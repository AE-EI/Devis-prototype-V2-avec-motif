<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis ‚Äî V3.0</title>

  <!-- Styles de base -->
  <style>
    :root {
      --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666;
      --line:#e8e8e8; --primary:#111;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#444; background:#fafafa; }
  </style>

  <!-- JSZip (exports ZIP) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- Cache-busting : ajoute ?v=timestamp une seule fois par onglet -->
  <script>
  (function(){
    try{
      var url = new URL(location.href);
      if (url.searchParams.has('v')) return;
      var onceKey = 'cb_once_' + location.pathname;
      if (sessionStorage.getItem(onceKey)) return;
      url.searchParams.set('v', Date.now());
      sessionStorage.setItem(onceKey, '1');
      location.replace(url.toString());
    }catch(e){}
  })();
  </script>
</head>
<body>
  <header>MiniDevis ‚Äî V3.0</header>
  <main id="app"></main>

  <!-- Sentinelle ultra-t√¥t -->
  <script>
  (function(){
    var app = document.getElementById('app');
    if(app){ app.innerHTML =
      '<div class="card">Loader OK ‚Äî en attente des chapitres JS‚Ä¶</div>';
    }
  })();
  </script>




  
  <!-- =============================
     CHAPITRE 2 : √âTAT & HELPERS
     Index :
       ¬ß2.1 ‚Ä¢ Gestion erreurs globales
       ¬ß2.2 ‚Ä¢ √âtat global & contexte courant
       ¬ß2.3 ‚Ä¢ Identifiants & helpers DOM/UI
       ¬ß2.4 ‚Ä¢ Libell√©s de pi√®ces (build/format)
       ¬ß2.5 ‚Ä¢ Persistance locale (save/load)
     ============================= -->
<script>
// ¬ß2.1 ‚Ä¢ Gestion erreurs globales
window.addEventListener('error', function (e) {
  var el = document.getElementById('app');
  if (el) {
    el.innerHTML =
      '<div class="card"><h2>Erreur JS</h2><pre>'
      + (e.message || 'Erreur inconnue')
      + '\n' + (e.filename || '') + ':' + (e.lineno || 0) + ':' + (e.colno || 0)
      + '</pre></div>';
  }
});

// ¬ß2.2 ‚Ä¢ √âtat global & contexte courant
var devis = {}; // contiendra aussi __id, __name, __tabCounter
var ctx   = { piece:null, category:null, intervention:null, pose:null, designation:null };

// ¬ß2.3 ‚Ä¢ Identifiants & helpers DOM/UI
function genId(){ return 'dv_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
function ensureId(){ if(!devis.__id) devis.__id = genId(); }
function $app(){ return document.getElementById('app'); }
function b(label, fn, cls){
  cls = cls || 'btn';
  return '<button class="'+cls+'" onclick=\''+fn+'\'>'+label+'</button>';
}
function euro(n){ return (+(n||0)).toFixed(2) + ' ‚Ç¨'; }
function view(html, noFooter){
  if(!noFooter){
    html += '<div class="row" style="margin-top:16px; gap:12px;">'
          + b('‚¨ÖÔ∏è Accueil','confirmBackHome()','btn back')
          + b('üíæ Sauvegarder devis','saveCurrentDevis()','btn primary')
          + '</div>';
  }
  $app().innerHTML = html;
}
function confirmBackHome(){
  var hasData = Object.keys(devis)
    .filter(function(k){ return k.indexOf('__') !== 0; })
    .some(function(k){
      var s = devis[k]||{};
      return (s.items && s.items.length>0) || (s.note && s.note.trim().length>0);
    });

  if(!hasData || confirm('Revenir au menu principal ?\n‚ö†Ô∏è Les modifications non sauvegard√©es seront perdues.')){
    if (typeof pageMain === 'function') pageMain();
    else $app().innerHTML = '<div class="card"><h2>Accueil</h2><p class="muted">Le chapitre Menu (4) n\'est pas encore charg√©.</p></div>';
  }
}

// ¬ß2.4 ‚Ä¢ Libell√©s de pi√®ces (build/format)
function buildPieceLabel(base, qualif, etage){
  var lbl = base || '';
  if(qualif && qualif.trim()) lbl += ' ('+qualif.trim()+')';
  if(etage && etage.trim())   lbl += ' ‚Äî '+etage.trim();
  return lbl;
}
function nextFreeKey(label){
  if(!devis[label]) return label;
  var n=2; while(devis[label+' ('+n+')']) n++;
  return label+' ('+n+')';
}
function createOrGetPiece(base, qualif, etage){
  var wanted = buildPieceLabel(base,qualif,etage);
  var key    = nextFreeKey(wanted);
  if(!devis[key]) devis[key] = { __base:base, qualificatif:qualif||'', etage:etage||'', items:[], note:'' };
  saveLocal();
  return key;
}
function formatPieceLabel(key){
  var s = devis[key]; if(!s) return key;
  var base = s.__base || key;
  return buildPieceLabel(base, s.qualificatif, s.etage);
}

// ¬ß2.5 ‚Ä¢ Persistance locale (save/load)
function ensureSection(key){
  if(!devis[key]) devis[key] = { items:[], note:'', qualificatif:'', etage:'' };
}
function saveLocal(){
  try { localStorage.setItem('devis', JSON.stringify(devis)); } catch(e){}
}
function loadLocal(){
  try { devis = JSON.parse(localStorage.getItem('devis') || '{}') || {}; }
  catch(e){ devis = {}; }
  ensureId();
}
</script>




  
<!-- =============================
     CHAPITRE 3 : CONSTANTES + PRIX
     ============================= -->
<script>
// Pi√®ces pr√©d√©finies
var PIECES_PREDEFINIES = [
  'Salon','Cuisine','Salle √† manger','Salle de bain','Salle d\'eau',
  'Chambre 1','Chambre 2','Chambre 3','Toilettes','Bureau',
  'Buanderie','Garage','Couloir','Terrasse','Balcon','Jardin',
  'D√©barras','Ext√©rieur','Grenier/Combles','Atelier',
  'Abri de jardin','Entr√©e','Biblioth√®que'
];

  //
  // Liste d‚Äô√©tages (utilis√©e par pageAddPiece)
//
var ETAGES = window.ETAGES || [
  'Sous-sol', 'RDC', 'R+1', 'R+2', 'Combles', 'Mezzanine',
  'Annexe', 'Ext√©rieur'
];

// (Optionnel mais robuste) ‚Äî si la variable est supprim√©e ailleurs,
// on force un fallback vide pour √©viter les plantages.
if (!Array.isArray(ETAGES)) { ETAGES = []; }

// Cat√©gories standards
var CATEGORIES = ['Prises','√âclairage','Circuit sp√©cialis√©','Sp√©cifique'];

// Modes de pose
var POSES = [
  'Encastr√© ma√ßonnerie','Placo','Semi-encastr√©',
  'Saillie avec moulure','Sous tube IRL','Sur-mesure'
];

// Sections de c√¢blage (avec option personnalis√©e)
var SECTIONS_CABLE = ['0,75 mm¬≤','1,5 mm¬≤','2,5 mm¬≤','6 mm¬≤','Personnalis√©e‚Ä¶'];

// D√©signations possibles par cat√©gorie
var DESIGNATIONS_PAR_CATEGORIE = {
  // <‚Äî pour Prises on ne s‚Äôen sert plus (d√©signation supprim√©e dans l‚ÄôUI)
  '√âclairage/Luminaires': ['Point de centre','Applique'],
  '√âclairage/Commandes': ['Interrupteur simple','Interrupteur double'],
  'Circuit sp√©cialis√©': [
    'Four','Plaque de cuisson','Lave-linge','Lave-vaisselle',
    'S√®che-linge','Cumulus','VMC','Chauffage','Climatisation',
    'Prise ext√©rieure √©tanche'
  ]
};

/* ============ TARIFS BASE (FT pos√©, hors coefficients) ============

  ‚Ä¢ PRISES : le prix de base est unique (par intervention)
  ‚Ä¢ √âCLAIRAGE : prix de base par d√©signation (point de centre, applique, etc.)
  ‚Ä¢ CIRCUIT SP√âCIALIS√â : prix de base UNIQUE (par intervention, *quel que soit* le circuit).
    Les sections appliquent un coefficient (voir COEFF_SECTIONS_CS).

  Tu pourras tout modifier plus tard dans le chapitre ‚ÄúParam√©trage tarifs‚Äù.
*/
var TARIFS_BASE = {
  prises: { // par intervention
    'Cr√©ation': 110,
    'Remplacement appareillage': 30,
    'Rec√¢blage avec remplacement appareillage': 85,
    'Rec√¢blage sans remplacement appareillage': 65
  },
  eclairage: { // par d√©signation
    'Point de centre': {
      'Cr√©ation': 100,
      'Remplacement luminaire': 30,
      'Rec√¢blage avec remplacement luminaire': 95,
      'Rec√¢blage sans remplacement luminaire': 65
    },
    'Applique': {
      'Cr√©ation': 100,
      'Remplacement luminaire': 30,
      'Rec√¢blage avec remplacement luminaire': 95,
      'Rec√¢blage sans remplacement luminaire': 65
    },
    'Interrupteur simple': {
      'Cr√©ation': 50,
      'Remplacement appareillage': 25,
      'Rec√¢blage avec remplacement appareillage': 75,
      'Rec√¢blage sans remplacement appareillage': 55
    },
    'Interrupteur double': {
      'Cr√©ation': 50,
      'Remplacement appareillage': 30,
      'Rec√¢blage avec remplacement appareillage': 85,
      'Rec√¢blage sans remplacement appareillage': 55
    }
  },
  circuit_specialise_base: { // un seul prix de base, par intervention
    'Cr√©ation': 110,
    'Remplacement appareillage': 30,
    'Rec√¢blage avec remplacement appareillage': 85,
    'Rec√¢blage sans remplacement appareillage': 65
  }
};

// Coefficients de POSE (appliqu√©s √† Prises, √âclairage et CS)
var COEFF_POSE = {
  'Placo': 1.00,
  'Encastr√© ma√ßonnerie': 1.50,
  'Semi-encastr√©': 1.40,
  'Sur-mesure': 1.60,
  'Saillie avec moulure': 1.35,
  'Sous tube IRL': 1.35
};

// Coefficients de SECTION pour CS :
// 0,75 et 1,5 ‚Üí 1.00 ; 2,5 ‚Üí +10% ; 6 ‚Üí +20%
var COEFF_SECTIONS_CS = {
  '0,75 mm¬≤': 1.00,
  '1,5 mm¬≤': 1.00,
  '2,5 mm¬≤': 1.20,
  '6 mm¬≤': 1.40
};

/* ============ Tableau & distribution (inchang√©) ============ */
var TARIFS_TABLEAU = {
  pose_base_13: { 1:70, 2:90, 3:110, 4:130 },
  coef: {
    modules: { 13:1.00, 18:1.30, 24:1.50 },
    pose: { 'Saillie':1.00, 'Encastr√©':1.70 },
    intervention: { 'Cr√©ation':1.00, 'Avec d√©pose de l‚Äôexistant':1.30 }
  },
  disjoncteurs: { 2:32, 10:25, 16:25, 20:25, 32:32, 40:45 },
  inter_diff: { '40A-AC':70, '40A-A':90, '63A-AC':110, '63A-A':130 },
  commandes: {
    'T√©l√©rupteur':60,
    'T√©l√©rupteur silencieux':80,
    'Horloge m√©canique + Disjoncteur 2A':90,
    'Horloge m√©canique + contacteur heures creuses + Disjoncteur 2A':140
  }
};

/* ============ Helpers PRIX communs ============ */

// Arrondi au 5 sup√©rieur (toujours vers le haut)
function roundUp5(x){
  x = +x || 0;
  return Math.ceil(x / 5) * 5;
}

// Renvoie le PU avec pose/section + arrondi au 5 sup√©rieur
// category : 'Prises' | '√âclairage/Luminaires' | '√âclairage/Commandes' | 'Circuit sp√©cialis√©'
function computePU(category, designation, intervention, pose, section){
  var base = 0;

  if(category === 'Prises'){
    base = (TARIFS_BASE.prises[intervention] || 0);

  } else if(category === '√âclairage/Luminaires' || category === '√âclairage/Commandes'){
    base = (TARIFS_BASE.eclairage[designation] && TARIFS_BASE.eclairage[designation][intervention]) || 0;

  } else if(category === 'Circuit sp√©cialis√©'){
    base = (TARIFS_BASE.circuit_specialise_base[intervention] || 0);
    // Coeff section
    var cSec = COEFF_SECTIONS_CS[section] || 1.00;
    base = base * cSec;
  }

  // Coeff pose
  var cPose = COEFF_POSE[pose] || 1.00;
  var total = base * cPose;

  // Arrondi 5 sup√©rieur
  return roundUp5(total);
}

// Back-compat : utilis√© ailleurs (estimatif‚Ä¶)
function getPrix(designation, intervention){
  // garde une compatibilit√© minimale si appel√© sans contexte
  // (ex : pr√©visualisation ancienne). On renvoie juste la base eclairage.
  var e = TARIFS_BASE.eclairage[designation];
  return e ? (e[intervention] || 0) : 0;
}
</script>


  





  

  

  
<!-- =============================
     CHAPITRE 4 : MENU PRINCIPAL & SAUVEGARDES (robuste)
     Index :
       ¬ß4.0 ‚Ä¢ Cl√©s & helpers de stockage
       ¬ß4.1 ‚Ä¢ Accueil principal (avec bouton Param√©trage)
       ¬ß4.2 ‚Ä¢ Nouveau devis / Ouverture / Suppression
       ¬ß4.3 ‚Ä¢ Sauvegarde (nommage, d√©doublonnage, MAJ)
       ¬ß4.4 ‚Ä¢ Export / Import (.json) avec fusion non destructive
       ¬ß4.5 ‚Ä¢ Routines internes : backup miroir, merge, recovery
     ============================= -->
<script>
// === ¬ß4.0 ‚Ä¢ Cl√©s & helpers de stockage =========================
const STORE_KEYS = {
  current: 'devis',
  saved:   'savedDevisList',
  backup:  'savedDevisListBackup'
};
function readJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key) || 'null') ?? fallback; }
  catch(e){ return fallback; }
}
function writeJSON(key, value){
  try { localStorage.setItem(key, JSON.stringify(value)); } catch(e){}
}

// Petit helper HTML safe (listes)
function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// Bouton Param√©trage (s√©curis√© si le Chap.8 n'est pas charg√©)
function openTarifs(){
  if (typeof pageTarifsAccueil === 'function') pageTarifsAccueil();
  else alert('Le chapitre Param√©trage (8) n‚Äôest pas encore charg√©.');
}

// === ¬ß4.1 ‚Ä¢ Accueil principal =================================
function pageMain(){
  // view() & b() sont d√©finis dans les chapitres communs (2.x)
  view(
    '<div class="card">'
      + '<h2>Menu principal</h2>'
      + '<div class="row">'
        + b('‚ûï Nouveau devis','actionNouveauDevis()','btn primary')
        + b('üìÇ Mes devis sauvegard√©s','pageSavedDevis()','btn')
        + b('‚öôÔ∏è Param√©trage des tarifs','openTarifs()','btn')
      + '</div>'
    + '</div>'
  , true);
}

// === ¬ß4.2 ‚Ä¢ Nouveau devis / Ouverture / Suppression ===========
function actionNouveauDevis(){
  // genId(), saveLocal(), pageHome() ‚Üí chapitres 2 & 5
  devis = { __id: genId(), __name: '' };
  saveLocal();
  pageHome();
}

function pageSavedDevis(){
  var saved = getSavedList();

  if(!saved.length){
    return view(
      '<div class="card">'
        + b('‚¨ÖÔ∏è Retour','pageMain()','btn back')
        + '<h2>Mes devis sauvegard√©s</h2>'
        + '<p class="muted">Aucun devis sauvegard√©.</p>'
        + '<div class="row" style="margin-top:10px;">'
          + b('‚¨ÜÔ∏è Importer‚Ä¶','importSavedDevisUI()','btn')
        + '</div>'
      + '</div>'
    , true);
  }

  var list = saved.map(function(d,i){
    var title = escapeHtml(d.name || ('Devis '+(i+1)));
    var date  = escapeHtml(d.date || '');
    return '<div class="pill" style="width:100%; justify-content:space-between;">'
         +   '<span><strong>'+title+'</strong> <small class="muted">'+date+'</small></span>'
         +   '<span>'
         +     b('Ouvrir','loadDevis('+i+')','btn')
         +     b('Supprimer','deleteDevis('+i+')','btn')
         +   '</span>'
         + '</div>';
  }).join('');

  view(
    '<div class="card">'
      + b('‚¨ÖÔ∏è Retour','pageMain()','btn back')
      + '<h2>Mes devis sauvegard√©s</h2>'
      + '<div class="list">'+list+'</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b('üíæ Exporter tout (.json)','exportSavedDevis()','btn')
        + b('‚¨ÜÔ∏è Importer‚Ä¶','importSavedDevisUI()','btn')
      + '</div>'
    + '</div>'
  , true);
}

function loadDevis(idx){
  var saved = getSavedList();
  if(!saved[idx]) return pageSavedDevis();
  devis = saved[idx].data || {};
  ensureId();
  saveLocal();
  pageHome();
}

function deleteDevis(idx){
  if(!confirm('Supprimer ce devis sauvegard√© ?')) return;
  var saved = getSavedList();
  saved.splice(idx,1);
  setSavedList(saved);
  makeSavedBackup(saved);
  pageSavedDevis();
}

// === ¬ß4.3 ‚Ä¢ Sauvegarde compl√®te (+ backup automatique) ========
function saveCurrentDevis(){
  ensureId();
  var saved = getSavedList();

  // Cherche par __id (mise √† jour si trouv√©)
  var i = saved.findIndex(function(d){ return d.data && d.data.__id === devis.__id; });

  // D√©termine/valide le nom
  var name = (devis.__name||'').trim();
  if(i < 0 && !name){
    name = (prompt('Nom du devis :','')||'').trim();
    if(!name){ alert('Sauvegarde annul√©e.'); return; }
  }
  devis.__name = name || (saved[i]?.name) || ('Devis '+new Date().toLocaleDateString());

  var record = { name: devis.__name, date: new Date().toLocaleString(), data: devis };

  if(i >= 0){
    saved[i] = record;
  } else {
    // D√©doublonnage par nom (√©vite 2 entr√©es strictement homonymes)
    var j = saved.findIndex(function(d){ return (d.name||'').toLowerCase() === devis.__name.toLowerCase(); });
    if(j >= 0){
      if(!confirm('Un devis ¬´ '+devis.__name+' ¬ª existe d√©j√†. L\'√©craser ?')) return;
      saved[j] = record;
    } else {
      saved.push(record);
    }
  }

  setSavedList(saved);
  makeSavedBackup(saved);
  alert('‚úÖ Devis sauvegard√©.');
}

// === ¬ß4.4 ‚Ä¢ Export / Import ===================================
function exportSavedDevis(){
  var saved = getSavedList();
  var payload = {
    _kind: 'MiniDevisSaved',
    version: 1,
    origin: location.origin,
    exported_at: new Date().toISOString(),
    items: saved
  };
  var blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url;
  a.download = 'minidevis_sauvegardes_'+(new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'))+'.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importSavedDevisUI(){
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = function(){
    var f = input.files && input.files[0];
    if(!f) return;
    var rd = new FileReader();
    rd.onload = function(){
      try{
        var json = JSON.parse(rd.result||'null');
        var items = Array.isArray(json?.items) ? json.items : (Array.isArray(json)? json : null);
        if(!items){ alert('Fichier non reconnu.'); return; }
        var merged = mergeSavedLists(getSavedList(), items);
        setSavedList(merged);
        makeSavedBackup(merged);
        alert('‚úÖ Import termin√© : '+items.length+' enregistrement(s) lu(s).');
        pageSavedDevis();
      }catch(e){
        alert('Erreur d‚Äôimport : '+e.message);
      }
    };
    rd.readAsText(f, 'utf-8');
  };
  input.click();
}

// === ¬ß4.5 ‚Ä¢ Routines internes (backup, merge, recovery) =======
function getSavedList(){ return readJSON(STORE_KEYS.saved, []); }
function setSavedList(list){ writeJSON(STORE_KEYS.saved, Array.isArray(list)?list:[]); }

// Sauvegarde miroir (pour r√©cup√©ration si effacement accidentel)
function makeSavedBackup(list){
  writeJSON(STORE_KEYS.backup, {
    saved: Array.isArray(list)?list:[],
    host: location.host,
    t: Date.now()
  });
}

// Appeler recoverSavedIfEmpty() au boot (cf. init() du Chap. 10)
function recoverSavedIfEmpty(){
  var saved = getSavedList();
  if(saved && saved.length) return; // rien √† faire
  var backup = readJSON(STORE_KEYS.backup, null);
  if(backup && Array.isArray(backup.saved) && backup.saved.length){
    if(confirm('Aucune sauvegarde active trouv√©e, mais une copie de secours est disponible. Restaurer ?')){
      setSavedList(backup.saved);
    }
  }
}

// Fusion non destructive par __id (priorit√© au plus r√©cent via date)
function mergeSavedLists(existing, incoming){
  var map = new Map();
  function put(rec){
    var id = rec?.data?.__id || rec?.__id || genId();
    var cur = map.get(id);
    var recDate = new Date(rec?.date||0).getTime() || 0;
    var curDate = new Date(cur?.date||0).getTime() || 0;
    if(!cur || recDate >= curDate){
      map.set(id, {
        name: rec?.name || rec?.data?.__name || 'Devis',
        date: rec?.date || new Date().toLocaleString(),
        data: rec?.data || rec
      });
    }
  }
  (existing||[]).forEach(put);
  (incoming||[]).forEach(put);
  return Array.from(map.values());
}
</script>








  

  


<!-- =============================
     CHAPITRE 5 : ACCUEIL & FLUX PI√àCES ‚Äî V5 one-page (MAJ : masquage pose/section hors Cr√©ation)
     Index :
       ¬ß5.0 ‚Ä¢ Helpers & router
       ¬ß5.1 ‚Ä¢ Accueil & liste des pi√®ces
       ¬ß5.2 ‚Ä¢ Ajout d‚Äôune pi√®ce
       ¬ß5.3 ‚Ä¢ D√©tail de pi√®ce & cat√©gories
       ¬ß5.4 ‚Ä¢ Cat√©gories & saisie one-shot (masquage dynamique)
       ¬ß5.5 ‚Ä¢ Sp√©cifique & notes
     ============================= -->

<!-- 5.0 ‚Äî Helpers & router -->
<script>
function goVent(){
  if (typeof pageVentAccueil === 'function') pageVentAccueil();
  else alert('La section Ventilation n‚Äôest pas encore charg√©e.');
}
function _badge(txt){ return txt ? '<span class="badge">'+txt+'</span>' : ''; }
</script>

<!-- 5.1 ‚Äî Accueil & liste des pi√®ces -->
<script>
function pageHome(){
  var keys = Object.keys(devis).filter(k=>k.indexOf('__')!==0);
  var listHtml = keys.length ? keys.map(function(key){
    var s = devis[key] || {};
    var label = pieceDisplayLabel(key);
    return '<div class="pill">'
      +'<strong>'+label+'</strong> '
      +'<small>'+((s.items||[]).length)+' ligne(s)</small> '
      + _badge(s.qualificatif && s.qualificatif.trim())
      + _badge(s.etage && s.etage.trim())
      + b('Ouvrir','goPiece('+JSON.stringify(key)+')','btn')
      + b('Supprimer','removePiece('+JSON.stringify(key)+')','btn')
    +'</div>';
  }).join('') : '<p class="muted">Aucune pi√®ce ajout√©e pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      +'<h2>Accueil</h2>'
      +'<div class="row">'
        + b('Ajouter une pi√®ce','pageAddPiece()','btn primary')
        + b('Cr√©er un tableau','pageTabCreate()','btn')
        + b('Ventilation','goVent()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Pi√®ces & Tableaux ajout√©s</h2>'
      +'<div class="list">'+listHtml+'</div>'
    +'</div>'
    +'<div class="row" style="margin-top:12px;">'
      + b('Voir l‚Äôestimatif','pageEstimatif()','btn')
      + b('Voir les totaux','pageTotaux()','btn')
    +'</div>'
  );
}

function goPiece(key){
  ctx = { piece:key, category:null, intervention:null, pose:null, designation:null };
  ensureSection(key);

  var cats = ['Prises','√âclairage','Circuit sp√©cialis√©']
    .map(c=> b(c,'goCategory('+JSON.stringify(c)+')','btn'))
    .join('');

  var s = devis[key];
  var lignes = (s.items||[]).length
    ? '<ul>'+s.items.map(function(it,i){
        var total = (+it.prixU||0) * (+it.qty||0);
        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? ' ‚Äî '+String(it.pose).toLowerCase() : '';
        var unitTxt = it.unit || 'u';
        var left = it.intervention ? (it.intervention+' ‚Äî ') : '';
        return '<li>'
          + left + it.designation + poseTxt
          +' ('+it.qty+' '+unitTxt+' √ó '+euro(it.prixU)+' = '+euro(total)+') '
          + b('√ó','delLine('+JSON.stringify(key)+','+i+')','btn')
        +'</li>';
      }).join('') + '</ul>'
    : '<p class="muted">Aucune ligne pour l‚Äôinstant.</p>';

  var label = pieceDisplayLabel(key);
  var noteTxt = s.note ? '<em class="muted">Note : '+s.note+'</em>' : '<span class="muted">Aucune note</span>';

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      +'<h2>'+label+'</h2>'
      +'<div class="row">'+cats+b('Sp√©cifique','pageSpecifiqueForm()','btn ghost')+'</div>'
      +'<div class="row" style="margin-top:10px;">'+b('Ajouter / modifier la note','editPieceNote()','btn')+'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Lignes de la pi√®ce</h2>'+lignes
      +'<p style="margin-top:8px;">'+noteTxt+'</p>'
    +'</div>'
  );
}

function delLine(key, idx){
  (devis[key].items||[]).splice(idx,1); saveLocal(); goPiece(key);
}
function removePiece(key){
  if(confirm('Supprimer la pi√®ce ¬´ '+pieceDisplayLabel(key)+' ¬ª et toutes ses lignes ?')){
    delete devis[key]; saveLocal(); pageHome();
  }
}
</script>

<!-- 5.2 ‚Äî Ajout d‚Äôune pi√®ce -->
<script>
function pageAddPiece(){
  var opts = PIECES_PREDEFINIES.map(p=>'<option value="'+p+'">'+p+'</option>').join('')
           + '<option value="__NEW__">‚ûï Cr√©er une nouvelle pi√®ce‚Ä¶</option>';
  var safeEtages = (window.ETAGES && Array.isArray(ETAGES) && ETAGES.length)
      ? ['(aucun)'].concat(ETAGES)
      : ['(aucun)','RDC','R+1','R+2','Sous-sol','Combles','Ext√©rieur'];
  var etageOpts = safeEtages.map(e=>'<option value="'+e+'">'+e+'</option>').join('');

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Ajouter une pi√®ce</h2>'
      + '<label>Choisir une pi√®ce</label>'
      + '<select id="piece-choice">'+opts+'</select>'
      + '<label style="margin-top:10px;">Qualificatif (optionnel)</label>'
      + '<input id="piece-qualif" placeholder="ex : Parents, RDC, gauche" />'
      + '<label style="margin-top:10px;">√âtage (optionnel)</label>'
      + '<select id="piece-etage">'+etageOpts+'</select>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Valider','confirmPieceChoice()','btn primary')
      + '</div>'
    + '</div>'
  );
}
function confirmPieceChoice(){
  var sel    = document.getElementById('piece-choice').value;
  var qualif = (document.getElementById('piece-qualif').value || '').trim();
  var etage  = document.getElementById('piece-etage').value;
  if(!sel) return;
  var base = sel;
  if(sel==='__NEW__'){
    base = (prompt('Nom de la pi√®ce :','') || '').trim();
    if(!base) return;
  }
  var etageVal = (etage && etage!=='(aucun)') ? etage : '';
  var key = createOrGetPiece(base, qualif, etageVal);
  goPiece(key);
}
</script>

<!-- 5.3 ‚Äî Cat√©gories & sous-menu √âclairage -->
<script>
function goCategory(cat){
  if (cat === '√âclairage') return goEclairageSub();
  ctx.category = cat;
  pageOneShotSelection();
}
function goEclairageSub(){
  view(
    '<div class="card">'
      + b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      + '<h2>√âclairage ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<div class="row">'
        + b('Luminaires','setEclairageBranch('+JSON.stringify('√âclairage/Luminaires')+')','btn')
        + b('Commandes','setEclairageBranch('+JSON.stringify('√âclairage/Commandes')+')','btn')
      + '</div>'
    + '</div>'
  );
}
function setEclairageBranch(branch){
  ctx.category = branch;
  pageOneShotSelection();
}
</script>

<!-- 5.4 ‚Äî Saisie ‚Äúone-shot‚Äù (masquage dynamique pose/section hors Cr√©ation) -->
<script>
function pageOneShotSelection(){
  var cat = ctx.category;

  // 1) Interventions par cat√©gorie
  var invs = [];
  if(cat==='Prises' || cat==='Circuit sp√©cialis√©'){
    invs = [
      'Cr√©ation',
      'Remplacement appareillage',
      'Rec√¢blage avec remplacement appareillage',
      'Rec√¢blage sans remplacement appareillage'
    ];
  } else if(cat==='√âclairage/Luminaires'){
    invs = [
      'Cr√©ation',
      'Remplacement luminaire',
      'Rec√¢blage avec remplacement luminaire',
      'Rec√¢blage sans remplacement luminaire'
    ];
  } else if(cat==='√âclairage/Commandes'){
    invs = [
      'Cr√©ation',
      'Remplacement appareillage',
      'Rec√¢blage avec remplacement appareillage',
      'Rec√¢blage sans remplacement appareillage'
    ];
  } else {
    invs = ['Cr√©ation'];
  }
  var invOpts = invs.map(i=>'<option value="'+i+'">'+i+'</option>').join('');

  // 2) D√©signation
  var desigHtml = '', defaultDesignation = '';
  if(cat==='Prises'){
    defaultDesignation = 'Prise';
    desigHtml = '<div class="pill"><strong>D√©signation : Prise</strong></div>';
  } else if(cat==='√âclairage/Luminaires' || cat==='√âclairage/Commandes'){
    var list = DESIGNATIONS_PAR_CATEGORIE[cat] || ['√âl√©ment'];
    defaultDesignation = list[0];
    desigHtml = '<label style="margin-top:10px;">D√©signation</label>'
              + '<select id="oneshot-desig">'
              + list.map(d=>'<option value="'+d+'">'+d+'</option>').join('')+'</select>';
  } else if(cat==='Circuit sp√©cialis√©'){
    defaultDesignation = 'Circuit sp√©cialis√©';
    desigHtml = '<label style="margin-top:10px;">Libell√© (optionnel)</label>'
              + '<input id="oneshot-custom-desig" placeholder="ex : Four, PAC‚Ä¶ (facultatif)" />';
  } else {
    defaultDesignation = '√âl√©ment';
    desigHtml = '<label>D√©signation</label><input id="oneshot-custom-desig" placeholder="√âl√©ment" />';
  }

  // 3) Pose (sera masqu√©e si intervention ‚â† Cr√©ation)
  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var poseBlock = '<div id="oneshot-pose-wrap">'
                +   '<label>Type de pose</label><select id="oneshot-pose">'+poseOpts+'</select>'
                + '</div>';

  // 4) Section (CS uniquement, et masqu√©e si intervention ‚â† Cr√©ation)
  var sectionBlock = '';
  if(cat==='Circuit sp√©cialis√©'){
    var sectOpts = SECTIONS_CABLE.map(s=>'<option value="'+s+'">'+s+'</option>').join('');
    sectionBlock = '<div id="oneshot-section-wrap" style="margin-top:10px;">'
                 +   '<label>Section</label><select id="oneshot-section">'+sectOpts+'</select>'
                 + '</div>';
  }

  // 5) Quantit√©
  var qtyOpts = Array.from({length:30},(_,i)=>'<option '+(i===0?'selected':'')+'>'+(i+1)+'</option>').join('');

  // UI
  var backFn = (cat && cat.indexOf('√âclairage/')===0) ? 'goEclairageSub()' : 'goPiece('+JSON.stringify(ctx.piece)+')';
  view(
    '<div class="card">'
      + b('Retour', backFn, 'btn back')
      + '<h2>'+cat+' ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<label>Intervention</label><select id="oneshot-interv">'+invOpts+'</select>'
      + desigHtml
      + poseBlock
      + sectionBlock
      + '<label style="margin-top:10px;">Quantit√©</label>'
      + '<select id="oneshot-qty">'+qtyOpts+'</select>'
      + '<div id="oneshot-preview" class="muted" style="margin-top:10px;"></div>'
      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveOneShotItem(false)','btn primary')
        + b('Ajouter et rester','saveOneShotItem(true)','btn')
      + '</div>'
    + '</div>'
  );

  // ----- Comportement : masquage dynamique selon intervention
  function isCreation(interv){ return String(interv||'')==='Cr√©ation'; }

  function applyInterventionVisibility(){
    var interv = document.getElementById('oneshot-interv').value;
    var poseWrap = document.getElementById('oneshot-pose-wrap');
    var sectionWrap = document.getElementById('oneshot-section-wrap');

    // Pose : visible uniquement en Cr√©ation (toutes cat√©gories)
    if(poseWrap){
      poseWrap.style.display = isCreation(interv) ? '' : 'none';
    }
    // Section : visible uniquement en Cr√©ation ET cat√©gorie = Circuit sp√©cialis√©
    if(sectionWrap){
      sectionWrap.style.display = (isCreation(interv) && cat==='Circuit sp√©cialis√©') ? '' : 'none';
    }
    refreshPreview(); // tenir compte du masquage dans le calcul
  }

  // ----- Aper√ßu PU/Total
  function refreshPreview(){
    var interv = document.getElementById('oneshot-interv').value;

    // D√©signation choisie
    var desig  = defaultDesignation;
    var selDes = document.getElementById('oneshot-desig');
    var custom = document.getElementById('oneshot-custom-desig');
    if(selDes) desig = selDes.value;
    if(custom && custom.value.trim()) desig = custom.value.trim();

    // Pose / Section : seulement si visibles (Cr√©ation)
    var poseEl = document.getElementById('oneshot-pose-wrap');
    var sectionEl = document.getElementById('oneshot-section-wrap');

    var pose   = (poseEl && poseEl.style.display!=='none') ? (document.getElementById('oneshot-pose').value||'') : '';
    var section= (sectionEl && sectionEl.style.display!=='none') ? ((document.getElementById('oneshot-section')||{}).value||'') : '';

    var pu = (typeof computePU==='function') ? computePU(cat, desig, interv, pose, section) : 0;
    var q  = parseInt(document.getElementById('oneshot-qty').value,10)||1;
    document.getElementById('oneshot-preview').innerHTML = 'PU : '+euro(pu)+' ‚Äî Total : '+euro(pu*q);
  }

  // Events
  ['oneshot-interv','oneshot-pose','oneshot-section','oneshot-desig','oneshot-custom-desig','oneshot-qty']
    .forEach(function(id){ var el=document.getElementById(id); if(el) el.addEventListener('input', function(){ 
      if(id==='oneshot-interv') applyInterventionVisibility(); else refreshPreview();
    }); });

  // Init
  applyInterventionVisibility();
}

function saveOneShotItem(stayHere){
  var cat  = ctx.category;
  var interv = document.getElementById('oneshot-interv').value;

  // Si non Cr√©ation ‚Üí ne pas prendre pose/section
  var poseWrap = document.getElementById('oneshot-pose-wrap');
  var sectionWrap = document.getElementById('oneshot-section-wrap');

  var pose   = (poseWrap && poseWrap.style.display!=='none') ? (document.getElementById('oneshot-pose').value||'') : '';
  var section= (sectionWrap && sectionWrap.style.display!=='none') ? ((document.getElementById('oneshot-section')||{}).value||'') : '';

  var qty    = parseInt(document.getElementById('oneshot-qty').value,10)||1;

  var desig = '√âl√©ment';
  if(cat==='Prises'){ desig='Prise'; }
  else {
    var selDes = document.getElementById('oneshot-desig');
    var custom = document.getElementById('oneshot-custom-desig');
    if(selDes) desig = selDes.value;
    if(custom && custom.value.trim()) desig = custom.value.trim();
  }

  var pu = (typeof computePU==='function') ? computePU(cat, desig, interv, pose, section) : 0;

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category: cat,
    intervention: interv,
    pose: pose, // vide si non Cr√©ation (d‚Äôo√π affichage coh√©rent en liste)
    designation: (cat==='Circuit sp√©cialis√©' && desig==='Circuit sp√©cialis√©')
                  ? (desig + (section?(' ‚Äî '+section):'')) : desig + (section?(' ‚Äî '+section):''),
    qty: qty,
    prixU: pu,
    __tabKey: ctx.piece
  });
  saveLocal();
  if(stayHere){ pageOneShotSelection(); } else { goPiece(ctx.piece); }
}
</script>

<!-- 5.5 ‚Äî Sp√©cifique & notes -->
<script>
function pageSpecifiqueForm(){
  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var invOpts   = ['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage']
                    .map(i=>'<option value="'+i+'">'+i+'</option>').join('');
  view(
    '<div class="card">'
      + b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      + '<h2>Sp√©cifique ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<label>Intervention</label><select id="sp-interv">'+invOpts+'</select>'
      + '<label style="margin-top:10px;">Nom</label>'
      + '<input id="sp-label" placeholder="ex : Bandeau LED, Pompe piscine‚Ä¶" />'
      + '<label style="margin-top:10px;">Type de pose</label><select id="sp-pose">'+poseOpts+'</select>'
      + '<label style="margin-top:10px;">Prix unitaire (‚Ç¨)</label><input id="sp-price" type="number" inputmode="decimal" placeholder="0" />'
      + '<label style="margin-top:10px;">Quantit√©</label><input id="sp-qty" type="number" inputmode="numeric" min="1" value="1" />'
      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveSpecifique(false)','btn primary')
        + b('Ajouter et rester','saveSpecifique(true)','btn')
      + '</div>'
    + '</div>'
  );
}
function saveSpecifique(stayHere){
  var label = (document.getElementById('sp-label').value||'').trim();
  if(!label){ alert('Nom requis.'); return; }
  var pose  = document.getElementById('sp-pose').value || '';
  var interv= document.getElementById('sp-interv').value || 'Cr√©ation';
  var prix  = parseFloat(document.getElementById('sp-price').value)||0;
  var qty   = Math.max(1, parseInt(document.getElementById('sp-qty').value,10) || 1);

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category:'Sp√©cifique',
    intervention:interv,
    pose:pose,
    designation:label,
    qty:qty,
    prixU:roundUp5(prix),
    __tabKey: ctx.piece
  });
  saveLocal();
  if(stayHere){ pageSpecifiqueForm(); } else { goPiece(ctx.piece); }
}

function editPieceNote(){
  ensureSection(ctx.piece);
  var cur = devis[ctx.piece].note || '';
  var n = prompt('Note pour '+pieceDisplayLabel(ctx.piece), cur);
  if(n!==null) devis[ctx.piece].note = n.trim();
  saveLocal();
  goPiece(ctx.piece);
}
</script>









  

  
  
 <!-- =======================================================================
     CHAPITRE 6 : TABLEAU √âLECTRIQUE (multi-tableaux) ‚Äî d√©coup√©
     Index :
       6.0 ‚Ä¢ √âtat local (tabState) + utils + getTabPrice
       6.1 ‚Ä¢ Cr√©ation / accueil d‚Äôun tableau (nom perso)
       6.2 ‚Ä¢ Pose du tableau
       6.3 ‚Ä¢ Interrupteurs diff√©rentiels
       6.3b‚Ä¢ Coupure g√©n√©rale
       6.4 ‚Ä¢ Disjoncteurs modulaires (+ d√©tails circuits)
       6.5 ‚Ä¢ Commandes & pilotage
       6.6 ‚Ä¢ √âl√©ment sp√©cifique
     ======================================================================= -->

<!-- 6.0 ‚Ä¢ √âtat local + utils -->
<script>
let tabState = {
  disj: {
    2:{qty:0,details:[]}, 10:{qty:0,details:[]}, 16:{qty:0,details:[]},
    20:{qty:0,details:[]}, 32:{qty:0,details:[]}, 40:{qty:0,details:[]},
    __custom__:{qty:0,details:[],label:""}
  }
};
function ensureTableauKey(key){
  if(!devis[key]) devis[key]={__base:"Tableau",items:[],note:"",__customName:""};
}
function saveDisjQtyFromUI(){
  const pick=id=>+((document.getElementById(id)||{}).value||0);
  ["2","10","16","20","32","40"].forEach(r=>{
    const v=pick("djq-"+r);
    if(!tabState.disj[+r]) tabState.disj[+r]={qty:0,details:[]};
    tabState.disj[+r].qty=v;
  });
  const lbl=(document.getElementById("djq-custom-label")?.value||"").trim();
  const q  =pick("djq-custom");
  tabState.disj.__custom__.label=lbl;
  tabState.disj.__custom__.qty=q;
}
// Prix de pose d‚Äôun tableau (arrondi 5+)
function getTabPrice(rangs, modules, pose, intervention){
  try{
    const base = (TARIFS_TABLEAU.pose_base_13[rangs]||0);
    const cm = (TARIFS_TABLEAU.coef.modules[modules]||1);
    const cp = (TARIFS_TABLEAU.coef.pose[pose]||1);
    const ci = (TARIFS_TABLEAU.coef.intervention[intervention]||1);
    return roundUp5(base*cm*cp*ci);
  }catch(e){ return 0; }
}
</script>

<!-- 6.1 ‚Ä¢ Cr√©ation / accueil -->
<script>
function pageTabCreate(){
  if(typeof devis.__tabCounter!=="number") devis.__tabCounter=0;
  devis.__tabCounter+=1;
  const key="Tableau "+devis.__tabCounter;

  if(!devis[key]) devis[key]={__base:"Tableau",items:[],note:"",__customName:""};
  saveLocal();

  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>Nouveau tableau</h2>'
      + '<p>Identifiant automatique : <strong>'+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="tab-custom" placeholder="ex: Principal RDC" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Valider","saveTabCustomName("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function saveTabCustomName(key){
  const name=(document.getElementById("tab-custom").value||"").trim();
  if(devis[key]){ devis[key].__customName=name; saveLocal(); }
  pageTabHome(key);
}
function pageTabHome(key){
  if(!key || !devis[key]) return pageHome();
  const custom = devis[key].__customName ? " ‚Äî "+devis[key].__customName : "";
  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>'+key+custom+'</h2>'
      + '<div class="row" style="margin-top:10px;">'
        + b("1 ¬∑ Pose du tableau","pageTabPose("+JSON.stringify(key)+")","btn primary")
        + b("2 ¬∑ Interrupteurs diff√©rentiels","pageTab_ID("+JSON.stringify(key)+")","btn")
        + b("3 ¬∑ Coupure g√©n√©rale","pageTab_Coupure("+JSON.stringify(key)+")","btn")
        + b("4 ¬∑ Disjoncteurs modulaires","pageTab_Disjoncteurs("+JSON.stringify(key)+")","btn")
        + b("5 ¬∑ Commandes / pilotage","pageTabMod_Commandes("+JSON.stringify(key)+")","btn")
        + b("6 ¬∑ Sp√©cifique (libre + prix)","pageTabMod_Specifique("+JSON.stringify(key)+")","btn ghost")
      + '</div>'
      + '<p class="muted" style="margin-top:8px;">Les √©l√©ments ajout√©s ici restent dans ¬´ '+key+' ¬ª.</p>'
    + '</div>'
  );
}
</script>

<!-- 6.2 ‚Ä¢ Pose du tableau -->
<script>
function pageTabPose(key){
  const rangs=[1,2,3,4].map(r=>`<option value="${r}">${r} rang√©e(s)</option>`).join('');
  const modules=[13,18,24].map(m=>`<option value="${m}">${m} modules</option>`).join('');
  const poses=['Saillie','Encastr√©'].map(p=>`<option value="${p}">${p}</option>`).join('');
  const intervs=['Cr√©ation','Avec d√©pose de l‚Äôexistant'].map(i=>`<option value="${i}">${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Pose du tableau</h2>'
      + '<label>Nombre de rang√©es</label><select id="tab-rang">'+rangs+'</select>'
      + '<label>Modules</label><select id="tab-mod">'+modules+'</select>'
      + '<label>Pose</label><select id="tab-pose">'+poses+'</select>'
      + '<label>Intervention</label><select id="tab-inv">'+intervs+'</select>'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"addTabPose("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function addTabPose(key){
  const r=+document.getElementById("tab-rang").value;
  const m=+document.getElementById("tab-mod").value;
  const pos=document.getElementById("tab-pose").value;
  const itv=document.getElementById("tab-inv").value;
  const pu=(typeof getTabPrice==='function')?getTabPrice(r,m,pos,itv):0;

  ensureTableauKey(key);
  devis[key].items.push({
    category:"Tableau & distribution",
    intervention:itv, pose:pos,
    designation:`Pose tableau ‚Äî ${r} rang√©e(s), ${m} modules`,
    qty:1, prixU:pu, __tabKey:key
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.3 ‚Ä¢ Interrupteurs diff√©rentiels -->
<script>
function pageTab_ID(key){
  const MODELS=[
    { id:"40A-A",  label:"ID 30mA - 40A - Type A"  },
    { id:"40A-AC", label:"ID 30mA - 40A - Type AC" },
    { id:"63A-A",  label:"ID 30mA - 63A - Type A"  },
    { id:"63A-AC", label:"ID 30mA - 63A - Type AC" }
  ];
  const opts=(n=20)=>Array.from({length:n+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  const price=id=>(TARIFS_TABLEAU && TARIFS_TABLEAU.inter_diff ? (TARIFS_TABLEAU.inter_diff[id]||0) : 0);

  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Interrupteurs diff√©rentiels</h2>'
      + '<div class="list">'
        + MODELS.map(m=>(
          `<label>${m.label} ‚Äî <span class="muted">${euro(price(m.id))}</span> `
          + `<select id="idq-${m.id.replace(/[^a-z0-9]/ig,'_')}">${opts(20)}</select></label>`
        )).join('')
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"submitTab_ID("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_ID(key){
  const pick=id=>+document.getElementById(id).value||0;
  const mk=id=>`idq-${id.replace(/[^a-z0-9]/ig,'_')}`;
  const lines=["40A-A","40A-AC","63A-A","63A-AC"].map(id=>({id,q:pick(mk(id))})).filter(x=>x.q>0);
  if(!lines.length){ pageTabHome(key); return; }

  ensureTableauKey(key);
  lines.forEach(x=>{
    const pu = (TARIFS_TABLEAU && TARIFS_TABLEAU.inter_diff ? (TARIFS_TABLEAU.inter_diff[x.id]||0) : 0);
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:`ID 30mA ‚Äî ${x.id.replace('-', ' - ')}`,
      qty:x.q, prixU:pu, __tabKey:key
    });
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.3b ‚Ä¢ Coupure g√©n√©rale -->
<script>
function pageTab_Coupure(key){
  const MODELS=[ { id:"45A", label:"Coupure g√©n√©rale 45 A", pu:80 },
                 { id:"60A", label:"Coupure g√©n√©rale 60 A", pu:110 } ];
  const opts=(n=20)=>Array.from({length:n+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Coupure g√©n√©rale</h2>'
      + '<div class="list">'
        + MODELS.map(m=>(
          `<label>${m.label} ‚Äî <span class="muted">${euro(m.pu)}</span> `
          + `<select id="cgq-${m.id}">${opts(20)}</select></label>`
        )).join('')
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"submitTab_Coupure("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_Coupure(key){
  const pick=id=>+document.getElementById(id).value||0;
  const defs = [
    { id:"45A", label:"Coupure g√©n√©rale 45 A", pu:80 },
    { id:"60A", label:"Coupure g√©n√©rale 60 A", pu:110 }
  ].map(d=>({ ...d, q: pick("cgq-"+d.id) })).filter(d=>d.q>0);

  if(!defs.length){ pageTabHome(key); return; }
  ensureTableauKey(key);
  defs.forEach(d=>{
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:d.label,
      qty:d.q, prixU:d.pu, __tabKey:key
    });
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.4 ‚Ä¢ Disjoncteurs modulaires (+ d√©tails) -->
<script>
function pageTab_Disjoncteurs(key){
  const opts=(max=30)=>Array.from({length:max+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  const line = amp => (
    `<label>${amp} A <select id="djq-${amp}">${opts(30)}</select> `
    + `${b("D√©tail circuits","pageTab_DisjDetails("+JSON.stringify(key)+","+amp+")")}</label>`
  );
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Disjoncteurs modulaires</h2>'
      + '<div class="list">'
        + line(2) + line(10) + line(16) + line(20) + line(32) + line(40)
        + `<label>Calibre personnalis√©
             <input id="djq-custom-label" placeholder="ex: 50 A, 3x20A‚Ä¶">
             Qt√© <select id="djq-custom">${opts(30)}</select>
             ${b("D√©tail circuits","pageTab_DisjDetails("+JSON.stringify(key)+", '__custom__')")}
           </label>`
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"pageTab_DisjValider("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
  ["2","10","16","20","32","40"].forEach(r=>{
    const el=document.getElementById("djq-"+r);
    if(el && tabState.disj[+r]) el.value=tabState.disj[+r].qty||0;
  });
  if(document.getElementById("djq-custom")){
    document.getElementById("djq-custom").value = tabState.disj.__custom__.qty||0;
    document.getElementById("djq-custom-label").value = tabState.disj.__custom__.label||"";
  }
}
function pageTab_DisjDetails(key, rating){
  saveDisjQtyFromUI();
  const st=tabState.disj[rating] || {qty:0,details:[]};
  const qty=st.qty||0; if(!st.details) st.details=[];
  const row=(i,d)=>{
    const type=d?.type||'', note=d?.note||'';
    return `
      <div class="pill" style="width:100%;">
        <select data-idx="${i}" class="dj-type">
          <option value="">(non d√©fini)</option>
          <option value="Circuit prise" ${type==='Circuit prise'?'selected':''}>Circuit prise</option>
          <option value="Circuit √©clairage" ${type==='Circuit √©clairage'?'selected':''}>Circuit √©clairage</option>
          <optgroup label="Circuits sp√©cialis√©s">
            <option value="Four" ${type==='Four'?'selected':''}>Four</option>
            <option value="Plaque de cuisson" ${type==='Plaque de cuisson'?'selected':''}>Plaque de cuisson</option>
            <option value="Lave-linge" ${type==='Lave-linge'?'selected':''}>Lave-linge</option>
            <option value="Lave-vaisselle" ${type==='Lave-vaisselle'?'selected':''}>Lave-vaisselle</option>
            <option value="S√®che-linge" ${type==='S√®che-linge'?'selected':''}>S√®che-linge</option>
            <option value="Cumulus" ${type==='Cumulus'?'selected':''}>Cumulus</option>
            <option value="VMC" ${type==='VMC'?'selected':''}>VMC</option>
            <option value="Chauffage" ${type==='Chauffage'?'selected':''}>Chauffage</option>
            <option value="Climatisation" ${type==='Climatisation'?'selected':''}>Climatisation</option>
            <option value="Prise ext√©rieure √©tanche" ${type==='Prise ext√©rieure √©tanche'?'selected':''}>Prise ext√©rieure √©tanche</option>
            <option value="__custom__">Nom personnalis√©‚Ä¶</option>
          </optgroup>
        </select>
        <input data-idx="${i}" class="dj-note" placeholder="Caract√©ristique / nom (facultatif)" value="${(note||'').replace(/"/g,'&quot;')}" />
      </div>
    `;
  };
  let out=''; for(let i=0;i<qty;i++){ out+=row(i, st.details[i]||{}); }
  view(
    '<div class="card">'
      + b("Retour","pageTab_Disjoncteurs("+JSON.stringify(key)+")","btn back")
      + '<h2>D√©tail circuits ‚Äî '+(rating==='__custom__'?(tabState.disj.__custom__.label||'Calibre personnalis√©'):(rating+' A'))+'</h2>'
      + '<div id="dj-detail-container">'+out+'</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Enregistrer","pageTab_DisjSaveDetails("+JSON.stringify(key)+","+JSON.stringify(rating)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function pageTab_DisjSaveDetails(key, rating){
  const types=[...document.querySelectorAll('.dj-type')];
  const notes=[...document.querySelectorAll('.dj-note')];
  const details=[];
  for(let i=0;i<types.length;i++){
    let t=types[i]?.value||''; if(t==="__custom__"){ t=prompt("Nom personnalis√© du circuit :","")||("Circuit "+(i+1)); }
    const n=notes[i]?.value||''; details.push({type:t,note:n});
  }
  if(!tabState.disj[rating]) tabState.disj[rating]={qty:0,details:[]};
  tabState.disj[rating].details=details;
  saveLocal(); pageTab_Disjoncteurs(key);
}
function pageTab_DisjValider(key){
  saveDisjQtyFromUI();
  const PU=Object.assign({}, (TARIFS_TABLEAU && TARIFS_TABLEAU.disjoncteurs)?TARIFS_TABLEAU.disjoncteurs:{}, {40:45});
  ensureTableauKey(key);

  [2,10,16,20,32,40].forEach(r=>{
    const st=tabState.disj[r];
    if(st && st.qty>0){
      const hasDetail=Array.isArray(st.details)&&st.details.some(d=>d&&(d.type||d.note));
      const detailText=hasDetail?' ‚Äî circuits : '+st.details.map((d,i)=>(d.type||('Circuit '+(i+1)))+(d.note?(' ('+d.note+')'):'')).join(', '):'';
      devis[key].items.push({
        category:"Tableau/Modulaire",
        designation:`Disjoncteur ${r} A${detailText}`,
        qty:st.qty, prixU:PU[r]||0, __tabKey:key
      });
    }
  });

  const c=tabState.disj.__custom__;
  if(c && c.qty>0){
    const label=(c.label||"Calibre personnalis√©").trim();
    const hasDetail=Array.isArray(c.details)&&c.details.some(d=>d&&(d.type||d.note));
    const detailText=hasDetail?' ‚Äî circuits : '+c.details.map((d,i)=>(d.type||('Circuit '+(i+1)))+(d.note?(' ('+d.note+')'):'')).join(', '):'';
    const pu=parseFloat(prompt("Prix unitaire pour ¬´ "+label+" ¬ª (‚Ç¨) :","0")||"0")||0;
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:`Disjoncteur ${label}${detailText}`,
      qty:c.qty, prixU:pu, __tabKey:key
    });
  }
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.5 ‚Ä¢ Commandes & pilotage -->
<script>
function pageTabMod_Commandes(key){
  const PC=(TARIFS_TABLEAU && TARIFS_TABLEAU.commandes)?TARIFS_TABLEAU.commandes:{};
  const opts=Object.keys(PC).map(k=>`<option value="${k}">${k} (${euro(PC[k]||0)})</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Commande & pilotage</h2>'
      + '<label>Mod√®le</label><select id="cmd-model">'+opts+'</select>'
      + '<label>Quantit√©</label><input id="cmd-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"submitTabMod_Commandes("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Commandes(key){
  const model=document.getElementById("cmd-model").value;
  const qty=Math.max(1, parseInt(document.getElementById("cmd-qty").value,10)||1);
  const pu=(TARIFS_TABLEAU && TARIFS_TABLEAU.commandes)?(TARIFS_TABLEAU.commandes[model]||0):0;
  ensureTableauKey(key);
  devis[key].items.push({ category:"Tableau/Commandes", designation:model, qty, prixU:pu, __tabKey:key });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.6 ‚Ä¢ √âl√©ment sp√©cifique -->
<script>
function pageTabMod_Specifique(key){
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>√âl√©ment sp√©cifique</h2>'
      + '<label>Intitul√©</label><input id="spec-label" />'
      + '<label>Prix unitaire (‚Ç¨)</label><input id="spec-price" type="number" inputmode="decimal" />'
      + '<label>Quantit√©</label><input id="spec-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"submitTabMod_Specifique("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Specifique(key){
  const label=(document.getElementById("spec-label").value||"").trim();
  const prix=parseFloat(document.getElementById("spec-price").value)||0;
  const qty=Math.max(1,parseInt(document.getElementById("spec-qty").value,10)||1);
  if(!label){ pageTabHome(key); return; }
  ensureTableauKey(key);
  devis[key].items.push({ category:"Tableau/Sp√©cifique", designation:label, qty, prixU:prix, __tabKey:key });
  saveLocal(); pageTabHome(key);
}
</script>









  
  
  
<!-- =======================================================================
     CHAPITRE 7 : VENTILATION ‚Äî corrig√© (libell√©s explicites, sans gros titres)
     ======================================================================= -->
<script>
/* √âtat local par ventilation */
var ventState = {};

/* S√©curit√© : pr√©sence d‚Äôune section VMC c√¥t√© devis + √©tat local par cl√© */
function ensureVentKey(key){
  if(!devis[key]) devis[key] = { __base:"VMC", __customName:"", items:[], note:"" };
  if(!ventState[key]) ventState[key] = {
    creation: {
      kit: {
        ref:"", d80:1, d125:1,
        conduits:[{type:"Gaine isol√©e"}],
        percements:[{support:"Placo", qty:0}]
      },
      extracteur: {
        ref:"", diam:"100",
        conduits:[{type:"Gaine isol√©e"}],
        percements:[{support:"Placo", qty:0}]
      },
      ventilateur: {
        ref:"", diam:"100", typeConduit:"Gaine isol√©e", longueur:0,
        percements:[{support:"Placo", qty:0}]
      }
    },
    retirage: { n80:0, n125:0 },
    entretien: { type:"Groupe VMC", nb:0 }
  };
}

/* Helpers lecture champs */
function pickVal(id, def){ var el=document.getElementById(id); return (el?el.value:def); }
function pickNum(id, def){ var el=document.getElementById(id); var v=parseFloat(el?el.value:NaN); return isNaN(v)?(def||0):v; }

/* ============================
   Accueil Ventilation
   ============================ */
function pageVentAccueil(){
  if(typeof devis.__ventCounter!=="number") devis.__ventCounter = 0;

  var keys = Object.keys(devis).filter(function(k){
    if(k.indexOf('__')===0) return false;
    var s = devis[k]||{};
    return (s.__base||"").toLowerCase()==="vmc";
  });

  var list = keys.length ? keys.map(function(k){
    var s=devis[k]||{};
    var titre = k + (s.__customName?(" ‚Äî "+s.__customName):"");
    var nb = (s.items||[]).length;
    return '<div class="pill">'
          +'<strong>'+titre+'</strong> <small>'+nb+' ligne(s)</small>'
          + b('Ouvrir','pageVentHome('+JSON.stringify(k)+')','btn')
          + b('Supprimer','ventDelete('+JSON.stringify(k)+')','btn')
          +'</div>';
  }).join('') : '<p class="muted">Aucune ventilation pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Ventilation</h2>'
      + b('‚ûï Ajouter une ventilation','pageVentNew()','btn primary')
    + '</div>'
    + '<div class="card" style="margin-top:12px;">'
      + '<h2>Liste</h2>'
      + list
    + '</div>'
  );
}

function pageVentNew(){
  devis.__ventCounter++;
  var key = 'Ventilation '+devis.__ventCounter;
  ensureVentKey(key); saveLocal();
  view(
    '<div class="card">'
      + b('Retour','pageVentAccueil()','btn back')
      + '<h2>Nouvelle ventilation</h2>'
      + '<p><strong>Identifiant : '+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="vent-name" placeholder="ex : VMC habitation, Local technique‚Ä¶" />'
      + '<div class="row" style="margin-top:10px;">'
        + b('Valider','saveVentName('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function saveVentName(key){
  var name = (document.getElementById('vent-name').value||'').trim();
  if(devis[key]) devis[key].__customName = name;
  saveLocal(); pageVentHome(key);
}
function ventDelete(key){
  if(!confirm('Supprimer ¬´ '+key+' ¬ª ?')) return;
  delete devis[key]; saveLocal(); pageVentAccueil();
}

function pageVentHome(key){
  ensureVentKey(key);
  var custom = devis[key].__customName ? ' ‚Äî '+devis[key].__customName : '';
  view(
    '<div class="card">'
      + b('Retour','pageVentAccueil('+')','btn back')
      + '<h2>'+key+custom+'</h2>'
      + '<div class="row" style="margin-top:8px; gap:8px;">'
        + b('1 ¬∑ Cr√©ation','pageVentCreation('+JSON.stringify(key)+')','btn primary')
        + b('2 ¬∑ Retirage des conduits','pageVentRetirage('+JSON.stringify(key)+')','btn')
        + b('3 ¬∑ Entretien','pageVentEntretien('+JSON.stringify(key)+')','btn')
      + '</div>'
      + '<p class="muted" style="margin-top:6px;">Ajoutez ici les lignes li√©es √† la ventilation (kit, extracteur, ventilateur, retirage, entretien‚Ä¶)</p>'
    + '</div>'
  );
}

/* ============================
   Cr√©ation (Kit / Extracteur / Ventilateur)
   ‚Äî Sans gros titres, mais avec libell√©s explicites
   ============================ */
function pageVentCreation(key){
  ensureVentKey(key);
  var st = ventState[key].creation;

  // Bloc : Liste de conduits (type)
  function conduitsBlock(arr, mutFn, prefix, legend){
    var rows = arr.map(function(c,i){
      var sel = ['Gaine isol√©e','Conduit rigide','Conduit rigide extra-plat','Gaine non isol√©e']
        .map(function(t){ return '<option '+(t===c.type?'selected':'')+'>'+t+'</option>'; }).join('');
      return (
        '<div class="pill" style="width:100%;">'
          + '<div style="flex:1 1 auto;">'
            + '<label><small>'+legend+' ‚Äî √©l√©ment n¬∞'+(i+1)+'</small></label>'
            + '<select id="'+prefix+'-type-'+i+'">'+sel+'</select>'
          + '</div>'
          + (i>0 ? b('√ó',mutFn+'('+JSON.stringify(key)+',"del",'+i+')','btn') : '')
        + '</div>'
      );
    }).join('');
    return rows + '<div class="row">'+ b('Ajouter un conduit',mutFn+'('+JSON.stringify(key)+',"add")','btn') +'</div>';
  }

  // Bloc : Liste de percements (support + quantit√©)
  function percementsBlock(arr, mutFn, prefix, legend){
    var supports=['Placo','Briquette','Ourdi b√©ton'];
    var rows = arr.map(function(p,i){
      var opts=supports.map(function(s){ return '<option '+(s===p.support?'selected':'')+'>'+s+'</option>'; }).join('');
      return (
        '<div class="pill" style="width:100%;">'
          + '<div style="flex:1 1 220px;">'
            + '<label><small>'+legend+' ‚Äî support du percement n¬∞'+(i+1)+'</small></label>'
            + '<select id="'+prefix+'-sup-'+i+'">'+opts+'</select>'
          + '</div>'
          + '<div style="flex:0 0 140px;">'
            + '<label><small>Quantit√© (nb de trous)</small></label>'
            + '<input id="'+prefix+'-qty-'+i+'" type="number" min="0" value="'+(p.qty||0)+'" />'
          + '</div>'
          + (i>0 ? b('√ó',mutFn+'('+JSON.stringify(key)+',"del",'+i+')','btn') : '')
        + '</div>'
      );
    }).join('');
    return rows + '<div class="row">'+ b('Ajouter un percement',mutFn+'('+JSON.stringify(key)+',"add")','btn') +'</div>';
  }

  // UI
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Cr√©ation</h2>'

      // ‚Äî Kit VMC (avec libell√©s)
      + '<div class="pill" style="margin:6px 0;"><strong>Kit VMC</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="kit-ref" placeholder="R√©f. du kit" value="'+st.kit.ref+'"/>'
      + '<div class="row">'
        + '<div style="flex:1 1 160px;">'
          + '<label>Nombre de bouches √ò80</label>'
          + '<input id="kit-d80" type="number" min="0" value="'+st.kit.d80+'"/>'
        + '</div>'
        + '<div style="flex:1 1 160px;">'
          + '<label>Nombre de bouches √ò125</label>'
          + '<input id="kit-d125" type="number" min="0" value="'+st.kit.d125+'"/>'
        + '</div>'
      + '</div>'
      + '<div style="margin-top:8px;">'+conduitsBlock(st.kit.conduits,"kitConduitMut","kitc","Kit VMC ‚Äî type de conduit")+'</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.kit.percements,"kitPercMut","kitp","Kit VMC")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter le Kit VMC','ventAddKit('+JSON.stringify(key)+')','btn primary') +'</div>'

      // ‚Äî Extracteur
      + '<hr style="margin:16px 0; border:none; border-top:1px solid var(--line);" />'
      + '<div class="pill" style="margin:6px 0;"><strong>Extracteur</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="ex-ref" placeholder="R√©f. de l‚Äôextracteur" value="'+st.extracteur.ref+'"/>'
      + '<label>Diam√®tre de raccord (mm)</label>'
      + '<select id="ex-diam">'+['80','100','125'].map(function(d){return '<option '+(d===st.extracteur.diam?'selected':'')+'>'+d+'</option>';}).join('')+'</select>'
      + '<div style="margin-top:8px;">'+conduitsBlock(st.extracteur.conduits,"exConduitMut","exc","Extracteur ‚Äî type de conduit")+'</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.extracteur.percements,"exPercMut","exp","Extracteur")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter l‚ÄôExtracteur','ventAddExtracteur('+JSON.stringify(key)+')','btn primary') +'</div>'

      // ‚Äî Ventilateur de conduit
      + '<hr style="margin:16px 0; border:none; border-top:1px solid var(--line);" />'
      + '<div class="pill" style="margin:6px 0;"><strong>Ventilateur de conduit</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="vc-ref" placeholder="R√©f. du ventilateur" value="'+st.ventilateur.ref+'"/>'
      + '<div class="row">'
        + '<div style="flex:1 1 160px;">'
          + '<label>Diam√®tre de raccord (mm)</label>'
          + '<select id="vc-diam">'+['80','100','125','150'].map(function(d){return '<option '+(d===st.ventilateur.diam?'selected':'')+'>'+d+'</option>';}).join('')+'</select>'
        + '</div>'
        + '<div style="flex:1 1 240px;">'
          + '<label>Type de conduit utilis√©</label>'
          + '<select id="vc-type">'+['Gaine isol√©e','Conduit rigide','Conduit rigide extra-plat','Gaine non isol√©e'].map(function(t){return '<option '+(t===st.ventilateur.typeConduit?'selected':'')+'>'+t+'</option>';}).join('')+'</select>'
        + '</div>'
        + '<div style="flex:1 1 160px;">'
          + '<label>Longueur de conduit (m)</label>'
          + '<input id="vc-len" type="number" min="0" step="0.1" value="'+st.ventilateur.longueur+'"/>'
        + '</div>'
      + '</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.ventilateur.percements,"vcPercMut","vcp","Ventilateur de conduit")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter le Ventilateur de conduit','ventAddVentilateur('+JSON.stringify(key)+')','btn primary') +'</div>'
    + '</div>'
  );
}

/* Mutateurs listes (ajout/suppression) */
function kitConduitMut(key,cmd,idx){ var arr=ventState[key].creation.kit.conduits; if(cmd==="add") arr.push({type:"Gaine isol√©e"}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function kitPercMut(key,cmd,idx){ var arr=ventState[key].creation.kit.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function exConduitMut(key,cmd,idx){ var arr=ventState[key].creation.extracteur.conduits; if(cmd==="add") arr.push({type:"Gaine isol√©e"}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function exPercMut(key,cmd,idx){ var arr=ventState[key].creation.extracteur.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function vcPercMut(key,cmd,idx){ var arr=ventState[key].creation.ventilateur.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }

/* Ajouts d‚Äôitems (on garde le m√™me niveau de d√©tail que pr√©c√©demment) */
function ventAddKit(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Kit VMC',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}
function ventAddExtracteur(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Extracteur',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}
function ventAddVentilateur(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Ventilateur conduit',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}

/* ============================
   Retirage des conduits
   ============================ */
function pageVentRetirage(key){
  ensureVentKey(key); var st=ventState[key].retirage;
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Retirage de conduits</h2>'
      + '<div class="row">'
        + '<div style="flex:1 1 200px;">'
          + '<label>Nombre de conduits √ò80 √† retirer</label>'
          + '<input id="rt-80" type="number" min="0" value="'+st.n80+'"/>'
        + '</div>'
        + '<div style="flex:1 1 200px;">'
          + '<label>Nombre de conduits √ò125 √† retirer</label>'
          + '<input id="rt-125" type="number" min="0" value="'+st.n125+'"/>'
        + '</div>'
      + '</div>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Ajouter le Retirage','ventAddRetirage('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function ventAddRetirage(key){
  var n80=pickNum('rt-80',0), n125=pickNum('rt-125',0);
  devis[key].items.push({
    category:'Ventilation/Retirage',
    designation:'Retirage √ò80='+n80+' / √ò125='+n125,
    qty:1, prixU:0, __tabKey:key
  });
  saveLocal(); pageVentHome(key);
}

/* ============================
   Entretien
   ============================ */
function pageVentEntretien(key){
  ensureVentKey(key); var st=ventState[key].entretien;
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Entretien</h2>'
      + '<label>√âl√©ment √† entretenir</label>'
      + '<select id="ent-type">'
        + ['Groupe VMC','Extracteur','Ventilateur de conduit'].map(function(t){ return '<option '+(t===st.type?'selected':'')+'>'+t+'</option>'; }).join('')
      + '</select>'
      + '<label style="margin-top:8px;">Nombre d‚Äôunit√©s</label>'
      + '<input id="ent-nb" type="number" min="0" value="'+st.nb+'"/>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Ajouter Entretien','ventAddEntretien('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function ventAddEntretien(key){
  var type=pickVal('ent-type','Groupe VMC'), nb=pickNum('ent-nb',0);
  devis[key].items.push({
    category:'Ventilation/Entretien',
    designation:'Entretien '+type+' ‚Äî nb='+nb,
    qty:1, prixU:0, __tabKey:key
  });
  saveLocal(); pageVentHome(key);
}
</script>








  
  
  
<!-- =============================
     CHAPITRE 8 : PARAM√âTRAGE DES TARIFS
     Index :
       8.0 ‚Ä¢ Styles + Helpers + Overrides (load/save/merge)
       8.1 ‚Ä¢ Accueil param√©trage
       8.2 ‚Ä¢ Prises (tarifs par intervention)
       8.3 ‚Ä¢ √âclairage ‚Äî Luminaires
       8.4 ‚Ä¢ √âclairage ‚Äî Commandes (intitul√©s en ‚Äúappareillage‚Äù)
       8.5 ‚Ä¢ Circuit sp√©cialis√© (base + coefficients de section)
       8.6 ‚Ä¢ Coefficients de pose (communs)
     ============================= -->

<!-- 8.0 ‚Ä¢ Styles + Helpers + Overrides -->
<style>
  /* Mise en page plus lisible sur le chapitre Param√©trage */
  .tarif-wrap .card.tarif-card{ margin-bottom:24px; }               /* espace entre blocs */
  .tarif-wrap h2, .tarif-wrap h3{ margin:8px 0 10px; }
  .tarif-wrap label{ display:block; margin-top:14px; font-weight:600; }
  .tarif-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
  .tarif-grid .field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .tarif-grid .field small{ color:var(--muted); display:block; margin-top:6px; }
  .tarif-actions{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; }
</style>

<script>
// ========== Merge util ==========
function deepMergeTarifs(base, override){
  if(!override || typeof override!=='object') return;
  Object.keys(override).forEach(function(k){
    var ov = override[k];
    if(ov && typeof ov==='object' && !Array.isArray(ov)){
      if(!base[k] || typeof base[k]!=='object') base[k] = {};
      deepMergeTarifs(base[k], ov);
    } else {
      base[k] = ov;
    }
  });
}

// ========== Load / Save overrides ==========
function loadTarifsOverrides(){
  try{
    var raw = localStorage.getItem('tarifsOverrides');
    if(!raw) return;
    var ov = JSON.parse(raw||'{}')||{};
    // Fusion avec les objets globaux du Chapitre 3
    if(ov.TARIFS_BASE) deepMergeTarifs(TARIFS_BASE, ov.TARIFS_BASE);
    if(ov.COEFF_POSE) deepMergeTarifs(COEFF_POSE, ov.COEFF_POSE);
    if(ov.COEFF_SECTIONS_CS) deepMergeTarifs(COEFF_SECTIONS_CS, ov.COEFF_SECTIONS_CS);
  }catch(e){}
}
function saveTarifsOverrides(partialOv){
  try{
    var cur = JSON.parse(localStorage.getItem('tarifsOverrides')||'{}')||{};
    deepMergeTarifs(cur, partialOv||{});
    localStorage.setItem('tarifsOverrides', JSON.stringify(cur));
    alert('‚úÖ Param√®tres sauvegard√©s.');
  }catch(e){ alert('Impossible de sauvegarder les param√®tres.'); }
}

// Charger d‚Äô√©ventuels overrides d√®s le chargement de ce chapitre
loadTarifsOverrides();

// ========== Helpers UI ==========
function _tfVal(id){ var el=document.getElementById(id); return parseFloat(el && el.value || '0')||0; }
function _setVal(id, v){ var el=document.getElementById(id); if(el) el.value = (v!=null?v:''); }
function _numInput(id, val){ return '<input id="'+id+'" type="number" inputmode="decimal" step="1" min="0" value="'+(val||0)+'" />'; }
</script>

<!-- 8.1 ‚Ä¢ Accueil param√©trage -->
<script>
function pageTarifsAccueil(){
  view(
    '<div class="tarif-wrap">'
    + '<div class="card tarif-card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Param√©trage des tarifs</h2>'
      + '<p class="muted">Ajuste ici les tarifs unitaires et coefficients utilis√©s dans les calculs.</p>'
      + '<div class="row" style="margin-top:8px;">'
        + b('Prises','pageTarifsPrises()','btn primary')
        + b('√âclairage ‚Äî Luminaires','pageTarifsEclLuminaires()','btn')
        + b('√âclairage ‚Äî Commandes','pageTarifsEclCommandes()','btn')
        + b('Circuit sp√©cialis√©','pageTarifsCS()','btn')
        + b('Coefficients de pose','pageTarifsCoeffsPose()','btn')
      + '</div>'
    + '</div>'
    + '</div>'
  );
}
</script>

<!-- 8.2 ‚Ä¢ Prises -->
<script>
function pageTarifsPrises(){
  var base = (TARIFS_BASE && TARIFS_BASE.prises) ? TARIFS_BASE.prises : {};
  view(
    '<div class="tarif-wrap">'
    + '<div class="card tarif-card">'
      + b('Retour','pageTarifsAccueil()','btn back')
      + '<h2>Prises ‚Äî tarifs par intervention</h2>'
      + '<div class="tarif-grid">'
        + '<div class="field"><label>Cr√©ation</label>'+_numInput('pris_cre', base['Cr√©ation'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Remplacement appareillage</label>'+_numInput('pris_rem_app', base['Remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage avec remplacement appareillage</label>'+_numInput('pris_rec_avec', base['Rec√¢blage avec remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage sans remplacement appareillage</label>'+_numInput('pris_rec_sans', base['Rec√¢blage sans remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
      + '</div>'
      + '<div class="tarif-actions">'
        + b('üíæ Enregistrer','saveTarifsPrises()','btn primary')
      + '</div>'
    + '</div>'
    + '</div>'
  );
}
function saveTarifsPrises(){
  var ov = {
    TARIFS_BASE: {
      prises: {
        'Cr√©ation': _tfVal('pris_cre'),
        'Remplacement appareillage': _tfVal('pris_rem_app'),
        'Rec√¢blage avec remplacement appareillage': _tfVal('pris_rec_avec'),
        'Rec√¢blage sans remplacement appareillage': _tfVal('pris_rec_sans')
      }
    }
  };
  // Appliquer en m√©moire + sauver
  deepMergeTarifs(TARIFS_BASE, ov.TARIFS_BASE);
  saveTarifsOverrides(ov);
}
</script>

<!-- 8.3 ‚Ä¢ √âclairage ‚Äî Luminaires -->
<script>
function pageTarifsEclLuminaires(){
  var e = (TARIFS_BASE && TARIFS_BASE.eclairage) ? TARIFS_BASE.eclairage : {};
  var PDC = e['Point de centre'] || {};
  var APP = e['Applique'] || {};
  view(
    '<div class="tarif-wrap">'
    + '<div class="card tarif-card">'
      + b('Retour','pageTarifsAccueil()','btn back')
      + '<h2>√âclairage ‚Äî Luminaires</h2>'
      + '<h3>Point de centre</h3>'
      + '<div class="tarif-grid">'
        + '<div class="field"><label>Cr√©ation</label>'+_numInput('lum_pdc_cre', PDC['Cr√©ation'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Remplacement luminaire</label>'+_numInput('lum_pdc_rem_lum', PDC['Remplacement luminaire'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage avec remplacement luminaire</label>'+_numInput('lum_pdc_rec_avec', PDC['Rec√¢blage avec remplacement luminaire'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage sans remplacement luminaire</label>'+_numInput('lum_pdc_rec_sans', PDC['Rec√¢blage sans remplacement luminaire'])+'<small>Tarif unitaire</small></div>'
      + '</div>'

      + '<h3 style="margin-top:18px;">Applique</h3>'
      + '<div class="tarif-grid">'
        + '<div class="field"><label>Cr√©ation</label>'+_numInput('lum_app_cre', APP['Cr√©ation'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Remplacement luminaire</label>'+_numInput('lum_app_rem_lum', APP['Remplacement luminaire'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage avec remplacement luminaire</label>'+_numInput('lum_app_rec_avec', APP['Rec√¢blage avec remplacement luminaire'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage sans remplacement luminaire</label>'+_numInput('lum_app_rec_sans', APP['Rec√¢blage sans remplacement luminaire'])+'<small>Tarif unitaire</small></div>'
      + '</div>'

      + '<div class="tarif-actions">'
        + b('üíæ Enregistrer','saveTarifsEclLuminaires()','btn primary')
      + '</div>'
    + '</div>'
    + '</div>'
  );
}
function saveTarifsEclLuminaires(){
  var ov = {
    TARIFS_BASE: {
      eclairage: {
        'Point de centre': {
          'Cr√©ation': _tfVal('lum_pdc_cre'),
          'Remplacement luminaire': _tfVal('lum_pdc_rem_lum'),
          'Rec√¢blage avec remplacement luminaire': _tfVal('lum_pdc_rec_avec'),
          'Rec√¢blage sans remplacement luminaire': _tfVal('lum_pdc_rec_sans')
        },
        'Applique': {
          'Cr√©ation': _tfVal('lum_app_cre'),
          'Remplacement luminaire': _tfVal('lum_app_rem_lum'),
          'Rec√¢blage avec remplacement luminaire': _tfVal('lum_app_rec_avec'),
          'Rec√¢blage sans remplacement luminaire': _tfVal('lum_app_rec_sans')
        }
      }
    }
  };
  deepMergeTarifs(TARIFS_BASE, ov.TARIFS_BASE);
  saveTarifsOverrides(ov);
}
</script>

<!-- 8.4 ‚Ä¢ √âclairage ‚Äî Commandes (intitul√©s en ‚Äúappareillage‚Äù) -->
<script>
function pageTarifsEclCommandes(){
  var e = (TARIFS_BASE && TARIFS_BASE.eclairage) ? TARIFS_BASE.eclairage : {};
  var IS = e['Interrupteur simple'] || {};
  var ID = e['Interrupteur double'] || {};
  view(
    '<div class="tarif-wrap">'
    + '<div class="card tarif-card">'
      + b('Retour','pageTarifsAccueil()','btn back')
      + '<h2>√âclairage ‚Äî Commandes</h2>'
      + '<h3>Interrupteur simple</h3>'
      + '<div class="tarif-grid">'
        + '<div class="field"><label>Cr√©ation</label>'+_numInput('cmd_is_cre', IS['Cr√©ation'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Remplacement appareillage</label>'+_numInput('cmd_is_rem_app', IS['Remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage avec remplacement appareillage</label>'+_numInput('cmd_is_rec_avec', IS['Rec√¢blage avec remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage sans remplacement appareillage</label>'+_numInput('cmd_is_rec_sans', IS['Rec√¢blage sans remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
      + '</div>'

      + '<h3 style="margin-top:18px;">Interrupteur double</h3>'
      + '<div class="tarif-grid">'
        + '<div class="field"><label>Cr√©ation</label>'+_numInput('cmd_id_cre', ID['Cr√©ation'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Remplacement appareillage</label>'+_numInput('cmd_id_rem_app', ID['Remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage avec remplacement appareillage</label>'+_numInput('cmd_id_rec_avec', ID['Rec√¢blage avec remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage sans remplacement appareillage</label>'+_numInput('cmd_id_rec_sans', ID['Rec√¢blage sans remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
      + '</div>'

      + '<div class="tarif-actions">'
        + b('üíæ Enregistrer','saveTarifsEclCommandes()','btn primary')
      + '</div>'
    + '</div>'
    + '</div>'
  );
}
function saveTarifsEclCommandes(){
  var ov = {
    TARIFS_BASE: {
      eclairage: {
        'Interrupteur simple': {
          'Cr√©ation': _tfVal('cmd_is_cre'),
          'Remplacement appareillage': _tfVal('cmd_is_rem_app'),
          'Rec√¢blage avec remplacement appareillage': _tfVal('cmd_is_rec_avec'),
          'Rec√¢blage sans remplacement appareillage': _tfVal('cmd_is_rec_sans')
        },
        'Interrupteur double': {
          'Cr√©ation': _tfVal('cmd_id_cre'),
          'Remplacement appareillage': _tfVal('cmd_id_rem_app'),
          'Rec√¢blage avec remplacement appareillage': _tfVal('cmd_id_rec_avec'),
          'Rec√¢blage sans remplacement appareillage': _tfVal('cmd_id_rec_sans')
        }
      }
    }
  };
  deepMergeTarifs(TARIFS_BASE, ov.TARIFS_BASE);
  saveTarifsOverrides(ov);
}
</script>

<!-- 8.5 ‚Ä¢ Circuit sp√©cialis√© (base + coefficients de section) -->
<script>
function pageTarifsCS(){
  var base = (TARIFS_BASE && TARIFS_BASE.circuit_specialise_base) ? TARIFS_BASE.circuit_specialise_base : {};
  view(
    '<div class="tarif-wrap">'
    + '<div class="card tarif-card">'
      + b('Retour','pageTarifsAccueil()','btn back')
      + '<h2>Circuit sp√©cialis√© ‚Äî base & coefficients</h2>'

      + '<h3>Tarifs base (par intervention)</h3>'
      + '<div class="tarif-grid">'
        + '<div class="field"><label>Cr√©ation</label>'+_numInput('cs_cre', base['Cr√©ation'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Remplacement appareillage</label>'+_numInput('cs_rem_app', base['Remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage avec remplacement appareillage</label>'+_numInput('cs_rec_avec', base['Rec√¢blage avec remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
        + '<div class="field"><label>Rec√¢blage sans remplacement appareillage</label>'+_numInput('cs_rec_sans', base['Rec√¢blage sans remplacement appareillage'])+'<small>Tarif unitaire</small></div>'
      + '</div>'

      + '<h3 style="margin-top:18px;">Coefficients de section</h3>'
      + '<div class="tarif-grid">'
        + '<div class="field"><label>0,75 mm¬≤</label>'+_numInput('cs_coef_075', COEFF_SECTIONS_CS['0,75 mm¬≤'])+'<small>Coefficient</small></div>'
        + '<div class="field"><label>1,5 mm¬≤</label>'+_numInput('cs_coef_15', COEFF_SECTIONS_CS['1,5 mm¬≤'])+'<small>Coefficient</small></div>'
        + '<div class="field"><label>2,5 mm¬≤</label>'+_numInput('cs_coef_25', COEFF_SECTIONS_CS['2,5 mm¬≤'])+'<small>Coefficient</small></div>'
        + '<div class="field"><label>6 mm¬≤</label>'+_numInput('cs_coef_6', COEFF_SECTIONS_CS['6 mm¬≤'])+'<small>Coefficient</small></div>'
      + '</div>'

      + '<div class="tarif-actions">'
        + b('üíæ Enregistrer','saveTarifsCS()','btn primary')
      + '</div>'
    + '</div>'
    + '</div>'
  );
}
function saveTarifsCS(){
  var ov = {
    TARIFS_BASE: {
      circuit_specialise_base: {
        'Cr√©ation': _tfVal('cs_cre'),
        'Remplacement appareillage': _tfVal('cs_rem_app'),
        'Rec√¢blage avec remplacement appareillage': _tfVal('cs_rec_avec'),
        'Rec√¢blage sans remplacement appareillage': _tfVal('cs_rec_sans')
      }
    },
    COEFF_SECTIONS_CS: {
      '0,75 mm¬≤': _tfVal('cs_coef_075'),
      '1,5 mm¬≤':  _tfVal('cs_coef_15'),
      '2,5 mm¬≤':  _tfVal('cs_coef_25'),
      '6 mm¬≤':    _tfVal('cs_coef_6')
    }
  };
  deepMergeTarifs(TARIFS_BASE, ov.TARIFS_BASE);
  deepMergeTarifs(COEFF_SECTIONS_CS, ov.COEFF_SECTIONS_CS);
  saveTarifsOverrides(ov);
}
</script>

<!-- 8.6 ‚Ä¢ Coefficients de pose (communs) -->
<script>
function pageTarifsCoeffsPose(){
  view(
    '<div class="tarif-wrap">'
    + '<div class="card tarif-card">'
      + b('Retour','pageTarifsAccueil()','btn back')
      + '<h2>Coefficients de pose</h2>'
      + '<div class="tarif-grid">'
        + '<div class="field"><label>Placo</label>'+_numInput('cp_placo', COEFF_POSE['Placo'])+'<small>Coefficient</small></div>'
        + '<div class="field"><label>Encastr√© ma√ßonnerie</label>'+_numInput('cp_maco', COEFF_POSE['Encastr√© ma√ßonnerie'])+'<small>Coefficient</small></div>'
        + '<div class="field"><label>Semi-encastr√©</label>'+_numInput('cp_semi', COEFF_POSE['Semi-encastr√©'])+'<small>Coefficient</small></div>'
        + '<div class="field"><label>Sur-mesure</label>'+_numInput('cp_surmes', COEFF_POSE['Sur-mesure'])+'<small>Coefficient</small></div>'
        + '<div class="field"><label>Saillie avec moulure</label>'+_numInput('cp_moul', COEFF_POSE['Saillie avec moulure'])+'<small>Coefficient</small></div>'
        + '<div class="field"><label>Sous tube IRL</label>'+_numInput('cp_irl', COEFF_POSE['Sous tube IRL'])+'<small>Coefficient</small></div>'
      + '</div>'
      + '<div class="tarif-actions">'
        + b('üíæ Enregistrer','saveTarifsCoeffsPose()','btn primary')
      + '</div>'
    + '</div>'
    + '</div>'
  );
}
function saveTarifsCoeffsPose(){
  var ov = {
    COEFF_POSE: {
      'Placo': _tfVal('cp_placo'),
      'Encastr√© ma√ßonnerie': _tfVal('cp_maco'),
      'Semi-encastr√©': _tfVal('cp_semi'),
      'Sur-mesure': _tfVal('cp_surmes'),
      'Saillie avec moulure': _tfVal('cp_moul'),
      'Sous tube IRL': _tfVal('cp_irl')
    }
  };
  deepMergeTarifs(COEFF_POSE, ov.COEFF_POSE);
  saveTarifsOverrides(ov);
}
</script>

<!-- Expose minimal (si tu veux appeler depuis le menu principal) -->
<script>
Object.assign(window, {
  pageTarifsAccueil,
  pageTarifsPrises,
  pageTarifsEclLuminaires,
  pageTarifsEclCommandes,
  pageTarifsCS,
  pageTarifsCoeffsPose
});
</script>

  <!-- =============================
     8.7 ‚Ä¢ Personnalisation avanc√©e (JSON, ajout-only)
     ============================= -->
<script>
// ---------- Stockage ----------
const CUSTOM_SCHEMA_KEY = 'tarifsCustomSchema';

// ---------- Helpers merge (ajouts SANS √©crasement du tronc) ----------
function addUniqueToArray(baseArr, addArr){
  if(!Array.isArray(baseArr) || !Array.isArray(addArr)) return;
  addArr.forEach(v => { if(baseArr.indexOf(v) === -1) baseArr.push(v); });
}
function mergeObjectAddOnly(base, add){
  if(!add || typeof add!=='object') return;
  Object.keys(add).forEach(k=>{
    const v = add[k];
    if(base[k] == null){
      // cl√© nouvelle ‚Üí on ajoute telle quelle
      base[k] = Array.isArray(v) ? v.slice() : (typeof v==='object' ? JSON.parse(JSON.stringify(v)) : v);
    }else{
      // cl√© existante ‚Üí on N'√âCRASE PAS, on compl√®te seulement
      if(Array.isArray(base[k]) && Array.isArray(v)) addUniqueToArray(base[k], v);
      else if(typeof base[k]==='object' && typeof v==='object') mergeObjectAddOnly(base[k], v);
      // sinon (nombre/string d√©j√† d√©fini) ‚Üí on ne touche pas
    }
  });
}

// ---------- Application du sch√©ma perso au runtime ----------
function applyCustomSchema(){
  let custom;
  try{ custom = JSON.parse(localStorage.getItem(CUSTOM_SCHEMA_KEY)||'{}')||{}; }catch(e){ custom = {}; }

  // 1) Listes ‚Äúsimples‚Äù (cat√©gories, poses, sections) ‚Äî ajouts only
  if(Array.isArray(custom.CATEGORIES))        addUniqueToArray(CATEGORIES, custom.CATEGORIES);
  if(Array.isArray(custom.POSES))             addUniqueToArray(POSES, custom.POSES);
  if(Array.isArray(custom.SECTIONS_CABLE))    addUniqueToArray(SECTIONS_CABLE, custom.SECTIONS_CABLE);

  // 2) D√©signations par branche (ex: "√âclairage/Luminaires": ["Rail LED", ...])
  if(custom.DESIGNATIONS_PAR_CATEGORIE && typeof custom.DESIGNATIONS_PAR_CATEGORIE==='object'){
    Object.keys(custom.DESIGNATIONS_PAR_CATEGORIE).forEach(cat=>{
      const adds = custom.DESIGNATIONS_PAR_CATEGORIE[cat];
      if(!Array.isArray(adds)) return;
      if(!DESIGNATIONS_PAR_CATEGORIE[cat]) DESIGNATIONS_PAR_CATEGORIE[cat] = [];
      addUniqueToArray(DESIGNATIONS_PAR_CATEGORIE[cat], adds);
    });
  }

  // 3) Tarifs pour les NOUVELLES d√©signations d‚Äô√©clairage (on n‚Äô√©crase pas les existantes)
  //    Format attendu :
  //    { "TARIFS_BASE": { "eclairage": { "Ma nouvelle d√©signation": { "Cr√©ation": 120, ... } } } }
  if(custom.TARIFS_BASE && custom.TARIFS_BASE.eclairage){
    const src = custom.TARIFS_BASE.eclairage;
    Object.keys(src).forEach(desig=>{
      if(!TARIFS_BASE.eclairage[desig]) TARIFS_BASE.eclairage[desig] = {}; // nouvelle d√©signation permise
      mergeObjectAddOnly(TARIFS_BASE.eclairage[desig], src[desig]);        // ajoute interventions sans √©craser celles d√©j√† pr√©sentes
    });
  }

  // 4) (facultatif) coefficients de pose/sections ‚Äî ajoute les nouvelles cl√©s uniquement
  if(custom.COEFF_POSE)           mergeObjectAddOnly(COEFF_POSE, custom.COEFF_POSE);
  if(custom.COEFF_SECTIONS_CS)    mergeObjectAddOnly(COEFF_SECTIONS_CS, custom.COEFF_SECTIONS_CS);
}
// Applique au chargement du chapitre
applyCustomSchema();

// ---------- UI ----------
function pageTarifsPersoJSON(){
  // mod√®le minimal affich√© si aucun JSON encore enregistr√©
  const example = JSON.stringify({
    "CATEGORIES": ["Domotique"],                // ajout√© au menu Cat√©gorie
    "POSES": ["Goulotte design"],               // ajout√© aux types de pose
    "SECTIONS_CABLE": ["10 mm¬≤"],               // ajout√© aux choix de section
    "DESIGNATIONS_PAR_CATEGORIE": {
      "√âclairage/Luminaires": ["Rail LED", "Suspension d√©co"],
      "√âclairage/Commandes": ["Variateur rotatif"],
      "Circuit sp√©cialis√©": ["Pompe de relevage"]  // libell√© sugg√©r√© lors de la saisie CS
    },
    "TARIFS_BASE": {
      "eclairage": {
        "Rail LED": {
          "Cr√©ation": 120,
          "Remplacement luminaire": 40
        },
        "Variateur rotatif": {
          "Cr√©ation": 55,
          "Remplacement appareillage": 30
        }
      }
    }
  }, null, 2);

  let current = '';
  try{ current = localStorage.getItem(CUSTOM_SCHEMA_KEY) || ''; }catch(e){}

  view(
    '<div class="tarif-wrap">'
    + '<div class="card tarif-card">'
      + b('Retour','pageTarifsAccueil()','btn back')
      + '<h2>Personnalisation avanc√©e (JSON)</h2>'
      + '<p class="muted">Ajoute cat√©gories, poses, sections, d√©signations et <em>tarifs pour les nouvelles d√©signations</em>. Le tronc existant n‚Äôest jamais √©cras√©.</p>'
      + '<label>JSON (ajouts only)</label>'
      + '<textarea id="custom-json" style="width:100%;height:320px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></textarea>'
      + '<div class="tarif-actions">'
        + b('üíæ Enregistrer','saveTarifsPersoJSON()','btn primary')
        + b('üßπ R√©initialiser','resetTarifsPersoJSON()','btn')
        + b('‚¨áÔ∏è Exporter','exportTarifsPersoJSON()','btn')
        + b('‚¨ÜÔ∏è Importer','importTarifsPersoJSON()','btn')
      + '</div>'
      + '<details style="margin-top:12px;"><summary>Exemple de structure</summary>'
      + '<pre style="margin-top:8px">'+escapeHtml(example)+'</pre>'
      + '</details>'
    + '</div>'
    + '</div>'
  );

  // remplir la zone
  const ta = document.getElementById('custom-json');
  ta.value = current || example;
}

function saveTarifsPersoJSON(){
  const ta = document.getElementById('custom-json');
  let obj;
  try{
    obj = JSON.parse(ta.value);
  }catch(e){
    alert('‚ùå JSON invalide : '+e.message);
    return;
  }
  // garde-fous simples : seules ces racines sont accept√©es
  const allowed = ['CATEGORIES','POSES','SECTIONS_CABLE','DESIGNATIONS_PAR_CATEGORIE','TARIFS_BASE','COEFF_POSE','COEFF_SECTIONS_CS'];
  const ok = Object.keys(obj).every(k=>allowed.indexOf(k)>=0);
  if(!ok){ alert('‚ùå Cl√©s non autoris√©es au niveau racine. Racines valides : '+allowed.join(', ')); return; }

  localStorage.setItem(CUSTOM_SCHEMA_KEY, JSON.stringify(obj));
  applyCustomSchema();
  alert('‚úÖ Ajouts enregistr√©s. Ils sont utilisables imm√©diatement.');
}

function resetTarifsPersoJSON(){
  if(!confirm('R√©initialiser toutes les personnalisations JSON ?')) return;
  localStorage.removeItem(CUSTOM_SCHEMA_KEY);
  // recharger les listes runtime (on repart sur le tronc)
  location.reload();
}

function exportTarifsPersoJSON(){
  const raw = localStorage.getItem(CUSTOM_SCHEMA_KEY) || '{}';
  const blob = new Blob([raw], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'minidevis_personnalisation.json';
  a.click(); URL.revokeObjectURL(url);
}

function importTarifsPersoJSON(){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'application/json';
  input.onchange = function(){
    const f = input.files && input.files[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload = function(){
      try{
        const obj = JSON.parse(rd.result||'{}');
        localStorage.setItem(CUSTOM_SCHEMA_KEY, JSON.stringify(obj));
        applyCustomSchema();
        alert('‚úÖ Fichier import√© et appliqu√©.');
        pageTarifsPersoJSON();
      }catch(e){ alert('‚ùå Import impossible : '+e.message); }
    };
    rd.readAsText(f, 'utf-8');
  };
  input.click();
}

// ---------- Hook : ajoute le bouton dans l'accueil Chap. 8 ----------
(function patchTarifsAccueilButton(){
  // on monkey-patche la fonction existante pour ins√©rer le bouton si pas d√©j√† pr√©sent
  const _orig = window.pageTarifsAccueil;
  if(typeof _orig === 'function'){
    window.pageTarifsAccueil = function(){
      // construire la vue standard puis la modifier en y ajoutant le bouton
      _orig();
      const app = document.getElementById('app');
      if(!app) return;
      const btnLabel = 'Personnalisation avanc√©e (JSON)';
      if(app.innerHTML.indexOf(btnLabel) === -1){
        app.innerHTML = app.innerHTML.replace(
          /(<div class="row"[^>]*>[\s\S]*?<\/div>\s*<\/div>\s*<\/div>)/,
          '$1<div class="card tarif-card"><div class="row" style="gap:8px;">'
          + '<button class="btn ghost" onclick="pageTarifsPersoJSON()">'+btnLabel+'</button>'
          + '</div></div>'
        );
      }
    };
  }
})();
</script>







<!-- =============================
     CHAPITRE 9 : FACTURATION (export .txt)
     - G√©n√®re une facture texte
     - Mode 's√©par√©' : blocs PRESTATIONS & MAT√âRIEL + totaux
     - Bouton inject√© sur Estimatif & Totaux
     ============================= -->
<script>
/* ==== Helpers prefs/entreprise ==== */
function _getPrefsSafe(){
  try{ return JSON.parse(localStorage.getItem('appPrefs_v1')||'null') || {}; }catch(e){ return {}; }
}
function _getCompanySafe(){
  try{ return JSON.parse(localStorage.getItem('companyConfig_v1')||'null') || {}; }catch(e){ return {}; }
}
function _fmtEuro(n, sym){
  var s = (sym || '‚Ç¨').trim();
  return (+(n||0)).toFixed(2)+' '+s;
}
function _todayFR(){
  try{ return new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit'}); }
  catch(e){ return new Date().toLocaleDateString(); }
}

/* ==== Totaliseur devis courant ==== */
function _totalGlobalDevis(){
  var sum = 0;
  for (var key in devis){
    if(key.indexOf('__')===0) continue;
    var s = devis[key]; var items = (s&&s.items)||[];
    for (var i=0;i<items.length;i++){
      var it=items[i]; sum += ((+it.prixU||0) * (+it.qty||0));
    }
  }
  return sum;
}

/* ==== G√©n√©ration du corps de facture (TXT) ==== */
function buildInvoiceText(){
  var prefs = _getPrefsSafe();
  var company = _getCompanySafe();
  var devise = prefs.devise || '‚Ç¨';

  var modeSepare = (prefs.facturation_mode === 'separe');
  var ratioMat = Math.min(100, Math.max(0, parseInt(prefs.ratio_materiel_defaut||40,10)));
  var ratioPrest = 100 - ratioMat;

  var totalTT = _totalGlobalDevis(); // HT ‚Äútout compris‚Äù
  var totalMat = modeSepare ? (totalTT * (ratioMat/100)) : 0;
  var totalPrest = modeSepare ? (totalTT * (ratioPrest/100)) : totalTT;

  var tvaOn   = !!prefs.tva_applicable;
  var tauxTVA = Math.max(0, +prefs.taux_tva || 20);
  var tvaPrest= tvaOn ? (totalPrest * tauxTVA/100) : 0;
  var tvaMat  = tvaOn ? (totalMat   * tauxTVA/100) : 0;

  // En-t√™te soci√©t√© / facture
  var header = [];
  header.push('================= FACTURE (brouillon) =================');
  header.push('Date : '+_todayFR());
  var facPrefix = (prefs.numerotation_fact_prefix || 'FAC-');
  var numCourant= Math.max(1, parseInt(prefs.numerotation_courante||1,10));
  header.push('N¬∞ : '+facPrefix+String(numCourant).padStart(4,'0'));
  header.push('');
  header.push('√âmetteur :');
  var rs = (company.raison_sociale || company.nom_commercial || '').trim();
  if(rs) header.push('  '+rs);
  var adr = [company.adresse, company.code_postal, company.ville].filter(Boolean).join(' ');
  if(adr) header.push('  '+adr);
  if(company.pays) header.push('  '+company.pays);
  if(company.email) header.push('  Email : '+company.email);
  if(company.telephone) header.push('  T√©l   : '+company.telephone);
  if(company.siren) header.push('  SIREN : '+company.siren);
  if(company.tva_intracom) header.push('  TVA   : '+company.tva_intracom);
  header.push('========================================================');
  header.push('');

  // Corps
  var body = [];
  if(modeSepare){
    body.push('--- PRESTATIONS ---');
    body.push('Total Prestations (HT) : '+_fmtEuro(totalPrest, devise));
    if(tvaOn) body.push('TVA Prestations ('+tauxTVA+'%) : '+_fmtEuro(tvaPrest, devise));
    body.push('');
    body.push('--- MAT√âRIEL ---');
    body.push('Total Mat√©riel (HT) : '+_fmtEuro(totalMat, devise));
    if(tvaOn) body.push('TVA Mat√©riel ('+tauxTVA+'%) : '+_fmtEuro(tvaMat, devise));
    body.push('');
  } else {
    body.push('--- TOTAL (fournitures + pose) ---');
    body.push('Montant HT : '+_fmtEuro(totalTT, devise));
    if(tvaOn) body.push('TVA ('+tauxTVA+'%) : '+_fmtEuro(totalTT * tauxTVA/100, devise));
    body.push('');
  }

  // R√©cap global
  var htGlobal  = modeSepare ? (totalPrest + totalMat) : totalTT;
  var tvaGlobal = tvaOn ? (modeSepare ? (tvaPrest + tvaMat) : (totalTT * tauxTVA/100)) : 0;

  body.push('================= R√âCAPITULATIF =================');
  body.push('Total HT  : '+_fmtEuro(htGlobal, devise));
  if(tvaOn) body.push('TVA       : '+_fmtEuro(tvaGlobal, devise));
  body.push('Total TTC : '+_fmtEuro(htGlobal + tvaGlobal, devise));
  body.push('=================================================');
  body.push('');

  // Mentions / paiement
  var foot = [];
  if(company.conditions_paiement) foot.push('Conditions de paiement : '+company.conditions_paiement);
  if(company.iban) foot.push('IBAN : '+company.iban+(company.bic?(' ‚Äî BIC : '+company.bic):''));
  if(company.rc_pro) foot.push('RC Pro : '+company.rc_pro);
  if(company.decennale) foot.push('D√©cennale : '+company.decennale);
  if(company.assureur) foot.push('Assureur : '+company.assureur);
  if(company.mentions_legales){
    foot.push('');
    foot.push(company.mentions_legales);
  }

  return header.concat(body).concat(foot).join('\r\n');
}

/* ==== Export .txt + incr√©ment num√©rotation ==== */
function exportInvoiceText(){
  var prefs = _getPrefsSafe();
  try{
    var cur = Math.max(1, parseInt(prefs.numerotation_courante||1,10));
    prefs.numerotation_courante = cur + 1;
    localStorage.setItem('appPrefs_v1', JSON.stringify(prefs));
  }catch(e){}
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildInvoiceText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url;
  a.download = name.replace(/\s+/g,'_').toLowerCase()+'_facture.txt';
  a.click();
  URL.revokeObjectURL(url);
  alert('‚úÖ Facture (texte) export√©e.');
}

/* ==== Injection du bouton dans Estimatif & Totaux ==== */
(function patchButtons(){
  var origEst = window.pageEstimatif;
  if(typeof origEst === 'function'){
    window.pageEstimatif = function(){
      origEst();
      var app = document.getElementById('app'); if(!app) return;
      if(app.innerHTML.indexOf('exportInvoiceText()')===-1){
        app.innerHTML = app.innerHTML.replace(
          /(Export \.zip \(complet\).*?<\/div>\s*<\/div>)/,
          '$1<div class="row" style="margin-top:10px;">'
          + '<button class="btn primary" onclick="exportInvoiceText()">üßæ Exporter facture (texte)</button>'
          + '</div>'
        );
      }
    };
  }
  var origTot = window.pageTotaux;
  if(typeof origTot === 'function'){
    window.pageTotaux = function(){
      origTot();
      var app = document.getElementById('app'); if(!app) return;
      if(app.innerHTML.indexOf('exportInvoiceText()')===-1){
        app.innerHTML = app.innerHTML.replace(
          /(Export \.zip \(complet\).*?<\/div>\s*<\/div>)/,
          '$1<div class="row" style="margin-top:10px;">'
          + '<button class="btn primary" onclick="exportInvoiceText()">üßæ Exporter facture (texte)</button>'
          + '</div>'
        );
      }
    };
  }
})();
</script>


  



  


<!-- ===== PATCH : MODIFICATION TABLEAU (D√©placement) ===== -->
<script>
// 1) Petits styles pour l‚Äôa√©ration
(function(){
  var css = `
    .mtx { margin-top:14px; }
    .mbx { margin-bottom:14px; }
    .vblock { display:block; margin-top:10px; }
    .fieldset { border:1px solid var(--line); background:#fff; border-radius:10px; padding:12px; margin-top:10px; }
    .fieldset h3 { margin:0 0 8px; font-size:16px; }
  `;
  var s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);
})();

// 2) Tarifs par d√©faut (utilis√©s si non configur√©s ailleurs)
window.TARIFS_TABMODS = window.TARIFS_TABMODS || {
  deplacement: {
    par_circuit: 20,          // ‚Ç¨ / circuit √† rallonger
    boite_base: 50,           // ‚Ç¨ base pour la bo√Æte
    boite_par_circuit: 10,    // ‚Ç¨ additionnels par circuit
    goulotte_base: 50,        // ‚Ç¨ base pour la goulotte
    goulotte_par_m: 20        // ‚Ç¨ / m√®tre
  }
};

// 3) Bouton p√©renne "Modifications Tableau" sur l'accueil
//    -> on monkey-patche pageHome pour injecter le bouton si absent
(function(){
  var _oldPageHome = window.pageHome;
  window.pageHome = function(){
    if (typeof _oldPageHome === 'function') _oldPageHome();
    // ins√®re le bouton si non pr√©sent
    var app = document.getElementById('app');
    if(!app) return;
    // cherche le premier card Accueil
    var btnHtml = '<button class="btn" onclick="pageTabModsAccueil()">Modifications Tableau</button>';
    // si d√©j√† pr√©sent, ne pas dupliquer
    if (app.innerHTML.indexOf('pageTabModsAccueil()') === -1) {
      app.innerHTML = app.innerHTML.replace(
        /(<div class="card">[\s\S]*?<h2>Accueil<\/h2>[\s\S]*?<div class="row">[\s\S]*?)(<\/div>)/,
        function(m, a, b){ return a + btnHtml + b; }
      );
    }
  };
})();

// 4) Accueil des modifications de tableau (peut √™tre enrichi plus tard)
function pageTabModsAccueil(){
  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Modifications de Tableau</h2>'
      + '<div class="row mtx">'
        + b('Modification emplacement Tableau','pageTabModsDeplacement()','btn primary')
        // + b('Rec√¢blage tableau','pageTabModsRecablage()','btn') // si tu veux r√©activer plus tard
      + '</div>'
    + '</div>'
  );
}

// 5) Formulaire "Modification emplacement Tableau"
function pageTabModsDeplacement(){
  // options circuits 0..30
  var circuits = Array.from({length:31},(_,i)=>'<option value="'+i+'">'+i+'</option>').join('');

  // (pour l‚Äôinstant une seule bo√Æte au catalogue comme demand√©)
  var boites = [
    {id:'MICHAUD_250x300', label:'Bo√Æte Michaud 250√ó300'}
  ].map(function(b){ return '<option value="'+b.id+'">'+b.label+'</option>'; }).join('');

  var t = TARIFS_TABMODS.deplacement || {};
  // UI
  view(
    '<div class="card">'
      + b('Retour','pageTabModsAccueil()','btn back')
      + '<h2>Modification emplacement Tableau</h2>'

      + '<div class="fieldset">'
        + '<h3>1) Nombre de circuits √† rallonger</h3>'
        + '<label class="vblock">Choix</label>'
        + '<select id="mt-circuits">'+circuits+'</select>'
        + '<small class="muted vblock">Tarif : '+euro(+t.par_circuit||20)+' / circuit</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>2) Cr√©ation d‚Äôune bo√Æte de d√©rivation</h3>'
        + '<label class="vblock">Mod√®le</label>'
        + '<select id="mt-boite">'+boites+'</select>'
        + '<small class="muted vblock">Base : '+euro(+t.boite_base||50)+' + '+euro(+t.boite_par_circuit||10)+' par circuit</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>3) Longueur de goulotte</h3>'
        + '<label class="vblock">Longueur (m)</label>'
        + '<input id="mt-goulotte" type="number" step="0.1" min="0" value="0" inputmode="decimal" />'
        + '<small class="muted vblock">Base : '+euro(+t.goulotte_base||50)+' + '+euro(+t.goulotte_par_m||20)+' / m√®tre</small>'
      + '</div>'

      + '<div id="mt-preview" class="muted mtx"></div>'

      + '<div class="row mtx" style="gap:8px;">'
        + b('Ajouter la modification Tableau','addTabMod_Deplacement()','btn primary')
      + '</div>'
    + '</div>'
  );

  // live preview
  ['mt-circuits','mt-boite','mt-goulotte'].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.addEventListener('input', refreshMtPreview);
  });
  refreshMtPreview();
}

// 6) Calcul + aper√ßu + ajout
function calcDeplacementTotal(nbCircuits, boiteId, lgM){
  var t = TARIFS_TABMODS.deplacement || {};
  var parCircuit = +t.par_circuit || 20;
  var bBase      = +t.boite_base || 50;
  var bPerC      = +t.boite_par_circuit || 10;
  var gBase      = +t.goulotte_base || 50;
  var gPerM      = +t.goulotte_par_m || 20;

  var pCircuits = nbCircuits * parCircuit;
  var pBoite    = bBase + nbCircuits * bPerC;
  var pGoulotte = gBase + (Math.max(0, +lgM) * gPerM);

  return roundUp5(pCircuits + pBoite + pGoulotte);
}

function refreshMtPreview(){
  var n  = parseInt(document.getElementById('mt-circuits').value,10)||0;
  var b  = document.getElementById('mt-boite').value;
  var lm = parseFloat(document.getElementById('mt-goulotte').value)||0;

  var labelBoite = (b==='MICHAUD_250x300') ? 'Bo√Æte Michaud 250√ó300' : b;
  var total = calcDeplacementTotal(n, b, lm);

  document.getElementById('mt-preview').innerHTML =
    'R√©cap : '+n+' circuit(s) ‚Äî '+labelBoite+' ‚Äî goulotte '+lm.toFixed(1)+' m'
    +' ‚Üí Total estim√© : <strong>'+euro(total)+'</strong>';
}

function addTabMod_Deplacement(){
  var n  = parseInt(document.getElementById('mt-circuits').value,10)||0;
  var b  = document.getElementById('mt-boite').value;
  var lm = parseFloat(document.getElementById('mt-goulotte').value)||0;
  var total = calcDeplacementTotal(n, b, lm);

  var labelBoite = (b==='MICHAUD_250x300') ? 'Bo√Æte Michaud 250√ó300' : b;

  // üëá Une seule ligne synth√©tique pour l‚Äôestimatif (prix global)
  var designation = 'Circuits: '+n+' ‚Äî Bo√Æte: '+labelBoite+' ‚Äî Goulotte: '+lm.toFixed(1)+' m';

  // On range √ßa dans une section d√©di√©e "Modifications de Tableau"
  var key = 'Modifications de Tableau';
  if(!devis[key]) devis[key] = { __base:'Modifications de Tableau', items:[], note:'' };

  devis[key].items.push({
    category: 'Modification emplacement Tableau', // s‚Äôaffiche comme titre dans l‚Äôestimatif
    intervention: '', // pas n√©cessaire ici
    pose: '',
    designation: designation,   // r√©sum√© voulu
    qty: 1,
    prixU: total,
    __tabKey: key
  });
  saveLocal();

  // Retour √† l‚Äôaccueil des modifs pour pouvoir encha√Æner
  pageTabModsAccueil();
}

// 7) Expose
Object.assign(window, {
  pageTabModsAccueil,
  pageTabModsDeplacement,
  addTabMod_Deplacement
});
</script>
<!-- ===== FIN PATCH ===== -->

  






  
  
  <!-- ============================================================
     CHAPITRE 10 : ESTIMATIF & EXPORTS ‚Äî vNEXT
     Index :
       ¬ß7.0 ‚Ä¢ D√©tection / libell√© des pi√®ces (Tableaux inclus)
       ¬ß7.1 ‚Ä¢ Tri d√©di√© aux Tableaux (diff ‚Üí coupure ‚Üí disjoncteurs ‚Üí reste)
       ¬ß7.2 ‚Ä¢ Pages : Estimatif d√©taill√© & Totaux par groupe
       ¬ß7.3 ‚Ä¢ Exports : .txt par groupe / .zip par groupe
       ¬ß7.4 ‚Ä¢ Exports : complet .txt / complet .zip
     ============================================================ -->
<script>
// ¬ß7.0 ‚Ä¢ D√©tection & libell√©s
window.PIECE_GROUPS = window.PIECE_GROUPS || {
  "Buanderie":"Pi√®ces techniques","Garage":"Pi√®ces techniques","Atelier":"Pi√®ces techniques",
  "Jardin":"Ext√©rieur","Terrasse":"Ext√©rieur","Balcon":"Ext√©rieur","Abri de jardin":"Ext√©rieur",
  "Cuisine":"Cuisine",
  "Salon":"Pi√®ces de vie","Salle √† manger":"Pi√®ces de vie","Couloir":"Pi√®ces de vie","Entr√©e":"Pi√®ces de vie",
  "Salle de bain":"Pi√®ces d'eau","Salle d'eau":"Pi√®ces d'eau","Toilettes":"Pi√®ces d'eau",
  "Chambre 1":"Chambres & Bureau","Chambre 2":"Chambres & Bureau","Chambre 3":"Chambres & Bureau",
  "Bureau":"Chambres & Bureau","Biblioth√®que":"Chambres & Bureau",
  "Tableau":"Tableau & distribution","Distribution":"Tableau & distribution",
  "Mise √† la terre":"Mise √† la terre","VMC":"VMC"
};
function groupDevis(){
  var g = {};
  for (var key in devis){
    if (key.indexOf("__") === 0) continue;
    var s = devis[key];
    var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
    var grp  = window.PIECE_GROUPS[base] || "Divers";
    if (!g[grp]) g[grp] = {};
    g[grp][key] = s;
  }
  return g;
}
function isTableauKey(key){
  var s = devis[key] || {};
  return ((s.__base||'').toLowerCase()==='tableau') || /^Tableau\s/i.test(key);
}
function pieceDisplayLabel(key){
  var s = devis[key] || {};
  var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
  var qual = s.qualificatif || '';
  var etg  = s.etage || '';
  var label = base===key ? key : (base + (qual ? ' ('+qual+')':'') + (etg ? ' ‚Äî '+etg:''));
  if(isTableauKey(key) && s.__customName && s.__customName.trim()){
    label = key + ' ‚Äî ' + s.__customName.trim();
  }else{
    if(!isTableauKey(key)){
      label = (typeof formatPieceLabel === 'function') ? formatPieceLabel(key) : key;
    }else{
      label = key;
    }
  }
  return label;
}

// ¬ß7.1 ‚Ä¢ Tri d√©di√© Tableaux
function sortedItemsForPiece(key, items){
  if(!Array.isArray(items)) return [];
  if(!isTableauKey(key)) return items.slice();

  function score(it){
    var d = (it && it.designation ? String(it.designation) : '').trim();
    if (/^ID\s/i.test(d))             return 0;
    if (/^Coupure g√©n√©rale/i.test(d)) return 1;
    if (/^Disjoncteur\s/i.test(d))    return 2;
    return 3;
  }
  return items.map(function(it, i){ return {it:it, i:i, s:score(it)}; })
              .sort(function(a,b){ return (a.s - b.s) || (a.i - b.i); })
              .map(function(x){ return x.it; });
}

// ¬ß7.2 ‚Ä¢ Pages : Estimatif + Totaux
function itemLine(it){
  var unit = it.unit || "u";
  var poseTxt = (it.intervention === "Cr√©ation" && it.pose) ? (" - " + String(it.pose).toLowerCase()) : "";
  var left = it.intervention ? (it.intervention + " ‚Äî ") : "";
  var pu = (+it.prixU || 0).toFixed(2);
  var q  = +it.qty || 0;
  var total = (q * (+it.prixU || 0)).toFixed(2);
  return "- " + left + it.designation + poseTxt + " | Qt√©: " + q + " " + unit + " | PU: " + pu + "‚Ç¨ | Total: " + total + "‚Ç¨";
}
function pieceSeparator(label){ return "\n---------------- " + label + " ----------------\n"; }

function pageEstimatif(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Estimatif d√©taill√©</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    html += '<h2 style="border-top:2px solid #000; padding-top:8px;">'+grp+'</h2>';
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var pieceLabel = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var sectionTotal = 0;

      html += '<h3 style="margin-top:6px; border-top:1px solid #ccc; padding-top:4px;">'+pieceLabel+'</h3><ul>';
      items.forEach(function(it){
        var q  = +it.qty || 0;
        var pu = +it.prixU || 0;
        var t  = q * pu;
        sectionTotal += t; groupTotal += t; totalGlobal += t;

        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? (" " + String(it.pose).toLowerCase()) : "";
        var unit    = it.unit || "u";
        var left    = it.intervention ? (it.intervention+" ‚Äî ") : "";
        html += '<li>' + left + it.designation + poseTxt + ' ('+q+' '+unit+' √ó '+euro(pu)+' = '+euro(t)+')</li>';
      });
      if (s.note) html += '<li><em>Note : '+s.note+'</em></li>';

      html += '</ul><p><strong>Total '+pieceLabel+' : '+euro(sectionTotal)+'</strong></p>';
    }

    html += '<p><strong>Total '+grp+' : '+euro(groupTotal)+'</strong></p><hr>';
  }

  html += '<h3>Total global : '+euro(totalGlobal)+'</h3>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

function pageTotaux(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Totaux par groupe</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    var gt = 0;
    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;
      var items = sortedItemsForPiece(key, s.items);
      var st = items.reduce(function(sum,it){ return sum + (((+it.prixU)||0)*((+it.qty)||0)); }, 0);
      gt += st; totalGlobal += st;
    }
    html += '<p><strong>'+grp+'</strong> : '+euro(gt)+'</p>';
  }

  html += '<hr><p><strong>Total global : '+euro(totalGlobal)+'</strong></p>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

// ¬ß7.3 ‚Ä¢ Exports : TXT/ZIP par groupe
function exportText(){
  var grouped = groupDevis();
  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');

    var blob = new Blob([lines.join('\r\n')], {type:'text/plain;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = 'devis_'+grp+'.txt'; a.click();
    URL.revokeObjectURL(url);
  }
  alert('‚úÖ Export termin√© : un fichier .txt par groupe g√©n√©r√©.');
}

async function exportZipGroups(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var grouped = groupDevis();
  var zip = new JSZip();
  var global = 0;

  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');
    global += groupTotal;

    zip.file('devis_'+grp+'.txt', lines.join('\r\n'));
  }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var readme = 'R√©capitulatif ‚Äî '+name+'\nDate: '+new Date().toLocaleString()
             + '\n\nTotal global: '+global.toFixed(2)+'‚Ç¨\n';
  zip.file('README.txt', readme);

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_groupes.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export ZIP (par groupe) g√©n√©r√©.');
}

// ¬ß7.4 ‚Ä¢ Exports : COMPLET (.txt/.zip)
function buildFullText(){
  var grouped = groupDevis();
  var lines = ['=== DEVIS COMPLET ===\n'];
  var globalTotal = 0;

  for (var grp in grouped){
    lines.push('\n## '+grp+' ##\n');
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t; globalTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨\n');
  }

  lines.push('\n=== Total global : '+globalTotal.toFixed(2)+'‚Ç¨ ===\n');
  return lines.join('\r\n');
}
function exportTextFull(){
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildFullText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export .txt complet g√©n√©r√©.');
}
async function exportZipFull(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var zip  = new JSZip();
  zip.file(name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt', buildFullText());
  zip.file('README.txt', 'Devis complet\nNom: '+name+'\nDate: '+new Date().toLocaleString()+'\n');

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export .zip complet g√©n√©r√©.');
}
</script>







<!-- =============================
     CHAPITRE 11 : CONFIG ENTREPRISE & PR√âF√âRENCES
     (Autonome, non intrusif ‚Äî ajoute 2 pages et 1 bouton dans le Chap.8)
     ============================= -->

<style>
  .cfg-wrap .card{ margin-bottom:24px; }
  .cfg-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .cfg-grid .field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .cfg-grid .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .cfg-actions{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; }

  .cfg-note{ color:var(--muted); font-size:14px; }

  /* Logo */
  .cfg-logo-block{ display:grid; grid-template-columns:1fr; gap:10px; }
  .cfg-logo-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .cfg-logo img{ max-height:64px; border:1px solid var(--line); border-radius:8px; background:#fff; padding:4px; }
  .dropzone{
    border:2px dashed var(--line); border-radius:10px; padding:12px; background:#fafafa;
    text-align:center; color:#444;
  }
  .dropzone.drag{ border-color:#4caf50; background:#f0fff4; }
  .alert-ok{
    border:1px solid #c8e6c9; background:#e8f5e9; color:#256029;
    padding:8px 10px; border-radius:8px; font-size:14px;
  }
  .alert-warn{
    border:1px solid #ffe0b2; background:#fff3e0; color:#9c6f19;
    padding:8px 10px; border-radius:8px; font-size:14px;
  }
</style>

<script>
/* ============================================================
   ¬ß11.0 ‚Ä¢ Stockage & helpers (localStorage)
   ============================================================ */
const KEY_COMPANY   = 'companyConfig_v1';
const KEY_PREFS     = 'appPrefs_v1';

function readJsonLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function writeJsonLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

function getCompany(){
  return readJsonLS(KEY_COMPANY, {
    // Identit√©
    raison_sociale: '', nom_commercial: '',
    siren: '', tva_intracom: '',
    adresse: '', code_postal: '', ville: '', pays: 'France',
    email: '', telephone: '', site: '',
    // Assurance / mentions
    rc_pro: '', decennale: '', assureur: '',
    iban: '', bic: '', conditions_paiement: 'Virement bancaire √† 30 jours.',
    mentions_legales: '',
    // Logo (dataURL)
    logo_dataurl: '',
    logo_meta: { name:'', size:0, width:0, height:0, loaded_at:'' }
  });
}
function setCompany(obj){ writeJsonLS(KEY_COMPANY, obj||{}); }

function getPrefs(){
  // ‚ûú Ratio mat√©riel supprim√© (on bascule vers le catalogue)
  return readJsonLS(KEY_PREFS, {
    facturation_mode: 'tout_compris', // 'tout_compris' | 'separe'
    devise: '‚Ç¨',
    tva_applicable: false,  // pour futur ¬´ r√©el ¬ª
    taux_tva: 20,           // % (non utilis√© tant que tva_applicable=false)
    numerotation_prefix: 'DEV-',
    numerotation_fact_prefix: 'FAC-',
    numerotation_courante: 1
  });
}
function setPrefs(obj){ writeJsonLS(KEY_PREFS, obj||{}); }

/* Fichier ‚Üí dataURL + meta (nom/taille + dimensions) */
function fileToDataURLWithMeta(file, cb, errCb){
  try{
    const rd = new FileReader();
    rd.onload = function(){
      const dataUrl = rd.result || '';
      const img = new Image();
      img.onload = function(){
        cb({
          dataUrl,
          meta: {
            name: file.name || '',
            size: file.size || 0,
            width: img.naturalWidth||img.width||0,
            height: img.naturalHeight||img.height||0,
            loaded_at: new Date().toISOString()
          }
        });
      };
      img.onerror = function(){ (errCb||alert)('Impossible de lire l‚Äôimage.'); };
      img.src = dataUrl;
    };
    rd.onerror = function(){ (errCb||alert)('Lecture du fichier √©chou√©e.'); };
    rd.readAsDataURL(file);
  }catch(e){ (errCb||alert)('S√©lection d‚Äôimage impossible : '+e.message); }
}

function pickImageFile(cb){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = function(){
    const f = input.files && input.files[0]; if(!f) return;
    cb(f);
  };
  input.click();
}

/* ============================================================
   ¬ß11.1 ‚Ä¢ UI ‚Äî Configuration entreprise
   ============================================================ */
function pageConfigEntreprise(notice){
  const cfg = getCompany();

  function f(label, id, val, placeholder){
    return '<div class="field"><label for="'+id+'">'+label+'</label>'
         + '<input id="'+id+'" value="'+(val?String(val).replace(/"/g,'&quot;'):'')+'" placeholder="'+(placeholder||'')+'"/></div>';
  }
  function ta(label, id, val, placeholder){
    return '<div class="field"><label for="'+id+'">'+label+'</label>'
         + '<textarea id="'+id+'" rows="5" placeholder="'+(placeholder||'')+'">'+(val||'')+'</textarea></div>';
  }

  const hasLogo = !!cfg.logo_dataurl;
  const meta = cfg.logo_meta || {};
  const metaTxt = hasLogo
    ? ('<div class="cfg-note">Fichier: <strong>'+ (meta.name||'') +
       '</strong> ‚Äî '+(Math.round((meta.size||0)/102.4)/10)+' Ko ‚Äî '+
       (meta.width||'?')+'√ó'+(meta.height||'?')+' px</div>')
    : '<div class="cfg-note">Aucun logo</div>';

  const banner = notice
    ? '<div class="alert-ok">'+notice+'</div>'
    : '';

  const logoHtml =
    '<div class="field">'
      + '<label>Logo</label>'
      + '<div class="cfg-logo-block">'
        + banner
        + '<div class="cfg-logo-row cfg-logo">'
            + (hasLogo ? ('<img id="cfg-logo-preview" src="'+cfg.logo_dataurl+'" alt="Logo"/>') : '')
            + metaTxt
        + '</div>'
        + '<div class="cfg-logo-row">'
            + b('Choisir une image','cfgPickLogoUI()','btn')
            + (hasLogo ? b('Aper√ßu plein','cfgOpenLogoFull()','btn') : '')
            + (hasLogo ? b('Retirer','cfgRemoveLogo()','btn') : '')
        + '</div>'
        + '<div id="dropzone" class="dropzone">Glissez-d√©posez votre logo ici (PNG/JPG recommand√©)</div>'
        + '<div class="cfg-note">Le logo sera int√©gr√© aux futurs PDF (devis/factures).</div>'
      + '</div>'
    + '</div>';

  view(
    '<div class="cfg-wrap">'
    +  '<div class="card">'
        + b('Retour','pageTarifsAccueil ? pageTarifsAccueil() : pageMain()','btn back')
        + '<h2>Configuration entreprise</h2>'
        + '<p class="cfg-note">Ces informations seront utilis√©es pour les futurs export PDF (devis/factures) et rappels l√©gaux.</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Identit√© & coordonn√©es</h3>'
        + '<div class="cfg-grid">'
          + f('Raison sociale','ce_rs', cfg.raison_sociale, 'Ex : SARL Dupont √âlectricit√©')
          + f('Nom commercial','ce_nc', cfg.nom_commercial, 'Ex : Dupont √âlec')
          + f('SIREN','ce_siren', cfg.siren, 'Ex : 123 456 789')
          + f('N¬∞ TVA intracom','ce_tva', cfg.tva_intracom, 'Ex : FRXX999999999')
          + f('Adresse','ce_addr', cfg.adresse, 'Rue et n¬∞')
          + f('Code postal','ce_cp', cfg.code_postal, '75000')
          + f('Ville','ce_ville', cfg.ville, 'Paris')
          + f('Pays','ce_pays', cfg.pays || 'France', 'France')
          + f('Email','ce_mail', cfg.email, 'contact@exemple.fr')
          + f('T√©l√©phone','ce_tel', cfg.telephone, '+33 6 12 34 56 78')
          + f('Site web','ce_web', cfg.site, 'https://‚Ä¶')
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Assurances & RIB</h3>'
        + '<div class="cfg-grid">'
          + f('RC Pro (n¬∞)','ce_rc', cfg.rc_pro, '')
          + f('D√©cennale (n¬∞)','ce_dec', cfg.decennale, '')
          + f('Assureur','ce_ass', cfg.assureur, '')
          + f('IBAN','ce_iban', cfg.iban, '')
          + f('BIC','ce_bic', cfg.bic, '')
        + '</div>'
        + ta('Conditions de paiement','ce_cond', cfg.conditions_paiement, 'Ex : Virement sous 30 jours‚Ä¶')
        + ta('Mentions l√©gales (pied de page)','ce_mentions', cfg.mentions_legales, 'Textes libres‚Ä¶')
      + '</div>'

      + '<div class="card">'
        + '<h3>Logo</h3>'
        + logoHtml
      + '</div>'

      + '<div class="cfg-actions">'
        + b('üíæ Enregistrer','saveConfigEntreprise()','btn primary')
      + '</div>'
    + '</div>'
  );

  // Handlers inline
  window.cfgPickLogoUI = function(){
    pickImageFile(function(file){
      fileToDataURLWithMeta(file, function(res){
        const c = getCompany();
        c.logo_dataurl = res.dataUrl;
        c.logo_meta = res.meta;
        setCompany(c);
        pageConfigEntreprise('Logo charg√© ‚úÖ ('+res.meta.width+'√ó'+res.meta.height+' px)');
      });
    });
  };
  window.cfgRemoveLogo = function(){
    const c = getCompany(); c.logo_dataurl = ''; c.logo_meta = {name:'',size:0,width:0,height:0,loaded_at:''};
    setCompany(c); pageConfigEntreprise('Logo supprim√©.');
  };
  window.cfgOpenLogoFull = function(){
    const c = getCompany(); if(!c.logo_dataurl) return;
    const w = window.open(); if(!w) return;
    w.document.write('<img src="'+c.logo_dataurl+'" style="max-width:100%;height:auto" alt="Logo" />');
  };

  // Drag & drop
  (function setupDrop(){
    const dz = document.getElementById('dropzone');
    if(!dz) return;
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('drag'); }));
    dz.addEventListener('drop', function(e){
      const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
      if(!f) return;
      if(!/^image\//i.test(f.type||'')){ alert('Merci de d√©poser une image (PNG/JPG).'); return; }
      fileToDataURLWithMeta(f, function(res){
        const c = getCompany();
        c.logo_dataurl = res.dataUrl;
        c.logo_meta = res.meta;
        setCompany(c);
        pageConfigEntreprise('Logo charg√© ‚úÖ ('+res.meta.width+'√ó'+res.meta.height+' px)');
      });
    });
  })();
}

function saveConfigEntreprise(){
  const cfg = getCompany();
  function gv(id){ const el=document.getElementById(id); return el?el.value.trim():''; }
  Object.assign(cfg, {
    raison_sociale: gv('ce_rs'),
    nom_commercial: gv('ce_nc'),
    siren: gv('ce_siren'),
    tva_intracom: gv('ce_tva'),
    adresse: gv('ce_addr'),
    code_postal: gv('ce_cp'),
    ville: gv('ce_ville'),
    pays: gv('ce_pays'),
    email: gv('ce_mail'),
    telephone: gv('ce_tel'),
    site: gv('ce_web'),
    rc_pro: gv('ce_rc'),
    decennale: gv('ce_dec'),
    assureur: gv('ce_ass'),
    iban: gv('ce_iban'),
    bic: gv('ce_bic'),
    conditions_paiement: gv('ce_cond'),
    mentions_legales: gv('ce_mentions')
  });
  setCompany(cfg);
  alert('‚úÖ Configuration entreprise enregistr√©e.');
}

/* ============================================================
   ¬ß11.2 ‚Ä¢ UI ‚Äî Pr√©f√©rences (mode facturation, devise, TVA‚Ä¶)
   (ratio mat√©riel retir√©)
   ============================================================ */
function pagePreferences(){
  const p = getPrefs();
  const radio = (name, val, cur, label) =>
    '<label class="pill"><input type="radio" name="'+name+'" value="'+val+'" '+(cur===val?'checked':'')+'> '+label+'</label>';

  view(
    '<div class="cfg-wrap">'
      + '<div class="card">'
        + b('Retour','pageTarifsAccueil ? pageTarifsAccueil() : pageMain()','btn back')
        + '<h2>Pr√©f√©rences</h2>'
        + '<p class="cfg-note">Ces r√©glages influencent la pr√©sentation des futurs exports (devis/factures) et la logique de TVA.</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Mode de facturation</h3>'
        + '<div class="row" style="gap:8px;">'
          + radio('pf_fmode','tout_compris', p.facturation_mode, 'Tarifs ¬´ fournitures + pose ¬ª (tout compris)')
          + radio('pf_fmode','separe', p.facturation_mode, 'S√©parer prestations et mat√©riel')
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Devise & TVA</h3>'
        + '<div class="cfg-grid">'
          + '<div class="field">'
            + '<label>Devise</label>'
            + '<input id="pf_dev" value="'+(p.devise||'‚Ç¨')+'" placeholder="‚Ç¨"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>TVA applicable</label>'
            + '<select id="pf_tva_on"><option value="no" '+(!p.tva_applicable?'selected':'')+'>Non (Micro)</option><option value="yes" '+(p.tva_applicable?'selected':'')+'>Oui (R√©gime r√©el)</option></select>'
          + '</div>'
          + '<div class="field">'
            + '<label>Taux de TVA (%)</label>'
            + '<input id="pf_tva" type="number" inputmode="decimal" min="0" max="100" step="0.1" value="'+(+p.taux_tva||20)+'"/>'
          + '</div>'
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Num√©rotation</h3>'
        + '<div class="cfg-grid">'
          + '<div class="field">'
            + '<label>Pr√©fixe num√©rotation devis</label>'
            + '<input id="pf_pref_dev" value="'+(p.numerotation_prefix||'DEV-')+'"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>Pr√©fixe num√©rotation facture</label>'
            + '<input id="pf_pref_fac" value="'+(p.numerotation_fact_prefix||'FAC-')+'"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>Compteur courant</label>'
            + '<input id="pf_counter" type="number" inputmode="numeric" min="1" value="'+(+p.numerotation_courante||1)+'"/>'
            + '<div class="cfg-note">Servira pour g√©n√©rer DEV-0001, FAC-0001, etc.</div>'
          + '</div>'
        + '</div>'
      + '</div>'

      + '<div class="cfg-actions">'
        + b('üíæ Enregistrer','savePreferences()','btn primary')
      + '</div>'
    + '</div>'
  );
}

function savePreferences(){
  const cur = getPrefs();
  function gv(id){ const el=document.getElementById(id); return el?el.value:''; }
  function gi(name){ const el=document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:cur[name]; }
  const tvay = (gv('pf_tva_on')==='yes');

  const out = Object.assign({}, cur, {
    facturation_mode: gi('pf_fmode') || cur.facturation_mode,
    devise: gv('pf_dev') || cur.devise || '‚Ç¨',
    tva_applicable: tvay,
    taux_tva: Math.max(0, parseFloat(gv('pf_tva'))||cur.taux_tva||20),
    numerotation_prefix: gv('pf_pref_dev') || cur.numerotation_prefix || 'DEV-',
    numerotation_fact_prefix: gv('pf_pref_fac') || cur.numerotation_fact_prefix || 'FAC-',
    numerotation_courante: Math.max(1, parseInt(gv('pf_counter'),10)||cur.numerotation_courante||1)
  });
  setPrefs(out);
  alert('‚úÖ Pr√©f√©rences enregistr√©es.');
}

/* ============================================================
   ¬ß11.3 ‚Ä¢ Int√©gration douce : ajoute 2 boutons au Chapitre 8
   (si pr√©sent) et expose les pages au global
   ============================================================ */
(function injectButtonsIntoParametrage(){
  const orig = window.pageTarifsAccueil;
  if(typeof orig === 'function'){
    window.pageTarifsAccueil = function(){
      orig();
      const app = document.getElementById('app');
      if(!app) return;
      const btn1 = 'Configuration entreprise';
      const btn2 = 'Pr√©f√©rences';
      if(app.innerHTML.indexOf(btn1)===-1 || app.innerHTML.indexOf(btn2)===-1){
        app.innerHTML = app.innerHTML.replace(
          /(<div class="row"[^>]*>[\s\S]*?<\/div>\s*<\/div>\s*<\/div>)/,
          '$1'
          + '<div class="card tarif-card"><div class="row" style="gap:8px;">'
          +   '<button class="btn" onclick="pageConfigEntreprise()">'+btn1+'</button>'
          +   '<button class="btn" onclick="pagePreferences()">'+btn2+'</button>'
          + '</div></div>'
        );
      }
    };
  }
})();

/* Expose au global */
Object.assign(window, {
  pageConfigEntreprise,
  pagePreferences,
  saveConfigEntreprise,
  savePreferences
});
</script>



  

<!-- =============================
     CHAPITRE 12 : CATALOGUE MAT√âRIEL
     (Autonome, rang√© sous Param√©trage ‚Äî Chap. 8)
     ============================= -->

<style>
  .cat-wrap .card{ margin-bottom:24px; }
  .cat-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .cat-field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .cat-field label{ display:block; font-weight:600; margin-bottom:6px; }
  .cat-note{ color:var(--muted); font-size:14px; }
  .pill.small{ padding:6px 10px; font-size:14px; }
  .row.gap8{ gap:8px; flex-wrap:wrap; }
  .list-plain{ display:flex; flex-direction:column; gap:6px; }
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<script>
/* ============================================================
   ¬ß13.0 ‚Ä¢ Stockage & valeurs par d√©faut
   ============================================================ */
const KEY_CATALOG = 'catalogueConfig_v1';

/*
  Structure de stockage (compacte, extensible via JSON) :

  {
    "types": {                       // Types de produits usuels
      "Appareillage": ["Prise 2P+T","Prise 2P+T IP44","Interrupteur simple","Interrupteur double","Variateur","Plaque 1 poste"],
      "√âclairage":   ["Point de centre","Applique"],
      "Circuit sp√©cialis√©": ["Four","Plaque de cuisson","Lave-linge","Lave-vaisselle","S√®che-linge","Cumulus","VMC","Chauffage","Climatisation","Prise ext√©rieure √©tanche"],
      "Tableau":     ["Tableau 1 rang√©e","Tableau 2 rang√©es","Tableau 3 rang√©es","Inter diff 30mA","Disjoncteur modulaire"],
      "VMC":         ["Kit VMC simple flux","Extracteur","Ventilateur de conduit"]
    },
    "marques": {                     // Marques & gammes par grande famille
      "Appareillage": [
        { marque:"Legrand",   gammes:[ {nom:"Dooxie", coef:1.00}, {nom:"C√©liane", coef:1.10} ] },
        { marque:"Schneider", gammes:[ {nom:"Odace",  coef:1.00}, {nom:"Unica",   coef:1.05} ] },
        { marque:"Hager",     gammes:[ {nom:"Essensya", coef:0.98} ] }
      ],
      "Tableau": [
        { marque:"Schneider", gammes:[ {nom:"Resi9 (r√©sidentiel)", coef:1.00}, {nom:"Acti9 (tertiaire)", coef:1.10} ] },
        // Pour Legrand/Hager on reste volontairement g√©n√©rique (r√©sidentiel/tertiaire),
        // l'utilisateur pr√©cisera / compl√®tera si besoin via JSON.
        { marque:"Legrand",   gammes:[ {nom:"R√©sidentiel", coef:1.00}, {nom:"Tertiaire", coef:1.08} ] },
        { marque:"Hager",     gammes:[ {nom:"R√©sidentiel", coef:1.00}, {nom:"Tertiaire", coef:1.08} ] }
      ]
    },
    "vmc": {                         // VMC : constructeurs & syst√®mes
      "S&P": {
        "syst√®mes": ["Autor√©glable","Hygro A","Hygro B","Hygro avec sonde hygro"]
      },
      "Atlantic": {
        "syst√®mes": ["Autor√©glable","Hygro A","Hygro B","Hygro avec sonde hygro"]
      }
    },
    "coef_defaut": 1.00              // multiplicateur si aucune gamme n'est choisie
  }
*/

function readJsonLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function writeJsonLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

function getCatalog(){
  return readJsonLS(KEY_CATALOG, {
    types: {
      "Appareillage": ["Prise 2P+T","Prise 2P+T IP44","Interrupteur simple","Interrupteur double","Variateur","Plaque 1 poste"],
      "√âclairage":   ["Point de centre","Applique"],
      "Circuit sp√©cialis√©": ["Four","Plaque de cuisson","Lave-linge","Lave-vaisselle","S√®che-linge","Cumulus","VMC","Chauffage","Climatisation","Prise ext√©rieure √©tanche"],
      "Tableau":     ["Tableau 1 rang√©e","Tableau 2 rang√©es","Tableau 3 rang√©es","Inter diff 30mA","Disjoncteur modulaire"],
      "VMC":         ["Kit VMC simple flux","Extracteur","Ventilateur de conduit"]
    },
    marques: {
      "Appareillage": [
        { marque:"Legrand",   gammes:[ {nom:"Dooxie", coef:1.00}, {nom:"C√©liane", coef:1.10} ] },
        { marque:"Schneider", gammes:[ {nom:"Odace",  coef:1.00}, {nom:"Unica",   coef:1.05} ] },
        { marque:"Hager",     gammes:[ {nom:"Essensya", coef:0.98} ] }
      ],
      "Tableau": [
        { marque:"Schneider", gammes:[ {nom:"Resi9 (r√©sidentiel)", coef:1.00}, {nom:"Acti9 (tertiaire)", coef:1.10} ] },
        { marque:"Legrand",   gammes:[ {nom:"R√©sidentiel", coef:1.00}, {nom:"Tertiaire", coef:1.08} ] },
        { marque:"Hager",     gammes:[ {nom:"R√©sidentiel", coef:1.00}, {nom:"Tertiaire", coef:1.08} ] }
      ]
    },
    vmc: {
      "S&P":     { "syst√®mes": ["Autor√©glable","Hygro A","Hygro B","Hygro avec sonde hygro"] },
      "Atlantic":{ "syst√®mes": ["Autor√©glable","Hygro A","Hygro B","Hygro avec sonde hygro"] }
    },
    coef_defaut: 1.00
  });
}
function setCatalog(obj){ writeJsonLS(KEY_CATALOG, obj||{}); }

/* ============================================================
   ¬ß13.1 ‚Ä¢ Entr√©e du Catalogue
   ============================================================ */
function pageCatalogue(){
  const c = getCatalog();
  view(
    '<div class="cat-wrap">'
      + '<div class="card">'
        + b('‚¨ÖÔ∏è Retour','pageTarifsAccueil ? pageTarifsAccueil() : pageMain()','btn back')
        + '<h2>Catalogue mat√©riel (compact)</h2>'
        + '<p class="cat-note">Types usuels, marques/gammes avec coefficients, et syst√®mes VMC. Tu peux √©tendre via JSON.</p>'
        + '<div class="row gap8" style="margin-top:8px;">'
          + b('üß© Types de produits','pageCatalogue_Types()','btn primary')
          + b('üè∑Ô∏è Marques & gammes','pageCatalogue_Marques()','btn')
          + b('üí® VMC ‚Äî Constructeurs & syst√®mes','pageCatalogue_VMC()','btn')
          + b('‚¨áÔ∏è Export JSON','catalogExport()','btn ghost')
          + b('‚¨ÜÔ∏è Import JSON','catalogImport()','btn ghost')
          + b('üßπ R√©initialiser','catalogReset()','btn')
        + '</div>'
      + '</div>'
      + '<div class="card">'
        + '<h3>Aper√ßu rapide</h3>'
        + '<p><strong>Types :</strong> '
          + Object.keys(c.types).map(k=>k+': '+c.types[k].length).join(' ‚Ä¢ ')
        + '</p>'
        + '<p><strong>Marques (appareillage/tableau) :</strong> '
          + ['Appareillage','Tableau'].map(fam=> fam+': '+(c.marques[fam]?c.marques[fam].length:0)).join(' ‚Ä¢ ')
        + '</p>'
        + '<p><strong>VMC :</strong> '+ Object.keys(c.vmc).join(', ') +'</p>'
      + '</div>'
    + '</div>'
  );
}

/* ============================================================
   ¬ß13.2 ‚Ä¢ Types usuels
   ============================================================ */
function pageCatalogue_Types(){
  const c = getCatalog();
  const familles = Object.keys(c.types);

  function blocFamille(fam){
    const list = (c.types[fam]||[]).map((t,i)=>
      '<div class="pill small" style="justify-content:space-between; width:100%;">'
        + '<span>'+t+'</span>'
        + '<span>'+ b('√ó','catTypeDel('+JSON.stringify(fam)+','+i+')','btn') +'</span>'
      + '</div>'
    ).join('');
    return (
      '<div class="card">'
        + '<h3>'+fam+'</h3>'
        + '<div class="list-plain">'+ (list || '<div class="cat-note">Aucun type ajout√©.</div>') +'</div>'
        + '<div class="row gap8" style="margin-top:8px;">'
          + '<input id="new-type-'+fam+'" placeholder="Nouveau type (¬´ Prise 2P+T IP55 ¬ª‚Ä¶)" />'
          + b('Ajouter','catTypeAdd('+JSON.stringify(fam)+')','btn')
        + '</div>'
      + '</div>'
    );
  }

  view(
    '<div class="cat-wrap">'
      + '<div class="card">'+ b('‚¨ÖÔ∏è Retour','pageCatalogue()','btn back') +'<h2>Types de produits</h2></div>'
      + familles.map(blocFamille).join('')
    + '</div>'
  );

  // expose handlers
  window.catTypeAdd = function(fam){
    const id='new-type-'+fam; const el=document.getElementById(id);
    const val=(el&&el.value||'').trim(); if(!val) return;
    const cat=getCatalog(); cat.types[fam]=cat.types[fam]||[];
    if(cat.types[fam].indexOf(val)===-1) cat.types[fam].push(val);
    setCatalog(cat); pageCatalogue_Types();
  };
  window.catTypeDel = function(fam, idx){
    const cat=getCatalog(); (cat.types[fam]||[]).splice(idx,1);
    setCatalog(cat); pageCatalogue_Types();
  };
}

/* ============================================================
   ¬ß13.3 ‚Ä¢ Marques & gammes (Appareillage / Tableau)
   ============================================================ */
function pageCatalogue_Marques(){
  const c = getCatalog();
  const familles = ['Appareillage','Tableau'];

  function tableFamille(fam){
    const rows = (c.marques[fam]||[]).map((m,mi)=>{
      const gam = (m.gammes||[]).map((g,gi)=>
        '<div class="pill small" style="justify-content:space-between;">'
          + '<span>'+g.nom+' <span class="cat-note">(coef '+(+g.coef||1).toFixed(2)+')</span></span>'
          + '<span>'+ b('√ó','catGamDel('+JSON.stringify(fam)+','+mi+','+gi+')','btn') +'</span>'
        + '</div>'
      ).join('');
      return (
        '<tr>'
          + '<td style="width:180px;"><strong>'+m.marque+'</strong></td>'
          + '<td>'+ (gam || '<span class="cat-note">Aucune gamme</span>') +'</td>'
          + '<td style="width:220px;">'
              + '<input id="gname-'+fam+'-'+mi+'" placeholder="Nom de gamme"/>'
          +   '</td>'
          + '<td style="width:140px;">'
              + '<input id="gcoef-'+fam+'-'+mi+'" type="number" step="0.01" inputmode="decimal" value="1.00" />'
          +   '</td>'
          + '<td style="width:120px;">'
              + b('Ajouter','catGamAdd('+JSON.stringify(fam)+','+mi+')','btn')
          +   '</td>'
          + '<td style="width:80px;">'+ b('Suppr. marque','catMarqueDel('+JSON.stringify(fam)+','+mi+')','btn') +'</td>'
        + '</tr>'
      );
    }).join('');

    return (
      '<div class="card">'
        + '<h3>'+fam+'</h3>'
        + '<table class="table-mini">'
          + '<thead><tr><th>Marque</th><th>Gammes</th><th>Nouvelle gamme</th><th>Coef</th><th></th><th></th></tr></thead>'
          + '<tbody>'+ (rows || '<tr><td colspan="6" class="cat-note">Aucune marque</td></tr>') +'</tbody>'
        + '</table>'
        + '<div class="row gap8" style="margin-top:10px;">'
          + '<input id="new-brand-'+fam+'" placeholder="Nouvelle marque (ex: Legrand)"/>'
          + b('Ajouter la marque','catMarqueAdd('+JSON.stringify(fam)+')','btn')
        + '</div>'
      + '</div>'
    );
  }

  view(
    '<div class="cat-wrap">'
      + '<div class="card">'+ b('‚¨ÖÔ∏è Retour','pageCatalogue()','btn back') +'<h2>Marques & gammes</h2></div>'
      + familles.map(tableFamille).join('')
    + '</div>'
  );

  // Handlers
  window.catMarqueAdd = function(fam){
    const el=document.getElementById('new-brand-'+fam);
    const name=(el&&el.value||'').trim(); if(!name) return;
    const cat=getCatalog(); cat.marques[fam]=cat.marques[fam]||[];
    if(!cat.marques[fam].some(m=>m.marque.toLowerCase()===name.toLowerCase())){
      cat.marques[fam].push({ marque:name, gammes:[] });
    }
    setCatalog(cat); pageCatalogue_Marques();
  };
  window.catMarqueDel = function(fam, mi){
    const cat=getCatalog(); (cat.marques[fam]||[]).splice(mi,1);
    setCatalog(cat); pageCatalogue_Marques();
  };
  window.catGamAdd = function(fam, mi){
    const n = (document.getElementById('gname-'+fam+'-'+mi)?.value||'').trim();
    const c = parseFloat(document.getElementById('gcoef-'+fam+'-'+mi)?.value)||1;
    if(!n) return;
    const cat=getCatalog(); const m=(cat.marques[fam]||[])[mi]; if(!m) return;
    m.gammes = m.gammes||[];
    if(!m.gammes.some(g=>g.nom.toLowerCase()===n.toLowerCase())) m.gammes.push({nom:n, coef: (+c||1)});
    setCatalog(cat); pageCatalogue_Marques();
  };
  window.catGamDel = function(fam, mi, gi){
    const cat=getCatalog(); const m=(cat.marques[fam]||[])[mi]; if(!m) return;
    (m.gammes||[]).splice(gi,1); setCatalog(cat); pageCatalogue_Marques();
  };
}

/* ============================================================
   ¬ß13.4 ‚Ä¢ VMC ‚Äî Constructeurs & syst√®mes
   ============================================================ */
function pageCatalogue_VMC(){
  const c = getCatalog();
  const constructeurs = Object.keys(c.vmc||{});

  function blocVMCCtor(brand){
    const sys = (c.vmc[brand]?.['syst√®mes']||[]).map((s,i)=>
      '<div class="pill small" style="justify-content:space-between; width:100%;">'
        + '<span>'+s+'</span>'
        + '<span>'+ b('√ó','vmcSysDel('+JSON.stringify(brand)+','+i+')','btn') +'</span>'
      + '</div>'
    ).join('');

    return (
      '<div class="card">'
        + '<h3>'+brand+'</h3>'
        + '<div class="list-plain">'+ (sys || '<div class="cat-note">Aucun syst√®me d√©fini.</div>') +'</div>'
        + '<div class="row gap8" style="margin-top:8px;">'
          + '<input id="new-sys-'+brand+'" placeholder="Ajouter un syst√®me (ex: Hygro A)"/>'
          + b('Ajouter','vmcSysAdd('+JSON.stringify(brand)+')','btn')
        + '</div>'
      + '</div>'
    );
  }

  view(
    '<div class="cat-wrap">'
      + '<div class="card">'+ b('‚¨ÖÔ∏è Retour','pageCatalogue()','btn back') +'<h2>VMC ‚Äî Constructeurs & syst√®mes</h2></div>'
      + constructeurs.map(blocVMCCtor).join('')
      + '<div class="card">'
        + '<h3>Ajouter un constructeur</h3>'
        + '<div class="row gap8">'
          + '<input id="vmc-brand" placeholder="Nom constructeur (ex: Aldes)"/>'
          + b('Ajouter constructeur','vmcCtorAdd()','btn')
        + '</div>'
      + '</div>'
    + '</div>'
  );

  // Handlers
  window.vmcSysAdd = function(brand){
    const id='new-sys-'+brand; const el=document.getElementById(id);
    const val=(el&&el.value||'').trim(); if(!val) return;
    const cat=getCatalog(); cat.vmc[brand]=cat.vmc[brand]||{"syst√®mes":[]};
    if(cat.vmc[brand]["syst√®mes"].indexOf(val)===-1) cat.vmc[brand]["syst√®mes"].push(val);
    setCatalog(cat); pageCatalogue_VMC();
  };
  window.vmcSysDel = function(brand, idx){
    const cat=getCatalog(); (cat.vmc[brand]?.["syst√®mes"]||[]).splice(idx,1);
    setCatalog(cat); pageCatalogue_VMC();
  };
  window.vmcCtorAdd = function(){
    const el=document.getElementById('vmc-brand');
    const name=(el&&el.value||'').trim(); if(!name) return;
    const cat=getCatalog(); cat.vmc = cat.vmc || {};
    if(!cat.vmc[name]) cat.vmc[name] = {"syst√®mes":[]};
    setCatalog(cat); pageCatalogue_VMC();
  };
}

/* ============================================================
   ¬ß13.5 ‚Ä¢ Import / Export / Reset JSON
   ============================================================ */
function catalogExport(){
  const raw = JSON.stringify(getCatalog(), null, 2);
  const blob = new Blob([raw], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'catalogue_materiel.json'; a.click();
  URL.revokeObjectURL(url);
}
function catalogImport(){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'application/json';
  input.onchange = function(){
    const f = input.files && input.files[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload = function(){
      try{
        const obj = JSON.parse(rd.result||'{}');
        // Validation basique
        if(!obj || typeof obj!=='object' || !obj.types || !obj.marques || !obj.vmc){
          alert('‚ùå Structure inattendue. Cl√©s attendues : types, marques, vmc.');
          return;
        }
        setCatalog(obj);
        alert('‚úÖ Catalogue import√©.');
        pageCatalogue();
      }catch(e){ alert('‚ùå Import impossible : '+e.message); }
    };
    rd.readAsText(f,'utf-8');
  };
  input.click();
}
function catalogReset(){
  if(!confirm('R√©initialiser le catalogue aux valeurs par d√©faut ?')) return;
  localStorage.removeItem(KEY_CATALOG);
  alert('‚úÖ Catalogue r√©initialis√©.');
  pageCatalogue();
}

/* ============================================================
   ¬ß13.6 ‚Ä¢ Int√©gration douce dans ‚ÄúParam√©trage‚Äù
   ============================================================ */
(function injectIntoParametrage(){
  const orig = window.pageTarifsAccueil;
  if(typeof orig === 'function'){
    window.pageTarifsAccueil = function(){
      orig();
      const app = document.getElementById('app');
      if(!app) return;
      const btn = 'Catalogue mat√©riel';
      if(app.innerHTML.indexOf(btn)===-1){
        app.innerHTML = app.innerHTML.replace(
          /(<div class="row"[^>]*>[\s\S]*?<\/div>\s*<\/div>\s*<\/div>)/,
          '$1'
          + '<div class="card tarif-card"><div class="row" style="gap:8px;">'
          +   '<button class="btn" onclick="pageCatalogue()">'+btn+'</button>'
          + '</div></div>'
        );
      }
    };
  }
})();

/* Expose global (si besoin ailleurs) */
Object.assign(window, {
  pageCatalogue,
  pageCatalogue_Types,
  pageCatalogue_Marques,
  pageCatalogue_VMC,
  catalogExport,
  catalogImport,
  catalogReset
});
</script>



  
  


  
<!-- =============================
     CHAPITRE 13 : D√âMARRAGE & EXPOSE
     Index :
       ¬ß0  ‚Ä¢ init() : chargement + reprise sauvegardes + pageMain()
       ¬ß1  ‚Ä¢ Expose : fonctions rendues accessibles (UI)
       ¬ß2  ‚Ä¢ Shim compat : neutralise les anciens appels goIntervention(...)
     ============================= -->
<script>
/* ======================
   ¬ß0 ‚Ä¢ D√âMARRAGE (init)
   ====================== */
function init(){
  try{
    // Charge l'√©tat courant
    loadLocal();

    // ‚úÖ Tentative de restauration si la liste des devis sauvegard√©s est vide
    // (fourni par le chapitre 4 robuste ‚Äî sans effet si absent)
    if (typeof recoverSavedIfEmpty === 'function') recoverSavedIfEmpty();

    // D√©marrage UI
    pageMain();
  }catch(err){
    var el = document.getElementById('app');
    if(el){
      el.innerHTML =
        '<div class="card"><h2>Erreur init()</h2><pre>'
        + ((err && err.stack) || String(err))
        + '</pre></div>';
    }
  }
}

/* ======================
   ¬ß1 ‚Ä¢ EXPOSE (window)
   ====================== */
Object.assign(window, {
  // Chap.4 ‚Äî Menu & sauvegarde (robuste)
  pageMain,
  actionNouveauDevis,
  pageSavedDevis,
  loadDevis,
  deleteDevis,
  saveCurrentDevis,
  exportSavedDevis,     // ‚ûï export .json (liste compl√®te)
  importSavedDevisUI,   // ‚ûï import .json (merge par __id)

  // Chap.5 ‚Äî Pi√®ces (flux one-page) + Ventilation (raccourci)
  pageHome,
  pageAddPiece,
  confirmPieceChoice,
  removePiece,
  goPiece,
  delLine,
  editPieceNote,
  pageSpecifiqueForm,
  saveSpecifique,
  pagePieceSpecifique: pageSpecifiqueForm, // alias
  goCategory,
  goEclairageSub,
  setEclairageBranch,
  pageOneShotSelection,
  saveOneShotItem,
  goVent, // bouton "Ventilation" (redirige vers pageVentAccueil si charg√©e)

  // Chap.6 ‚Äî Tableaux (multi-tableaux)
  pageTabCreate,
  saveTabCustomName,
  pageTabHome,
  pageTabPose,
  addTabPose,
  pageTab_ID,
  submitTab_ID,
  pageTab_Coupure,       // (coupure g√©n√©rale)
  submitTab_Coupure,     // (coupure g√©n√©rale)
  pageTab_Disjoncteurs,
  pageTab_DisjDetails,
  pageTab_DisjSaveDetails,
  pageTab_DisjValider,
  pageTabMod_Commandes,
  submitTabMod_Commandes,
  pageTabMod_Specifique,
  submitTabMod_Specifique,

  // Chap.7 ‚Äî Ventilation
  pageVentAccueil,
  pageVentNew,
  saveVentName,
  ventDelete,
  pageVentHome,
  pageVentCreation,
  kitConduitMut, kitPercMut, exConduitMut, exPercMut, vcPercMut,
  ventAddKit, ventAddExtracteur, ventAddVentilateur,
  pageVentRetirage,
  ventAddRetirage,
  pageVentEntretien, ventAddEntretien,

  // Chap.9 ‚Äî Estimatif & exports
  pageEstimatif,
  pageTotaux,
  exportText,
  exportZipGroups,
  exportTextFull,
  exportZipFull,

  // Navigation commune
  confirmBackHome
});

/* =========================================
   ¬ß2 ‚Ä¢ SHIM COMPAT (s√©curit√© anti-crash)
   - Si l‚Äôancienne fonction goIntervention est appel√©e
     via un vieux bouton, on neutralise proprement.
   ========================================= */
if (typeof window.goIntervention !== 'function') {
  window.goIntervention = function(){
    alert('‚ö†Ô∏è Ce raccourci "Intervention" n‚Äôest plus utilis√©.\n' +
          'Choisissez directement l‚Äôintervention dans la page de saisie.');
  };
}

// Lancement auto
init();
</script>
