<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- ============================= -->
  <!-- CHAPITRE 1 : STRUCTURE & STYLES -->
  <!-- ============================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis ‚Äî V2 (menu + flux valid√©)</title>
  <style>
    :root { --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666; --line:#e8e8e8; --primary:#111; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
  </style>
</head>
<body>
<header>MiniDevis ‚Äî V2</header>
<main id="app"></main>
// Forcer un cache-busting automatique √† chaque build
(function(){
  const s = document.currentScript;
  if(s && !location.search.includes("nocache")){
    const ver = Date.now(); // num√©ro unique √† chaque d√©ploiement
    location.href = location.pathname + "?nocache=" + ver;
  }
})();
<script>
  // DEBUG : afficher la premi√®re erreur JS en plein √©cran
window.addEventListener('error', (e) => {
  const el = document.getElementById('app');
  if (el) el.innerHTML = `<div class="card"><h2>Erreur JS</h2><pre>${e.message}\n${e.filename}:${e.lineno}:${e.colno}</pre></div>`;
});

/* ============================= */
/* CHAPITRE 2 : √âTAT & HELPERS UI */
/* ============================= */

// √âtat global
let devis = {}; // { [piece]: { items:[{...}], note:"" } }
let ctx = { piece:null, category:null, intervention:null, pose:null, designation:null };

// Helpers DOM
const $app = () => document.getElementById('app');
function view(html){ 
  $app().innerHTML = html + `
    <div class="row" style="margin-top:16px; gap:12px;">
      ${b("‚¨ÖÔ∏è Accueil","pageMain()","btn back")}
      ${b("üíæ Sauvegarder devis","saveCurrentDevis()","btn primary")}
    </div>
  `;
}
function b(label, fn, cls="btn"){ return `<button class="${cls}" onclick="${fn}">${label}</button>`; }
function euro(n){ return `${(+n).toFixed(2)} ‚Ç¨`; }

// Persistance locale
function ensureSection(piece){
  if(!devis[piece]) devis[piece] = { items:[], note:"" };
}
function saveLocal(){
  try { localStorage.setItem('devis', JSON.stringify(devis)); } catch(e){}
}
function loadLocal(){
  try {
    const raw = localStorage.getItem('devis');
    if (raw) devis = JSON.parse(raw) || {};
  } catch(e){ devis = {}; }
}
/* ============================= */
/* CHAPITRE 3 : DONN√âES & CONSTANTES
   R√¥le : listes de pi√®ces, poses, cat√©gories, tarifs de base            */
/* ============================= */
const PIECES_PREDEFINIES = [
  "Salon","Cuisine","Salle √† manger","Salle de bain","Salle d'eau",
  "Chambre 1","Chambre 2","Chambre 3","Toilettes","Bureau",
  "Buanderie","Garage","Couloir","Terrasse","Balcon","Jardin",
  "D√©barras","Ext√©rieur","Grenier/Combles"
];

const CATEGORIES = ["Prises","√âclairage","Circuit sp√©cialis√©"];

const POSES = [
  "Encastr√© ma√ßonnerie",
  "Placo",
  "Semi-encastr√©",
  "Sur-mesure",
  "Saillie avec moulure",
  "Sous tube IRL"
];

const DESIGNATIONS_PAR_CATEGORIE = {
  "Prises": ["Prise"],

  // ‚¨áÔ∏è Nouvelle s√©paration √âclairage :
  "√âclairage/Luminaires": ["Point de centre","Applique"],
  "√âclairage/Commandes": ["Interrupteur simple","Interrupteur double"],

  // ‚¨áÔ∏è Si tu as d√©j√† "Circuit sp√©cialis√©", garde-le tel quel :
  "Circuit sp√©cialis√©": [
    "Four","Plaque de cuisson","Lave-linge","Lave-vaisselle",
    "S√®che-linge","Cumulus","VMC","Chauffage",
    "Climatisation","Prise ext√©rieure √©tanche","Autre circuit sp√©cialis√©"
  ]
};

const TARIFS = {
  "Prise": { creation:120, recablage_sans:50, recablage_avec:70, remplacement:20 },
  "Point de centre": { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  "Applique": { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  "Interrupteur simple": { creation:40, recablage_sans:50, recablage_avec:75, remplacement:25 },
  "Interrupteur double": { creation:60, recablage_sans:50, recablage_avec:85, remplacement:35 },

  // Exemple de tarifs pour circuits sp√©cialis√©s (√† ajuster)
  "Four": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "Plaque de cuisson": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "Lave-linge": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "Lave-vaisselle": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "S√®che-linge": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "Cumulus": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "VMC": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "Chauffage": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "Climatisation": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "Prise ext√©rieure √©tanche": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  "Autre circuit sp√©cialis√©": { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 }
};
/* ============================= */
/* CHAPITRE 4 : MENU PRINCIPAL (ne remplace rien, il coiffe le flux existant) */
/* ============================= */
function pageMain(){
  view(`
    <div class="card">
      <h2>Menu principal</h2>
      <div class="row">
        ${b("‚ûï Nouveau devis","actionNouveauDevis()","btn primary")}
        ${b("üìÇ Mes devis sauvegard√©s","pageSavedDevis()")}
      </div>
    </div>
  `);
}
function actionNouveauDevis(){
  devis = {}; // reset propre
  pageHome(); // ‚Ü©Ô∏è on lance le FLUX VALID√â (petits carr√©s) tel quel
}
function pageSavedDevis(){
  const saved = JSON.parse(localStorage.getItem("savedDevisList")||"[]");
  if(!saved.length){
    view(`<div class="card">
      ${b("Retour","pageMain()","btn back")}
      <h2>Mes devis sauvegard√©s</h2>
      <p class="muted">Aucun devis sauvegard√©.</p>
    </div>`);
    return;
  }
  const list = saved.map((d,i)=>`<div class="pill">
      <strong>${d.name}</strong> <small>${d.date}</small>
      ${b("Ouvrir",`loadDevis(${i})`)} ${b("Supprimer",`deleteDevis(${i})`,"btn")}
    </div>`).join('');
  view(`<div class="card">
      ${b("Retour","pageMain()","btn back")}
      <h2>Mes devis sauvegard√©s</h2>
      <div class="list">${list}</div>
  </div>`);
}
function saveCurrentDevis(){
  const name = prompt("Nom du devis :","") || ("Devis " + new Date().toLocaleDateString());
  const saved = JSON.parse(localStorage.getItem("savedDevisList")||"[]");
  saved.push({ name, date:new Date().toLocaleDateString(), data:devis });
  localStorage.setItem("savedDevisList", JSON.stringify(saved));
  alert("Devis sauvegard√© !");
}
function loadDevis(idx){
  const saved = JSON.parse(localStorage.getItem("savedDevisList")||"[]");
  if(saved[idx]){ devis = saved[idx].data; pageHome(); }
}
function deleteDevis(idx){
  if(!confirm("Supprimer ce devis ?")) return;
  const saved = JSON.parse(localStorage.getItem("savedDevisList")||"[]");
  saved.splice(idx,1);
  localStorage.setItem("savedDevisList", JSON.stringify(saved));
  pageSavedDevis();
}

/* ============================= */
/* CHAPITRE 5 : ACCUEIL & FLUX ‚ÄúPI√àCES DYN.‚Äù
   R√¥le : ajouter/supprimer des pi√®ces, puis d√©rouler : 
   cat√©gorie ‚Üí intervention ‚Üí pose ‚Üí quantit√© ‚Üí note */
/* ============================= */

// Helpers communs
function ensureSection(piece){
  if(!devis[piece]) devis[piece] = { items:[], note:"" };
}
function saveLocal(){
  try { localStorage.setItem('devis', JSON.stringify(devis)); } catch(e){}
}
function loadLocal(){
  try {
    const raw = localStorage.getItem('devis');
    if (raw) devis = JSON.parse(raw) || {};
  } catch(e){ devis = {}; }
}

/* Accueil */
function pageHome(){
  const listPieces = Object.keys(devis);
  const listHtml = listPieces.length
    ? listPieces.map(p => `<div class="pill">
          <strong>${p}</strong>
          <small>${devis[p].items.length} ligne(s)</small>
          ${b("Ouvrir", `goPiece('${p}')`,"btn")}
          ${b("Supprimer", `removePiece('${p}')`,"btn")}
        </div>`).join('')
    : `<p class="muted">Aucune pi√®ce ajout√©e pour l‚Äôinstant.</p>`;

  view(`
    <div class="card">
      <h2>Accueil</h2>
      <div class="row">
        ${b("Ajouter une pi√®ce","pageAddPiece()","btn primary")}
        ${b("Installations sp√©cifiques","pageISHome()","btn")}
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Pi√®ces ajout√©es</h2>
      <div class="list">${listHtml}</div>
    </div>

    <div class="row" style="margin-top:12px;">
      ${b("Voir l‚Äôestimatif","pageEstimatif()")}
      ${b("Voir les totaux","pageTotaux()")}
    </div>
  `);
}

/* S√©lection / cr√©ation de pi√®ce */
function pageAddPiece(){
  const options =
    PIECES_PREDEFINIES.map(p=>`<option value="${p}">${p}</option>`).join('') +
    `<option value="__NEW__">‚ûï Cr√©er une nouvelle pi√®ce‚Ä¶</option>`;

  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Ajouter une pi√®ce</h2>
      <label>Choisir une pi√®ce</label>
      <select id="piece-choice">${options}</select>
      <div class="row" style="margin-top:10px;">
        ${b("Valider","confirmPieceChoice()","btn primary")}
      </div>
    </div>
  `);
}
function confirmPieceChoice(){
  const sel = document.getElementById('piece-choice').value;
  if(!sel) return;

  let name = sel;
  if (sel === "__NEW__") {
    name = (prompt("Nom de la pi√®ce :","") || "").trim();
    if(!name) return; // annul√© ou vide
  }

  ensureSection(name);   // cr√©e la section si n√©cessaire
  goPiece(name);         // ouvre la pi√®ce directement
}
function removePiece(piece){
  if(confirm(`Supprimer la pi√®ce ‚Äú${piece}‚Äù et toutes ses lignes ?`)){
    delete devis[piece];
    saveLocal();              // ‚¨ÖÔ∏è Sauvegarde auto
    pageHome();
  }
}

/* Page d‚Äôune pi√®ce */
function goPiece(piece){
  ctx = { piece, category:null, intervention:null, pose:null, designation:null };
  ensureSection(piece);

  // On filtre "Sp√©cifique" au cas o√π il serait encore dans CATEGORIES
  const cats = CATEGORIES
    .filter(cat => cat !== "Sp√©cifique")
    .map(cat => b(cat, `goCategory('${cat}')`))
    .join('');

  const noteTxt = devis[piece].note
    ? `<em class="muted">Note : ${devis[piece].note}</em>`
    : `<span class="muted">Aucune note</span>`;

  const lignes = devis[piece].items.length
    ? `<ul>` + devis[piece].items.map((it,i)=>{
        const total = (it.prixU||0) * (it.qty||0);
        const poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? ` ‚Äî ${it.pose.toLowerCase()}` : "";
        const unitTxt = it.unit || "u";
        return `<li>
          ${it.intervention ? it.intervention + " ‚Äî " : ""}${it.designation}${poseTxt}
          (${it.qty} ${unitTxt} √ó ${euro(it.prixU)} = ${euro(total)})
          ${b("√ó",`delLine('${piece}',${i})`,"btn")}
        </li>`;
      }).join('') + `</ul>`
    : `<p class="muted">Aucune ligne pour l‚Äôinstant.</p>`;

  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>${piece}</h2>
      <div class="row">
        ${cats}
        ${b("Sp√©cifique",`pagePieceSpecifique()`,"btn ghost")}
      </div>

      <div class="row" style="margin-top:10px;">
        ${b("Ajouter / modifier la note","editPieceNote()")}
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Lignes de la pi√®ce</h2>
      ${lignes}
      <p style="margin-top:8px;">${noteTxt}</p>
    </div>
  `);
}
function delLine(piece, idx){
  devis[piece].items.splice(idx,1);
  saveLocal();                // ‚¨ÖÔ∏è Sauvegarde auto
  goPiece(piece);
}

/* Cat√©gorie ‚Üí Intervention ‚Üí Pose ‚Üí Quantit√© */
function goCategory(cat){
  ctx.category = cat;

  // Cas sp√©cial : √âclairage -> sous-menu
  if (cat === "√âclairage") {
    return goEclairageSub();
  }

  let interventions = [];
  if (cat === "Prises" || cat === "Circuit sp√©cialis√©") {
    interventions = [
      "Cr√©ation",
      "Remplacement appareillage",
      "Rec√¢blage avec remplacement appareillage",
      "Rec√¢blage sans remplacement appareillage"
    ];
  } else if (cat === "Sp√©cifique") {
    interventions = ["Saisie libre avec prix"];
  } else {
    interventions = ["Cr√©ation"];
  }

  const btns = interventions.map(i=> b(i,`goIntervention('${i}')`)).join('');
  view(`
    <div class="card">
      ${b("Retour",`goPiece('${ctx.piece}')`,"btn back")}
      <h2>${ctx.category} ‚Äî ${ctx.piece}</h2>
      <div class="row">${btns}</div>
    </div>
  `);
}

function goEclairageSub(){
  view(`
    <div class="card">
      ${b("Retour",`goPiece('${ctx.piece}')`,"btn back")}
      <h2>√âclairage ‚Äî ${ctx.piece}</h2>
      <div class="row">
        ${b("Luminaires", `setEclairageBranch('√âclairage/Luminaires')`)}
        ${b("Commandes", `setEclairageBranch('√âclairage/Commandes')`)}
      </div>
    </div>
  `);
}
function setEclairageBranch(branch){
  ctx.category = branch;

  let interventions = [];
  if (branch === "√âclairage/Luminaires") {
    interventions = [
      "Cr√©ation",
      "Remplacement luminaire",
      "Rec√¢blage avec remplacement luminaire",
      "Rec√¢blage sans remplacement luminaire"
    ];
  } else { // Commandes
    interventions = [
      "Cr√©ation",
      "Remplacement appareillage",
      "Rec√¢blage avec remplacement appareillage",
      "Rec√¢blage sans remplacement appareillage"
    ];
  }

  const btns = interventions.map(i=> b(i,`goIntervention('${i}')`)).join('');
  view(`
    <div class="card">
      ${b("Retour","goEclairageSub()","btn back")}
      <h2>${branch} ‚Äî ${ctx.piece}</h2>
      <div class="row">${btns}</div>
    </div>
  `);
}

function goIntervention(interv){
  ctx.intervention = interv;

  // Cas sp√©cifique (saisie libre)
  if (ctx.category === "Sp√©cifique") {
    const label = prompt("Nom de la prestation sp√©cifique :","");
    if(!label){ return goCategory("Sp√©cifique"); }
    const prix = parseFloat(prompt("Prix estim√© (‚Ç¨) :","0"))||0;
    ensureSection(ctx.piece);
    devis[ctx.piece].items.push({
      category:"Sp√©cifique", intervention:"", pose:"",
      designation:label, qty:1, prixU:prix
    });
    saveLocal();
    return goPiece(ctx.piece);
  }

  // Pose obligatoire pour Cr√©ation
  const needsPoseOnCreation =
    (ctx.category === "Prises") ||
    (ctx.category === "Circuit sp√©cialis√©") ||
    (ctx.category === "√âclairage/Luminaires") ||
    (ctx.category === "√âclairage/Commandes");

  if (interv === "Cr√©ation" && needsPoseOnCreation) {
    const poses = POSES.map(p=> b(p,`goDesignation('${p}')`)).join('');
    const backCat = (ctx.category.startsWith("√âclairage/") ? "√âclairage" : ctx.category);
    view(`
      <div class="card">
        ${b("Retour",`goCategory('${backCat}')`,"btn back")}
        <h2>Type de pose</h2>
        <div class="row">${poses}</div>
      </div>
    `);
  } else {
    goDesignation(null);
  }
}

function goDesignation(pose){
  ctx.pose = pose; // peut √™tre null (hors Cr√©ation)

  const list = DESIGNATIONS_PAR_CATEGORIE[ctx.category] || ["√âl√©ment"];

  // üîß Auto-skip si une seule d√©signation (ex: Prises ‚Üí "Prise")
  if (list.length === 1) {
    return pageQuantite(list[0]);
  }

  const btns = list.map(d=> b(d,`pageQuantite('${d}')`)).join('');
  view(`
    <div class="card">
      ${b("Retour", ctx.intervention==="Cr√©ation" 
                  ? `goIntervention('${ctx.intervention}')` 
                  : `goCategory('${ctx.category}')`,"btn back")}
      <h2>D√©signation</h2>
      <div class="row">${btns}</div>
    </div>
  `);
}
function pageQuantite(designation){
  ctx.designation = designation;
  const qtyBtns = Array.from({length:10},(_,i)=> b(i+1,`saveItem(${i+1})`)).join('');
  view(`
    <div class="card">
      ${b("Retour",`goDesignation('${ctx.pose}')`,"btn back")}
      <h2>Quantit√©</h2>
      <div class="grid-qty">${qtyBtns}</div>
    </div>
  `);
}

function getPrix(designation, intervention){
  const base = TARIFS[designation] || {};
  if(intervention==="Cr√©ation") return base.creation||0;
  if(intervention.includes("sans remplacement")) return base.recablage_sans||0;
  if(intervention.includes("avec remplacement")) return base.recablage_avec||0;
  if(intervention.startsWith("Remplacement")) return base.remplacement||0;
  return 0;
}

function saveItem(qty){
  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category: ctx.category,
    intervention: ctx.intervention,
    pose: ctx.pose,
    designation: ctx.designation,
    qty: qty,
    prixU: getPrix(ctx.designation, ctx.intervention)
  });
  saveLocal();
  goPiece(ctx.piece);
}

/* Sp√©cifique (raccourci) */
function pagePieceSpecifique(){
  const label = prompt("Nom de la prestation sp√©cifique :","");
  if(!label){ return goPiece(ctx.piece); }
  const prix = parseFloat(prompt("Prix estim√© (‚Ç¨) :","0"))||0;
  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category:"Sp√©cifique", intervention:"", pose:"",
    designation:label, qty:1, prixU:prix
  });
  saveLocal();
  goPiece(ctx.piece);
}

/* Note */
function editPieceNote(){
  ensureSection(ctx.piece);
  const cur = devis[ctx.piece].note || "";
  const n = prompt(`Note pour ${ctx.piece}`, cur);
  if(n!==null) devis[ctx.piece].note = n.trim();
  saveLocal();
  goPiece(ctx.piece);
}
/* ============================= */
/* CHAPITRE 6 : INSTALLATIONS SP√âCIFIQUES (placeholder)
   R√¥le : √©cran ‚ÄúIS‚Äù simple qui ne casse rien au flux valid√©.
   (On branchera Terre / Ventilation / Tableau plus tard.) */
/* ============================= */

function pageISHome(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Installations sp√©cifiques</h2>
      <p class="muted">Module d√©taill√© √† r√©int√©grer (Mise √† la terre, Ventilation, Distribution tableau).</p>

      <div class="row" style="margin-top:10px;">
        ${b("Mise √† la terre","isSoon('Mise √† la terre')")}
        ${b("Ventilation","isSoon('Ventilation')")}
        ${b("Distribution tableau","isSoon('Distribution tableau')")}
      </div>

      <p class="muted" style="margin-top:10px;">
        Astuce : tu peux continuer √† saisir tes pi√®ces normalement depuis l‚Äô√©cran Accueil.
      </p>
    </div>
  `);
}

function isSoon(feature){
  alert(`${feature} : √† venir (ce bouton est un placeholder).`);
  pageISHome();
}
/* ============================= */
/* CHAPITRE 7 : ESTIMATIF & TOTAUX + EXPORT */
/* ============================= */
function pageEstimatif(){
  let html = `<div class="card">${b("Retour","pageHome()","btn back")}<h2>Estimatif d√©taill√©</h2>`;
  let totalGlobal = 0;
  for (const section in devis) {
    if (!devis[section] || devis[section].items.length === 0) continue;
    let sectionTotal = 0;
    html += `<h3><strong>${section}</strong></h3><ul>`;
    devis[section].items.forEach((item) => {
      const prixTotal = (item.prixU||0) * (item.qty||0);
      sectionTotal += prixTotal;
      totalGlobal += prixTotal;
      const poseTxt = (item.intervention==="Cr√©ation" && item.pose) ? ` ${item.pose.toLowerCase()}` : "";
      const unitTxt = item.unit ? item.unit : "u";
      const left = item.intervention ? `${item.intervention} ‚Äî ` : "";
      html += `<li>${left}${item.designation}${poseTxt} (${item.qty} ${unitTxt} √ó ${euro(item.prixU)} = ${euro(prixTotal)})</li>`;
    });
    if (devis[section].note) html += `<li><em>Note : ${devis[section].note}</em></li>`;
    html += `</ul><p><strong>Total ${section} : ${euro(sectionTotal)}</strong></p><hr>`;
  }
  html += `<h3>Total global : ${euro(totalGlobal)}</h3>
           <div class="row" style="margin-top:10px;">${b("Exporter en .txt","exportText()")}</div></div>`;
  view(html);
}
function pageTotaux(){
  let html = `<div class="card">${b("Retour","pageHome()","btn back")}<h2>Totaux par section</h2>`;
  let totalGlobal = 0;
  for (const section in devis) {
    if (!devis[section] || devis[section].items.length === 0) continue;
    const sectionTotal = devis[section].items.reduce((sum, it) => sum + ((it.prixU||0) * (it.qty||0)), 0);
    totalGlobal += sectionTotal;
    html += `<p><strong>${section}</strong> : ${euro(sectionTotal)}</p>`;
  }
  html += `<hr><p><strong>Total global : ${euro(totalGlobal)}</strong></p>
           <div class="row" style="margin-top:10px;">${b("Exporter en .txt","exportText()")}</div></div>`;
  view(html);
}
function exportText(){
  let lines = [];
  let totalGlobal = 0;
  for (const section in devis) {
    if (!devis[section] || devis[section].items.length === 0) continue;
    lines.push(`${section} :`);
    let sectionTotal = 0;
    devis[section].items.forEach(item => {
      const prixTotal = (item.prixU||0) * (item.qty||0);
      sectionTotal += prixTotal;
      totalGlobal += prixTotal;
      const poseTxt = (item.intervention==="Cr√©ation" && item.pose) ? ` - ${item.pose.toLowerCase()}` : "";
      const unitTxt = item.unit ? item.unit : "u";
      lines.push(`-${item.qty} ${item.designation}${poseTxt} (${item.prixU}‚Ç¨/ ${unitTxt})`);
    });
    if (devis[section].note) lines.push(`_Note : ${devis[section].note}_`);
    lines.push(`Total ${section} : ${sectionTotal}‚Ç¨`);
    lines.push("");
  }
  lines.push(`Total global : ${totalGlobal}‚Ç¨`);
  const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "devis.txt"; a.click();
  URL.revokeObjectURL(url);
}

/* ============================= */
/* CHAPITRE 8 : D√âMARRAGE (ouvre le menu principal) */
/* ============================= */
function init(){
  try{
    if (typeof loadLocal === 'function') loadLocal(); // restaure l‚Äô√©tat si besoin
    pageMain(); // ‚¨ÖÔ∏è on affiche le menu principal au lancement
  }catch(err){
    const el = document.getElementById('app');
    if (el) el.innerHTML = `<div class="card"><h2>Erreur pendant init()</h2><pre>${(err && err.stack) || err}</pre></div>`;
  }
}
init();
</script>
</main>
</body>
</html>
