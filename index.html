<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- ============================= -->
  <!-- CHAPITRE 1 : STRUCTURE & STYLES -->
  <!-- ============================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis ‚Äî V2</title>
  <style>
    :root { --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666; --line:#e8e8e8; --primary:#111; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
  </style>
</head>
<body>
<header>MiniDevis ‚Äî V2</header>
<main id="app"></main>

<script>
/* ============================= */
/* CHAPITRE 2 : DONN√âES & CONSTANTES */
/* ============================= */
const PIECES_PREDEFINIES = ["Salon","Cuisine","Salle √† manger","Salle de bain","Salle d'eau",
  "Chambre 1","Chambre 2","Chambre 3","Toilettes","Bureau","Buanderie","Garage","Couloir",
  "Terrasse","Balcon","Jardin","D√©barras","Ext√©rieur","Grenier/Combles"];
const CATEGORIES = ["Prises","√âclairage","Sp√©cifique"];
const POSES = ["Encastr√© ma√ßonnerie","Placo","Semi-encastr√©","Sur-mesure"];
const DESIGNATIONS_PAR_CATEGORIE = {
  "Prises": ["Prise"],
  "√âclairage": ["Point de centre","Applique","Interrupteur simple","Interrupteur double"]
};
const TARIFS = {
  "Prise": { creation:120, recablage_sans:50, recablage_avec:70, remplacement:20 },
  "Point de centre": { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  "Applique": { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  "Interrupteur simple": { creation:40, recablage_sans:50, recablage_avec:75, remplacement:25 },
  "Interrupteur double": { creation:60, recablage_sans:50, recablage_avec:85, remplacement:35 }
};

/* ============================= */
/* CHAPITRE 3 : √âTAT & HELPERS UI */
/* ============================= */
let devis = {}; // { [piece]: { items:[{...}], note:"" } }
let ctx = { piece:null, category:null, intervention:null, pose:null, designation:null };

const $app = () => document.getElementById('app');
function view(html){ $app().innerHTML = html; }
function b(label, fn, cls="btn"){ return `<button class="${cls}" onclick="${fn}">${label}</button>`; }
function euro(n){ return `${(+n).toFixed(2)} ‚Ç¨`; }
function ensureSection(piece){ if(!devis[piece]) devis[piece] = { items:[], note:"" }; }

/* ============================= */
/* CHAPITRE 4 : MENU PRINCIPAL */
/* ============================= */
function pageMenu(){
  view(`
    <div class="card">
      <h2>Menu principal</h2>
      <div class="row">
        ${b("‚ûï Nouveau devis","newDevis()","btn primary")}
        ${b("üìÇ Mes devis sauvegard√©s","pageSavedDevis()")}
      </div>
    </div>
  `);
}
function newDevis(){ devis = {}; pageHome(); }
function pageSavedDevis(){
  const saved = JSON.parse(localStorage.getItem("savedDevisList")||"[]");
  if(!saved.length){
    view(`<div class="card">${b("Retour","pageMenu()","btn back")}<h2>Mes devis sauvegard√©s</h2><p class="muted">Aucun devis sauvegard√©.</p></div>`);
    return;
  }
  const list = saved.map((d,i)=>`<div class="pill"><strong>${d.name}</strong> (${d.date}) ${b("Ouvrir",`loadDevis(${i})`)} ${b("Supprimer",`deleteDevis(${i})`,"btn")}</div>`).join('');
  view(`<div class="card">${b("Retour","pageMenu()","btn back")}<h2>Mes devis sauvegard√©s</h2><div class="list">${list}</div></div>`);
}
function saveCurrentDevis(){
  const name = prompt("Nom du devis :","") || ("Devis " + new Date().toLocaleDateString());
  const saved = JSON.parse(localStorage.getItem("savedDevisList")||"[]");
  saved.push({ name, date:new Date().toLocaleDateString(), data:devis });
  localStorage.setItem("savedDevisList", JSON.stringify(saved));
  alert("Devis sauvegard√© !");
}
function loadDevis(idx){
  const saved = JSON.parse(localStorage.getItem("savedDevisList")||"[]");
  if(saved[idx]){ devis = saved[idx].data; pageHome(); }
}
function deleteDevis(idx){
  if(!confirm("Supprimer ce devis ?")) return;
  const saved = JSON.parse(localStorage.getItem("savedDevisList")||"[]");
  saved.splice(idx,1);
  localStorage.setItem("savedDevisList", JSON.stringify(saved));
  pageSavedDevis();
}

/* ============================= */
/* CHAPITRE 5 : ACCUEIL & PI√àCES */
/* ============================= */
function pageHome(){
  const listPieces = Object.keys(devis);
  const listHtml = listPieces.length
    ? listPieces.map(p => `<div class="pill">
          <strong>${p}</strong>
          <small>${devis[p].items.length} ligne(s)</small>
          ${b("Ouvrir", `goPiece('${p}')`,"btn")}
          ${b("Supprimer", `removePiece('${p}')`,"btn")}
        </div>`).join('')
    : `<p class="muted">Aucune pi√®ce ajout√©e pour l‚Äôinstant.</p>`;

  view(`
    <div class="card">
      ${b("Retour menu","pageMenu()","btn back")}
      <h2>Accueil du devis</h2>
      <div class="row">
        ${b("Ajouter une pi√®ce","pageAddPiece()","btn primary")}
        ${b("Installations sp√©cifiques","pageISHome()","btn")}
      </div>
    </div>

    <div class="card">
      <h2>Pi√®ces ajout√©es</h2>
      <div class="list">${listHtml}</div>
    </div>

    <div class="row">
      ${b("Voir l‚Äôestimatif","pageEstimatif()")}
      ${b("Voir les totaux","pageTotaux()")}
      ${b("üíæ Sauvegarder ce devis","saveCurrentDevis()")}
    </div>
  `);
}

function pageAddPiece(){
  const opts = PIECES_PREDEFINIES.map(p=>`<option value="${p}">${p}</option>`).join('');
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Ajouter une pi√®ce</h2>
      <select id="pieceSelect">${opts}<option value="autre">‚ûï Cr√©er une pi√®ce</option></select>
      <div class="row">${b("Valider","confirmPiece()","btn primary")}</div>
    </div>
  `);
}
function confirmPiece(){
  const sel = document.getElementById("pieceSelect").value;
  let name = sel;
  if(sel==="autre"){ name = prompt("Nom de la nouvelle pi√®ce :",""); if(!name) return pageAddPiece(); }
  ensureSection(name); ctx.piece=name; pagePiece(name);
}
function removePiece(p){ if(confirm("Supprimer cette pi√®ce ?")){ delete devis[p]; pageHome(); } }
function goPiece(p){ ctx.piece=p; pagePiece(p); }
function pagePiece(p){
  const sec = devis[p]; if(!sec) return pageHome();
  const lines = sec.items.map((it,i)=>`<div class="pill">
      ${it.qty}x ${it.designation} ‚Äî ${it.intervention} ‚Äî ${euro(it.total)}
      ${b("‚úèÔ∏è","editLine('${p}',${i})")} ${b("üóëÔ∏è","delLine('${p}',${i})")}
    </div>`).join('');
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>${p}</h2>
      <div class="row">
        ${b("Ajouter une ligne","pageCategory()","btn primary")}
        ${b("üìù Note","pageNotePiece('${p}')")}
      </div>
    </div>
    <div class="card"><h2>Lignes</h2><div class="list">${lines||"<p class='muted'>Aucune ligne</p>"}</div></div>
  `);
}
function pageNotePiece(p){
  const sec = devis[p]; const val = sec.note || "";
  view(`
    <div class="card">
      ${b("Retour",`pagePiece('${p}')`,"btn back")}
      <h2>Note pour ${p}</h2>
      <textarea id="note" rows="6">${val}</textarea>
      ${b("Enregistrer","saveNotePiece('"+p+"')","btn primary")}
    </div>
  `);
}
function saveNotePiece(p){ devis[p].note = document.getElementById("note").value; pagePiece(p); }

/* ============================= */
/* CHAPITRE 6 : CAT√âGORIE ‚Üí INTERVENTION ‚Üí POSE ‚Üí DESIGNATION */
/* ============================= */
function pageCategory(){
  const opts = CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join('');
  view(`<div class="card">${b("Retour","pagePiece(ctx.piece)","btn back")}<h2>Cat√©gorie</h2>
    <select id="cat">${opts}</select>
    ${b("Valider","confirmCategory()","btn primary")}</div>`);
}
function confirmCategory(){ ctx.category=document.getElementById("cat").value; pageIntervention(); }
function pageIntervention(){
  const opts=["Cr√©ation","Rec√¢blage sans saign√©e","Rec√¢blage avec saign√©e","Remplacement"].map(x=>`<option>${x}</option>`).join('');
  view(`<div class="card">${b("Retour","pageCategory()","btn back")}<h2>Type d‚Äôintervention</h2>
    <select id="interv">${opts}</select>
    ${b("Valider","confirmInterv()","btn primary")}</div>`);
}
function confirmInterv(){ ctx.intervention=document.getElementById("interv").value; pagePose(); }
function pagePose(){
  const opts = POSES.map(p=>`<option>${p}</option>`).join('');
  view(`<div class="card">${b("Retour","pageIntervention()","btn back")}<h2>Type de pose</h2>
    <select id="pose">${opts}</select>
    ${b("Valider","confirmPose()","btn primary")}</div>`);
}
function confirmPose(){ ctx.pose=document.getElementById("pose").value; pageDesignation(); }
function pageDesignation(){
  const list = DESIGNATIONS_PAR_CATEGORIE[ctx.category]||["Autre"];
  const opts = list.map(d=>`<option value="${d}">${d}</option>`).join('');
  view(`<div class="card">${b("Retour","pagePose()","btn back")}<h2>D√©signation</h2>
    <select id="des">${opts}<option value="autre">Autre...</option></select>
    ${b("Valider","confirmDes()","btn primary")}</div>`);
}
function confirmDes(){
  let d=document.getElementById("des").value;
  if(d==="autre") d=prompt("Nouvelle d√©signation :","")||"Autre";
  ctx.designation=d; pageQty();
}
function pageQty(){
  const btns = Array.from({length:6},(_,i)=>b(i+1,`addLine(${i+1})`,"btn")).join('');
  view(`<div class="card">${b("Retour","pageDesignation()","btn back")}<h2>Quantit√©</h2><div class="grid-qty">${btns}</div></div>`);
}
function addLine(q){
  const prix = TARIFS[ctx.designation];
  let unit=0;
  if(prix){
    if(ctx.intervention==="Cr√©ation") unit=prix.creation;
    else if(ctx.intervention.includes("sans")) unit=prix.recablage_sans;
    else if(ctx.intervention.includes("avec")) unit=prix.recablage_avec;
    else unit=prix.remplacement;
  }
  const total=unit*q;
  devis[ctx.piece].items.push({ category:ctx.category, intervention:ctx.intervention, pose:ctx.pose, designation:ctx.designation, qty:q, unit, total });
  pagePiece(ctx.piece);
}
function editLine(p,i){
  const it=devis[p].items[i]; const newQty=prompt("Nouvelle quantit√©:",it.qty);
  if(newQty){ it.qty=+newQty; it.total=it.qty*it.unit; pagePiece(p); }
}
function delLine(p,i){ devis[p].items.splice(i,1); pagePiece(p); }

/* ============================= */
/* CHAPITRE 7 : INSTALLATIONS SP√âCIFIQUES */
/* ============================= */
function pageISHome(){
  view(`<div class="card">${b("Retour","pageHome()","btn back")}<h2>Installations sp√©cifiques</h2><p class="muted">(Module √† compl√©ter)</p></div>`);
}

/* ============================= */
/* CHAPITRE 8 : ESTIMATIF & TOTAUX */
/* ============================= */
function pageEstimatif(){
  let html=""; let total=0;
  for(const p in devis){
    html+=`<h3>${p}</h3>`;
    devis[p].items.forEach(it=>{ html+=`${it.qty}x ${it.designation} (${it.intervention}) ‚Äî ${euro(it.total)}<br>`; total+=it.total; });
    if(devis[p].note) html+=`<em>Note: ${devis[p].note}</em><br>`;
  }
  view(`<div class="card">${b("Retour","pageHome()","btn back")}<h2>Estimatif d√©taill√©</h2><pre>${html||"Aucune ligne"}</pre><p><strong>Total: ${euro(total)}</strong></p></div>`);
}
function pageTotaux(){
  let total=0; for(const p in devis){ devis[p].items.forEach(it=>total+=it.total); }
  view(`<div class="card">${b("Retour","pageHome()","btn back")}<h2>Total global</h2><p><strong>${euro(total)}</strong></p></div>`);
}

/* ============================= */
/* CHAPITRE 9 : D√âMARRAGE */
/* ============================= */
function init(){ pageMenu(); }
init();
</script>
</main>
</body>
</html>
