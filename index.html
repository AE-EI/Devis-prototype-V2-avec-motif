<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis â€” V3.0</title>

  <!-- Styles de base -->
  <style>
    :root {
      --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666;
      --line:#e8e8e8; --primary:#111;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#444; background:#fafafa; }
  </style>

  <!-- JSZip (exports ZIP) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- Cache-busting : ajoute ?v=timestamp une seule fois par onglet -->
  <script>
  (function(){
    try{
      var url = new URL(location.href);
      if (url.searchParams.has('v')) return;
      var onceKey = 'cb_once_' + location.pathname;
      if (sessionStorage.getItem(onceKey)) return;
      url.searchParams.set('v', Date.now());
      sessionStorage.setItem(onceKey, '1');
      location.replace(url.toString());
    }catch(e){}
  })();
  </script>
</head>
<body>
  <header>MiniDevis â€” V3.0</header>
  <main id="app"></main>

  <!-- Sentinelle ultra-tÃ´t -->
  <script>
  (function(){
    var app = document.getElementById('app');
    if(app){ app.innerHTML =
      '<div class="card">Loader OK â€” en attente des chapitres JSâ€¦</div>';
    }
  })();
  </script>

<!-- =============================
     CHAPITRE 2 : Ã‰TAT & HELPERS
     ============================= -->
<script>
// --- Debug global : affiche toute erreur JS dans #app
window.addEventListener('error', function (e) {
  var el = document.getElementById('app');
  if (el) {
    el.innerHTML =
      '<div class="card"><h2>Erreur JS</h2><pre>'
      + (e.message || 'Erreur inconnue')
      + '\n' + (e.filename || '') + ':' + (e.lineno || 0) + ':' + (e.colno || 0)
      + '</pre></div>';
  }
});

// --- Ã‰tat global
var devis = {}; // contiendra aussi __id, __name, __tabCounter
var ctx   = { piece:null, category:null, intervention:null, pose:null, designation:null };

// --- Identifiants
function genId(){ return 'dv_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
function ensureId(){ if(!devis.__id) devis.__id = genId(); }

// --- DOM & helpers UI
function $app(){ return document.getElementById('app'); }

/** CrÃ©e un bouton (fn = string comme "goPiece('Salon')") */
function b(label, fn, cls){
  cls = cls || 'btn';
  return '<button class="'+cls+'" onclick=\''+fn+'\'>'+label+'</button>';
}

/** Format â‚¬ */
function euro(n){ return (+(n||0)).toFixed(2) + ' â‚¬'; }

/** Rendu principal avec footer Sauvegarde/Accueil (dÃ©sactivable par noFooter=true) */
function view(html, noFooter){
  if(!noFooter){
    html += '<div class="row" style="margin-top:16px; gap:12px;">'
          + b('â¬…ï¸ Accueil','confirmBackHome()','btn back')
          + b('ğŸ’¾ Sauvegarder devis','saveCurrentDevis()','btn primary')
          + '</div>';
  }
  $app().innerHTML = html;
}

/** Confirmation retour accueil si donnÃ©es non vides */
function confirmBackHome(){
  var hasData = Object.keys(devis)
    .filter(function(k){ return k.indexOf('__') !== 0; })
    .some(function(k){
      var s = devis[k]||{};
      return (s.items && s.items.length>0) || (s.note && s.note.trim().length>0);
    });

  if(!hasData || confirm('Revenir au menu principal ?\nâš ï¸ Les modifications non sauvegardÃ©es seront perdues.')){
    if (typeof pageMain === 'function') pageMain();
    else $app().innerHTML = '<div class="card"><h2>Accueil</h2><p class="muted">Le chapitre Menu (4) n\'est pas encore chargÃ©.</p></div>';
  }
}

// --- LibellÃ©s des piÃ¨ces (base + qualificatif + Ã©tage)
function buildPieceLabel(base, qualif, etage){
  var lbl = base || '';
  if(qualif && qualif.trim()) lbl += ' ('+qualif.trim()+')';
  if(etage && etage.trim())   lbl += ' â€” '+etage.trim();
  return lbl;
}
/** Cherche une clÃ© libre si le libellÃ© existe dÃ©jÃ  (Salon, Salon (2), â€¦) */
function nextFreeKey(label){
  if(!devis[label]) return label;
  var n=2; while(devis[label+' ('+n+')']) n++;
  return label+' ('+n+')';
}
/** CrÃ©e (ou rÃ©cupÃ¨re) une section piÃ¨ce, avec mÃ©ta conservÃ©es */
function createOrGetPiece(base, qualif, etage){
  var wanted = buildPieceLabel(base,qualif,etage);
  var key    = nextFreeKey(wanted);
  if(!devis[key]) devis[key] = { __base:base, qualificatif:qualif||'', etage:etage||'', items:[], note:'' };
  saveLocal();
  return key;
}
/** Affiche le libellÃ© complet dâ€™une clÃ© piÃ¨ce */
function formatPieceLabel(key){
  var s = devis[key]; if(!s) return key;
  var base = s.__base || key;
  return buildPieceLabel(base, s.qualificatif, s.etage);
}

// --- Persistance locale
function ensureSection(key){
  if(!devis[key]) devis[key] = { items:[], note:'', qualificatif:'', etage:'' };
}
function saveLocal(){
  try { localStorage.setItem('devis', JSON.stringify(devis)); } catch(e){}
}
function loadLocal(){
  try { devis = JSON.parse(localStorage.getItem('devis') || '{}') || {}; }
  catch(e){ devis = {}; }
  ensureId();
}
</script>

<!-- =============================
     CHAPITRE 3 : CONSTANTES
     ============================= -->
<script>
// PiÃ¨ces prÃ©dÃ©finies
var PIECES_PREDEFINIES = [
  'Salon','Cuisine','Salle Ã  manger','Salle de bain','Salle d\'eau',
  'Chambre 1','Chambre 2','Chambre 3','Toilettes','Bureau',
  'Buanderie','Garage','Couloir','Terrasse','Balcon','Jardin',
  'DÃ©barras','ExtÃ©rieur','Grenier/Combles','Atelier',
  'Abri de jardin','EntrÃ©e','BibliothÃ¨que'
];

// CatÃ©gories standards
var CATEGORIES = [
  'Prises','Ã‰clairage','Circuit spÃ©cialisÃ©','SpÃ©cifique'
];

// Modes de pose
var POSES = [
  'EncastrÃ© maÃ§onnerie','Placo','Semi-encastrÃ©',
  'Sur-mesure','Saillie avec moulure','Sous tube IRL'
];

// Sections de cÃ¢blage (avec option personnalisÃ©e)
var SECTIONS_CABLE = [
  '0,75 mmÂ²','1,5 mmÂ²','2,5 mmÂ²','6 mmÂ²','PersonnalisÃ©eâ€¦'
];

// DÃ©signations possibles par catÃ©gorie
// âš ï¸ pas dâ€™"Autre circuit spÃ©cialisÃ©" (remplacÃ© par champ libre dans lâ€™UI)
var DESIGNATIONS_PAR_CATEGORIE = {
  'Prises': ['Prise'],
  'Ã‰clairage/Luminaires': ['Point de centre','Applique'],
  'Ã‰clairage/Commandes': ['Interrupteur simple','Interrupteur double'],
  'Circuit spÃ©cialisÃ©': [
    'Four','Plaque de cuisson','Lave-linge','Lave-vaisselle',
    'SÃ¨che-linge','Cumulus','VMC','Chauffage','Climatisation',
    'Prise extÃ©rieure Ã©tanche'
  ]
};

// Tarifs de base (piÃ¨ces classiques)
var TARIFS = {
  'Prise': { creation:120, recablage_sans:50, recablage_avec:70, remplacement:20 },
  'Point de centre': { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  'Applique': { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  'Interrupteur simple': { creation:40, recablage_sans:50, recablage_avec:75, remplacement:25 },
  'Interrupteur double': { creation:60, recablage_sans:50, recablage_avec:85, remplacement:35 },
  'Four': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Plaque de cuisson': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Lave-linge': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Lave-vaisselle': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'SÃ¨che-linge': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Cumulus': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'VMC': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Chauffage': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Climatisation': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Prise extÃ©rieure Ã©tanche': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 }
};

// Ã‰tages prÃ©dÃ©finis
var ETAGES = [
  'Rez-de-chaussÃ©e','1er Ã©tage','2e Ã©tage',
  'Sous-sol','Combles','Annexe'
];

/* ======================================================
   TARIFS â€” TABLEAU & DISTRIBUTION (pose, modulaires, etc.)
   ====================================================== */
var TARIFS_TABLEAU = {
  pose_base_13: { 1:60, 2:80, 3:100, 4:120 },
  coef: {
    modules: { 13:1.00, 18:1.30, 24:1.50 },
    pose: { 'Saillie':1.00, 'EncastrÃ©':1.70 },
    intervention: { 'CrÃ©ation':1.00, 'Avec dÃ©pose de lâ€™existant':1.30 }
  },
  // + ajout 40A = 45â‚¬
  disjoncteurs: { 2:32, 10:25, 16:25, 20:25, 32:32, 40:45 },
  inter_diff: { '40A-AC':60, '40A-A':80, '63A-AC':100, '63A-A':120 },
  commandes: {
    'TÃ©lÃ©rupteur':50,
    'TÃ©lÃ©rupteur silencieux':70,
    'Horloge mÃ©canique + Disjoncteur 2A':80,
    'Horloge mÃ©canique + contacteur heures creuses + Disjoncteur 2A':130
  }
};

function getTabPrice(rang, modules, pose, intervention){
  var base = TARIFS_TABLEAU.pose_base_13[+rang] || 0;
  if(!base) return 0;
  var cMod = TARIFS_TABLEAU.coef.modules[+modules] || 1.00;
  var cPose= TARIFS_TABLEAU.coef.pose[pose] || 1.00;
  var cInv = TARIFS_TABLEAU.coef.intervention[intervention] || 1.00;
  return Math.round(base * cMod * cPose * cInv * 100) / 100;
}
function getPrix(designation, intervention){
  var base = TARIFS[designation] || {};
  if(intervention === 'CrÃ©ation') return base.creation || 0;
  if(intervention && intervention.indexOf('sans remplacement') >= 0) return base.recablage_sans || 0;
  if(intervention && intervention.indexOf('avec remplacement') >= 0) return base.recablage_avec || 0;
  if(intervention && intervention.indexOf('Remplacement') === 0) return base.remplacement || 0;
  return 0;
}
</script>

<!-- =============================
     CHAPITRE 4 : MENU PRINCIPAL
     ============================= -->
<script>
function pageMain(){
  view(
    '<div class="card">'
      +'<h2>Menu principal</h2>'
      +'<div class="row">'
        +b('â• Nouveau devis','actionNouveauDevis()','btn primary')
        +b('ğŸ“‚ Mes devis sauvegardÃ©s','pageSavedDevis()','btn')
      +'</div>'
    +'</div>'
  , true);
}
function actionNouveauDevis(){
  devis = { __id: genId(), __name: '' };
  saveLocal();
  pageHome();
}
function pageSavedDevis(){
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  if(!saved.length){
    return view(
      '<div class="card">'
        +b('Retour','pageMain()','btn back')
        +'<h2>Mes devis sauvegardÃ©s</h2>'
        +'<p class="muted">Aucun devis sauvegardÃ©.</p>'
      +'</div>', true
    );
  }
  var list = saved.map(function(d,i){
    return '<div class="pill">'
      +'<strong>'+d.name+'</strong> <small>'+d.date+'</small>'
      +b('Ouvrir','loadDevis('+i+')','btn')
      +b('Supprimer','deleteDevis('+i+')','btn')
      +'</div>';
  }).join('');
  view(
    '<div class="card">'
      +b('Retour','pageMain()','btn back')
      +'<h2>Mes devis sauvegardÃ©s</h2>'
      +'<div class="list">'+list+'</div>'
    +'</div>', true
  );
}
function loadDevis(idx){
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  if(!saved[idx]) return pageSavedDevis();
  devis = saved[idx].data || {};
  ensureId();
  saveLocal();
  pageHome();
}
function deleteDevis(idx){
  if(!confirm('Supprimer ce devis sauvegardÃ© ?')) return;
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  saved.splice(idx,1);
  localStorage.setItem('savedDevisList', JSON.stringify(saved));
  pageSavedDevis();
}
function saveCurrentDevis(){
  ensureId();
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  var i = saved.findIndex(function(d){ return d.data && d.data.__id === devis.__id; });
  if(i >= 0){
    var name = devis.__name || saved[i].name || ('Devis '+new Date().toLocaleDateString());
    devis.__name = name;
    saved[i] = { name:name, date:new Date().toLocaleDateString(), data:devis };
    localStorage.setItem('savedDevisList', JSON.stringify(saved));
    alert('Devis mis Ã  jour.');
    return;
  }
  var name2 = (devis.__name||'').trim();
  if(!name2){
    name2 = (prompt('Nom du devis :','')||'').trim();
    if(!name2){ alert('Sauvegarde annulÃ©e.'); return; }
  }
  var j = saved.findIndex(function(d){ return (d.name||'').toLowerCase() === name2.toLowerCase(); });
  devis.__name = name2;
  if(j >= 0){
    if(!confirm('Un devis Â« '+name2+' Â» existe dÃ©jÃ . L\'Ã©craser ?')) return;
    saved[j] = { name:name2, date:new Date().toLocaleDateString(), data:devis };
  } else {
    saved.push({ name:name2, date:new Date().toLocaleDateString(), data:devis });
  }
  localStorage.setItem('savedDevisList', JSON.stringify(saved));
  alert('Devis sauvegardÃ© !');
}
</script>

<!-- =============================
     CHAPITRE 5 : ACCUEIL & FLUX PIÃˆCES (V5-onepage + amÃ©liorations)
     ============================= -->
<script>
// ---- Accueil
function pageHome(){
  var keys = Object.keys(devis).filter(k=>k.indexOf('__')!==0);
  var listHtml = keys.length ? keys.map(function(key){
    var s = devis[key] || {};
    var badges = [
      (s.qualificatif && s.qualificatif.trim()) ? '<span class="badge">'+s.qualificatif+'</span>' : '',
      (s.etage && s.etage.trim()) ? '<span class="badge">'+s.etage+'</span>' : ''
    ].filter(Boolean).join(' ');
    var label = pieceDisplayLabel(key);
    return '<div class="pill">'
      +'<strong>'+label+'</strong> '
      +'<small>'+((s.items||[]).length)+' ligne(s)</small> '
      +badges
      +b('Ouvrir','goPiece('+JSON.stringify(key)+')','btn')
      +b('Supprimer','removePiece('+JSON.stringify(key)+')','btn')
    +'</div>';
  }).join('') : '<p class="muted">Aucune piÃ¨ce ajoutÃ©e pour lâ€™instant.</p>';

  view(
    '<div class="card">'
      +'<h2>Accueil</h2>'
      +'<div class="row">'
        +b('Ajouter une piÃ¨ce','pageAddPiece()','btn primary')
        +b('CrÃ©er un tableau','pageTabCreate()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>PiÃ¨ces & Tableaux ajoutÃ©s</h2>'
      +'<div class="list">'+listHtml+'</div>'
    +'</div>'
    +'<div class="row" style="margin-top:12px;">'
      +b('Voir lâ€™estimatif','pageEstimatif()','btn')
      +b('Voir les totaux','pageTotaux()','btn')
    +'</div>'
  );
}

// ---- Ajouter une piÃ¨ce
function pageAddPiece(){
  var opts = PIECES_PREDEFINIES.map(p=>'<option value="'+p+'">'+p+'</option>').join('')
           + '<option value="__NEW__">â• CrÃ©er une nouvelle piÃ¨ceâ€¦</option>';
  var etageOpts = ['(aucun)'].concat(ETAGES).map(e=>'<option value="'+e+'">'+e+'</option>').join('');

  view(
    '<div class="card">'
      +b('Retour','pageHome()','btn back')
      +'<h2>Ajouter une piÃ¨ce</h2>'
      +'<label>Choisir une piÃ¨ce</label>'
      +'<select id="piece-choice">'+opts+'</select>'
      +'<label style="margin-top:10px;">Qualificatif (optionnel)</label>'
      +'<input id="piece-qualif" placeholder="ex : Parents, RDC, gauche" />'
      +'<label style="margin-top:10px;">Ã‰tage (optionnel)</label>'
      +'<select id="piece-etage">'+etageOpts+'</select>'
      +'<div class="row" style="margin-top:10px;">'
        +b('Valider','confirmPieceChoice()','btn primary')
      +'</div>'
    +'</div>'
  );
}
function confirmPieceChoice(){
  var sel    = document.getElementById('piece-choice').value;
  var qualif = (document.getElementById('piece-qualif').value || '').trim();
  var etage  = document.getElementById('piece-etage').value;
  if(!sel) return;

  var base = sel;
  if(sel==='__NEW__'){
    base = (prompt('Nom de la piÃ¨ce :','') || '').trim();
    if(!base) return;
  }
  var etageVal = (etage && etage!=='(aucun)') ? etage : '';
  var key = createOrGetPiece(base, qualif, etageVal);
  goPiece(key);
}
function removePiece(key){
  if(confirm('Supprimer la piÃ¨ce Â« '+pieceDisplayLabel(key)+' Â» et toutes ses lignes ?')){
    delete devis[key];
    saveLocal();
    pageHome();
  }
}

// ---- DÃ©tail dâ€™une piÃ¨ce
function goPiece(key){
  ctx = { piece:key, category:null, intervention:null, pose:null, designation:null };
  ensureSection(key);

  var cats = CATEGORIES
    .filter(c=>c!=='SpÃ©cifique')
    .map(c=> b(c,'goCategory('+JSON.stringify(c)+')','btn'))
    .join('');

  var s = devis[key];
  var noteTxt = s.note ? '<em class="muted">Note : '+s.note+'</em>' : '<span class="muted">Aucune note</span>';

  var lignes = (s.items||[]).length
    ? '<ul>'+s.items.map(function(it,i){
        var total = (+it.prixU||0) * (+it.qty||0);
        var poseTxt = it.pose ? ' â€” '+String(it.pose).toLowerCase() : '';
        var unitTxt = it.unit || 'u';
        var left = it.intervention ? (it.intervention+' â€” ') : '';
        return '<li>'
          + left + it.designation + poseTxt
          +' ('+it.qty+' '+unitTxt+' Ã— '+euro(it.prixU)+' = '+euro(total)+') '
          +b('Ã—','delLine('+JSON.stringify(key)+','+i+')','btn')
        +'</li>';
      }).join('') + '</ul>'
    : '<p class="muted">Aucune ligne pour lâ€™instant.</p>';

  var label = pieceDisplayLabel(key);

  view(
    '<div class="card">'
      +b('Retour','pageHome()','btn back')
      +'<h2>'+label+'</h2>'
      +'<div class="row">'+cats+b('SpÃ©cifique','pageSpecifiqueForm()','btn ghost')+'</div>'
      +'<div class="row" style="margin-top:10px;">'
        +b('Ajouter / modifier la note','editPieceNote()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Lignes de la piÃ¨ce</h2>'
      +lignes
      +'<p style="margin-top:8px;">'+noteTxt+'</p>'
    +'</div>'
  );
}
function delLine(key, idx){
  (devis[key].items||[]).splice(idx,1);
  saveLocal();
  goPiece(key);
}

// ---- Choix catÃ©gorie â†’ intervention
function goCategory(cat){
  ctx.category = cat;
  if(cat==='Ã‰clairage') return goEclairageSub();

  var interventions = [];
  if(cat==='Prises' || cat==='Circuit spÃ©cialisÃ©'){
    interventions = [
      'CrÃ©ation',
      'Remplacement appareillage',
      'RecÃ¢blage avec remplacement appareillage',
      'RecÃ¢blage sans remplacement appareillage'
    ];
  }else if(cat==='SpÃ©cifique'){
    interventions = ['Saisie libre avec prix'];
  }else{
    interventions = ['CrÃ©ation'];
  }

  var btns = interventions.map(i=> b(i,'goIntervention('+JSON.stringify(i)+')','btn')).join('');

  view(
    '<div class="card">'
      +b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      +'<h2>'+ctx.category+' â€” '+pieceDisplayLabel(ctx.piece)+'</h2>'
      +'<div class="row">'+btns+'</div>'
    +'</div>'
  );
}

// Sous-menu Ã‰clairage
function goEclairageSub(){
  view(
    '<div class="card">'
      +b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      +'<h2>Ã‰clairage â€” '+pieceDisplayLabel(ctx.piece)+'</h2>'
      +'<div class="row">'
        +b('Luminaires','setEclairageBranch('+JSON.stringify('Ã‰clairage/Luminaires')+')','btn')
        +b('Commandes','setEclairageBranch('+JSON.stringify('Ã‰clairage/Commandes')+')','btn')
      +'</div>'
    +'</div>'
  );
}
function setEclairageBranch(branch){
  ctx.category = branch;
  var interventions = (branch==='Ã‰clairage/Luminaires')
    ? ['CrÃ©ation','Remplacement luminaire','RecÃ¢blage avec remplacement luminaire','RecÃ¢blage sans remplacement luminaire']
    : ['CrÃ©ation','Remplacement appareillage','RecÃ¢blage avec remplacement appareillage','RecÃ¢blage sans remplacement appareillage'];

  var btns = interventions.map(i=> b(i,'goIntervention('+JSON.stringify(i)+')','btn')).join('');

  view(
    '<div class="card">'
      +b('Retour','goEclairageSub()','btn back')
      +'<h2>'+branch+' â€” '+pieceDisplayLabel(ctx.piece)+'</h2>'
      +'<div class="row">'+btns+'</div>'
    +'</div>'
  );
}

// ---- Intervention â†’ page unique amÃ©liorÃ©e
function goIntervention(interv){
  ctx.intervention = interv;
  if(ctx.category==='SpÃ©cifique'){ return pageSpecifiqueForm(); }
  pageOneShotSelection();
}

// ======== Page "one-shot" (pose toujours visible, section cÃ¢ble pour Circuit spÃ©cialisÃ©) ========
function pageOneShotSelection(){
  var isElecStd = ['Prises','Circuit spÃ©cialisÃ©','Ã‰clairage/Luminaires','Ã‰clairage/Commandes'].indexOf(ctx.category) >= 0;

  var list = DESIGNATIONS_PAR_CATEGORIE[ctx.category] || ['Ã‰lÃ©ment'];
  var desigOpts = list.map(d=>'<option value="'+d+'">'+d+'</option>').join('');

  var customDesigBlock = (ctx.category==='Circuit spÃ©cialisÃ©')
    ? '<label style="margin-top:10px;">Nom personnalisÃ© (remplace la liste ci-dessus)</label>'
      +'<input id="oneshot-custom-desig" placeholder="ex : Pompe Ã  chaleur" />'
    : '';

  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var poseBlock = isElecStd ? ('<label>Type de pose</label><select id="oneshot-pose">'+poseOpts+'</select>') : '';

  var sectionBlock = '';
  if(ctx.category==='Circuit spÃ©cialisÃ©'){
    var sectOpts = SECTIONS_CABLE.map(s=>'<option value="'+s+'">'+s+'</option>').join('');
    sectionBlock =
      '<label style="margin-top:10px;">Section de cÃ¢blage</label>'
     +'<select id="oneshot-section">'+sectOpts+'</select>';
  }

  var qtyOpts   = Array.from({length:30}).map((_,i)=>{
    var q=i+1; return '<option value="'+q+'" '+(q===1?'selected':'')+'>'+q+'</option>';
  }).join('');

  var backFn = (ctx.category.indexOf('Ã‰clairage/')===0) ? 'goEclairageSub()' : 'goCategory('+JSON.stringify(ctx.category)+')';

  var defaultDesig = (DESIGNATIONS_PAR_CATEGORIE[ctx.category] && DESIGNATIONS_PAR_CATEGORIE[ctx.category][0]) || 'Ã‰lÃ©ment';
  var defaultPU = getPrix(defaultDesig, ctx.intervention) || 0;

  view(
    '<div class="card">'
      + b('Retour', backFn, 'btn back')
      + '<h2>'+ctx.category+' â€” '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<div class="pill" style="margin-bottom:10px;"><strong>Intervention :</strong>&nbsp;'+ctx.intervention+'</div>'
      + poseBlock
      + '<label style="margin-top:10px;">DÃ©signation</label>'
      + '<select id="oneshot-desig">'+desigOpts+'</select>'
      + customDesigBlock
      + sectionBlock
      + '<label style="margin-top:10px;">QuantitÃ©</label>'
      + '<select id="oneshot-qty">'+qtyOpts+'</select>'
      + '<div id="oneshot-preview" class="muted" style="margin-top:10px;">PU estimÃ© : '
          + euro(defaultPU)+' â€” Total : '+euro(defaultPU*1)
        +'</div>'
      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveOneShotItem(false)','btn primary')
        + b('Ajouter et rester','saveOneShotItem(true)','btn')
      + '</div>'
    + '</div>'
  );

  var $des  = document.getElementById('oneshot-desig');
  var $qty  = document.getElementById('oneshot-qty');
  var $prev = document.getElementById('oneshot-preview');

  function refreshPreview(){
    var designation = ($des && $des.value) || defaultDesig;
    var pu = getPrix(designation, ctx.intervention) || 0;
    var q  = parseInt(($qty && $qty.value) || '1', 10) || 1;
    $prev.innerHTML = 'PU estimÃ© : '+euro(pu)+' â€” Total : '+euro(pu*q);
  }
  if($des) $des.addEventListener('change', refreshPreview);
  if($qty) $qty.addEventListener('change', refreshPreview);
  refreshPreview();
}

function saveOneShotItem(stayHere){
  var $des  = document.getElementById('oneshot-desig');
  var $qty  = document.getElementById('oneshot-qty');
  var $pose = document.getElementById('oneshot-pose');
  var $custom = document.getElementById('oneshot-custom-desig');
  var $sect = document.getElementById('oneshot-section');

  var designation = ($custom && $custom.value.trim()) ? $custom.value.trim() : ($des ? ($des.value || 'Ã‰lÃ©ment') : 'Ã‰lÃ©ment');

  var sect = ($sect && $sect.value) ? $sect.value : '';
  if(sect === 'PersonnalisÃ©eâ€¦'){
    var s2 = (prompt('Section personnalisÃ©e :','')||'').trim();
    if(s2) sect = s2;
  }
  if(sect){ designation += ' â€” ' + sect; }

  var qty = parseInt($qty ? $qty.value : '1', 10) || 1;
  var pose = ($pose && $pose.value) ? $pose.value : '';

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category: ctx.category,
    intervention: ctx.intervention,
    pose: pose,
    designation: designation,
    qty: qty,
    prixU: getPrix(($des && $des.value) || designation, ctx.intervention) || 0,
    __tabKey: ctx.piece
  });
  saveLocal();

  if(stayHere){ pageOneShotSelection(); } else { goPiece(ctx.piece); }
}

/* ======== SpÃ©cifique : nouvelle page formulaire ======== */
function pageSpecifiqueForm(){
  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var sectOpts  = SECTIONS_CABLE.map(s=>'<option value="'+s+'">'+s+'</option>').join('');

  view(
    '<div class="card">'
      + b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      + '<h2>SpÃ©cifique â€” '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<label>Nom du circuit spÃ©cifique</label>'
      + '<input id="sp-label" placeholder="ex : Bandeau LED, Pompe piscineâ€¦" />'

      + '<label style="margin-top:10px;">Type de pose</label>'
      + '<select id="sp-pose">'+poseOpts+'</select>'

      + '<label style="margin-top:10px;">Section de cÃ¢blage</label>'
      + '<select id="sp-section">'+sectOpts+'</select>'

      + '<label style="margin-top:10px;">Prix unitaire (â‚¬)</label>'
      + '<input id="sp-price" type="number" inputmode="decimal" placeholder="0" />'

      + '<label style="margin-top:10px;">QuantitÃ©</label>'
      + '<input id="sp-qty" type="number" inputmode="numeric" min="1" value="1" />'

      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveSpecifique(false)','btn primary')
        + b('Ajouter et rester','saveSpecifique(true)','btn')
      + '</div>'
    + '</div>'
  );
}
function saveSpecifique(stayHere){
  var label = (document.getElementById('sp-label').value||'').trim();
  if(!label){ alert('Nom requis.'); return; }

  var pose  = document.getElementById('sp-pose').value || '';
  var sect  = document.getElementById('sp-section').value || '';
  if(sect==='PersonnalisÃ©eâ€¦'){
    var s2 = (prompt('Section personnalisÃ©e :','')||'').trim();
    if(s2) sect = s2; else sect = '';
  }
  if(sect){ label += ' â€” ' + sect; }

  var prix  = parseFloat(document.getElementById('sp-price').value)||0;
  var qty   = Math.max(1, parseInt(document.getElementById('sp-qty').value,10) || 1);

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category:'SpÃ©cifique',
    intervention:'',
    pose:pose,
    designation:label,
    qty:qty,
    prixU:prix,
    __tabKey: ctx.piece
  });
  saveLocal();

  if(stayHere){ pageSpecifiqueForm(); } else { goPiece(ctx.piece); }
}

function editPieceNote(){
  ensureSection(ctx.piece);
  var cur = devis[ctx.piece].note || '';
  var n = prompt('Note pour '+pieceDisplayLabel(ctx.piece), cur);
  if(n!==null) devis[ctx.piece].note = n.trim();
  saveLocal();
  goPiece(ctx.piece);
}
</script>

<!-- =============================
     CHAPITRE 6 : TABLEAU Ã‰LECTRIQUE
     (multi-tableaux â€” ID avant DJ, calibre perso, dÃ©tails persistants)
     ============================= -->
<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§0 â€¢ Ã‰TAT LOCAL + SÃ‰CURITÃ‰S TARIFS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let tabState = {
  // QuantitÃ©s + dÃ©tails des disjoncteurs fixes
  disj: {
    2:  { qty:0, details:[] },
    10: { qty:0, details:[] },
    16: { qty:0, details:[] },
    20: { qty:0, details:[] },
    32: { qty:0, details:[] },
    40: { qty:0, details:[] } // dÃ©jÃ  demandÃ© (45â‚¬ par dÃ©faut)
  },
  // Calibre personnalisÃ© (un bloc dÃ©diÃ©)
  disjCustom: { label:'', price:0, qty:0, details:[] },

  // Interrupteurs diffÃ©rentiels par modÃ¨le (ex: "40A-A")
  ids: { /* '40A-A': { qty:0, details:[] } */ }
};

// SÃ©cu tarifs tableau (au cas oÃ¹)
(function(){
  if(!window.TARIFS_TABLEAU) window.TARIFS_TABLEAU = {};
  if(!TARIFS_TABLEAU.disjoncteurs) TARIFS_TABLEAU.disjoncteurs = {2:32,10:25,16:25,20:25,32:32,40:45};
  if(!TARIFS_TABLEAU.inter_diff) TARIFS_TABLEAU.inter_diff = {
    '40A-AC':60,'40A-A':80,'63A-AC':100,'63A-A':120
  };
})();

function ensureTableKey(key){
  if(!devis[key]) devis[key] = { __base:"Tableau", items:[], note:"", __customName:"" };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§1 â€¢ CRÃ‰ER UN NOUVEAU TABLEAU (numÃ©rotÃ© par ordre de crÃ©ation)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pageTabCreate(){
  if(typeof devis.__tabCounter !== 'number') devis.__tabCounter = 0;
  devis.__tabCounter += 1; saveLocal();

  const key = "Tableau " + devis.__tabCounter;
  ensureTableKey(key);

  view(
    '<div class="card">'
      + b("Retour",'pageHome()',"btn back")
      + '<h2>Nouveau tableau</h2>'
      + '<p>Identifiant : <strong>'+key+'</strong></p>'
      + '<label>Nom personnalisÃ© (optionnel)</label>'
      + '<input id="tab-custom" placeholder="ex : Principal RDC" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Valider",'saveTabCustomName('+JSON.stringify(key)+')',"btn primary")
      + '</div>'
    + '</div>'
  );
}
function saveTabCustomName(key){
  ensureTableKey(key);
  const name = (document.getElementById('tab-custom').value||'').trim();
  devis[key].__customName = name; saveLocal();
  pageTabHome(key);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§2 â€¢ ACCUEIL Dâ€™UN TABLEAU (ordre : ID puis Disjoncteurs)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pageTabHome(key){
  if(!key || !devis[key]) return pageHome();
  const custom = devis[key].__customName ? ' â€” '+devis[key].__customName : '';
  view(
    '<div class="card">'
      + b("Retour",'pageHome()',"btn back")
      + '<h2>'+key+custom+'</h2>'
      + '<div class="row" style="margin-top:10px;">'
        + b("1 Â· Interrupteurs diffÃ©rentiels",'pageTab_ID('+JSON.stringify(key)+')',"btn primary")
        + b("2 Â· Disjoncteurs modulaires",'pageTab_Disjoncteurs('+JSON.stringify(key)+')',"btn")
        + b("3 Â· Pose tableau",'pageTabPose('+JSON.stringify(key)+')',"btn")
        + b("4 Â· Commandes / pilotage",'pageTabMod_Commandes('+JSON.stringify(key)+')',"btn")
        + b("5 Â· SpÃ©cifique (libre + prix)",'pageTabMod_Specifique('+JSON.stringify(key)+')',"btn ghost")
      + '</div>'
      + '<p class="muted" style="margin-top:8px;">Les Ã©lÃ©ments ajoutÃ©s ici sont rangÃ©s dans Â« '+key+' Â» uniquement.</p>'
    + '</div>'
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§3 â€¢ POSE DU TABLEAU
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pageTabPose(key){
  ensureTableKey(key);
  const o = (arr)=>arr.map(v=>'<option value="'+v+'">'+v+'</option>').join('');
  view(
    '<div class="card">'
      + b("Retour",'pageTabHome('+JSON.stringify(key)+')',"btn back")
      + '<h2>Pose du tableau</h2>'
      + '<label>Nombre de rangÃ©es</label><select id="tab-rang">'+o([1,2,3,4])+'</select>'
      + '<label>Modules</label><select id="tab-mod">'+o([13,18,24])+'</select>'
      + '<label>Pose</label><select id="tab-pose">'+o(['Saillie','EncastrÃ©'])+'</select>'
      + '<label>Intervention</label><select id="tab-inv">'+o(['CrÃ©ation',"Avec dÃ©pose de lâ€™existant"])+'</select>'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter Ã  "+key,'addTabPose('+JSON.stringify(key)+')',"btn primary")
      + '</div>'
    + '</div>'
  );
}
function addTabPose(key){
  ensureTableKey(key);
  const rang    = +document.getElementById('tab-rang').value;
  const modules = +document.getElementById('tab-mod').value;
  const pose    = document.getElementById('tab-pose').value;
  const inv     = document.getElementById('tab-inv').value;
  const pu      = (typeof getTabPrice==='function') ? (getTabPrice(rang,modules,pose,inv)||0) : 0;

  devis[key].items.push({
    category:"Tableau & distribution",
    intervention:inv, pose:pose,
    designation:`Pose tableau â€” ${rang} rangÃ©e(s), ${modules} modules`,
    qty:1, prixU:pu, __tabKey:key
  });
  saveLocal(); pageTabHome(key);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§4 â€¢ INTERRUPTEURS DIFFÃ‰RENTIELS (comme les disjoncteurs)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pageTab_ID(key){
  ensureTableKey(key);
  const models = Object.keys(TARIFS_TABLEAU.inter_diff||{});
  // Ã©tat par modÃ¨le
  models.forEach(m=>{ if(!tabState.ids[m]) tabState.ids[m]={qty:0,details:[]}; });

  const optsQty = (max=20)=>Array.from({length:max+1},(_,i)=>`<option value="${i}">${i}</option>`).join('');
  const rows = models.map(m=>{
    const id = 'idq-'+m.replace(/[^a-z0-9]/ig,'_');
    return `
      <label>
        ${m} â€” PU ${euro(TARIFS_TABLEAU.inter_diff[m]||0)}
        <select id="${id}" onchange="(function(v){ tabState.ids[${JSON.stringify(m)}].qty=+v; }) (this.value)">
          ${optsQty(20)}
        </select>
        ${b("DÃ©tail circuits",'pageTab_IDDetails('+JSON.stringify(key)+','+JSON.stringify(m)+')')}
      </label>`;
  }).join('');

  view(
    '<div class="card">'
      + b("Retour",'pageTabHome('+JSON.stringify(key)+')',"btn back")
      + '<h2>Interrupteurs diffÃ©rentiels</h2>'
      + '<div class="list">'+rows+'</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter Ã  "+key,'pageTab_IDValider('+JSON.stringify(key)+')',"btn primary")
      + '</div>'
      + '<p class="muted" style="margin-top:6px;">Astuce : le dÃ©tail est facultatif ; les quantitÃ©s restent mÃ©morisÃ©es.</p>'
    + '</div>'
  );

  // Restaure visuellement les quantitÃ©s mÃ©morisÃ©es
  models.forEach(m=>{
    const id = 'idq-'+m.replace(/[^a-z0-9]/ig,'_');
    const el = document.getElementById(id);
    if(el) el.value = tabState.ids[m].qty || 0;
  });
}

function pageTab_IDDetails(key, model){
  const state = tabState.ids[model] || {qty:0, details:[]};
  const qty = state.qty || 0;

  const row = (i, d={})=>{
    const t = d.type||'', n = d.note||'';
    return `
      <div class="pill" style="width:100%;">
        <select data-idx="${i}" class="id-type">
          <option value="">(non dÃ©fini)</option>
          <option value="Circuits en aval" ${t==='Circuits en aval'?'selected':''}>Circuits en aval</option>
          <option value="Chauffe-eau" ${t==='Chauffe-eau'?'selected':''}>Chauffe-eau</option>
          <option value="Cuisine" ${t==='Cuisine'?'selected':''}>Cuisine</option>
          <option value="Autre" ${t==='Autre'?'selected':''}>Autre</option>
        </select>
        <input class="id-note" data-idx="${i}" placeholder="Note (facultatif)" value="${n.replace(/"/g,'&quot;')}" />
      </div>`;
  };

  let out = '';
  for(let i=0;i<qty;i++) out += row(i, state.details[i]||{});

  view(
    '<div class="card">'
      + b("Retour",'pageTab_ID('+JSON.stringify(key)+')',"btn back")
      + '<h2>DÃ©tails â€” '+model+'</h2>'
      + (qty>0 ? '<div id="id-detail">'+out+'</div>' : '<p class="muted">DÃ©finis dâ€™abord une quantitÃ© sur la page prÃ©cÃ©dente.</p>')
      + '<div class="row" style="margin-top:12px;">'
        + b("Enregistrer",'pageTab_IDSaveDetails('+JSON.stringify(key)+','+JSON.stringify(model)+')',"btn primary")
      + '</div>'
    + '</div>'
  );
}
function pageTab_IDSaveDetails(key, model){
  const state = tabState.ids[model] || {qty:0, details:[]};
  const types = Array.from(document.querySelectorAll('.id-type'));
  const notes = Array.from(document.querySelectorAll('.id-note'));
  const details = [];
  for(let i=0;i<types.length;i++){
    details.push({ type: types[i]?.value||'', note: notes[i]?.value||'' });
  }
  state.details = details; tabState.ids[model] = state;
  saveLocal(); pageTab_ID(key);
}

function pageTab_IDValider(key){
  ensureTableKey(key);
  const PU = TARIFS_TABLEAU.inter_diff || {};
  Object.keys(tabState.ids).forEach(model=>{
    const { qty, details } = tabState.ids[model] || {};
    if(qty>0){
      const txt = (details && details.some(d=>d && (d.type||d.note)))
        ? ' â€” circuits : ' + details.map((d,i)=> (d.type||'Circuit '+(i+1)) + (d.note?(' ('+d.note+')'):'')).join(', ')
        : '';
      devis[key].items.push({
        category:"Tableau/Modulaire",
        designation:'ID 30mA â€” '+model.replace('-',' - ')+txt,
        qty:qty, prixU:PU[model]||0, __tabKey:key
      });
    }
  });
  saveLocal(); pageTabHome(key);
}

// Compat : ancienne fonction
function submitTab_ID(key){ pageTab_IDValider(key); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§5 â€¢ DISJONCTEURS MODULAIRES (calibre perso + dÃ©tails persistants)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pageTab_Disjoncteurs(key){
  ensureTableKey(key);
  const optsQty = (max=30)=>Array.from({length:max+1},(_,i)=>`<option value="${i}">${i}</option>`).join('');

  // RangÃ©es standard
  const stdRow = (rating)=>`
    <label>
      ${rating} A â€” PU ${euro((TARIFS_TABLEAU.disjoncteurs||{})[rating]||0)}
      <select id="djq-${rating}" onchange="(function(v){ tabState.disj[${rating}].qty=+v; }) (this.value)">
        ${optsQty(30)}
      </select>
      ${b("DÃ©tail circuits",'pageTab_DisjDetails('+JSON.stringify(key)+','+rating+')')}
    </label>`;

  // Bloc calibre personnalisÃ©
  const custom = tabState.disjCustom || {label:'',price:0,qty:0,details:[]};
  const customBlock = `
    <div class="card" style="margin-top:10px;">
      <h3 style="margin:0 0 6px;">Calibre personnalisÃ©</h3>
      <label>LibellÃ© (ex : 45 A)</label>
      <input id="djx-label" placeholder="ex : 45 A" value="${(custom.label||'').replace(/"/g,'&quot;')}" />
      <label style="margin-top:6px;">Prix unitaire (â‚¬)</label>
      <input id="djx-price" type="number" inputmode="decimal" value="${custom.price||0}" />
      <label style="margin-top:6px;">QuantitÃ©</label>
      <input id="djx-qty" type="number" inputmode="numeric" min="0" value="${custom.qty||0}" />
      <div class="row" style="margin-top:6px;">
        ${b("DÃ©tail circuits","pageTab_DisjDetailsCustom("+JSON.stringify(key)+")")}
      </div>
    </div>
  `;

  view(
    '<div class="card">'
      + b("Retour",'pageTabHome('+JSON.stringify(key)+')',"btn back")
      + '<h2>Disjoncteurs modulaires</h2>'
      + '<div class="list">'
        + stdRow(2) + stdRow(10) + stdRow(16) + stdRow(20) + stdRow(32) + stdRow(40)
      + '</div>'
      + customBlock
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter Ã  "+key,'pageTab_DisjValider('+JSON.stringify(key)+')',"btn primary")
      + '</div>'
      + '<p class="muted" style="margin-top:6px;">Les quantitÃ©s restent mÃ©morisÃ©es ; le dÃ©tail est facultatif.</p>'
    + '</div>'
  );

  // Restaure quantitÃ©s standard
  [2,10,16,20,32,40].forEach(r=>{
    const el = document.getElementById('djq-'+r);
    if(el) el.value = tabState.disj[r].qty || 0;
  });
}

function pageTab_DisjDetails(key, rating){
  const state = tabState.disj[rating] || {qty:0, details:[]};
  const qty = state.qty || 0;

  const row = (i, d={})=>{
    const t = d.type||'', n = d.note||'';
    return `
      <div class="pill" style="width:100%;">
        <select data-idx="${i}" class="dj-type">
          <option value="">(non dÃ©fini)</option>
          <option value="Circuit prise" ${t==='Circuit prise'?'selected':''}>Circuit prise</option>
          <option value="Circuit Ã©clairage" ${t==='Circuit Ã©clairage'?'selected':''}>Circuit Ã©clairage</option>
          <optgroup label="Circuits spÃ©cialisÃ©s">
            <option value="Four" ${t==='Four'?'selected':''}>Four</option>
            <option value="Plaque de cuisson" ${t==='Plaque de cuisson'?'selected':''}>Plaque de cuisson</option>
            <option value="Lave-linge" ${t==='Lave-linge'?'selected':''}>Lave-linge</option>
            <option value="Lave-vaisselle" ${t==='Lave-vaisselle'?'selected':''}>Lave-vaisselle</option>
            <option value="SÃ¨che-linge" ${t==='SÃ¨che-linge'?'selected':''}>SÃ¨che-linge</option>
            <option value="Cumulus" ${t==='Cumulus'?'selected':''}>Cumulus</option>
            <option value="VMC" ${t==='VMC'?'selected':''}>VMC</option>
            <option value="Chauffage" ${t==='Chauffage'?'selected':''}>Chauffage</option>
            <option value="Climatisation" ${t==='Climatisation'?'selected':''}>Climatisation</option>
            <option value="Prise extÃ©rieure Ã©tanche" ${t==='Prise extÃ©rieure Ã©tanche'?'selected':''}>Prise extÃ©rieure Ã©tanche</option>
            <option value="__custom__">Nom personnalisÃ©â€¦</option>
          </optgroup>
        </select>
        <input class="dj-note" data-idx="${i}" placeholder="CaractÃ©ristique / nom (facultatif)" value="${(n||'').replace(/"/g,'&quot;')}" />
      </div>`;
  };

  let out = '';
  for(let i=0;i<qty;i++) out += row(i, state.details[i]||{});

  view(
    '<div class="card">'
      + b("Retour",'pageTab_Disjoncteurs('+JSON.stringify(key)+')',"btn back")
      + '<h2>DÃ©tail circuits â€” '+rating+' A</h2>'
      + (qty>0 ? ('<div id="dj-detail">'+out+'</div>') : '<p class="muted">DÃ©finis dâ€™abord une quantitÃ© sur la page prÃ©cÃ©dente.</p>')
      + '<div class="row" style="margin-top:12px;">'
        + b("Enregistrer",'pageTab_DisjSaveDetails('+JSON.stringify(key)+','+rating+')',"btn primary")
      + '</div>'
    + '</div>'
  );
}
function pageTab_DisjSaveDetails(key, rating){
  const types = Array.from(document.querySelectorAll('.dj-type'));
  const notes = Array.from(document.querySelectorAll('.dj-note'));
  const details = [];
  for(let i=0;i<types.length;i++){
    let t = types[i]?.value || '';
    if(t==='__custom__') t = prompt('Nom personnalisÃ© du circuit :','') || ('Circuit '+(i+1));
    details.push({ type:t, note:notes[i]?.value||'' });
  }
  if(!tabState.disj[rating]) tabState.disj[rating] = {qty:types.length,details:[]};
  tabState.disj[rating].details = details;
  saveLocal(); pageTab_Disjoncteurs(key);
}

/* â€” Calibre personnalisÃ© : dÃ©tails â€” */
function pageTab_DisjDetailsCustom(key){
  const st = tabState.disjCustom || {label:'',price:0,qty:0,details:[]};
  const qty = +document.getElementById('djx-qty').value || 0;
  // on mÃ©morise avant dâ€™ouvrir
  tabState.disjCustom = {
    label: (document.getElementById('djx-label').value||'').trim(),
    price: parseFloat(document.getElementById('djx-price').value)||0,
    qty: qty,
    details: st.details || []
  };

  const row = (i, d={})=>{
    const t = d.type||'', n = d.note||'';
    return `
      <div class="pill" style="width:100%;">
        <input class="djx-type" data-idx="${i}" placeholder="Nom du circuit (ex: Atelier)" value="${(t||'').replace(/"/g,'&quot;')}" />
        <input class="djx-note" data-idx="${i}" placeholder="Note (facultatif)" value="${(n||'').replace(/"/g,'&quot;')}" />
      </div>`;
  };

  let out = '';
  for(let i=0;i<qty;i++) out += row(i, (tabState.disjCustom.details||[])[i]||{});

  view(
    '<div class="card">'
      + b("Retour",'pageTab_Disjoncteurs('+JSON.stringify(key)+')',"btn back")
      + '<h2>DÃ©tail circuits â€” Calibre personnalisÃ©</h2>'
      + (qty>0 ? ('<div>'+out+'</div>') : '<p class="muted">DÃ©finis dâ€™abord une quantitÃ© sur la page prÃ©cÃ©dente.</p>')
      + '<div class="row" style="margin-top:12px;">'
        + b("Enregistrer",'pageTab_DisjSaveDetailsCustom('+JSON.stringify(key)+')',"btn primary")
      + '</div>'
    + '</div>'
  );
}
function pageTab_DisjSaveDetailsCustom(key){
  const qty = tabState.disjCustom.qty || 0;
  const types = Array.from(document.querySelectorAll('.djx-type'));
  const notes = Array.from(document.querySelectorAll('.djx-note'));
  const details = [];
  for(let i=0;i<qty;i++){
    details.push({ type: types[i]?.value||('Circuit '+(i+1)), note: notes[i]?.value||'' });
  }
  tabState.disjCustom.details = details;
  saveLocal(); pageTab_Disjoncteurs(key);
}

function pageTab_DisjValider(key){
  ensureTableKey(key);
  const PU = TARIFS_TABLEAU.disjoncteurs || {};

  // 1) calibres standards
  [2,10,16,20,32,40].forEach(rating=>{
    const st = tabState.disj[rating];
    if(st && st.qty>0){
      const detailText = (st.details && st.details.some(d=>d && (d.type||d.note)))
        ? ' â€” circuits : ' + st.details.map((d,i)=> (d.type||'Circuit '+(i+1)) + (d.note?(' ('+d.note+')'):'')).join(', ')
        : '';
      devis[key].items.push({
        category:"Tableau/Modulaire",
        designation:`Disjoncteur ${rating} A${detailText}`,
        qty:st.qty, prixU:PU[rating]||0, __tabKey:key
      });
    }
  });

  // 2) calibre personnalisÃ© (si renseignÃ©)
  const cx = tabState.disjCustom || {};
  if((cx.qty||0)>0 && (cx.label||'').trim()){
    const txt = (cx.details && cx.details.some(d=>d && (d.type||d.note)))
      ? ' â€” circuits : ' + cx.details.map((d,i)=> (d.type||'Circuit '+(i+1)) + (d.note?(' ('+d.note+')'):'')).join(', ')
      : '';
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation: `Disjoncteur ${cx.label.trim()}${txt}`,
      qty: cx.qty, prixU: +cx.price||0, __tabKey:key
    });
  }

  saveLocal(); pageTabHome(key);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§6 â€¢ COMMANDES & PILOTAGE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pageTabMod_Commandes(key){
  ensureTableKey(key);
  const models = Object.keys(TARIFS_TABLEAU.commandes||{});
  const opts = models.map(m=>'<option value="'+m+'">'+m+' ('+euro(TARIFS_TABLEAU.commandes[m]) +')</option>').join('');
  view(
    '<div class="card">'
      + b("Retour",'pageTabHome('+JSON.stringify(key)+')',"btn back")
      + '<h2>Commande & pilotage</h2>'
      + '<label>ModÃ¨le</label><select id="cmd-model">'+opts+'</select>'
      + '<label>QuantitÃ©</label><input id="cmd-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter Ã  "+key,'submitTabMod_Commandes('+JSON.stringify(key)+')',"btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Commandes(key){
  const model = document.getElementById('cmd-model').value;
  const qty   = Math.max(1, parseInt(document.getElementById('cmd-qty').value,10) || 1);
  const pu    = (TARIFS_TABLEAU.commandes||{})[model] || 0;
  devis[key].items.push({
    category:"Tableau/Commandes",
    designation:model, qty:qty, prixU:pu, __tabKey:key
  });
  saveLocal(); pageTabHome(key);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Â§7 â€¢ SPÃ‰CIFIQUE (libre + prix â€” clavier numÃ©rique)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pageTabMod_Specifique(key){
  ensureTableKey(key);
  view(
    '<div class="card">'
      + b("Retour",'pageTabHome('+JSON.stringify(key)+')',"btn back")
      + '<h2>Ã‰lÃ©ment spÃ©cifique</h2>'
      + '<label>IntitulÃ©</label><input id="spec-label" />'
      + '<label>Prix unitaire (â‚¬)</label><input id="spec-price" type="number" inputmode="decimal" />'
      + '<label>QuantitÃ©</label><input id="spec-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter Ã  "+key,'submitTabMod_Specifique('+JSON.stringify(key)+')',"btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Specifique(key){
  const label = (document.getElementById('spec-label').value||'').trim();
  const prix  = parseFloat(document.getElementById('spec-price').value)||0;
  const qty   = Math.max(1, parseInt(document.getElementById('spec-qty').value,10)||1);
  if(!label){ pageTabHome(key); return; }
  devis[key].items.push({
    category:"Tableau/SpÃ©cifique",
    designation:label, qty:qty, prixU:prix, __tabKey:key
  });
  saveLocal(); pageTabHome(key);
}
</script>
<!-- =============================
     CHAPITRE 7 : ESTIMATIF & EXPORTS
     (tri: ID avant Disjoncteurs dans chaque Tableau)
     ============================= -->
<script>
/* Â§0 â€¢ GROUPES & HELPERS COMMUNS */
window.PIECE_GROUPS = window.PIECE_GROUPS || {
  "Buanderie":"PiÃ¨ces techniques","Garage":"PiÃ¨ces techniques","Atelier":"PiÃ¨ces techniques",
  "Jardin":"ExtÃ©rieur","Terrasse":"ExtÃ©rieur","Balcon":"ExtÃ©rieur","Abri de jardin":"ExtÃ©rieur",
  "Cuisine":"Cuisine",
  "Salon":"PiÃ¨ces de vie","Salle Ã  manger":"PiÃ¨ces de vie","Couloir":"PiÃ¨ces de vie","EntrÃ©e":"PiÃ¨ces de vie",
  "Salle de bain":"PiÃ¨ces d'eau","Salle d'eau":"PiÃ¨ces d'eau","Toilettes":"PiÃ¨ces d'eau",
  "Chambre 1":"Chambres & Bureau","Chambre 2":"Chambres & Bureau","Chambre 3":"Chambres & Bureau",
  "Bureau":"Chambres & Bureau","BibliothÃ¨que":"Chambres & Bureau",
  "Tableau":"Tableau & distribution","Distribution":"Tableau & distribution",
  "Mise Ã  la terre":"Mise Ã  la terre","VMC":"VMC"
};
function groupDevis(){
  var g = {};
  for (var key in devis){
    if (key.indexOf("__") === 0) continue;
    var s = devis[key];
    var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" â€” ")[0];
    var grp  = window.PIECE_GROUPS[base] || "Divers";
    if (!g[grp]) g[grp] = {};
    g[grp][key] = s;
  }
  return g;
}
function pieceDisplayLabel(key){
  var s = devis[key] || {};
  var label = formatPieceLabel(key);
  var isTab = ((s.__base||'').toLowerCase()==='tableau') || /^Tableau\s/i.test(key);
  if(isTab && s.__customName && s.__customName.trim()){
    label += ' â€” ' + s.__customName.trim();
  }
  return label;
}
function itemLine(it){
  var unit = it.unit || "u";
  var poseTxt = (it.intervention === "CrÃ©ation" && it.pose) ? (" - " + String(it.pose).toLowerCase()) : "";
  var left = it.intervention ? (it.intervention + " â€” ") : "";
  var pu = (+it.prixU || 0).toFixed(2);
  var q  = +it.qty || 0;
  var total = (q * (+it.prixU || 0)).toFixed(2);
  return "- " + left + it.designation + poseTxt + " | QtÃ©: " + q + " " + unit + " | PU: " + pu + "â‚¬ | Total: " + total + "â‚¬";
}
function pieceSeparator(label){
  return "\n---------------- " + label + " ----------------\n";
}

/* Â§1 â€¢ TRI SPÃ‰CIFIQUE POUR LES â€œTABLEAU N â€¦â€ */
function isTableauKey(key){
  var s = devis[key] || {};
  return ((s.__base||'').toLowerCase()==='tableau') || /^Tableau\s/i.test(key);
}
function sortedItemsForPiece(key, items){
  if(!isTableauKey(key)) return items.slice();
  function score(it){
    var d = (it.designation||'').trim();
    if(/^ID\s/i.test(d)) return 0;          // Interrupteurs diffÃ©rentiels dâ€™abord
    if(/^Disjoncteur\s/i.test(d)) return 1; // puis Disjoncteurs
    return 2;                               // puis le reste
  }
  return items
    .map(function(it, i){ return {it:it, i:i, s:score(it)}; })
    .sort(function(a,b){ return (a.s - b.s) || (a.i - b.i); })
    .map(function(x){ return x.it; });
}

/* Â§2 â€¢ PAGE : ESTIMATIF DÃ‰TAILLÃ‰ */
function pageEstimatif(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Estimatif dÃ©taillÃ©</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    html += '<h2 style="border-top:2px solid #000; padding-top:8px;">'+grp+'</h2>';
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var pieceLabel = pieceDisplayLabel(key);
      var sectionTotal = 0;
      var items = sortedItemsForPiece(key, s.items);

      html += '<h3 style="margin-top:6px; border-top:1px solid #ccc; padding-top:4px;">'+pieceLabel+'</h3><ul>';
      items.forEach(function(it){
        var q  = +it.qty || 0;
        var pu = +it.prixU || 0;
        var t  = q * pu;
        sectionTotal += t; groupTotal += t; totalGlobal += t;

        var poseTxt = (it.intervention==="CrÃ©ation" && it.pose) ? (" " + String(it.pose).toLowerCase()) : "";
        var unit    = it.unit || "u";
        var left    = it.intervention ? (it.intervention+" â€” ") : "";
        html += '<li>' + left + it.designation + poseTxt + ' ('+q+' '+unit+' Ã— '+euro(pu)+' = '+euro(t)+')</li>';
      });
      if (s.note) html += '<li><em>Note : '+s.note+'</em></li>';

      html += '</ul><p><strong>Total '+pieceLabel+' : '+euro(sectionTotal)+'</strong></p>';
    }

    html += '<p><strong>Total '+grp+' : '+euro(groupTotal)+'</strong></p><hr>';
  }

  html += '<h3>Total global : '+euro(totalGlobal)+'</h3>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

/* Â§3 â€¢ PAGE : TOTAUX PAR GROUPE */
function pageTotaux(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Totaux par groupe</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    var gt = 0;
    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;
      var st = s.items.reduce(function(sum,it){ return sum + (((+it.prixU)||0)*((+it.qty)||0)); }, 0);
      gt += st; totalGlobal += st;
    }
    html += '<p><strong>'+grp+'</strong> : '+euro(gt)+'</p>';
  }

  html += '<hr><p><strong>Total global : '+euro(totalGlobal)+'</strong></p>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

/* Â§4 â€¢ EXPORT .TXT PAR GROUPE */
function exportText(){
  var grouped = groupDevis();
  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var st = 0;
      lines.push(pieceSeparator(label));

      var items = sortedItemsForPiece(key, s.items);

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'â‚¬\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'â‚¬');

    var blob = new Blob([lines.join('\r\n')], {type:'text/plain;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = 'devis_'+grp+'.txt'; a.click();
    URL.revokeObjectURL(url);
  }
  alert('âœ… Export terminÃ© : un fichier .txt par groupe gÃ©nÃ©rÃ©.');
}

/* Â§5 â€¢ EXPORT .ZIP PAR GROUPE */
async function exportZipGroups(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non chargÃ©.'); return; }

  var grouped = groupDevis();
  var zip = new JSZip();
  var global = 0;

  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var st = 0;
      lines.push(pieceSeparator(label));

      var items = sortedItemsForPiece(key, s.items);

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'â‚¬\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'â‚¬');
    global += groupTotal;

    zip.file('devis_'+grp+'.txt', lines.join('\r\n'));
  }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var readme = 'RÃ©capitulatif â€” '+name+'\nDate: '+new Date().toLocaleString()
             + '\n\nTotal global: '+global.toFixed(2)+'â‚¬\n';
  zip.file('README.txt', readme);

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_groupes.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('âœ… Export ZIP (par groupe) gÃ©nÃ©rÃ©.');
}

/* Â§6 â€¢ EXPORT COMPLET (TXT & ZIP) */
function buildFullText(){
  var grouped = groupDevis();
  var lines = ['=== DEVIS COMPLET ===\n'];
  var globalTotal = 0;

  for (var grp in grouped){
    lines.push('\n## '+grp+' ##\n');
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var st = 0;
      lines.push(pieceSeparator(label));

      var items = sortedItemsForPiece(key, s.items);

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t; globalTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'â‚¬\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'â‚¬\n');
  }

  lines.push('\n=== Total global : '+globalTotal.toFixed(2)+'â‚¬ ===\n');
  return lines.join('\r\n');
}
function exportTextFull(){
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildFullText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('âœ… Export .txt complet gÃ©nÃ©rÃ©.');
}
async function exportZipFull(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non chargÃ©.'); return; }
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var zip  = new JSZip();
  zip.file(name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt', buildFullText());
  zip.file('README.txt', 'Devis complet\nNom: '+name+'\nDate: '+new Date().toLocaleString()+'\n');
  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.zip';
  a.click(); URL.revokeObjectURL(url);
  alert('âœ… Export .zip complet gÃ©nÃ©rÃ©.');
}
</script>
<!-- =============================
     CHAPITRE 8 : DÃ‰MARRAGE & EXPOSE
     ============================= -->
<script>
function init(){
  try{
    loadLocal();
    pageMain();
  }catch(err){
    var el = document.getElementById('app');
    if(el){
      el.innerHTML =
        '<div class="card"><h2>Erreur init()</h2><pre>'
        + ((err && err.stack) || String(err))
        + '</pre></div>';
    }
  }
}

/* Expose â€” fonctions rÃ©ellement utilisÃ©es dans lâ€™UI */
Object.assign(window, {
  // Chap.4 â€” Menu & sauvegarde
  pageMain,
  actionNouveauDevis,
  pageSavedDevis,
  loadDevis,
  deleteDevis,
  saveCurrentDevis,

  // Chap.5 â€” PiÃ¨ces (flux one-page)
  pageHome,
  pageAddPiece,
  confirmPieceChoice,
  removePiece,
  goPiece,
  delLine,
  editPieceNote,
  pageSpecifiqueForm,
  saveSpecifique,
  pagePieceSpecifique: pageSpecifiqueForm, // alias
  goCategory,
  goEclairageSub,
  setEclairageBranch,
  goIntervention,
  pageOneShotSelection,
  saveOneShotItem,

  // Chap.6 â€” Tableaux (multi-tableaux)
  pageTabCreate,
  saveTabCustomName,
  pageTabHome,
  pageTabPose,
  addTabPose,
  pageTab_ID,
  submitTab_ID,
  pageTab_Disjoncteurs,
  pageTab_DisjDetails,
  pageTab_DisjSaveDetails,
  pageTab_DisjValider,
  pageTabMod_Commandes,
  submitTabMod_Commandes,
  pageTabMod_Specifique,
  submitTabMod_Specifique,

  // Chap.7 â€” Estimatif & exports
  pageEstimatif,
  pageTotaux,
  exportText,
  exportZipGroups,
  exportTextFull,
  exportZipFull,

  // Navigation commune
  confirmBackHome
});

// Lancement
init();
</script>
</body>
</html>
