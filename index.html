<!-- =====================================================
     CHAPITRE 1 : SOCLE UI & HELPERS
     Sommaire :
       1.0 ‚Ä¢ Styles de base + conteneur
       1.1 ‚Ä¢ Boutons & rendu (b, view)
       1.2 ‚Ä¢ Aides ‚Ç¨ / arrondi / formats
       1.3 ‚Ä¢ √âtat courant du devis (ensure)
       1.4 ‚Ä¢ Persistance locale (load/save)
       1.5 ‚Ä¢ Outils g√©n√©riques (download, uid)
     ===================================================== -->

<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280; --bg:#f7f7fb;
  }
  html,body{ margin:0; padding:0; background:var(--bg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; color:#111; }
  .app-wrap{ max-width:980px; margin:24px auto; padding:0 14px; }
  .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; }
  h1,h2,h3{ margin:0 0 8px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{ appearance:none; border:1px solid #1112; background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn:hover{ background:#fafafa; }
  .btn.primary{ background:#111; color:#fff; border-color:#111; }
  .btn.back{ background:#f3f4f6; }
  .pill{ display:inline-flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--line); border-radius:999px; padding:6px 10px; }
  .muted{ color:var(--muted); font-size:14px; }
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th,.table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<div id="app" class="app-wrap">
  <div class="card"><h2>Chargement‚Ä¶</h2></div>
</div>

<script>
/* =========================
   1.1 ‚Ä¢ Boutons & rendu
   ========================= */
window.b = window.b || function(txt, fn, cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>'; };
window.view = window.view || function(html){ var el=document.getElementById('app'); if(el) el.innerHTML=html; };

/* =========================
   1.2 ‚Ä¢ ‚Ç¨ / arrondi / format
   ========================= */
window.euro = window.euro || function(n){ var v=+(n||0); return v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2})+' ‚Ç¨'; };
window.roundUp5 = window.roundUp5 || function(n){ n=+n||0; return Math.ceil(n/5)*5; };
window.formatDateFR = function(d){ try{ return (d?new Date(d):new Date()).toLocaleDateString('fr-FR'); }catch(e){ return new Date().toLocaleDateString(); } };

/* =========================
   1.3 ‚Ä¢ √âtat devis courant
   ========================= */
window.devis = window.devis || { __id:'', __name:'Nouveau devis', __created_at:'', __tva_applicable:undefined, __taux_tva:undefined };
function ensureDevis(){
  if(!devis.__id) devis.__id = 'dv_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7);
  if(!devis.__created_at) devis.__created_at = new Date().toISOString();
  if(typeof devis.__name!=='string') devis.__name='Devis';
}

/* =========================
   1.4 ‚Ä¢ Persistance locale
   ========================= */
const KEY_DEVIS_CURRENT = 'devis_current_v1';
function saveLocal(){ try{ ensureDevis(); localStorage.setItem(KEY_DEVIS_CURRENT, JSON.stringify(devis)); }catch(e){} }
function loadLocal(){
  try{
    var raw = localStorage.getItem(KEY_DEVIS_CURRENT);
    if(raw){ window.devis = JSON.parse(raw)||window.devis; }
    ensureDevis();
  }catch(e){ ensureDevis(); }
}

/* =========================
   1.5 ‚Ä¢ Utilitaires divers
   ========================= */
function makeUID(pfx){ return (pfx||'id')+'_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6); }
function downloadBlob(name, blob){
  try{
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }catch(e){ alert('T√©l√©chargement impossible : '+e.message); }
}

// expose minimal
Object.assign(window,{ saveLocal, loadLocal, ensureDevis, downloadBlob, makeUID });
</script>
















<!-- =====================================================
     CHAPITRE 1 : SOCLE UI & HELPERS
     Sommaire :
       1.0 ‚Ä¢ Styles de base + conteneur
       1.1 ‚Ä¢ Boutons & rendu (b, view)
       1.2 ‚Ä¢ Aides ‚Ç¨ / arrondi / formats
       1.3 ‚Ä¢ √âtat courant du devis (ensure)
       1.4 ‚Ä¢ Persistance locale (load/save)
       1.5 ‚Ä¢ Outils g√©n√©riques (download, uid)
     ===================================================== -->

<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280; --bg:#f7f7fb;
  }
  html,body{ margin:0; padding:0; background:var(--bg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; color:#111; }
  .app-wrap{ max-width:980px; margin:24px auto; padding:0 14px; }
  .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; }
  h1,h2,h3{ margin:0 0 8px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{ appearance:none; border:1px solid #1112; background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn:hover{ background:#fafafa; }
  .btn.primary{ background:#111; color:#fff; border-color:#111; }
  .btn.back{ background:#f3f4f6; }
  .pill{ display:inline-flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--line); border-radius:999px; padding:6px 10px; }
  .muted{ color:var(--muted); font-size:14px; }
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th,.table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<div id="app" class="app-wrap">
  <div class="card"><h2>Chargement‚Ä¶</h2></div>
</div>

<script>
/* =========================
   1.1 ‚Ä¢ Boutons & rendu
   ========================= */
window.b = window.b || function(txt, fn, cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>'; };
window.view = window.view || function(html){ var el=document.getElementById('app'); if(el) el.innerHTML=html; };

/* =========================
   1.2 ‚Ä¢ ‚Ç¨ / arrondi / format
   ========================= */
window.euro = window.euro || function(n){ var v=+(n||0); return v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2})+' ‚Ç¨'; };
window.roundUp5 = window.roundUp5 || function(n){ n=+n||0; return Math.ceil(n/5)*5; };
window.formatDateFR = function(d){ try{ return (d?new Date(d):new Date()).toLocaleDateString('fr-FR'); }catch(e){ return new Date().toLocaleDateString(); } };

/* =========================
   1.3 ‚Ä¢ √âtat devis courant
   ========================= */
window.devis = window.devis || { __id:'', __name:'Nouveau devis', __created_at:'', __tva_applicable:undefined, __taux_tva:undefined };
function ensureDevis(){
  if(!devis.__id) devis.__id = 'dv_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7);
  if(!devis.__created_at) devis.__created_at = new Date().toISOString();
  if(typeof devis.__name!=='string') devis.__name='Devis';
}

/* =========================
   1.4 ‚Ä¢ Persistance locale
   ========================= */
const KEY_DEVIS_CURRENT = 'devis_current_v1';
function saveLocal(){ try{ ensureDevis(); localStorage.setItem(KEY_DEVIS_CURRENT, JSON.stringify(devis)); }catch(e){} }
function loadLocal(){
  try{
    var raw = localStorage.getItem(KEY_DEVIS_CURRENT);
    if(raw){ window.devis = JSON.parse(raw)||window.devis; }
    ensureDevis();
  }catch(e){ ensureDevis(); }
}

/* =========================
   1.5 ‚Ä¢ Utilitaires divers
   ========================= */
function makeUID(pfx){ return (pfx||'id')+'_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6); }
function downloadBlob(name, blob){
  try{
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }catch(e){ alert('T√©l√©chargement impossible : '+e.message); }
}

// expose minimal
Object.assign(window,{ saveLocal, loadLocal, ensureDevis, downloadBlob, makeUID });
</script>

















<!-- =====================================================
     CHAPITRE 3 : NAVIGATION & ACCUEIL
     Sommaire :
       3.0 ‚Ä¢ Page principale (pageMain)
       3.1 ‚Ä¢ Raccourcis vers modules (Pi√®ces, Tableaux, Ventilation‚Ä¶)
       3.2 ‚Ä¢ Aide/√©tat en pied de page
     ===================================================== -->
<script>
function pageMain(){
  ensureDevis();
  view(
    '<div class="card">'
      + '<div class="row" style="justify-content:space-between;">'
        + '<h2>'+ (devis.__name||'Devis') +'</h2>'
        + '<div class="row">'
          + b('üìÅ Mes devis','pageSavedDevis()','btn')
          + b('üìù Renommer','renameCurrentDevis()','btn')
          + b('üÜï Nouveau devis','actionNouveauDevis()','btn')
        + '</div>'
      + '</div>'
      + '<p class="muted">ID : '+devis.__id+' ‚Äî Cr√©√© le '+formatDateFR(devis.__created_at)+'</p>'
    + '</div>'

    + '<div class="card" style="margin-top:12px;">'
      + '<h2>Outils</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + b('üì¶ Saisie par pi√®ces','pageHome()','btn primary')  // (Chap.5)
        + b('üß∞ Tableaux','pageTabHome ? pageTabHome() : pageTabCreate()','btn') // (Chap.6)
        + b('üå¨Ô∏è Ventilation','pageVentAccueil ? pageVentAccueil() : alert(\'Module ventilation (chap.7) non charg√©\')','btn')
        + b('üßÆ Estimatif & exports','pageEstimatif ? pageEstimatif() : alert(\'Chap.11 requis\')','btn')
      + '</div>'
    + '</div>'

    + '<div class="card" style="margin-top:12px;">'
      + '<h2>Param√©trage</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + b('‚öôÔ∏è Tarifs / Catalogue','pageTarifsAccueil ? pageTarifsAccueil() : (pageCatalogueTarifsAccueil ? pageCatalogueTarifsAccueil() : alert(\'Chapitres 8/13 requis\'))','btn')
        + b('üè¢ Configuration entreprise','pageConfigEntreprise ? pageConfigEntreprise() : alert(\'Chap.12 requis\')','btn')
        + b('üß≠ Pr√©f√©rences','pagePreferences ? pagePreferences() : alert(\'Chap.12 requis\')','btn')
        + b('üí∂ Facturation','pageFactures ? pageFactures() : alert(\'Chap.10 requis\')','btn')
      + '</div>'
    + '</div>'
  );
}
function renameCurrentDevis(){
  const nn = prompt('Nom du devis :', devis.__name||''); if(nn==null) return;
  devis.__name = (nn||'').trim() || devis.__name; saveLocal(); pageMain();
}
Object.assign(window,{ pageMain, renameCurrentDevis });
</script>















<!-- =====================================================
     CHAPITRE 4 : SAUVEGARDE ROBUSTE
     Sommaire :
       4.0 ‚Ä¢ Snapshots auto (historique court)
       4.1 ‚Ä¢ Reprise si document vide
       4.2 ‚Ä¢ Outils (purge / restore)
     ===================================================== -->
<script>
const KEY_AUTOSNAPS = 'devis_autosnaps_v1';
const AUTOSNAP_EVERY_MS = 30*1000; // 30s
let _autosnap_timer = null;

function _readSnaps(){ try{ return JSON.parse(localStorage.getItem(KEY_AUTOSNAPS)||'null')||[]; }catch(e){ return []; } }
function _writeSnaps(arr){ try{ localStorage.setItem(KEY_AUTOSNAPS, JSON.stringify(arr||[])); }catch(e){} }

function autosnapOnce(){
  try{
    ensureDevis();
    const list = _readSnaps();
    const snap = { when: Date.now(), data: JSON.parse(JSON.stringify(devis)) };
    list.unshift(snap);
    // garder les 20 derniers
    _writeSnaps(list.slice(0,20));
  }catch(e){}
}
function startAutosnapLoop(){
  if(_autosnap_timer) clearInterval(_autosnap_timer);
  _autosnap_timer = setInterval(autosnapOnce, AUTOSNAP_EVERY_MS);
}

// Reprise si devis ‚Äúvide‚Äù
function isDevisEmpty(dv){
  if(!dv) return true;
  for(const k in dv){ if(k.startsWith('__')) continue; const s=dv[k]; if(s && Array.isArray(s.items) && s.items.length) return false; }
  return true;
}
function recoverSavedIfEmpty(){
  try{
    if(!isDevisEmpty(devis)) return; // rien √† faire
    const last = _readSnaps()[0];
    if(last && last.data){ window.devis = last.data; saveLocal(); }
  }catch(e){}
}

Object.assign(window,{ autosnapOnce, startAutosnapLoop, recoverSavedIfEmpty });
</script>














<!-- =====================================================
     CHAPITRE 5 : SAISIE PAR PI√àCES
     Sommaire :
       5.0 ‚Ä¢ Mod√®le de section (pi√®ce) & helpers
       5.1 ‚Ä¢ Accueil + ajout de pi√®ce
       5.2 ‚Ä¢ S√©lection d‚Äôune cat√©gorie (rapide)
       5.3 ‚Ä¢ Ajout d‚Äô√©l√©ments ‚Äúone-shot‚Äù (PU simple)
       5.4 ‚Ä¢ Notes de pi√®ce / suppression
     ===================================================== -->
<script>
/* =========================
   5.0 ‚Ä¢ Mod√®le de pi√®ce
   ========================= */
function ensurePiece(key, base){
  devis[key] = devis[key] || { __base: (base||key), items:[], note:'' };
}
function pieceKeys(){ return Object.keys(devis).filter(k=>!k.startsWith('__')); }

/* =========================
   5.1 ‚Ä¢ Accueil & ajout
   ========================= */
function pageHome(){
  const keys = pieceKeys();
  const list = keys.length ? keys.map(k=>{
    const s=devis[k]||{}; const nb=(s.items||[]).length;
    return `<div class="pill"><strong>${k}</strong><span class="muted">${nb} ligne(s)</span>
      ${b('Ouvrir','goPiece("'+k.replace(/"/g,'&quot;')+'")','btn')}
      ${b('Supprimer','removePiece("'+k.replace(/"/g,'&quot;')+'")','btn')}
    </div>`;
  }).join(' ') : '<p class="muted">Aucune pi√®ce pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Pi√®ces</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + '<input id="new-piece" placeholder="Nouvelle pi√®ce (ex: Salon, Cuisine‚Ä¶)" />'
        + b('Ajouter','pageAddPiece()','btn primary')
      + '</div>'
    + '</div>'
    + '<div class="card"><h3>Liste</h3>'+list+'</div>'
  );
}
function pageAddPiece(){
  const el=document.getElementById('new-piece'); const name=(el&&el.value||'').trim(); if(!name) return;
  ensurePiece(name, name); saveLocal(); goPiece(name);
}

/* =========================
   5.2 ‚Ä¢ √âcran d‚Äôune pi√®ce
   ========================= */
const QUICK_CATS = [
  { id:'Prises', items:['Prise 2P+T'] },
  { id:'√âclairage/Luminaires', items:['Point de centre','Applique'] },
  { id:'√âclairage/Commandes', items:['Interrupteur simple','Interrupteur double'] },
  { id:'Circuit sp√©cialis√©', items:['Four','Plaque de cuisson'] }
];

function goPiece(key){
  ensurePiece(key);
  const s=devis[key], items=(s.items||[]);
  const rows = items.length ? items.map((it,idx)=>{
    const q=+it.qty||0, pu=+it.prixU||0, t=q*pu;
    return `<li>${it.intervention?it.intervention+' ‚Äî ':''}${it.designation} (${q} ${it.unit||'u'} √ó ${euro(pu)} = ${euro(t)})
      ${b('√ó','delLine("'+key+'",'+idx+')','btn')}</li>`;
  }).join('') : '<li class="muted">Aucune ligne.</li>';

  const catBtns = QUICK_CATS.map(c=>b(c.id,'goCategory("'+key+'","'+c.id+'")','btn')).join(' ');

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>'+key+'</h2>'
      + '<div class="row" style="margin-top:8px;">'+catBtns+'</div>'
      + '<div class="row" style="margin-top:8px;">'
        + b('‚ûï Ajout ‚Äúone-shot‚Äù','pageOneShotSelection("'+key+'")','btn')
        + b('üìù Note','editPieceNote("'+key+'")','btn')
      + '</div>'
    + '</div>'
    + '<div class="card"><h3>Lignes</h3><ul>'+rows+'</ul></div>'
  );
}
function delLine(key, idx){
  const s=devis[key]; if(!s||!s.items) return; s.items.splice(idx,1); saveLocal(); goPiece(key);
}

/* =========================
   5.3 ‚Ä¢ Ajouts rapides
   ========================= */
function goCategory(key, cat){
  const cfg = QUICK_CATS.find(x=>x.id===cat);
  if(!cfg) return alert('Cat√©gorie inconnue');
  const opts = cfg.items.map(n=>'<option>'+n+'</option>').join('');
  view(
    '<div class="card">'
      + b('Retour','goPiece("'+key+'")','btn back')
      + '<h2>'+key+' ‚Äî '+cat+'</h2>'
      + '<label>√âl√©ment</label><select id="qsel">'+opts+'</select>'
      + '<div class="row" style="margin-top:8px;">'
        + '<input id="q-qty" type="number" min="1" value="1" style="max-width:120px;" />'
        + '<input id="q-pu" type="number" min="0" step="1" placeholder="PU (tout compris)" style="max-width:200px;" />'
        + b('Ajouter','saveSpecifique("'+key+'","'+cat+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}

// compat: utilis√© par d‚Äôanciens boutons
function pageSpecifiqueForm(key, cat){ goCategory(key, cat); }

function saveSpecifique(key, cat){
  const sel=document.getElementById('qsel'); const des=(sel&&sel.value)||cat;
  const q = Math.max(1, parseInt(document.getElementById('q-qty')?.value||'1',10));
  const pu = Math.max(0, parseFloat(document.getElementById('q-pu')?.value||'0'));
  ensurePiece(key);
  devis[key].items.push({ category:cat, intervention:'Cr√©ation', designation:des, qty:q, prixU:pu });
  saveLocal(); goPiece(key);
}

/* =========================
   5.4 ‚Ä¢ Notes & suppression
   ========================= */
function editPieceNote(key){
  ensurePiece(key);
  const cur = devis[key].note || '';
  const nn = prompt('Note pour '+key+' :', cur);
  if(nn==null) return;
  devis[key].note = nn; saveLocal(); goPiece(key);
}
function removePiece(key){
  if(!confirm('Supprimer la pi√®ce ¬´ '+key+' ¬ª ?')) return;
  delete devis[key]; saveLocal(); pageHome();
}

Object.assign(window,{
  pageHome, pageAddPiece, goPiece, delLine,
  goCategory, pageSpecifiqueForm, saveSpecifique,
  pageOneShotSelection: goCategory, // alias
  editPieceNote, removePiece
});
</script>






















<!-- =====================================================
     CHAPITRE 6 : TABLEAUX (MULTI)
     Sommaire :
       6.0 ‚Ä¢ Mod√®le, cl√©s & helpers
       6.1 ‚Ä¢ Accueil Tableaux (liste)
       6.2 ‚Ä¢ Cr√©ation & nom personnalis√©
       6.3 ‚Ä¢ √âl√©ments clefs (ID, coupure, disjoncteurs)
       6.4 ‚Ä¢ Ajout d‚Äô√©l√©ments & validation
     ===================================================== -->
<script>
/* =========================
   6.0 ‚Ä¢ Mod√®le & helpers
   ========================= */
function _tabListKeys(){
  return Object.keys(devis).filter(k=>{
    if(k.startsWith('__')) return false;
    const s=devis[k]||{}; return ((s.__base||'').toLowerCase()==='tableau');
  });
}
function _ensureTab(key){
  if(!devis[key]) devis[key]={ __base:'Tableau', __customName:'', items:[], note:'' };
}

/* =========================
   6.1 ‚Ä¢ Accueil Tableaux
   ========================= */
function pageTabHome(){
  const keys = _tabListKeys();
  const list = keys.length ? keys.map(k=>{
    const s=devis[k]||{}; const lab = k + (s.__customName?(' ‚Äî '+s.__customName):'');
    return `<div class="pill"><strong>${lab}</strong>
      ${b('Ouvrir','pageTabPose("'+k+'")','btn')}
      ${b('Supprimer','tabDelete("'+k+'")','btn')}
    </div>`;
  }).join(' ') : '<p class="muted">Aucun tableau.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Tableaux</h2>'
      + '<div class="row" style="margin-top:8px;">'+ b('‚ûï Cr√©er un tableau','pageTabCreate()','btn primary') +'</div>'
    + '</div>'
    + '<div class="card"><h3>Liste</h3>'+list+'</div>'
  );
}

/* =========================
   6.2 ‚Ä¢ Cr√©ation & nom
   ========================= */
function pageTabCreate(){
  const key = 'Tableau '+(_tabListKeys().length+1);
  _ensureTab(key); saveLocal();
  view(
    '<div class="card">'
      + b('Retour','pageTabHome()','btn back')
      + '<h2>Nouveau tableau</h2>'
      + '<p><strong>Identifiant : '+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="tab-name" placeholder="ex : Logement A / Atelier / TGBT‚Ä¶" />'
      + '<div class="row" style="margin-top:10px;">'
        + b('Valider','saveTabCustomName("'+key+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}
function saveTabCustomName(key){
  const nm = (document.getElementById('tab-name')?.value||'').trim();
  if(devis[key]) devis[key].__customName = nm;
  saveLocal(); pageTabPose(key);
}
function tabDelete(key){
  if(!confirm('Supprimer ¬´ '+key+' ¬ª ?')) return;
  delete devis[key]; saveLocal(); pageTabHome();
}

/* =========================
   6.3 ‚Ä¢ √âl√©ments clefs
   ========================= */
function pageTabPose(key){
  _ensureTab(key);
  const s=devis[key];
  const name = key + (s.__customName?(' ‚Äî '+s.__customName):'');
  const rows = (s.items||[]).map((it,idx)=>{
    const t = (it.qty||0)*(it.prixU||0);
    return `<li>${it.designation} (${it.qty||0} √ó ${euro(it.prixU||0)} = ${euro(t)}) ${b('√ó','tabDelLine("'+key+'",'+idx+')','btn')}</li>`;
  }).join('') || '<li class="muted">Aucune ligne.</li>';

  view(
    '<div class="card">'
      + b('Retour','pageTabHome()','btn back')
      + '<h2>'+name+'</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + b('Ajouter ‚Äî ID 30mA','pageTab_ID("'+key+'")','btn')
        + b('Ajouter ‚Äî Coupure g√©n√©rale','pageTab_Coupure("'+key+'")','btn')
        + b('Ajouter ‚Äî Disjoncteurs','pageTab_Disjoncteurs("'+key+'")','btn')
      + '</div>'
      + '<p class="muted">Version l√©g√®re ‚Äî compatible avec tes chapitres d√©taill√©s.</p>'
    + '</div>'
    + '<div class="card"><h3>Lignes</h3><ul>'+rows+'</ul></div>'
  );
}
function tabDelLine(key, idx){ const s=devis[key]; if(!s||!s.items) return; s.items.splice(idx,1); saveLocal(); pageTabPose(key); }

/* === 6.3.a ‚Ä¢ ID 30mA === */
function pageTab_ID(key){
  view(
    '<div class="card">'
      + b('Retour','pageTabPose("'+key+'")','btn back')
      + '<h2>Interrupteur diff√©rentiel 30 mA</h2>'
      + '<div class="row">'
        + '<input id="id-cal" type="number" min="25" step="5" value="40" style="max-width:120px;" />'
        + '<select id="id-type"><option>AC</option><option>A</option><option>F</option></select>'
        + '<input id="id-prix" type="number" step="1" placeholder="PU (tout compris)" style="max-width:180px;" />'
        + b('Ajouter','pageTab_ID_submit("'+key+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}
function pageTab_ID_submit(key){
  const cal = parseInt(document.getElementById('id-cal')?.value||'40',10);
  const type = document.getElementById('id-type')?.value||'AC';
  const pu = Math.max(0, parseFloat(document.getElementById('id-prix')?.value||'0'));
  _ensureTab(key);
  devis[key].items.push({ category:'Tableau', designation:`ID 30mA ${type} ${cal}A`, qty:1, prixU:pu });
  saveLocal(); pageTabPose(key);
}

/* === 6.3.b ‚Ä¢ Coupure g√©n√©rale === */
function pageTab_Coupure(key){
  view(
    '<div class="card">'
      + b('Retour','pageTabPose("'+key+'")','btn back')
      + '<h2>Coupure g√©n√©rale</h2>'
      + '<div class="row">'
        + '<select id="cg-type"><option>Inter-sectionneur</option><option>Disjoncteur de coupure</option></select>'
        + '<input id="cg-cal" type="number" min="40" step="10" value="63" style="max-width:120px;" />'
        + '<input id="cg-prix" type="number" step="1" placeholder="PU (tout compris)" style="max-width:180px;" />'
        + b('Ajouter','submitTab_Coupure("'+key+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}
function submitTab_Coupure(key){
  const t=document.getElementById('cg-type')?.value||'Inter-sectionneur';
  const cal=parseInt(document.getElementById('cg-cal')?.value||'63',10);
  const pu=Math.max(0, parseFloat(document.getElementById('cg-prix')?.value||'0'));
  _ensureTab(key);
  devis[key].items.push({ category:'Tableau', designation:`Coupure g√©n√©rale ‚Äî ${t} ${cal}A`, qty:1, prixU:pu });
  saveLocal(); pageTabPose(key);
}

/* === 6.3.c ‚Ä¢ Disjoncteurs === */
function pageTab_Disjoncteurs(key){
  view(
    '<div class="card">'
      + b('Retour','pageTabPose("'+key+'")','btn back')
      + '<h2>Disjoncteurs modulaires</h2>'
      + '<div class="row">'
        + '<input id="dj-nb" type="number" min="1" value="1" style="max-width:120px;" />'
        + '<select id="dj-cal"><option>10A</option><option>16A</option><option>20A</option><option>32A</option></select>'
        + '<input id="dj-prix" type="number" step="1" placeholder="PU (tout compris / pi√®ce)" style="max-width:220px;" />'
        + b('Ajouter','pageTab_DisjValider("'+key+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}
function pageTab_DisjValider(key){
  const nb = Math.max(1, parseInt(document.getElementById('dj-nb')?.value||'1',10));
  const cal = document.getElementById('dj-cal')?.value||'16A';
  const pu = Math.max(0, parseFloat(document.getElementById('dj-prix')?.value||'0'));
  _ensureTab(key);
  devis[key].items.push({ category:'Tableau', designation:`Disjoncteur ${cal}`, qty:nb, prixU:pu });
  saveLocal(); pageTabPose(key);
}

/* =========================
   6.4 ‚Ä¢ Expose compat
   ========================= */
Object.assign(window,{
  pageTabHome, pageTabCreate, saveTabCustomName, tabDelete,
  pageTabPose,
  pageTab_ID, pageTab_ID_submit: pageTab_ID_submit, submitTab_ID: pageTab_ID_submit,
  pageTab_Coupure, submitTab_Coupure,
  pageTab_Disjoncteurs, pageTab_DisjValider
});
</script>












<!-- =====================================================
     CHAPITRE 7 : VENTILATION ‚Äî VMC / Extracteur / Ventilo conduit
     Sommaire :
       7.0 ‚Ä¢ √âtat local & helpers
       7.1 ‚Ä¢ Accueil ventilation
       7.2 ‚Ä¢ Cr√©ation (kit / extracteur / ventilateur)
       7.3 ‚Ä¢ Retirage de conduits
       7.4 ‚Ä¢ Entretien
       7.5 ‚Ä¢ Expose
     ===================================================== -->
<script>
/* ======== 7.0 ‚Ä¢ √âtat local & helpers ======== */
var ventState = {};
function ensureVentKey(key){
  if(!devis[key]) devis[key] = { __base:"VMC", __customName:"", items:[], note:"" };
  if(!ventState[key]) ventState[key] = {
    creation:{ kit:{ref:"",d80:1,d125:1,conduits:[{type:"Gaine isol√©e"}],perc:[{support:"Placo",qty:0}]},
               extracteur:{ref:"",diam:"100",conduits:[{type:"Gaine isol√©e"}],perc:[{support:"Placo",qty:0}]},
               ventilo:{ref:"",diam:"100",long:0,perc:[{support:"Placo",qty:0}]}},
    retirage:{n80:0,n125:0},
    entretien:{type:"Groupe VMC",nb:0}
  };
}
function pickVal(id,def){const e=document.getElementById(id);return e?e.value:def;}
function pickNum(id,def){const e=document.getElementById(id);const v=parseFloat(e?e.value:NaN);return isNaN(v)?(def||0):v;}

/* ======== 7.1 ‚Ä¢ Accueil ventilation ======== */
function pageVentAccueil(){
  var keys=Object.keys(devis).filter(k=>(devis[k]?.__base||"").toLowerCase()==="vmc");
  var list=keys.length?keys.map(k=>{
    var s=devis[k];return `<div class="pill"><strong>${k}</strong> <small>${(s.items||[]).length} ligne(s)</small>
      ${b("Ouvrir","pageVentHome('"+k+"')","btn")}
      ${b("Supprimer","ventDelete('"+k+"')","btn")}</div>`;
  }).join(""):"<p class='muted'>Aucune ventilation.</p>";
  view(`<div class="card">${b("Retour","pageMain()","btn back")}<h2>Ventilation</h2>
    <div class="row">${b("‚ûï Ajouter une ventilation","pageVentNew()","btn primary")}</div></div>
    <div class="card" style="margin-top:12px;"><h2>Liste</h2>${list}</div>`);
}
function pageVentNew(){
  var key="Ventilation "+((_tabListKeys?.().length||0)+1);
  ensureVentKey(key);saveLocal();
  view(`<div class="card">${b("Retour","pageVentAccueil()","btn back")}<h2>Nouvelle ventilation</h2>
    <p><strong>${key}</strong></p><input id="vent-name" placeholder="Nom personnalis√©"/><div class="row" style="margin-top:10px;">
    ${b("Valider","saveVentName('"+key+"')","btn primary")}</div></div>`);
}
function saveVentName(key){var n=(document.getElementById("vent-name")?.value||"").trim();devis[key].__customName=n;saveLocal();pageVentHome(key);}
function ventDelete(key){if(!confirm("Supprimer "+key+" ?"))return;delete devis[key];saveLocal();pageVentAccueil();}

/* ======== 7.2 ‚Ä¢ Cr√©ation (kit / extracteur / ventilo) ======== */
function pageVentHome(key){
  ensureVentKey(key);
  view(`<div class="card">${b("Retour","pageVentAccueil()","btn back")}<h2>${key}</h2>
    <div class="row" style="margin-top:8px;">${b("Cr√©ation","pageVentCreation('"+key+"')","btn primary")}
      ${b("Retirage","pageVentRetirage('"+key+"')","btn")}
      ${b("Entretien","pageVentEntretien('"+key+"')","btn")}</div></div>`);
}
function pageVentCreation(key){
  ensureVentKey(key);var st=ventState[key].creation;
  view(`<div class="card">${b("Retour","pageVentHome('"+key+"')","btn back")}<h2>Cr√©ation VMC</h2>
    <label>Kit ref.</label><input id="kit-ref" value="${st.kit.ref}"/>
    <div class="row"><input id="kit-d80" type="number" value="${st.kit.d80}"/><input id="kit-d125" type="number" value="${st.kit.d125}"/></div>
    <div class="row" style="margin-top:8px;">${b("Ajouter Kit","ventAddKit('"+key+"')","btn primary")}</div>
    <hr/>
    <label>Extracteur ref.</label><input id="ex-ref" value="${st.extracteur.ref}"/>
    <div class="row"><input id="ex-diam" value="${st.extracteur.diam}"/></div>
    <div class="row" style="margin-top:8px;">${b("Ajouter Extracteur","ventAddExtracteur('"+key+"')","btn primary")}</div>
    <hr/>
    <label>Ventilo ref.</label><input id="vc-ref" value="${st.ventilo.ref}"/>
    <div class="row"><input id="vc-diam" value="${st.ventilo.diam}"/><input id="vc-long" type="number" value="${st.ventilo.long}"/></div>
    <div class="row" style="margin-top:8px;">${b("Ajouter Ventilo","ventAddVentilateur('"+key+"')","btn primary")}</div></div>`);
}
function ventAddKit(key){devis[key].items.push({category:"Ventilation",designation:"Kit VMC",qty:1,prixU:0});saveLocal();pageVentHome(key);}
function ventAddExtracteur(key){devis[key].items.push({category:"Ventilation",designation:"Extracteur",qty:1,prixU:0});saveLocal();pageVentHome(key);}
function ventAddVentilateur(key){devis[key].items.push({category:"Ventilation",designation:"Ventilateur conduit",qty:1,prixU:0});saveLocal();pageVentHome(key);}

/* ======== 7.3 ‚Ä¢ Retirage ======== */
function pageVentRetirage(key){
  ensureVentKey(key);var st=ventState[key].retirage;
  view(`<div class="card">${b("Retour","pageVentHome('"+key+"')","btn back")}<h2>Retirage</h2>
    <div class="row"><input id="rt80" type="number" value="${st.n80}"/><input id="rt125" type="number" value="${st.n125}"/></div>
    <div class="row" style="margin-top:8px;">${b("Ajouter","ventAddRetirage('"+key+"')","btn primary")}</div></div>`);
}
function ventAddRetirage(key){
  var n80=pickNum("rt80",0),n125=pickNum("rt125",0);
  devis[key].items.push({category:"Ventilation",designation:`Retirage √ò80=${n80}/√ò125=${n125}`,qty:1,prixU:0});saveLocal();pageVentHome(key);
}

/* ======== 7.4 ‚Ä¢ Entretien ======== */
function pageVentEntretien(key){
  ensureVentKey(key);var st=ventState[key].entretien;
  view(`<div class="card">${b("Retour","pageVentHome('"+key+"')","btn back")}<h2>Entretien</h2>
    <select id="ent-type"><option>Groupe VMC</option><option>Extracteur</option><option>Ventilateur conduit</option></select>
    <input id="ent-nb" type="number" value="${st.nb}" style="margin-top:8px;"/>
    <div class="row" style="margin-top:8px;">${b("Ajouter","ventAddEntretien('"+key+"')","btn primary")}</div></div>`);
}
function ventAddEntretien(key){
  var t=pickVal("ent-type","Groupe VMC"),nb=pickNum("ent-nb",0);
  devis[key].items.push({category:"Ventilation",designation:`Entretien ${t} nb=${nb}`,qty:1,prixU:0});saveLocal();pageVentHome(key);
}

/* ======== 7.5 ‚Ä¢ Expose ======== */
Object.assign(window,{
  pageVentAccueil,pageVentNew,saveVentName,ventDelete,pageVentHome,pageVentCreation,
  ventAddKit,ventAddExtracteur,ventAddVentilateur,
  pageVentRetirage,ventAddRetirage,pageVentEntretien,ventAddEntretien
});
</script>






























