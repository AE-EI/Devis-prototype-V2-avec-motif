<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis ‚Äî V3.0</title>

  <!-- Styles de base -->
  <style>
    :root {
      --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666;
      --line:#e8e8e8; --primary:#111;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#444; background:#fafafa; }
  </style>

  <!-- JSZip (exports ZIP) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- Cache-busting : ajoute ?v=timestamp une seule fois par onglet -->
  <script>
  (function(){
    try{
      var url = new URL(location.href);
      if (url.searchParams.has('v')) return;
      var onceKey = 'cb_once_' + location.pathname;
      if (sessionStorage.getItem(onceKey)) return;
      url.searchParams.set('v', Date.now());
      sessionStorage.setItem(onceKey, '1');
      location.replace(url.toString());
    }catch(e){}
  })();
  </script>
</head>
<body>
  <header>MiniDevis ‚Äî V3.0</header>
  <main id="app"></main>

  <!-- Sentinelle ultra-t√¥t -->
  <script>
  (function(){
    var app = document.getElementById('app');
    if(app){ app.innerHTML =
      '<div class="card">Loader OK ‚Äî en attente des chapitres JS‚Ä¶</div>';
    }
  })();
  </script>






  






  

  



  
  <!-- =============================
     CHAPITRE 2 : √âTAT & HELPERS
     Index :
       ¬ß2.1 ‚Ä¢ Gestion erreurs globales
       ¬ß2.2 ‚Ä¢ √âtat global & contexte courant
       ¬ß2.3 ‚Ä¢ Identifiants & helpers DOM/UI
       ¬ß2.4 ‚Ä¢ Libell√©s de pi√®ces (build/format)
       ¬ß2.5 ‚Ä¢ Persistance locale (save/load)
     ============================= -->
<script>
// ¬ß2.1 ‚Ä¢ Gestion erreurs globales
window.addEventListener('error', function (e) {
  var el = document.getElementById('app');
  if (el) {
    el.innerHTML =
      '<div class="card"><h2>Erreur JS</h2><pre>'
      + (e.message || 'Erreur inconnue')
      + '\n' + (e.filename || '') + ':' + (e.lineno || 0) + ':' + (e.colno || 0)
      + '</pre></div>';
  }
});

// ¬ß2.2 ‚Ä¢ √âtat global & contexte courant
var devis = {}; // contiendra aussi __id, __name, __tabCounter
var ctx   = { piece:null, category:null, intervention:null, pose:null, designation:null };

// ¬ß2.3 ‚Ä¢ Identifiants & helpers DOM/UI
function genId(){ return 'dv_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
function ensureId(){ if(!devis.__id) devis.__id = genId(); }
function $app(){ return document.getElementById('app'); }
function b(label, fn, cls){
  cls = cls || 'btn';
  return '<button class="'+cls+'" onclick=\''+fn+'\'>'+label+'</button>';
}
function euro(n){ return (+(n||0)).toFixed(2) + ' ‚Ç¨'; }
function view(html, noFooter){
  if(!noFooter){
    html += '<div class="row" style="margin-top:16px; gap:12px;">'
          + b('‚¨ÖÔ∏è Accueil','confirmBackHome()','btn back')
          + b('üíæ Sauvegarder devis','saveCurrentDevis()','btn primary')
          + '</div>';
  }
  $app().innerHTML = html;
}
function confirmBackHome(){
  var hasData = Object.keys(devis)
    .filter(function(k){ return k.indexOf('__') !== 0; })
    .some(function(k){
      var s = devis[k]||{};
      return (s.items && s.items.length>0) || (s.note && s.note.trim().length>0);
    });

  if(!hasData || confirm('Revenir au menu principal ?\n‚ö†Ô∏è Les modifications non sauvegard√©es seront perdues.')){
    if (typeof pageMain === 'function') pageMain();
    else $app().innerHTML = '<div class="card"><h2>Accueil</h2><p class="muted">Le chapitre Menu (4) n\'est pas encore charg√©.</p></div>';
  }
}

// ¬ß2.4 ‚Ä¢ Libell√©s de pi√®ces (build/format)
function buildPieceLabel(base, qualif, etage){
  var lbl = base || '';
  if(qualif && qualif.trim()) lbl += ' ('+qualif.trim()+')';
  if(etage && etage.trim())   lbl += ' ‚Äî '+etage.trim();
  return lbl;
}
function nextFreeKey(label){
  if(!devis[label]) return label;
  var n=2; while(devis[label+' ('+n+')']) n++;
  return label+' ('+n+')';
}
function createOrGetPiece(base, qualif, etage){
  var wanted = buildPieceLabel(base,qualif,etage);
  var key    = nextFreeKey(wanted);
  if(!devis[key]) devis[key] = { __base:base, qualificatif:qualif||'', etage:etage||'', items:[], note:'' };
  saveLocal();
  return key;
}
function formatPieceLabel(key){
  var s = devis[key]; if(!s) return key;
  var base = s.__base || key;
  return buildPieceLabel(base, s.qualificatif, s.etage);
}

// ¬ß2.5 ‚Ä¢ Persistance locale (save/load)
function ensureSection(key){
  if(!devis[key]) devis[key] = { items:[], note:'', qualificatif:'', etage:'' };
}
function saveLocal(){
  try { localStorage.setItem('devis', JSON.stringify(devis)); } catch(e){}
}
function loadLocal(){
  try { devis = JSON.parse(localStorage.getItem('devis') || '{}') || {}; }
  catch(e){ devis = {}; }
  ensureId();
}
</script>










  

  




  


  
<!-- =============================
     CHAPITRE 3 : CONSTANTES + PRIX
     ============================= -->
<script>
// Pi√®ces pr√©d√©finies
var PIECES_PREDEFINIES = [
  'Salon','Cuisine','Salle √† manger','Salle de bain','Salle d\'eau',
  'Chambre 1','Chambre 2','Chambre 3','Toilettes','Bureau',
  'Buanderie','Garage','Couloir','Terrasse','Balcon','Jardin',
  'D√©barras','Ext√©rieur','Grenier/Combles','Atelier',
  'Abri de jardin','Entr√©e','Biblioth√®que'
];

  //
  // Liste d‚Äô√©tages (utilis√©e par pageAddPiece)
//
var ETAGES = window.ETAGES || [
  'Sous-sol', 'RDC', 'R+1', 'R+2', 'Combles', 'Mezzanine',
  'Annexe', 'Ext√©rieur'
];

// (Optionnel mais robuste) ‚Äî si la variable est supprim√©e ailleurs,
// on force un fallback vide pour √©viter les plantages.
if (!Array.isArray(ETAGES)) { ETAGES = []; }

// Cat√©gories standards
var CATEGORIES = ['Prises','√âclairage','Circuit sp√©cialis√©','Sp√©cifique'];

// Modes de pose
var POSES = [
  'Encastr√© ma√ßonnerie','Placo','Semi-encastr√©',
  'Saillie avec moulure','Sous tube IRL','Sur-mesure'
];

// Sections de c√¢blage (avec option personnalis√©e)
var SECTIONS_CABLE = ['0,75 mm¬≤','1,5 mm¬≤','2,5 mm¬≤','6 mm¬≤','Personnalis√©e‚Ä¶'];

// D√©signations possibles par cat√©gorie
var DESIGNATIONS_PAR_CATEGORIE = {
  // <‚Äî pour Prises on ne s‚Äôen sert plus (d√©signation supprim√©e dans l‚ÄôUI)
  '√âclairage/Luminaires': ['Point de centre','Applique'],
  '√âclairage/Commandes': ['Interrupteur simple','Interrupteur double'],
  'Circuit sp√©cialis√©': [
    'Four','Plaque de cuisson','Lave-linge','Lave-vaisselle',
    'S√®che-linge','Cumulus','VMC','Chauffage','Climatisation',
    'Prise ext√©rieure √©tanche'
  ]
};

/* ============ TARIFS BASE (FT pos√©, hors coefficients) ============

  ‚Ä¢ PRISES : le prix de base est unique (par intervention)
  ‚Ä¢ √âCLAIRAGE : prix de base par d√©signation (point de centre, applique, etc.)
  ‚Ä¢ CIRCUIT SP√âCIALIS√â : prix de base UNIQUE (par intervention, *quel que soit* le circuit).
    Les sections appliquent un coefficient (voir COEFF_SECTIONS_CS).

  Tu pourras tout modifier plus tard dans le chapitre ‚ÄúParam√©trage tarifs‚Äù.
*/
var TARIFS_BASE = {
  prises: { // par intervention
    'Cr√©ation': 110,
    'Remplacement appareillage': 30,
    'Rec√¢blage avec remplacement appareillage': 85,
    'Rec√¢blage sans remplacement appareillage': 65
  },
  eclairage: { // par d√©signation
    'Point de centre': {
      'Cr√©ation': 100,
      'Remplacement luminaire': 30,
      'Rec√¢blage avec remplacement luminaire': 95,
      'Rec√¢blage sans remplacement luminaire': 65
    },
    'Applique': {
      'Cr√©ation': 100,
      'Remplacement luminaire': 30,
      'Rec√¢blage avec remplacement luminaire': 95,
      'Rec√¢blage sans remplacement luminaire': 65
    },
    'Interrupteur simple': {
      'Cr√©ation': 50,
      'Remplacement appareillage': 25,
      'Rec√¢blage avec remplacement appareillage': 75,
      'Rec√¢blage sans remplacement appareillage': 55
    },
    'Interrupteur double': {
      'Cr√©ation': 50,
      'Remplacement appareillage': 30,
      'Rec√¢blage avec remplacement appareillage': 85,
      'Rec√¢blage sans remplacement appareillage': 55
    }
  },
  circuit_specialise_base: { // un seul prix de base, par intervention
    'Cr√©ation': 110,
    'Remplacement appareillage': 30,
    'Rec√¢blage avec remplacement appareillage': 85,
    'Rec√¢blage sans remplacement appareillage': 65
  }
};

// Coefficients de POSE (appliqu√©s √† Prises, √âclairage et CS)
var COEFF_POSE = {
  'Placo': 1.00,
  'Encastr√© ma√ßonnerie': 1.50,
  'Semi-encastr√©': 1.40,
  'Sur-mesure': 1.60,
  'Saillie avec moulure': 1.35,
  'Sous tube IRL': 1.35
};

// Coefficients de SECTION pour CS :
// 0,75 et 1,5 ‚Üí 1.00 ; 2,5 ‚Üí +10% ; 6 ‚Üí +20%
var COEFF_SECTIONS_CS = {
  '0,75 mm¬≤': 1.00,
  '1,5 mm¬≤': 1.00,
  '2,5 mm¬≤': 1.20,
  '6 mm¬≤': 1.40
};

/* ============ Tableau & distribution (inchang√©) ============ */
var TARIFS_TABLEAU = {
  pose_base_13: { 1:70, 2:90, 3:110, 4:130 },
  coef: {
    modules: { 13:1.00, 18:1.30, 24:1.50 },
    pose: { 'Saillie':1.00, 'Encastr√©':1.70 },
    intervention: { 'Cr√©ation':1.00, 'Avec d√©pose de l‚Äôexistant':1.30 }
  },
  disjoncteurs: { 2:32, 10:25, 16:25, 20:25, 32:32, 40:45 },
  inter_diff: { '40A-AC':70, '40A-A':90, '63A-AC':110, '63A-A':130 },
  commandes: {
    'T√©l√©rupteur':60,
    'T√©l√©rupteur silencieux':80,
    'Horloge m√©canique + Disjoncteur 2A':90,
    'Horloge m√©canique + contacteur heures creuses + Disjoncteur 2A':140
  }
};

/* ============ Helpers PRIX communs ============ */

// Arrondi au 5 sup√©rieur (toujours vers le haut)
function roundUp5(x){
  x = +x || 0;
  return Math.ceil(x / 5) * 5;
}

// Renvoie le PU avec pose/section + arrondi au 5 sup√©rieur
// category : 'Prises' | '√âclairage/Luminaires' | '√âclairage/Commandes' | 'Circuit sp√©cialis√©'
function computePU(category, designation, intervention, pose, section){
  var base = 0;

  if(category === 'Prises'){
    base = (TARIFS_BASE.prises[intervention] || 0);

  } else if(category === '√âclairage/Luminaires' || category === '√âclairage/Commandes'){
    base = (TARIFS_BASE.eclairage[designation] && TARIFS_BASE.eclairage[designation][intervention]) || 0;

  } else if(category === 'Circuit sp√©cialis√©'){
    base = (TARIFS_BASE.circuit_specialise_base[intervention] || 0);
    // Coeff section
    var cSec = COEFF_SECTIONS_CS[section] || 1.00;
    base = base * cSec;
  }

  // Coeff pose
  var cPose = COEFF_POSE[pose] || 1.00;
  var total = base * cPose;

  // Arrondi 5 sup√©rieur
  return roundUp5(total);
}

// Back-compat : utilis√© ailleurs (estimatif‚Ä¶)
function getPrix(designation, intervention){
  // garde une compatibilit√© minimale si appel√© sans contexte
  // (ex : pr√©visualisation ancienne). On renvoie juste la base eclairage.
  var e = TARIFS_BASE.eclairage[designation];
  return e ? (e[intervention] || 0) : 0;
}
</script>


  







  



<!-- =============================
     CHAPITRE 3.2 : C≈íUR ‚Äî STOCKAGE & ROUTAGE UNIFI√âS (v3)
     Sommaire :
       ¬ß3.2.0 ‚Ä¢ Cl√©s, sch√©mas & helpers
       ¬ß3.2.1 ‚Ä¢ Devis courant : init / save / auto-save / reset
       ¬ß3.2.2 ‚Ä¢ Devis sauvegard√©s : CRUD + import/export + migration
       ¬ß3.2.3 ‚Ä¢ Factures (snapshots) : CRUD + transformation depuis un devis
     D√©pendances souples :
       - view(html) & b(label, onclick, className) pour l‚ÄôUI
       - pageHome() pour revenir √† l‚Äô√©diteur apr√®s cr√©ation/ouverture
       - Chapitre 10 (si pr√©sent) fournit les exports avanc√©s ; sinon fallback TXT minimal (Partie 2)
     ============================= -->

<!-- ¬ß3.2.0 ‚Ä¢ Cl√©s, sch√©mas & helpers -->
<script>
const KEY_CURRENT_DEVIS = 'devis_current_v3';
const KEY_SAVED_DEVIS   = 'saved_devis_v3';
const KEY_INVOICES      = 'invoices_v1';
const KEY_AUTOSAVE_OPTS = 'autosave_opts_v1';

function _lsGet(k, def){ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }catch(e){ return def; } }
function _lsSet(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){ alert('Stockage indisponible : '+e.message); } }
function _clone(x){ return JSON.parse(JSON.stringify(x)); }
function _newId(prefix){ return (prefix||'id_') + Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7); }
function _nowISO(){ return new Date().toISOString(); }
function _fmtBytes(n){ if(!n) return '0 o'; var u=['o','Ko','Mo','Go']; var i=Math.min(3, Math.floor(Math.log(n)/Math.log(1024))); return (n/Math.pow(1024,i)).toFixed(1)+' '+u[i]; }

// Fallbacks UI (si non d√©finis)
if(typeof window.b !== 'function'){
  window.b = function(label, onclick, cls){ return '<button class="'+(cls||'btn')+'" onclick="'+onclick+'">'+label+'</button>'; };
}
if(typeof window.view !== 'function'){
  window.view = function(html){ var el=document.getElementById('app')||document.body; el.innerHTML = '<div class="card">'+html+'</div>'; };
}

// Mod√®le de devis vide (m√©tadonn√©es min)
function _blankDevis(meta){
  return Object.assign({
    __id: _newId('dv_'),
    __name: (meta && meta.title) || 'Nouveau devis',
    __created_at: _nowISO(),
    __updated_at: _nowISO(),
    __mode: (meta && meta.mode) || 'devis', // 'devis' | 'facture' (info)
    __client: (meta && meta.client) || '',
    __chantier: (meta && meta.site) || '',
    __tva_applicable: true,
    __taux_tva: (meta && +meta.tva)||20
  }, {});
}
</script>

<!-- ¬ß3.2.1 ‚Ä¢ Devis courant : init / save / auto-save / reset -->
<script>
window.devis = window.devis || _blankDevis();
let _autosaveTimer = null;

function loadLocal(){
  var cur = _lsGet(KEY_CURRENT_DEVIS, null);
  if(!cur){ cur = _blankDevis(); _lsSet(KEY_CURRENT_DEVIS, cur); }
  window.devis = cur;
  return cur;
}
function saveLocal(){
  if(!window.devis) return;
  window.devis.__updated_at = _nowISO();
  _lsSet(KEY_CURRENT_DEVIS, window.devis);
}
function resetCurrent(meta){
  window.devis = _blankDevis(meta||{});
  saveLocal();
}
function startAutoSave(everyMs){
  try{ if(_autosaveTimer) clearInterval(_autosaveTimer); }catch(e){}
  var opts = _lsGet(KEY_AUTOSAVE_OPTS, { enabled:true, period:10000 });
  var period = +everyMs || +opts.period || 10000;
  if(opts.enabled!==false){
    _autosaveTimer = setInterval(function(){ try{ saveLocal(); }catch(e){} }, period);
  }
}
function setAutoSave(on, periodMs){
  var opts = _lsGet(KEY_AUTOSAVE_OPTS, { enabled:true, period:10000 });
  if(typeof on==='boolean') opts.enabled = on;
  if(periodMs) opts.period = Math.max(2000, +periodMs||10000);
  _lsSet(KEY_AUTOSAVE_OPTS, opts);
  startAutoSave();
}
</script>

<!-- ¬ß3.2.2 ‚Ä¢ Devis sauvegard√©s : CRUD + import/export + migration -->
<script>
function _listDevis(){ return _lsGet(KEY_SAVED_DEVIS, []); }
function _writeDevis(arr){ _lsSet(KEY_SAVED_DEVIS, arr||[]); }

function listSavedDevis(){ return _listDevis(); }

function saveCurrentAs(name, mode){
  var cur = _clone(window.devis || _blankDevis());
  if(name) cur.__name = String(name).trim() || cur.__name;
  if(mode) cur.__mode = mode;
  if(!cur.__id) cur.__id = _newId('dv_');
  cur.__updated_at = _nowISO();

  var list = _listDevis();
  var idx = list.findIndex(d=>d.__id===cur.__id);
  if(idx>=0) list[idx] = cur; else list.unshift(cur);
  _writeDevis(list);
  alert('‚úÖ Document sauvegard√©.');
  return cur.__id;
}

function saveCurrentAsNew(newName){
  var cur = _clone(window.devis || {});
  cur.__id = _newId('dv_');
  if(newName) cur.__name = String(newName).trim() || cur.__name;
  cur.__updated_at = _nowISO();
  var list = _listDevis(); list.unshift(cur); _writeDevis(list);
  alert('‚úÖ Nouvelle version cr√©√©e.');
  return cur.__id;
}

function loadDevis(id){
  var list = _listDevis();
  var found = list.find(d=>d.__id===id);
  if(!found){ alert('Devis introuvable.'); return; }
  window.devis = _clone(found);
  saveLocal();
  if(typeof pageHome==='function') pageHome();
  else view('<div class="card"><h2>Devis charg√©</h2><pre>'+found.__name+'</pre></div>');
}

function deleteDevis(id){
  if(!confirm('Supprimer ce devis ?')) return;
  _writeDevis(_listDevis().filter(d=>d.__id!==id));
  if(typeof pageSavedDevis==='function') pageSavedDevis(); else alert('Supprim√©.');
}

function renameDevis(id, newName){
  var list=_listDevis(); var d=list.find(x=>x.__id===id); if(!d) return;
  d.__name = (newName||'').trim() || d.__name;
  d.__updated_at=_nowISO();
  _writeDevis(list);
}

function duplicateDevis(id){
  var list=_listDevis(); var d=list.find(x=>x.__id===id); if(!d) return;
  var cp=_clone(d); cp.__id=_newId('dv_'); cp.__name=cp.__name+' (copie)'; cp.__updated_at=_nowISO();
  list.unshift(cp); _writeDevis(list);
}

function exportSavedDevis(){
  var raw = JSON.stringify(_listDevis(), null, 2);
  var blob = new Blob([raw], {type:'application/json;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a = document.createElement('a'); a.href=url; a.download='saved_devis.json'; a.click(); URL.revokeObjectURL(url);
}

function importSavedDevisUI(){
  var input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange=function(){
    var f=input.files && input.files[0]; if(!f) return;
    var rd=new FileReader();
    rd.onload=function(){
      try{
        var arr=JSON.parse(rd.result||'[]'); if(!Array.isArray(arr)) throw new Error('Format inattendu.');
        var map = {}; _listDevis().forEach(d=> map[d.__id]=d);
        arr.forEach(d=>{ if(d && d.__id) map[d.__id]=d; });
        _writeDevis(Object.values(map).sort(function(a,b){ return (b.__updated_at||'').localeCompare(a.__updated_at||''); }));
        alert('‚úÖ Import termin√©.');
        if(typeof pageSavedDevis==='function') pageSavedDevis();
      }catch(e){ alert('‚ùå Import impossible : '+e.message); }
    };
    rd.readAsText(f,'utf-8');
  };
  input.click();
}

// Migration simple depuis ancienne cl√© (exemple)
(function migrateOld(){
  try{
    var old = _lsGet('saved_devis_v2', null);
    if(old && Array.isArray(old) && !_lsGet(KEY_SAVED_DEVIS, null)){
      _writeDevis(old.map(function(d){
        d.__id = d.__id || _newId('dv_');
        d.__updated_at = d.__updated_at || _nowISO();
        return d;
      }));
      localStorage.removeItem('saved_devis_v2');
    }
  }catch(e){}
})();

// V√©rif quota (approx)
function checkStorageQuota(){
  try{
    var total=0;
    for(var i=0;i<localStorage.length;i++){
      var k=localStorage.key(i); var v=localStorage.getItem(k)||''; total += k.length + v.length;
    }
    alert('Espace localStorage estim√© : '+_fmtBytes(total));
  }catch(e){ alert('Quota inconnu : '+e.message); }
}
</script>

<!-- ¬ß3.2.3 ‚Ä¢ Factures (snapshots) : CRUD + transformation -->
<script>
function _listInvoices(){ return _lsGet(KEY_INVOICES, []); }
function _writeInvoices(arr){ _lsSet(KEY_INVOICES, arr||[]); }

function listInvoices(){ return _listInvoices(); }

function saveInvoiceSnapshot(fromDevis, mode){
  var snap = _clone(fromDevis||window.devis||_blankDevis());
  var inv = {
    __id: _newId('fac_'),
    created_at: _nowISO(),
    mode: mode || 'tout_compris',
    name: (snap.__name || 'Facture'),
    snapshot: snap
  };
  var list=_listInvoices(); list.unshift(inv); _writeInvoices(list);
  return inv.__id;
}

function deleteInvoice(id){
  if(!confirm('Supprimer cette facture ?')) return;
  _writeInvoices(_listInvoices().filter(x=>x.__id!==id));
  if(typeof pageFacturesAccueil==='function') pageFacturesAccueil();
}

function renameInvoice(id, newName){
  var list=_listInvoices(); var it=list.find(x=>x.__id===id); if(!it) return;
  it.name=(newName||'').trim()||it.name; _writeInvoices(list);
}

function duplicateInvoice(id){
  var list=_listInvoices(); var it=list.find(x=>x.__id===id); if(!it) return;
  var cp=_clone(it); cp.__id=_newId('fac_'); cp.name=cp.name+' (copie)'; cp.created_at=_nowISO();
  list.unshift(cp); _writeInvoices(list);
}

// Transformation : charger un devis en mode "facture" pour √©dition puis export
function transformDevisToInvoiceEdit(id){
  var list=_listDevis(); var d=list.find(x=>x.__id===id);
  if(!d){ alert('Devis introuvable.'); return; }
  var edited=_clone(d); edited.__mode='facture';
  window.devis = edited; saveLocal();
  if(typeof pageHome==='function') pageHome();
  else view('<div class="card"><h2>Facture (√©dition)</h2><p>Le devis est charg√© en mode facture.</p></div>');
}
</script>
  
  <!-- =============================
     CHAPITRE 3.2 (suite) : Pages + Exports fallback + Expose
     Sommaire (suite) :
       ¬ß3.2.4 ‚Ä¢ Pages : cr√©er un devis / une facture (formulaire court)
       ¬ß3.2.5 ‚Ä¢ Pages : Mes devis / Mes factures (listes + actions)
       ¬ß3.2.6 ‚Ä¢ Fallback export TXT & Expose (window)
     ============================= -->

<!-- ¬ß3.2.4 ‚Ä¢ Pages : cr√©er un devis / une facture -->
<script>
function _renderCreateForm(kind){
  var title = (kind==='facture') ? 'Cr√©er une nouvelle facture' : 'Cr√©er un nouveau devis';
  var hint  = (kind==='facture') ? 'Tu pourras √©diter puis exporter.' : 'Tu seras redirig√© vers l‚Äô√©diteur.';
  var tvaSel = [
    {v:20, label:'20 %'}, {v:10, label:'10 %'}, {v:5.5, label:'5,5 %'}
  ].map(o=>'<option value="'+o.v+'">'+o.label+'</option>').join('');
  view(
    '<div class="card">'
      + (typeof pageMain==='function' ? b('Retour','pageMain()','btn back') : '')
      + '<h2>'+title+'</h2>'
      + '<label>Nom du client</label><input id="c_client" placeholder="Ex : Martin SARL" />'
      + '<label style="margin-top:8px;">Lieu du chantier</label><input id="c_site" placeholder="Ex : 12 rue des Lilas, Lyon" />'
      + '<label style="margin-top:8px;">Taux de TVA</label><select id="c_tva">'+tvaSel+'</select>'
      + '<div class="row" style="margin-top:12px;">'
        + b('Continuer','_createDocConfirm(\''+kind+'\')','btn primary')
      + '</div>'
      + '<p class="muted" style="margin-top:8px;">'+hint+'</p>'
    + '</div>'
  );
}
function _createDocConfirm(kind){
  var client=(document.getElementById('c_client').value||'').trim();
  var site  =(document.getElementById('c_site').value||'').trim();
  var tva   = parseFloat(document.getElementById('c_tva').value)||20;

  resetCurrent({ title:(kind==='facture'?'Facture ‚Äî ':'Devis ‚Äî ')+ (client||'Sans nom'),
                 client, site, tva, mode:(kind==='facture'?'facture':'devis') });
  saveLocal();
  // on sauvegarde une premi√®re version dans la liste
  saveCurrentAs(window.devis.__name, window.devis.__mode);
  if(typeof pageHome==='function') pageHome(); else view('<div class="card"><h2>√âditeur</h2></div>');
}

function pageCreateDevis(){ _renderCreateForm('devis'); }
function pageCreateFacture(){ _renderCreateForm('facture'); }
</script>

<!-- ¬ß3.2.5 ‚Ä¢ Pages : Mes devis / Mes factures -->
<script>
function _safePromptRename(defaultName){
  var n = prompt('Nouveau nom :', defaultName||''); if(n==null) return null;
  return n.trim();
}

function pageSavedDevis(){
  var arr = listSavedDevis();
  var html = '<div class="card">'
    + (typeof pageMain==='function' ? b('Accueil','pageMain()','btn back') : '')
    + '<h2>Mes devis sauvegard√©s</h2>'
    + '<div class="row" style="gap:8px;margin:8px 0;">'
      + b('Exporter (JSON)','exportSavedDevis()','btn')
      + b('Importer (JSON)','importSavedDevisUI()','btn')
    + '</div>'
    + (arr.length? '<table class="table-mini" style="width:100%"><thead><tr>'
      +'<th>Nom</th><th>Client</th><th>Chantier</th><th>M√†J</th><th>Actions</th></tr></thead><tbody>' : '<p class="muted">Aucun devis sauvegard√©.</p>');

  arr.forEach(function(d){
    var when = new Date(d.__updated_at||d.__created_at||Date.now()).toLocaleString('fr-FR');
    html += '<tr>'
      + '<td><strong>'+ (d.__name||'Devis') +'</strong></td>'
      + '<td>'+ (d.__client||'‚Äî') +'</td>'
      + '<td>'+ (d.__chantier||'‚Äî') +'</td>'
      + '<td><small>'+ when +'</small></td>'
      + '<td>'
        + b('Ouvrir','loadDevis("'+d.__id+'")','btn')
        + b('Renommer','(function(){var n=_safePromptRename("'+(d.__name||'Devis').replace(/"/g,'&quot;')+'"); if(n!==null){ renameDevis("'+d.__id+'", n); pageSavedDevis(); }})()','btn')
        + b('Dupliquer','(function(){ duplicateDevis("'+d.__id+'"); pageSavedDevis(); })()','btn')
        + b('Transformer en facture (√©diter)','transformDevisToInvoiceEdit("'+d.__id+'")','btn')
        + b('Supprimer','(function(){ deleteDevis("'+d.__id+'"); })()','btn')
      + '</td>'
    + '</tr>';
  });

  if(arr.length) html += '</tbody></table>';
  html += '</div>';
  view(html);
}

function _fallbackInvoiceText(snap){
  var name=snap.__name||'Facture';
  var tvaOn = !!snap.__tva_applicable, taux = Math.max(0,+snap.__taux_tva||20);
  var totalHT=0;
  for(var k in snap){ if(k.indexOf('__')===0) continue; var s=snap[k]; var items=(s&&s.items)||[]; items.forEach(it=> totalHT += ((+it.prixU||0)*(+it.qty||0))); }
  var tva = tvaOn ? totalHT*taux/100 : 0;
  var out = [];
  out.push('FACTURE ‚Äî '+name);
  out.push('Date : '+new Date().toLocaleDateString('fr-FR'));
  out.push('Total HT : '+totalHT.toFixed(2)+' ‚Ç¨');
  if(tvaOn) out.push('TVA ('+taux+'%) : '+tva.toFixed(2)+' ‚Ç¨');
  out.push('Total TTC : '+(totalHT+tva).toFixed(2)+' ‚Ç¨');
  return out.join('\r\n');
}

function exportInvoiceSnapshotTXT(id, mode){
  // si Chap.10 fournit exportInvoiceFromStored, on l‚Äôutilise
  if(typeof window.exportInvoiceFromStored==='function'){ return window.exportInvoiceFromStored(id, mode==='sep'?'sep':'tc'); }
  // sinon fallback : retrouver l‚Äôitem et sortir un TXT simple
  var inv=listInvoices().find(x=>x.__id===id); if(!inv){ alert('Introuvable.'); return; }
  var txt=_fallbackInvoiceText(inv.snapshot||{});
  var a=document.createElement('a'); var url=URL.createObjectURL(new Blob([txt],{type:'text/plain;charset=utf-8'}));
  a.href=url; a.download=(inv.name||'facture')+'.txt'; a.click(); URL.revokeObjectURL(url);
}

function pageFacturesAccueil(){
  var arr = listInvoices();
  var html = '<div class="card">'
    + (typeof pageMain==='function' ? b('Accueil','pageMain()','btn back') : '')
    + '<h2>Mes factures</h2>';

  if(!arr.length){
    html += '<p class="muted">Aucune facture enregistr√©e pour le moment.</p>'
          + '<div class="row" style="gap:8px;margin-top:8px;">'
          +   b('Cr√©er une facture','pageCreateFacture()','btn primary')
          + '</div>';
    html += '</div>'; view(html); return;
  }

  html += '<table class="table-mini" style="width:100%"><thead><tr>'
      +'<th>Nom</th><th>Cr√©√©e le</th><th>Mode</th><th>Actions</th></tr></thead><tbody>';

  arr.forEach(function(inv){
    var d=new Date(inv.created_at).toLocaleString('fr-FR');
    html+='<tr>'
      +'<td><strong>'+ (inv.name||'Facture') +'</strong></td>'
      +'<td><small>'+ d +'</small></td>'
      +'<td>'+ (inv.mode==='separe'?'S√©par√©':'Tout compris') +'</td>'
      +'<td>'
        + b('Ouvrir (√©diter)','(function(){ window.devis=_clone('+JSON.stringify(inv).replace(/"/g,'&quot;')+'.snapshot); saveLocal(); if(typeof pageHome===\'function\'){ pageHome(); } })()','btn')
        + b('TXT (tout compris)','exportInvoiceSnapshotTXT("'+inv.__id+'","tc")','btn')
        + b('TXT (s√©par√©)','exportInvoiceSnapshotTXT("'+inv.__id+'","sep")','btn')
        + (typeof window.exportInvoiceCSVFromStored==='function'
            ? b('CSV (2 lignes)','exportInvoiceCSVFromStored("'+inv.__id+'")','btn')
            : '')
        + b('Renommer','(function(){ var n=_safePromptRename("'+(inv.name||'Facture').replace(/"/g,'&quot;')+'"); if(n!==null){ renameInvoice("'+inv.__id+'", n); pageFacturesAccueil(); } })()','btn')
        + b('Dupliquer','(function(){ duplicateInvoice("'+inv.__id+'"); pageFacturesAccueil(); })()','btn')
        + b('Supprimer','(function(){ deleteInvoice("'+inv.__id+'"); })()','btn')
      +'</td>'
    +'</tr>';
  });

  html += '</tbody></table></div>';
  view(html);
}
</script>

<!-- ¬ß3.2.6 ‚Ä¢ Expose (window) -->
<script>
Object.assign(window, {
  // Devis courant
  loadLocal, saveLocal, resetCurrent,
  startAutoSave, setAutoSave,

  // Devis list
  listSavedDevis, saveCurrentAs, saveCurrentAsNew,
  loadDevis, deleteDevis, renameDevis, duplicateDevis,
  exportSavedDevis, importSavedDevisUI, checkStorageQuota,

  // Factures
  listInvoices, saveInvoiceSnapshot, deleteInvoice,
  renameInvoice, duplicateInvoice, transformDevisToInvoiceEdit,
  exportInvoiceSnapshotTXT,

  // Pages
  pageCreateDevis, pageCreateFacture,
  pageSavedDevis, pageFacturesAccueil
});
</script>

  









  

  
<!-- =============================
     CHAPITRE 4 : MENU PRINCIPAL ‚Äî Instant Devis (UNIFI√â)
     Sommaire :
       ¬ß4.0 ‚Ä¢ Styles (local)
       ¬ß4.1 ‚Ä¢ Page principale (pageMain)
       ¬ß4.2 ‚Ä¢ Wrappers de navigation (sans r√©cursion, multi-alias)
       ¬ß4.3 ‚Ä¢ Sauvegarde auto + retour accueil
       ¬ß4.4 ‚Ä¢ Expose & auto-lancement
     ============================= -->
<script>
/* ============================
   ¬ß4.0 ‚Ä¢ Styles (local)
   ============================ */
(function(){
  var css = `
    .card { border:1px solid var(--line,#e6e6e6); border-radius:12px; background:#fff; padding:14px; margin-bottom:16px; }
    .title { font-size:22px; font-weight:700; margin-bottom:10px; }
    .section-title { font-size:18px; font-weight:600; margin:12px 0 6px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; }
    .muted { color:var(--muted,#666); font-size:14px; }
    .btn { border:none; border-radius:8px; background:#eee; padding:8px 14px; cursor:pointer; font-size:15px; }
    .btn.primary { background:#0a84ff; color:#fff; }
    .btn.ghost { background:#f6f6f6; }
    .btn.back { background:#ccc; }
  `;
  var s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);
})();

/* Small helper ‚Äúb(label, fnStr, cls)‚Äù attendu par l‚Äôapp */
if(typeof window.b!=='function'){
  window.b=function(label, fnStr, cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fnStr+'">'+label+'</button>'; };
}
/* Small helper view(html) attendu par l‚Äôapp */
if(typeof window.view!=='function'){
  window.view=function(html){ var el=document.getElementById('app'); if(el) el.innerHTML=html; };
}

/* ============================
   ¬ß4.1 ‚Ä¢ Page principale
   ============================ */
function pageMain(){
  var html =
  '<div class="card">'
    + '<h1 class="title" style="text-align:center;">Instant Devis</h1>'
  + '</div>'

  // === Cadre : cr√©ation d‚Äôun nouveau document ===
  + '<div class="card">'
    + '<div class="section-title">Cr√©er un nouveau document</div>'
    + '<div class="row">'
      + b('Cr√©er un nouveau devis','navCreateDevis()','btn primary')
      + b('Cr√©er une nouvelle facture','navCreateFacture()','btn')
      + b('Transformer un devis en facture','navTransformDevisFacture()','btn ghost')
    + '</div>'
  + '</div>'

  // === Cadre : documents sauvegard√©s ===
  + '<div class="card">'
    + '<div class="section-title">Mes documents sauvegard√©s</div>'
    + '<div class="row">'
      + b('Mes devis sauvegard√©s','navSavedDevis()','btn')
      + b('Mes factures sauvegard√©es','navSavedFactures()','btn')
    + '</div>'
  + '</div>'

  // === Cadre : configuration & param√®tres ===
  + '<div class="card">'
    + '<div class="section-title">Configuration & param√®tres</div>'
    + '<div class="row">'
      + b('Configuration entreprise','navCompanyConfig()','btn')
      + b('Pr√©f√©rences g√©n√©rales','navPrefs()','btn')
    + '</div>'
  + '</div>'

  // === Cadre : catalogue prestations / mat√©riel & tarifs ===
  + '<div class="card">'
    + '<div class="section-title">Catalogue prestations / mat√©riel & tarifs</div>'
    + '<div class="row">'
      + b('Catalogue prestations','navCataloguePrestations()','btn primary')
      + b('Tarifs & coefficients','navTarifsCoeffs()','btn')
      + b('Catalogue mat√©riel','navCatalogueMateriel()','btn')
    + '</div>'
  + '</div>'

  + '<div class="card muted">'
    + '<p>Version 3.0 ‚Äî Tous droits r√©serv√©s ¬© Alba Elec</p>'
  + '</div>';

  view(html);
}

/* ============================
   ¬ß4.2 ‚Ä¢ Wrappers de navigation
   - IMPORTANT : noms ‚Äúnav*‚Äù ‚â† cibles r√©elles ‚Üí z√©ro r√©cursion
   - Chaque wrapper teste plusieurs alias potentiels
   ============================ */
function _goOneOf(){
  for(var i=0;i<arguments.length;i++){
    var fnName = arguments[i];
    if(typeof window[fnName] === 'function'){ return window[fnName](); }
  }
  alert('‚ö†Ô∏è Fonction manquante : '+(arguments[0]||'inconnue')+' ‚Äî chapitre non encore charg√©.');
}

function navCreateDevis(){
  // Aliases possibles de l‚Äôassistant de cr√©ation d‚Äôun devis
  _goOneOf('pageCreateDevis','pageNewDevisWizard','pageNewDevis');
}
function navCreateFacture(){
  // Aliases possibles de l‚Äôassistant de cr√©ation d‚Äôune facture
  _goOneOf('pageCreateFacture','pageNewFactureWizard','pageNewFacture');
}
function navTransformDevisFacture(){
  // Soit une page ‚Äútransformer‚Äù, soit la liste des devis (puis choix)
  _goOneOf('pageTransformDevisFacture','pageSavedDevis','pageSavedDevisAccueil');
}
function navSavedDevis(){
  // Liste des devis sauvegard√©s
  _goOneOf('pageSavedDevis','pageSavedDevisAccueil');
}
function navSavedFactures(){
  // Liste des factures sauvegard√©es (chapitre facturation)
  // Dans nos chapitres, la vraie page s‚Äôappelle ‚ÄúpageFacturesAccueil‚Äù
  _goOneOf('pageFacturesAccueil','pageFacturesHome','pageInvoicesHome');
}
function navCompanyConfig(){
  // Configuration entreprise
  _goOneOf('pageConfigEntreprise','pageCompanyConfig');
}
function navPrefs(){
  // Pr√©f√©rences g√©n√©rales
  _goOneOf('pagePreferences','pagePrefsGenerales','pageConfigPreferences');
}
function navCataloguePrestations(){
  // Catalogue des prestations (structuration des types)
  _goOneOf('pageCataloguePrestations','pageCatalogue','pageConfigCataloguePrestations');
}
function navTarifsCoeffs(){
  // Tarifs & coefficients (impacte les PU/estimatif)
  _goOneOf('pageTarifsEtCoeffs','pageTarifsAccueil','pageConfigTarifsCoeffs');
}
function navCatalogueMateriel(){
  // Catalogue mat√©riel (marques/gammes/prix)
  _goOneOf('pageCatalogueMateriel','pageConfigCatalogueMateriel');
}

/* ============================
   ¬ß4.3 ‚Ä¢ Sauvegarde auto + retour accueil
   ============================ */
function goAccueil(){
  // Si une auto-save existe dans l‚Äôapp, on l‚Äôutilise
  if(typeof window.startAutoSave==='function'){
    // L‚Äôapp sauvegarde d√©j√† p√©riodiquement ‚Üí retour direct
    pageMain();
    return;
  }
  // Sinon on prot√®ge le retour si un devis courant est pr√©sent
  var hasDirty = (window.devis && Object.keys(window.devis).some(k=>k.indexOf('__')!==0));
  if(hasDirty){
    if(confirm('Revenir √† l‚Äôaccueil ? Les modifications non sauvegard√©es pourraient √™tre perdues.')){
      pageMain();
    }
  } else {
    pageMain();
  }
}
function goHomeConfirm(){ goAccueil(); }

/* ============================
   ¬ß4.4 ‚Ä¢ Expose & auto-lancement
   ============================ */
Object.assign(window, {
  pageMain,
  goAccueil,
  goHomeConfirm,
  navCreateDevis,
  navCreateFacture,
  navTransformDevisFacture,
  navSavedDevis,
  navSavedFactures,
  navCompanyConfig,
  navPrefs,
  navCataloguePrestations,
  navTarifsCoeffs,
  navCatalogueMateriel
});

// Auto-lancement (s‚Äôil n‚Äôy a encore aucune vue)
(function(){
  function boot(){
    var app = document.getElementById('app');
    if(app && String(app.innerHTML||'').trim()===''){ pageMain(); }
  }
  if(document.readyState==='complete') setTimeout(boot, 100);
  else window.addEventListener('load', boot);
})();
</script>






  




  
  


<!-- =============================
     CHAPITRE 5 : ACCUEIL & FLUX PI√àCES ‚Äî V5 one-page (MAJ : masquage pose/section hors Cr√©ation)
     Index :
       ¬ß5.0 ‚Ä¢ Helpers & router
       ¬ß5.1 ‚Ä¢ Accueil & liste des pi√®ces
       ¬ß5.2 ‚Ä¢ Ajout d‚Äôune pi√®ce
       ¬ß5.3 ‚Ä¢ D√©tail de pi√®ce & cat√©gories
       ¬ß5.4 ‚Ä¢ Cat√©gories & saisie one-shot (masquage dynamique)
       ¬ß5.5 ‚Ä¢ Sp√©cifique & notes
     ============================= -->

<!-- 5.0 ‚Äî Helpers & router -->
<script>
function goVent(){
  if (typeof pageVentAccueil === 'function') pageVentAccueil();
  else alert('La section Ventilation n‚Äôest pas encore charg√©e.');
}
function _badge(txt){ return txt ? '<span class="badge">'+txt+'</span>' : ''; }
</script>

<!-- 5.1 ‚Äî Accueil & liste des pi√®ces -->
<script>
function pageHome(){
  var keys = Object.keys(devis).filter(k=>k.indexOf('__')!==0);
  var listHtml = keys.length ? keys.map(function(key){
    var s = devis[key] || {};
    var label = pieceDisplayLabel(key);
    return '<div class="pill">'
      +'<strong>'+label+'</strong> '
      +'<small>'+((s.items||[]).length)+' ligne(s)</small> '
      + _badge(s.qualificatif && s.qualificatif.trim())
      + _badge(s.etage && s.etage.trim())
      + b('Ouvrir','goPiece('+JSON.stringify(key)+')','btn')
      + b('Supprimer','removePiece('+JSON.stringify(key)+')','btn')
    +'</div>';
  }).join('') : '<p class="muted">Aucune pi√®ce ajout√©e pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      +'<h2>Accueil</h2>'
      +'<div class="row">'
        + b('Ajouter une pi√®ce','pageAddPiece()','btn primary')
        + b('Cr√©er un tableau','pageTabCreate()','btn')
        + b('Ventilation','goVent()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Pi√®ces & Tableaux ajout√©s</h2>'
      +'<div class="list">'+listHtml+'</div>'
    +'</div>'
    +'<div class="row" style="margin-top:12px;">'
      + b('Voir l‚Äôestimatif','pageEstimatif()','btn')
      + b('Voir les totaux','pageTotaux()','btn')
    +'</div>'
  );
}

function goPiece(key){
  ctx = { piece:key, category:null, intervention:null, pose:null, designation:null };
  ensureSection(key);

  var cats = ['Prises','√âclairage','Circuit sp√©cialis√©']
    .map(c=> b(c,'goCategory('+JSON.stringify(c)+')','btn'))
    .join('');

  var s = devis[key];
  var lignes = (s.items||[]).length
    ? '<ul>'+s.items.map(function(it,i){
        var total = (+it.prixU||0) * (+it.qty||0);
        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? ' ‚Äî '+String(it.pose).toLowerCase() : '';
        var unitTxt = it.unit || 'u';
        var left = it.intervention ? (it.intervention+' ‚Äî ') : '';
        return '<li>'
          + left + it.designation + poseTxt
          +' ('+it.qty+' '+unitTxt+' √ó '+euro(it.prixU)+' = '+euro(total)+') '
          + b('√ó','delLine('+JSON.stringify(key)+','+i+')','btn')
        +'</li>';
      }).join('') + '</ul>'
    : '<p class="muted">Aucune ligne pour l‚Äôinstant.</p>';

  var label = pieceDisplayLabel(key);
  var noteTxt = s.note ? '<em class="muted">Note : '+s.note+'</em>' : '<span class="muted">Aucune note</span>';

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      +'<h2>'+label+'</h2>'
      +'<div class="row">'+cats+b('Sp√©cifique','pageSpecifiqueForm()','btn ghost')+'</div>'
      +'<div class="row" style="margin-top:10px;">'+b('Ajouter / modifier la note','editPieceNote()','btn')+'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Lignes de la pi√®ce</h2>'+lignes
      +'<p style="margin-top:8px;">'+noteTxt+'</p>'
    +'</div>'
  );
}

function delLine(key, idx){
  (devis[key].items||[]).splice(idx,1); saveLocal(); goPiece(key);
}
function removePiece(key){
  if(confirm('Supprimer la pi√®ce ¬´ '+pieceDisplayLabel(key)+' ¬ª et toutes ses lignes ?')){
    delete devis[key]; saveLocal(); pageHome();
  }
}
</script>

<!-- 5.2 ‚Äî Ajout d‚Äôune pi√®ce -->
<script>
function pageAddPiece(){
  var opts = PIECES_PREDEFINIES.map(p=>'<option value="'+p+'">'+p+'</option>').join('')
           + '<option value="__NEW__">‚ûï Cr√©er une nouvelle pi√®ce‚Ä¶</option>';
  var safeEtages = (window.ETAGES && Array.isArray(ETAGES) && ETAGES.length)
      ? ['(aucun)'].concat(ETAGES)
      : ['(aucun)','RDC','R+1','R+2','Sous-sol','Combles','Ext√©rieur'];
  var etageOpts = safeEtages.map(e=>'<option value="'+e+'">'+e+'</option>').join('');

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Ajouter une pi√®ce</h2>'
      + '<label>Choisir une pi√®ce</label>'
      + '<select id="piece-choice">'+opts+'</select>'
      + '<label style="margin-top:10px;">Qualificatif (optionnel)</label>'
      + '<input id="piece-qualif" placeholder="ex : Parents, RDC, gauche" />'
      + '<label style="margin-top:10px;">√âtage (optionnel)</label>'
      + '<select id="piece-etage">'+etageOpts+'</select>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Valider','confirmPieceChoice()','btn primary')
      + '</div>'
    + '</div>'
  );
}
function confirmPieceChoice(){
  var sel    = document.getElementById('piece-choice').value;
  var qualif = (document.getElementById('piece-qualif').value || '').trim();
  var etage  = document.getElementById('piece-etage').value;
  if(!sel) return;
  var base = sel;
  if(sel==='__NEW__'){
    base = (prompt('Nom de la pi√®ce :','') || '').trim();
    if(!base) return;
  }
  var etageVal = (etage && etage!=='(aucun)') ? etage : '';
  var key = createOrGetPiece(base, qualif, etageVal);
  goPiece(key);
}
</script>

<!-- 5.3 ‚Äî Cat√©gories & sous-menu √âclairage -->
<script>
function goCategory(cat){
  if (cat === '√âclairage') return goEclairageSub();
  ctx.category = cat;
  pageOneShotSelection();
}
function goEclairageSub(){
  view(
    '<div class="card">'
      + b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      + '<h2>√âclairage ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<div class="row">'
        + b('Luminaires','setEclairageBranch('+JSON.stringify('√âclairage/Luminaires')+')','btn')
        + b('Commandes','setEclairageBranch('+JSON.stringify('√âclairage/Commandes')+')','btn')
      + '</div>'
    + '</div>'
  );
}
function setEclairageBranch(branch){
  ctx.category = branch;
  pageOneShotSelection();
}
</script>

<!-- 5.4 ‚Äî Saisie ‚Äúone-shot‚Äù (masquage dynamique pose/section hors Cr√©ation) -->
<script>
function pageOneShotSelection(){
  var cat = ctx.category;

  // 1) Interventions par cat√©gorie
  var invs = [];
  if(cat==='Prises' || cat==='Circuit sp√©cialis√©'){
    invs = [
      'Cr√©ation',
      'Remplacement appareillage',
      'Rec√¢blage avec remplacement appareillage',
      'Rec√¢blage sans remplacement appareillage'
    ];
  } else if(cat==='√âclairage/Luminaires'){
    invs = [
      'Cr√©ation',
      'Remplacement luminaire',
      'Rec√¢blage avec remplacement luminaire',
      'Rec√¢blage sans remplacement luminaire'
    ];
  } else if(cat==='√âclairage/Commandes'){
    invs = [
      'Cr√©ation',
      'Remplacement appareillage',
      'Rec√¢blage avec remplacement appareillage',
      'Rec√¢blage sans remplacement appareillage'
    ];
  } else {
    invs = ['Cr√©ation'];
  }
  var invOpts = invs.map(i=>'<option value="'+i+'">'+i+'</option>').join('');

  // 2) D√©signation
  var desigHtml = '', defaultDesignation = '';
  if(cat==='Prises'){
    defaultDesignation = 'Prise';
    desigHtml = '<div class="pill"><strong>D√©signation : Prise</strong></div>';
  } else if(cat==='√âclairage/Luminaires' || cat==='√âclairage/Commandes'){
    var list = DESIGNATIONS_PAR_CATEGORIE[cat] || ['√âl√©ment'];
    defaultDesignation = list[0];
    desigHtml = '<label style="margin-top:10px;">D√©signation</label>'
              + '<select id="oneshot-desig">'
              + list.map(d=>'<option value="'+d+'">'+d+'</option>').join('')+'</select>';
  } else if(cat==='Circuit sp√©cialis√©'){
    defaultDesignation = 'Circuit sp√©cialis√©';
    desigHtml = '<label style="margin-top:10px;">Libell√© (optionnel)</label>'
              + '<input id="oneshot-custom-desig" placeholder="ex : Four, PAC‚Ä¶ (facultatif)" />';
  } else {
    defaultDesignation = '√âl√©ment';
    desigHtml = '<label>D√©signation</label><input id="oneshot-custom-desig" placeholder="√âl√©ment" />';
  }

  // 3) Pose (sera masqu√©e si intervention ‚â† Cr√©ation)
  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var poseBlock = '<div id="oneshot-pose-wrap">'
                +   '<label>Type de pose</label><select id="oneshot-pose">'+poseOpts+'</select>'
                + '</div>';

  // 4) Section (CS uniquement, et masqu√©e si intervention ‚â† Cr√©ation)
  var sectionBlock = '';
  if(cat==='Circuit sp√©cialis√©'){
    var sectOpts = SECTIONS_CABLE.map(s=>'<option value="'+s+'">'+s+'</option>').join('');
    sectionBlock = '<div id="oneshot-section-wrap" style="margin-top:10px;">'
                 +   '<label>Section</label><select id="oneshot-section">'+sectOpts+'</select>'
                 + '</div>';
  }

  // 5) Quantit√©
  var qtyOpts = Array.from({length:30},(_,i)=>'<option '+(i===0?'selected':'')+'>'+(i+1)+'</option>').join('');

  // UI
  var backFn = (cat && cat.indexOf('√âclairage/')===0) ? 'goEclairageSub()' : 'goPiece('+JSON.stringify(ctx.piece)+')';
  view(
    '<div class="card">'
      + b('Retour', backFn, 'btn back')
      + '<h2>'+cat+' ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<label>Intervention</label><select id="oneshot-interv">'+invOpts+'</select>'
      + desigHtml
      + poseBlock
      + sectionBlock
      + '<label style="margin-top:10px;">Quantit√©</label>'
      + '<select id="oneshot-qty">'+qtyOpts+'</select>'
      + '<div id="oneshot-preview" class="muted" style="margin-top:10px;"></div>'
      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveOneShotItem(false)','btn primary')
        + b('Ajouter et rester','saveOneShotItem(true)','btn')
      + '</div>'
    + '</div>'
  );

  // ----- Comportement : masquage dynamique selon intervention
  function isCreation(interv){ return String(interv||'')==='Cr√©ation'; }

  function applyInterventionVisibility(){
    var interv = document.getElementById('oneshot-interv').value;
    var poseWrap = document.getElementById('oneshot-pose-wrap');
    var sectionWrap = document.getElementById('oneshot-section-wrap');

    // Pose : visible uniquement en Cr√©ation (toutes cat√©gories)
    if(poseWrap){
      poseWrap.style.display = isCreation(interv) ? '' : 'none';
    }
    // Section : visible uniquement en Cr√©ation ET cat√©gorie = Circuit sp√©cialis√©
    if(sectionWrap){
      sectionWrap.style.display = (isCreation(interv) && cat==='Circuit sp√©cialis√©') ? '' : 'none';
    }
    refreshPreview(); // tenir compte du masquage dans le calcul
  }

  // ----- Aper√ßu PU/Total
  function refreshPreview(){
    var interv = document.getElementById('oneshot-interv').value;

    // D√©signation choisie
    var desig  = defaultDesignation;
    var selDes = document.getElementById('oneshot-desig');
    var custom = document.getElementById('oneshot-custom-desig');
    if(selDes) desig = selDes.value;
    if(custom && custom.value.trim()) desig = custom.value.trim();

    // Pose / Section : seulement si visibles (Cr√©ation)
    var poseEl = document.getElementById('oneshot-pose-wrap');
    var sectionEl = document.getElementById('oneshot-section-wrap');

    var pose   = (poseEl && poseEl.style.display!=='none') ? (document.getElementById('oneshot-pose').value||'') : '';
    var section= (sectionEl && sectionEl.style.display!=='none') ? ((document.getElementById('oneshot-section')||{}).value||'') : '';

    var pu = (typeof computePU==='function') ? computePU(cat, desig, interv, pose, section) : 0;
    var q  = parseInt(document.getElementById('oneshot-qty').value,10)||1;
    document.getElementById('oneshot-preview').innerHTML = 'PU : '+euro(pu)+' ‚Äî Total : '+euro(pu*q);
  }

  // Events
  ['oneshot-interv','oneshot-pose','oneshot-section','oneshot-desig','oneshot-custom-desig','oneshot-qty']
    .forEach(function(id){ var el=document.getElementById(id); if(el) el.addEventListener('input', function(){ 
      if(id==='oneshot-interv') applyInterventionVisibility(); else refreshPreview();
    }); });

  // Init
  applyInterventionVisibility();
}

function saveOneShotItem(stayHere){
  var cat  = ctx.category;
  var interv = document.getElementById('oneshot-interv').value;

  // Si non Cr√©ation ‚Üí ne pas prendre pose/section
  var poseWrap = document.getElementById('oneshot-pose-wrap');
  var sectionWrap = document.getElementById('oneshot-section-wrap');

  var pose   = (poseWrap && poseWrap.style.display!=='none') ? (document.getElementById('oneshot-pose').value||'') : '';
  var section= (sectionWrap && sectionWrap.style.display!=='none') ? ((document.getElementById('oneshot-section')||{}).value||'') : '';

  var qty    = parseInt(document.getElementById('oneshot-qty').value,10)||1;

  var desig = '√âl√©ment';
  if(cat==='Prises'){ desig='Prise'; }
  else {
    var selDes = document.getElementById('oneshot-desig');
    var custom = document.getElementById('oneshot-custom-desig');
    if(selDes) desig = selDes.value;
    if(custom && custom.value.trim()) desig = custom.value.trim();
  }

  var pu = (typeof computePU==='function') ? computePU(cat, desig, interv, pose, section) : 0;

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category: cat,
    intervention: interv,
    pose: pose, // vide si non Cr√©ation (d‚Äôo√π affichage coh√©rent en liste)
    designation: (cat==='Circuit sp√©cialis√©' && desig==='Circuit sp√©cialis√©')
                  ? (desig + (section?(' ‚Äî '+section):'')) : desig + (section?(' ‚Äî '+section):''),
    qty: qty,
    prixU: pu,
    __tabKey: ctx.piece
  });
  saveLocal();
  if(stayHere){ pageOneShotSelection(); } else { goPiece(ctx.piece); }
}
</script>

<!-- 5.5 ‚Äî Sp√©cifique & notes -->
<script>
function pageSpecifiqueForm(){
  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var invOpts   = ['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage']
                    .map(i=>'<option value="'+i+'">'+i+'</option>').join('');
  view(
    '<div class="card">'
      + b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      + '<h2>Sp√©cifique ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<label>Intervention</label><select id="sp-interv">'+invOpts+'</select>'
      + '<label style="margin-top:10px;">Nom</label>'
      + '<input id="sp-label" placeholder="ex : Bandeau LED, Pompe piscine‚Ä¶" />'
      + '<label style="margin-top:10px;">Type de pose</label><select id="sp-pose">'+poseOpts+'</select>'
      + '<label style="margin-top:10px;">Prix unitaire (‚Ç¨)</label><input id="sp-price" type="number" inputmode="decimal" placeholder="0" />'
      + '<label style="margin-top:10px;">Quantit√©</label><input id="sp-qty" type="number" inputmode="numeric" min="1" value="1" />'
      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveSpecifique(false)','btn primary')
        + b('Ajouter et rester','saveSpecifique(true)','btn')
      + '</div>'
    + '</div>'
  );
}
function saveSpecifique(stayHere){
  var label = (document.getElementById('sp-label').value||'').trim();
  if(!label){ alert('Nom requis.'); return; }
  var pose  = document.getElementById('sp-pose').value || '';
  var interv= document.getElementById('sp-interv').value || 'Cr√©ation';
  var prix  = parseFloat(document.getElementById('sp-price').value)||0;
  var qty   = Math.max(1, parseInt(document.getElementById('sp-qty').value,10) || 1);

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category:'Sp√©cifique',
    intervention:interv,
    pose:pose,
    designation:label,
    qty:qty,
    prixU:roundUp5(prix),
    __tabKey: ctx.piece
  });
  saveLocal();
  if(stayHere){ pageSpecifiqueForm(); } else { goPiece(ctx.piece); }
}

function editPieceNote(){
  ensureSection(ctx.piece);
  var cur = devis[ctx.piece].note || '';
  var n = prompt('Note pour '+pieceDisplayLabel(ctx.piece), cur);
  if(n!==null) devis[ctx.piece].note = n.trim();
  saveLocal();
  goPiece(ctx.piece);
}
</script>












  

  <!-- =============================
     CHAPITRE 5 bis : CR√âATION DEVIS/FACTURE, TRANSFORMATION & BOUTONS ‚ÄúG√âN√âRER‚Äù
     Index :
       ¬ß6.0 ‚Ä¢ Helpers (LS, dates, TVA, autosave)
       ¬ß6.1 ‚Ä¢ Formulaire ‚ÄúNouveau devis‚Äù (client, lieu, TVA)
       ¬ß6.2 ‚Ä¢ Formulaire ‚ÄúNouvelle facture‚Äù (client, lieu, TVA)
       ¬ß6.3 ‚Ä¢ Transformer un devis sauvegard√© en facture
       ¬ß6.4 ‚Ä¢ Injection des boutons ‚ÄúG√©n√©rer devis / facture‚Äù dans l‚ÄôAccueil (Chap.5)
       ¬ß6.5 ‚Ä¢ Expose (window)
     ============================= -->
<script>
/* ============================
   ¬ß6.0 ‚Ä¢ Helpers
   ============================ */
const KEY_SAVED_DEVIS_A = 'savedDevis_v2'; // formats pr√©c√©dents possibles
const KEY_SAVED_DEVIS_B = 'savedDevis';    // fallback si l‚Äôappli existante l‚Äôutilise

function _lsRead(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function _lsWrite(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

function _todayFR6(){
  try{ return new Date().toLocaleDateString('fr-FR', {year:'numeric',month:'2-digit',day:'2-digit'}); }
  catch(e){ return new Date().toLocaleDateString(); }
}
function _round2(n){ return Math.round((+n||0)*100)/100; }

function _parseTVAChoice(val){
  // val ‚àà {'20','10','5.5','0'} ‚Üí {on:boolean,taux:number}
  var t = String(val||'20').replace(',','.');
  var taux = Math.max(0, parseFloat(t) || 20);
  return { on: taux>0, taux: taux };
}

// Sauvegarde locale de l'√©tat courant (si saveLocal n‚Äôexiste pas d√©j√†)
function saveLocalSafe(){
  if(typeof saveLocal === 'function'){ try{ saveLocal(); }catch(e){}; return; }
  try{ localStorage.setItem('devis_current', JSON.stringify(window.devis||{})); }catch(e){}
}
function loadLocalSafe(){
  if(typeof loadLocal === 'function'){ try{ loadLocal(); return; }catch(e){}; }
  try{ window.devis = JSON.parse(localStorage.getItem('devis_current')||'{}') || {}; }catch(e){ window.devis={}; }
}

// Autosave toutes les 10 s (si un devis/facture est en cours)
let _autosaveTimer6 = null;
function startAutoSave6(){
  stopAutoSave6();
  _autosaveTimer6 = setInterval(function(){
    if(window.devis && Object.keys(window.devis).length){
      saveLocalSafe();
    }
  }, 10000);
}
function stopAutoSave6(){ if(_autosaveTimer6){ clearInterval(_autosaveTimer6); _autosaveTimer6=null; } }

/* Mod√®le ‚Äúsquelette‚Äù de document */
function _newDocSkeleton(kind, meta){
  // kind: 'devis' | 'facture'
  var tva = _parseTVAChoice(meta.tva || '20');
  return {
    __id: 'doc_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8),
    __kind: kind, // indicatif, non bloquant
    __created_at: new Date().toISOString(),
    __name: (meta.title||'Document').trim(),
    __client: (meta.client||'').trim(),
    __lieu: (meta.lieu||'').trim(),
    __tva_applicable: !!tva.on,
    __taux_tva: _round2(tva.taux),
    // Contenu ‚Äúpi√®ces / tableaux‚Äù
    // Chaque cl√© (hors __*) repr√©sente une pi√®ce avec {items:[]...}
  };
}

/* ============================
   ¬ß6.1 ‚Ä¢ Nouveau devis
   ============================ */
function pageCreateDevis(){
  var tvaOpts = [
    {v:'20',  l:'20 %'},
    {v:'10',  l:'10 %'},
    {v:'5.5', l:'5,5 %'},
    {v:'0',   l:'TVA non applicable'}
  ].map(o=>'<option value="'+o.v+'">'+o.l+'</option>').join('');

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Nouveau devis</h2>'
      + '<label>Nom du client</label>'
      + '<input id="nd-client" placeholder="ex : M. et Mme Dupont" />'
      + '<label style="margin-top:10px;">Lieu du chantier</label>'
      + '<input id="nd-lieu" placeholder="ex : 12 rue des Fleurs, 75000 Paris" />'
      + '<label style="margin-top:10px;">TVA applicable</label>'
      + '<select id="nd-tva">'+tvaOpts+'</select>'
      + '<label style="margin-top:10px;">Titre du devis</label>'
      + '<input id="nd-title" placeholder="ex : Devis Dupont ‚Äî R√©novation T3" />'
      + '<div class="row" style="margin-top:12px;">'
        + b('Continuer','createDevisConfirm()','btn primary')
        + b('Retour √† l‚Äôaccueil','pageMain()','btn')
      + '</div>'
    + '</div>'
  );
}
function createDevisConfirm(){
  var meta = {
    client: (document.getElementById('nd-client').value||'').trim(),
    lieu:   (document.getElementById('nd-lieu').value||'').trim(),
    tva:    (document.getElementById('nd-tva').value||'20'),
    title:  (document.getElementById('nd-title').value||'Devis').trim() || 'Devis'
  };
  window.devis = _newDocSkeleton('devis', meta);
  // Nom de la premi√®re section ‚ÄúDivers‚Äù par d√©faut
  devis['Divers'] = { __base:'Divers', items:[] };

  saveLocalSafe();
  startAutoSave6();

  // On encha√Æne vers l‚Äôaccueil (Chap.5) pour ajouter des pi√®ces & lignes
  if(typeof pageHome === 'function') pageHome(); else alert('Devis cr√©√© ‚Äî charge la page d‚Äôaccueil pour continuer.');
}

/* ============================
   ¬ß6.2 ‚Ä¢ Nouvelle facture
   ============================ */
function pageCreateFacture(){
  var tvaOpts = [
    {v:'20',  l:'20 %'},
    {v:'10',  l:'10 %'},
    {v:'5.5', l:'5,5 %'},
    {v:'0',   l:'TVA non applicable'}
  ].map(o=>'<option value="'+o.v+'">'+o.l+'</option>').join('');

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Nouvelle facture</h2>'
      + '<label>Nom du client</label>'
      + '<input id="nf-client" placeholder="ex : M. et Mme Dupont" />'
      + '<label style="margin-top:10px;">Lieu du chantier</label>'
      + '<input id="nf-lieu" placeholder="ex : 12 rue des Fleurs, 75000 Paris" />'
      + '<label style="margin-top:10px;">TVA applicable</label>'
      + '<select id="nf-tva">'+tvaOpts+'</select>'
      + '<label style="margin-top:10px;">Titre de la facture</label>'
      + '<input id="nf-title" placeholder="ex : Facture Dupont ‚Äî R√©novation T3" />'
      + '<div class="row" style="margin-top:12px;">'
        + b('Continuer','createFactureConfirm()','btn primary')
        + b('Retour √† l‚Äôaccueil','pageMain()','btn')
      + '</div>'
    + '</div>'
  );
}
function createFactureConfirm(){
  var meta = {
    client: (document.getElementById('nf-client').value||'').trim(),
    lieu:   (document.getElementById('nf-lieu').value||'').trim(),
    tva:    (document.getElementById('nf-tva').value||'20'),
    title:  (document.getElementById('nf-title').value||'Facture').trim() || 'Facture'
  };
  window.devis = _newDocSkeleton('facture', meta);
  devis['Divers'] = { __base:'Divers', items:[] };

  saveLocalSafe();
  startAutoSave6();

  if(typeof pageHome === 'function') pageHome(); else alert('Facture cr√©√©e ‚Äî charge la page d‚Äôaccueil pour ajouter des lignes.');
}

/* ============================
   ¬ß6.3 ‚Ä¢ Transformer un devis sauvegard√© en facture
   ============================ */
function _readSavedDevisList6(){
  // Essaie plusieurs formats connus
  var a = _lsRead(KEY_SAVED_DEVIS_A, null);
  if(Array.isArray(a) && a.length) return a;

  var b = _lsRead(KEY_SAVED_DEVIS_B, null);
  if(Array.isArray(b) && b.length) return b;

  // Fallback : aucun
  return [];
}

function pageTransformDevisFacture(){
  var list = _readSavedDevisList6();
  if(!list.length){
    view(
      '<div class="card">'
        + b('Retour','pageMain()','btn back')
        + '<h2>Transformer un devis en facture</h2>'
        + '<p class="muted">Aucun devis sauvegard√© n‚Äôa √©t√© trouv√©.</p>'
        + '<div class="row" style="margin-top:10px;">'
          + b('Aller √† ‚ÄúMes devis sauvegard√©s‚Äù','(typeof pageSavedDevis==="function"?pageSavedDevis():pageMain())','btn')
          + b('Retour √† l‚Äôaccueil','pageMain()','btn')
        + '</div>'
      + '</div>'
    );
    return;
  }
  var rows = list.map(function(entry, idx){
    // On essaie d‚Äôattraper un titre; diff√©rents formats possibles
    var title = entry.__name || entry.name || (entry.devis && entry.devis.__name) || ('Devis #'+(idx+1));
    var created = entry.__created_at || entry.created_at || '';
    var dateTxt = created ? new Date(created).toLocaleString('fr-FR') : '';
    return '<tr>'
      + '<td>'+title+'</td>'
      + '<td>'+dateTxt+'</td>'
      + '<td>'+ b('Transformer','transformThisSaved('+idx+')','btn primary') +'</td>'
    + '</tr>';
  }).join('');

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Transformer un devis en facture</h2>'
      + '<div class="muted" style="margin-bottom:6px;">S√©lectionne un devis √† reprendre : tu pourras modifier les lignes avant d‚Äôexporter la facture.</div>'
      + '<table class="table-mini" style="width:100%;border-collapse:collapse;">'
        + '<thead><tr><th>Titre</th><th>Cr√©√© le</th><th>Action</th></tr></thead>'
        + '<tbody>'+rows+'</tbody>'
      + '</table>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Retour √† l‚Äôaccueil','pageMain()','btn')
      + '</div>'
    + '</div>'
  );

  window.transformThisSaved = function(idx){
    var list = _readSavedDevisList6();
    var entry = list[idx]; if(!entry){ alert('Introuvable.'); return; }
    // Plusieurs structures possibles : {devis:{...}} ou {...} directement
    var payload = entry.devis || entry.data || entry;
    // On force le mode ‚Äúfacture‚Äù
    payload.__kind = 'facture';
    payload.__created_at = new Date().toISOString();
    window.devis = JSON.parse(JSON.stringify(payload||{}));
    saveLocalSafe();
    startAutoSave6();
    if(typeof pageHome === 'function') pageHome();
  };
}

/* ============================
   ¬ß6.4 ‚Ä¢ Injection boutons ‚ÄúG√©n√©rer ‚Ä¶‚Äù dans l‚ÄôAccueil (Chapitre 5)
   ============================ */
(function injectGenerateButtonsIntoAccueil(){
  var orig = window.pageHome;
  if(typeof orig !== 'function') return; // Chap.5 non charg√© encore; ce patch sera sans effet (ok)

  window.pageHome = function(){
    orig();

    var app = document.getElementById('app'); if(!app) return;

    // √âvite doublons
    if(app.innerHTML.indexOf('exportDevisToutComprisTXT')!==-1 && app.innerHTML.indexOf('exportInvoiceText')!==-1){
      // Probablement d√©j√† inject√©
    }

    // Trouve une zone d‚Äôactions sous l‚Äôestimatif (sinon on ajoute en bas)
    var container = app.querySelector('.row:last-of-type') || app;

    var row = document.createElement('div');
    row.className = 'row';
    row.style.marginTop = '10px';
    row.innerHTML =
      '<button class="btn" onclick="genDevisUI()">üßæ G√©n√©rer le devis</button>'
    + '<button class="btn" onclick="genFactureUI()">üí∂ G√©n√©rer la facture</button>';
    container.parentNode ? container.parentNode.appendChild(row) : app.appendChild(row);

    // Expose handlers (robustes aux chapitres manquants)
    window.genDevisUI = function(){
      // Propose les exports dispo (TXT tout compris / TXT s√©par√©)
      var hasTC = (typeof exportDevisToutComprisTXT === 'function');
      var hasSP = (typeof exportDevisSepareTXT === 'function');
      if(!hasTC && !hasSP){ alert('Exports devis non disponibles dans cette version.'); return; }
      var choice = prompt('Exporter le devis :\n1 = TXT (tout compris)\n2 = TXT (s√©par√© Prestations / Mat√©riel)\nAnnuler pour quitter','1');
      if(choice===null) return;
      if(choice==='2' && hasSP) exportDevisSepareTXT();
      else if(hasTC) exportDevisToutComprisTXT();
      else alert('Option indisponible.');
    };

    window.genFactureUI = function(){
      var hasTxt = (typeof exportInvoiceText === 'function');
      var hasCsv = (typeof exportInvoiceCSV === 'function');
      if(!hasTxt && !hasCsv){ alert('Exports facture non disponibles dans cette version.'); return; }
      var choice = prompt('Exporter la facture :\n1 = TXT\n2 = CSV (compta)\nAnnuler pour quitter','1');
      if(choice===null) return;
      if(choice==='2' && hasCsv) exportInvoiceCSV();
      else if(hasTxt) exportInvoiceText();
      else alert('Option indisponible.');
    };
  };
})();

/* ============================
   ¬ß6.5 ‚Ä¢ Expose (window)
   ============================ */
Object.assign(window, {
  pageCreateDevis,
  pageCreateFacture,
  pageTransformDevisFacture,
  startAutoSave6,
  stopAutoSave6
});

// Charge l‚Äô√©tat courant si pr√©sent (s√©curit√©) et d√©marre l‚Äôautosave
loadLocalSafe();
startAutoSave6();
</script>


  





  
  

  
  
 <!-- =======================================================================
     CHAPITRE 6 : TABLEAU √âLECTRIQUE (multi-tableaux) ‚Äî d√©coup√©
     Index :
       6.0 ‚Ä¢ √âtat local (tabState) + utils + getTabPrice
       6.1 ‚Ä¢ Cr√©ation / accueil d‚Äôun tableau (nom perso)
       6.2 ‚Ä¢ Pose du tableau
       6.3 ‚Ä¢ Interrupteurs diff√©rentiels
       6.3b‚Ä¢ Coupure g√©n√©rale
       6.4 ‚Ä¢ Disjoncteurs modulaires (+ d√©tails circuits)
       6.5 ‚Ä¢ Commandes & pilotage
       6.6 ‚Ä¢ √âl√©ment sp√©cifique
     ======================================================================= -->

<!-- 6.0 ‚Ä¢ √âtat local + utils -->
<script>
let tabState = {
  disj: {
    2:{qty:0,details:[]}, 10:{qty:0,details:[]}, 16:{qty:0,details:[]},
    20:{qty:0,details:[]}, 32:{qty:0,details:[]}, 40:{qty:0,details:[]},
    __custom__:{qty:0,details:[],label:""}
  }
};
function ensureTableauKey(key){
  if(!devis[key]) devis[key]={__base:"Tableau",items:[],note:"",__customName:""};
}
function saveDisjQtyFromUI(){
  const pick=id=>+((document.getElementById(id)||{}).value||0);
  ["2","10","16","20","32","40"].forEach(r=>{
    const v=pick("djq-"+r);
    if(!tabState.disj[+r]) tabState.disj[+r]={qty:0,details:[]};
    tabState.disj[+r].qty=v;
  });
  const lbl=(document.getElementById("djq-custom-label")?.value||"").trim();
  const q  =pick("djq-custom");
  tabState.disj.__custom__.label=lbl;
  tabState.disj.__custom__.qty=q;
}
// Prix de pose d‚Äôun tableau (arrondi 5+)
function getTabPrice(rangs, modules, pose, intervention){
  try{
    const base = (TARIFS_TABLEAU.pose_base_13[rangs]||0);
    const cm = (TARIFS_TABLEAU.coef.modules[modules]||1);
    const cp = (TARIFS_TABLEAU.coef.pose[pose]||1);
    const ci = (TARIFS_TABLEAU.coef.intervention[intervention]||1);
    return roundUp5(base*cm*cp*ci);
  }catch(e){ return 0; }
}
</script>

<!-- 6.1 ‚Ä¢ Cr√©ation / accueil -->
<script>
function pageTabCreate(){
  if(typeof devis.__tabCounter!=="number") devis.__tabCounter=0;
  devis.__tabCounter+=1;
  const key="Tableau "+devis.__tabCounter;

  if(!devis[key]) devis[key]={__base:"Tableau",items:[],note:"",__customName:""};
  saveLocal();

  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>Nouveau tableau</h2>'
      + '<p>Identifiant automatique : <strong>'+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="tab-custom" placeholder="ex: Principal RDC" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Valider","saveTabCustomName("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function saveTabCustomName(key){
  const name=(document.getElementById("tab-custom").value||"").trim();
  if(devis[key]){ devis[key].__customName=name; saveLocal(); }
  pageTabHome(key);
}
function pageTabHome(key){
  if(!key || !devis[key]) return pageHome();
  const custom = devis[key].__customName ? " ‚Äî "+devis[key].__customName : "";
  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>'+key+custom+'</h2>'
      + '<div class="row" style="margin-top:10px;">'
        + b("1 ¬∑ Pose du tableau","pageTabPose("+JSON.stringify(key)+")","btn primary")
        + b("2 ¬∑ Interrupteurs diff√©rentiels","pageTab_ID("+JSON.stringify(key)+")","btn")
        + b("3 ¬∑ Coupure g√©n√©rale","pageTab_Coupure("+JSON.stringify(key)+")","btn")
        + b("4 ¬∑ Disjoncteurs modulaires","pageTab_Disjoncteurs("+JSON.stringify(key)+")","btn")
        + b("5 ¬∑ Commandes / pilotage","pageTabMod_Commandes("+JSON.stringify(key)+")","btn")
        + b("6 ¬∑ Sp√©cifique (libre + prix)","pageTabMod_Specifique("+JSON.stringify(key)+")","btn ghost")
      + '</div>'
      + '<p class="muted" style="margin-top:8px;">Les √©l√©ments ajout√©s ici restent dans ¬´ '+key+' ¬ª.</p>'
    + '</div>'
  );
}
</script>

<!-- 6.2 ‚Ä¢ Pose du tableau -->
<script>
function pageTabPose(key){
  const rangs=[1,2,3,4].map(r=>`<option value="${r}">${r} rang√©e(s)</option>`).join('');
  const modules=[13,18,24].map(m=>`<option value="${m}">${m} modules</option>`).join('');
  const poses=['Saillie','Encastr√©'].map(p=>`<option value="${p}">${p}</option>`).join('');
  const intervs=['Cr√©ation','Avec d√©pose de l‚Äôexistant'].map(i=>`<option value="${i}">${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Pose du tableau</h2>'
      + '<label>Nombre de rang√©es</label><select id="tab-rang">'+rangs+'</select>'
      + '<label>Modules</label><select id="tab-mod">'+modules+'</select>'
      + '<label>Pose</label><select id="tab-pose">'+poses+'</select>'
      + '<label>Intervention</label><select id="tab-inv">'+intervs+'</select>'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"addTabPose("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function addTabPose(key){
  const r=+document.getElementById("tab-rang").value;
  const m=+document.getElementById("tab-mod").value;
  const pos=document.getElementById("tab-pose").value;
  const itv=document.getElementById("tab-inv").value;
  const pu=(typeof getTabPrice==='function')?getTabPrice(r,m,pos,itv):0;

  ensureTableauKey(key);
  devis[key].items.push({
    category:"Tableau & distribution",
    intervention:itv, pose:pos,
    designation:`Pose tableau ‚Äî ${r} rang√©e(s), ${m} modules`,
    qty:1, prixU:pu, __tabKey:key
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.3 ‚Ä¢ Interrupteurs diff√©rentiels -->
<script>
function pageTab_ID(key){
  const MODELS=[
    { id:"40A-A",  label:"ID 30mA - 40A - Type A"  },
    { id:"40A-AC", label:"ID 30mA - 40A - Type AC" },
    { id:"63A-A",  label:"ID 30mA - 63A - Type A"  },
    { id:"63A-AC", label:"ID 30mA - 63A - Type AC" }
  ];
  const opts=(n=20)=>Array.from({length:n+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  const price=id=>(TARIFS_TABLEAU && TARIFS_TABLEAU.inter_diff ? (TARIFS_TABLEAU.inter_diff[id]||0) : 0);

  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Interrupteurs diff√©rentiels</h2>'
      + '<div class="list">'
        + MODELS.map(m=>(
          `<label>${m.label} ‚Äî <span class="muted">${euro(price(m.id))}</span> `
          + `<select id="idq-${m.id.replace(/[^a-z0-9]/ig,'_')}">${opts(20)}</select></label>`
        )).join('')
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"submitTab_ID("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_ID(key){
  const pick=id=>+document.getElementById(id).value||0;
  const mk=id=>`idq-${id.replace(/[^a-z0-9]/ig,'_')}`;
  const lines=["40A-A","40A-AC","63A-A","63A-AC"].map(id=>({id,q:pick(mk(id))})).filter(x=>x.q>0);
  if(!lines.length){ pageTabHome(key); return; }

  ensureTableauKey(key);
  lines.forEach(x=>{
    const pu = (TARIFS_TABLEAU && TARIFS_TABLEAU.inter_diff ? (TARIFS_TABLEAU.inter_diff[x.id]||0) : 0);
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:`ID 30mA ‚Äî ${x.id.replace('-', ' - ')}`,
      qty:x.q, prixU:pu, __tabKey:key
    });
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.3b ‚Ä¢ Coupure g√©n√©rale -->
<script>
function pageTab_Coupure(key){
  const MODELS=[ { id:"45A", label:"Coupure g√©n√©rale 45 A", pu:80 },
                 { id:"60A", label:"Coupure g√©n√©rale 60 A", pu:110 } ];
  const opts=(n=20)=>Array.from({length:n+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Coupure g√©n√©rale</h2>'
      + '<div class="list">'
        + MODELS.map(m=>(
          `<label>${m.label} ‚Äî <span class="muted">${euro(m.pu)}</span> `
          + `<select id="cgq-${m.id}">${opts(20)}</select></label>`
        )).join('')
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"submitTab_Coupure("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_Coupure(key){
  const pick=id=>+document.getElementById(id).value||0;
  const defs = [
    { id:"45A", label:"Coupure g√©n√©rale 45 A", pu:80 },
    { id:"60A", label:"Coupure g√©n√©rale 60 A", pu:110 }
  ].map(d=>({ ...d, q: pick("cgq-"+d.id) })).filter(d=>d.q>0);

  if(!defs.length){ pageTabHome(key); return; }
  ensureTableauKey(key);
  defs.forEach(d=>{
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:d.label,
      qty:d.q, prixU:d.pu, __tabKey:key
    });
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.4 ‚Ä¢ Disjoncteurs modulaires (+ d√©tails) -->
<script>
function pageTab_Disjoncteurs(key){
  const opts=(max=30)=>Array.from({length:max+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  const line = amp => (
    `<label>${amp} A <select id="djq-${amp}">${opts(30)}</select> `
    + `${b("D√©tail circuits","pageTab_DisjDetails("+JSON.stringify(key)+","+amp+")")}</label>`
  );
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Disjoncteurs modulaires</h2>'
      + '<div class="list">'
        + line(2) + line(10) + line(16) + line(20) + line(32) + line(40)
        + `<label>Calibre personnalis√©
             <input id="djq-custom-label" placeholder="ex: 50 A, 3x20A‚Ä¶">
             Qt√© <select id="djq-custom">${opts(30)}</select>
             ${b("D√©tail circuits","pageTab_DisjDetails("+JSON.stringify(key)+", '__custom__')")}
           </label>`
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"pageTab_DisjValider("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
  ["2","10","16","20","32","40"].forEach(r=>{
    const el=document.getElementById("djq-"+r);
    if(el && tabState.disj[+r]) el.value=tabState.disj[+r].qty||0;
  });
  if(document.getElementById("djq-custom")){
    document.getElementById("djq-custom").value = tabState.disj.__custom__.qty||0;
    document.getElementById("djq-custom-label").value = tabState.disj.__custom__.label||"";
  }
}
function pageTab_DisjDetails(key, rating){
  saveDisjQtyFromUI();
  const st=tabState.disj[rating] || {qty:0,details:[]};
  const qty=st.qty||0; if(!st.details) st.details=[];
  const row=(i,d)=>{
    const type=d?.type||'', note=d?.note||'';
    return `
      <div class="pill" style="width:100%;">
        <select data-idx="${i}" class="dj-type">
          <option value="">(non d√©fini)</option>
          <option value="Circuit prise" ${type==='Circuit prise'?'selected':''}>Circuit prise</option>
          <option value="Circuit √©clairage" ${type==='Circuit √©clairage'?'selected':''}>Circuit √©clairage</option>
          <optgroup label="Circuits sp√©cialis√©s">
            <option value="Four" ${type==='Four'?'selected':''}>Four</option>
            <option value="Plaque de cuisson" ${type==='Plaque de cuisson'?'selected':''}>Plaque de cuisson</option>
            <option value="Lave-linge" ${type==='Lave-linge'?'selected':''}>Lave-linge</option>
            <option value="Lave-vaisselle" ${type==='Lave-vaisselle'?'selected':''}>Lave-vaisselle</option>
            <option value="S√®che-linge" ${type==='S√®che-linge'?'selected':''}>S√®che-linge</option>
            <option value="Cumulus" ${type==='Cumulus'?'selected':''}>Cumulus</option>
            <option value="VMC" ${type==='VMC'?'selected':''}>VMC</option>
            <option value="Chauffage" ${type==='Chauffage'?'selected':''}>Chauffage</option>
            <option value="Climatisation" ${type==='Climatisation'?'selected':''}>Climatisation</option>
            <option value="Prise ext√©rieure √©tanche" ${type==='Prise ext√©rieure √©tanche'?'selected':''}>Prise ext√©rieure √©tanche</option>
            <option value="__custom__">Nom personnalis√©‚Ä¶</option>
          </optgroup>
        </select>
        <input data-idx="${i}" class="dj-note" placeholder="Caract√©ristique / nom (facultatif)" value="${(note||'').replace(/"/g,'&quot;')}" />
      </div>
    `;
  };
  let out=''; for(let i=0;i<qty;i++){ out+=row(i, st.details[i]||{}); }
  view(
    '<div class="card">'
      + b("Retour","pageTab_Disjoncteurs("+JSON.stringify(key)+")","btn back")
      + '<h2>D√©tail circuits ‚Äî '+(rating==='__custom__'?(tabState.disj.__custom__.label||'Calibre personnalis√©'):(rating+' A'))+'</h2>'
      + '<div id="dj-detail-container">'+out+'</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Enregistrer","pageTab_DisjSaveDetails("+JSON.stringify(key)+","+JSON.stringify(rating)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function pageTab_DisjSaveDetails(key, rating){
  const types=[...document.querySelectorAll('.dj-type')];
  const notes=[...document.querySelectorAll('.dj-note')];
  const details=[];
  for(let i=0;i<types.length;i++){
    let t=types[i]?.value||''; if(t==="__custom__"){ t=prompt("Nom personnalis√© du circuit :","")||("Circuit "+(i+1)); }
    const n=notes[i]?.value||''; details.push({type:t,note:n});
  }
  if(!tabState.disj[rating]) tabState.disj[rating]={qty:0,details:[]};
  tabState.disj[rating].details=details;
  saveLocal(); pageTab_Disjoncteurs(key);
}
function pageTab_DisjValider(key){
  saveDisjQtyFromUI();
  const PU=Object.assign({}, (TARIFS_TABLEAU && TARIFS_TABLEAU.disjoncteurs)?TARIFS_TABLEAU.disjoncteurs:{}, {40:45});
  ensureTableauKey(key);

  [2,10,16,20,32,40].forEach(r=>{
    const st=tabState.disj[r];
    if(st && st.qty>0){
      const hasDetail=Array.isArray(st.details)&&st.details.some(d=>d&&(d.type||d.note));
      const detailText=hasDetail?' ‚Äî circuits : '+st.details.map((d,i)=>(d.type||('Circuit '+(i+1)))+(d.note?(' ('+d.note+')'):'')).join(', '):'';
      devis[key].items.push({
        category:"Tableau/Modulaire",
        designation:`Disjoncteur ${r} A${detailText}`,
        qty:st.qty, prixU:PU[r]||0, __tabKey:key
      });
    }
  });

  const c=tabState.disj.__custom__;
  if(c && c.qty>0){
    const label=(c.label||"Calibre personnalis√©").trim();
    const hasDetail=Array.isArray(c.details)&&c.details.some(d=>d&&(d.type||d.note));
    const detailText=hasDetail?' ‚Äî circuits : '+c.details.map((d,i)=>(d.type||('Circuit '+(i+1)))+(d.note?(' ('+d.note+')'):'')).join(', '):'';
    const pu=parseFloat(prompt("Prix unitaire pour ¬´ "+label+" ¬ª (‚Ç¨) :","0")||"0")||0;
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:`Disjoncteur ${label}${detailText}`,
      qty:c.qty, prixU:pu, __tabKey:key
    });
  }
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.5 ‚Ä¢ Commandes & pilotage -->
<script>
function pageTabMod_Commandes(key){
  const PC=(TARIFS_TABLEAU && TARIFS_TABLEAU.commandes)?TARIFS_TABLEAU.commandes:{};
  const opts=Object.keys(PC).map(k=>`<option value="${k}">${k} (${euro(PC[k]||0)})</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Commande & pilotage</h2>'
      + '<label>Mod√®le</label><select id="cmd-model">'+opts+'</select>'
      + '<label>Quantit√©</label><input id="cmd-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"submitTabMod_Commandes("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Commandes(key){
  const model=document.getElementById("cmd-model").value;
  const qty=Math.max(1, parseInt(document.getElementById("cmd-qty").value,10)||1);
  const pu=(TARIFS_TABLEAU && TARIFS_TABLEAU.commandes)?(TARIFS_TABLEAU.commandes[model]||0):0;
  ensureTableauKey(key);
  devis[key].items.push({ category:"Tableau/Commandes", designation:model, qty, prixU:pu, __tabKey:key });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.6 ‚Ä¢ √âl√©ment sp√©cifique -->
<script>
function pageTabMod_Specifique(key){
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>√âl√©ment sp√©cifique</h2>'
      + '<label>Intitul√©</label><input id="spec-label" />'
      + '<label>Prix unitaire (‚Ç¨)</label><input id="spec-price" type="number" inputmode="decimal" />'
      + '<label>Quantit√©</label><input id="spec-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"submitTabMod_Specifique("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Specifique(key){
  const label=(document.getElementById("spec-label").value||"").trim();
  const prix=parseFloat(document.getElementById("spec-price").value)||0;
  const qty=Math.max(1,parseInt(document.getElementById("spec-qty").value,10)||1);
  if(!label){ pageTabHome(key); return; }
  ensureTableauKey(key);
  devis[key].items.push({ category:"Tableau/Sp√©cifique", designation:label, qty, prixU:prix, __tabKey:key });
  saveLocal(); pageTabHome(key);
}
</script>










  


  
  
  
<!-- =======================================================================
     CHAPITRE 7 : VENTILATION ‚Äî corrig√© (libell√©s explicites, sans gros titres)
     ======================================================================= -->
<script>
/* √âtat local par ventilation */
var ventState = {};

/* S√©curit√© : pr√©sence d‚Äôune section VMC c√¥t√© devis + √©tat local par cl√© */
function ensureVentKey(key){
  if(!devis[key]) devis[key] = { __base:"VMC", __customName:"", items:[], note:"" };
  if(!ventState[key]) ventState[key] = {
    creation: {
      kit: {
        ref:"", d80:1, d125:1,
        conduits:[{type:"Gaine isol√©e"}],
        percements:[{support:"Placo", qty:0}]
      },
      extracteur: {
        ref:"", diam:"100",
        conduits:[{type:"Gaine isol√©e"}],
        percements:[{support:"Placo", qty:0}]
      },
      ventilateur: {
        ref:"", diam:"100", typeConduit:"Gaine isol√©e", longueur:0,
        percements:[{support:"Placo", qty:0}]
      }
    },
    retirage: { n80:0, n125:0 },
    entretien: { type:"Groupe VMC", nb:0 }
  };
}

/* Helpers lecture champs */
function pickVal(id, def){ var el=document.getElementById(id); return (el?el.value:def); }
function pickNum(id, def){ var el=document.getElementById(id); var v=parseFloat(el?el.value:NaN); return isNaN(v)?(def||0):v; }

/* ============================
   Accueil Ventilation
   ============================ */
function pageVentAccueil(){
  if(typeof devis.__ventCounter!=="number") devis.__ventCounter = 0;

  var keys = Object.keys(devis).filter(function(k){
    if(k.indexOf('__')===0) return false;
    var s = devis[k]||{};
    return (s.__base||"").toLowerCase()==="vmc";
  });

  var list = keys.length ? keys.map(function(k){
    var s=devis[k]||{};
    var titre = k + (s.__customName?(" ‚Äî "+s.__customName):"");
    var nb = (s.items||[]).length;
    return '<div class="pill">'
          +'<strong>'+titre+'</strong> <small>'+nb+' ligne(s)</small>'
          + b('Ouvrir','pageVentHome('+JSON.stringify(k)+')','btn')
          + b('Supprimer','ventDelete('+JSON.stringify(k)+')','btn')
          +'</div>';
  }).join('') : '<p class="muted">Aucune ventilation pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Ventilation</h2>'
      + b('‚ûï Ajouter une ventilation','pageVentNew()','btn primary')
    + '</div>'
    + '<div class="card" style="margin-top:12px;">'
      + '<h2>Liste</h2>'
      + list
    + '</div>'
  );
}

function pageVentNew(){
  devis.__ventCounter++;
  var key = 'Ventilation '+devis.__ventCounter;
  ensureVentKey(key); saveLocal();
  view(
    '<div class="card">'
      + b('Retour','pageVentAccueil()','btn back')
      + '<h2>Nouvelle ventilation</h2>'
      + '<p><strong>Identifiant : '+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="vent-name" placeholder="ex : VMC habitation, Local technique‚Ä¶" />'
      + '<div class="row" style="margin-top:10px;">'
        + b('Valider','saveVentName('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function saveVentName(key){
  var name = (document.getElementById('vent-name').value||'').trim();
  if(devis[key]) devis[key].__customName = name;
  saveLocal(); pageVentHome(key);
}
function ventDelete(key){
  if(!confirm('Supprimer ¬´ '+key+' ¬ª ?')) return;
  delete devis[key]; saveLocal(); pageVentAccueil();
}

function pageVentHome(key){
  ensureVentKey(key);
  var custom = devis[key].__customName ? ' ‚Äî '+devis[key].__customName : '';
  view(
    '<div class="card">'
      + b('Retour','pageVentAccueil('+')','btn back')
      + '<h2>'+key+custom+'</h2>'
      + '<div class="row" style="margin-top:8px; gap:8px;">'
        + b('1 ¬∑ Cr√©ation','pageVentCreation('+JSON.stringify(key)+')','btn primary')
        + b('2 ¬∑ Retirage des conduits','pageVentRetirage('+JSON.stringify(key)+')','btn')
        + b('3 ¬∑ Entretien','pageVentEntretien('+JSON.stringify(key)+')','btn')
      + '</div>'
      + '<p class="muted" style="margin-top:6px;">Ajoutez ici les lignes li√©es √† la ventilation (kit, extracteur, ventilateur, retirage, entretien‚Ä¶)</p>'
    + '</div>'
  );
}

/* ============================
   Cr√©ation (Kit / Extracteur / Ventilateur)
   ‚Äî Sans gros titres, mais avec libell√©s explicites
   ============================ */
function pageVentCreation(key){
  ensureVentKey(key);
  var st = ventState[key].creation;

  // Bloc : Liste de conduits (type)
  function conduitsBlock(arr, mutFn, prefix, legend){
    var rows = arr.map(function(c,i){
      var sel = ['Gaine isol√©e','Conduit rigide','Conduit rigide extra-plat','Gaine non isol√©e']
        .map(function(t){ return '<option '+(t===c.type?'selected':'')+'>'+t+'</option>'; }).join('');
      return (
        '<div class="pill" style="width:100%;">'
          + '<div style="flex:1 1 auto;">'
            + '<label><small>'+legend+' ‚Äî √©l√©ment n¬∞'+(i+1)+'</small></label>'
            + '<select id="'+prefix+'-type-'+i+'">'+sel+'</select>'
          + '</div>'
          + (i>0 ? b('√ó',mutFn+'('+JSON.stringify(key)+',"del",'+i+')','btn') : '')
        + '</div>'
      );
    }).join('');
    return rows + '<div class="row">'+ b('Ajouter un conduit',mutFn+'('+JSON.stringify(key)+',"add")','btn') +'</div>';
  }

  // Bloc : Liste de percements (support + quantit√©)
  function percementsBlock(arr, mutFn, prefix, legend){
    var supports=['Placo','Briquette','Ourdi b√©ton'];
    var rows = arr.map(function(p,i){
      var opts=supports.map(function(s){ return '<option '+(s===p.support?'selected':'')+'>'+s+'</option>'; }).join('');
      return (
        '<div class="pill" style="width:100%;">'
          + '<div style="flex:1 1 220px;">'
            + '<label><small>'+legend+' ‚Äî support du percement n¬∞'+(i+1)+'</small></label>'
            + '<select id="'+prefix+'-sup-'+i+'">'+opts+'</select>'
          + '</div>'
          + '<div style="flex:0 0 140px;">'
            + '<label><small>Quantit√© (nb de trous)</small></label>'
            + '<input id="'+prefix+'-qty-'+i+'" type="number" min="0" value="'+(p.qty||0)+'" />'
          + '</div>'
          + (i>0 ? b('√ó',mutFn+'('+JSON.stringify(key)+',"del",'+i+')','btn') : '')
        + '</div>'
      );
    }).join('');
    return rows + '<div class="row">'+ b('Ajouter un percement',mutFn+'('+JSON.stringify(key)+',"add")','btn') +'</div>';
  }

  // UI
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Cr√©ation</h2>'

      // ‚Äî Kit VMC (avec libell√©s)
      + '<div class="pill" style="margin:6px 0;"><strong>Kit VMC</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="kit-ref" placeholder="R√©f. du kit" value="'+st.kit.ref+'"/>'
      + '<div class="row">'
        + '<div style="flex:1 1 160px;">'
          + '<label>Nombre de bouches √ò80</label>'
          + '<input id="kit-d80" type="number" min="0" value="'+st.kit.d80+'"/>'
        + '</div>'
        + '<div style="flex:1 1 160px;">'
          + '<label>Nombre de bouches √ò125</label>'
          + '<input id="kit-d125" type="number" min="0" value="'+st.kit.d125+'"/>'
        + '</div>'
      + '</div>'
      + '<div style="margin-top:8px;">'+conduitsBlock(st.kit.conduits,"kitConduitMut","kitc","Kit VMC ‚Äî type de conduit")+'</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.kit.percements,"kitPercMut","kitp","Kit VMC")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter le Kit VMC','ventAddKit('+JSON.stringify(key)+')','btn primary') +'</div>'

      // ‚Äî Extracteur
      + '<hr style="margin:16px 0; border:none; border-top:1px solid var(--line);" />'
      + '<div class="pill" style="margin:6px 0;"><strong>Extracteur</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="ex-ref" placeholder="R√©f. de l‚Äôextracteur" value="'+st.extracteur.ref+'"/>'
      + '<label>Diam√®tre de raccord (mm)</label>'
      + '<select id="ex-diam">'+['80','100','125'].map(function(d){return '<option '+(d===st.extracteur.diam?'selected':'')+'>'+d+'</option>';}).join('')+'</select>'
      + '<div style="margin-top:8px;">'+conduitsBlock(st.extracteur.conduits,"exConduitMut","exc","Extracteur ‚Äî type de conduit")+'</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.extracteur.percements,"exPercMut","exp","Extracteur")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter l‚ÄôExtracteur','ventAddExtracteur('+JSON.stringify(key)+')','btn primary') +'</div>'

      // ‚Äî Ventilateur de conduit
      + '<hr style="margin:16px 0; border:none; border-top:1px solid var(--line);" />'
      + '<div class="pill" style="margin:6px 0;"><strong>Ventilateur de conduit</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="vc-ref" placeholder="R√©f. du ventilateur" value="'+st.ventilateur.ref+'"/>'
      + '<div class="row">'
        + '<div style="flex:1 1 160px;">'
          + '<label>Diam√®tre de raccord (mm)</label>'
          + '<select id="vc-diam">'+['80','100','125','150'].map(function(d){return '<option '+(d===st.ventilateur.diam?'selected':'')+'>'+d+'</option>';}).join('')+'</select>'
        + '</div>'
        + '<div style="flex:1 1 240px;">'
          + '<label>Type de conduit utilis√©</label>'
          + '<select id="vc-type">'+['Gaine isol√©e','Conduit rigide','Conduit rigide extra-plat','Gaine non isol√©e'].map(function(t){return '<option '+(t===st.ventilateur.typeConduit?'selected':'')+'>'+t+'</option>';}).join('')+'</select>'
        + '</div>'
        + '<div style="flex:1 1 160px;">'
          + '<label>Longueur de conduit (m)</label>'
          + '<input id="vc-len" type="number" min="0" step="0.1" value="'+st.ventilateur.longueur+'"/>'
        + '</div>'
      + '</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.ventilateur.percements,"vcPercMut","vcp","Ventilateur de conduit")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter le Ventilateur de conduit','ventAddVentilateur('+JSON.stringify(key)+')','btn primary') +'</div>'
    + '</div>'
  );
}

/* Mutateurs listes (ajout/suppression) */
function kitConduitMut(key,cmd,idx){ var arr=ventState[key].creation.kit.conduits; if(cmd==="add") arr.push({type:"Gaine isol√©e"}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function kitPercMut(key,cmd,idx){ var arr=ventState[key].creation.kit.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function exConduitMut(key,cmd,idx){ var arr=ventState[key].creation.extracteur.conduits; if(cmd==="add") arr.push({type:"Gaine isol√©e"}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function exPercMut(key,cmd,idx){ var arr=ventState[key].creation.extracteur.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function vcPercMut(key,cmd,idx){ var arr=ventState[key].creation.ventilateur.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }

/* Ajouts d‚Äôitems (on garde le m√™me niveau de d√©tail que pr√©c√©demment) */
function ventAddKit(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Kit VMC',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}
function ventAddExtracteur(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Extracteur',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}
function ventAddVentilateur(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Ventilateur conduit',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}

/* ============================
   Retirage des conduits
   ============================ */
function pageVentRetirage(key){
  ensureVentKey(key); var st=ventState[key].retirage;
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Retirage de conduits</h2>'
      + '<div class="row">'
        + '<div style="flex:1 1 200px;">'
          + '<label>Nombre de conduits √ò80 √† retirer</label>'
          + '<input id="rt-80" type="number" min="0" value="'+st.n80+'"/>'
        + '</div>'
        + '<div style="flex:1 1 200px;">'
          + '<label>Nombre de conduits √ò125 √† retirer</label>'
          + '<input id="rt-125" type="number" min="0" value="'+st.n125+'"/>'
        + '</div>'
      + '</div>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Ajouter le Retirage','ventAddRetirage('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function ventAddRetirage(key){
  var n80=pickNum('rt-80',0), n125=pickNum('rt-125',0);
  devis[key].items.push({
    category:'Ventilation/Retirage',
    designation:'Retirage √ò80='+n80+' / √ò125='+n125,
    qty:1, prixU:0, __tabKey:key
  });
  saveLocal(); pageVentHome(key);
}

/* ============================
   Entretien
   ============================ */
function pageVentEntretien(key){
  ensureVentKey(key); var st=ventState[key].entretien;
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Entretien</h2>'
      + '<label>√âl√©ment √† entretenir</label>'
      + '<select id="ent-type">'
        + ['Groupe VMC','Extracteur','Ventilateur de conduit'].map(function(t){ return '<option '+(t===st.type?'selected':'')+'>'+t+'</option>'; }).join('')
      + '</select>'
      + '<label style="margin-top:8px;">Nombre d‚Äôunit√©s</label>'
      + '<input id="ent-nb" type="number" min="0" value="'+st.nb+'"/>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Ajouter Entretien','ventAddEntretien('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function ventAddEntretien(key){
  var type=pickVal('ent-type','Groupe VMC'), nb=pickNum('ent-nb',0);
  devis[key].items.push({
    category:'Ventilation/Entretien',
    designation:'Entretien '+type+' ‚Äî nb='+nb,
    qty:1, prixU:0, __tabKey:key
  });
  saveLocal(); pageVentHome(key);
}
</script>







  
  
  
 

<!-- =============================
     CHAPITRE 8 : CATALOGUES & TARIFS
     Index :
       8.0 ‚Ä¢ Styles + Helpers communs
       8.1 ‚Ä¢ Accueil ‚ÄúCatalogue & Tarifs‚Äù (point d‚Äôentr√©e)
       8.2 ‚Ä¢ Catalogue PRESTATIONS (ajouts/modifs ‚Üí injecte dans menus + TARIFS_BASE)
              - 8.2.1 Familles & libell√©s d‚Äôinterventions
              - 8.2.2 √âditeurs par famille (liste, ajout, prix)
              - 8.2.3 Import / Export / Reset
       8.3 ‚Ä¢ TARIFS & COEFFICIENTS (pose, sections, ‚Ä¶)
              - 8.3.1 Tarifs unitaires par famille
              - 8.3.2 Coefficients (pose / sections / autres)
              - 8.3.3 Sauvegarde runtime + overrides
       8.4 ‚Ä¢ Catalogue MAT√âRIEL (marques, gammes, multiplicateurs)
              - 8.4.1 Structure & stockage
              - 8.4.2 √âditeur (marque/gamme par famille)
              - 8.4.3 Import / Export / Reset
       8.5 ‚Ä¢ Application au runtime (DESIGNATIONS_PAR_CATEGORIE / TARIFS_BASE)
       8.6 ‚Ä¢ Expose (window) + int√©gration menu (si n√©cessaire)
     ============================= -->

<style>
  /* 8.0 ‚Ä¢ Styles communs */
  .cfg8-wrap .card{ margin-bottom:24px; }
  .row.gap8{ gap:8px; flex-wrap:wrap; }
  .grid-auto{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
  .field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .note{ color:var(--muted); font-size:14px; }
  .pill.small{ padding:6px 10px; font-size:14px; }
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
  .muted{ color:var(--muted); }
  .space-top{ margin-top:12px; }
  .sep{ border-top:1px solid var(--line); padding-top:10px; margin-top:10px; }
  .footer-nav{ margin-top:16px; display:flex; justify-content:flex-end; }
</style>

<script>
/* =============================
   8.0 ‚Ä¢ Helpers communs
   ============================= */
const KEY_CAT_PREST = 'cat_prestations_v1';   // Catalogue PRESTATIONS
const KEY_CAT_MAT   = 'catalogue_materiel_v1';// Catalogue MAT√âRIEL
const KEY_TAR_OV    = 'tarifsOverrides';      // Overrides tarifs/coeffs (h√©rit√©)

function readJsonLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function writeJsonLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

function _clone(x){ return JSON.parse(JSON.stringify(x)); }
function _ensureNum(n){ return Math.max(0, +n || 0); }
function _esc(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]); }

function topBackButton(){
  // retour √† la page pr√©c√©dente si dispo, sinon home
  return b('Retour','history.length>1?history.back():pageHome()','btn back');
}
function bottomHome(){
  // bouton Accueil (avec garde-fou si le chap.4 a confirmBackHome)
  const act = (typeof confirmBackHome==='function') ? 'confirmBackHome()' : 'pageHome()';
  return '<div class="footer-nav">'+b('üè† Accueil',act,'btn')+'</div>';
}

/* =============================
   8.1 ‚Ä¢ Accueil (pont)
   ============================= */
function pageCatalogueTarifsAccueil(){
  view(
    '<div class="cfg8-wrap">'
    + '<div class="card">'
      + topBackButton()
      + '<h2>Catalogue & Tarifs</h2>'
      + '<p class="note">G√®re tes prestations (libell√©s + prix), tes coefficients et ton catalogue mat√©riel (marques/gammes).</p>'
      + '<div class="row gap8 space-top">'
        + b('üìö Catalogue prestations','pageCataloguePrestations()','btn primary')
        + b('üí∂ Tarifs & coefficients','pageTarifsCoeffs()','btn')
        + b('üè∑Ô∏è Catalogue mat√©riel','pageCatalogueMateriel()','btn')
      + '</div>'
    + '</div>'
    + bottomHome()
    + '</div>'
  );
}

/* ====================================================================
   8.2 ‚Ä¢ CATALOGUE PRESTATIONS
   ==================================================================== */

/* 8.2.1 ‚Ä¢ Familles + types d‚Äôinterventions par famille
   - Les libell√©s de colonnes diff√®rent (appareillage vs luminaire)
   - Tu peux ajuster/√©tendre les familles ici si besoin
*/
const PREST_FAMILIES = [
  { id:'prises', label:'Prises', keys:[
    'Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'
  ]},
  { id:'ecl_lum', label:'√âclairage ‚Äî Luminaires', keys:[
    'Cr√©ation','Remplacement luminaire','Rec√¢blage avec remplacement luminaire','Rec√¢blage sans remplacement luminaire'
  ]},
  { id:'ecl_cmd', label:'√âclairage ‚Äî Commandes', keys:[
    'Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'
  ]},
  { id:'cs', label:'Circuit sp√©cialis√©', keys:[
    'Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'
  ]},
  { id:'tableau', label:'Tableau & distribution', keys:[
    'Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'
  ]},
  { id:'vent', label:'Ventilation', keys:[
    'Cr√©ation','Remplacement appareillage','Entretien'
  ]},
  { id:'terre', label:'Mise √† la terre', keys:[
    'Cr√©ation','Am√©lioration/ajout','Contr√¥le'
  ]}
];

// Structure par d√©faut du catalogue PRESTATIONS
function _catPrestDefault(){
  return {
    prises: [
      { nom:'Prise 2P+T', prix:{'Cr√©ation':90,'Remplacement appareillage':25,'Rec√¢blage avec remplacement appareillage':45,'Rec√¢blage sans remplacement appareillage':30} }
    ],
    ecl_lum: [
      { nom:'Point de centre', prix:{'Cr√©ation':110,'Remplacement luminaire':35,'Rec√¢blage avec remplacement luminaire':55,'Rec√¢blage sans remplacement luminaire':40} }
    ],
    ecl_cmd: [
      { nom:'Interrupteur simple', prix:{'Cr√©ation':65,'Remplacement appareillage':25,'Rec√¢blage avec remplacement appareillage':40,'Rec√¢blage sans remplacement appareillage':28} }
    ],
    cs: [
      { nom:'Four', prix:{'Cr√©ation':140,'Remplacement appareillage':35,'Rec√¢blage avec remplacement appareillage':55,'Rec√¢blage sans remplacement appareillage':40} }
    ],
    tableau: [
      { nom:'Remplacement coffret standard', prix:{'Cr√©ation':100,'Remplacement appareillage':0,'Rec√¢blage avec remplacement appareillage':0,'Rec√¢blage sans remplacement appareillage':0} }
    ],
    vent: [
      { nom:'Kit VMC simple flux', prix:{'Cr√©ation':280,'Remplacement appareillage':60,'Entretien':45} }
    ],
    terre: [
      { nom:'Prise de terre (piquet)', prix:{'Cr√©ation':180,'Am√©lioration/ajout':90,'Contr√¥le':30} }
    ]
  };
}
function getCatPrest(){ return readJsonLS(KEY_CAT_PREST, _catPrestDefault()); }
function setCatPrest(obj){ writeJsonLS(KEY_CAT_PREST, obj||_catPrestDefault()); }

/* 8.2.2 ‚Ä¢ Pages √âditeur par famille */
function pageCataloguePrestations(){
  const cat = getCatPrest();
  const cards = PREST_FAMILIES.map(f=>{
    const arr = cat[f.id]||[];
    return `
      <div class="card">
        <h3>${_esc(f.label)}</h3>
        ${arr.length ? `
          <table class="table-mini">
            <thead>
              <tr><th>Type</th>${f.keys.map(k=>`<th>${_esc(k)}</th>`).join('')}<th></th></tr>
            </thead>
            <tbody>
              ${arr.map((t,idx)=>`
                <tr>
                  <td>${_esc(t.nom)}</td>
                  ${f.keys.map(k=>{
                    const id = `pr_${f.id}_${idx}_${k.replace(/\s+/g,'_')}`;
                    const val = +(t.prix?.[k]||0);
                    return `<td><input id="${id}" type="number" inputmode="decimal" step="1" min="0" value="${val}"></td>`;
                  }).join('')}
                  <td>${b('üíæ','catPrestSave("'+f.id+'",'+idx+')','btn')} ${b('üóëÔ∏è','catPrestDel("'+f.id+'",'+idx+')','btn')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : '<p class="muted">Aucun type pour le moment.</p>'}
        <div class="row gap8 space-top">
          <input id="add_${f.id}" placeholder="Ajouter un type (ex : Prise 2P+T IP55)" />
          ${b('Ajouter','catPrestAdd("'+f.id+'")','btn')}
        </div>
      </div>
    `;
  }).join('');

  view(
    '<div class="cfg8-wrap">'
    + '<div class="card">'
      + topBackButton()
      + '<h2>Catalogue prestations</h2>'
      + '<p class="note">Ajoute et modifie tes types de prestations. Les prix saisis sont utilis√©s par les menus de saisie et les exports.</p>'
      + '<div class="row gap8 space-top">'
        + b('‚¨áÔ∏è Export JSON','catPrestExport()','btn')
        + b('‚¨ÜÔ∏è Import JSON','catPrestImport()','btn')
        + b('üßπ R√©initialiser','catPrestReset()','btn')
      + '</div>'
    + '</div>'
    + cards
    + bottomHome()
    + '</div>'
  );

  // handlers runtime
  window.catPrestAdd = function(fid){
    const el = document.getElementById('add_'+fid);
    const name = (el && el.value || '').trim();
    if(!name) return;
    const cur = getCatPrest();
    cur[fid] = cur[fid] || [];
    cur[fid].push({ nom:name, prix:{} });
    setCatPrest(cur);
    applyPrestationsToRuntime(); // met √† jour DESIGNATIONS + TARIFS_BASE
    pageCataloguePrestations();
  };
  window.catPrestDel = function(fid, idx){
    const cur = getCatPrest();
    (cur[fid]||[]).splice(idx,1);
    setCatPrest(cur);
    applyPrestationsToRuntime();
    pageCataloguePrestations();
  };
  window.catPrestSave = function(fid, idx){
    const f = PREST_FAMILIES.find(x=>x.id===fid);
    if(!f) return;
    const cur = getCatPrest();
    const row = cur[fid]?.[idx];
    if(!row) return;
    const out = {};
    f.keys.forEach(k=>{
      const id = `pr_${fid}_${idx}_${k.replace(/\s+/g,'_')}`;
      const el = document.getElementById(id);
      out[k] = _ensureNum(el && el.value);
    });
    row.prix = out;
    setCatPrest(cur);
    applyPrestationsToRuntime();
    alert('‚úÖ Enregistr√©.');
  };
}

/* 8.2.3 ‚Ä¢ IO : Export / Import / Reset */
function catPrestExport(){
  const raw = JSON.stringify(getCatPrest(), null, 2);
  const blob = new Blob([raw], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'catalogue_prestations.json'; a.click();
  URL.revokeObjectURL(url);
}
function catPrestImport(){
  const input = document.createElement('input');
  input.type='file'; input.accept='application/json';
  input.onchange=function(){
    const f = input.files && input.files[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload=function(){
      try{
        const obj = JSON.parse(rd.result||'{}');
        // Sanity minimal
        if(!obj || typeof obj!=='object'){ alert('‚ùå JSON inattendu.'); return; }
        setCatPrest(obj);
        applyPrestationsToRuntime();
        alert('‚úÖ Catalogue prestations import√©.');
        pageCataloguePrestations();
      }catch(e){ alert('‚ùå Import impossible : '+e.message); }
    };
    rd.readAsText(f,'utf-8');
  };
  input.click();
}
function catPrestReset(){
  if(!confirm('R√©initialiser le catalogue prestations ?')) return;
  localStorage.removeItem(KEY_CAT_PREST);
  applyPrestationsToRuntime();
  pageCataloguePrestations();
}

/* ====================================================================
   8.3 ‚Ä¢ TARIFS & COEFFICIENTS
   ==================================================================== */

/* Mod√®le d‚Äôoverrides (h√©rit√© : TARIFS_BASE / COEFF_POSE / COEFF_SECTIONS_CS) */
function getOverrides(){ return readJsonLS(KEY_TAR_OV, {}); }
function setOverrides(p){
  const cur = getOverrides();
  function deepMerge(base, add){
    if(!add || typeof add!=='object') return;
    Object.keys(add).forEach(k=>{
      const v = add[k];
      if(v && typeof v==='object' && !Array.isArray(v)){
        if(!base[k] || typeof base[k]!=='object') base[k] = {};
        deepMerge(base[k], v);
      } else {
        base[k] = v;
      }
    });
  }
  deepMerge(cur, p||{});
  writeJsonLS(KEY_TAR_OV, cur);
  // Appliquer au runtime si les objets globaux existent
  if(typeof window.TARIFS_BASE==='object' && p.TARIFS_BASE) deepMerge(window.TARIFS_BASE, p.TARIFS_BASE);
  if(typeof window.COEFF_POSE==='object' && p.COEFF_POSE) deepMerge(window.COEFF_POSE, p.COEFF_POSE);
  if(typeof window.COEFF_SECTIONS_CS==='object' && p.COEFF_SECTIONS_CS) deepMerge(window.COEFF_SECTIONS_CS, p.COEFF_SECTIONS_CS);
}

function ensureTarifsGlobals(){
  // Valeurs par d√©faut si l‚Äôapp ne les a pas pos√©es
  window.TARIFS_BASE = window.TARIFS_BASE || {
    prises:{}, eclairage:{}, circuit_specialise:{}, circuit_specialise_base:{}
  };
  window.COEFF_POSE = window.COEFF_POSE || {
    'Placo':1,'Encastr√© ma√ßonnerie':1.2,'Semi-encastr√©':1.1,'Sur-mesure':1.5,'Saillie avec moulure':0.9,'Sous tube IRL':1
  };
  window.COEFF_SECTIONS_CS = window.COEFF_SECTIONS_CS || {
    '0,75 mm¬≤':0.8,'1,5 mm¬≤':1,'2,5 mm¬≤':1.2,'6 mm¬≤':1.4
  };
}

/* Pages */
function pageTarifsCoeffs(){
  ensureTarifsGlobals();
  // Panneau 1 : Tarifs par famille (valeur de base ‚Äúfallbacks‚Äù)
  const cat = getCatPrest();
  // On propose une √©dition ‚Äúglobale rapide‚Äù : si absent dans TARIFS_BASE, on injecte
  const familyCards = PREST_FAMILIES.map(f=>{
    const arr = (cat[f.id]||[]);
    if(!arr.length) return '';
    return `
      <div class="card">
        <h3>${_esc(f.label)} ‚Äî tarifs de base (par type)</h3>
        <table class="table-mini">
          <thead><tr><th>Type</th>${f.keys.map(k=>`<th>${_esc(k)}</th>`).join('')}<th></th></tr></thead>
          <tbody>
            ${arr.map((t,idx)=>`
              <tr>
                <td>${_esc(t.nom)}</td>
                ${f.keys.map(k=>{
                  const id=`tb_${f.id}_${idx}_${k.replace(/\s+/g,'_')}`;
                  // on part des prix du catalogue prestations
                  const def = +(t.prix?.[k]||0);
                  return `<td><input id="${id}" type="number" inputmode="decimal" step="1" min="0" value="${def}"></td>`;
                }).join('')}
                <td>${b('üíæ','saveTarifBase("'+f.id+'",'+idx+')','btn')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <p class="note">Ces tarifs seront fusionn√©s dans TARIFS_BASE (overrides). Ils impacteront directement les menus et les exports.</p>
      </div>
    `;
  }).join('');

  // Panneau 2 : Coefficients (pose / sections)
  const pose = window.COEFF_POSE || {};
  const cs  = window.COEFF_SECTIONS_CS || {};
  const poseRows = Object.keys(pose).map(k=>{
    const id = 'cp_'+k.replace(/\s+/g,'_');
    return `<tr><td>${_esc(k)}</td><td><input id="${id}" type="number" inputmode="decimal" step="0.1" min="0" value="${+(pose[k]||0)}"></td></tr>`;
  }).join('');
  const csRows = Object.keys(cs).map(k=>{
    const id = 'cs_'+k.replace(/\s+/g,'_');
    return `<tr><td>${_esc(k)}</td><td><input id="${id}" type="number" inputmode="decimal" step="0.1" min="0" value="${+(cs[k]||0)}"></td></tr>`;
  }).join('');

  view(
    '<div class="cfg8-wrap">'
    + '<div class="card">'
      + topBackButton()
      + '<h2>Tarifs & coefficients</h2>'
      + '<p class="note">Modifie les tarifs de base par type (famille) ainsi que les coefficients utilis√©s dans les calculs.</p>'
    + '</div>'
    + familyCards
    + '<div class="card">'
      + '<h3>Coefficients de pose</h3>'
      + '<table class="table-mini"><thead><tr><th>Type de pose</th><th>Coefficient</th></tr></thead><tbody>'
      + poseRows
      + '</tbody></table>'
      + '<div class="row gap8 space-top">'
        + b('üíæ Enregistrer les coefficients de pose','saveCoeffsPose()','btn primary')
      + '</div>'
    + '</div>'
    + '<div class="card">'
      + '<h3>Coefficients sections (Circuit sp√©cialis√©)</h3>'
      + '<table class="table-mini"><thead><tr><th>Section</th><th>Coefficient</th></tr></thead><tbody>'
      + csRows
      + '</tbody></table>'
      + '<div class="row gap8 space-top">'
        + b('üíæ Enregistrer les coefficients sections','saveCoeffsSections()','btn primary')
      + '</div>'
    + '</div>'
    + bottomHome()
    + '</div>'
  );

  // Handlers
  window.saveTarifBase = function(fid, idx){
    const fam = PREST_FAMILIES.find(x=>x.id===fid);
    if(!fam) return;
    const cat = getCatPrest();
    const item = cat[fid]?.[idx]; if(!item) return;

    // Construire override TARIFS_BASE selon la ‚Äúbranche‚Äù
    // On mappe les familles vers leurs troncs existants
    // - prises ‚Üí TARIFS_BASE.prises[item.nom]
    // - ecl_*  ‚Üí TARIFS_BASE.eclairage[item.nom]
    // - cs     ‚Üí TARIFS_BASE.circuit_specialise[item.nom]
    // - tableau/vent/terre ‚Üí TARIFS_BASE.<branche libre> (on regroupe dans eclairage si besoin)
    const ov = { TARIFS_BASE:{} };
    let target;
    if(fid==='prises'){
      target = (ov.TARIFS_BASE.prises = ov.TARIFS_BASE.prises || {});
      target[item.nom] = {};
      fam.keys.forEach(k=>{
        const id = `tb_${fid}_${idx}_${k.replace(/\s+/g,'_')}`;
        target[item.nom][k] = _ensureNum(document.getElementById(id)?.value);
      });
    }else if(fid==='ecl_lum' || fid==='ecl_cmd'){
      const ecl = (ov.TARIFS_BASE.eclairage = ov.TARIFS_BASE.eclairage || {});
      ecl[item.nom] = {};
      fam.keys.forEach(k=>{
        const id = `tb_${fid}_${idx}_${k.replace(/\s+/g,'_')}`;
        ecl[item.nom][k] = _ensureNum(document.getElementById(id)?.value);
      });
    }else if(fid==='cs'){
      const csb = (ov.TARIFS_BASE.circuit_specialise = ov.TARIFS_BASE.circuit_specialise || {});
      csb[item.nom] = {};
      fam.keys.forEach(k=>{
        const id = `tb_${fid}_${idx}_${k.replace(/\s+/g,'_')}`;
        csb[item.nom][k] = _ensureNum(document.getElementById(id)?.value);
      });
    }else{
      // Regroupement ‚Äúdivers‚Äù ‚Üí on range sous TARIFS_BASE.prises pour compat,
      // ou mieux, un tronc d√©di√© si l‚Äôapp le pr√©voit. Ici, on cr√©e un tronc ‚Äúdivers‚Äù.
      const dv = (ov.TARIFS_BASE.divers = ov.TARIFS_BASE.divers || {});
      dv[item.nom] = {};
      fam.keys.forEach(k=>{
        const id = `tb_${fid}_${idx}_${k.replace(/\s+/g,'_')}`;
        dv[item.nom][k] = _ensureNum(document.getElementById(id)?.value);
      });
    }

    setOverrides(ov);
    alert('‚úÖ Tarifs inject√©s dans TARIFS_BASE.');
  };

  window.saveCoeffsPose = function(){
    const pose = {};
    (Object.keys(window.COEFF_POSE||{})).forEach(k=>{
      const id = 'cp_'+k.replace(/\s+/g,'_');
      pose[k] = _ensureNum(document.getElementById(id)?.value);
    });
    setOverrides({ COEFF_POSE: pose });
    alert('‚úÖ Coefficients de pose enregistr√©s.');
  };
  window.saveCoeffsSections = function(){
    const map = {};
    (Object.keys(window.COEFF_SECTIONS_CS||{})).forEach(k=>{
      const id = 'cs_'+k.replace(/\s+/g,'_');
      map[k] = _ensureNum(document.getElementById(id)?.value);
    });
    setOverrides({ COEFF_SECTIONS_CS: map });
    alert('‚úÖ Coefficients de sections enregistr√©s.');
  };
}

/* ====================================================================
   8.4 ‚Ä¢ CATALOGUE MAT√âRIEL (marques/gammes)
   ==================================================================== */

/* 8.4.1 Structure
   On associe (famille ‚Üí [ { marque, gammes:[{nom, coef}] } ])
   - coef : multiplicateur (ex : 1.00 = base, 1.15 = +15%)
*/
function _matDefault(){
  return {
    prises: [
      { marque:'Schneider', gammes:[ {nom:'Odace', coef:1.00}, {nom:'Unica', coef:1.15} ] }
    ],
    ecl_cmd: [
      { marque:'Legrand', gammes:[ {nom:'C√©liane', coef:1.10} ] }
    ],
    tableau: [
      { marque:'Schneider', gammes:[ {nom:'Resi9', coef:1.00}, {nom:'Acti9', coef:1.15} ] }
    ]
  };
}
function getMat(){ return readJsonLS(KEY_CAT_MAT, _matDefault()); }
function setMat(obj){ writeJsonLS(KEY_CAT_MAT, obj||_matDefault()); }

/* 8.4.2 √âditeur */
function pageCatalogueMateriel(){
  const famOptions = PREST_FAMILIES.map(f=>`<option value="${f.id}">${_esc(f.label)}</option>`).join('');
  const m = getMat();
  const famCards = PREST_FAMILIES.map(f=>{
    const arr = m[f.id]||[];
    return `
      <div class="card">
        <h3>${_esc(f.label)}</h3>
        ${arr.length ? `
          <table class="table-mini">
            <thead><tr><th>Marque</th><th>Gammes (nom ‚Äî coef)</th><th></th></tr></thead>
            <tbody>
              ${arr.map((brand, bi)=>`
                <tr>
                  <td>${_esc(brand.marque)}</td>
                  <td>
                    ${(brand.gammes||[]).map((g,gi)=>`
                      <div class="row gap8" style="margin:4px 0">
                        <input id="mg_${f.id}_${bi}_${gi}_name" value="${_esc(g.nom)}" placeholder="Nom de gamme"/>
                        <input id="mg_${f.id}_${bi}_${gi}_coef" type="number" step="0.01" inputmode="decimal" min="0" value="${+(g.coef||1)}" placeholder="Coef"/>
                        ${b('üíæ','saveMatGamme("'+f.id+'",'+bi+','+gi+')','btn')}
                        ${b('üóëÔ∏è','delMatGamme("'+f.id+'",'+bi+','+gi+')','btn')}
                      </div>
                    `).join('')}
                    <div class="row gap8 sep">
                      <input id="newg_${f.id}_${bi}_name" placeholder="Nouvelle gamme"/>
                      <input id="newg_${f.id}_${bi}_coef" type="number" step="0.01" inputmode="decimal" min="0" value="1"/>
                      ${b('Ajouter une gamme','addMatGamme("'+f.id+'",'+bi+')','btn')}
                    </div>
                  </td>
                  <td>${b('üóëÔ∏è Marque','delMatBrand("'+f.id+'",'+bi+')','btn')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : '<p class="muted">Aucune marque pour le moment.</p>'}
        <div class="row gap8 space-top">
          <input id="addm_'+f.id+'" placeholder="Ajouter une marque (ex : Schneider)"/>
          ${b('Ajouter','addMatBrand("'+f.id+'")','btn')}
        </div>
      </div>
    `;
  }).join('');

  view(
    '<div class="cfg8-wrap">'
    + '<div class="card">'
      + topBackButton()
      + '<h2>Catalogue mat√©riel</h2>'
      + '<p class="note">D√©clare tes marques et gammes par famille. Les coefficients pourront √™tre exploit√©s par tes √©crans de saisie et exports.</p>'
      + '<div class="row gap8 space-top">'
        + b('‚¨áÔ∏è Export JSON','matExport()','btn')
        + b('‚¨ÜÔ∏è Import JSON','matImport()','btn')
        + b('üßπ R√©initialiser','matReset()','btn')
      + '</div>'
    + '</div>'
    + famCards
    + bottomHome()
    + '</div>'
  );

  // Handlers
  window.addMatBrand = function(fid){
    const el = document.getElementById('addm_'+fid);
    const name = (el && el.value || '').trim(); if(!name) return;
    const cur = getMat();
    cur[fid] = cur[fid] || [];
    cur[fid].push({ marque:name, gammes:[] });
    setMat(cur);
    pageCatalogueMateriel();
  };
  window.delMatBrand = function(fid, bi){
    const cur = getMat(); (cur[fid]||[]).splice(bi,1); setMat(cur); pageCatalogueMateriel();
  };
  window.addMatGamme = function(fid, bi){
    const n = document.getElementById(`newg_${fid}_${bi}_name`);
    const c = document.getElementById(`newg_${fid}_${bi}_coef`);
    const nom = (n && n.value || '').trim(); if(!nom) return;
    const coef = _ensureNum(c && c.value);
    const cur = getMat(); const br = (cur[fid]||[])[bi]; if(!br) return;
    br.gammes = br.gammes || []; br.gammes.push({ nom, coef });
    setMat(cur); pageCatalogueMateriel();
  };
  window.delMatGamme = function(fid, bi, gi){
    const cur = getMat(); const br=(cur[fid]||[])[bi]; if(!br) return;
    (br.gammes||[]).splice(gi,1); setMat(cur); pageCatalogueMateriel();
  };
  window.saveMatGamme = function(fid, bi, gi){
    const nameEl = document.getElementById(`mg_${fid}_${bi}_${gi}_name`);
    const coefEl = document.getElementById(`mg_${fid}_${bi}_${gi}_coef`);
    const cur = getMat(); const br=(cur[fid]||[])[bi]; if(!br) return;
    const g = (br.gammes||[])[gi]; if(!g) return;
    g.nom = (nameEl && nameEl.value || '').trim();
    g.coef = _ensureNum(coefEl && coefEl.value);
    setMat(cur); alert('‚úÖ Gamme enregistr√©e.');
  };
}

/* IO Mat√©riel */
function matExport(){
  const raw = JSON.stringify(getMat(), null, 2);
  const blob = new Blob([raw], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='catalogue_materiel.json'; a.click();
  URL.revokeObjectURL(url);
}
function matImport(){
  const input = document.createElement('input');
  input.type='file'; input.accept='application/json';
  input.onchange=function(){
    const f = input.files && input.files[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload=function(){
      try{
        const obj = JSON.parse(rd.result||'{}');
        if(!obj || typeof obj!=='object'){ alert('‚ùå JSON inattendu.'); return; }
        setMat(obj);
        alert('‚úÖ Catalogue mat√©riel import√©.');
        pageCatalogueMateriel();
      }catch(e){ alert('‚ùå Import impossible : '+e.message); }
    };
    rd.readAsText(f,'utf-8');
  };
  input.click();
}
function matReset(){
  if(!confirm('R√©initialiser le catalogue mat√©riel ?')) return;
  localStorage.removeItem(KEY_CAT_MAT);
  pageCatalogueMateriel();
}

/* ====================================================================
   8.5 ‚Ä¢ Application au runtime (DESIGNATIONS / TARIFS_BASE)
   ==================================================================== */
function applyPrestationsToRuntime(){
  // 1) Garantir les troncs globaux
  ensureTarifsGlobals();

  // 2) Appliquer les prestations au runtime
  const cat = getCatPrest();
  // DESIGNATIONS_PAR_CATEGORIE (si l‚Äôapp l‚Äôutilise)
  if(typeof window.DESIGNATIONS_PAR_CATEGORIE==='object'){
    // Reset minimal (on ajoute sans dupliquer)
    const ensureList = (key)=>{ window.DESIGNATIONS_PAR_CATEGORIE[key] = window.DESIGNATIONS_PAR_CATEGORIE[key] || []; return window.DESIGNATIONS_PAR_CATEGORIE[key]; };
    function pushU(list, name){ if(list.indexOf(name)===-1) list.push(name); }

    // Mappings vers les cat√©gories menus existants
    (cat.prises||[]).forEach(t=> pushU(ensureList('Prises'), t.nom));
    (cat.ecl_lum||[]).forEach(t=> pushU(ensureList('√âclairage/Luminaires'), t.nom));
    (cat.ecl_cmd||[]).forEach(t=> pushU(ensureList('√âclairage/Commandes'), t.nom));
    (cat.cs||[]).forEach(t=> pushU(ensureList('Circuit sp√©cialis√©'), t.nom));
    (cat.tableau||[]).forEach(t=> pushU(ensureList('Tableau & distribution'), t.nom));
    (cat.vent||[]).forEach(t=> pushU(ensureList('VMC'), t.nom));
    (cat.terre||[]).forEach(t=> pushU(ensureList('Mise √† la terre'), t.nom));
  }

  // TARIFS_BASE : on injecte/override par nom
  function mergeTarifs(dst, src){
    Object.keys(src||{}).forEach(k=>{
      if(!dst[k]) dst[k] = {};
      Object.assign(dst[k], src[k]); // override feuille (prix)
    });
  }

  // Construit structures √† partir du catalogue prestations
  const tb = { prises:{}, eclairage:{}, circuit_specialise:{} };
  (cat.prises||[]).forEach(t=> tb.prises[t.nom] = _clone(t.prix||{}));
  (cat.ecl_lum||[]).forEach(t=> { tb.eclairage[t.nom] = _clone(t.prix||{}); });
  (cat.ecl_cmd||[]).forEach(t=> { tb.eclairage[t.nom] = Object.assign(tb.eclairage[t.nom]||{}, _clone(t.prix||{})); });
  (cat.cs||[]).forEach(t=> tb.circuit_specialise[t.nom] = _clone(t.prix||{}));
  // facultatif : autres familles sous ‚Äúdivers‚Äù
  if(!TARIFS_BASE.divers) TARIFS_BASE.divers = {};
  (cat.tableau||[]).forEach(t=> TARIFS_BASE.divers[t.nom] = _clone(t.prix||{}));
  (cat.vent||[]).forEach(t=> TARIFS_BASE.divers[t.nom] = _clone(t.prix||{}));
  (cat.terre||[]).forEach(t=> TARIFS_BASE.divers[t.nom] = _clone(t.prix||{}));

  // Merge dans les globaux
  mergeTarifs(TARIFS_BASE.prises, tb.prises);
  mergeTarifs(TARIFS_BASE.eclairage, tb.eclairage);
  mergeTarifs(TARIFS_BASE.circuit_specialise, tb.circuit_specialise);
  mergeTarifs(TARIFS_BASE.divers, TARIFS_BASE.divers);

  // Appliquer aussi les overrides existants
  const ov = getOverrides();
  if(ov.TARIFS_BASE) {
    // simple deep merge
    (function deepMerge(base, add){
      Object.keys(add).forEach(k=>{
        const v = add[k];
        if(v && typeof v==='object' && !Array.isArray(v)){
          if(!base[k] || typeof base[k]!=='object') base[k] = {};
          deepMerge(base[k], v);
        } else {
          base[k] = v;
        }
      });
    })(TARIFS_BASE, ov.TARIFS_BASE);
  }
}

/* Appel initial (au chargement du chapitre) */
applyPrestationsToRuntime();

/* ====================================================================
   8.6 ‚Ä¢ Expose & int√©gration
   ==================================================================== */
Object.assign(window, {
  pageCatalogueTarifsAccueil,
  pageCataloguePrestations,
  pageTarifsCoeffs,
  pageCatalogueMateriel,

  // Cat Prest IO
  catPrestExport, catPrestImport, catPrestReset,

  // Mat IO
  matExport, matImport, matReset,

  // Runtime apply
  applyPrestationsToRuntime
});

// Si le chapitre 4 n‚Äôa pas d√©j√† ‚Äúc√¢bl√©‚Äù les boutons, on expose une passerelle
// (ne double pas si d√©j√† pr√©sent)
(function softHookIntoMenu(){
  if(typeof window.pageHome!=='function') return;
  const old = window.pageHome;
  window.pageHome = function(){
    old();
    const app = document.getElementById('app'); if(!app) return;
    // injecte un lien discret si rien n‚Äôa √©t√© branch√©
    if(app.innerHTML.indexOf('pageCataloguePrestations()')===-1){
      const hint = '<div class="card"><div class="row" style="gap:8px;">'
        + '<button class="btn" onclick="pageCataloguePrestations()">Catalogue prestations</button>'
        + '<button class="btn" onclick="pageTarifsCoeffs()">Tarifs & coefficients</button>'
        + '<button class="btn" onclick="pageCatalogueMateriel()">Catalogue mat√©riel</button>'
        + '</div></div>';
      app.innerHTML += hint;
    }
  };
})();
</script>






  




  


  




<!-- =============================
     CHAPITRE 9 : MODIFICATIONS DE TABLEAU
     Index :
       9.0 ‚Ä¢ Styles + Tarifs + Constantes
       9.1 ‚Ä¢ Injection bouton (apr√®s ‚ÄúCr√©ation tableau‚Äù dans le menu principal)
       9.2 ‚Ä¢ Accueil ‚ÄúModifications de Tableau‚Äù
       9.3 ‚Ä¢ √âcran unique : D√©placement + (√† la suite) Remplacement coffret
       9.4 ‚Ä¢ Rec√¢blage tableau existant (remplacement coffret + circuits + mat√©riel suppl.)
       9.5 ‚Ä¢ Expose (window)
     ============================= -->

<style>
  .mtx { margin-top:14px; }
  .mbx { margin-bottom:14px; }
  .vblock { display:block; margin-top:10px; }
  .fieldset {
    border:1px solid var(--line); background:#fff;
    border-radius:10px; padding:12px; margin-top:10px;
  }
  .fieldset h3 { margin:0 0 8px; font-size:16px; }
  .pill.small{ padding:6px 10px; font-size:14px; }
  .row.gap8{ gap:8px; flex-wrap:wrap; }
  .list-plain{ display:flex; flex-direction:column; gap:6px; }
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<script>
// =============================
// ¬ß9.0 ‚Ä¢ Tarifs + constantes
// =============================
window.TARIFS_TABMODS = window.TARIFS_TABMODS || {
  deplacement: {
    par_circuit: 20,          // ‚Ç¨ / circuit √† rallonger
    boite_base: 50,           // ‚Ç¨ base pour la bo√Æte (si ‚â† "N√©ant")
    boite_par_circuit: 10,    // ‚Ç¨ additionnels par circuit (si ‚â† "N√©ant")
    goulotte_base: 50,        // ‚Ç¨ base pour la goulotte
    goulotte_par_m: 20        // ‚Ç¨ / m√®tre
  },
  recablage: {
    par_circuit: 10,          // ‚Ç¨ / circuit √† rec√¢bler
    // Mat√©riel suppl. (prix unitaires par d√©faut ‚Äî modifiables dans le code)
    materiel: {
      "Disjoncteur modulaire": 18,
      "Inter diff 30mA": 65,
      "Peigne d‚Äôalimentation": 12,
      "Bornier": 8,
      "Contacteur J/N": 42
    }
  }
};

// Libell√©s bo√Ætes d√©rivation propos√©es (d√©placement)
const TABMODS_BOITES = [
  { id:'NONE', label:'N√©ant' },
  { id:'100x150', label:'Bo√Æte 100√ó150' },
  { id:'150x200', label:'Bo√Æte 150√ó200' },
  { id:'200x250', label:'Bo√Æte 200√ó250' },
  { id:'300x350', label:'Bo√Æte 300√ó350' }
];

// Choix (rapides) pour Remplacement Coffret
const TABMODS_COFFRET_GAMMES = [
  'Schneider Resi9','Schneider Acti9','Legrand (r√©sidentiel)','Hager (r√©sidentiel)','Hager (tertiaire)'
];
const TABMODS_COFFRET_MODULES = ['13 modules','18 modules','24 modules'];
const TABMODS_COFFRET_RANGES = [1,2,3,4];

// Dossier de rangement pour le devis
const TABMODS_SECTION_KEY = 'Tableau & distribution';
function ensureTabModsSection(){
  if(!devis[TABMODS_SECTION_KEY]){
    devis[TABMODS_SECTION_KEY] = { __base:'Tableau & distribution', items:[], note:'' };
  }
}

// ========================================================
// ¬ß9.1 ‚Ä¢ Injection bouton APRES ‚ÄúCr√©ation tableau‚Äù (menu)
// ========================================================
(function(){
  const _old = window.pageHome;
  window.pageHome = function(){
    if(typeof _old === 'function') _old();
    const app=document.getElementById('app');
    if(!app) return;
    if(app.innerHTML.indexOf('pageTabModsAccueil()')!==-1) return;

    // priorit√© : ins√©rer juste APR√àS le bouton de cr√©ation de tableau
    // on cherche un onclick de pageTabCreate() et on ins√®re derri√®re
    const btn = '<button class="btn" onclick="pageTabModsAccueil()">Modifications de Tableau</button>';
    let html = app.innerHTML;

    // insertion ‚Äúpropre‚Äù apr√®s un bouton qui appelle pageTabCreate()
    const reBtnCreate = /(<button[^>]+onclick="[^"]*pageTabCreate\(\)[^"]*"[^>]*>[\s\S]*?<\/button>)/i;
    if(reBtnCreate.test(html)){
      app.innerHTML = html.replace(reBtnCreate, '$1'+btn);
      return;
    }
    // fallback : apr√®s le mot ‚ÄúTableau‚Äù si le bouton est textuel
    const reWord = /(Cr√©ation\s*tableau|Tableau\s+nouveau)/i;
    if(reWord.test(html)){
      app.innerHTML = html.replace(reWord, '$1</button>'+btn);
      return;
    }
    // dernier fallback : on ajoute en fin de la premi√®re ligne de boutons
    app.innerHTML = html.replace(/(<div class="row"[^>]*>)/, '$1'+btn);
  };
})();

// ==========================================
// ¬ß9.2 ‚Ä¢ Accueil ‚ÄúModifications de Tableau‚Äù
// ==========================================
function pageTabModsAccueil(){
  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Modifications de Tableau</h2>'
      + '<div class="row mtx" style="gap:8px;">'
        + b('D√©placement + Remplacement coffret (m√™me √©cran)','pageTabModsDeplacement()','btn primary')
        + b('Rec√¢blage tableau existant','pageTabModsRecablage()','btn')
      + '</div>'
    + '</div>'
  );
}

// =====================================================================
// ¬ß9.3 ‚Ä¢ √âcran UNIQUE : D√©placement + (√† la suite) Remplacement coffret
// =====================================================================
function pageTabModsDeplacement(){
  const t = TARIFS_TABMODS.deplacement || {};
  const circuits = Array.from({length:31},(_,i)=>`<option value="${i}">${i}</option>`).join('');
  const boites = TABMODS_BOITES.map(b=>`<option value="${b.id}">${b.label}</option>`).join('');

  const gammes = ['Aucun'].concat(TABMODS_COFFRET_GAMMES).map(x=>`<option value="${x}">${x}</option>`).join('');
  const modules = TABMODS_COFFRET_MODULES.map(x=>`<option value="${x}">${x}</option>`).join('');
  const ranges = TABMODS_COFFRET_RANGES.map(x=>`<option value="${x}">${x} rang√©e(s)</option>`).join('');

  view(
    '<div class="card">'
      + b('Retour','pageTabModsAccueil()','btn back')
      + '<h2>D√©placement de tableau</h2>'

      + '<div class="fieldset">'
        + '<h3>1) Nombre de circuits √† rallonger</h3>'
        + '<select id="mt-circuits">'+circuits+'</select>'
        + '<small class="muted vblock">Tarif : '+euro(+t.par_circuit||20)+' / circuit</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>2) Cr√©ation d‚Äôune bo√Æte de d√©rivation</h3>'
        + '<select id="mt-boite">'+boites+'</select>'
        + '<small class="muted vblock">Base : '+euro(+t.boite_base||50)+' + '+euro(+t.boite_par_circuit||10)+' / circuit (si bo√Æte ‚â† N√©ant)</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>3) Longueur de goulotte</h3>'
        + '<input id="mt-goulotte" type="number" step="0.1" min="0" value="0" inputmode="decimal" />'
        + '<small class="muted vblock">Base : '+euro(+t.goulotte_base||50)+' + '+euro(+t.goulotte_par_m||20)+' / m√®tre</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>4) Remplacement coffret (facultatif)</h3>'
        + '<label class="vblock">Marque / Gamme</label>'
        + '<select id="rc-gamme">'+gammes+'</select>'
        + '<label class="vblock">Modules par rang√©e</label>'
        + '<select id="rc-mod">'+modules+'</select>'
        + '<label class="vblock">Nombre de rang√©es</label>'
        + '<select id="rc-range">'+ranges+'</select>'
        + '<label class="vblock">Type de pose</label>'
        + '<select id="rc-pose"><option>Saillie</option><option>Encastr√©</option></select>'
        + '<small class="muted vblock">Estimation simple : base + rang√©es √ó modules, coef encastr√©.</small>'
      + '</div>'

      + '<div id="mt-preview" class="muted mtx"></div>'

      + '<div class="row mtx" style="gap:8px;">'
        + b('Ajouter la modification','addTabMod_Deplacement()','btn primary')
      + '</div>'
    + '</div>'
  );

  ['mt-circuits','mt-boite','mt-goulotte','rc-gamme','rc-mod','rc-range','rc-pose'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('input', refreshMtPreview);
  });
  refreshMtPreview();
}

function calcDeplacementTotal(nbCircuits, boiteId, lgM){
  const t = TARIFS_TABMODS.deplacement || {};
  const parCircuit = +t.par_circuit || 20;
  const bBase = (boiteId==='NONE') ? 0 : (+t.boite_base || 50);
  const bPerC = (boiteId==='NONE') ? 0 : (+t.boite_par_circuit || 10);
  const gBase = +t.goulotte_base || 50;
  const gPerM = +t.goulotte_par_m || 20;
  return roundUp5(nbCircuits*parCircuit + bBase + nbCircuits*bPerC + gBase + (Math.max(0,+lgM)*gPerM));
}
function calcRemplacementCoffretTotal(rang, modTxt, pose){
  const m = /(\d+)/.exec(modTxt||''); const mod = m? +m[1] : 13;
  const basePrix=100, coefPose=(pose==='Encastr√©'?1.7:1);
  return roundUp5(basePrix*coefPose*( (+rang||1) * (mod/13) ));
}

function refreshMtPreview(){
  const n  = +document.getElementById('mt-circuits').value || 0;
  const b  = document.getElementById('mt-boite').value;
  const lm = +document.getElementById('mt-goulotte').value || 0;

  const gamme = document.getElementById('rc-gamme').value;
  const mod   = document.getElementById('rc-mod').value;
  const rang  = (document.getElementById('rc-range').value||'').replace(/\D/g,'')||'1';
  const pose  = document.getElementById('rc-pose').value;

  const lblBoite = (b==='NONE') ? 'Aucune bo√Æte' : (TABMODS_BOITES.find(x=>x.id===b)?.label || b);
  const t1 = calcDeplacementTotal(n,b,lm);
  let recap = `R√©cap d√©placement : ${n} circuit(s) ‚Äî ${lblBoite} ‚Äî goulotte ${lm.toFixed(1)} m ‚Üí <strong>${euro(t1)}</strong>`;

  if(gamme && gamme!=='Aucun'){
    const t2 = calcRemplacementCoffretTotal(+rang, mod, pose);
    recap += `<br>Remplacement coffret : ${rang} rang√©e(s) ‚Äî ${mod} ‚Äî ${gamme} ‚Äî Pose ${pose} ‚Üí <strong>${euro(t2)}</strong>`;
  }else{
    recap += `<br>Remplacement coffret : <em>non s√©lectionn√©</em>`;
  }

  document.getElementById('mt-preview').innerHTML = recap;
}

function addTabMod_Deplacement(){
  const n  = +document.getElementById('mt-circuits').value || 0;
  const b  = document.getElementById('mt-boite').value;
  const lm = +document.getElementById('mt-goulotte').value || 0;
  const lbl = (b==='NONE') ? 'Aucune bo√Æte' : (TABMODS_BOITES.find(x=>x.id===b)?.label || b);
  const totalDep = calcDeplacementTotal(n,b,lm);

  const gamme = document.getElementById('rc-gamme').value;
  const mod   = document.getElementById('rc-mod').value;
  const rang  = (document.getElementById('rc-range').value||'').replace(/\D/g,'')||'1';
  const pose  = document.getElementById('rc-pose').value;

  ensureTabModsSection();
  // Ligne 1 : D√©placement
  devis[TABMODS_SECTION_KEY].items.push({
    category:'Modification emplacement Tableau',
    designation:`Circuits √† rallonger : ${n} ‚Äî Bo√Æte : ${lbl} ‚Äî Goulotte : ${lm.toFixed(1)} m`,
    qty:1, prixU:totalDep
  });

  // Ligne 2 (facultative) : Remplacement coffret
  if(gamme && gamme!=='Aucun'){
    const totalCof = calcRemplacementCoffretTotal(+rang, mod, pose);
    devis[TABMODS_SECTION_KEY].items.push({
      category:'Remplacement coffret',
      designation:`${gamme} ‚Äî ${rang} rang√©e(s) √ó ${mod} ‚Äî Pose ${pose}`,
      qty:1, prixU:totalCof
    });
  }

  saveLocal();
  alert('‚úÖ Modification ajout√©e √† l‚Äôestimatif.');
  pageTabModsAccueil();
}

// =============================================================
// ¬ß9.4 ‚Ä¢ Rec√¢blage tableau existant
//   - Remplacement coffret (sans ‚Äúd√©pose existant‚Äù)
//   - Nb de circuits √† rec√¢bler (10‚Ç¨ / u)
//   - Mat√©riel suppl√©mentaire (s√©lecteur multi-lignes)
// =============================================================
let _recab_suppl = []; // { type, qty, pu }

function pageTabModsRecablage(){
  const marques = ['Aucun'].concat(TABMODS_COFFRET_GAMMES).map(m=>`<option value="${m}">${m}</option>`).join('');
  const modules = TABMODS_COFFRET_MODULES.map(m=>`<option value="${m}">${m}</option>`).join('');
  const ranges  = TABMODS_COFFRET_RANGES.map(r=>`<option value="${r}">${r} rang√©e(s)</option>`).join('');
  const circuits = Array.from({length:31},(_,i)=>`<option value="${i}">${i}</option>`).join('');

  const MAT = TARIFS_TABMODS.recablage.materiel || {};
  const types = Object.keys(MAT);
  const typeOptions = types.map(t=>`<option value="${t}">${t}</option>`).join('');

  // tableau lignes mat√©rielles actuelles
  function tableSuppl(){
    if(!_recab_suppl.length) return '<div class="muted">Aucun mat√©riel ajout√©.</div>';
    const rows = _recab_suppl.map((it,i)=>(
      `<tr>
        <td>${it.type}</td>
        <td style="text-align:right">${(+it.pu||0).toFixed(2)} ‚Ç¨</td>
        <td style="text-align:right">${(+it.qty||0)}</td>
        <td style="text-align:right">${(+it.pu*(+it.qty)).toFixed(2)} ‚Ç¨</td>
        <td>${b('√ó','recabDel('+i+')','btn')}</td>
      </tr>`
    )).join('');
    return `<table class="table-mini">
      <thead><tr><th>√âl√©ment</th><th>PU</th><th>Qt√©</th><th>Total</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  }

  view(
    '<div class="card">'
      + b('Retour','pageTabModsAccueil()','btn back')
      + '<h2>Rec√¢blage tableau existant</h2>'

      + '<div class="fieldset">'
        + '<h3>1) Remplacement coffret (facultatif)</h3>'
        + '<label class="vblock">Marque / Gamme</label>'
        + '<select id="rb-gamme">'+marques+'</select>'
        + '<label class="vblock">Modules par rang√©e</label>'
        + '<select id="rb-mod">'+modules+'</select>'
        + '<label class="vblock">Nombre de rang√©es</label>'
        + '<select id="rb-range">'+ranges+'</select>'
        + '<label class="vblock">Type de pose</label>'
        + '<select id="rb-pose"><option>Saillie</option><option>Encastr√©</option></select>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>2) Circuits √† rec√¢bler</h3>'
        + '<select id="rb-circuits">'+circuits+'</select>'
        + '<small class="muted vblock">Tarif : '+euro(+TARIFS_TABMODS.recablage.par_circuit||10)+' / circuit</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>3) Mat√©riel suppl√©mentaire</h3>'
        + '<div class="row gap8">'
          + '<select id="rb-type">'+typeOptions+'</select>'
          + '<input id="rb-pu" type="number" inputmode="decimal" step="0.1" min="0" placeholder="PU (‚Ç¨)" />'
          + '<input id="rb-qty" type="number" inputmode="numeric" step="1" min="1" value="1" placeholder="Qt√©" />'
          + b('Ajouter','recabAdd()','btn')
        + '</div>'
        + '<div id="rb-table" class="mtx">'+tableSuppl()+'</div>'
      + '</div>'

      + '<div id="rb-preview" class="muted mtx"></div>'
      + '<div class="row mtx" style="gap:8px;">'
        + b('Ajouter au devis','addTabMod_Recablage()','btn primary')
      + '</div>'
    + '</div>'
  );

  // init champs PU auto
  const sel = document.getElementById('rb-type');
  const puIn = document.getElementById('rb-pu');
  const setDefaultPU = ()=>{ const k = sel.value; const d = (TARIFS_TABMODS.recablage.materiel||{})[k]||0; puIn.value = (+d||0).toFixed(2); };
  if(sel){ sel.addEventListener('change', setDefaultPU); setDefaultPU(); }

  ['rb-gamme','rb-mod','rb-range','rb-pose','rb-circuits'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('input', refreshRecabPreview);
  });
  refreshRecabPreview();

  // expose handlers locaux
  window.recabAdd = function(){
    const type = (document.getElementById('rb-type')?.value||'').trim();
    const pu   = parseFloat(document.getElementById('rb-pu')?.value)||0;
    const qty  = parseInt(document.getElementById('rb-qty')?.value,10)||1;
    if(!type || pu<=0 || qty<=0) return;
    _recab_suppl.push({type, pu:+pu, qty:+qty});
    pageTabModsRecablage();
  };
  window.recabDel = function(i){
    _recab_suppl.splice(i,1);
    pageTabModsRecablage();
  };
}

function calcRecabCoffret(gamme, rang, modTxt, pose){
  if(!gamme || gamme==='Aucun') return 0;
  return calcRemplacementCoffretTotal(+rang, modTxt, pose);
}
function calcRecabCircuits(n){ return roundUp5( ( +TARIFS_TABMODS.recablage.par_circuit || 10 ) * Math.max(0,+n) ); }
function calcRecabSupplTotal(){
  return roundUp5((_recab_suppl||[]).reduce((s,it)=> s + ((+it.pu||0)*(+it.qty||0)), 0));
}

function refreshRecabPreview(){
  const gamme = document.getElementById('rb-gamme')?.value || 'Aucun';
  const mod   = document.getElementById('rb-mod')?.value || '13 modules';
  const rang  = (document.getElementById('rb-range')?.value||'1').replace(/\D/g,'')||'1';
  const pose  = document.getElementById('rb-pose')?.value || 'Saillie';
  const n     = +document.getElementById('rb-circuits')?.value || 0;

  const tCof = calcRecabCoffret(gamme, rang, mod, pose);
  const tCir = calcRecabCircuits(n);
  const tSup = calcRecabSupplTotal();
  const total = roundUp5(tCof + tCir + tSup);

  document.getElementById('rb-preview').innerHTML =
    `Rempl. coffret : ${(gamme==='Aucun')?'‚Äî':`${rang} rang√©e(s) ‚Äî ${mod} ‚Äî ${gamme} ‚Äî Pose ${pose} ‚Üí <strong>${euro(tCof)}</strong>`}`
    + `<br>Circuits √† rec√¢bler : ${n} ‚Üí <strong>${euro(tCir)}</strong>`
    + `<br>Mat√©riel suppl√©mentaire : <strong>${euro(tSup)}</strong>`
    + `<br>Total estim√© : <strong>${euro(total)}</strong>`;
}

function addTabMod_Recablage(){
  const gamme = document.getElementById('rb-gamme')?.value || 'Aucun';
  const mod   = document.getElementById('rb-mod')?.value || '13 modules';
  const rang  = (document.getElementById('rb-range')?.value||'1').replace(/\D/g,'')||'1';
  const pose  = document.getElementById('rb-pose')?.value || 'Saillie';
  const n     = +document.getElementById('rb-circuits')?.value || 0;

  ensureTabModsSection();

  // (a) Remplacement coffret (si choisi)
  if(gamme && gamme!=='Aucun'){
    const tCof = calcRecabCoffret(gamme, rang, mod, pose);
    devis[TABMODS_SECTION_KEY].items.push({
      category:'Rec√¢blage tableau existant ‚Äî Remplacement coffret',
      designation:`${gamme} ‚Äî ${rang} rang√©e(s) √ó ${mod} ‚Äî Pose ${pose}`,
      qty:1, prixU:tCof
    });
  }
  // (b) Circuits √† rec√¢bler
  const tCir = calcRecabCircuits(n);
  devis[TABMODS_SECTION_KEY].items.push({
    category:'Rec√¢blage tableau existant ‚Äî Circuits',
    designation:`Nombre de circuits √† rec√¢bler : ${n}`,
    qty:1, prixU:tCir
  });
  // (c) Mat√©riel suppl√©mentaire (lignes d√©taill√©es)
  (_recab_suppl||[]).forEach(it=>{
    devis[TABMODS_SECTION_KEY].items.push({
      category:'Rec√¢blage tableau existant ‚Äî Mat√©riel suppl.',
      designation:`${it.type}`,
      qty:+it.qty||1, prixU:+it.pu||0
    });
  });

  saveLocal();
  _recab_suppl = [];
  alert('‚úÖ Rec√¢blage ajout√© √† l‚Äôestimatif.');
  pageTabModsAccueil();
}

// =======================
// ¬ß9.5 ‚Ä¢ Expose (window)
// =======================
Object.assign(window,{
  pageTabModsAccueil,
  pageTabModsDeplacement,
  pageTabModsRecablage,
  addTabMod_Deplacement,
  addTabMod_Recablage
});
</script>














  

  

<!-- =============================
     CHAPITRE 10 : FACTURATION (COMPLET)
     Index :
       10.0 ‚Ä¢ Styles & helpers (format ‚Ç¨, date, lecture prefs/soci√©t√©)
       10.1 ‚Ä¢ TVA effective & total HT du document
       10.2 ‚Ä¢ Num√©rotation facture (aper√ßu + incr√©ment apr√®s export)
       10.3 ‚Ä¢ G√©n√©ration FACTURE TXT (tout compris / s√©par√©e)
       10.4 ‚Ä¢ G√©n√©ration FACTURE CSV (2 lignes : Prestations / Mat√©riel)
       10.5 ‚Ä¢ Sauvegarde locale des factures (snapshots)
       10.6 ‚Ä¢ Page "Mes factures" (ouvrir, renommer, dupliquer, supprimer, exporter)
       10.7 ‚Ä¢ Boutons d‚Äôexport (injection robuste dans Estimatif & Totaux)
       10.8 ‚Ä¢ Expose global (window)
     ============================= -->

<style>
  .fact-wrap .card{ margin-bottom:24px; }
  .table-mini{ width:100%; border-collapse:collapse; margin-top:10px; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
  .muted{ color:var(--muted); font-size:14px; }
  .row.gap8{ gap:8px; flex-wrap:wrap; }
</style>

<script>
/* =============================
   10.0 ‚Ä¢ Styles & helpers
   ============================= */
function _f10_readJSON(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function _f10_writeJSON(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

function _f10_prefs(){ return _f10_readJSON('appPrefs_v1', { facturation_mode:'tout_compris', devise:'‚Ç¨', tva_applicable:false, taux_tva:20, numerotation_fact_prefix:'FAC-', numerotation_courante:1 }); }
function _f10_company(){ return _f10_readJSON('companyConfig_v1', {}); }

function _f10_fmtEuro(n, sym){ var s=(sym||'‚Ç¨').trim(); return (+(n||0)).toFixed(2)+' '+s; }
function _f10_todayFR(){
  try{ return new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit'}); }
  catch(e){ return new Date().toLocaleDateString(); }
}
function _f10_clone(x){ return JSON.parse(JSON.stringify(x)); }

/* =============================
   10.1 ‚Ä¢ TVA effective & total HT
   (le devis courant peut contenir __tva_applicable / __taux_tva)
   ============================= */
function _f10_effectiveTVA_from(obj){
  var prefs=_f10_prefs();
  var on  = (obj && typeof obj.__tva_applicable!=='undefined') ? !!obj.__tva_applicable : !!prefs.tva_applicable;
  var tx  = (obj && typeof obj.__taux_tva!=='undefined') ? Math.max(0,+obj.__taux_tva||0) : Math.max(0,+prefs.taux_tva||20);
  return { on:on, taux:tx };
}
function _f10_sumHT_from(obj){
  var sum=0;
  if(!obj) return 0;
  for(var k in obj){
    if(k.indexOf('__')===0) continue;
    var s=obj[k], items=(s&&s.items)||[];
    for(var i=0;i<items.length;i++){
      var it=items[i];
      sum += ((+it.prixU||0) * (+it.qty||0));
    }
  }
  return sum;
}

/* =============================
   10.2 ‚Ä¢ Num√©rotation facture
   - aper√ßu (FAC-0007)
   - incr√©ment APR√àS export
   ============================= */
function _f10_invoiceNumberPreview(){
  var p=_f10_prefs();
  var prefix=p.numerotation_fact_prefix||'FAC-';
  var num=Math.max(1, parseInt(p.numerotation_courante||1,10));
  return prefix + String(num).padStart(4,'0');
}
function _f10_incrementAfterExport(){
  var p=_f10_prefs();
  var cur=Math.max(1, parseInt(p.numerotation_courante||1,10));
  p.numerotation_courante = cur + 1;
  _f10_writeJSON('appPrefs_v1', p);
}

/* =============================
   10.3 ‚Ä¢ G√©n√©ration FACTURE TXT
   - mode tout_compris
   - mode s√©par√© (demande % mat√©riel si non fourni)
   ============================= */
function _f10_buildInvoiceText_fromSnapshot(snap, opts){
  opts = opts||{};
  var prefs=_f10_prefs(), company=_f10_company();
  var devise=prefs.devise||'‚Ç¨';

  var eff=_f10_effectiveTVA_from(snap);
  var tvaOn=!!eff.on, tauxTVA=Math.max(0,+eff.taux||20);

  var totalHT=_f10_sumHT_from(snap);
  var mode=(opts.mode || prefs.facturation_mode || 'tout_compris'); // 'separe'|'tout_compris'
  var ratioMat=0, ratioPrest=1;

  if(mode==='separe'){
    var pct = (typeof opts.matPct==='number') ? opts.matPct : parseFloat(prompt('Facture s√©par√©e : % MAT√âRIEL ?', '40'));
    if(isNaN(pct)) pct=40;
    pct=Math.min(100,Math.max(0,pct));
    ratioMat=pct/100; ratioPrest=1-ratioMat;
  }

  var totalMatHT   = (mode==='separe') ? (totalHT * ratioMat)   : 0;
  var totalPrestHT = (mode==='separe') ? (totalHT * ratioPrest) : totalHT;

  var tvaPrest = tvaOn ? (totalPrestHT * tauxTVA/100) : 0;
  var tvaMat   = tvaOn ? (totalMatHT   * tauxTVA/100) : 0;

  var out=[];
  out.push('================= FACTURE =================');
  out.push('Date : '+_f10_todayFR());
  out.push('N¬∞   : '+_f10_invoiceNumberPreview());
  out.push('');

  // √âmetteur
  out.push('√âmetteur :');
  var rs=(company.raison_sociale||company.nom_commercial||'').trim(); if(rs) out.push('  '+rs);
  var adr=[company.adresse,company.code_postal,company.ville].filter(Boolean).join(' '); if(adr) out.push('  '+adr);
  if(company.pays) out.push('  '+company.pays);
  if(company.email) out.push('  Email : '+(company.email||''));
  if(company.telephone) out.push('  T√©l   : '+(company.telephone||''));
  if(company.siren) out.push('  SIREN : '+(company.siren||''));
  if(company.tva_intracom) out.push('  TVA   : '+(company.tva_intracom||''));
  out.push('========================================================'); out.push('');

  if(mode==='separe'){
    out.push('1) Prestations de services');
    out.push('   Montant HT  : '+_f10_fmtEuro(totalPrestHT, devise));
    if(tvaOn) out.push('   TVA ('+tauxTVA+'%) : '+_f10_fmtEuro(tvaPrest, devise));
    out.push('   Montant TTC : '+_f10_fmtEuro(totalPrestHT + tvaPrest, devise));
    out.push('');

    out.push('2) Vente de mat√©riel');
    out.push('   Montant HT  : '+_f10_fmtEuro(totalMatHT, devise));
    if(tvaOn) out.push('   TVA ('+tauxTVA+'%) : '+_f10_fmtEuro(tvaMat, devise));
    out.push('   Montant TTC : '+_f10_fmtEuro(totalMatHT + tvaMat, devise));
    out.push('');

    out.push('[Info] R√©partition : Mat√©riel = '+Math.round(ratioMat*100)+'% | Prestations = '+Math.round(ratioPrest*100)+'%');
    out.push('');
  }else{
    out.push('1) Fournitures + pose (tout compris)');
    out.push('   Montant HT  : '+_f10_fmtEuro(totalHT, devise));
    if(tvaOn) out.push('   TVA ('+tauxTVA+'%) : '+_f10_fmtEuro(totalHT * tauxTVA/100, devise));
    out.push('   Montant TTC : '+_f10_fmtEuro(totalHT + (tvaOn? totalHT*tauxTVA/100 : 0), devise));
    out.push('');
  }

  var htGlobal  = (mode==='separe') ? (totalPrestHT + totalMatHT) : totalHT;
  var tvaGlobal = tvaOn ? ((mode==='separe') ? (tvaPrest + tvaMat) : (totalHT * tauxTVA/100)) : 0;

  out.push('================= R√âCAPITULATIF =================');
  out.push('Total HT  : '+_f10_fmtEuro(htGlobal, devise));
  if(tvaOn) out.push('TVA       : '+_f10_fmtEuro(tvaGlobal, devise));
  out.push('Total TTC : '+_f10_fmtEuro(htGlobal + tvaGlobal, devise));
  out.push('================================================='); out.push('');

  if(company.conditions_paiement) out.push('Conditions de paiement : '+company.conditions_paiement);
  if(company.iban) out.push('IBAN : '+company.iban+(company.bic?(' ‚Äî BIC : '+company.bic):''));
  if(company.rc_pro) out.push('RC Pro : '+company.rc_pro);
  if(company.decennale) out.push('D√©cennale : '+company.decennale);
  if(company.assureur) out.push('Assureur : '+company.assureur);
  if(company.mentions_legales){ out.push(''); out.push(company.mentions_legales); }

  return out.join('\r\n');
}

function f10_exportInvoiceTXT_Current(mode){ // mode: 'tout_compris' | 'separe' | 'auto'
  var snap = window.devis || null;
  if(!snap){ alert('Aucun document en cours.'); return; }
  var prefs=_f10_prefs();
  var useMode = (mode && mode!=='auto') ? mode : (prefs.facturation_mode||'tout_compris');

  var txt = _f10_buildInvoiceText_fromSnapshot(snap, { mode:useMode });
  var name = (snap.__name || 'Document').trim() || 'Document';
  var blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase() + (useMode==='separe'?'_facture_sep':'_facture') + '.txt';
  a.click(); URL.revokeObjectURL(url);

  _f10_incrementAfterExport();
  alert('‚úÖ Facture (texte) export√©e.');
}

/* =============================
   10.4 ‚Ä¢ G√©n√©ration FACTURE CSV
   (2 lignes : Prestations / Mat√©riel)
   ============================= */
function _f10_csv_build_fromSnapshot(snap, matPct){
  var prefs=_f10_prefs();
  var eff=_f10_effectiveTVA_from(snap);
  var tvaOn=!!eff.on, tauxTVA=Math.max(0,+eff.taux||20);

  var totalHT=_f10_sumHT_from(snap);
  var matRatio=Math.min(100,Math.max(0,parseFloat(matPct||40)))/100;
  var prestRatio=1-matRatio;
  var totalMatHT=totalHT*matRatio, totalPrestHT=totalHT*prestRatio;

  function fmt(n){ return (+(n||0)).toFixed(2).replace('.',','); }
  function esc(s){ s=String(s==null?'':s); return (s.indexOf(';')>=0 || s.indexOf('"')>=0 || s.indexOf('\n')>=0) ? ('"'+s.replace(/"/g,'""')+'"') : s; }

  var date=_f10_todayFR(), unit='lot', qty=1;
  var name=(snap && snap.__name ? String(snap.__name).trim() : 'Document');
  var lines=[ ['Date','Libell√©','Quantit√©','Unit√©','PU HT','Montant HT','TVA %','Cat√©gorie'].join(';') ];

  lines.push([ esc(date), esc('Prestations ‚Äî '+name), esc(qty), esc(unit), fmt(totalPrestHT), fmt(totalPrestHT), esc(tvaOn?tauxTVA:0), esc('Prestations') ].join(';'));
  lines.push([ esc(date), esc('Mat√©riel ‚Äî '+name),   esc(qty), esc(unit), fmt(totalMatHT),   fmt(totalMatHT),   esc(tvaOn?tauxTVA:0), esc('Mat√©riel')   ].join(';'));

  return lines.join('\r\n');
}
function f10_exportInvoiceCSV_Current(){
  var snap = window.devis || null;
  if(!snap){ alert('Aucun document en cours.'); return; }
  var ask = prompt('Pourcentage MAT√âRIEL (0‚Äì100) ?', '40'); if(ask==null) return;
  var csv = _f10_csv_build_fromSnapshot(snap, ask);
  var name = (snap.__name || 'Document').trim() || 'Document';
  var blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_facture.csv';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ CSV (facture) export√© : 2 lignes (Prestations / Mat√©riel).');
}

/* =============================
   10.5 ‚Ä¢ Sauvegarde locale des factures
   - snapshots ind√©pendants du "devis" courant
   ============================= */
const F10_KEY_INVOICES = 'invoices_v1';

function f10_invoices_read(){ return _f10_readJSON(F10_KEY_INVOICES, []); }
function f10_invoices_write(arr){ _f10_writeJSON(F10_KEY_INVOICES, arr||[]); }

function f10_newId(){ return 'fac_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8); }

function f10_saveCurrentAsInvoice(){
  if(!window.devis){ alert('Aucun document en cours.'); return; }
  var prefs=_f10_prefs();
  var inv={
    __id: f10_newId(),
    name: (devis.__name || 'Document').trim() || 'Document',
    created_at: new Date().toISOString(),
    mode: prefs.facturation_mode || 'tout_compris',
    snapshot: _f10_clone(devis)
  };
  var list=f10_invoices_read(); list.unshift(inv); f10_invoices_write(list);
  alert('‚úÖ Facture enregistr√©e.');
}

/* =============================
   10.6 ‚Ä¢ Page "Mes factures"
   ============================= */
function pageFactures(){
  var list=f10_invoices_read();
  var html = '<div class="fact-wrap">'
    + '<div class="card">'
      + (typeof b==='function'? b('Retour','pageHome ? pageHome() : pageMain()','btn back') : '')
      + '<h2>Mes factures</h2>'
      + '<div class="row gap8" style="margin-top:8px;">'
        + (typeof b==='function'? b('Transformer le document courant en facture','f10_saveCurrentAsInvoice()','btn primary') : '<button class="btn" onclick="f10_saveCurrentAsInvoice()">Transformer le document courant en facture</button>')
      + '</div>'
      + '<p class="muted">N¬∞ prochain : '+_f10_invoiceNumberPreview()+'</p>'
    + '</div>';

  if(!list.length){
    html += '<div class="card"><p class="muted">Aucune facture sauvegard√©e pour le moment.</p></div>';
  }else{
    html += '<div class="card">'
      + '<table class="table-mini"><thead><tr>'
      + '<th>Nom</th><th>Cr√©√©e le</th><th>Mode</th><th>Actions</th>'
      + '</tr></thead><tbody>';
    list.forEach(function(inv){
      var d=new Date(inv.created_at).toLocaleString('fr-FR');
      html += '<tr>'
        + '<td>'+ (inv.name||'Facture') +'</td>'
        + '<td>'+ d +'</td>'
        + '<td>'+ (inv.mode==='separe'?'S√©par√©':'Tout compris') +'</td>'
        + '<td>'
          + (typeof b==='function'
              ? b('Ouvrir (√©diter)','f10_openInvoice(\''+inv.__id+'\')','btn')
              + b('Renommer','f10_renameInvoice(\''+inv.__id+'\')','btn')
              + b('Dupliquer','f10_duplicateInvoice(\''+inv.__id+'\')','btn')
              + b('Supprimer','f10_deleteInvoice(\''+inv.__id+'\')','btn')
              + b('TXT (TC)','f10_exportInvoiceTXT_FromStored(\''+inv.__id+'\',\'tc\')','btn')
              + b('TXT (S√©par√©)','f10_exportInvoiceTXT_FromStored(\''+inv.__id+'\',\'sep\')','btn')
              + b('CSV','f10_exportInvoiceCSV_FromStored(\''+inv.__id+'\')','btn')
              : '<button class="btn" onclick="f10_openInvoice(\''+inv.__id+'\')">Ouvrir</button>'
                + '<button class="btn" onclick="f10_renameInvoice(\''+inv.__id+'\')">Renommer</button>'
                + '<button class="btn" onclick="f10_duplicateInvoice(\''+inv.__id+'\')">Dupliquer</button>'
                + '<button class="btn" onclick="f10_deleteInvoice(\''+inv.__id+'\')">Supprimer</button>'
                + '<button class="btn" onclick="f10_exportInvoiceTXT_FromStored(\''+inv.__id+'\',\'tc\')">TXT (TC)</button>'
                + '<button class="btn" onclick="f10_exportInvoiceTXT_FromStored(\''+inv.__id+'\',\'sep\')">TXT (S√©par√©)</button>'
                + '<button class="btn" onclick="f10_exportInvoiceCSV_FromStored(\''+inv.__id+'\')">CSV</button>')
        + '</td>'
      + '</tr>';
    });
    html += '</tbody></table></div>';
  }

  html += '</div>';
  view(html);
}

/* Handlers pageFactures */
function f10_findInvoice(id){ return f10_invoices_read().find(x=>x.__id===id); }
function f10_openInvoice(id){
  var inv=f10_findInvoice(id); if(!inv){ alert('Introuvable.'); return; }
  window.devis=_f10_clone(inv.snapshot||{});
  if(typeof saveLocal==='function') saveLocal();
  alert('‚úÖ Facture ouverte comme document modifiable.\nTu peux ajuster puis exporter.');
  if(typeof pageEstimatif==='function') pageEstimatif();
}
function f10_deleteInvoice(id){
  if(!confirm('Supprimer cette facture ?')) return;
  var list=f10_invoices_read().filter(x=>x.__id!==id); f10_invoices_write(list);
  pageFactures();
}
function f10_duplicateInvoice(id){
  var inv=f10_findInvoice(id); if(!inv) return;
  var copy=_f10_clone(inv); copy.__id=f10_newId(); copy.created_at=new Date().toISOString();
  var list=f10_invoices_read(); list.unshift(copy); f10_invoices_write(list);
  pageFactures();
}
function f10_renameInvoice(id){
  var inv=f10_findInvoice(id); if(!inv) return;
  var nn=prompt('Nouveau nom de facture :', inv.name||''); if(nn==null) return;
  inv.name = (nn||'').trim()||inv.name;
  var list=f10_invoices_read().map(x=> x.__id===id ? inv : x); f10_invoices_write(list);
  pageFactures();
}

/* Exports depuis snapshot stock√© */
function f10_exportInvoiceTXT_FromStored(id, mode){ // mode: 'tc' | 'sep'
  var inv=f10_findInvoice(id); if(!inv) return;
  var txt=_f10_buildInvoiceText_fromSnapshot(inv.snapshot, { mode:(mode==='sep'?'separe':'tout_compris') });
  var blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url; a.download=(inv.name||'facture').replace(/\s+/g,'_').toLowerCase() + (mode==='sep'?'_sep':'_tc') + '.txt';
  a.click(); URL.revokeObjectURL(url);
}
function f10_exportInvoiceCSV_FromStored(id){
  var inv=f10_findInvoice(id); if(!inv) return;
  var ask=prompt('Pourcentage MAT√âRIEL (0‚Äì100) ?','40'); if(ask==null) return;
  var csv=_f10_csv_build_fromSnapshot(inv.snapshot, ask);
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  a.href=url; a.download=(inv.name||'facture').replace(/\s+/g,'_').toLowerCase()+'_facture.csv';
  a.click(); URL.revokeObjectURL(url);
}

/* =============================
   10.7 ‚Ä¢ Boutons d‚Äôexport ‚Äî injection robuste
   - Ajoute sur Estimatif & Totaux :
     ‚Ä¢ "üí∂ Facture TXT"
     ‚Ä¢ "üí∂ Facture CSV"
   ============================= */
(function f10_injectExportButtons(){
  function addBtns(){
    var app=document.getElementById('app'); if(!app) return;

    // √©vite doublons
    if(app.innerHTML.indexOf('f10_exportInvoiceTXT_Current(')!==-1
      && app.innerHTML.indexOf('f10_exportInvoiceCSV_Current()')!==-1) return;

    // zone d'exports d√©j√† existante (selon chapitres)
    var anchor =
      app.querySelector('.row button[onclick*="exportZipFull"]')?.closest('.row') ||
      app.querySelector('.row button[onclick*="exportTextFull"]')?.closest('.row') ||
      app.querySelector('.row:last-of-type');

    var wrap=document.createElement('div');
    wrap.className='row';
    wrap.style.marginTop='10px';
    wrap.innerHTML =
      '<button class="btn" onclick="f10_exportInvoiceTXT_Current(\'auto\')">üí∂ Facture (TXT)</button>'
      + '<button class="btn" onclick="f10_exportInvoiceTXT_Current(\'separe\')">üí∂ Facture (TXT s√©par√©)</button>'
      + '<button class="btn" onclick="f10_exportInvoiceCSV_Current()">üí∂ Facture (CSV ‚Äî compta)</button>';

    (anchor?anchor.parentNode:app).appendChild(wrap);
  }

  var oE=window.pageEstimatif, oT=window.pageTotaux;
  if(typeof oE==='function'){ window.pageEstimatif=function(){ oE(); addBtns(); }; }
  if(typeof oT==='function'){ window.pageTotaux=function(){ oT(); addBtns(); }; }
})();

/* =============================
   10.8 ‚Ä¢ Expose
   ============================= */
Object.assign(window, {
  // Page & store
  pageFactures,
  f10_saveCurrentAsInvoice,
  f10_openInvoice,
  f10_deleteInvoice,
  f10_duplicateInvoice,
  f10_renameInvoice,

  // Exports courants
  f10_exportInvoiceTXT_Current,
  f10_exportInvoiceCSV_Current,

  // Exports depuis "Mes factures"
  f10_exportInvoiceTXT_FromStored,
  f10_exportInvoiceCSV_FromStored
});
</script>



  



  



  



  




  
  <!-- =============================
     CHAPITRE 11 : ESTIMATIF & EXPORTS ‚Äî COMPLET
     Index :
       11.0 ‚Ä¢ D√©tection / libell√© des pi√®ces (Tableaux inclus)
       11.1 ‚Ä¢ Tri d√©di√© aux Tableaux (diff ‚Üí coupure ‚Üí disjoncteurs ‚Üí reste)
       11.2 ‚Ä¢ Pages : Estimatif d√©taill√© & Totaux par groupe
       11.3 ‚Ä¢ Exports : .txt par groupe / .zip par groupe
       11.4 ‚Ä¢ Exports : complet .txt / complet .zip
       11.5 ‚Ä¢ DEVIS (TXT) : tout compris & s√©par√© Prestations/Mat√©riel
       11.6 ‚Ä¢ Expose (window)
     ============================= -->
<style>
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<script>
// =============================
// 11.0 ‚Ä¢ D√©tection & libell√©s
// =============================
window.PIECE_GROUPS = window.PIECE_GROUPS || {
  "Buanderie":"Pi√®ces techniques","Garage":"Pi√®ces techniques","Atelier":"Pi√®ces techniques",
  "Jardin":"Ext√©rieur","Terrasse":"Ext√©rieur","Balcon":"Ext√©rieur","Abri de jardin":"Ext√©rieur",
  "Cuisine":"Cuisine",
  "Salon":"Pi√®ces de vie","Salle √† manger":"Pi√®ces de vie","Couloir":"Pi√®ces de vie","Entr√©e":"Pi√®ces de vie",
  "Salle de bain":"Pi√®ces d'eau","Salle d'eau":"Pi√®ces d'eau","Toilettes":"Pi√®ces d'eau",
  "Chambre 1":"Chambres & Bureau","Chambre 2":"Chambres & Bureau","Chambre 3":"Chambres & Bureau",
  "Bureau":"Chambres & Bureau","Biblioth√®que":"Chambres & Bureau",
  "Tableau":"Tableau & distribution","Distribution":"Tableau & distribution",
  "Mise √† la terre":"Mise √† la terre","VMC":"VMC"
};

// Format ‚Ç¨ robuste (utilise euro() s‚Äôil existe, sinon fallback local)
function _euro11(n){
  if(typeof euro==='function') return euro(n);
  var v = (+n||0);
  return v.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2})+' ‚Ç¨';
}

function groupDevis(){
  var g = {};
  for (var key in devis){
    if (key.indexOf("__") === 0) continue;
    var s = devis[key];
    var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
    var grp  = window.PIECE_GROUPS[base] || "Divers";
    if (!g[grp]) g[grp] = {};
    g[grp][key] = s;
  }
  return g;
}
function isTableauKey(key){
  var s = devis[key] || {};
  return ((s.__base||'').toLowerCase()==='tableau') || /^Tableau\s/i.test(key);
}
function pieceDisplayLabel(key){
  var s = devis[key] || {};
  var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
  var qual = s.qualificatif || '';
  var etg  = s.etage || '';
  var label = base===key ? key : (base + (qual ? ' ('+qual+')':'') + (etg ? ' ‚Äî '+etg:''));
  if(isTableauKey(key) && s.__customName && s.__customName.trim()){
    label = key + ' ‚Äî ' + s.__customName.trim();
  }else{
    if(!isTableauKey(key)){
      label = (typeof formatPieceLabel === 'function') ? formatPieceLabel(key) : key;
    }else{
      label = key;
    }
  }
  return label;
}

// ========================================
// 11.1 ‚Ä¢ Tri d√©di√© aux Tableaux (esth√©tique)
// ========================================
function sortedItemsForPiece(key, items){
  if(!Array.isArray(items)) return [];
  if(!isTableauKey(key)) return items.slice();

  function score(it){
    var d = (it && it.designation ? String(it.designation) : '').trim();
    if (/^ID\s/i.test(d))             return 0;
    if (/^Coupure g√©n√©rale/i.test(d)) return 1;
    if (/^Disjoncteur\s/i.test(d))    return 2;
    return 3;
  }
  return items.map(function(it, i){ return {it:it, i:i, s:score(it)}; })
              .sort(function(a,b){ return (a.s - b.s) || (a.i - b.i); })
              .map(function(x){ return x.it; });
}

// ===========================================
// 11.2 ‚Ä¢ Pages : Estimatif & Totaux par groupe
// ===========================================
function itemLine(it){
  var unit = it.unit || "u";
  var poseTxt = (it.intervention === "Cr√©ation" && it.pose) ? (" - " + String(it.pose).toLowerCase()) : "";
  var left = it.intervention ? (it.intervention + " ‚Äî ") : "";
  var pu = (+it.prixU || 0).toFixed(2);
  var q  = +it.qty || 0;
  var total = (q * (+it.prixU || 0)).toFixed(2);
  return "- " + left + it.designation + poseTxt + " | Qt√©: " + q + " " + unit + " | PU: " + pu + "‚Ç¨ | Total: " + total + "‚Ç¨";
}
function pieceSeparator(label){ return "\n---------------- " + label + " ----------------\n"; }

function pageEstimatif(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Estimatif d√©taill√©</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    html += '<h2 style="border-top:2px solid #000; padding-top:8px;">'+grp+'</h2>';
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var pieceLabel = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var sectionTotal = 0;

      html += '<h3 style="margin-top:6px; border-top:1px solid #ccc; padding-top:4px;">'+pieceLabel+'</h3><ul>';
      items.forEach(function(it){
        var q  = +it.qty || 0;
        var pu = +it.prixU || 0;
        var t  = q * pu;
        sectionTotal += t; groupTotal += t; totalGlobal += t;

        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? (" " + String(it.pose).toLowerCase()) : "";
        var unit    = it.unit || "u";
        var left    = it.intervention ? (it.intervention+" ‚Äî ") : "";
        html += '<li>' + left + it.designation + poseTxt + ' ('+q+' '+unit+' √ó '+_euro11(pu)+' = '+_euro11(t)+')</li>';
      });
      if (s.note) html += '<li><em>Note : '+s.note+'</em></li>';

      html += '</ul><p><strong>Total '+pieceLabel+' : '+_euro11(sectionTotal)+'</strong></p>';
    }

    html += '<p><strong>Total '+grp+' : '+_euro11(groupTotal)+'</strong></p><hr>';
  }

  html += '<h3>Total global : '+_euro11(totalGlobal)+'</h3>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("üßæ Export DEVIS (tout compris)","exportDevisToutComprisTXT()","btn primary")
       +    b("üßæ Export DEVIS (s√©par√©)","exportDevisSepareTXT()","btn")
       +  '</div>'
       +  '</div>';

  view(html);
}

function pageTotaux(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Totaux par groupe</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    var gt = 0;
    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;
      var items = sortedItemsForPiece(key, s.items);
      var st = items.reduce(function(sum,it){ return sum + (((+it.prixU)||0)*((+it.qty)||0)); }, 0);
      gt += st; totalGlobal += st;
    }
    html += '<p><strong>'+grp+'</strong> : '+_euro11(gt)+'</p>';
  }

  html += '<hr><p><strong>Total global : '+_euro11(totalGlobal)+'</strong></p>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("üßæ Export DEVIS (tout compris)","exportDevisToutComprisTXT()","btn primary")
       +    b("üßæ Export DEVIS (s√©par√©)","exportDevisSepareTXT()","btn")
       +  '</div>'
       +  '</div>';

  view(html);
}

// =============================================
// 11.3 ‚Ä¢ Exports : TXT/ZIP par groupe (estimatif)
// =============================================
function exportText(){
  var grouped = groupDevis();
  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');

    var blob = new Blob([lines.join('\r\n')], {type:'text/plain;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = 'devis_'+grp+'.txt'; a.click();
    URL.revokeObjectURL(url);
  }
  alert('‚úÖ Export termin√© : un fichier .txt par groupe g√©n√©r√©.');
}

async function exportZipGroups(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var grouped = groupDevis();
  var zip = new JSZip();
  var global = 0;

  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');
    global += groupTotal;

    zip.file('devis_'+grp+'.txt', lines.join('\r\n'));
  }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var readme = 'R√©capitulatif ‚Äî '+name+'\nDate: '+new Date().toLocaleString('fr-FR')
             + '\n\nTotal global: '+global.toFixed(2)+'‚Ç¨\n';
  zip.file('README.txt', readme);

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_groupes.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export ZIP (par groupe) g√©n√©r√©.');
}

// ==========================================
// 11.4 ‚Ä¢ Exports : COMPLET (.txt/.zip) devis
// ==========================================
function buildFullText(){
  var grouped = groupDevis();
  var lines = ['=== DEVIS COMPLET ===\n'];
  var globalTotal = 0;

  for (var grp in grouped){
    lines.push('\n## '+grp+' ##\n');
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t; globalTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨\n');
  }

  lines.push('\n=== Total global : '+globalTotal.toFixed(2)+'‚Ç¨ ===\n');
  return lines.join('\r\n');
}
function exportTextFull(){
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildFullText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export .txt complet g√©n√©r√©.');
}
async function exportZipFull(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var zip  = new JSZip();
  zip.file(name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt', buildFullText());
  zip.file('README.txt', 'Devis complet\nNom: '+name+'\nDate: '+new Date().toLocaleString('fr-FR')+'\n');

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export .zip complet g√©n√©r√©.');
}

// =========================================================
// 11.5 ‚Ä¢ DEVIS (TXT) : tout compris & s√©par√© P/M (c√¥t√© devis)
// =========================================================
function _fmtDevTxt11(n, sym){
  var s = (sym || '‚Ç¨').trim();
  return (+(n||0)).toFixed(2)+' '+s;
}
function _todayFR_dev11(){
  try{ return new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit'}); }
  catch(e){ return new Date().toLocaleDateString(); }
}

// Helpers prefs & soci√©t√© si chap.10 charg√©, sinon fallback
function _getPrefsSafe11(){ try{ return JSON.parse(localStorage.getItem('appPrefs_v1')||'null')||{}; }catch(e){ return {}; } }
function _getCompanySafe11(){ try{ return JSON.parse(localStorage.getItem('companyConfig_v1')||'null')||{}; }catch(e){ return {}; } }

// Construit une liste de blocs (groupe > pi√®ce > items) pour affichage texte
function _linesByGroup_dev11(){
  var out=[];
  var g = groupDevis();
  for (var grp in g){
    for (var key in g[grp]){
      var s = g[grp][key];
      var items = sortedItemsForPiece(key, (s&&s.items)||[]);
      out.push({ group: grp, label: pieceDisplayLabel(key), items: items });
    }
  }
  return out;
}
function _txtItemLine_dev11(it, deviseSym){
  var unit = it.unit || 'u';
  var q  = +it.qty || 0;
  var pu = +it.prixU || 0;
  var t  = q*pu;
  var left = it.intervention ? (it.intervention+' ‚Äî ') : '';
  var poseTxt = (it.intervention==='Cr√©ation' && it.pose) ? (' - '+String(it.pose).toLowerCase()) : '';
  return '- ' + left + (it.designation||'') + poseTxt + ' ('
       + q+' '+unit+' √ó '+_fmtDevTxt11(pu, deviseSym)+' = '+_fmtDevTxt11(t, deviseSym)+')';
}

// DEVIS ‚Äî tout compris (TXT)
function buildDevisText_ToutCompris(){
  var prefs   = _getPrefsSafe11();
  var company = _getCompanySafe11();
  var devise  = prefs.devise || '‚Ç¨';
  var tvaOn   = !!prefs.tva_applicable;
  var tauxTVA = Math.max(0, +prefs.taux_tva || 20);

  var lines=[];
  lines.push('================= DEVIS ‚Äî TOUT COMPRIS =================');
  lines.push('Date : '+_todayFR_dev11());
  lines.push('');

  // √âmetteur
  var rs = (company.raison_sociale || company.nom_commercial || '').trim();
  if(rs){ lines.push('√âmetteur : '+rs); }
  var adr = [company.adresse, company.code_postal, company.ville].filter(Boolean).join(' ');
  if(adr) lines.push('Adresse  : '+adr+(company.pays?(' ‚Äî '+company.pays):''));
  if(company.email) lines.push('Email    : '+company.email);
  if(company.telephone) lines.push('T√©l      : '+company.telephone);
  if(company.siren) lines.push('SIREN    : '+company.siren);
  if(company.tva_intracom) lines.push('TVA      : '+company.tva_intracom);
  lines.push('========================================================');
  lines.push('');

  // D√©tail
  var blocks = _linesByGroup_dev11();
  var totalHT = 0;
  var currentGroup = null;
  blocks.forEach(function(block){
    if(block.group && block.group!==currentGroup){
      lines.push('## '+block.group+' ##');
      currentGroup = block.group;
    }
    lines.push('---- '+block.label+' ----');
    var st=0;
    block.items.forEach(function(it){
      lines.push(_txtItemLine_dev11(it, devise));
      st += ((+it.qty||0) * (+it.prixU||0));
    });
    lines.push('Total '+block.label+' : '+_fmtDevTxt11(st, devise));
    lines.push('');
    totalHT += st;
  });

  // Totaux
  var tva = tvaOn ? (totalHT * tauxTVA/100) : 0;
  lines.push('================= R√âCAPITULATIF =================');
  lines.push('Total HT  : '+_fmtDevTxt11(totalHT, devise));
  if(tvaOn) lines.push('TVA ('+tauxTVA+'%) : '+_fmtDevTxt11(tva, devise));
  lines.push('Total TTC : '+_fmtDevTxt11(totalHT + tva, devise));
  lines.push('=================================================');
  lines.push('');

  // Mentions
  if(company.conditions_paiement) lines.push('Conditions de paiement : '+company.conditions_paiement);
  if(company.iban) lines.push('IBAN : '+company.iban+(company.bic?(' ‚Äî BIC : '+company.bic):''));
  if(company.mentions_legales){
    lines.push('');
    lines.push(company.mentions_legales);
  }
  return lines.join('\r\n');
}

// DEVIS ‚Äî s√©par√© Prestations / Mat√©riel (TXT)
function buildDevisText_Separe(matPct){
  var prefs   = _getPrefsSafe11();
  var company = _getCompanySafe11();
  var devise  = prefs.devise || '‚Ç¨';
  var tvaOn   = !!prefs.tva_applicable;
  var tauxTVA = Math.max(0, +prefs.taux_tva || 20);

  var matRatio   = Math.min(100, Math.max(0, parseFloat(matPct||40))) / 100;
  var prestRatio = 1 - matRatio;

  var lines=[];
  lines.push('============ DEVIS ‚Äî S√âPAR√â PRESTATIONS / MAT√âRIEL ============');
  lines.push('Date : '+_todayFR_dev11());
  lines.push('');

  // √âmetteur
  var rs = (company.raison_sociale || company.nom_commercial || '').trim();
  if(rs){ lines.push('√âmetteur : '+rs); }
  var adr = [company.adresse, company.code_postal, company.ville].filter(Boolean).join(' ');
  if(adr) lines.push('Adresse  : '+adr+(company.pays?(' ‚Äî '+company.pays):''));
  if(company.email) lines.push('Email    : '+company.email);
  if(company.telephone) lines.push('T√©l      : '+company.telephone);
  if(company.siren) lines.push('SIREN    : '+company.siren);
  if(company.tva_intracom) lines.push('TVA      : '+company.tva_intracom);
  lines.push('===============================================================');
  lines.push('');

  // D√©tail identique √† "tout compris"
  var blocks = _linesByGroup_dev11();
  var totalHT = 0;
  var currentGroup = null;
  blocks.forEach(function(block){
    if(block.group && block.group!==currentGroup){
      lines.push('## '+block.group+' ##');
      currentGroup = block.group;
    }
    lines.push('---- '+block.label+' ----');
    var st=0;
    block.items.forEach(function(it){
      lines.push(_txtItemLine_dev11(it, devise));
      st += ((+it.qty||0) * (+it.prixU||0));
    });
    lines.push('Total '+block.label+' : '+_fmtDevTxt11(st, devise));
    lines.push('');
    totalHT += st;
  });

  // Split global
  var totalMatHT   = totalHT * matRatio;
  var totalPrestHT = totalHT * prestRatio;

  var tvaPrest = tvaOn ? (totalPrestHT * tauxTVA/100) : 0;
  var tvaMat   = tvaOn ? (totalMatHT   * tauxTVA/100) : 0;

  lines.push('================= R√âCAPITULATIF =================');
  lines.push('Hypoth√®se s√©paration : Mat√©riel = '+Math.round(matRatio*100)+'% | Prestations = '+Math.round(prestRatio*100)+'%');
  lines.push('');
  lines.push('--- PRESTATIONS ---');
  lines.push('HT  : '+_fmtDevTxt11(totalPrestHT, devise));
  if(tvaOn) lines.push('TVA : '+_fmtDevTxt11(tvaPrest, devise));
  lines.push('');
  lines.push('--- MAT√âRIEL ---');
  lines.push('HT  : '+_fmtDevTxt11(totalMatHT, devise));
  if(tvaOn) lines.push('TVA : '+_fmtDevTxt11(tvaMat, devise));
  lines.push('');
  lines.push('Total HT  : '+_fmtDevTxt11(totalHT, devise));
  if(tvaOn) lines.push('Total TVA : '+_fmtDevTxt11(tvaPrest + tvaMat, devise));
  lines.push('Total TTC : '+_fmtDevTxt11(totalHT + (tvaPrest + tvaMat), devise));
  lines.push('=================================================');
  lines.push('');

  // Mentions
  if(company.conditions_paiement) lines.push('Conditions de paiement : '+company.conditions_paiement);
  if(company.iban) lines.push('IBAN : '+company.iban+(company.bic?(' ‚Äî BIC : '+company.bic):''));
  if(company.mentions_legales){
    lines.push('');
    lines.push(company.mentions_legales);
  }
  return lines.join('\r\n');
}

// Exports .TXT (devis)
function exportDevisToutComprisTXT(){
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildDevisText_ToutCompris()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_devis_tout_compris.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Devis (tout compris) export√©.');
}
function exportDevisSepareTXT(){
  var pct = prompt('Pourcentage MAT√âRIEL (0‚Äì100) ?', '40');
  if(pct==null) return; // annul√©
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildDevisText_Separe(pct)], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_devis_separe.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Devis (s√©par√©) export√©.');
}

// =============================
// 11.6 ‚Ä¢ Expose (window)
// =============================
Object.assign(window, {
  // Grouping & tri
  PIECE_GROUPS, groupDevis, isTableauKey, pieceDisplayLabel, sortedItemsForPiece,

  // Pages
  pageEstimatif, pageTotaux,

  // Exports estimatif
  exportText, exportZipGroups, exportTextFull, exportZipFull,

  // Exports devis TXT
  buildDevisText_ToutCompris, buildDevisText_Separe, exportDevisToutComprisTXT, exportDevisSepareTXT
});
</script>




  


  








  






<!-- =============================
     CHAPITRE 12 : CONFIG ENTREPRISE & PR√âF√âRENCES
     Index :
       12.0 ‚Ä¢ Cl√©s & helpers de stockage (localStorage)
       12.1 ‚Ä¢ UI ‚Äî Configuration entreprise (coordonn√©es, assurances, logo)
       12.2 ‚Ä¢ UI ‚Äî Pr√©f√©rences (facturation, devise, TVA, num√©rotation)
       12.3 ‚Ä¢ Expose (window)
     ============================= -->

<style>
  .cfg-wrap .card{ margin-bottom:24px; }
  .cfg-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .cfg-grid .field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .cfg-grid .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .cfg-actions{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; }
  .cfg-note{ color:var(--muted); font-size:14px; }
  /* Logo */
  .cfg-logo-block{ display:grid; grid-template-columns:1fr; gap:10px; }
  .cfg-logo-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .cfg-logo img{ max-height:64px; border:1px solid var(--line); border-radius:8px; background:#fff; padding:4px; }
  .dropzone{
    border:2px dashed var(--line); border-radius:10px; padding:12px; background:#fafafa;
    text-align:center; color:#444;
  }
  .dropzone.drag{ border-color:#4caf50; background:#f0fff4; }
  .alert-ok{
    border:1px solid #c8e6c9; background:#e8f5e9; color:#256029;
    padding:8px 10px; border-radius:8px; font-size:14px;
  }
</style>

<script>
/* ================================
   12.0 ‚Ä¢ Stockage & helpers
   ================================ */
const KEY_COMPANY = 'companyConfig_v1';
const KEY_PREFS   = 'appPrefs_v1';

function readJsonLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function writeJsonLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

/* ‚Äî Config entreprise ‚Äî */
function getCompany(){
  return readJsonLS(KEY_COMPANY, {
    // Identit√©
    raison_sociale: '', nom_commercial: '',
    siren: '', tva_intracom: '',
    adresse: '', code_postal: '', ville: '', pays: 'France',
    email: '', telephone: '', site: '',
    // Assurance / mentions
    rc_pro: '', decennale: '', assureur: '',
    iban: '', bic: '', conditions_paiement: 'Virement bancaire √† 30 jours.',
    mentions_legales: '',
    // Logo (dataURL)
    logo_dataurl: '',
    logo_meta: { name:'', size:0, width:0, height:0, loaded_at:'' }
  });
}
function setCompany(obj){ writeJsonLS(KEY_COMPANY, obj||{}); }

/* ‚Äî Pr√©f√©rences ‚Äî */
function getPrefs(){
  return readJsonLS(KEY_PREFS, {
    facturation_mode: 'tout_compris', // 'tout_compris' | 'separe'
    devise: '‚Ç¨',
    tva_applicable: false,  // si vrai : application du taux ci-dessous
    taux_tva: 20,           // %
    numerotation_prefix: 'DEV-',
    numerotation_fact_prefix: 'FAC-',
    numerotation_courante: 1
  });
}
function setPrefs(obj){ writeJsonLS(KEY_PREFS, obj||{}); }

/* Fichier ‚Üí dataURL + meta (nom/taille + dimensions) */
function fileToDataURLWithMeta(file, cb, errCb){
  try{
    const rd = new FileReader();
    rd.onload = function(){
      const dataUrl = rd.result || '';
      const img = new Image();
      img.onload = function(){
        cb({
          dataUrl,
          meta: {
            name: file.name || '',
            size: file.size || 0,
            width: img.naturalWidth||img.width||0,
            height: img.naturalHeight||img.height||0,
            loaded_at: new Date().toISOString()
          }
        });
      };
      img.onerror = function(){ (errCb||alert)('Impossible de lire l‚Äôimage.'); };
      img.src = dataUrl;
    };
    rd.onerror = function(){ (errCb||alert)('Lecture du fichier √©chou√©e.'); };
    rd.readAsDataURL(file);
  }catch(e){ (errCb||alert)('S√©lection d‚Äôimage impossible : '+e.message); }
}
function pickImageFile(cb){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = function(){ const f=input.files&&input.files[0]; if(f) cb(f); };
  input.click();
}

/* ============================================
   12.1 ‚Ä¢ UI ‚Äî Configuration entreprise
   ============================================ */
function pageConfigEntreprise(notice){
  const cfg = getCompany();

  function f(label, id, val, placeholder){
    return '<div class="field"><label for="'+id+'">'+label+'</label>'
         + '<input id="'+id+'" value="'+(val?String(val).replace(/"/g,'&quot;'):'')+'" placeholder="'+(placeholder||'')+'"/></div>';
  }
  function ta(label, id, val, placeholder){
    return '<div class="field"><label for="'+id+'">'+label+'</label>'
         + '<textarea id="'+id+'" rows="5" placeholder="'+(placeholder||'')+'">'+(val||'')+'</textarea></div>';
  }

  const hasLogo = !!cfg.logo_dataurl;
  const meta = cfg.logo_meta || {};
  const metaTxt = hasLogo
    ? ('<div class="cfg-note">Fichier: <strong>'+ (meta.name||'') +
       '</strong> ‚Äî '+(Math.round((meta.size||0)/102.4)/10)+' Ko ‚Äî '+
       (meta.width||'?')+'√ó'+(meta.height||'?')+' px</div>')
    : '<div class="cfg-note">Aucun logo</div>';

  const banner = notice ? '<div class="alert-ok">'+notice+'</div>' : '';

  const logoHtml =
    '<div class="field">'
      + '<label>Logo</label>'
      + '<div class="cfg-logo-block">'
        + banner
        + '<div class="cfg-logo-row cfg-logo">'
            + (hasLogo ? ('<img id="cfg-logo-preview" src="'+cfg.logo_dataurl+'" alt="Logo"/>') : '')
            + metaTxt
        + '</div>'
        + '<div class="cfg-logo-row">'
            + b('Choisir une image','cfgPickLogoUI()','btn')
            + (hasLogo ? b('Aper√ßu plein','cfgOpenLogoFull()','btn') : '')
            + (hasLogo ? b('Retirer','cfgRemoveLogo()','btn') : '')
        + '</div>'
        + '<div id="dropzone" class="dropzone">Glissez-d√©posez votre logo ici (PNG/JPG recommand√©)</div>'
        + '<div class="cfg-note">Le logo sera exploitable par les exports PDF si vous les ajoutez plus tard.</div>'
      + '</div>'
    + '</div>';

  view(
    '<div class="cfg-wrap">'
      + '<div class="card">'
        + b('Retour','pageMain()','btn back')
        + '<h2>Configuration entreprise</h2>'
        + '<p class="cfg-note">Renseignez vos coordonn√©es, assurances et mentions l√©gales. Ces informations sont r√©utilis√©es dans les exports (devis/factures texte, CSV, etc.).</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Identit√© & coordonn√©es</h3>'
        + '<div class="cfg-grid">'
          + f('Raison sociale','ce_rs', cfg.raison_sociale, 'Ex : SARL Dupont √âlectricit√©')
          + f('Nom commercial','ce_nc', cfg.nom_commercial, 'Ex : Dupont √âlec')
          + f('SIREN','ce_siren', cfg.siren, 'Ex : 123 456 789')
          + f('N¬∞ TVA intracom','ce_tva', cfg.tva_intracom, 'Ex : FRXX999999999')
          + f('Adresse','ce_addr', cfg.adresse, 'Rue et n¬∞')
          + f('Code postal','ce_cp', cfg.code_postal, '75000')
          + f('Ville','ce_ville', cfg.ville, 'Paris')
          + f('Pays','ce_pays', cfg.pays || 'France', 'France')
          + f('Email','ce_mail', cfg.email, 'contact@exemple.fr')
          + f('T√©l√©phone','ce_tel', cfg.telephone, '+33 6 12 34 56 78')
          + f('Site web','ce_web', cfg.site, 'https://‚Ä¶')
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Assurances & RIB</h3>'
        + '<div class="cfg-grid">'
          + f('RC Pro (n¬∞)','ce_rc', cfg.rc_pro, '')
          + f('D√©cennale (n¬∞)','ce_dec', cfg.decennale, '')
          + f('Assureur','ce_ass', cfg.assureur, '')
          + f('IBAN','ce_iban', cfg.iban, '')
          + f('BIC','ce_bic', cfg.bic, '')
        + '</div>'
        + ta('Conditions de paiement','ce_cond', cfg.conditions_paiement, 'Ex : Virement sous 30 jours‚Ä¶')
        + ta('Mentions l√©gales (pied de page)','ce_mentions', cfg.mentions_legales, 'Textes libres‚Ä¶')
      + '</div>'

      + '<div class="card">'
        + '<h3>Logo</h3>'
        + logoHtml
      + '</div>'

      + '<div class="cfg-actions">'
        + b('üíæ Enregistrer','saveConfigEntreprise()','btn primary')
        + b('‚¨ÖÔ∏è Accueil','pageMain()','btn')
      + '</div>'
    + '</div>'
  );

  // Handlers inline
  window.cfgPickLogoUI = function(){
    pickImageFile(function(file){
      fileToDataURLWithMeta(file, function(res){
        const c = getCompany();
        c.logo_dataurl = res.dataUrl;
        c.logo_meta = res.meta;
        setCompany(c);
        pageConfigEntreprise('Logo charg√© ‚úÖ ('+res.meta.width+'√ó'+res.meta.height+' px)');
      });
    });
  };
  window.cfgRemoveLogo = function(){
    const c = getCompany(); c.logo_dataurl = ''; c.logo_meta = {name:'',size:0,width:0,height:0,loaded_at:''};
    setCompany(c); pageConfigEntreprise('Logo supprim√©.');
  };
  window.cfgOpenLogoFull = function(){
    const c = getCompany(); if(!c.logo_dataurl) return;
    const w = window.open(); if(!w) return;
    w.document.write('<img src="'+c.logo_dataurl+'" style="max-width:100%;height:auto" alt="Logo" />');
  };

  // Drag & drop
  (function setupDrop(){
    const dz = document.getElementById('dropzone');
    if(!dz) return;
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('drag'); }));
    dz.addEventListener('drop', function(e){
      const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
      if(!f) return;
      if(!/^image\//i.test(f.type||'')){ alert('Merci de d√©poser une image (PNG/JPG).'); return; }
      fileToDataURLWithMeta(f, function(res){
        const c = getCompany();
        c.logo_dataurl = res.dataUrl;
        c.logo_meta = res.meta;
        setCompany(c);
        pageConfigEntreprise('Logo charg√© ‚úÖ ('+res.meta.width+'√ó'+res.meta.height+' px)');
      });
    });
  })();
}

function saveConfigEntreprise(){
  const cfg = getCompany();
  function gv(id){ const el=document.getElementById(id); return el?el.value.trim():''; }
  Object.assign(cfg, {
    raison_sociale: gv('ce_rs'),
    nom_commercial: gv('ce_nc'),
    siren: gv('ce_siren'),
    tva_intracom: gv('ce_tva'),
    adresse: gv('ce_addr'),
    code_postal: gv('ce_cp'),
    ville: gv('ce_ville'),
    pays: gv('ce_pays'),
    email: gv('ce_mail'),
    telephone: gv('ce_tel'),
    site: gv('ce_web'),
    rc_pro: gv('ce_rc'),
    decennale: gv('ce_dec'),
    assureur: gv('ce_ass'),
    iban: gv('ce_iban'),
    bic: gv('ce_bic'),
    conditions_paiement: gv('ce_cond'),
    mentions_legales: gv('ce_mentions')
  });
  setCompany(cfg);
  alert('‚úÖ Configuration entreprise enregistr√©e.');
}

/* ============================================
   12.2 ‚Ä¢ UI ‚Äî Pr√©f√©rences g√©n√©rales
   ============================================ */
function pagePreferences(){
  const p = getPrefs();
  const radio = (name, val, cur, label) =>
    '<label class="pill"><input type="radio" name="'+name+'" value="'+val+'" '+(cur===val?'checked':'')+'> '+label+'</label>';

  view(
    '<div class="cfg-wrap">'
      + '<div class="card">'
        + b('Retour','pageMain()','btn back')
        + '<h2>Pr√©f√©rences g√©n√©rales</h2>'
        + '<p class="cfg-note">Ces r√©glages influencent la pr√©sentation des exports (devis/factures) et la logique de TVA.</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Mode de facturation</h3>'
        + '<div class="row" style="gap:8px;">'
          + radio('pf_fmode','tout_compris', p.facturation_mode, 'Tarifs ¬´ fournitures + pose ¬ª (tout compris)')
          + radio('pf_fmode','separe', p.facturation_mode, 'S√©parer prestations et mat√©riel')
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Devise & TVA</h3>'
        + '<div class="cfg-grid">'
          + '<div class="field">'
            + '<label>Devise</label>'
            + '<input id="pf_dev" value="'+(p.devise||'‚Ç¨')+'" placeholder="‚Ç¨"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>TVA applicable</label>'
            + '<select id="pf_tva_on"><option value="no" '+(!p.tva_applicable?'selected':'')+'>Non (Micro)</option><option value="yes" '+(p.tva_applicable?'selected':'')+'>Oui (R√©gime r√©el)</option></select>'
          + '</div>'
          + '<div class="field">'
            + '<label>Taux de TVA (%)</label>'
            + '<input id="pf_tva" type="number" inputmode="decimal" min="0" max="100" step="0.1" value="'+(+p.taux_tva||20)+'"/>'
          + '</div>'
        + '</div>'
        + '<p class="cfg-note">Le devis peut surcharger la TVA (ex : chantier √† 10%). Les exports utilisent d‚Äôabord la TVA du document courant.</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Num√©rotation</h3>'
        + '<div class="cfg-grid">'
          + '<div class="field">'
            + '<label>Pr√©fixe num√©rotation devis</label>'
            + '<input id="pf_pref_dev" value="'+(p.numerotation_prefix||'DEV-')+'"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>Pr√©fixe num√©rotation facture</label>'
            + '<input id="pf_pref_fac" value="'+(p.numerotation_fact_prefix||'FAC-')+'"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>Compteur courant</label>'
            + '<input id="pf_counter" type="number" inputmode="numeric" min="1" value="'+(+p.numerotation_courante||1)+'"/>'
            + '<div class="cfg-note">Servira pour g√©n√©rer DEV-0001, FAC-0001, etc. (incr√©ment √† l‚Äôexport).</div>'
          + '</div>'
        + '</div>'
      + '</div>'

      + '<div class="cfg-actions">'
        + b('üíæ Enregistrer','savePreferences()','btn primary')
        + b('‚¨ÖÔ∏è Accueil','pageMain()','btn')
      + '</div>'
    + '</div>'
  );
}

function savePreferences(){
  const cur = getPrefs();
  function gv(id){ const el=document.getElementById(id); return el?el.value:''; }
  function gi(name){ const el=document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:cur[name]; }
  const tvay = (gv('pf_tva_on')==='yes');

  const out = Object.assign({}, cur, {
    facturation_mode: gi('pf_fmode') || cur.facturation_mode,
    devise: gv('pf_dev') || cur.devise || '‚Ç¨',
    tva_applicable: tvay,
    taux_tva: Math.max(0, parseFloat(gv('pf_tva'))||cur.taux_tva||20),
    numerotation_prefix: gv('pf_pref_dev') || cur.numerotation_prefix || 'DEV-',
    numerotation_fact_prefix: gv('pf_pref_fac') || cur.numerotation_fact_prefix || 'FAC-',
    numerotation_courante: Math.max(1, parseInt(gv('pf_counter'),10)||cur.numerotation_courante||1)
  });
  setPrefs(out);
  alert('‚úÖ Pr√©f√©rences enregistr√©es.');
}

/* =========================
   12.3 ‚Ä¢ Expose (window)
   ========================= */
Object.assign(window, {
  // acc√®s lecture/√©criture
  getCompany, setCompany, getPrefs, setPrefs,
  // pages
  pageConfigEntreprise, pagePreferences,
  // actions
  saveConfigEntreprise, savePreferences
});
</script>
















  

<!-- =============================
     CHAPITRE 13 : CATALOGUE PRESTATIONS / MAT√âRIEL & TARIFS C√îT√â CATALOGUE
     Index :
       13.0 ‚Ä¢ Styles & garde-fous
       13.1 ‚Ä¢ Stockage & structures (prestations, coefficients, mat√©riel)
       13.2 ‚Ä¢ Helpers (merge, UI, IO)
       13.3 ‚Ä¢ Catalogue PRESTATIONS (ajout/suppression + tarifs par intervention)
       13.4 ‚Ä¢ TARIFS & COEFFICIENTS (pose, sections, par familles)
       13.5 ‚Ä¢ Catalogue MAT√âRIEL (marques ‚Üí gammes ‚Üí prix)
       13.6 ‚Ä¢ Import / Export / Reset (3 sous-domaines)
       13.7 ‚Ä¢ Accueil(s) de ce chapitre
       13.8 ‚Ä¢ Expose (window)
     ============================= -->

<style>
  .cat-wrap .card{ margin-bottom:24px; }
  .grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .muted{ color:var(--muted); }
  .row.gap8{ display:flex; gap:8px; flex-wrap:wrap; }
  .table-mini{ width:100%; border-collapse:collapse; font-size:14px; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; vertical-align:middle; }
  .table-mini th{ background:#fafafa; }
  .type-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .pill.small{ padding:6px 10px; font-size:14px; }
  .note{ font-size:13px; color:#555; }
  .hr{ border-top:1px solid var(--line); margin:12px 0; }
</style>

<script>
/* =============================
   13.0 ‚Ä¢ Garde-fous (host app)
   ============================= */
window.TARIFS_BASE  = window.TARIFS_BASE  || { prises:{}, eclairage:{}, circuit_specialise:{}, circuit_specialise_base:{} };
window.COEFF_POSE   = window.COEFF_POSE   || { 'Placo':1, 'Encastr√© ma√ßonnerie':1.3, 'Semi-encastr√©':1.15, 'Sur-mesure':1.6, 'Saillie avec moulure':1.1, 'Sous tube IRL':1.2 };
window.COEFF_SECTIONS_CS = window.COEFF_SECTIONS_CS || { '0,75 mm¬≤':0.9, '1,5 mm¬≤':1, '2,5 mm¬≤':1.15, '6 mm¬≤':1.6 };
window.DESIGNATIONS_PAR_CATEGORIE = window.DESIGNATIONS_PAR_CATEGORIE || {
  'Prises': ['Prise 2P+T'],
  '√âclairage/Luminaires': ['Point de centre','Applique'],
  '√âclairage/Commandes': ['Interrupteur simple','Interrupteur double'],
  'Circuit sp√©cialis√©': ['Four','Plaque de cuisson'],
  'Tableau': ['Inter diff 30mA','Disjoncteur'],
  'Ventilation': ['Kit VMC','Extracteur'],
  'Mise √† la terre': ['Prise de terre','Barre de terre']
};

/* Helpers de l‚Äôapp suppos√©s : b(), view(), euro() */
if(typeof window.b!=='function'){
  window.b=function(txt,fn,cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>'; };
}
if(typeof window.view!=='function'){
  window.view=function(html){ var app=document.getElementById('app'); if(app) app.innerHTML=html; };
}

/* ==================================
   13.1 ‚Ä¢ Stockage & structures cl√©s
   ================================== */
const KEY_CAT_PRESTATIONS = 'cat_prestations_v1';
const KEY_TARIFS_COEFFS   = 'cat_tarifs_coeffs_v1';
const KEY_CAT_MATERIEL    = 'cat_materiel_v1';

/* ‚Äî PRESTATIONS
   Structure : {
     familles: {
       'Prises': [
         { nom:'Prise 2P+T', tarifs:{ 'Cr√©ation':90, 'Remplacement appareillage':25, 'Rec√¢blage avec remplacement appareillage':45, 'Rec√¢blage sans remplacement appareillage':30 } },
         ...
       ],
       '√âclairage/Luminaires': [ { nom:'Point de centre', tarifs:{ 'Cr√©ation':110, 'Remplacement luminaire':35, ... } }, ... ],
       ...
     }
   }
*/
function _defaultCatPrestations(){
  return {
    familles: {
      'Prises': [
        { nom:'Prise 2P+T', tarifs:{ 'Cr√©ation':90, 'Remplacement appareillage':25, 'Rec√¢blage avec remplacement appareillage':45, 'Rec√¢blage sans remplacement appareillage':30 } }
      ],
      '√âclairage/Luminaires': [
        { nom:'Point de centre', tarifs:{ 'Cr√©ation':110, 'Remplacement luminaire':35, 'Rec√¢blage avec remplacement luminaire':55, 'Rec√¢blage sans remplacement luminaire':40 } },
        { nom:'Applique',        tarifs:{ 'Cr√©ation':95,  'Remplacement luminaire':30, 'Rec√¢blage avec remplacement luminaire':50, 'Rec√¢blage sans remplacement luminaire':35 } }
      ],
      '√âclairage/Commandes': [
        { nom:'Interrupteur simple', tarifs:{ 'Cr√©ation':65, 'Remplacement appareillage':25, 'Rec√¢blage avec remplacement appareillage':40, 'Rec√¢blage sans remplacement appareillage':28 } },
        { nom:'Interrupteur double', tarifs:{ 'Cr√©ation':80, 'Remplacement appareillage':30, 'Rec√¢blage avec remplacement appareillage':48, 'Rec√¢blage sans remplacement appareillage':34 } }
      ],
      'Circuit sp√©cialis√©': [
        { nom:'Four',              tarifs:{ 'Cr√©ation':140, 'Remplacement appareillage':35, 'Rec√¢blage avec remplacement appareillage':55, 'Rec√¢blage sans remplacement appareillage':40 } },
        { nom:'Plaque de cuisson', tarifs:{ 'Cr√©ation':155, 'Remplacement appareillage':35, 'Rec√¢blage avec remplacement appareillage':60, 'Rec√¢blage sans remplacement appareillage':42 } }
      ],
      'Tableau': [
        { nom:'Inter diff 30mA', tarifs:{ 'Cr√©ation':120 } },
        { nom:'Disjoncteur',     tarifs:{ 'Cr√©ation':18 } }
      ],
      'Ventilation': [
        { nom:'Kit VMC',      tarifs:{ 'Cr√©ation':380 } },
        { nom:'Extracteur',   tarifs:{ 'Cr√©ation':140 } }
      ],
      'Mise √† la terre': [
        { nom:'Prise de terre', tarifs:{ 'Cr√©ation':220 } },
        { nom:'Barre de terre', tarifs:{ 'Cr√©ation':90 } }
      ]
    }
  };
}
function getCatPrestations(){ try{ return JSON.parse(localStorage.getItem(KEY_CAT_PRESTATIONS)||'null') || _defaultCatPrestations(); }catch(e){ return _defaultCatPrestations(); } }
function setCatPrestations(obj){ try{ localStorage.setItem(KEY_CAT_PRESTATIONS, JSON.stringify(obj||_defaultCatPrestations())); }catch(e){} }

/* ‚Äî TARIFS & COEFFS (pose, sections, overrides base) */
function _defaultTarifsCoeffs(){
  return {
    coeff_pose: Object.assign({}, COEFF_POSE),
    coeff_sections_cs: Object.assign({}, COEFF_SECTIONS_CS),
    // Overrides optionnels par famille/type/intervention
    overrides: {
      // exemple : 'Prises': { 'Prise 2P+T': { 'Cr√©ation': 95 } }
    }
  };
}
function getTarifsCoeffs(){ try{ return JSON.parse(localStorage.getItem(KEY_TARIFS_COEFFS)||'null') || _defaultTarifsCoeffs(); }catch(e){ return _defaultTarifsCoeffs(); } }
function setTarifsCoeffs(obj){ try{ localStorage.setItem(KEY_TARIFS_COEFFS, JSON.stringify(obj||_defaultTarifsCoeffs())); }catch(e){} }

/* ‚Äî MAT√âRIEL (Marques ‚Üí Gammes ‚Üí Tarifs unitaires) */
function _defaultCatMateriel(){
  return {
    familles: {
      'Appareillage': {
        'Schneider': {
          'Odace': { 'Interrupteur simple': 14, 'Prise 2P+T': 11 },
          'Mureva': { 'Interrupteur simple': 18, 'Prise 2P+T': 16 }
        },
        'Legrand': {
          'C√©liane': { 'Interrupteur simple': 16, 'Prise 2P+T': 13 }
        }
      },
      'Tableau': {
        'Schneider': {
          'Resi9': { 'Disjoncteur 16A': 9.5, 'Inter diff 30mA AC': 58 }
        },
        'Hager': {
          'Volta': { 'Disjoncteur 16A': 9.2, 'Inter diff 30mA AC': 55 }
        }
      }
    }
  };
}
function getCatMateriel(){ try{ return JSON.parse(localStorage.getItem(KEY_CAT_MATERIEL)||'null') || _defaultCatMateriel(); }catch(e){ return _defaultCatMateriel(); } }
function setCatMateriel(obj){ try{ localStorage.setItem(KEY_CAT_MATERIEL, JSON.stringify(obj||_defaultCatMateriel())); }catch(e){} }

/* =========================
   13.2 ‚Ä¢ Helpers communs
   ========================= */
function _clone(x){ return JSON.parse(JSON.stringify(x)); }
function _ensureNum(n){ return Math.max(0, +n || 0); }
function _esc(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]); }
function _mergeLeafOverride(base, add){
  if(!add || typeof add!=='object') return;
  Object.keys(add).forEach(k=>{
    const v=add[k];
    if(v && typeof v==='object' && !Array.isArray(v)){
      if(!base[k] || typeof base[k]!=='object') base[k]={};
      _mergeLeafOverride(base[k], v);
    }else{
      base[k]=v;
    }
  });
}

/* Applique PRESTATIONS + TARIFS/COEFFS au runtime de l‚Äôapp */
function applyPrestationsToApp(){
  const cat = getCatPrestations();
  // 1) D√©signations visibles dans l‚Äôapp
  Object.keys(cat.familles).forEach(fam=>{
    DESIGNATIONS_PAR_CATEGORIE[fam] = DESIGNATIONS_PAR_CATEGORIE[fam] || [];
    cat.familles[fam].forEach(item=>{
      if(DESIGNATIONS_PAR_CATEGORIE[fam].indexOf(item.nom)===-1){
        DESIGNATIONS_PAR_CATEGORIE[fam].push(item.nom);
      }
    });
  });
  // 2) TARIFS_BASE : fusionner/ajouter
  TARIFS_BASE.prises = TARIFS_BASE.prises || {};
  TARIFS_BASE.eclairage = TARIFS_BASE.eclairage || {};
  TARIFS_BASE.circuit_specialise = TARIFS_BASE.circuit_specialise || {};
  // R√©partition par familles connues
  Object.keys(cat.familles).forEach(fam=>{
    (cat.familles[fam]||[]).forEach(it=>{
      // mapping famille ‚Üí branche tarifs
      if(fam==='Prises'){
        TARIFS_BASE.prises[it.nom] = TARIFS_BASE.prises[it.nom] || {};
        _mergeLeafOverride(TARIFS_BASE.prises[it.nom], it.tarifs||{});
      } else if(fam==='√âclairage/Luminaires' || fam==='√âclairage/Commandes'){
        TARIFS_BASE.eclairage[it.nom] = TARIFS_BASE.eclairage[it.nom] || {};
        _mergeLeafOverride(TARIFS_BASE.eclairage[it.nom], it.tarifs||{});
      } else if(fam==='Circuit sp√©cialis√©'){
        TARIFS_BASE.circuit_specialise[it.nom] = TARIFS_BASE.circuit_specialise[it.nom] || {};
        _mergeLeafOverride(TARIFS_BASE.circuit_specialise[it.nom], it.tarifs||{});
      } else {
        // Autres familles (Tableau, Ventilation, Mise √† la terre) :
        // elles sont surtout utilis√©es via √©crans d√©di√©s, on garde les noms pour menus/labels.
        // Si besoin, on peut cr√©er TARIFS_BASE[fam] dynamiquement.
        TARIFS_BASE[fam] = TARIFS_BASE[fam] || {};
        TARIFS_BASE[fam][it.nom] = TARIFS_BASE[fam][it.nom] || {};
        _mergeLeafOverride(TARIFS_BASE[fam][it.nom], it.tarifs||{});
      }
    });
  });
  // 3) COEFFICIENTS (depuis 13.4)
  const tc = getTarifsCoeffs();
  _mergeLeafOverride(COEFF_POSE, tc.coeff_pose||{});
  _mergeLeafOverride(COEFF_SECTIONS_CS, tc.coeff_sections_cs||{});
  // 4) Overrides chiffr√©s √©ventuels
  if(tc.overrides){ _mergeLeafOverride(TARIFS_BASE, { eclairage:TARIFS_BASE.eclairage, prises:TARIFS_BASE.prises, circuit_specialise:TARIFS_BASE.circuit_specialise, ...tc.overridesRoot }); }
}

/* ================================
   13.3 ‚Ä¢ CATALOGUE PRESTATIONS
   ================================ */
function pageCataloguePrestations(){
  const cat = getCatPrestations();
  const familles = Object.keys(cat.familles);

  function blockFamille(fam){
    const arr = cat.familles[fam] || [];
    const rows = arr.map((t,idx)=>{
      const pfx = fam+'__'+idx;
      // D√©terminer les libell√©s d‚Äôintervention selon la famille
      const KEYS_APP = (fam==='√âclairage/Luminaires')
        ? ["Cr√©ation","Remplacement luminaire","Rec√¢blage avec remplacement luminaire","Rec√¢blage sans remplacement luminaire"]
        : (fam==='Prises' || fam==='√âclairage/Commandes' || fam==='Circuit sp√©cialis√©'
            ? ["Cr√©ation","Remplacement appareillage","Rec√¢blage avec remplacement appareillage","Rec√¢blage sans remplacement appareillage"]
            : ["Cr√©ation"]); // par d√©faut
      const inputs = KEYS_APP.map(k=>{
        const id = (pfx+'__'+k).replace(/\s+/g,'_');
        const val = +(t.tarifs?.[k]||0);
        return '<div class="field"><label>'+_esc(k)+'</label><input id="'+id+'" type="number" step="1" inputmode="decimal" value="'+val+'"/></div>';
      }).join('');
      return `
        <div class="card">
          <div class="type-head">
            <h3>${_esc(t.nom)}</h3>
            <div class="row gap8">
              ${b('Supprimer','catPrestDel("'+fam+'",'+idx+')','btn')}
              ${b('üíæ Enregistrer','catPrestSave("'+fam+'",'+idx+')','btn primary')}
            </div>
          </div>
          <div class="grid">${inputs}</div>
        </div>`;
    }).join('');

    return `
      <div class="card">
        <h2>${_esc(fam)}</h2>
        ${rows || '<p class="muted">Aucune prestation d√©finie.</p>'}
        <div class="hr"></div>
        <div class="row gap8">
          <input id="add-'+_esc(fam)+'" placeholder="Nouvelle prestation‚Ä¶" />
          ${b('Ajouter','catPrestAdd("'+fam+'")','btn')}
        </div>
      </div>`;
  }

  view(
    '<div class="cat-wrap">'
    + '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Configuration catalogue prestations</h2>'
      + '<p class="muted">Ajoutez/supprimez des prestations et ajustez leurs tarifs d‚Äôintervention. Toute modification est appliqu√©e imm√©diatement √† l‚Äôapplication.</p>'
      + '<div class="row gap8">'
        + b('‚¨áÔ∏è Export JSON','catPrestExport()','btn')
        + b('‚¨ÜÔ∏è Import JSON','catPrestImport()','btn')
        + b('üßπ R√©initialiser','catPrestReset()','btn')
      + '</div>'
    + '</div>'
    + familles.map(blockFamille).join('')
    + '<div class="card">'
      + '<h3>Ajouter une famille</h3>'
      + '<div class="row gap8">'
        + '<input id="fam-add" placeholder="Nom de la famille (ex: Domotique)"/>'
        + b('Ajouter la famille','catFamAdd()','btn')
      + '</div>'
      + '<p class="note">Les familles doivent correspondre (id√©alement) aux cat√©gories de l‚Äôapplication pour appara√Ætre dans les menus. Exemples : ¬´ Prises ¬ª, ¬´ √âclairage/Luminaires ¬ª, ¬´ √âclairage/Commandes ¬ª, ¬´ Circuit sp√©cialis√© ¬ª, ¬´ Tableau ¬ª, ¬´ Ventilation ¬ª, ¬´ Mise √† la terre ¬ª.</p>'
    + '</div>'
    + '</div>'
  );

  // Handlers
  window.catPrestAdd = function(fam){
    const el = document.getElementById('add-'+fam);
    const name = (el && el.value || '').trim(); if(!name) return;
    const cur = getCatPrestations();
    cur.familles[fam] = cur.familles[fam] || [];
    cur.familles[fam].push({ nom:name, tarifs:{} });
    setCatPrestations(cur); applyPrestationsToApp(); pageCataloguePrestations();
  };
  window.catPrestDel = function(fam, idx){
    const cur = getCatPrestations();
    (cur.familles[fam]||[]).splice(idx,1);
    setCatPrestations(cur); applyPrestationsToApp(); pageCataloguePrestations();
  };
  window.catPrestSave = function(fam, idx){
    const cur = getCatPrestations(); const t=cur.familles[fam][idx]; if(!t) return;
    // Reconstruire depuis DOM
    const KEYS_APP = (fam==='√âclairage/Luminaires')
      ? ["Cr√©ation","Remplacement luminaire","Rec√¢blage avec remplacement luminaire","Rec√¢blage sans remplacement luminaire"]
      : (fam==='Prises' || fam==='√âclairage/Commandes' || fam==='Circuit sp√©cialis√©'
          ? ["Cr√©ation","Remplacement appareillage","Rec√¢blage avec remplacement appareillage","Rec√¢blage sans remplacement appareillage"]
          : ["Cr√©ation"]);
    const tarifs = {};
    KEYS_APP.forEach(k=>{
      const id = (fam+'__'+idx+'__'+k).replace(/\s+/g,'_');
      const el = document.getElementById(id);
      tarifs[k] = _ensureNum(el && el.value);
    });
    t.tarifs = tarifs;
    setCatPrestations(cur); applyPrestationsToApp(); alert('‚úÖ Tarifs enregistr√©s.');
  };
  window.catFamAdd = function(){
    const el=document.getElementById('fam-add'); const fam=(el&&el.value||'').trim(); if(!fam) return;
    const cur=getCatPrestations(); cur.familles[fam]=cur.familles[fam]||[]; setCatPrestations(cur);
    applyPrestationsToApp(); pageCataloguePrestations();
  };
}

/* ==========================================
   13.4 ‚Ä¢ TARIFS & COEFFICIENTS (catalogue)
   ========================================== */
function pageTarifsEtCoeffs(){
  const tc = getTarifsCoeffs();
  function coefPoseGrid(){
    return Object.keys(COEFF_POSE).concat(Object.keys(tc.coeff_pose||{})).filter((v,i,a)=>a.indexOf(v)===i).map(k=>{
      const id = 'cp_'+k.replace(/\s+/g,'_');
      const val = (tc.coeff_pose && typeof tc.coeff_pose[k]!=='undefined') ? tc.coeff_pose[k] : COEFF_POSE[k];
      return '<div class="field"><label>'+_esc(k)+'</label><input id="'+id+'" type="number" step="0.05" inputmode="decimal" value="'+(+val||1)+'"/></div>';
    }).join('');
  }
  function coefSectionsGrid(){
    return Object.keys(COEFF_SECTIONS_CS).concat(Object.keys(tc.coeff_sections_cs||{})).filter((v,i,a)=>a.indexOf(v)===i).map(k=>{
      const id = 'cs_'+k.replace(/\s+/g,'_');
      const val = (tc.coeff_sections_cs && typeof tc.coeff_sections_cs[k]!=='undefined') ? tc.coeff_sections_cs[k] : COEFF_SECTIONS_CS[k];
      return '<div class="field"><label>'+_esc(k)+'</label><input id="'+id+'" type="number" step="0.05" inputmode="decimal" value="'+(+val||1)+'"/></div>';
    }).join('');
  }

  view(
    '<div class="cat-wrap">'
    + '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Tarifs & coefficients</h2>'
      + '<p class="muted">Ajustez ici les coefficients de pose et de section, ainsi que des overrides cibl√©s par famille/type/intervention.</p>'
      + '<div class="row gap8">'
        + b('üíæ Enregistrer','saveTarifsEtCoeffs()','btn primary')
        + b('‚¨áÔ∏è Export JSON','tcExport()','btn')
        + b('‚¨ÜÔ∏è Import JSON','tcImport()','btn')
        + b('üßπ R√©initialiser','tcReset()','btn')
      + '</div>'
    + '</div>'

    + '<div class="card">'
      + '<h3>Coefficients de pose</h3>'
      + '<div class="grid">'+coefPoseGrid()+'</div>'
    + '</div>'

    + '<div class="card">'
      + '<h3>Coefficients de section (Circuit sp√©cialis√©)</h3>'
      + '<div class="grid">'+coefSectionsGrid()+'</div>'
    + '</div>'

    + '<div class="card">'
      + '<h3>Overrides cibl√©s (optionnel)</h3>'
      + '<p class="note">Format simple : indiquez Famille ‚Üí D√©signation ‚Üí Intervention ‚Üí Prix. Laisse vide pour ignorer. Exemple : Famille=Prises, D√©signation=Prise 2P+T, Intervention=Cr√©ation, Prix=95</p>'
      + '<div class="grid">'
        + '<div class="field"><label>Famille</label><input id="ov_fam" placeholder="ex : Prises"/></div>'
        + '<div class="field"><label>D√©signation</label><input id="ov_des" placeholder="ex : Prise 2P+T"/></div>'
        + '<div class="field"><label>Intervention</label><input id="ov_int" placeholder="ex : Cr√©ation"/></div>'
        + '<div class="field"><label>Prix (‚Ç¨)</label><input id="ov_prix" type="number" step="1" inputmode="decimal" placeholder="ex : 95"/></div>'
      + '</div>'
      + '<div class="row gap8" style="margin-top:8px;">'
        + b('Ajouter/Mettre √† jour override','tcAddOverride()','btn')
        + b('Vider les overrides','tcClearOverrides()','btn')
      + '</div>'
    + '</div>'

    + '<div class="card">'
      + '<h3>Notes</h3>'
      + '<p class="muted">Toutes les modifications se r√©percutent dans l‚Äôapplication (menus, calculs et exports).</p>'
    + '</div>'
    + '</div>'
  );

  window.saveTarifsEtCoeffs = function(){
    const cur = getTarifsCoeffs();
    // lire les inputs dynamiques
    const inputs = document.querySelectorAll('[id^="cp_"],[id^="cs_"]');
    inputs.forEach(el=>{
      if(el.id.startsWith('cp_')){
        const k = el.id.slice(3).replace(/_/g,' ');
        cur.coeff_pose[k] = Math.max(0, parseFloat(el.value)||1);
      }else if(el.id.startsWith('cs_')){
        const k = el.id.slice(3).replace(/_/g,' ');
        cur.coeff_sections_cs[k] = Math.max(0, parseFloat(el.value)||1);
      }
    });
    setTarifsCoeffs(cur); applyPrestationsToApp(); alert('‚úÖ Tarifs & coefficients enregistr√©s.');
  };
  window.tcAddOverride = function(){
    const fam = (document.getElementById('ov_fam')?.value||'').trim();
    const des = (document.getElementById('ov_des')?.value||'').trim();
    const itv = (document.getElementById('ov_int')?.value||'').trim();
    const p   = Math.max(0, parseFloat(document.getElementById('ov_prix')?.value)||0);
    if(!fam || !des || !itv || !p){ alert('Renseignez tous les champs.'); return; }
    const cur = getTarifsCoeffs();
    cur.overrides = cur.overrides || {};
    cur.overrides[fam] = cur.overrides[fam] || {};
    cur.overrides[fam][des] = cur.overrides[fam][des] || {};
    cur.overrides[fam][des][itv] = p;
    setTarifsCoeffs(cur); applyPrestationsToApp(); alert('‚úÖ Override ajout√©.');
  };
  window.tcClearOverrides = function(){
    const cur=getTarifsCoeffs(); cur.overrides={}; setTarifsCoeffs(cur); applyPrestationsToApp(); alert('‚úÖ Overrides vid√©s.');
  };
  window.tcExport = function(){
    const blob = new Blob([JSON.stringify(getTarifsCoeffs(),null,2)],{type:'application/json;charset=utf-8'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tarifs_coeffs.json'; a.click(); URL.revokeObjectURL(url);
  };
  window.tcImport = function(){
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=function(){
      const f=input.files&&input.files[0]; if(!f) return;
      const rd=new FileReader(); rd.onload=function(){
        try{ const obj=JSON.parse(rd.result||'{}'); setTarifsCoeffs(obj); applyPrestationsToApp(); alert('‚úÖ Import OK.'); pageTarifsEtCoeffs(); }
        catch(e){ alert('‚ùå Import invalide : '+e.message); }
      }; rd.readAsText(f,'utf-8');
    };
    input.click();
  };
  window.tcReset = function(){
    if(!confirm('R√©initialiser les coefficients ?')) return;
    localStorage.removeItem(KEY_TARIFS_COEFFS); applyPrestationsToApp(); pageTarifsEtCoeffs();
  };
}

/* =======================================
   13.5 ‚Ä¢ CATALOGUE MAT√âRIEL (marques‚Ä¶)
   ======================================= */
function pageCatalogueMateriel(){
  const cat = getCatMateriel();
  const familles = Object.keys(cat.familles||{});

  function blocFam(fam){
    const marques = cat.familles[fam]||{};
    const marqueRows = Object.keys(marques).map(marque=>{
      const gammes = marques[marque]||{};
      const gammeRows = Object.keys(gammes).map(gamme=>{
        const refs = gammes[gamme]||{};
        const refRows = Object.keys(refs).map(ref=>{
          const id = ['mat',fam,marque,gamme,ref].map(x=>x.replace(/\s+/g,'_')).join('__');
          const v  = +refs[ref]||0;
          return `<tr>
            <td>${_esc(ref)}</td>
            <td style="width:140px"><input id="${id}" type="number" step="0.1" inputmode="decimal" value="${v}"/></td>
            <td style="width:1%">${b('√ó','matDelRef("'+fam+'","'+marque+'","'+gamme+'","'+ref+'")','btn')}</td>
          </tr>`;
        }).join('');
        return `
          <div class="card">
            <div class="type-head">
              <h3>${_esc(marque)} ‚Äî ${_esc(gamme)}</h3>
              <div class="row gap8">
                ${b('Supprimer la gamme','matDelGamme("'+fam+'","'+marque+'","'+gamme+'")','btn')}
              </div>
            </div>
            <table class="table-mini">
              <thead><tr><th>R√©f√©rence</th><th>PU (‚Ç¨)</th><th></th></tr></thead>
              <tbody>${refRows || '<tr><td colspan="3" class="muted">Aucune r√©f√©rence.</td></tr>'}</tbody>
            </table>
            <div class="row gap8" style="margin-top:8px;">
              <input id="ref-'+_esc(fam)+'-'+_esc(marque)+'-'+_esc(gamme)+'" placeholder="Nouvelle r√©f√©rence (ex: Inter simple)"/>
              <input id="pu-'+_esc(fam)+'-'+_esc(marque)+'-'+_esc(gamme)+'" type="number" step="0.1" inputmode="decimal" placeholder="PU (‚Ç¨)"/>
              ${b('Ajouter','matAddRef("'+fam+'","'+marque+'","'+gamme+'")','btn')}
              ${b('üíæ Enregistrer les PU','matSaveRefs("'+fam+'","'+marque+'","'+gamme+'")','btn primary')}
            </div>
          </div>`;
      }).join('');

      return `
        <div class="card">
          <div class="type-head">
            <h2>${_esc(fam)} ‚Äî ${_esc(marque)}</h2>
            <div class="row gap8">
              ${b('Supprimer la marque','matDelMarque("'+fam+'","'+marque+'")','btn')}
            </div>
          </div>
          ${gammeRows || '<p class="muted">Aucune gamme.</p>'}
          <div class="row gap8">
            <input id="gamme-'+_esc(fam)+'-'+_esc(marque)+'" placeholder="Nouvelle gamme (ex: Resi9)"/>
            ${b('Ajouter la gamme','matAddGamme("'+fam+'","'+marque+'")','btn')}
          </div>
        </div>`;
    }).join('');

    return `
      <div class="card">
        <h2>${_esc(fam)}</h2>
        ${marqueRows || '<p class="muted">Aucune marque.</p>'}
        <div class="row gap8">
          <input id="marque-'+_esc(fam)+'" placeholder="Nouvelle marque (ex: Schneider)"/>
          ${b('Ajouter la marque','matAddMarque("'+fam+'")','btn')}
        </div>
      </div>`;
  }

  view(
    '<div class="cat-wrap">'
    + '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Catalogue mat√©riel</h2>'
      + '<p class="muted">D√©finissez les marques, gammes et prix unitaires de vos r√©f√©rences. Utilisable par vos √©crans (tableaux, appareillage‚Ä¶)</p>'
      + '<div class="row gap8">'
        + b('‚¨áÔ∏è Export JSON','matExport()','btn')
        + b('‚¨ÜÔ∏è Import JSON','matImport()','btn')
        + b('üßπ R√©initialiser','matReset()','btn')
      + '</div>'
    + '</div>'
    + (familles.length ? familles.map(blocFam).join('') : '<div class="card"><p class="muted">Aucune famille. Ajoutez-en une.</p></div>')
    + '<div class="card">'
      + '<h3>Ajouter une famille</h3>'
      + '<div class="row gap8">'
        + '<input id="fam-mat-add" placeholder="ex: Appareillage, Tableau, Ventilation‚Ä¶"/>'
        + b('Ajouter la famille','matAddFamille()','btn')
      + '</div>'
    + '</div>'
    + '</div>'
  );

  // Handlers mat√©riel
  window.matAddFamille = function(){
    const fam = (document.getElementById('fam-mat-add')?.value||'').trim(); if(!fam) return;
    const cur = getCatMateriel(); cur.familles[fam]=cur.familles[fam]||{}; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matAddMarque = function(fam){
    const m = (document.getElementById('marque-'+fam)?.value||'').trim(); if(!m) return;
    const cur=getCatMateriel(); cur.familles[fam]=cur.familles[fam]||{}; cur.familles[fam][m]=cur.familles[fam][m]||{}; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matAddGamme = function(fam, marque){
    const g = (document.getElementById('gamme-'+fam+'-'+marque)?.value||'').trim(); if(!g) return;
    const cur=getCatMateriel(); cur.familles[fam][marque]=cur.familles[fam][marque]||{}; cur.familles[fam][marque][g]=cur.familles[fam][marque][g]||{}; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matAddRef = function(fam, marque, gamme){
    const refEl=document.getElementById('ref-'+fam+'-'+marque+'-'+gamme);
    const puEl =document.getElementById('pu-'+fam+'-'+marque+'-'+gamme);
    const ref=(refEl&&refEl.value||'').trim(); const pu=Math.max(0, parseFloat(puEl&&puEl.value)||0);
    if(!ref || !pu) return;
    const cur=getCatMateriel(); cur.familles[fam][marque][gamme][ref]=pu; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matDelRef = function(fam, marque, gamme, ref){
    const cur=getCatMateriel(); delete cur.familles[fam][marque][gamme][ref]; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matDelGamme = function(fam, marque, gamme){
    const cur=getCatMateriel(); delete cur.familles[fam][marque][gamme]; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matDelMarque = function(fam, marque){
    const cur=getCatMateriel(); delete cur.familles[fam][marque]; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matSaveRefs = function(fam, marque, gamme){
    const cur=getCatMateriel();
    const tbl=document.querySelectorAll('table.table-mini input[id^="mat'+['',fam,marque,gamme].map(x=>x.replace(/\s+/g,'_')).join('__')+'"]');
    tbl.forEach(el=>{
      // id = mat__fam__marque__gamme__ref
      const parts = el.id.split('__').map(x=>x.replace(/_/g,' '));
      const ref   = parts.slice(4).join('__').replace(/_/g,' ');
      cur.familles[fam][marque][gamme][ref]=Math.max(0, parseFloat(el.value)||0);
    });
    setCatMateriel(cur); alert('‚úÖ Tarifs mat√©riel enregistr√©s.');
  };
  window.matExport=function(){
    const blob = new Blob([JSON.stringify(getCatMateriel(),null,2)],{type:'application/json;charset=utf-8'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='catalogue_materiel.json'; a.click(); URL.revokeObjectURL(url);
  };
  window.matImport=function(){
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=function(){
      const f=input.files&&input.files[0]; if(!f) return;
      const rd=new FileReader(); rd.onload=function(){
        try{ const obj=JSON.parse(rd.result||'{}'); setCatMateriel(obj); alert('‚úÖ Import OK.'); pageCatalogueMateriel(); }
        catch(e){ alert('‚ùå Import invalide : '+e.message); }
      }; rd.readAsText(f,'utf-8');
    };
    input.click();
  };
  window.matReset=function(){
    if(!confirm('R√©initialiser le catalogue mat√©riel ?')) return;
    localStorage.removeItem(KEY_CAT_MATERIEL); pageCatalogueMateriel();
  };
}

/* ===========================================
   13.6 ‚Ä¢ Import / Export / Reset (prestations)
   =========================================== */
function catPrestExport(){
  const blob = new Blob([JSON.stringify(getCatPrestations(),null,2)],{type:'application/json;charset=utf-8'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='catalogue_prestations.json'; a.click(); URL.revokeObjectURL(url);
}
function catPrestImport(){
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange=function(){
    const f=input.files&&input.files[0]; if(!f) return;
    const rd=new FileReader(); rd.onload=function(){
      try{ const obj=JSON.parse(rd.result||'{}'); setCatPrestations(obj); applyPrestationsToApp(); alert('‚úÖ Import OK.'); pageCataloguePrestations(); }
      catch(e){ alert('‚ùå Import invalide : '+e.message); }
    }; rd.readAsText(f,'utf-8');
  };
  input.click();
}
function catPrestReset(){
  if(!confirm('R√©initialiser le catalogue prestations ?')) return;
  localStorage.removeItem(KEY_CAT_PRESTATIONS); applyPrestationsToApp(); pageCataloguePrestations();
}

/* =======================================
   13.7 ‚Ä¢ Accueil(s) de ce chapitre (facultatif)
   ======================================= */
function pageCatalogueAccueil(){
  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Catalogue & tarifs (configuration)</h2>'
      + '<div class="row gap8" style="margin-top:8px;">'
        + b('Configuration catalogue prestations','pageCataloguePrestations()','btn primary')
        + b('Tarifs & coefficients','pageTarifsEtCoeffs()','btn')
        + b('Catalogue mat√©riel','pageCatalogueMateriel()','btn')
      + '</div>'
    + '</div>'
  );
}

/* =========================
   13.8 ‚Ä¢ Expose (window)
   ========================= */
Object.assign(window,{
  // pages
  pageCatalogueAccueil,
  pageCataloguePrestations,
  pageTarifsEtCoeffs,
  pageCatalogueMateriel,
  // apply runtime
  applyPrestationsToApp,
  // IO prestations
  catPrestExport, catPrestImport, catPrestReset
});

// Appliquer au chargement du chapitre (alimentation menus/tarifs/coeffs)
applyPrestationsToApp();
</script>

  
  












  
  
<!-- =============================
     CHAPITRE 14 : D√âMARRAGE & EXPOSE ‚Äî COMPLET
     Index :
       ¬ß0  ‚Ä¢ init() : chargement + reprise sauvegardes + pageMain()
       ¬ß1  ‚Ä¢ Expose : fonctions rendues accessibles (UI)
       ¬ß2  ‚Ä¢ Shim compat : neutralise les anciens appels goIntervention(...)
     ============================= -->
<script>
/* ======================
   ¬ß0 ‚Ä¢ D√âMARRAGE (init)
   ====================== */
function init(){
  try{
    // Charge l'√©tat courant du devis
    if (typeof loadLocal === 'function') loadLocal();

    // ‚úÖ Reprise auto si liste vide (si le Chap.4 robuste est pr√©sent)
    if (typeof recoverSavedIfEmpty === 'function') recoverSavedIfEmpty();

    // D√©marrage UI
    if (typeof pageMain === 'function') {
      pageMain();
    } else if (typeof pageHome === 'function') {
      pageHome();
    } else {
      const el = document.getElementById('app');
      if (el) el.innerHTML = '<div class="card"><h2>Interface non initialis√©e</h2><p>pageMain() ou pageHome() introuvable.</p></div>';
    }
  }catch(err){
    var el = document.getElementById('app');
    if(el){
      el.innerHTML =
        '<div class="card"><h2>Erreur init()</h2><pre>'
        + ((err && err.stack) || String(err))
        + '</pre></div>';
    }
    console.error(err);
  }
}

/* ======================
   ¬ß1 ‚Ä¢ EXPOSE (window)
   ====================== */
Object.assign(window, {
  // ===== Chap.4 ‚Äî Menu & sauvegarde (robuste)
  pageMain,
  actionNouveauDevis,
  pageSavedDevis,
  loadDevis,
  deleteDevis,
  saveCurrentDevis,
  exportSavedDevis,     // export .json (liste compl√®te)
  importSavedDevisUI,   // import .json (merge par __id)

  // ===== Chap.5 ‚Äî Pi√®ces (flux one-page) + Ventilation (raccourci)
  pageHome,
  pageAddPiece,
  confirmPieceChoice,
  removePiece,
  goPiece,
  delLine,
  editPieceNote,
  pageSpecifiqueForm,
  saveSpecifique,
  pagePieceSpecifique: pageSpecifiqueForm, // alias compat
  goCategory,
  goEclairageSub,
  setEclairageBranch,
  pageOneShotSelection,
  saveOneShotItem,
  goVent, // bouton "Ventilation" (redirige vers pageVentAccueil si charg√©e)

  // ===== Chap.6 ‚Äî Tableaux (multi-tableaux)
  pageTabCreate,
  saveTabCustomName,
  pageTabHome,
  pageTabPose,
  addTabPose,
  pageTab_ID,
  submitTab_ID,
  pageTab_Coupure,       // (coupure g√©n√©rale)
  submitTab_Coupure,     // (coupure g√©n√©rale)
  pageTab_Disjoncteurs,
  pageTab_DisjDetails,
  pageTab_DisjSaveDetails,
  pageTab_DisjValider,
  pageTabMod_Commandes,
  submitTabMod_Commandes,
  pageTabMod_Specifique,
  submitTabMod_Specifique,

  // ===== Chap.7 ‚Äî Ventilation
  pageVentAccueil,
  pageVentNew,
  saveVentName,
  ventDelete,
  pageVentHome,
  pageVentCreation,
  kitConduitMut, kitPercMut, exConduitMut, exPercMut, vcPercMut,
  ventAddKit, ventAddExtracteur, ventAddVentilateur,
  pageVentRetirage,
  ventAddRetirage,
  pageVentEntretien, ventAddEntretien,

  // ===== Chap.8 ‚Äî Param√©trage (tarifs + JSON perso + catalogue + prefs)
  pageTarifsAccueil,
  pageTarifsPrises,
  pageTarifsEclLuminaires,
  pageTarifsEclCommandes,
  pageTarifsCS,
  pageTarifsCoeffsPose,
  pageTarifsPersoJSON,
  // Catalogue li√© aux menus
  pageCatalogue,
  pageCat_Prise,
  pageCat_Luminaires,
  pageCat_Commandes,
  pageCat_CS,
  cat13Export,
  cat13Import,
  cat13Reset,
  applyCatalogToApp,
  // Configuration & pr√©f√©rences
  pageConfigEntreprise,
  pagePreferences,
  saveConfigEntreprise,
  savePreferences,

  // ===== Chap.9 ‚Äî Estimatif & exports
  pageEstimatif,
  pageTotaux,
  exportText,
  exportZipGroups,
  exportTextFull,
  exportZipFull,
  exportDevisToutComprisTXT,
  exportDevisSepareTXT,

  // ===== Chap.9 (modifs tableau) si pr√©sent
  pageTabModsAccueil,
  pageTabModsDeplacement,
  pageTabModsRecablage,
  addTabMod_Deplacement,
  addTabMod_Recablage,

  // ===== Chap.10 ‚Äî Facture TXT
  exportInvoiceText,

  // ===== Chap.11b ‚Äî Facture CSV
  exportInvoiceCSV,

  // ===== Chap.10bis ‚Äî Gestion des factures (nouveau)
  pageFacturesAccueil,
  transformCurrentDevisToInvoice,
  exportInvoiceFromStored,
  exportInvoiceCSVFromStored
});

/* =========================================
   ¬ß2 ‚Ä¢ SHIM COMPAT (s√©curit√© anti-crash)
   - Si l‚Äôancienne fonction goIntervention est appel√©e
     via un vieux bouton, on neutralise proprement.
   ========================================= */
if (typeof window.goIntervention !== 'function') {
  window.goIntervention = function(){
    alert('‚ö†Ô∏è Ce raccourci "Intervention" n‚Äôest plus utilis√©.\n'
        + 'Choisissez directement l‚Äôintervention dans la page de saisie.');
  };
}

// Lancement auto
init();
</script>
