<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis ‚Äî V2.4.1 (safe quoting)</title>
  <style>
    :root { --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666; --line:#e8e8e8; --primary:#111; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#444; background:#fafafa; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>(function(){try{var u=new URL(location.href);if(!u.searchParams.has('v')){u.searchParams.set('v',Date.now());location.replace(u.toString());}}catch(e){}})();</script>
</head>
<body>
<header>MiniDevis ‚Äî V2.4.1</header>
<main id="app"></main>

<!-- Sentinelle ultra-t√¥t : si tu vois √ßa, le HTML et ce script sont OK -->
<script>
(function(){
  var app=document.getElementById('app');
  if(app){ app.innerHTML='<div class="card">Loader OK ‚Äî le JS principal va d√©marrer‚Ä¶</div>'; }
})();
</script>

<script>
// =============================
// Debug global (affiche les erreurs fatales parsing/ex√©cution)
// =============================
window.addEventListener('error', function(e){
  var el=document.getElementById('app');
  if(el){ el.innerHTML='<div class="card"><h2>Erreur JS</h2><pre>'+e.message+'\n'+e.filename+':'+e.lineno+':'+e.colno+'</pre></div>'; }
});

// =============================
// CHAPITRE 2 : √âTAT & HELPERS
// =============================
var devis = {}; // + __id, __name
var ctx = { piece:null, category:null, intervention:null, pose:null, designation:null };

function genId(){ return 'dv_'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
function ensureId(){ if(!devis.__id) devis.__id = genId(); }

function $app(){ return document.getElementById('app'); }
// bouton : fn est une cha√Æne "goPiece('Salon')"
function b(label, fn, cls){ cls=cls||'btn'; return '<button class="'+cls+'" onclick="'+fn+'">'+label+'</button>'; }
function euro(n){ return (+(n||0)).toFixed(2)+' ‚Ç¨'; }

// Libell√© ‚Äúbase + (qualif) ‚Äî √©tage‚Äù
function buildPieceLabel(base, qualif, etage){
  var lbl=base||''; if(qualif&&qualif.trim()) lbl+=' ('+qualif.trim()+')';
  if(etage&&etage.trim()) lbl+=' ‚Äî '+etage.trim(); return lbl;
}
function nextFreeKey(label){
  if(!devis[label]) return label;
  var n=2; while(devis[label+' ('+n+')']) n++; return label+' ('+n+')';
}
function createOrGetPiece(base, qualif, etage){
  var wanted=buildPieceLabel(base,qualif,etage);
  var key=nextFreeKey(wanted);
  if(!devis[key]) devis[key]={ __base:base, qualificatif:qualif||'', etage:etage||'', items:[], note:'' };
  saveLocal(); return key;
}
function formatPieceLabel(key){
  var s=devis[key]; if(!s) return key;
  var base=s.__base||key; return buildPieceLabel(base, s.qualificatif, s.etage);
}

function view(html, noFooter){
  if(!noFooter){
    html+='<div class="row" style="margin-top:16px; gap:12px;">'
         +b('‚¨ÖÔ∏è Accueil','confirmBackHome()','btn back')
         +b('üíæ Sauvegarder devis','saveCurrentDevis()','btn primary')
         +'</div>';
  }
  $app().innerHTML=html;
}

function confirmBackHome(){
  var hasData=Object.keys(devis).filter(function(k){return k.indexOf('__')!==0;})
    .some(function(k){
      var s=devis[k]||{};
      return (s.items&&s.items.length>0) || (s.note&&s.note.trim().length>0);
    });
  if(!hasData || confirm('Revenir au menu principal ?\n‚ö†Ô∏è Les modifications non sauvegard√©es seront perdues.')){
    pageMain();
  }
}

// Persistance
function ensureSection(key){ if(!devis[key]) devis[key]={ items:[], note:'', qualificatif:'', etage:'' }; }
function saveLocal(){ try{ localStorage.setItem('devis', JSON.stringify(devis)); }catch(e){} }
function loadLocal(){
  try{ devis=JSON.parse(localStorage.getItem('devis')||'{}')||{}; }catch(e){ devis={}; }
  ensureId();
}

// =============================
// CHAP.3 : CONSTANTES
// =============================
var PIECES_PREDEFINIES=[
  'Salon','Cuisine','Salle √† manger','Salle de bain','Salle d\'eau',
  'Chambre 1','Chambre 2','Chambre 3','Toilettes','Bureau',
  'Buanderie','Garage','Couloir','Terrasse','Balcon','Jardin',
  'D√©barras','Ext√©rieur','Grenier/Combles','Atelier','Abri de jardin','Entr√©e','Biblioth√®que'
];
var CATEGORIES=['Prises','√âclairage','Circuit sp√©cialis√©'];
var POSES=['Encastr√© ma√ßonnerie','Placo','Semi-encastr√©','Sur-mesure','Saillie avec moulure','Sous tube IRL'];
var DESIGNATIONS_PAR_CATEGORIE={
  'Prises':['Prise'],
  '√âclairage/Luminaires':['Point de centre','Applique'],
  '√âclairage/Commandes':['Interrupteur simple','Interrupteur double'],
  'Circuit sp√©cialis√©':['Four','Plaque de cuisson','Lave-linge','Lave-vaisselle','S√®che-linge','Cumulus','VMC','Chauffage','Climatisation','Prise ext√©rieure √©tanche','Autre circuit sp√©cialis√©']
};
var TARIFS={
  'Prise':{ creation:120, recablage_sans:50, recablage_avec:70, remplacement:20 },
  'Point de centre':{ creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  'Applique':{ creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  'Interrupteur simple':{ creation:40, recablage_sans:50, recablage_avec:75, remplacement:25 },
  'Interrupteur double':{ creation:60, recablage_sans:50, recablage_avec:85, remplacement:35 },
  'Four':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Plaque de cuisson':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Lave-linge':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Lave-vaisselle':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'S√®che-linge':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Cumulus':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'VMC':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Chauffage':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Climatisation':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Prise ext√©rieure √©tanche':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Autre circuit sp√©cialis√©':{ creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 }
};
var ETAGES=['Rez-de-chauss√©e','1er √©tage','2e √©tage','Sous-sol','Combles','Annexe'];

// =============================
// CHAP.4 : MENU PRINCIPAL
// =============================
function pageMain(){
  view(
    '<div class="card">'
    +'<h2>Menu principal</h2>'
    +'<div class="row">'
      +b('‚ûï Nouveau devis','actionNouveauDevis()','btn primary')
      +b('üìÇ Mes devis sauvegard√©s','pageSavedDevis()','btn')
    +'</div>'
    +'</div>'
  , true);
}
function actionNouveauDevis(){ devis={ __id:genId(), __name:'' }; saveLocal(); pageHome(); }
function pageSavedDevis(){
  var saved=JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  if(!saved.length){
    return view('<div class="card">'+b('Retour','pageMain()','btn back')+'<h2>Mes devis sauvegard√©s</h2><p class="muted">Aucun devis sauvegard√©.</p></div>', true);
  }
  var list=saved.map(function(d,i){
    return '<div class="pill"><strong>'+d.name+'</strong> <small>'+d.date+'</small>'
      +b('Ouvrir','loadDevis('+i+')','btn')+b('Supprimer','deleteDevis('+i+')','btn')
      +'</div>';
  }).join('');
  view('<div class="card">'+b('Retour','pageMain()','btn back')+'<h2>Mes devis sauvegard√©s</h2><div class="list">'+list+'</div></div>', true);
}
function loadDevis(idx){
  var saved=JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  if(!saved[idx]) return pageSavedDevis();
  devis=saved[idx].data||{}; ensureId(); saveLocal(); pageHome();
}
function deleteDevis(idx){
  if(!confirm('Supprimer ce devis sauvegard√© ?')) return;
  var saved=JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  saved.splice(idx,1); localStorage.setItem('savedDevisList', JSON.stringify(saved)); pageSavedDevis();
}
function saveCurrentDevis(){
  ensureId();
  var saved=JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  var i=saved.findIndex(function(d){return d.data&&d.data.__id===devis.__id;});
  if(i>=0){
    var name=devis.__name||saved[i].name||('Devis '+new Date().toLocaleDateString());
    devis.__name=name; saved[i]={ name:name, date:new Date().toLocaleDateString(), data:devis };
    localStorage.setItem('savedDevisList', JSON.stringify(saved)); alert('Devis mis √† jour.'); return;
  }
  var name2=(devis.__name||'').trim();
  if(!name2){ name2=(prompt('Nom du devis :','')||'').trim(); if(!name2){ alert('Sauvegarde annul√©e.'); return; } }
  var j=saved.findIndex(function(d){ return (d.name||'').toLowerCase()===name2.toLowerCase(); });
  devis.__name=name2;
  if(j>=0){ if(!confirm('Un devis ¬´ '+name2+' ¬ª existe d√©j√†. L\'√©craser ?')) return; saved[j]={ name:name2, date:new Date().toLocaleDateString(), data:devis }; }
  else{ saved.push({ name:name2, date:new Date().toLocaleDateString(), data:devis }); }
  localStorage.setItem('savedDevisList', JSON.stringify(saved)); alert('Devis sauvegard√© !');
}

// =============================
// CHAP.5 : ACCUEIL & FLUX PI√àCES
// =============================
function pageHome(){
  var keys=Object.keys(devis).filter(function(k){return k.indexOf('__')!==0;});
  var listHtml = keys.length ? keys.map(function(p){
    var s=devis[p]||{};
    var badges=[ (s.qualificatif&&s.qualificatif.trim())?'<span class="badge">'+s.qualificatif+'</span>':'',
                 (s.etage&&s.etage.trim())?'<span class="badge">'+s.etage+'</span>':'' ].filter(Boolean).join(' ');
    return '<div class="pill">'
      +'<strong>'+formatPieceLabel(p)+'</strong>'
      +'<small>'+((s.items||[]).length)+' ligne(s)</small> '+badges
      +b('Ouvrir','goPiece('+JSON.stringify(p)+')','btn')
      +b('Supprimer','removePiece('+JSON.stringify(p)+')','btn')
      +'</div>';
  }).join('') : '<p class="muted">Aucune pi√®ce ajout√©e pour l‚Äôinstant.</p>';

  view(
    '<div class="card"><h2>Accueil</h2>'
    +'<div class="row">'+b('Ajouter une pi√®ce','pageAddPiece()','btn primary')+b('Installations sp√©cifiques','pageISHome()','btn')+'</div></div>'
    +'<div class="card" style="margin-top:12px;"><h2>Pi√®ces ajout√©es</h2><div class="list">'+listHtml+'</div></div>'
    +'<div class="row" style="margin-top:12px;">'+b('Voir l‚Äôestimatif','pageEstimatif()','btn')+b('Voir les totaux','pageTotaux()','btn')+'</div>'
  );
}
function pageAddPiece(){
  var opts=PIECES_PREDEFINIES.map(function(p){return '<option value="'+p+'">'+p+'</option>';}).join('')
           +'<option value="__NEW__">‚ûï Cr√©er une nouvelle pi√®ce‚Ä¶</option>';
  var etageOpts=['(aucun)'].concat(ETAGES).map(function(e){return '<option value="'+e+'">'+e+'</option>';}).join('');
  view(
    '<div class="card">'+b('Retour','pageHome()','btn back')+'<h2>Ajouter une pi√®ce</h2>'
    +'<label>Choisir une pi√®ce</label><select id="piece-choice">'+opts+'</select>'
    +'<label style="margin-top:10px;">Qualificatif (optionnel)</label><input id="piece-qualif" placeholder="ex : Parents, RDC, gauche" />'
    +'<label style="margin-top:10px;">√âtage (optionnel)</label><select id="piece-etage">'+etageOpts+'</select>'
    +'<div class="row" style="margin-top:10px;">'+b('Valider','confirmPieceChoice()','btn primary')+'</div>'
    +'</div>'
  );
}
function confirmPieceChoice(){
  var sel=document.getElementById('piece-choice').value;
  var qualif=(document.getElementById('piece-qualif').value||'').trim();
  var etage=document.getElementById('piece-etage').value;
  if(!sel) return;
  var base=sel;
  if(sel==='__NEW__'){ base=(prompt('Nom de la pi√®ce :','')||'').trim(); if(!base) return; }
  var etageVal=(etage&&etage!=='(aucun)')?etage:'';
  var key=createOrGetPiece(base,qualif,etageVal);
  goPiece(key);
}
function removePiece(key){
  if(confirm('Supprimer la pi√®ce ¬´ '+formatPieceLabel(key)+' ¬ª et toutes ses lignes ?')){
    delete devis[key]; saveLocal(); pageHome();
  }
}
function goPiece(key){
  ctx={ piece:key, category:null, intervention:null, pose:null, designation:null };
  ensureSection(key);
  var cats=CATEGORIES.filter(function(c){return c!=='Sp√©cifique';})
    .map(function(c){return b(c,'goCategory('+JSON.stringify(c)+')','btn');}).join('');
  var s=devis[key];
  var noteTxt=s.note?'<em class="muted">Note : '+s.note+'</em>':'<span class="muted">Aucune note</span>';
  var lignes=(s.items||[]).length?('<ul>'+s.items.map(function(it,i){
    var total=(+it.prixU||0)*(+it.qty||0);
    var poseTxt=(it.intervention==='Cr√©ation'&&it.pose)?' ‚Äî '+String(it.pose).toLowerCase():'';
    var unitTxt=it.unit||'u';
    return '<li>'+(it.intervention?(it.intervention+' ‚Äî '):'')+it.designation+poseTxt
      +' ('+it.qty+' '+unitTxt+' √ó '+euro(it.prixU)+' = '+euro(total)+') '
      +b('√ó','delLine('+JSON.stringify(key)+','+i+')','btn')+'</li>';
  }).join('')+'</ul>'):'<p class="muted">Aucune ligne pour l‚Äôinstant.</p>';
  view(
    '<div class="card">'+b('Retour','pageHome()','btn back')+'<h2>'+formatPieceLabel(key)+'</h2>'
    +'<div class="row">'+cats+b('Sp√©cifique','pagePieceSpecifique()','btn ghost')+'</div>'
    +'<div class="row" style="margin-top:10px;">'+b('Ajouter / modifier la note','editPieceNote()','btn')+'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;"><h2>Lignes de la pi√®ce</h2>'+lignes+'<p style="margin-top:8px;">'+noteTxt+'</p></div>'
  );
}
function delLine(key, idx){ (devis[key].items||[]).splice(idx,1); saveLocal(); goPiece(key); }
function goCategory(cat){
  ctx.category=cat;
  if(cat==='√âclairage') return goEclairageSub();
  var interventions=[];
  if(cat==='Prises'||cat==='Circuit sp√©cialis√©'){ interventions=['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage']; }
  else if(cat==='Sp√©cifique'){ interventions=['Saisie libre avec prix']; }
  else{ interventions=['Cr√©ation']; }
  var btns=interventions.map(function(i){return b(i,'goIntervention('+JSON.stringify(i)+')','btn');}).join('');
  view('<div class="card">'+b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')+'<h2>'+ctx.category+' ‚Äî '+formatPieceLabel(ctx.piece)+'</h2><div class="row">'+btns+'</div></div>');
}
function goEclairageSub(){
  view('<div class="card">'+b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')+'<h2>√âclairage ‚Äî '+formatPieceLabel(ctx.piece)+'</h2><div class="row">'
    +b('Luminaires','setEclairageBranch('+JSON.stringify('√âclairage/Luminaires')+')','btn')
    +b('Commandes','setEclairageBranch('+JSON.stringify('√âclairage/Commandes')+')','btn')
    +'</div></div>');
}
function setEclairageBranch(branch){
  ctx.category=branch;
  var interventions=(branch==='√âclairage/Luminaires')?['Cr√©ation','Remplacement luminaire','Rec√¢blage avec remplacement luminaire','Rec√¢blage sans remplacement luminaire']
                                                 :['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'];
  var btns=interventions.map(function(i){return b(i,'goIntervention('+JSON.stringify(i)+')','btn');}).join('');
  view('<div class="card">'+b('Retour','goEclairageSub()','btn back')+'<h2>'+branch+' ‚Äî '+formatPieceLabel(ctx.piece)+'</h2><div class="row">'+btns+'</div></div>');
}
function goIntervention(interv){
  ctx.intervention=interv;
  if(ctx.category==='Sp√©cifique'){
    var label=prompt('Nom de la prestation sp√©cifique :',''); if(!label) return goCategory('Sp√©cifique');
    var prix=parseFloat(prompt('Prix estim√© (‚Ç¨) :','0'))||0;
    ensureSection(ctx.piece);
    devis[ctx.piece].items.push({ category:'Sp√©cifique', intervention:'', pose:'', designation:label, qty:1, prixU:prix });
    saveLocal(); return goPiece(ctx.piece);
  }
  var needsPose=['Prises','Circuit sp√©cialis√©','√âclairage/Luminaires','√âclairage/Commandes'].indexOf(ctx.category)>=0;
  if(interv==='Cr√©ation' && needsPose){
    var poses=POSES.map(function(p){return b(p,'goDesignation('+JSON.stringify(p)+')','btn');}).join('');
    var back=(ctx.category.indexOf('√âclairage/')===0)?'√âclairage':ctx.category;
    view('<div class="card">'+b('Retour','goCategory('+JSON.stringify(back)+')','btn back')+'<h2>Type de pose</h2><div class="row">'+poses+'</div></div>');
  }else{
    goDesignation(null);
  }
}
function goDesignation(pose){
  ctx.pose=pose;
  var list=DESIGNATIONS_PAR_CATEGORIE[ctx.category]||['√âl√©ment'];
  if(list.length===1) return pageQuantite(list[0]);
  var btns=list.map(function(d){return b(d,'pageQuantite('+JSON.stringify(d)+')','btn');}).join('');
  view('<div class="card">'+b('Retour', (ctx.intervention==='Cr√©ation'?'goIntervention('+JSON.stringify(ctx.intervention)+')':'goCategory('+JSON.stringify(ctx.category)+')') ,'btn back')+'<h2>D√©signation</h2><div class="row">'+btns+'</div></div>');
}
function pageQuantite(designation){
  ctx.designation=designation;
  var qtyBtns=Array.from({length:10}).map(function(_,i){var q=i+1; return b(q,'saveItem('+q+')','btn');}).join('');
  view('<div class="card">'+b('Retour','goDesignation('+(ctx.pose?JSON.stringify(ctx.pose):'null')+')','btn back')+'<h2>Quantit√©</h2><div class="grid-qty">'+qtyBtns+'</div></div>');
}
function getPrix(designation, intervention){
  var base=TARIFS[designation]||{};
  if(intervention==='Cr√©ation') return base.creation||0;
  if(intervention&&intervention.indexOf('sans remplacement')>=0) return base.recablage_sans||0;
  if(intervention&&intervention.indexOf('avec remplacement')>=0) return base.recablage_avec||0;
  if(intervention&&intervention.indexOf('Remplacement')===0) return base.remplacement||0;
  return 0;
}
function saveItem(qty){
  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({ category:ctx.category, intervention:ctx.intervention, pose:ctx.pose, designation:ctx.designation, qty:qty, prixU:getPrix(ctx.designation, ctx.intervention) });
  saveLocal(); goPiece(ctx.piece);
}
function pagePieceSpecifique(){
  var label=prompt('Nom de la prestation sp√©cifique :',''); if(!label) return goPiece(ctx.piece);
  var prix=parseFloat(prompt('Prix estim√© (‚Ç¨) :','0'))||0;
  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({ category:'Sp√©cifique', intervention:'', pose:'', designation:label, qty:1, prixU:prix });
  saveLocal(); goPiece(ctx.piece);
}
function editPieceNote(){
  ensureSection(ctx.piece);
  var cur=devis[ctx.piece].note||'';
  var n=prompt('Note pour '+formatPieceLabel(ctx.piece), cur);
  if(n!==null) devis[ctx.piece].note=n.trim();
  saveLocal(); goPiece(ctx.piece);
}

/* ============================= */
/* CHAPITRE 6 : TABLEAU & DISTRIBUTION (COMPLET) */
/* ============================= */

// Tout ce qui concerne le tableau est stock√© dans la pi√®ce "Tableau"
function ensureTableau(){ ensureSection("Tableau"); }

// Petit √©tat local pour la page Disjoncteurs (√©vite le clavier)
let tabState = {
  disj: {
    2:  { qty:0, names:[] },
    10: { qty:0, names:[] },
    16: { qty:0, names:[] },
    20: { qty:0, names:[] },
    32: { qty:0, names:[] }
  }
};

// -------- Hub ‚ÄúInstallations sp√©cifiques‚Äù
function pageISHome(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Installations sp√©cifiques</h2>
      <div class="row" style="margin-top:10px;">
        ${b("Mise √† la terre","isSoon('Mise √† la terre')")}
        ${b("VMC","isSoon('VMC')")}
        ${b("Tableau / distribution","pageTabHome()","btn primary")}
      </div>
      <p class="muted" style="margin-top:8px;">Les modules ‚ÄúMise √† la terre‚Äù et ‚ÄúVMC‚Äù arrivent bient√¥t.</p>
    </div>
  `);
}
function isSoon(x){ alert(x+" : module √† venir."); }

// -------- Hub ‚ÄúTableau & distribution‚Äù
function pageTabHome(){
  view(`
    <div class="card">
      ${b("Retour","pageISHome()","btn back")}
      <h2>Tableau & distribution</h2>
      <div class="row" style="margin-top:10px;">
        ${b("1 ¬∑ Pose tableau","pageTabPose()","btn primary")}
        ${b("2 ¬∑ Modulaire : Disjoncteurs","pageTab_Disjoncteurs()","btn")}
        ${b("3 ¬∑ Modulaire : Interrupteurs diff.","pageTab_ID()","btn")}
        ${b("4 ¬∑ Commande & pilotage","pageTabMod_Commandes()","btn")}
        ${b("5 ¬∑ Sp√©cifique (libre + prix)","pageTabMod_Specifique()","btn ghost")}
      </div>
      <p class="muted" style="margin-top:8px;">Les √©l√©ments ajout√©s ici sont rang√©s dans la pi√®ce ¬´ Tableau ¬ª.</p>
    </div>
  `);
}

/* ========== (1) POSE TABLEAU ========== */

function pageTabPose(){
  view(`
    <div class="card">
      ${b("Retour","pageTabHome()","btn back")}
      <h2>Pose tableau</h2>

      <label>Nombre de rang√©es</label>
      <select id="tp-rang">
        <option value="1" selected>1 rang√©e</option>
        <option value="2">2 rang√©es</option>
        <option value="3">3 rang√©es</option>
        <option value="4">4 rang√©es</option>
      </select>

      <label style="margin-top:8px;">Nombre de modules</label>
      <select id="tp-mod">
        <option value="13" selected>13 modules</option>
        <option value="18">18 modules</option>
        <option value="24">24 modules</option>
      </select>

      <label style="margin-top:8px;">Type de pose</label>
      <select id="tp-pose">
        <option value="Saillie" selected>Saillie</option>
        <option value="Encastr√©">Encastr√©</option>
      </select>

      <label style="margin-top:8px;">Type d‚Äôintervention</label>
      <select id="tp-interv">
        <option value="Cr√©ation" selected>Cr√©ation</option>
        <option value="Avec d√©pose de l‚Äôexistant">Avec d√©pose de l‚Äôexistant</option>
      </select>

      <div class="row" style="margin-top:12px;">
        ${b("Ajouter au devis","addTabPose()","btn primary")}
      </div>
    </div>
  `);
}
function addTabPose(){
  const r   = document.getElementById('tp-rang').value;
  const m   = document.getElementById('tp-mod').value;
  const pos = document.getElementById('tp-pose').value;
  const itv = document.getElementById('tp-interv').value;

  ensureTableau();
  devis["Tableau"].items.push({
    category: "Tableau & distribution",
    intervention: itv,
    pose: pos,
    designation: `Pose tableau ‚Äî ${r} rang√©e(s), ${m} modules`,
    qty: 1,
    prixU: 0
  });
  saveLocal();
  alert("√âl√©ment ajout√© √† ¬´ Tableau ¬ª.");
  pageTabHome();
}

/* ========== (2) MODULAIRE : INTER DIFF. ========== */

function pageTab_ID(){
  view(`
    <div class="card">
      ${b("Retour","pageTabHome()","btn back")}
      <h2>Interrupteurs diff√©rentiels</h2>

      <div class="list">
        <label>ID 30mA - 40A - Type A
          <select id="id-a-40-30">${[...Array(21)].map((_,i)=>`<option ${i===0?'selected':''} value="${i}">${i}</option>`).join('')}</select>
        </label>
        <label>ID 30mA - 40A - Type AC
          <select id="id-ac-40-30">${[...Array(21)].map((_,i)=>`<option ${i===0?'selected':''} value="${i}">${i}</option>`).join('')}</select>
        </label>
        <label>ID 30mA - 63A - Type A
          <select id="id-a-63-30">${[...Array(21)].map((_,i)=>`<option ${i===0?'selected':''} value="${i}">${i}</option>`).join('')}</select>
        </label>
        <label>ID 30mA - 63A - Type AC
          <select id="id-ac-63-30">${[...Array(21)].map((_,i)=>`<option ${i===0?'selected':''} value="${i}">${i}</option>`).join('')}</select>
        </label>
      </div>

      <div class="row" style="margin-top:12px;">
        ${b("Ajouter au devis","submitTab_ID()","btn primary")}
      </div>
    </div>
  `);
}
function submitTab_ID(){
  const defs = [
    { id:"id-a-40-30",  name:"ID 30mA - 40A - Type A"  },
    { id:"id-ac-40-30", name:"ID 30mA - 40A - Type AC" },
    { id:"id-a-63-30",  name:"ID 30mA - 63A - Type A"  },
    { id:"id-ac-63-30", name:"ID 30mA - 63A - Type AC" }
  ];
  let added = 0;
  ensureTableau();
  defs.forEach(d=>{
    const q = +document.getElementById(d.id).value || 0;
    if(q>0){
      devis["Tableau"].items.push({
        category: "Tableau/Modulaire",
        intervention: "",
        pose: "",
        designation: d.name,
        qty: q,
        prixU: 0
      });
      added++;
    }
  });
  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal();
  alert("Interrupteurs diff√©rentiels ajout√©s.");
  pageTabHome();
}

/* ========== (3) MODULAIRE : DISJONCTEURS regroup√©s ========== */

function pageTab_Disjoncteurs(){
  // helpers rendus sans clavier
  const opts = (max=20)=>[...Array(max+1)].map((_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');

  view(`
    <div class="card">
      ${b("Retour","pageTabHome()","btn back")}
      <h2>Disjoncteurs modulaires (2A / 10A / 16A / 20A / 32A)</h2>

      <div class="list">
        <label>2 A (Qt√©)
          <select id="djq-2">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(2)")}
        </label>
        <label>10 A (Qt√©)
          <select id="djq-10">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(10)")}
        </label>
        <label>16 A (Qt√©)
          <select id="djq-16">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(16)")}
        </label>
        <label>20 A (Qt√©)
          <select id="djq-20">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(20)")}
        </label>
        <label>32 A (Qt√©)
          <select id="djq-32">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(32)")}
        </label>
      </div>

      <div class="row" style="margin-top:12px;">
        ${b("Vider la s√©lection","pageTab_DisjVider()")}
        ${b("Valider ces disjoncteurs","pageTab_DisjValider()","btn primary")}
      </div>
      <p class="muted" style="margin-top:6px;">Astuce : utilise ¬´ D√©tail circuits ¬ª pour g√©n√©rer automatiquement ‚ÄúCircuit 1, 2, ‚Ä¶‚Äù sans clavier. Apr√®s validation, tu restes sur cette page pour ajouter d‚Äôautres calibres.</p>
    </div>
  `);

  // Re-appliquer l'√©tat stock√©
  document.getElementById('djq-2').value  = tabState.disj[2].qty;
  document.getElementById('djq-10').value = tabState.disj[10].qty;
  document.getElementById('djq-16').value = tabState.disj[16].qty;
  document.getElementById('djq-20').value = tabState.disj[20].qty;
  document.getElementById('djq-32').value = tabState.disj[32].qty;
}

function pageTab_DisjDetails(rating){
  // quantit√© actuelle
  const currentQty = tabState.disj[rating]?.qty || 0;
  // options 0..30
  const opts = (sel)=>[...Array(31)].map((_,i)=>`<option value="${i}" ${i===sel?'selected':''}>${i}</option>`).join('');
  // items ‚ÄúCircuit 1‚Ä¶N‚Äù visuels (pr√©-remplis, pas de clavier)
  const preview = (n)=> n>0
    ? `<ul style="margin:8px 0 0 18px;">${[...Array(n)].map((_,i)=>`<li>Circuit ${i+1}</li>`).join('')}</ul>`
    : `<p class="muted">Aucun circuit pour l‚Äôinstant.</p>`;

  view(`
    <div class="card">
      ${b("Retour","pageTab_Disjoncteurs()","btn back")}
      <h2>D√©tail circuits ‚Äî ${rating} A</h2>

      <label>Nombre de circuits
        <select id="dj-detail-qty">${opts(currentQty)}</select>
      </label>

      <div id="dj-detail-preview" style="margin-top:8px;">
        ${preview(currentQty)}
      </div>

      <div class="row" style="margin-top:12px;">
        ${b("Enregistrer et revenir","pageTab_DisjSaveDetails("+rating+")","btn primary")}
      </div>
    </div>
  `);

  // live preview quand on change la quantit√© (sans clavier)
  document.getElementById('dj-detail-qty').addEventListener('change', (e)=>{
    const n = +e.target.value || 0;
    document.getElementById('dj-detail-preview').innerHTML =
      n>0 ? `<ul style="margin:8px 0 0 18px;">${[...Array(n)].map((_,i)=>`<li>Circuit ${i+1}</li>`).join('')}</ul>`
          : `<p class="muted">Aucun circuit pour l‚Äôinstant.</p>`;
  });
}

function pageTab_DisjSaveDetails(rating){
  const qty = +document.getElementById('dj-detail-qty').value || 0;
  tabState.disj[rating] = {
    qty,
    names: qty>0 ? [...Array(qty)].map((_,i)=>`Circuit ${i+1}`) : []
  };
  alert(`D√©tails ${rating} A enregistr√©s (${qty} circuit(s)).`);
  pageTab_Disjoncteurs();
}

function pageTab_DisjVider(){
  tabState.disj = {2:{qty:0,names:[]},10:{qty:0,names:[]},16:{qty:0,names:[]},20:{qty:0,names:[]},32:{qty:0,names:[]}};
  pageTab_Disjoncteurs();
}

function pageTab_DisjValider(){
  // r√©cup√®re les quantit√©s visibles (au cas o√π l‚Äôutilisateur a chang√© sans passer par ‚ÄúD√©tail circuits‚Äù)
  const readQty = (id)=> +document.getElementById(id).value || 0;
  tabState.disj[2].qty  = readQty('djq-2');
  tabState.disj[10].qty = readQty('djq-10');
  tabState.disj[16].qty = readQty('djq-16');
  tabState.disj[20].qty = readQty('djq-20');
  tabState.disj[32].qty = readQty('djq-32');

  let added = 0;
  ensureTableau();

  [2,10,16,20,32].forEach(rating=>{
    const { qty, names } = tabState.disj[rating];
    if(qty>0){
      const details = (names && names.length)
        ? ` ‚Äî circuits : ${names.join(', ')}`
        : '';
      devis["Tableau"].items.push({
        category: "Tableau/Modulaire",
        intervention: "",
        pose: "",
        designation: `Disjoncteur ${rating} A${details}`,
        qty,
        prixU: 0
      });
      added++;
    }
  });

  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal();
  alert("Disjoncteurs ajout√©s au devis.");
  // On reste sur la page Disjoncteurs pour pouvoir compl√©ter d‚Äôautres calibres
  pageTab_Disjoncteurs();
}

/* ========== (4) COMMANDE & PILOTAGE ========== */

function pageTabMod_Commandes(){
  const opts = (max=20)=>[...Array(max+1)].map((_,i)=>`<option value="${i}">${i}</option>`).join('');
  view(`
    <div class="card">
      ${b("Retour","pageTabHome()","btn back")}
      <h2>Commande & pilotage modulaire</h2>

      <div class="list">
        <label>T√©l√©rupteur
          <select id="cmd-telerup">${opts(20)}</select>
        </label>
        <label>T√©l√©rupteur silencieux
          <select id="cmd-telerup-sil">${opts(20)}</select>
        </label>
        <label>Horloge m√©canique + Disjoncteur 2A
          <select id="cmd-horloge-2a">${opts(20)}</select>
        </label>
        <label>Horloge m√©canique + contacteur HC + Disjoncteur 2A
          <select id="cmd-horloge-hc-2a">${opts(20)}</select>
        </label>
      </div>

      <div class="row" style="margin-top:12px;">
        ${b("Ajouter au devis","submitTabMod_Commandes()","btn primary")}
      </div>
    </div>
  `);
}
function submitTabMod_Commandes(){
  const pick = id => +document.getElementById(id).value || 0;
  const defs = [
    { id:"cmd-telerup",       name:"T√©l√©rupteur" },
    { id:"cmd-telerup-sil",   name:"T√©l√©rupteur silencieux" },
    { id:"cmd-horloge-2a",    name:"Horloge m√©canique + Disjoncteur 2A" },
    { id:"cmd-horloge-hc-2a", name:"Horloge m√©canique + contacteur heures creuses + Disjoncteur 2A" }
  ];
  let added=0;
  ensureTableau();
  defs.forEach(d=>{
    const q = pick(d.id);
    if(q>0){
      devis["Tableau"].items.push({
        category: "Tableau/Commandes",
        intervention: "",
        pose: "",
        designation: d.name,
        qty: q,
        prixU: 0
      });
      added++;
    }
  });
  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal();
  alert("Commandes modulaires ajout√©es.");
  pageTabHome();
}

/* ========== (5) SP√âCIFIQUE ========== */

function pageTabMod_Specifique(){
  const label = prompt("Intitul√© (libre) :", "");
  if(!label){ pageTabHome(); return; }
  const prix  = parseFloat(prompt("Prix unitaire estim√© (‚Ç¨) :", "0")) || 0;
  const qty   = Math.max(1, parseInt(prompt("Quantit√© :", "1")||"1", 10));

  ensureTableau();
  devis["Tableau"].items.push({
    category: "Tableau/Modulaire ‚Äî Sp√©cifique",
    intervention: "",
    pose: "",
    designation: label,
    qty,
    prixU: prix
  });
  saveLocal();
  alert("Ajout√©.");
  pageTabHome();
}

// =============================
// CHAP.7 : ESTIMATIF & EXPORTS
// =============================
var PIECE_GROUPS={
  'Buanderie':'Pi√®ces techniques','Garage':'Pi√®ces techniques','Atelier':'Pi√®ces techniques',
  'Jardin':'Ext√©rieur','Terrasse':'Ext√©rieur','Balcon':'Ext√©rieur','Abri de jardin':'Ext√©rieur',
  'Cuisine':'Cuisine',
  'Salon':'Pi√®ces de vie','Salle √† manger':'Pi√®ces de vie','Couloir':'Pi√®ces de vie','Entr√©e':'Pi√®ces de vie',
  'Salle de bain':'Pi√®ces d\'eau','Salle d\'eau':'Pi√®ces d\'eau','Toilettes':'Pi√®ces d\'eau',
  'Chambre 1':'Chambres & Bureau','Chambre 2':'Chambres & Bureau','Chambre 3':'Chambres & Bureau','Bureau':'Chambres & Bureau','Biblioth√®que':'Chambres & Bureau',
  'Tableau':'Tableau & distribution','Distribution':'Tableau & distribution','Mise √† la terre':'Mise √† la terre','VMC':'VMC'
};
function groupDevis(){
  var g={}, key, s, base, grp;
  for(key in devis){
    if(key.indexOf('__')===0) continue;
    s=devis[key]; base=(s&&s.__base)?s.__base:key.replace(/\s*\(.*\)\s*$/,'').split(' ‚Äî ')[0];
    grp=PIECE_GROUPS[base]||'Divers';
    if(!g[grp]) g[grp]={};
    g[grp][key]=s;
  }
  return g;
}
function pageEstimatif(){
  var html='<div class="card">'+b('Retour','pageHome()','btn back')+'<h2>Estimatif d√©taill√©</h2>';
  var totalGlobal=0, grouped=groupDevis();
  for(var grp in grouped){
    html+='<h2 style="border-top:2px solid #000; padding-top:8px;">'+grp+'</h2>';
    var groupTotal=0;
    for(var key in grouped[grp]){
      var s=grouped[grp][key]; if(!s||!Array.isArray(s.items)||!s.items.length) continue;
      var pieceLabel=formatPieceLabel(key), sectionTotal=0;
      html+='<h3 style="margin-top:6px; border-top:1px solid #ccc; padding-top:4px;">'+pieceLabel+'</h3><ul>';
      s.items.forEach(function(it){
        var q=+it.qty||0, pu=+it.prixU||0, t=q*pu; sectionTotal+=t; groupTotal+=t; totalGlobal+=t;
        var poseTxt=(it.intervention==='Cr√©ation'&&it.pose)?' '+String(it.pose).toLowerCase():'';
        var unit=it.unit||'u', left=it.intervention?(it.intervention+' ‚Äî '):'';
        html+='<li>'+left+it.designation+poseTxt+' ('+q+' '+unit+' √ó '+euro(pu)+' = '+euro(t)+')</li>';
      });
      if(s.note) html+='<li><em>Note : '+s.note+'</em></li>';
      html+='</ul><p><strong>Total '+pieceLabel+' : '+euro(sectionTotal)+'</strong></p>';
    }
    html+='<p><strong>Total '+grp+' : '+euro(groupTotal)+'</strong></p><hr>';
  }
  html+='<h3>Total global : '+euro(totalGlobal)+'</h3>'
      +'<div class="row" style="margin-top:10px;">'
      +b('Export .txt (par groupe)','exportText()','btn')
      +b('Export .zip (par groupe)','exportZipGroups()','btn')
      +b('Export .txt (complet)','exportTextFull()','btn')
      +b('Export .zip (complet)','exportZipFull()','btn')
      +'</div></div>';
  view(html);
}
function pageTotaux(){
  var html='<div class="card">'+b('Retour','pageHome()','btn back')+'<h2>Totaux par groupe</h2>';
  var totalGlobal=0, grouped=groupDevis();
  for(var grp in grouped){
    var gt=0;
    for(var key in grouped[grp]){
      var s=grouped[grp][key]; if(!s||!Array.isArray(s.items)||!s.items.length) continue;
      var st=s.items.reduce(function(sum,it){ return sum+(((+it.prixU)||0)*((+it.qty)||0)); },0);
      gt+=st; totalGlobal+=st;
    }
    html+='<p><strong>'+grp+'</strong> : '+euro(gt)+'</p>';
  }
  html+='<hr><p><strong>Total global : '+euro(totalGlobal)+'</strong></p>'
      +'<div class="row" style="margin-top:10px;">'
      +b('Export .txt (par groupe)','exportText()','btn')
      +b('Export .zip (par groupe)','exportZipGroups()','btn')
      +b('Export .txt (complet)','exportTextFull()','btn')
      +b('Export .zip (complet)','exportZipFull()','btn')
      +'</div></div>';
  view(html);
}
function itemLine(it){
  var unit=it.unit||'u';
  var poseTxt=(it.intervention==='Cr√©ation'&&it.pose)?' - '+String(it.pose).toLowerCase():'';
  var left=it.intervention?(it.intervention+' ‚Äî '):'';
  var pu=(+it.prixU||0).toFixed(2), q=+it.qty||0, total=(q*(+it.prixU||0)).toFixed(2);
  return '- '+left+it.designation+poseTxt+' | Qt√©: '+q+' '+unit+' | PU: '+pu+'‚Ç¨ | Total: '+total+'‚Ç¨';
}
function pieceSeparator(label){ return '\n---------------- '+label+' ----------------\n'; }
function exportText(){
  var grouped=groupDevis();
  for(var grp in grouped){
    var lines=['=== '+grp+' ===\n'], groupTotal=0;
    for(var key in grouped[grp]){
      var s=grouped[grp][key]; if(!s||!Array.isArray(s.items)||!s.items.length) continue;
      var label=formatPieceLabel(key), st=0;
      lines.push(pieceSeparator(label));
      s.items.forEach(function(it){ var q=+it.qty||0, pu=+it.prixU||0, t=q*pu; st+=t; groupTotal+=t; lines.push(itemLine(it)); });
      if(s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }
    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');
    var blob=new Blob([lines.join('\r\n')],{type:'text/plain;charset=utf-8'});
    var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='devis_'+grp+'.txt'; a.click(); URL.revokeObjectURL(url);
  }
  alert('‚úÖ Export termin√© : un fichier .txt par groupe g√©n√©r√©.');
}
async function exportZipGroups(){
  if(typeof JSZip==='undefined'){ alert('JSZip non charg√©.'); return; }
  var grouped=groupDevis(), zip=new JSZip(), global=0;
  for(var grp in grouped){
    var lines=['=== '+grp+' ===\n'], groupTotal=0;
    for(var key in grouped[grp]){
      var s=grouped[grp][key]; if(!s||!Array.isArray(s.items)||!s.items.length) continue;
      var label=formatPieceLabel(key), st=0;
      lines.push(pieceSeparator(label));
      s.items.forEach(function(it){ var q=+it.qty||0, pu=+it.prixU||0, t=q*pu; st+=t; groupTotal+=t; lines.push(itemLine(it)); });
      if(s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }
    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨'); global+=groupTotal;
    zip.file('devis_'+grp+'.txt', lines.join('\r\n'));
  }
  var name=(devis.__name||'Devis').trim()||'Devis';
  var readme=['R√©capitulatif ‚Äî '+name,'Date: '+new Date().toLocaleString(),'','Total global: '+global.toFixed(2)+'‚Ç¨','','Un fichier .txt par groupe avec d√©tails, quantit√©s, PU et totaux.'].join('\r\n');
  zip.file('README.txt', readme);
  var blob=await zip.generateAsync({type:'blob'}); var url=URL.createObjectURL(blob); var a=document.createElement('a');
  a.href=url; a.download=(name.replace(/\s+/g,'_').toLowerCase())+'_groupes.zip'; a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export ZIP (par groupe) g√©n√©r√©.');
}
function buildFullText(){
  var grouped=groupDevis(), lines=[], globalTotal=0, grp, key;
  lines.push('=== DEVIS COMPLET ===\n');
  for(grp in grouped){
    lines.push('\n## '+grp+' ##\n'); var groupTotal=0;
    for(key in grouped[grp]){
      var s=grouped[grp][key]; if(!s||!Array.isArray(s.items)||!s.items.length) continue;
      var label=formatPieceLabel(key), st=0;
      lines.push(pieceSeparator(label));
      s.items.forEach(function(it){ var q=+it.qty||0, pu=+it.prixU||0, t=q*pu; st+=t; groupTotal+=t; globalTotal+=t; lines.push(itemLine(it)); });
      if(s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }
    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨\n');
  }
  lines.push('\n=== Total global : '+globalTotal.toFixed(2)+'‚Ç¨ ===\n'); return lines.join('\r\n');
}
function exportTextFull(){
  var name=(devis.__name||'Devis').trim()||'Devis';
  var blob=new Blob([buildFullText()],{type:'text/plain;charset=utf-8'});
  var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt'; a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export .txt complet g√©n√©r√©.');
}
async function exportZipFull(){
  if(typeof JSZip==='undefined'){ alert('JSZip non charg√©.'); return; }
  var name=(devis.__name||'Devis').trim()||'Devis', zip=new JSZip();
  zip.file(name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt', buildFullText());
  zip.file('README.txt','Devis complet\nNom: '+name+'\nDate: '+new Date().toLocaleString()+'\n');
  var blob=await zip.generateAsync({type:'blob'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=name.replace(/\s+/g,'_').toLowerCase()+'_complet.zip'; a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export .zip complet g√©n√©r√©.');
}

/* ============================= */
/* CHAPITRE 6 : TABLEAU & DISTRIBUTION (COMPLET) */
/* ============================= */

// Tout ce qui concerne le tableau est stock√© dans la pi√®ce "Tableau"
function ensureTableau(){ ensureSection("Tableau"); }

// Petit √©tat local pour la page Disjoncteurs (√©vite le clavier)
let tabState = {
  disj: {
    2:  { qty:0, names:[] },
    10: { qty:0, names:[] },
    16: { qty:0, names:[] },
    20: { qty:0, names:[] },
    32: { qty:0, names:[] }
  }
};

// -------- Hub ‚ÄúInstallations sp√©cifiques‚Äù
function pageISHome(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Installations sp√©cifiques</h2>
      <div class="row" style="margin-top:10px;">
        ${b("Mise √† la terre","isSoon('Mise √† la terre')")}
        ${b("VMC","isSoon('VMC')")}
        ${b("Tableau / distribution","pageTabHome()","btn primary")}
      </div>
      <p class="muted" style="margin-top:8px;">Les modules ‚ÄúMise √† la terre‚Äù et ‚ÄúVMC‚Äù arrivent bient√¥t.</p>
    </div>
  `);
}
function isSoon(x){ alert(x+" : module √† venir."); }

// -------- Hub ‚ÄúTableau & distribution‚Äù
function pageTabHome(){
  view(`
    <div class="card">
      ${b("Retour","pageISHome()","btn back")}
      <h2>Tableau & distribution</h2>
      <div class="row" style="margin-top:10px;">
        ${b("1 ¬∑ Pose tableau","pageTabPose()","btn primary")}
        ${b("2 ¬∑ Modulaire : Disjoncteurs","pageTab_Disjoncteurs()","btn")}
        ${b("3 ¬∑ Modulaire : Interrupteurs diff.","pageTab_ID()","btn")}
        ${b("4 ¬∑ Commande & pilotage","pageTabMod_Commandes()","btn")}
        ${b("5 ¬∑ Sp√©cifique (libre + prix)","pageTabMod_Specifique()","btn ghost")}
      </div>
      <p class="muted" style="margin-top:8px;">Les √©l√©ments ajout√©s ici sont rang√©s dans la pi√®ce ¬´ Tableau ¬ª.</p>
    </div>
  `);
}

/* ========== (1) POSE TABLEAU ========== */

function pageTabPose(){
  view(`
    <div class="card">
      ${b("Retour","pageTabHome()","btn back")}
      <h2>Pose tableau</h2>

      <label>Nombre de rang√©es</label>
      <select id="tp-rang">
        <option value="1" selected>1 rang√©e</option>
        <option value="2">2 rang√©es</option>
        <option value="3">3 rang√©es</option>
        <option value="4">4 rang√©es</option>
      </select>

      <label style="margin-top:8px;">Nombre de modules</label>
      <select id="tp-mod">
        <option value="13" selected>13 modules</option>
        <option value="18">18 modules</option>
        <option value="24">24 modules</option>
      </select>

      <label style="margin-top:8px;">Type de pose</label>
      <select id="tp-pose">
        <option value="Saillie" selected>Saillie</option>
        <option value="Encastr√©">Encastr√©</option>
      </select>

      <label style="margin-top:8px;">Type d‚Äôintervention</label>
      <select id="tp-interv">
        <option value="Cr√©ation" selected>Cr√©ation</option>
        <option value="Avec d√©pose de l‚Äôexistant">Avec d√©pose de l‚Äôexistant</option>
      </select>

      <div class="row" style="margin-top:12px;">
        ${b("Ajouter au devis","addTabPose()","btn primary")}
      </div>
    </div>
  `);
}
function addTabPose(){
  const r   = document.getElementById('tp-rang').value;
  const m   = document.getElementById('tp-mod').value;
  const pos = document.getElementById('tp-pose').value;
  const itv = document.getElementById('tp-interv').value;

  ensureTableau();
  devis["Tableau"].items.push({
    category: "Tableau & distribution",
    intervention: itv,
    pose: pos,
    designation: `Pose tableau ‚Äî ${r} rang√©e(s), ${m} modules`,
    qty: 1,
    prixU: 0
  });
  saveLocal();
  alert("√âl√©ment ajout√© √† ¬´ Tableau ¬ª.");
  pageTabHome();
}

/* ========== (2) MODULAIRE : INTER DIFF. ========== */

function pageTab_ID(){
  view(`
    <div class="card">
      ${b("Retour","pageTabHome()","btn back")}
      <h2>Interrupteurs diff√©rentiels</h2>

      <div class="list">
        <label>ID 30mA - 40A - Type A
          <select id="id-a-40-30">${[...Array(21)].map((_,i)=>`<option ${i===0?'selected':''} value="${i}">${i}</option>`).join('')}</select>
        </label>
        <label>ID 30mA - 40A - Type AC
          <select id="id-ac-40-30">${[...Array(21)].map((_,i)=>`<option ${i===0?'selected':''} value="${i}">${i}</option>`).join('')}</select>
        </label>
        <label>ID 30mA - 63A - Type A
          <select id="id-a-63-30">${[...Array(21)].map((_,i)=>`<option ${i===0?'selected':''} value="${i}">${i}</option>`).join('')}</select>
        </label>
        <label>ID 30mA - 63A - Type AC
          <select id="id-ac-63-30">${[...Array(21)].map((_,i)=>`<option ${i===0?'selected':''} value="${i}">${i}</option>`).join('')}</select>
        </label>
      </div>

      <div class="row" style="margin-top:12px;">
        ${b("Ajouter au devis","submitTab_ID()","btn primary")}
      </div>
    </div>
  `);
}
function submitTab_ID(){
  const defs = [
    { id:"id-a-40-30",  name:"ID 30mA - 40A - Type A"  },
    { id:"id-ac-40-30", name:"ID 30mA - 40A - Type AC" },
    { id:"id-a-63-30",  name:"ID 30mA - 63A - Type A"  },
    { id:"id-ac-63-30", name:"ID 30mA - 63A - Type AC" }
  ];
  let added = 0;
  ensureTableau();
  defs.forEach(d=>{
    const q = +document.getElementById(d.id).value || 0;
    if(q>0){
      devis["Tableau"].items.push({
        category: "Tableau/Modulaire",
        intervention: "",
        pose: "",
        designation: d.name,
        qty: q,
        prixU: 0
      });
      added++;
    }
  });
  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal();
  alert("Interrupteurs diff√©rentiels ajout√©s.");
  pageTabHome();
}

/* ========== (3) MODULAIRE : DISJONCTEURS regroup√©s ========== */

function pageTab_Disjoncteurs(){
  // helpers rendus sans clavier
  const opts = (max=20)=>[...Array(max+1)].map((_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');

  view(`
    <div class="card">
      ${b("Retour","pageTabHome()","btn back")}
      <h2>Disjoncteurs modulaires (2A / 10A / 16A / 20A / 32A)</h2>

      <div class="list">
        <label>2 A (Qt√©)
          <select id="djq-2">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(2)")}
        </label>
        <label>10 A (Qt√©)
          <select id="djq-10">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(10)")}
        </label>
        <label>16 A (Qt√©)
          <select id="djq-16">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(16)")}
        </label>
        <label>20 A (Qt√©)
          <select id="djq-20">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(20)")}
        </label>
        <label>32 A (Qt√©)
          <select id="djq-32">${opts(30)}</select>
          ${b("D√©tail circuits","pageTab_DisjDetails(32)")}
        </label>
      </div>

      <div class="row" style="margin-top:12px;">
        ${b("Vider la s√©lection","pageTab_DisjVider()")}
        ${b("Valider ces disjoncteurs","pageTab_DisjValider()","btn primary")}
      </div>
      <p class="muted" style="margin-top:6px;">Astuce : utilise ¬´ D√©tail circuits ¬ª pour g√©n√©rer automatiquement ‚ÄúCircuit 1, 2, ‚Ä¶‚Äù sans clavier. Apr√®s validation, tu restes sur cette page pour ajouter d‚Äôautres calibres.</p>
    </div>
  `);

  // Re-appliquer l'√©tat stock√©
  document.getElementById('djq-2').value  = tabState.disj[2].qty;
  document.getElementById('djq-10').value = tabState.disj[10].qty;
  document.getElementById('djq-16').value = tabState.disj[16].qty;
  document.getElementById('djq-20').value = tabState.disj[20].qty;
  document.getElementById('djq-32').value = tabState.disj[32].qty;
}

function pageTab_DisjDetails(rating){
  // quantit√© actuelle
  const currentQty = tabState.disj[rating]?.qty || 0;
  // options 0..30
  const opts = (sel)=>[...Array(31)].map((_,i)=>`<option value="${i}" ${i===sel?'selected':''}>${i}</option>`).join('');
  // items ‚ÄúCircuit 1‚Ä¶N‚Äù visuels (pr√©-remplis, pas de clavier)
  const preview = (n)=> n>0
    ? `<ul style="margin:8px 0 0 18px;">${[...Array(n)].map((_,i)=>`<li>Circuit ${i+1}</li>`).join('')}</ul>`
    : `<p class="muted">Aucun circuit pour l‚Äôinstant.</p>`;

  view(`
    <div class="card">
      ${b("Retour","pageTab_Disjoncteurs()","btn back")}
      <h2>D√©tail circuits ‚Äî ${rating} A</h2>

      <label>Nombre de circuits
        <select id="dj-detail-qty">${opts(currentQty)}</select>
      </label>

      <div id="dj-detail-preview" style="margin-top:8px;">
        ${preview(currentQty)}
      </div>

      <div class="row" style="margin-top:12px;">
        ${b("Enregistrer et revenir","pageTab_DisjSaveDetails("+rating+")","btn primary")}
      </div>
    </div>
  `);

  // live preview quand on change la quantit√© (sans clavier)
  document.getElementById('dj-detail-qty').addEventListener('change', (e)=>{
    const n = +e.target.value || 0;
    document.getElementById('dj-detail-preview').innerHTML =
      n>0 ? `<ul style="margin:8px 0 0 18px;">${[...Array(n)].map((_,i)=>`<li>Circuit ${i+1}</li>`).join('')}</ul>`
          : `<p class="muted">Aucun circuit pour l‚Äôinstant.</p>`;
  });
}

function pageTab_DisjSaveDetails(rating){
  const qty = +document.getElementById('dj-detail-qty').value || 0;
  tabState.disj[rating] = {
    qty,
    names: qty>0 ? [...Array(qty)].map((_,i)=>`Circuit ${i+1}`) : []
  };
  alert(`D√©tails ${rating} A enregistr√©s (${qty} circuit(s)).`);
  pageTab_Disjoncteurs();
}

function pageTab_DisjVider(){
  tabState.disj = {2:{qty:0,names:[]},10:{qty:0,names:[]},16:{qty:0,names:[]},20:{qty:0,names:[]},32:{qty:0,names:[]}};
  pageTab_Disjoncteurs();
}

function pageTab_DisjValider(){
  // r√©cup√®re les quantit√©s visibles (au cas o√π l‚Äôutilisateur a chang√© sans passer par ‚ÄúD√©tail circuits‚Äù)
  const readQty = (id)=> +document.getElementById(id).value || 0;
  tabState.disj[2].qty  = readQty('djq-2');
  tabState.disj[10].qty = readQty('djq-10');
  tabState.disj[16].qty = readQty('djq-16');
  tabState.disj[20].qty = readQty('djq-20');
  tabState.disj[32].qty = readQty('djq-32');

  let added = 0;
  ensureTableau();

  [2,10,16,20,32].forEach(rating=>{
    const { qty, names } = tabState.disj[rating];
    if(qty>0){
      const details = (names && names.length)
        ? ` ‚Äî circuits : ${names.join(', ')}`
        : '';
      devis["Tableau"].items.push({
        category: "Tableau/Modulaire",
        intervention: "",
        pose: "",
        designation: `Disjoncteur ${rating} A${details}`,
        qty,
        prixU: 0
      });
      added++;
    }
  });

  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal();
  alert("Disjoncteurs ajout√©s au devis.");
  // On reste sur la page Disjoncteurs pour pouvoir compl√©ter d‚Äôautres calibres
  pageTab_Disjoncteurs();
}

/* ========== (4) COMMANDE & PILOTAGE ========== */

function pageTabMod_Commandes(){
  const opts = (max=20)=>[...Array(max+1)].map((_,i)=>`<option value="${i}">${i}</option>`).join('');
  view(`
    <div class="card">
      ${b("Retour","pageTabHome()","btn back")}
      <h2>Commande & pilotage modulaire</h2>

      <div class="list">
        <label>T√©l√©rupteur
          <select id="cmd-telerup">${opts(20)}</select>
        </label>
        <label>T√©l√©rupteur silencieux
          <select id="cmd-telerup-sil">${opts(20)}</select>
        </label>
        <label>Horloge m√©canique + Disjoncteur 2A
          <select id="cmd-horloge-2a">${opts(20)}</select>
        </label>
        <label>Horloge m√©canique + contacteur HC + Disjoncteur 2A
          <select id="cmd-horloge-hc-2a">${opts(20)}</select>
        </label>
      </div>

      <div class="row" style="margin-top:12px;">
        ${b("Ajouter au devis","submitTabMod_Commandes()","btn primary")}
      </div>
    </div>
  `);
}
function submitTabMod_Commandes(){
  const pick = id => +document.getElementById(id).value || 0;
  const defs = [
    { id:"cmd-telerup",       name:"T√©l√©rupteur" },
    { id:"cmd-telerup-sil",   name:"T√©l√©rupteur silencieux" },
    { id:"cmd-horloge-2a",    name:"Horloge m√©canique + Disjoncteur 2A" },
    { id:"cmd-horloge-hc-2a", name:"Horloge m√©canique + contacteur heures creuses + Disjoncteur 2A" }
  ];
  let added=0;
  ensureTableau();
  defs.forEach(d=>{
    const q = pick(d.id);
    if(q>0){
      devis["Tableau"].items.push({
        category: "Tableau/Commandes",
        intervention: "",
        pose: "",
        designation: d.name,
        qty: q,
        prixU: 0
      });
      added++;
    }
  });
  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal();
  alert("Commandes modulaires ajout√©es.");
  pageTabHome();
}

/* ========== (5) SP√âCIFIQUE ========== */

function pageTabMod_Specifique(){
  const label = prompt("Intitul√© (libre) :", "");
  if(!label){ pageTabHome(); return; }
  const prix  = parseFloat(prompt("Prix unitaire estim√© (‚Ç¨) :", "0")) || 0;
  const qty   = Math.max(1, parseInt(prompt("Quantit√© :", "1")||"1", 10));

  ensureTableau();
  devis["Tableau"].items.push({
    category: "Tableau/Modulaire ‚Äî Sp√©cifique",
    intervention: "",
    pose: "",
    designation: label,
    qty,
    prixU: prix
  });
  saveLocal();
  alert("Ajout√©.");
  pageTabHome();
}
