<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis ‚Äî V3.0</title>

  <!-- Styles de base -->
  <style>
    :root {
      --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666;
      --line:#e8e8e8; --primary:#111;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#444; background:#fafafa; }
  </style>

  <!-- JSZip (exports ZIP) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- Cache-busting : ajoute ?v=timestamp une seule fois par onglet -->
  <script>
  (function(){
    try{
      var url = new URL(location.href);
      if (url.searchParams.has('v')) return;
      var onceKey = 'cb_once_' + location.pathname;
      if (sessionStorage.getItem(onceKey)) return;
      url.searchParams.set('v', Date.now());
      sessionStorage.setItem(onceKey, '1');
      location.replace(url.toString());
    }catch(e){}
  })();
  </script>
</head>
<body>
  <header>MiniDevis ‚Äî V3.0</header>
  <main id="app"></main>

  <!-- Sentinelle ultra-t√¥t -->
  <script>
  (function(){
    var app = document.getElementById('app');
    if(app){ app.innerHTML =
      '<div class="card">Loader OK ‚Äî en attente des chapitres JS‚Ä¶</div>';
    }
  })();
  </script>

  <!-- =============================
     CHAPITRE 2 : √âTAT & HELPERS
     Index :
       ¬ß2.1 ‚Ä¢ Gestion erreurs globales
       ¬ß2.2 ‚Ä¢ √âtat global & contexte courant
       ¬ß2.3 ‚Ä¢ Identifiants & helpers DOM/UI
       ¬ß2.4 ‚Ä¢ Libell√©s de pi√®ces (build/format)
       ¬ß2.5 ‚Ä¢ Persistance locale (save/load)
     ============================= -->
<script>
// ¬ß2.1 ‚Ä¢ Gestion erreurs globales
window.addEventListener('error', function (e) {
  var el = document.getElementById('app');
  if (el) {
    el.innerHTML =
      '<div class="card"><h2>Erreur JS</h2><pre>'
      + (e.message || 'Erreur inconnue')
      + '\n' + (e.filename || '') + ':' + (e.lineno || 0) + ':' + (e.colno || 0)
      + '</pre></div>';
  }
});

// ¬ß2.2 ‚Ä¢ √âtat global & contexte courant
var devis = {}; // contiendra aussi __id, __name, __tabCounter
var ctx   = { piece:null, category:null, intervention:null, pose:null, designation:null };

// ¬ß2.3 ‚Ä¢ Identifiants & helpers DOM/UI
function genId(){ return 'dv_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
function ensureId(){ if(!devis.__id) devis.__id = genId(); }
function $app(){ return document.getElementById('app'); }
function b(label, fn, cls){
  cls = cls || 'btn';
  return '<button class="'+cls+'" onclick=\''+fn+'\'>'+label+'</button>';
}
function euro(n){ return (+(n||0)).toFixed(2) + ' ‚Ç¨'; }
function view(html, noFooter){
  if(!noFooter){
    html += '<div class="row" style="margin-top:16px; gap:12px;">'
          + b('‚¨ÖÔ∏è Accueil','confirmBackHome()','btn back')
          + b('üíæ Sauvegarder devis','saveCurrentDevis()','btn primary')
          + '</div>';
  }
  $app().innerHTML = html;
}
function confirmBackHome(){
  var hasData = Object.keys(devis)
    .filter(function(k){ return k.indexOf('__') !== 0; })
    .some(function(k){
      var s = devis[k]||{};
      return (s.items && s.items.length>0) || (s.note && s.note.trim().length>0);
    });

  if(!hasData || confirm('Revenir au menu principal ?\n‚ö†Ô∏è Les modifications non sauvegard√©es seront perdues.')){
    if (typeof pageMain === 'function') pageMain();
    else $app().innerHTML = '<div class="card"><h2>Accueil</h2><p class="muted">Le chapitre Menu (4) n\'est pas encore charg√©.</p></div>';
  }
}

// ¬ß2.4 ‚Ä¢ Libell√©s de pi√®ces (build/format)
function buildPieceLabel(base, qualif, etage){
  var lbl = base || '';
  if(qualif && qualif.trim()) lbl += ' ('+qualif.trim()+')';
  if(etage && etage.trim())   lbl += ' ‚Äî '+etage.trim();
  return lbl;
}
function nextFreeKey(label){
  if(!devis[label]) return label;
  var n=2; while(devis[label+' ('+n+')']) n++;
  return label+' ('+n+')';
}
function createOrGetPiece(base, qualif, etage){
  var wanted = buildPieceLabel(base,qualif,etage);
  var key    = nextFreeKey(wanted);
  if(!devis[key]) devis[key] = { __base:base, qualificatif:qualif||'', etage:etage||'', items:[], note:'' };
  saveLocal();
  return key;
}
function formatPieceLabel(key){
  var s = devis[key]; if(!s) return key;
  var base = s.__base || key;
  return buildPieceLabel(base, s.qualificatif, s.etage);
}

// ¬ß2.5 ‚Ä¢ Persistance locale (save/load)
function ensureSection(key){
  if(!devis[key]) devis[key] = { items:[], note:'', qualificatif:'', etage:'' };
}
function saveLocal(){
  try { localStorage.setItem('devis', JSON.stringify(devis)); } catch(e){}
}
function loadLocal(){
  try { devis = JSON.parse(localStorage.getItem('devis') || '{}') || {}; }
  catch(e){ devis = {}; }
  ensureId();
}
</script>

<!-- =============================
     CHAPITRE 3 : CONSTANTES
     ============================= -->
<script>
// Pi√®ces pr√©d√©finies
var PIECES_PREDEFINIES = [
  'Salon','Cuisine','Salle √† manger','Salle de bain','Salle d\'eau',
  'Chambre 1','Chambre 2','Chambre 3','Toilettes','Bureau',
  'Buanderie','Garage','Couloir','Terrasse','Balcon','Jardin',
  'D√©barras','Ext√©rieur','Grenier/Combles','Atelier',
  'Abri de jardin','Entr√©e','Biblioth√®que'
];

// Cat√©gories standards
var CATEGORIES = [
  'Prises','√âclairage','Circuit sp√©cialis√©','Sp√©cifique'
];

// Modes de pose
var POSES = [
  'Encastr√© ma√ßonnerie','Placo','Semi-encastr√©',
  'Sur-mesure','Saillie avec moulure','Sous tube IRL'
];

// Sections de c√¢blage (avec option personnalis√©e)
var SECTIONS_CABLE = [
  '0,75 mm¬≤','1,5 mm¬≤','2,5 mm¬≤','6 mm¬≤','Personnalis√©e‚Ä¶'
];

// D√©signations possibles par cat√©gorie
// ‚ö†Ô∏è pas d‚Äô"Autre circuit sp√©cialis√©" (remplac√© par champ libre dans l‚ÄôUI)
var DESIGNATIONS_PAR_CATEGORIE = {
  'Prises': ['Prise'],
  '√âclairage/Luminaires': ['Point de centre','Applique'],
  '√âclairage/Commandes': ['Interrupteur simple','Interrupteur double'],
  'Circuit sp√©cialis√©': [
    'Four','Plaque de cuisson','Lave-linge','Lave-vaisselle',
    'S√®che-linge','Cumulus','VMC','Chauffage','Climatisation',
    'Prise ext√©rieure √©tanche'
  ]
};

// Tarifs de base (fourniture + pose "standard" de r√©f√©rence)
// Ces prix restent la r√©f√©rence de base AVANT coefficient de pose et/ou section.
var TARIFS = {
  'Prise': { creation:120, recablage_sans:50, recablage_avec:70, remplacement:20 },
  'Point de centre': { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  'Applique': { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  'Interrupteur simple': { creation:40, recablage_sans:50, recablage_avec:75, remplacement:25 },
  'Interrupteur double': { creation:60, recablage_sans:50, recablage_avec:85, remplacement:35 },

  // Circuits sp√©cialis√©s ‚Äî base = section 0,75/1,5 mm¬≤
  'Four': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Plaque de cuisson': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Lave-linge': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Lave-vaisselle': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'S√®che-linge': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Cumulus': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'VMC': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Chauffage': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Climatisation': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Prise ext√©rieure √©tanche': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 }
};

// √âtages pr√©d√©finis
var ETAGES = [
  'Rez-de-chauss√©e','1er √©tage','2e √©tage',
  'Sous-sol','Combles','Annexe'
];

/* ======================================================
   COEFFICIENTS ‚Äî POSE & SECTION (circuits sp√©cialis√©s)
   ====================================================== */
// Coefficients de POSE appliqu√©s aux cat√©gories Prises + Circuit sp√©cialis√©
// (modifie/affine les valeurs √† ta convenance)
var TARIFS_POSE = {
  'Encastr√© ma√ßonnerie': 1.15,
  'Placo':               1.00,
  'Semi-encastr√©':       1.10,
  'Sur-mesure':          1.25,
  'Saillie avec moulure':1.08,
  'Sous tube IRL':       1.05
};

// Coefficients de SECTION (uniquement Circuit sp√©cialis√©)
// Base = prix section 0,75 et 1,5 mm¬≤
var COEF_SECTION_CIRCUIT = {
  '0,75 mm¬≤': 1.00,
  '1,5 mm¬≤':  1.00,
  '2,5 mm¬≤':  1.10, // +10%
  '6 mm¬≤':    1.20, // +20%
  'Personnalis√©e‚Ä¶': 1.00 // par d√©faut (pas d‚Äôimpact)
};

/* ======================================================
   TARIFS ‚Äî TABLEAU & DISTRIBUTION (pose, modulaires, etc.)
   (inchang√© par ta demande)
   ====================================================== */
var TARIFS_TABLEAU = {
  pose_base_13: { 1:60, 2:80, 3:100, 4:120 },
  coef: {
    modules: { 13:1.00, 18:1.30, 24:1.50 },
    pose: { 'Saillie':1.00, 'Encastr√©':1.70 },
    intervention: { 'Cr√©ation':1.00, 'Avec d√©pose de l‚Äôexistant':1.30 }
  },
  // + ajout 40A = 45‚Ç¨
  disjoncteurs: { 2:32, 10:25, 16:25, 20:25, 32:32, 40:45 },
  inter_diff: { '40A-AC':60, '40A-A':80, '63A-AC':100, '63A-A':120 },
  commandes: {
    'T√©l√©rupteur':50,
    'T√©l√©rupteur silencieux':70,
    'Horloge m√©canique + Disjoncteur 2A':80,
    'Horloge m√©canique + contacteur heures creuses + Disjoncteur 2A':130
  }
};

/* ======================================================
   HELPERS PRIX
   ====================================================== */
function getTabPrice(rang, modules, pose, intervention){
  var base = TARIFS_TABLEAU.pose_base_13[+rang] || 0;
  if(!base) return 0;
  var cMod = TARIFS_TABLEAU.coef.modules[+modules] || 1.00;
  var cPose= TARIFS_TABLEAU.coef.pose[pose] || 1.00;
  var cInv = TARIFS_TABLEAU.coef.intervention[intervention] || 1.00;
  return Math.round(base * cMod * cPose * cInv * 100) / 100;
}

// Prix de base ¬´ brut ¬ª √† partir de la d√©signation et de l‚Äôintervention
function getPrix(designation, intervention){
  var base = TARIFS[designation] || {};
  if(intervention === 'Cr√©ation') return base.creation || 0;
  if(intervention && intervention.indexOf('sans remplacement') >= 0) return base.recablage_sans || 0;
  if(intervention && intervention.indexOf('avec remplacement') >= 0) return base.recablage_avec || 0;
  if(intervention && intervention.indexOf('Remplacement') === 0) return base.remplacement || 0;
  return 0;
}

// Prix final int√©grant pose (+ section si Circuit sp√©cialis√©)
function computePUFinal(opts){
  // opts = { category, designation, intervention, pose, section }
  var pu = getPrix(opts.designation, opts.intervention) || 0;

  // 1) coef de pose (Prises + Circuit sp√©cialis√© uniquement)
  if (opts.category === 'Prises' || opts.category === 'Circuit sp√©cialis√©') {
    var coefPose = TARIFS_POSE[opts.pose] || 1;
    pu = pu * coefPose;
  }

  // 2) coef de section (Circuit sp√©cialis√© uniquement)
  if (opts.category === 'Circuit sp√©cialis√©') {
    var coefSec = COEF_SECTION_CIRCUIT[opts.section] || 1;
    pu = pu * coefSec;
  }

  return Math.round(pu * 100) / 100; // on garde 2 d√©cimales ¬´ propres ¬ª
}
</script>

  <!-- =============================
     CHAPITRE 4 : MENU PRINCIPAL
     Index :
       ¬ß4.1 ‚Ä¢ Accueil principal
       ¬ß4.2 ‚Ä¢ Nouveau devis / Ouverture / Suppression
       ¬ß4.3 ‚Ä¢ Sauvegarde compl√®te
     ============================= -->
<script>
// ¬ß4.1 ‚Ä¢ Accueil principal
function pageMain(){
  view(
    '<div class="card">'
      +'<h2>Menu principal</h2>'
      +'<div class="row">'
        +b('‚ûï Nouveau devis','actionNouveauDevis()','btn primary')
        +b('üìÇ Mes devis sauvegard√©s','pageSavedDevis()','btn')
      +'</div>'
    +'</div>'
  , true);
}

// ¬ß4.2 ‚Ä¢ Nouveau devis / Ouverture / Suppression
function actionNouveauDevis(){
  devis = { __id: genId(), __name: '' };
  saveLocal();
  pageHome();
}
function pageSavedDevis(){
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  if(!saved.length){
    return view(
      '<div class="card">'
        +b('Retour','pageMain()','btn back')
        +'<h2>Mes devis sauvegard√©s</h2>'
        +'<p class="muted">Aucun devis sauvegard√©.</p>'
      +'</div>', true
    );
  }
  var list = saved.map(function(d,i){
    return '<div class="pill">'
      +'<strong>'+d.name+'</strong> <small>'+d.date+'</small>'
      +b('Ouvrir','loadDevis('+i+')','btn')
      +b('Supprimer','deleteDevis('+i+')','btn')
      +'</div>';
  }).join('');
  view(
    '<div class="card">'
      +b('Retour','pageMain()','btn back')
      +'<h2>Mes devis sauvegard√©s</h2>'
      +'<div class="list">'+list+'</div>'
    +'</div>', true
  );
}
function loadDevis(idx){
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  if(!saved[idx]) return pageSavedDevis();
  devis = saved[idx].data || {};
  ensureId();
  saveLocal();
  pageHome();
}
function deleteDevis(idx){
  if(!confirm('Supprimer ce devis sauvegard√© ?')) return;
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  saved.splice(idx,1);
  localStorage.setItem('savedDevisList', JSON.stringify(saved));
  pageSavedDevis();
}

// ¬ß4.3 ‚Ä¢ Sauvegarde compl√®te
function saveCurrentDevis(){
  ensureId();
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  var i = saved.findIndex(function(d){ return d.data && d.data.__id === devis.__id; });
  if(i >= 0){
    var name = devis.__name || saved[i].name || ('Devis '+new Date().toLocaleDateString());
    devis.__name = name;
    saved[i] = { name:name, date:new Date().toLocaleDateString(), data:devis };
    localStorage.setItem('savedDevisList', JSON.stringify(saved));
    alert('Devis mis √† jour.');
    return;
  }
  var name2 = (devis.__name||'').trim();
  if(!name2){
    name2 = (prompt('Nom du devis :','')||'').trim();
    if(!name2){ alert('Sauvegarde annul√©e.'); return; }
  }
  var j = saved.findIndex(function(d){ return (d.name||'').toLowerCase() === name2.toLowerCase(); });
  devis.__name = name2;
  if(j >= 0){
    if(!confirm('Un devis ¬´ '+name2+' ¬ª existe d√©j√†. L\'√©craser ?')) return;
    saved[j] = { name:name2, date:new Date().toLocaleDateString(), data:devis };
  } else {
    saved.push({ name:name2, date:new Date().toLocaleDateString(), data:devis });
  }
  localStorage.setItem('savedDevisList', JSON.stringify(saved));
  alert('Devis sauvegard√© !');
}
</script>

<!-- =============================
     CHAPITRE 5 : ACCUEIL & FLUX PI√àCES ‚Äî V5 one-page
     Index :
       ¬ß0  ‚Ä¢ Accueil (liste + raccourcis)
       ¬ß1  ‚Ä¢ Ajout d‚Äôune pi√®ce (pr√©defs + perso)
       ¬ß2  ‚Ä¢ D√©tail pi√®ce (cat√©gories + lignes)
       ¬ß3  ‚Ä¢ Cat√©gorie √âclairage : sous-rubriques
       ¬ß4  ‚Ä¢ Choix intervention ‚Üí √©cran unique ‚Äúone-shot‚Äù
       ¬ß5  ‚Ä¢ Sp√©cifique : formulaire d√©di√©
       ¬ß6  ‚Ä¢ Note de pi√®ce
     ============================= -->
<script>
/* ======================
   ¬ß0 ‚Ä¢ ACCUEIL
   ====================== */
function goVent(){
  if (typeof pageVentAccueil === 'function') {
    pageVentAccueil();
  } else {
    alert('La section Ventilation (chapitre 6.2) n‚Äôest pas encore charg√©e.');
  }
}

function pageHome(){
  var keys = Object.keys(devis).filter(k=>k.indexOf('__')!==0);
  var listHtml = keys.length ? keys.map(function(key){
    var s = devis[key] || {};
    var badges = [
      (s.qualificatif && s.qualificatif.trim()) ? '<span class="badge">'+s.qualificatif+'</span>' : '',
      (s.etage && s.etage.trim()) ? '<span class="badge">'+s.etage+'</span>' : ''
    ].filter(Boolean).join(' ');
    var label = pieceDisplayLabel(key);
    return '<div class="pill">'
      +'<strong>'+label+'</strong> '
      +'<small>'+((s.items||[]).length)+' ligne(s)</small> '
      +badges
      +b('Ouvrir','goPiece('+JSON.stringify(key)+')','btn')
      +b('Supprimer','removePiece('+JSON.stringify(key)+')','btn')
    +'</div>';
  }).join('') : '<p class="muted">Aucune pi√®ce ajout√©e pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      +'<h2>Accueil</h2>'
      +'<div class="row">'
        +b('Ajouter une pi√®ce','pageAddPiece()','btn primary')
        +b('Cr√©er un tableau','pageTabCreate()','btn')
        +b('Ventilation','goVent()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Pi√®ces & Tableaux ajout√©s</h2>'
      +'<div class="list">'+listHtml+'</div>'
    +'</div>'
    +'<div class="row" style="margin-top:12px;">'
      +b('Voir l‚Äôestimatif','pageEstimatif()','btn')
      +b('Voir les totaux','pageTotaux()','btn')
    +'</div>'
  );
}

/* ======================
   ¬ß1 ‚Ä¢ AJOUTER UNE PI√àCE
   ====================== */
function pageAddPiece(){
  var opts = PIECES_PREDEFINIES.map(p=>'<option value="'+p+'">'+p+'</option>').join('')
           + '<option value="__NEW__">‚ûï Cr√©er une nouvelle pi√®ce‚Ä¶</option>';
  var etageOpts = ['(aucun)'].concat(ETAGES).map(e=>'<option value="'+e+'">'+e+'</option>').join('');

  view(
    '<div class="card">'
      +b('Retour','pageHome()','btn back')
      +'<h2>Ajouter une pi√®ce</h2>'
      +'<label>Choisir une pi√®ce</label>'
      +'<select id="piece-choice">'+opts+'</select>'
      +'<label style="margin-top:10px;">Qualificatif (optionnel)</label>'
      +'<input id="piece-qualif" placeholder="ex : Parents, RDC, gauche" />'
      +'<label style="margin-top:10px;">√âtage (optionnel)</label>'
      +'<select id="piece-etage">'+etageOpts+'</select>'
      +'<div class="row" style="margin-top:10px;">'
        +b('Valider','confirmPieceChoice()','btn primary')
      +'</div>'
    +'</div>'
  );
}

function confirmPieceChoice(){
  var sel    = document.getElementById('piece-choice').value;
  var qualif = (document.getElementById('piece-qualif').value || '').trim();
  var etage  = document.getElementById('piece-etage').value;
  if(!sel) return;

  var base = sel;
  if(sel==='__NEW__'){
    base = (prompt('Nom de la pi√®ce :','') || '').trim();
    if(!base) return;
  }
  var etageVal = (etage && etage!=='(aucun)') ? etage : '';
  var key = createOrGetPiece(base, qualif, etageVal);
  goPiece(key);
}

function removePiece(key){
  if(confirm('Supprimer la pi√®ce ¬´ '+pieceDisplayLabel(key)+' ¬ª et toutes ses lignes ?')){
    delete devis[key];
    saveLocal();
    pageHome();
  }
}

/* =========================================
   ¬ß2 ‚Ä¢ D√âTAIL D‚ÄôUNE PI√àCE & CAT√âGORIES
   ========================================= */
function goPiece(key){
  ctx = { piece:key, category:null, intervention:null, pose:null, designation:null };
  ensureSection(key);

  var cats = CATEGORIES
    .filter(c=>c!=='Sp√©cifique')
    .map(c=> b(c,'goCategory('+JSON.stringify(c)+')','btn'))
    .join('');

  var s = devis[key];
  var noteTxt = s.note ? '<em class="muted">Note : '+s.note+'</em>' : '<span class="muted">Aucune note</span>';

  var lignes = (s.items||[]).length
    ? '<ul>'+s.items.map(function(it,i){
        var total = (+it.prixU||0) * (+it.qty||0);
        var poseTxt = it.pose ? ' ‚Äî '+String(it.pose).toLowerCase() : '';
        var unitTxt = it.unit || 'u';
        var left = it.intervention ? (it.intervention+' ‚Äî ') : '';
        return '<li>'
          + left + it.designation + poseTxt
          +' ('+it.qty+' '+unitTxt+' √ó '+euro(it.prixU)+' = '+euro(total)+') '
          +b('√ó','delLine('+JSON.stringify(key)+','+i+')','btn')
        +'</li>';
      }).join('') + '</ul>'
    : '<p class="muted">Aucune ligne pour l‚Äôinstant.</p>';

  var label = pieceDisplayLabel(key);

  view(
    '<div class="card">'
      +b('Retour','pageHome()','btn back')
      +'<h2>'+label+'</h2>'
      +'<div class="row">'+cats+b('Sp√©cifique','pageSpecifiqueForm()','btn ghost')+'</div>'
      +'<div class="row" style="margin-top:10px;">'
        +b('Ajouter / modifier la note','editPieceNote()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Lignes de la pi√®ce</h2>'
      +lignes
      +'<p style="margin-top:8px;">'+noteTxt+'</p>'
    +'</div>'
  );
}

function delLine(key, idx){
  (devis[key].items||[]).splice(idx,1);
  saveLocal();
  goPiece(key);
}

/* =========================================
   ¬ß3 ‚Ä¢ √âCLAIRAGE : sous-rubriques
   ========================================= */
function goCategory(cat){
  ctx.category = cat;
  if(cat==='√âclairage') return goEclairageSub();

  var interventions = [];
  if(cat==='Prises' || cat==='Circuit sp√©cialis√©'){
    interventions = [
      'Cr√©ation',
      'Remplacement appareillage',
      'Rec√¢blage avec remplacement appareillage',
      'Rec√¢blage sans remplacement appareillage'
    ];
  }else if(cat==='Sp√©cifique'){
    interventions = ['Saisie libre avec prix'];
  }else{
    interventions = ['Cr√©ation'];
  }

  var btns = interventions.map(i=> b(i,'goIntervention('+JSON.stringify(i)+')','btn')).join('');

  view(
    '<div class="card">'
      +b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      +'<h2>'+ctx.category+' ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      +'<div class="row">'+btns+'</div>'
    +'</div>'
  );
}

function goEclairageSub(){
  view(
    '<div class="card">'
      +b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      +'<h2>√âclairage ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      +'<div class="row">'
        +b('Luminaires','setEclairageBranch('+JSON.stringify('√âclairage/Luminaires')+')','btn')
        +b('Commandes','setEclairageBranch('+JSON.stringify('√âclairage/Commandes')+')','btn')
      +'</div>'
    +'</div>'
  );
}

function setEclairageBranch(branch){
  ctx.category = branch;
  var interventions = (branch==='√âclairage/Luminaires')
    ? ['Cr√©ation','Remplacement luminaire','Rec√¢blage avec remplacement luminaire','Rec√¢blage sans remplacement luminaire']
    : ['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'];

  var btns = interventions.map(i=> b(i,'goIntervention('+JSON.stringify(i)+')','btn')).join('');

  view(
    '<div class="card">'
      +b('Retour','goEclairageSub()','btn back')
      +'<h2>'+branch+' ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      +'<div class="row">'+btns+'</div>'
    +'</div>'
  );
}

/* =====================================================
   ¬ß4 ‚Ä¢ INTERVENTION ‚Üí √©cran unique ‚Äúone-shot‚Äù
   ===================================================== */
function goIntervention(interv){
  ctx.intervention = interv;
  if(ctx.category==='Sp√©cifique'){ return pageSpecifiqueForm(); }
  pageOneShotSelection();
}

// Page one-shot : pose visible quand pertinent, section c√¢ble pour ‚ÄúCircuit sp√©cialis√©‚Äù
function pageOneShotSelection(){
  var isElecStd = ['Prises','Circuit sp√©cialis√©','√âclairage/Luminaires','√âclairage/Commandes'].indexOf(ctx.category) >= 0;

  var list = DESIGNATIONS_PAR_CATEGORIE[ctx.category] || ['√âl√©ment'];
  var desigOpts = list.map(d=>'<option value="'+d+'">'+d+'</option>').join('');

  var customDesigBlock = (ctx.category==='Circuit sp√©cialis√©')
    ? '<label style="margin-top:10px;">Nom personnalis√© (remplace la liste ci-dessus)</label>'
      +'<input id="oneshot-custom-desig" placeholder="ex : Pompe √† chaleur" />'
    : '';

  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var poseBlock = isElecStd ? ('<label>Type de pose</label><select id="oneshot-pose">'+poseOpts+'</select>') : '';

  var sectionBlock = '';
  if(ctx.category==='Circuit sp√©cialis√©'){
    var sectOpts = SECTIONS_CABLE.map(s=>'<option value="'+s+'">'+s+'</option>').join('');
    sectionBlock =
      '<label style="margin-top:10px;">Section de c√¢blage</label>'
     +'<select id="oneshot-section">'+sectOpts+'</select>';
  }

  var qtyOpts   = Array.from({length:30}).map((_,i)=>{
    var q=i+1; return '<option value="'+q+'" '+(q===1?'selected':'')+'>'+q+'</option>';
  }).join('');

  var backFn = (ctx.category.indexOf('√âclairage/')===0) ? 'goEclairageSub()' : 'goCategory('+JSON.stringify(ctx.category)+')';

  var defaultDesig = (DESIGNATIONS_PAR_CATEGORIE[ctx.category] && DESIGNATIONS_PAR_CATEGORIE[ctx.category][0]) || '√âl√©ment';

  view(
    '<div class="card">'
      + b('Retour', backFn, 'btn back')
      + '<h2>'+ctx.category+' ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<div class="pill" style="margin-bottom:10px;"><strong>Intervention :</strong>&nbsp;'+ctx.intervention+'</div>'
      + poseBlock
      + '<label style="margin-top:10px;">D√©signation</label>'
      + '<select id="oneshot-desig">'+desigOpts+'</select>'
      + customDesigBlock
      + sectionBlock
      + '<label style="margin-top:10px;">Quantit√©</label>'
      + '<select id="oneshot-qty">'+qtyOpts+'</select>'
      + '<div id="oneshot-preview" class="muted" style="margin-top:10px;">PU estim√© : '
          + '‚Äî Total : ‚Äî'
        +'</div>'
      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveOneShotItem(false)','btn primary')
        + b('Ajouter et rester','saveOneShotItem(true)','btn')
      + '</div>'
    + '</div>'
  );

  var $des  = document.getElementById('oneshot-desig');
  var $qty  = document.getElementById('oneshot-qty');
  var $prev = document.getElementById('oneshot-preview');

  function currentSection(){
    var el = document.getElementById('oneshot-section');
    return el ? el.value : '';
    }
  function currentPose(){
    var el = document.getElementById('oneshot-pose');
    return el ? el.value : '';
  }

  function refreshPreview(){
    var designation = ($des && $des.value) || defaultDesig;
    var pose = currentPose();
    var section = currentSection();
    var q  = parseInt(($qty && $qty.value) || '1', 10) || 1;

    var pu = (typeof computePUFinal==='function')
      ? computePUFinal({
          category: ctx.category,
          designation: designation,
          intervention: ctx.intervention,
          pose: pose,
          section: section
        })
      : (getPrix(designation, ctx.intervention) || 0);

    $prev.innerHTML = 'PU estim√© : '+euro(pu)+' ‚Äî Total : '+euro(pu*q);
  }

  if($des) $des.addEventListener('change', refreshPreview);
  if($qty) $qty.addEventListener('change', refreshPreview);
  var $poseSel = document.getElementById('oneshot-pose');
  if($poseSel) $poseSel.addEventListener('change', refreshPreview);
  var $sectSel = document.getElementById('oneshot-section');
  if($sectSel) $sectSel.addEventListener('change', refreshPreview);

  refreshPreview();
}

function saveOneShotItem(stayHere){
  var $des  = document.getElementById('oneshot-desig');
  var $qty  = document.getElementById('oneshot-qty');
  var $pose = document.getElementById('oneshot-pose');
  var $custom = document.getElementById('oneshot-custom-desig');
  var $sect = document.getElementById('oneshot-section');

  // D√©signation affich√©e √† l'utilisateur
  var designation = ($custom && $custom.value.trim()) ? $custom.value.trim() : ($des ? ($des.value || '√âl√©ment') : '√âl√©ment');

  // Section : ajout texte dans la d√©signation si renseign√©e
  var section = ($sect && $sect.value) ? $sect.value : '';
  if(section === 'Personnalis√©e‚Ä¶'){
    var s2 = (prompt('Section personnalis√©e :','')||'').trim();
    if(s2) section = s2; else section = '';
  }
  if(section){ designation += ' ‚Äî ' + section; }

  var qty = parseInt($qty ? $qty.value : '1', 10) || 1;
  var pose = ($pose && $pose.value) ? $pose.value : '';

  // Calcul PU final avec pose + section (si applicable)
  var pickedDesignationForBase = ($des && $des.value) || designation;
  var puFinal = (typeof computePUFinal==='function')
    ? computePUFinal({
        category: ctx.category,
        designation: pickedDesignationForBase,
        intervention: ctx.intervention,
        pose: pose,
        section: ($sect && $sect.value) || ''
      })
    : (getPrix(pickedDesignationForBase, ctx.intervention) || 0);

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category: ctx.category,
    intervention: ctx.intervention,
    pose: pose,
    designation: designation,
    qty: qty,
    prixU: puFinal,
    __tabKey: ctx.piece
  });
  saveLocal();

  if(stayHere){ pageOneShotSelection(); } else { goPiece(ctx.piece); }
}

/* =========================================
   ¬ß5 ‚Ä¢ SP√âCIFIQUE : formulaire d√©di√©
   ========================================= */
function pageSpecifiqueForm(){
  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var sectOpts  = SECTIONS_CABLE.map(s=>'<option value="'+s+'">'+s+'</option>').join('');

  view(
    '<div class="card">'
      + b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      + '<h2>Sp√©cifique ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<label>Nom du circuit sp√©cifique</label>'
      + '<input id="sp-label" placeholder="ex : Bandeau LED, Pompe piscine‚Ä¶" />'

      + '<label style="margin-top:10px;">Type de pose</label>'
      + '<select id="sp-pose">'+poseOpts+'</select>'

      + '<label style="margin-top:10px;">Section de c√¢blage</label>'
      + '<select id="sp-section">'+sectOpts+'</select>'

      + '<label style="margin-top:10px;">Prix unitaire (‚Ç¨)</label>'
      + '<input id="sp-price" type="number" inputmode="decimal" placeholder="0" />'

      + '<label style="margin-top:10px;">Quantit√©</label>'
      + '<input id="sp-qty" type="number" inputmode="numeric" min="1" value="1" />'

      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveSpecifique(false)','btn primary')
        + b('Ajouter et rester','saveSpecifique(true)','btn')
      + '</div>'
    + '</div>'
  );
}

function saveSpecifique(stayHere){
  var label = (document.getElementById('sp-label').value||'').trim();
  if(!label){ alert('Nom requis.'); return; }

  var pose  = document.getElementById('sp-pose').value || '';
  var sect  = document.getElementById('sp-section').value || '';
  if(sect==='Personnalis√©e‚Ä¶'){
    var s2 = (prompt('Section personnalis√©e :','')||'').trim();
    if(s2) sect = s2; else sect = '';
  }
  if(sect){ label += ' ‚Äî ' + sect; }

  var prix  = parseFloat(document.getElementById('sp-price').value)||0;
  var qty   = Math.max(1, parseInt(document.getElementById('sp-qty').value,10) || 1);

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category:'Sp√©cifique',
    intervention:'',
    pose:pose,
    designation:label,
    qty:qty,
    prixU:prix,
    __tabKey: ctx.piece
  });
  saveLocal();

  if(stayHere){ pageSpecifiqueForm(); } else { goPiece(ctx.piece); }
}

/* ======================
   ¬ß6 ‚Ä¢ NOTE DE PI√àCE
   ====================== */
function editPieceNote(){
  ensureSection(ctx.piece);
  var cur = devis[ctx.piece].note || '';
  var n = prompt('Note pour '+pieceDisplayLabel(ctx.piece), cur);
  if(n!==null) devis[ctx.piece].note = n.trim();
  saveLocal();
  goPiece(ctx.piece);
}
</script>
  <!-- =======================================================================
     CHAPITRE 6 : TABLEAU √âLECTRIQUE (multi-tableaux) ‚Äî vNEXT
     Index :
       ¬ß6.0 ‚Ä¢ √âtat local (tabState) + utilitaires
       ¬ß6.1 ‚Ä¢ Cr√©ation / accueil d‚Äôun tableau (num√©rotation + nom perso)
       ¬ß6.2 ‚Ä¢ Pose du tableau
       ¬ß6.3 ‚Ä¢ Interrupteurs diff√©rentiels
       ¬ß6.3b‚Ä¢ Coupure g√©n√©rale
       ¬ß6.4 ‚Ä¢ Disjoncteurs modulaires (calibre perso + d√©tails circuits)
       ¬ß6.5 ‚Ä¢ Commandes & pilotage
       ¬ß6.6 ‚Ä¢ √âl√©ment sp√©cifique (libre)
     ======================================================================= -->
<script>
// ¬ß6.0 ‚Ä¢ √âtat local + utils
let tabState = {
  disj: {
    2:{qty:0,details:[]}, 10:{qty:0,details:[]}, 16:{qty:0,details:[]},
    20:{qty:0,details:[]}, 32:{qty:0,details:[]}, 40:{qty:0,details:[]},
    __custom__:{qty:0,details:[],label:""}
  }
};
function ensureTableauKey(key){
  if(!devis[key]) devis[key]={__base:"Tableau",items:[],note:"",__customName:""};
}
function saveDisjQtyFromUI(){
  const pick=id=>+((document.getElementById(id)||{}).value||0);
  ["2","10","16","20","32","40"].forEach(r=>{
    const v=pick("djq-"+r);
    if(!tabState.disj[+r]) tabState.disj[+r]={qty:0,details:[]};
    tabState.disj[+r].qty=v;
  });
  const lbl=(document.getElementById("djq-custom-label")?.value||"").trim();
  const q  =pick("djq-custom");
  tabState.disj.__custom__.label=lbl;
  tabState.disj.__custom__.qty=q;
}

// ¬ß6.1 ‚Ä¢ Cr√©ation / accueil
function pageTabCreate(){
  if(typeof devis.__tabCounter!=="number") devis.__tabCounter=0;
  devis.__tabCounter+=1;
  const key="Tableau "+devis.__tabCounter;

  if(!devis[key]) devis[key]={__base:"Tableau",items:[],note:"",__customName:""};
  saveLocal();

  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>Nouveau tableau</h2>'
      + '<p>Identifiant automatique : <strong>'+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="tab-custom" placeholder="ex: Principal RDC" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Valider","saveTabCustomName("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function saveTabCustomName(key){
  const name=(document.getElementById("tab-custom").value||"").trim();
  if(devis[key]){ devis[key].__customName=name; saveLocal(); }
  pageTabHome(key);
}
function pageTabHome(key){
  if(!key || !devis[key]) return pageHome();
  const custom = devis[key].__customName ? " ‚Äî "+devis[key].__customName : "";
  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>'+key+custom+'</h2>'
      + '<div class="row" style="margin-top:10px;">'
        + b("1 ¬∑ Pose du tableau","pageTabPose("+JSON.stringify(key)+")","btn primary")
        + b("2 ¬∑ Interrupteurs diff√©rentiels","pageTab_ID("+JSON.stringify(key)+")","btn")
        + b("3 ¬∑ Coupure g√©n√©rale","pageTab_Coupure("+JSON.stringify(key)+")","btn") /* NOUVEAU */
        + b("4 ¬∑ Disjoncteurs modulaires","pageTab_Disjoncteurs("+JSON.stringify(key)+")","btn")
        + b("5 ¬∑ Commandes / pilotage","pageTabMod_Commandes("+JSON.stringify(key)+")","btn")
        + b("6 ¬∑ Sp√©cifique (libre + prix)","pageTabMod_Specifique("+JSON.stringify(key)+")","btn ghost")
      + '</div>'
      + '<p class="muted" style="margin-top:8px;">Les √©l√©ments ajout√©s ici restent dans ¬´ '+key+' ¬ª.</p>'
    + '</div>'
  );
}

// ¬ß6.2 ‚Ä¢ Pose du tableau
function pageTabPose(key){
  const rangs=[1,2,3,4].map(r=>`<option value="${r}">${r} rang√©e(s)</option>`).join('');
  const modules=[13,18,24].map(m=>`<option value="${m}">${m} modules</option>`).join('');
  const poses=['Saillie','Encastr√©'].map(p=>`<option value="${p}">${p}</option>`).join('');
  const intervs=['Cr√©ation','Avec d√©pose de l‚Äôexistant'].map(i=>`<option value="${i}">${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Pose du tableau</h2>'
      + '<label>Nombre de rang√©es</label><select id="tab-rang">'+rangs+'</select>'
      + '<label>Modules</label><select id="tab-mod">'+modules+'</select>'
      + '<label>Pose</label><select id="tab-pose">'+poses+'</select>'
      + '<label>Intervention</label><select id="tab-inv">'+intervs+'</select>'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"addTabPose("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function addTabPose(key){
  const r=+document.getElementById("tab-rang").value;
  const m=+document.getElementById("tab-mod").value;
  const pos=document.getElementById("tab-pose").value;
  const itv=document.getElementById("tab-inv").value;
  const pu=(typeof getTabPrice==='function')?getTabPrice(r,m,pos,itv):0;

  ensureTableauKey(key);
  devis[key].items.push({
    category:"Tableau & distribution",
    intervention:itv, pose:pos,
    designation:`Pose tableau ‚Äî ${r} rang√©e(s), ${m} modules`,
    qty:1, prixU:pu, __tabKey:key
  });
  saveLocal(); pageTabHome(key);
}

// ¬ß6.3 ‚Ä¢ Interrupteurs diff√©rentiels
function pageTab_ID(key){
  const MODELS=[
    { id:"40A-A",  label:"ID 30mA - 40A - Type A"  },
    { id:"40A-AC", label:"ID 30mA - 40A - Type AC" },
    { id:"63A-A",  label:"ID 30mA - 63A - Type A"  },
    { id:"63A-AC", label:"ID 30mA - 63A - Type AC" }
  ];
  const opts=(n=20)=>Array.from({length:n+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  const price=id=>(TARIFS_TABLEAU && TARIFS_TABLEAU.inter_diff ? (TARIFS_TABLEAU.inter_diff[id]||0) : 0);

  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Interrupteurs diff√©rentiels</h2>'
      + '<div class="list">'
        + MODELS.map(m=>(
          `<label>${m.label} ‚Äî <span class="muted">${euro(price(m.id))}</span> `
          + `<select id="idq-${m.id.replace(/[^a-z0-9]/ig,'_')}">${opts(20)}</select></label>`
        )).join('')
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"submitTab_ID("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_ID(key){
  const pick=id=>+document.getElementById(id).value||0;
  const mk=id=>`idq-${id.replace(/[^a-z0-9]/ig,'_')}`;
  const lines=["40A-A","40A-AC","63A-A","63A-AC"].map(id=>({id,q:pick(mk(id))})).filter(x=>x.q>0);
  if(!lines.length){ pageTabHome(key); return; }

  ensureTableauKey(key);
  lines.forEach(x=>{
    const pu = (TARIFS_TABLEAU && TARIFS_TABLEAU.inter_diff ? (TARIFS_TABLEAU.inter_diff[x.id]||0) : 0);
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:`ID 30mA ‚Äî ${x.id.replace('-', ' - ')}`,
      qty:x.q, prixU:pu, __tabKey:key
    });
  });
  saveLocal(); pageTabHome(key);
}

// ¬ß6.3b ‚Ä¢ Coupure g√©n√©rale
function pageTab_Coupure(key){
  const MODELS=[ { id:"45A", label:"Coupure g√©n√©rale 45 A", pu:80 },
                 { id:"60A", label:"Coupure g√©n√©rale 60 A", pu:110 } ];
  const opts=(n=20)=>Array.from({length:n+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Coupure g√©n√©rale</h2>'
      + '<div class="list">'
        + MODELS.map(m=>(
          `<label>${m.label} ‚Äî <span class="muted">${euro(m.pu)}</span> `
          + `<select id="cgq-${m.id}">${opts(20)}</select></label>`
        )).join('')
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"submitTab_Coupure("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_Coupure(key){
  const pick=id=>+document.getElementById(id).value||0;
  const defs = [
    { id:"45A", label:"Coupure g√©n√©rale 45 A", pu:80 },
    { id:"60A", label:"Coupure g√©n√©rale 60 A", pu:110 }
  ].map(d=>({ ...d, q: pick("cgq-"+d.id) })).filter(d=>d.q>0);

  if(!defs.length){ pageTabHome(key); return; }
  ensureTableauKey(key);
  defs.forEach(d=>{
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:d.label,
      qty:d.q, prixU:d.pu, __tabKey:key
    });
  });
  saveLocal(); pageTabHome(key);
}

// ¬ß6.4 ‚Ä¢ Disjoncteurs modulaires
function pageTab_Disjoncteurs(key){
  const opts=(max=30)=>Array.from({length:max+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  const line = amp => (
    `<label>${amp} A <select id="djq-${amp}">${opts(30)}</select> `
    + `${b("D√©tail circuits","pageTab_DisjDetails("+JSON.stringify(key)+","+amp+")")}</label>`
  );
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Disjoncteurs modulaires</h2>'
      + '<div class="list">'
        + line(2) + line(10) + line(16) + line(20) + line(32) + line(40)
        + `<label>Calibre personnalis√©
             <input id="djq-custom-label" placeholder="ex: 50 A, 3x20A‚Ä¶">
             Qt√© <select id="djq-custom">${opts(30)}</select>
             ${b("D√©tail circuits","pageTab_DisjDetails("+JSON.stringify(key)+", '__custom__')")}
           </label>`
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"pageTab_DisjValider("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
  // restauration
  ["2","10","16","20","32","40"].forEach(r=>{
    const el=document.getElementById("djq-"+r);
    if(el && tabState.disj[+r]) el.value=tabState.disj[+r].qty||0;
  });
  if(document.getElementById("djq-custom")){
    document.getElementById("djq-custom").value = tabState.disj.__custom__.qty||0;
    document.getElementById("djq-custom-label").value = tabState.disj.__custom__.label||"";
  }
}
function pageTab_DisjDetails(key, rating){
  saveDisjQtyFromUI();
  const st=tabState.disj[rating] || {qty:0,details:[]};
  const qty=st.qty||0; if(!st.details) st.details=[];
  const row=(i,d)=>{
    const type=d?.type||'', note=d?.note||'';
    return `
      <div class="pill" style="width:100%;">
        <select data-idx="${i}" class="dj-type">
          <option value="">(non d√©fini)</option>
          <option value="Circuit prise" ${type==='Circuit prise'?'selected':''}>Circuit prise</option>
          <option value="Circuit √©clairage" ${type==='Circuit √©clairage'?'selected':''}>Circuit √©clairage</option>
          <optgroup label="Circuits sp√©cialis√©s">
            <option value="Four" ${type==='Four'?'selected':''}>Four</option>
            <option value="Plaque de cuisson" ${type==='Plaque de cuisson'?'selected':''}>Plaque de cuisson</option>
            <option value="Lave-linge" ${type==='Lave-linge'?'selected':''}>Lave-linge</option>
            <option value="Lave-vaisselle" ${type==='Lave-vaisselle'?'selected':''}>Lave-vaisselle</option>
            <option value="S√®che-linge" ${type==='S√®che-linge'?'selected':''}>S√®che-linge</option>
            <option value="Cumulus" ${type==='Cumulus'?'selected':''}>Cumulus</option>
            <option value="VMC" ${type==='VMC'?'selected':''}>VMC</option>
            <option value="Chauffage" ${type==='Chauffage'?'selected':''}>Chauffage</option>
            <option value="Climatisation" ${type==='Climatisation'?'selected':''}>Climatisation</option>
            <option value="Prise ext√©rieure √©tanche" ${type==='Prise ext√©rieure √©tanche'?'selected':''}>Prise ext√©rieure √©tanche</option>
            <option value="__custom__">Nom personnalis√©‚Ä¶</option>
          </optgroup>
        </select>
        <input data-idx="${i}" class="dj-note" placeholder="Caract√©ristique / nom (facultatif)" value="${(note||'').replace(/"/g,'&quot;')}" />
      </div>
    `;
  };
  let out=''; for(let i=0;i<qty;i++){ out+=row(i, st.details[i]||{}); }
  view(
    '<div class="card">'
      + b("Retour","pageTab_Disjoncteurs("+JSON.stringify(key)+")","btn back")
      + '<h2>D√©tail circuits ‚Äî '+(rating==='__custom__'?(tabState.disj.__custom__.label||'Calibre personnalis√©'):(rating+' A'))+'</h2>'
      + '<div id="dj-detail-container">'+out+'</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Enregistrer","pageTab_DisjSaveDetails("+JSON.stringify(key)+","+JSON.stringify(rating)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function pageTab_DisjSaveDetails(key, rating){
  const types=[...document.querySelectorAll('.dj-type')];
  const notes=[...document.querySelectorAll('.dj-note')];
  const details=[];
  for(let i=0;i<types.length;i++){
    let t=types[i]?.value||''; if(t==="__custom__"){ t=prompt("Nom personnalis√© du circuit :","")||("Circuit "+(i+1)); }
    const n=notes[i]?.value||''; details.push({type:t,note:n});
  }
  if(!tabState.disj[rating]) tabState.disj[rating]={qty:0,details:[]};
  tabState.disj[rating].details=details;
  saveLocal(); pageTab_Disjoncteurs(key);
}
function pageTab_DisjValider(key){
  saveDisjQtyFromUI();
  const PU=Object.assign({}, (TARIFS_TABLEAU && TARIFS_TABLEAU.disjoncteurs)?TARIFS_TABLEAU.disjoncteurs:{}, {40:45});
  ensureTableauKey(key);

  [2,10,16,20,32,40].forEach(r=>{
    const st=tabState.disj[r];
    if(st && st.qty>0){
      const hasDetail=Array.isArray(st.details)&&st.details.some(d=>d&&(d.type||d.note));
      const detailText=hasDetail?' ‚Äî circuits : '+st.details.map((d,i)=>(d.type||('Circuit '+(i+1)))+(d.note?(' ('+d.note+')'):'')).join(', '):'';
      devis[key].items.push({
        category:"Tableau/Modulaire",
        designation:`Disjoncteur ${r} A${detailText}`,
        qty:st.qty, prixU:PU[r]||0, __tabKey:key
      });
    }
  });

  const c=tabState.disj.__custom__;
  if(c && c.qty>0){
    const label=(c.label||"Calibre personnalis√©").trim();
    const hasDetail=Array.isArray(c.details)&&c.details.some(d=>d&&(d.type||d.note));
    const detailText=hasDetail?' ‚Äî circuits : '+c.details.map((d,i)=>(d.type||('Circuit '+(i+1)))+(d.note?(' ('+d.note+')'):'')).join(', '):'';
    const pu=parseFloat(prompt("Prix unitaire pour ¬´ "+label+" ¬ª (‚Ç¨) :","0")||"0")||0;
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:`Disjoncteur ${label}${detailText}`,
      qty:c.qty, prixU:pu, __tabKey:key
    });
  }
  saveLocal(); pageTabHome(key);
}

// ¬ß6.5 ‚Ä¢ Commandes & pilotage
function pageTabMod_Commandes(key){
  const PC=(TARIFS_TABLEAU && TARIFS_TABLEAU.commandes)?TARIFS_TABLEAU.commandes:{};
  const opts=Object.keys(PC).map(k=>`<option value="${k}">${k} (${euro(PC[k]||0)})</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Commande & pilotage</h2>'
      + '<label>Mod√®le</label><select id="cmd-model">'+opts+'</select>'
      + '<label>Quantit√©</label><input id="cmd-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"submitTabMod_Commandes("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Commandes(key){
  const model=document.getElementById("cmd-model").value;
  const qty=Math.max(1, parseInt(document.getElementById("cmd-qty").value,10)||1);
  const pu=(TARIFS_TABLEAU && TARIFS_TABLEAU.commandes)?(TARIFS_TABLEAU.commandes[model]||0):0;
  ensureTableauKey(key);
  devis[key].items.push({ category:"Tableau/Commandes", designation:model, qty, prixU:pu, __tabKey:key });
  saveLocal(); pageTabHome(key);
}

// ¬ß6.6 ‚Ä¢ Sp√©cifique (libre + prix)
function pageTabMod_Specifique(key){
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>√âl√©ment sp√©cifique</h2>'
      + '<label>Intitul√©</label><input id="spec-label" />'
      + '<label>Prix unitaire (‚Ç¨)</label><input id="spec-price" type="number" inputmode="decimal" />'
      + '<label>Quantit√©</label><input id="spec-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"submitTabMod_Specifique("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Specifique(key){
  const label=(document.getElementById("spec-label").value||"").trim();
  const prix=parseFloat(document.getElementById("spec-price").value)||0;
  const qty=Math.max(1,parseInt(document.getElementById("spec-qty").value,10)||1);
  if(!label){ pageTabHome(key); return; }
  ensureTableauKey(key);
  devis[key].items.push({ category:"Tableau/Sp√©cifique", designation:label, qty, prixU:prix, __tabKey:key });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- =======================================================================
     CHAPITRE 6.2 : VENTILATION ‚Äî corrig√© (sans rtConduitMut)
     ======================================================================= -->
<script>
var ventState = {}; 

function ensureVentKey(key){
  if(!devis[key]) devis[key] = { __base:"VMC", __customName:"", items:[], note:"" };
  if(!ventState[key]) ventState[key] = {
    creation: {
      kit: { ref:"", d80:1, d125:1, conduits:[{type:"Gaine isol√©e"}], percements:[{support:"Placo", qty:0}] },
      extracteur: { ref:"", diam:"100", conduits:[{type:"Gaine isol√©e"}], percements:[{support:"Placo", qty:0}] },
      ventilateur: { ref:"", diam:"100", typeConduit:"Gaine isol√©e", longueur:0, percements:[{support:"Placo", qty:0}] }
    },
    retirage: { n80:0, n125:0 },
    entretien: { type:"Groupe VMC", nb:0 }
  };
}
function pickVal(id, def){ var el=document.getElementById(id); return (el?el.value:def); }
function pickNum(id, def){ var el=document.getElementById(id); var v=parseFloat(el?el.value:NaN); return isNaN(v)?(def||0):v; }

/* === Accueil Ventilation === */
function pageVentAccueil(){
  if(typeof devis.__ventCounter!=="number") devis.__ventCounter = 0;
  var keys = Object.keys(devis).filter(k=>{
    if(k.indexOf('__')===0) return false;
    var s = devis[k]||{};
    return (s.__base||"").toLowerCase()==="vmc";
  });

  var list = keys.length ? keys.map(function(k){
    var s=devis[k]||{};
    var titre = k + (s.__customName?(" ‚Äî "+s.__customName):"");
    var nb = (s.items||[]).length;
    return '<div class="pill">'
          +'<strong>'+titre+'</strong> <small>'+nb+' ligne(s)</small>'
          + b('Ouvrir','pageVentHome('+JSON.stringify(k)+')','btn')
          + b('Supprimer','ventDelete('+JSON.stringify(k)+')','btn')
          +'</div>';
  }).join('') : '<p class="muted">Aucune ventilation pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Ventilation</h2>'
      + b('‚ûï Ajouter une ventilation','pageVentNew()','btn primary')
    + '</div>'
    + '<div class="card" style="margin-top:12px;">'
      + '<h2>Liste</h2>'
      + list
    + '</div>'
  );
}
function pageVentNew(){
  devis.__ventCounter++;
  var key = 'Ventilation '+devis.__ventCounter;
  ensureVentKey(key); saveLocal();
  view(
    '<div class="card">'
      + b('Retour','pageVentAccueil()','btn back')
      + '<h2>Nouvelle ventilation</h2>'
      + '<p><strong>'+key+'</strong></p>'
      + '<label>Nom personnalis√©</label>'
      + '<input id="vent-name" />'
      + b('Valider','saveVentName('+JSON.stringify(key)+')','btn primary')
    + '</div>'
  );
}
function saveVentName(key){
  var name = (document.getElementById('vent-name').value||'').trim();
  if(devis[key]) devis[key].__customName = name;
  saveLocal(); pageVentHome(key);
}
function ventDelete(key){
  if(!confirm('Supprimer ¬´ '+key+' ¬ª ?')) return;
  delete devis[key]; saveLocal(); pageVentAccueil();
}
function pageVentHome(key){
  ensureVentKey(key);
  var custom = devis[key].__customName ? ' ‚Äî '+devis[key].__customName : '';
  view(
    '<div class="card">'
      + b('Retour','pageVentAccueil()','btn back')
      + '<h2>'+key+custom+'</h2>'
      + b('1 ¬∑ Cr√©ation','pageVentCreation('+JSON.stringify(key)+')','btn primary')
      + b('2 ¬∑ Retirage des conduits','pageVentRetirage('+JSON.stringify(key)+')','btn')
      + b('3 ¬∑ Entretien','pageVentEntretien('+JSON.stringify(key)+')','btn')
    + '</div>'
  );
}

/* === Cr√©ation (kit / extracteur / ventilateur) === */
function pageVentCreation(key){
  ensureVentKey(key);
  var st = ventState[key].creation;

  function conduitsBlock(arr, mutFn, prefix){
    return arr.map(function(c,i){
      var sel = ['Gaine isol√©e','Conduit rigide','Conduit rigide extra-plat','Gaine non isol√©e']
        .map(t=>'<option '+(t===c.type?'selected':'')+'>'+t+'</option>').join('');
      return '<div class="row">'
        + '<select id="'+prefix+'-type-'+i+'">'+sel+'</select>'
        + (i>0? b('√ó',mutFn+'('+JSON.stringify(key)+',"del",'+i+')','btn'):"")
        + '</div>';
    }).join('') + b('Ajouter conduit',mutFn+'('+JSON.stringify(key)+',"add")','btn');
  }
  function percementsBlock(arr, mutFn, prefix){
    var supports=['Placo','Briquette','Ourdi b√©ton'];
    return arr.map(function(p,i){
      var opts=supports.map(s=>'<option '+(s===p.support?'selected':'')+'>'+s+'</option>').join('');
      return '<div class="row">'
        + '<select id="'+prefix+'-sup-'+i+'">'+opts+'</select>'
        + '<input id="'+prefix+'-qty-'+i+'" type="number" value="'+(p.qty||0)+'"/>'
        + (i>0? b('√ó',mutFn+'('+JSON.stringify(key)+',"del",'+i+')','btn'):"")
        + '</div>';
    }).join('') + b('Ajouter percement',mutFn+'('+JSON.stringify(key)+',"add")','btn');
  }

  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Cr√©ation</h2>'
      + '<h3>Kit VMC</h3>'
      + '<input id="kit-ref" placeholder="R√©f." value="'+st.kit.ref+'"/>'
      + '<input id="kit-d80" type="number" value="'+st.kit.d80+'"/> D80'
      + '<input id="kit-d125" type="number" value="'+st.kit.d125+'"/> D125'
      + conduitsBlock(st.kit.conduits,"kitConduitMut","kitc")
      + percementsBlock(st.kit.percements,"kitPercMut","kitp")
      + b('Ajouter Kit VMC','ventAddKit('+JSON.stringify(key)+')','btn primary')
      + '<h3>Extracteur</h3>'
      + '<input id="ex-ref" placeholder="R√©f." value="'+st.extracteur.ref+'"/>'
      + '<select id="ex-diam">'+['80','100','125'].map(d=>'<option '+(d===st.extracteur.diam?'selected':'')+'>'+d+'</option>').join('')+'</select>'
      + conduitsBlock(st.extracteur.conduits,"exConduitMut","exc")
      + percementsBlock(st.extracteur.percements,"exPercMut","exp")
      + b('Ajouter Extracteur','ventAddExtracteur('+JSON.stringify(key)+')','btn primary')
      + '<h3>Ventilateur de conduit</h3>'
      + '<input id="vc-ref" placeholder="R√©f." value="'+st.ventilateur.ref+'"/>'
      + '<select id="vc-diam">'+['80','100','125','150'].map(d=>'<option '+(d===st.ventilateur.diam?'selected':'')+'>'+d+'</option>').join('')+'</select>'
      + '<select id="vc-type">'+['Gaine isol√©e','Conduit rigide','Conduit rigide extra-plat','Gaine non isol√©e'].map(t=>'<option '+(t===st.ventilateur.typeConduit?'selected':'')+'>'+t+'</option>').join('')+'</select>'
      + '<input id="vc-len" type="number" value="'+st.ventilateur.longueur+'"/> m'
      + percementsBlock(st.ventilateur.percements,"vcPercMut","vcp")
      + b('Ajouter Ventilateur','ventAddVentilateur('+JSON.stringify(key)+')','btn primary')
    + '</div>'
  );
}
function kitConduitMut(key,cmd,idx){ var arr=ventState[key].creation.kit.conduits; if(cmd==="add") arr.push({type:"Gaine isol√©e"}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key);}
function kitPercMut(key,cmd,idx){ var arr=ventState[key].creation.kit.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key);}
function exConduitMut(key,cmd,idx){ var arr=ventState[key].creation.extracteur.conduits; if(cmd==="add") arr.push({type:"Gaine isol√©e"}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key);}
function exPercMut(key,cmd,idx){ var arr=ventState[key].creation.extracteur.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key);}
function vcPercMut(key,cmd,idx){ var arr=ventState[key].creation.ventilateur.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key);}
function ventAddKit(key){ devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Kit VMC',qty:1,prixU:0,__tabKey:key}); saveLocal(); pageVentHome(key);}
function ventAddExtracteur(key){ devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Extracteur',qty:1,prixU:0,__tabKey:key}); saveLocal(); pageVentHome(key);}
function ventAddVentilateur(key){ devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Ventilateur conduit',qty:1,prixU:0,__tabKey:key}); saveLocal(); pageVentHome(key);}

/* === Retirage === */
function pageVentRetirage(key){
  ensureVentKey(key); var st=ventState[key].retirage;
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Retirage</h2>'
      + '<input id="rt-80" type="number" value="'+st.n80+'"/> √ò80'
      + '<input id="rt-125" type="number" value="'+st.n125+'"/> √ò125'
      + b('Ajouter Retirage','ventAddRetirage('+JSON.stringify(key)+')','btn primary')
    + '</div>'
  );
}
function ventAddRetirage(key){
  var n80=pickNum('rt-80',0), n125=pickNum('rt-125',0);
  devis[key].items.push({category:'Ventilation/Retirage',designation:'Retirage √ò80='+n80+' √ò125='+n125,qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}

/* === Entretien === */
function pageVentEntretien(key){
  ensureVentKey(key); var st=ventState[key].entretien;
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Entretien</h2>'
      + '<select id="ent-type">'+['Groupe VMC','Extracteur','Ventilateur de conduit'].map(t=>'<option '+(t===st.type?'selected':'')+'>'+t+'</option>').join('')+'</select>'
      + '<input id="ent-nb" type="number" value="'+st.nb+'"/>'
      + b('Ajouter Entretien','ventAddEntretien('+JSON.stringify(key)+')','btn primary')
    + '</div>'
  );
}
function ventAddEntretien(key){
  var type=pickVal('ent-type','Groupe VMC'), nb=pickNum('ent-nb',0);
  devis[key].items.push({category:'Ventilation/Entretien',designation:'Entretien '+type+' ‚Äî nb='+nb,qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}
</script>
  <!-- ============================================================
     CHAPITRE 7 : ESTIMATIF & EXPORTS ‚Äî vNEXT
     Index :
       ¬ß7.0 ‚Ä¢ D√©tection / libell√© des pi√®ces (Tableaux inclus)
       ¬ß7.1 ‚Ä¢ Tri d√©di√© aux Tableaux (diff ‚Üí coupure ‚Üí disjoncteurs ‚Üí reste)
       ¬ß7.2 ‚Ä¢ Pages : Estimatif d√©taill√© & Totaux par groupe
       ¬ß7.3 ‚Ä¢ Exports : .txt par groupe / .zip par groupe
       ¬ß7.4 ‚Ä¢ Exports : complet .txt / complet .zip
     ============================================================ -->
<script>
// ¬ß7.0 ‚Ä¢ D√©tection & libell√©s
window.PIECE_GROUPS = window.PIECE_GROUPS || {
  "Buanderie":"Pi√®ces techniques","Garage":"Pi√®ces techniques","Atelier":"Pi√®ces techniques",
  "Jardin":"Ext√©rieur","Terrasse":"Ext√©rieur","Balcon":"Ext√©rieur","Abri de jardin":"Ext√©rieur",
  "Cuisine":"Cuisine",
  "Salon":"Pi√®ces de vie","Salle √† manger":"Pi√®ces de vie","Couloir":"Pi√®ces de vie","Entr√©e":"Pi√®ces de vie",
  "Salle de bain":"Pi√®ces d'eau","Salle d'eau":"Pi√®ces d'eau","Toilettes":"Pi√®ces d'eau",
  "Chambre 1":"Chambres & Bureau","Chambre 2":"Chambres & Bureau","Chambre 3":"Chambres & Bureau",
  "Bureau":"Chambres & Bureau","Biblioth√®que":"Chambres & Bureau",
  "Tableau":"Tableau & distribution","Distribution":"Tableau & distribution",
  "Mise √† la terre":"Mise √† la terre","VMC":"VMC"
};
function groupDevis(){
  var g = {};
  for (var key in devis){
    if (key.indexOf("__") === 0) continue;
    var s = devis[key];
    var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
    var grp  = window.PIECE_GROUPS[base] || "Divers";
    if (!g[grp]) g[grp] = {};
    g[grp][key] = s;
  }
  return g;
}
function isTableauKey(key){
  var s = devis[key] || {};
  return ((s.__base||'').toLowerCase()==='tableau') || /^Tableau\s/i.test(key);
}
function pieceDisplayLabel(key){
  var s = devis[key] || {};
  var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
  var qual = s.qualificatif || '';
  var etg  = s.etage || '';
  var label = base===key ? key : (base + (qual ? ' ('+qual+')':'') + (etg ? ' ‚Äî '+etg:''));
  if(isTableauKey(key) && s.__customName && s.__customName.trim()){
    label = key + ' ‚Äî ' + s.__customName.trim();
  }else{
    if(!isTableauKey(key)){
      label = (typeof formatPieceLabel === 'function') ? formatPieceLabel(key) : key;
    }else{
      label = key;
    }
  }
  return label;
}

// ¬ß7.1 ‚Ä¢ Tri d√©di√© Tableaux
function sortedItemsForPiece(key, items){
  if(!Array.isArray(items)) return [];
  if(!isTableauKey(key)) return items.slice();

  function score(it){
    var d = (it && it.designation ? String(it.designation) : '').trim();
    if (/^ID\s/i.test(d))             return 0;
    if (/^Coupure g√©n√©rale/i.test(d)) return 1;
    if (/^Disjoncteur\s/i.test(d))    return 2;
    return 3;
  }
  return items.map(function(it, i){ return {it:it, i:i, s:score(it)}; })
              .sort(function(a,b){ return (a.s - b.s) || (a.i - b.i); })
              .map(function(x){ return x.it; });
}

// ¬ß7.2 ‚Ä¢ Pages : Estimatif + Totaux
function itemLine(it){
  var unit = it.unit || "u";
  var poseTxt = (it.intervention === "Cr√©ation" && it.pose) ? (" - " + String(it.pose).toLowerCase()) : "";
  var left = it.intervention ? (it.intervention + " ‚Äî ") : "";
  var pu = (+it.prixU || 0).toFixed(2);
  var q  = +it.qty || 0;
  var total = (q * (+it.prixU || 0)).toFixed(2);
  return "- " + left + it.designation + poseTxt + " | Qt√©: " + q + " " + unit + " | PU: " + pu + "‚Ç¨ | Total: " + total + "‚Ç¨";
}
function pieceSeparator(label){ return "\n---------------- " + label + " ----------------\n"; }

function pageEstimatif(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Estimatif d√©taill√©</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    html += '<h2 style="border-top:2px solid #000; padding-top:8px;">'+grp+'</h2>';
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var pieceLabel = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var sectionTotal = 0;

      html += '<h3 style="margin-top:6px; border-top:1px solid #ccc; padding-top:4px;">'+pieceLabel+'</h3><ul>';
      items.forEach(function(it){
        var q  = +it.qty || 0;
        var pu = +it.prixU || 0;
        var t  = q * pu;
        sectionTotal += t; groupTotal += t; totalGlobal += t;

        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? (" " + String(it.pose).toLowerCase()) : "";
        var unit    = it.unit || "u";
        var left    = it.intervention ? (it.intervention+" ‚Äî ") : "";
        html += '<li>' + left + it.designation + poseTxt + ' ('+q+' '+unit+' √ó '+euro(pu)+' = '+euro(t)+')</li>';
      });
      if (s.note) html += '<li><em>Note : '+s.note+'</em></li>';

      html += '</ul><p><strong>Total '+pieceLabel+' : '+euro(sectionTotal)+'</strong></p>';
    }

    html += '<p><strong>Total '+grp+' : '+euro(groupTotal)+'</strong></p><hr>';
  }

  html += '<h3>Total global : '+euro(totalGlobal)+'</h3>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

function pageTotaux(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Totaux par groupe</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    var gt = 0;
    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;
      var items = sortedItemsForPiece(key, s.items);
      var st = items.reduce(function(sum,it){ return sum + (((+it.prixU)||0)*((+it.qty)||0)); }, 0);
      gt += st; totalGlobal += st;
    }
    html += '<p><strong>'+grp+'</strong> : '+euro(gt)+'</p>';
  }

  html += '<hr><p><strong>Total global : '+euro(totalGlobal)+'</strong></p>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

// ¬ß7.3 ‚Ä¢ Exports : TXT/ZIP par groupe
function exportText(){
  var grouped = groupDevis();
  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');

    var blob = new Blob([lines.join('\r\n')], {type:'text/plain;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = 'devis_'+grp+'.txt'; a.click();
    URL.revokeObjectURL(url);
  }
  alert('‚úÖ Export termin√© : un fichier .txt par groupe g√©n√©r√©.');
}

async function exportZipGroups(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var grouped = groupDevis();
  var zip = new JSZip();
  var global = 0;

  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');
    global += groupTotal;

    zip.file('devis_'+grp+'.txt', lines.join('\r\n'));
  }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var readme = 'R√©capitulatif ‚Äî '+name+'\nDate: '+new Date().toLocaleString()
             + '\n\nTotal global: '+global.toFixed(2)+'‚Ç¨\n';
  zip.file('README.txt', readme);

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_groupes.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export ZIP (par groupe) g√©n√©r√©.');
}

// ¬ß7.4 ‚Ä¢ Exports : COMPLET (.txt/.zip)
function buildFullText(){
  var grouped = groupDevis();
  var lines = ['=== DEVIS COMPLET ===\n'];
  var globalTotal = 0;

  for (var grp in grouped){
    lines.push('\n## '+grp+' ##\n');
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t; globalTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨\n');
  }

  lines.push('\n=== Total global : '+globalTotal.toFixed(2)+'‚Ç¨ ===\n');
  return lines.join('\r\n');
}
function exportTextFull(){
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildFullText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export .txt complet g√©n√©r√©.');
}
async function exportZipFull(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var zip  = new JSZip();
  zip.file(name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt', buildFullText());
  zip.file('README.txt', 'Devis complet\nNom: '+name+'\nDate: '+new Date().toLocaleString()+'\n');

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export .zip complet g√©n√©r√©.');
}
</script>

<!-- =============================
     CHAPITRE 8 : D√âMARRAGE & EXPOSE
     Index :
       ¬ß0  ‚Ä¢ init() : chargement local + pageMain()
       ¬ß1  ‚Ä¢ Expose : fonctions rendues accessibles (UI)
     ============================= -->
<script>
/* ======================
   ¬ß0 ‚Ä¢ D√âMARRAGE (init)
   ====================== */
function init(){
  try{
    loadLocal();
    pageMain();
  }catch(err){
    var el = document.getElementById('app');
    if(el){
      el.innerHTML =
        '<div class="card"><h2>Erreur init()</h2><pre>'
        + ((err && err.stack) || String(err))
        + '</pre></div>';
    }
  }
}

/* ======================
   ¬ß1 ‚Ä¢ EXPOSE (window)
   ====================== */
Object.assign(window, {
  // Chap.4 ‚Äî Menu & sauvegarde
  pageMain,
  actionNouveauDevis,
  pageSavedDevis,
  loadDevis,
  deleteDevis,
  saveCurrentDevis,

  // Chap.5 ‚Äî Pi√®ces (flux one-page) + raccourci Ventilation
  pageHome,
  pageAddPiece,
  confirmPieceChoice,
  removePiece,
  goPiece,
  delLine,
  editPieceNote,
  pageSpecifiqueForm,
  saveSpecifique,
  pagePieceSpecifique: pageSpecifiqueForm,
  goCategory,
  goEclairageSub,
  setEclairageBranch,
  goIntervention,
  pageOneShotSelection,
  saveOneShotItem,
  goVent, // bouton "Ventilation" depuis l'accueil

  // Chap.6 ‚Äî Tableaux (multi-tableaux)
  pageTabCreate,
  saveTabCustomName,
  pageTabHome,
  pageTabPose,
  addTabPose,
  pageTab_ID,
  submitTab_ID,
  pageTab_Coupure,
  submitTab_Coupure,
  pageTab_Disjoncteurs,
  pageTab_DisjDetails,
  pageTab_DisjSaveDetails,
  pageTab_DisjValider,
  pageTabMod_Commandes,
  submitTabMod_Commandes,
  pageTabMod_Specifique,
  submitTabMod_Specifique,

  // Chap.6.2 ‚Äî Ventilation (corrig√©, sans rtConduitMut)
  pageVentAccueil,
  pageVentNew,
  saveVentName,
  ventDelete,
  pageVentHome,
  pageVentCreation,
  kitConduitMut,
  kitPercMut,
  exConduitMut,
  exPercMut,
  vcPercMut,
  ventAddKit,
  ventAddExtracteur,
  ventAddVentilateur,
  pageVentRetirage,
  ventAddRetirage,
  pageVentEntretien,
  ventAddEntretien,

  // Chap.7 ‚Äî Estimatif & exports
  pageEstimatif,
  pageTotaux,
  exportText,
  exportZipGroups,
  exportTextFull,
  exportZipFull,

  // Commun
  confirmBackHome
});

// Lancement
init();
</script>
