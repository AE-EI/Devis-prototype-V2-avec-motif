<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis ‚Äî V3.0 (rebuild chap.1)</title>

  <!-- Styles de base -->
  <style>
    :root {
      --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666;
      --line:#e8e8e8; --primary:#111;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#444; background:#fafafa; }
  </style>

  <!-- JSZip (exports ZIP) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- Cache-busting doux : ajoute ?v=timestamp si absent -->
  <script>
  (function(){
    try{
      var u = new URL(location.href);
      if(!u.searchParams.has('v')){
        u.searchParams.set('v', Date.now());
        location.replace(u.toString());
      }
    }catch(e){}
  })();
  </script>
</head>
<body>
  <header>MiniDevis ‚Äî V3.0</header>
  <main id="app"></main>

  <!-- Sentinelle ultra-t√¥t : prouve que HTML + ce script sont charg√©s -->
  <script>
  (function(){
    var app = document.getElementById('app');
    if(app){ app.innerHTML =
      '<div class="card">Loader OK ‚Äî en attente des chapitres JS‚Ä¶</div>';
    }
  })();
  </script>

<!-- =============================
     CHAPITRE 2 : √âTAT & HELPERS
     ============================= -->
<script>
// --- Debug global : affiche toute erreur JS dans #app
window.addEventListener('error', function (e) {
  var el = document.getElementById('app');
  if (el) {
    el.innerHTML =
      '<div class="card"><h2>Erreur JS</h2><pre>'
      + (e.message || 'Erreur inconnue')
      + '\n' + (e.filename || '') + ':' + (e.lineno || 0) + ':' + (e.colno || 0)
      + '</pre></div>';
  }
});

// --- √âtat global
var devis = {}; // contiendra aussi __id, __name
var ctx   = { piece:null, category:null, intervention:null, pose:null, designation:null };

// --- Identifiants
function genId(){ return 'dv_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
function ensureId(){ if(!devis.__id) devis.__id = genId(); }

// --- DOM & helpers UI
function $app(){ return document.getElementById('app'); }
/** Cr√©e un bouton (fn = string "goPiece('Salon')") */
function b(label, fn, cls){ cls = cls || 'btn'; return '<button class="'+cls+'" onclick="'+fn+'">'+label+'</button>'; }
/** Format ‚Ç¨ */
function euro(n){ return (+(n||0)).toFixed(2) + ' ‚Ç¨'; }

/** Rendu principal avec footer Sauvegarde/Accueil (d√©sactivable par noFooter=true) */
function view(html, noFooter){
  if(!noFooter){
    html += '<div class="row" style="margin-top:16px; gap:12px;">'
          + b('‚¨ÖÔ∏è Accueil','confirmBackHome()','btn back')
          + b('üíæ Sauvegarder devis','saveCurrentDevis()','btn primary')
          + '</div>';
  }
  $app().innerHTML = html;
}

/** Confirmation retour accueil si donn√©es non vides */
function confirmBackHome(){
  var hasData = Object.keys(devis)
    .filter(function(k){ return k.indexOf('__') !== 0; })
    .some(function(k){
      var s = devis[k]||{};
      return (s.items && s.items.length>0) || (s.note && s.note.trim().length>0);
    });

  if(!hasData || confirm('Revenir au menu principal ?\n‚ö†Ô∏è Les modifications non sauvegard√©es seront perdues.')){
    if (typeof pageMain === 'function') pageMain();
    else $app().innerHTML = '<div class="card"><h2>Accueil</h2><p class="muted">Le chapitre Menu (4) n\'est pas encore charg√©.</p></div>';
  }
}

// --- Libell√©s des pi√®ces (base + qualificatif + √©tage)
function buildPieceLabel(base, qualif, etage){
  var lbl = base || '';
  if(qualif && qualif.trim()) lbl += ' ('+qualif.trim()+')';
  if(etage && etage.trim())   lbl += ' ‚Äî '+etage.trim();
  return lbl;
}
/** Cherche une cl√© libre si le libell√© existe d√©j√† (Salon, Salon (2), Salon (3), ‚Ä¶) */
function nextFreeKey(label){
  if(!devis[label]) return label;
  var n=2; while(devis[label+' ('+n+')']) n++;
  return label+' ('+n+')';
}
/** Cr√©e (ou r√©cup√®re) une section pi√®ce, avec m√©ta conserv√©es */
function createOrGetPiece(base, qualif, etage){
  var wanted = buildPieceLabel(base,qualif,etage);
  var key    = nextFreeKey(wanted);
  if(!devis[key]) devis[key] = { __base:base, qualificatif:qualif||'', etage:etage||'', items:[], note:'' };
  saveLocal();
  return key;
}
/** Affiche le libell√© complet d‚Äôune cl√© pi√®ce */
function formatPieceLabel(key){
  var s = devis[key]; if(!s) return key;
  var base = s.__base || key;
  return buildPieceLabel(base, s.qualificatif, s.etage);
}

// --- Persistance locale
function ensureSection(key){
  if(!devis[key]) devis[key] = { items:[], note:'', qualificatif:'', etage:'' };
}
function saveLocal(){
  try { localStorage.setItem('devis', JSON.stringify(devis)); } catch(e){}
}
function loadLocal(){
  try { devis = JSON.parse(localStorage.getItem('devis') || '{}') || {}; }
  catch(e){ devis = {}; }
  ensureId();
}
</script>
  <!-- =============================
     CHAPITRE 3 : CONSTANTES
     ============================= -->
<script>
// Pi√®ces pr√©d√©finies
var PIECES_PREDEFINIES = [
  'Salon','Cuisine','Salle √† manger','Salle de bain','Salle d\'eau',
  'Chambre 1','Chambre 2','Chambre 3','Toilettes','Bureau',
  'Buanderie','Garage','Couloir','Terrasse','Balcon','Jardin',
  'D√©barras','Ext√©rieur','Grenier/Combles','Atelier',
  'Abri de jardin','Entr√©e','Biblioth√®que'
];

// Cat√©gories standards
var CATEGORIES = [
  'Prises','√âclairage','Circuit sp√©cialis√©','Sp√©cifique'
];

// Modes de pose
var POSES = [
  'Encastr√© ma√ßonnerie','Placo','Semi-encastr√©',
  'Sur-mesure','Saillie avec moulure','Sous tube IRL'
];

// D√©signations possibles par cat√©gorie
var DESIGNATIONS_PAR_CATEGORIE = {
  'Prises': ['Prise'],
  '√âclairage/Luminaires': ['Point de centre','Applique'],
  '√âclairage/Commandes': ['Interrupteur simple','Interrupteur double'],
  'Circuit sp√©cialis√©': [
    'Four','Plaque de cuisson','Lave-linge','Lave-vaisselle',
    'S√®che-linge','Cumulus','VMC','Chauffage','Climatisation',
    'Prise ext√©rieure √©tanche','Autre circuit sp√©cialis√©'
  ]
};

// Tarifs de base (selon type d‚Äôintervention)
var TARIFS = {
  'Prise': { creation:120, recablage_sans:50, recablage_avec:70, remplacement:20 },
  'Point de centre': { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  'Applique': { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  'Interrupteur simple': { creation:40, recablage_sans:50, recablage_avec:75, remplacement:25 },
  'Interrupteur double': { creation:60, recablage_sans:50, recablage_avec:85, remplacement:35 },
  'Four': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Plaque de cuisson': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Lave-linge': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Lave-vaisselle': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'S√®che-linge': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Cumulus': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'VMC': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Chauffage': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Climatisation': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Prise ext√©rieure √©tanche': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 },
  'Autre circuit sp√©cialis√©': { creation:140, recablage_sans:70, recablage_avec:90, remplacement:40 }
};

// √âtages pr√©d√©finis
var ETAGES = [
  'Rez-de-chauss√©e','1er √©tage','2e √©tage',
  'Sous-sol','Combles','Annexe'
];
</script>
  <!-- =============================
     CHAPITRE 4 : MENU PRINCIPAL
     ============================= -->
<script>
function pageMain(){
  view(
    '<div class="card">'
      +'<h2>Menu principal</h2>'
      +'<div class="row">'
        +b('‚ûï Nouveau devis','actionNouveauDevis()','btn primary')
        +b('üìÇ Mes devis sauvegard√©s','pageSavedDevis()','btn')
      +'</div>'
    +'</div>'
  , true);
}

// Cr√©er un nouveau devis vide
function actionNouveauDevis(){
  devis = { __id: genId(), __name: '' };
  saveLocal();
  pageHome();
}

// Liste des devis sauvegard√©s
function pageSavedDevis(){
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  if(!saved.length){
    return view(
      '<div class="card">'
        +b('Retour','pageMain()','btn back')
        +'<h2>Mes devis sauvegard√©s</h2>'
        +'<p class="muted">Aucun devis sauvegard√©.</p>'
      +'</div>', true
    );
  }

  var list = saved.map(function(d,i){
    return '<div class="pill">'
      +'<strong>'+d.name+'</strong> <small>'+d.date+'</small>'
      +b('Ouvrir','loadDevis('+i+')','btn')
      +b('Supprimer','deleteDevis('+i+')','btn')
      +'</div>';
  }).join('');

  view(
    '<div class="card">'
      +b('Retour','pageMain()','btn back')
      +'<h2>Mes devis sauvegard√©s</h2>'
      +'<div class="list">'+list+'</div>'
    +'</div>', true
  );
}

// Charger un devis sauvegard√©
function loadDevis(idx){
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  if(!saved[idx]) return pageSavedDevis();
  devis = saved[idx].data || {};
  ensureId();
  saveLocal();
  pageHome();
}

// Supprimer un devis sauvegard√©
function deleteDevis(idx){
  if(!confirm('Supprimer ce devis sauvegard√© ?')) return;
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  saved.splice(idx,1);
  localStorage.setItem('savedDevisList', JSON.stringify(saved));
  pageSavedDevis();
}

// Sauvegarder l‚Äô√©tat actuel du devis
function saveCurrentDevis(){
  ensureId();
  var saved = JSON.parse(localStorage.getItem('savedDevisList')||'[]');
  var i = saved.findIndex(function(d){ return d.data && d.data.__id === devis.__id; });

  if(i >= 0){
    // Mise √† jour d‚Äôun devis existant
    var name = devis.__name || saved[i].name || ('Devis '+new Date().toLocaleDateString());
    devis.__name = name;
    saved[i] = { name:name, date:new Date().toLocaleDateString(), data:devis };
    localStorage.setItem('savedDevisList', JSON.stringify(saved));
    alert('Devis mis √† jour.');
    return;
  }

  // Nouveau devis
  var name2 = (devis.__name||'').trim();
  if(!name2){
    name2 = (prompt('Nom du devis :','')||'').trim();
    if(!name2){ alert('Sauvegarde annul√©e.'); return; }
  }
  var j = saved.findIndex(function(d){ return (d.name||'').toLowerCase() === name2.toLowerCase(); });
  devis.__name = name2;

  if(j >= 0){
    if(!confirm('Un devis ¬´ '+name2+' ¬ª existe d√©j√†. L\'√©craser ?')) return;
    saved[j] = { name:name2, date:new Date().toLocaleDateString(), data:devis };
  } else {
    saved.push({ name:name2, date:new Date().toLocaleDateString(), data:devis });
  }

  localStorage.setItem('savedDevisList', JSON.stringify(saved));
  alert('Devis sauvegard√© !');
}
</script>
<!-- =============================
     CHAPITRE 5 : ACCUEIL & FLUX PI√àCES
     ============================= -->
<script>
// ---- Accueil
function pageHome(){
  var keys = Object.keys(devis).filter(function(k){ return k.indexOf('__')!==0; });
  var listHtml = keys.length ? keys.map(function(key){
    var s = devis[key] || {};
    var badges = [
      (s.qualificatif && s.qualificatif.trim()) ? '<span class="badge">'+s.qualificatif+'</span>' : '',
      (s.etage && s.etage.trim()) ? '<span class="badge">'+s.etage+'</span>' : ''
    ].filter(Boolean).join(' ');
    return '<div class="pill">'
      +'<strong>'+formatPieceLabel(key)+'</strong> '
      +'<small>'+((s.items||[]).length)+' ligne(s)</small> '
      +badges
      +b('Ouvrir','goPiece('+JSON.stringify(key)+')','btn')
      +b('Supprimer','removePiece('+JSON.stringify(key)+')','btn')
    +'</div>';
  }).join('') : '<p class="muted">Aucune pi√®ce ajout√©e pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      +'<h2>Accueil</h2>'
      +'<div class="row">'
        +b('Ajouter une pi√®ce','pageAddPiece()','btn primary')
        +b('Installations sp√©cifiques','pageISHome()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Pi√®ces ajout√©es</h2>'
      +'<div class="list">'+listHtml+'</div>'
    +'</div>'
    +'<div class="row" style="margin-top:12px;">'
      +b('Voir l‚Äôestimatif','pageEstimatif()','btn')
      +b('Voir les totaux','pageTotaux()','btn')
    +'</div>'
  );
}

// ---- Ajouter une pi√®ce
function pageAddPiece(){
  var opts = PIECES_PREDEFINIES.map(function(p){ return '<option value="'+p+'">'+p+'</option>'; }).join('')
           + '<option value="__NEW__">‚ûï Cr√©er une nouvelle pi√®ce‚Ä¶</option>';
  var etageOpts = ['(aucun)'].concat(ETAGES).map(function(e){ return '<option value="'+e+'">'+e+'</option>'; }).join('');

  view(
    '<div class="card">'
      +b('Retour','pageHome()','btn back')
      +'<h2>Ajouter une pi√®ce</h2>'
      +'<label>Choisir une pi√®ce</label>'
      +'<select id="piece-choice">'+opts+'</select>'
      +'<label style="margin-top:10px;">Qualificatif (optionnel)</label>'
      +'<input id="piece-qualif" placeholder="ex : Parents, RDC, gauche" />'
      +'<label style="margin-top:10px;">√âtage (optionnel)</label>'
      +'<select id="piece-etage">'+etageOpts+'</select>'
      +'<div class="row" style="margin-top:10px;">'
        +b('Valider','confirmPieceChoice()','btn primary')
      +'</div>'
    +'</div>'
  );
}

function confirmPieceChoice(){
  var sel    = document.getElementById('piece-choice').value;
  var qualif = (document.getElementById('piece-qualif').value || '').trim();
  var etage  = document.getElementById('piece-etage').value;
  if(!sel) return;

  var base = sel;
  if(sel==='__NEW__'){
    base = (prompt('Nom de la pi√®ce :','') || '').trim();
    if(!base) return;
  }
  var etageVal = (etage && etage!=='(aucun)') ? etage : '';
  var key = createOrGetPiece(base, qualif, etageVal); // garantit une cl√© unique
  goPiece(key);
}

function removePiece(key){
  if(confirm('Supprimer la pi√®ce ¬´ '+formatPieceLabel(key)+' ¬ª et toutes ses lignes ?')){
    delete devis[key];
    saveLocal();
    pageHome();
  }
}

// ---- D√©tail d‚Äôune pi√®ce
function goPiece(key){
  ctx = { piece:key, category:null, intervention:null, pose:null, designation:null };
  ensureSection(key);

  var cats = CATEGORIES
    .filter(function(c){ return c!=='Sp√©cifique'; })
    .map(function(c){ return b(c,'goCategory('+JSON.stringify(c)+')','btn'); })
    .join('');

  var s = devis[key];
  var noteTxt = s.note ? '<em class="muted">Note : '+s.note+'</em>' : '<span class="muted">Aucune note</span>';

  var lignes = (s.items||[]).length
    ? '<ul>'+s.items.map(function(it,i){
        var total = (+it.prixU||0) * (+it.qty||0);
        var poseTxt = (it.intervention==='Cr√©ation' && it.pose) ? ' ‚Äî '+String(it.pose).toLowerCase() : '';
        var unitTxt = it.unit || 'u';
        return '<li>'
          +(it.intervention?(it.intervention+' ‚Äî '):'')+it.designation+poseTxt
          +' ('+it.qty+' '+unitTxt+' √ó '+euro(it.prixU)+' = '+euro(total)+') '
          +b('√ó','delLine('+JSON.stringify(key)+','+i+')','btn')
        +'</li>';
      }).join('') + '</ul>'
    : '<p class="muted">Aucune ligne pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      +b('Retour','pageHome()','btn back')
      +'<h2>'+formatPieceLabel(key)+'</h2>'
      +'<div class="row">'+cats+b('Sp√©cifique','pagePieceSpecifique()','btn ghost')+'</div>'
      +'<div class="row" style="margin-top:10px;">'
        +b('Ajouter / modifier la note','editPieceNote()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Lignes de la pi√®ce</h2>'
      +lignes
      +'<p style="margin-top:8px;">'+noteTxt+'</p>'
    +'</div>'
  );
}
function delLine(key, idx){
  (devis[key].items||[]).splice(idx,1);
  saveLocal();
  goPiece(key);
}

// ---- Choix cat√©gorie ‚Üí intervention
function goCategory(cat){
  ctx.category = cat;
  if(cat==='√âclairage') return goEclairageSub();

  var interventions = [];
  if(cat==='Prises' || cat==='Circuit sp√©cialis√©'){
    interventions = [
      'Cr√©ation',
      'Remplacement appareillage',
      'Rec√¢blage avec remplacement appareillage',
      'Rec√¢blage sans remplacement appareillage'
    ];
  }else if(cat==='Sp√©cifique'){
    interventions = ['Saisie libre avec prix'];
  }else{
    interventions = ['Cr√©ation'];
  }

  var btns = interventions.map(function(i){
    return b(i,'goIntervention('+JSON.stringify(i)+')','btn');
  }).join('');

  view(
    '<div class="card">'
      +b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      +'<h2>'+ctx.category+' ‚Äî '+formatPieceLabel(ctx.piece)+'</h2>'
      +'<div class="row">'+btns+'</div>'
    +'</div>'
  );
}

// Sous-menu √âclairage
function goEclairageSub(){
  view(
    '<div class="card">'
      +b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      +'<h2>√âclairage ‚Äî '+formatPieceLabel(ctx.piece)+'</h2>'
      +'<div class="row">'
        +b('Luminaires','setEclairageBranch('+JSON.stringify('√âclairage/Luminaires')+')','btn')
        +b('Commandes','setEclairageBranch('+JSON.stringify('√âclairage/Commandes')+')','btn')
      +'</div>'
    +'</div>'
  );
}
function setEclairageBranch(branch){
  ctx.category = branch;
  var interventions = (branch==='√âclairage/Luminaires')
    ? ['Cr√©ation','Remplacement luminaire','Rec√¢blage avec remplacement luminaire','Rec√¢blage sans remplacement luminaire']
    : ['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'];

  var btns = interventions.map(function(i){
    return b(i,'goIntervention('+JSON.stringify(i)+')','btn');
  }).join('');

  view(
    '<div class="card">'
      +b('Retour','goEclairageSub()','btn back')
      +'<h2>'+branch+' ‚Äî '+formatPieceLabel(ctx.piece)+'</h2>'
      +'<div class="row">'+btns+'</div>'
    +'</div>'
  );
}

// ---- Intervention ‚Üí √©ventuellement Pose ‚Üí D√©signation
function goIntervention(interv){
  ctx.intervention = interv;

  // Sp√©cifique (saisie libre)
  if(ctx.category==='Sp√©cifique'){
    var label = prompt('Nom de la prestation sp√©cifique :',''); if(!label) return goCategory('Sp√©cifique');
    var prix  = parseFloat(prompt('Prix estim√© (‚Ç¨) :','0'))||0;
    ensureSection(ctx.piece);
    devis[ctx.piece].items.push({ category:'Sp√©cifique', intervention:'', pose:'', designation:label, qty:1, prixU:prix });
    saveLocal();
    return goPiece(ctx.piece);
  }

  var needsPose = ['Prises','Circuit sp√©cialis√©','√âclairage/Luminaires','√âclairage/Commandes'].indexOf(ctx.category)>=0;
  if(interv==='Cr√©ation' && needsPose){
    var poses = POSES.map(function(p){ return b(p,'goDesignation('+JSON.stringify(p)+')','btn'); }).join('');
    var back  = (ctx.category.indexOf('√âclairage/')===0) ? '√âclairage' : ctx.category;
    view('<div class="card">'+b('Retour','goCategory('+JSON.stringify(back)+')','btn back')+'<h2>Type de pose</h2><div class="row">'+poses+'</div></div>');
  }else{
    goDesignation(null);
  }
}

function goDesignation(pose){
  ctx.pose = pose;
  var list = DESIGNATIONS_PAR_CATEGORIE[ctx.category] || ['√âl√©ment'];
  if(list.length===1) return pageQuantite(list[0]);

  var btns = list.map(function(d){
    return b(d,'pageQuantite('+JSON.stringify(d)+')','btn');
  }).join('');

  var backFn = (ctx.intervention==='Cr√©ation')
    ? 'goIntervention('+JSON.stringify(ctx.intervention)+')'
    : 'goCategory('+JSON.stringify(ctx.category)+')';

  view('<div class="card">'+b('Retour', backFn ,'btn back')+'<h2>D√©signation</h2><div class="row">'+btns+'</div></div>');
}

// ---- Quantit√© ‚Üí enregistrement
function pageQuantite(designation){
  ctx.designation = designation;
  var qtyBtns = Array.from({length:10}).map(function(_,i){
    var q=i+1; return b(q,'saveItem('+q+')','btn');
  }).join('');
  view('<div class="card">'+b('Retour','goDesignation('+(ctx.pose?JSON.stringify(ctx.pose):'null')+')','btn back')+'<h2>Quantit√©</h2><div class="grid-qty">'+qtyBtns+'</div></div>');
}

function getPrix(designation, intervention){
  var base = TARIFS[designation] || {};
  if(intervention==='Cr√©ation') return base.creation||0;
  if(intervention && intervention.indexOf('sans remplacement')>=0) return base.recablage_sans||0;
  if(intervention && intervention.indexOf('avec remplacement')>=0) return base.recablage_avec||0;
  if(intervention && intervention.indexOf('Remplacement')===0) return base.remplacement||0;
  return 0;
}

function saveItem(qty){
  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category: ctx.category,
    intervention: ctx.intervention,
    pose: ctx.pose,
    designation: ctx.designation,
    qty: qty,
    prixU: getPrix(ctx.designation, ctx.intervention)
  });
  saveLocal();
  goPiece(ctx.piece);
}

// ---- Sp√©cifique & Notes
function pagePieceSpecifique(){
  var label = prompt('Nom de la prestation sp√©cifique :',''); if(!label) return goPiece(ctx.piece);
  var prix  = parseFloat(prompt('Prix estim√© (‚Ç¨) :','0'))||0;
  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({ category:'Sp√©cifique', intervention:'', pose:'', designation:label, qty:1, prixU:prix });
  saveLocal();
  goPiece(ctx.piece);
}

function editPieceNote(){
  ensureSection(ctx.piece);
  var cur = devis[ctx.piece].note || '';
  var n = prompt('Note pour '+formatPieceLabel(ctx.piece), cur);
  if(n!==null) devis[ctx.piece].note = n.trim();
  saveLocal();
  goPiece(ctx.piece);
}
</script>
<!-- =============================
     CHAPITRE 6 : TABLEAU & DISTRIBUTION
     ============================= -->
<script>
// Forcer la pr√©sence de la section Tableau
function ensureTableau(){ ensureSection("Tableau"); }

/* ----------------------------------------------------------------------------
   √âtat local Disjoncteurs
   - qty : quantit√© demand√©e pour un calibre
   - circuits[] : infos par circuit (cr√©√©s quand on ouvre D√©tail)
   - hasDetails : true seulement si l‚Äôutilisateur a ouvert ¬´ D√©tail circuits ¬ª
                  ET cliqu√© ¬´ Enregistrer et revenir ¬ª
   ---------------------------------------------------------------------------*/
let tabState = {
  disj: {
    2:  { qty:0, circuits:[], hasDetails:false },
    10: { qty:0, circuits:[], hasDetails:false },
    16: { qty:0, circuits:[], hasDetails:false },
    20: { qty:0, circuits:[], hasDetails:false },
    32: { qty:0, circuits:[], hasDetails:false }
  }
};

// Initialiser circuits[] (uniquement quand on √©dite les d√©tails)
function ensureCircuitsArray(block){
  const n = block.qty|0;
  if(!Array.isArray(block.circuits)) block.circuits = [];
  while(block.circuits.length < n){
    block.circuits.push({ type:"prise", note:"", special:"" });
  }
  if(block.circuits.length > n){
    block.circuits = block.circuits.slice(0, n);
  }
}

// -------- Hub ‚ÄúInstallations sp√©cifiques‚Äù
function pageISHome(){
  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>Installations sp√©cifiques</h2>'
      + '<div class="row" style="margin-top:10px;">'
        + b("Mise √† la terre","isSoon(\'Mise √† la terre\')","btn")
        + b("VMC","isSoon(\'VMC\')","btn")
        + b("Tableau / distribution","pageTabHome()","btn primary")
      + '</div>'
      + '<p class="muted" style="margin-top:8px;">Les modules ‚ÄúMise √† la terre‚Äù et ‚ÄúVMC‚Äù arrivent bient√¥t.</p>'
    + '</div>'
  );
}
function isSoon(x){ alert(x+" : module √† venir."); }

// -------- Hub ‚ÄúTableau & distribution‚Äù
function pageTabHome(){
  view(
    '<div class="card">'
      + b("Retour","pageISHome()","btn back")
      + '<h2>Tableau & distribution</h2>'
      + '<div class="row" style="margin-top:10px;">'
        + b("1 ¬∑ Pose tableau","pageTabPose()","btn primary")
        + b("2 ¬∑ Modulaire : Disjoncteurs","pageTab_Disjoncteurs()","btn")
        + b("3 ¬∑ Modulaire : Interrupteurs diff.","pageTab_ID()","btn")
        + b("4 ¬∑ Commande & pilotage","pageTabMod_Commandes()","btn")
        + b("5 ¬∑ Sp√©cifique (libre + prix)","pageTabMod_Specifique()","btn ghost")
      + '</div>'
      + '<p class="muted" style="margin-top:8px;">Les √©l√©ments ajout√©s ici sont rang√©s dans la pi√®ce ¬´ Tableau ¬ª.</p>'
    + '</div>'
  );
}

/* ========== (1) POSE TABLEAU ========== */
function pageTabPose(){
  view(
    '<div class="card">'
      + b("Retour","pageTabHome()","btn back")
      + '<h2>Pose tableau</h2>'

      + '<label>Nombre de rang√©es</label>'
      + '<select id="tp-rang">'
        + '<option value="1" selected>1 rang√©e</option>'
        + '<option value="2">2 rang√©es</option>'
        + '<option value="3">3 rang√©es</option>'
        + '<option value="4">4 rang√©es</option>'
      + '</select>'

      + '<label style="margin-top:8px;">Nombre de modules</label>'
      + '<select id="tp-mod">'
        + '<option value="13" selected>13 modules</option>'
        + '<option value="18">18 modules</option>'
        + '<option value="24">24 modules</option>'
      + '</select>'

      + '<label style="margin-top:8px;">Type de pose</label>'
      + '<select id="tp-pose">'
        + '<option value="Saillie" selected>Saillie</option>'
        + '<option value="Encastr√©">Encastr√©</option>'
      + '</select>'

      + '<label style="margin-top:8px;">Type d‚Äôintervention</label>'
      + '<select id="tp-interv">'
        + '<option value="Cr√©ation" selected>Cr√©ation</option>'
        + '<option value="Avec d√©pose de l‚Äôexistant">Avec d√©pose de l‚Äôexistant</option>'
      + '</select>'

      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter au devis","addTabPose()","btn primary")
      + '</div>'
    + '</div>'
  );
}
function addTabPose(){
  const r   = document.getElementById('tp-rang').value;
  const m   = document.getElementById('tp-mod').value;
  const pos = document.getElementById('tp-pose').value;
  const itv = document.getElementById('tp-interv').value;

  ensureTableau();
  devis["Tableau"].items.push({
    category: "Tableau & distribution",
    intervention: itv,
    pose: pos,
    designation: "Pose tableau ‚Äî "+r+" rang√©e(s), "+m+" modules",
    qty: 1,
    prixU: 0
  });
  saveLocal();
  alert("√âl√©ment ajout√© √† ¬´ Tableau ¬ª.");
  pageTabHome();
}

/* ========== (2) INTER DIFF. ========== */
function pageTab_ID(){
  const opts = max => Array.from({length:max+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome()","btn back")
      + '<h2>Interrupteurs diff√©rentiels</h2>'
      + '<div class="list">'
        + `<label>ID 30mA - 40A - Type A <select id="id-a-40-30">${opts(20)}</select></label>`
        + `<label>ID 30mA - 40A - Type AC <select id="id-ac-40-30">${opts(20)}</select></label>`
        + `<label>ID 30mA - 63A - Type A <select id="id-a-63-30">${opts(20)}</select></label>`
        + `<label>ID 30mA - 63A - Type AC <select id="id-ac-63-30">${opts(20)}</select></label>`
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter au devis","submitTab_ID()","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_ID(){
  const defs = [
    { id:"id-a-40-30",  name:"ID 30mA - 40A - Type A"  },
    { id:"id-ac-40-30", name:"ID 30mA - 40A - Type AC" },
    { id:"id-a-63-30",  name:"ID 30mA - 63A - Type A"  },
    { id:"id-ac-63-30", name:"ID 30mA - 63A - Type AC" }
  ];
  let added = 0;
  ensureTableau();
  defs.forEach(d=>{
    const q = +document.getElementById(d.id).value || 0;
    if(q>0){
      devis["Tableau"].items.push({
        category: "Tableau/Modulaire",
        designation: d.name,
        qty: q,
        prixU: 0
      });
      added++;
    }
  });
  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal();
  alert("Interrupteurs diff√©rentiels ajout√©s.");
  pageTabHome();
}

/* ========== (3) DISJONCTEURS + D√âTAIL CIRCUITS ========== */

// Types basiques + sp√©cialis√©s (reprend les constantes du Chapitre 3)
const CIRCUIT_TYPES = [
  { value:"prise",     label:"Circuit prises" },
  { value:"eclairage", label:"Circuit √©clairage" }
];
const getSpecials = () =>
  (DESIGNATIONS_PAR_CATEGORIE && DESIGNATIONS_PAR_CATEGORIE["Circuit sp√©cialis√©"]) || [];

// Petit rendu d‚Äôaper√ßu des d√©tails (affich√© sous les s√©lecteurs sur la page principale)
function previewDetails(block){
  if(!block || !block.hasDetails || !block.qty) return "";
  const names = block.circuits.slice(0, block.qty).map(c=>{
    if(c.type==="special") return c.special||"Sp√©cialis√©";
    if(c.type==="eclairage") return "√©clairage"+(c.note?` (${c.note})`:"");
    return "prise"+(c.note?` (${c.note})`:"");
  }).filter(Boolean);
  return names.length ? `<small class="muted">D√©tails : ${names.join(", ")}</small>` : "";
}

function pageTab_Disjoncteurs(){
  const opts = max => Array.from({length:max+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome()","btn back")
      + '<h2>Disjoncteurs modulaires (2A / 10A / 16A / 20A / 32A)</h2>'
      + '<div class="list">'
        + `<label>2 A (Qt√©)  <select id="djq-2">${opts(30)}</select> ${b("D√©tail circuits","pageTab_DisjDetails(2)")}<br>${previewDetails(tabState.disj[2])}</label>`
        + `<label>10 A (Qt√©) <select id="djq-10">${opts(30)}</select> ${b("D√©tail circuits","pageTab_DisjDetails(10)")}<br>${previewDetails(tabState.disj[10])}</label>`
        + `<label>16 A (Qt√©) <select id="djq-16">${opts(30)}</select> ${b("D√©tail circuits","pageTab_DisjDetails(16)")}<br>${previewDetails(tabState.disj[16])}</label>`
        + `<label>20 A (Qt√©) <select id="djq-20">${opts(30)}</select> ${b("D√©tail circuits","pageTab_DisjDetails(20)")}<br>${previewDetails(tabState.disj[20])}</label>`
        + `<label>32 A (Qt√©) <select id="djq-32">${opts(30)}</select> ${b("D√©tail circuits","pageTab_DisjDetails(32)")}<br>${previewDetails(tabState.disj[32])}</label>`
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Vider la s√©lection","pageTab_DisjVider()","btn")
        + b("Valider ces disjoncteurs","pageTab_DisjValider()","btn primary")
      + '</div>'
      + '<p class="muted" style="margin-top:6px;">Tu peux ouvrir ¬´ D√©tail circuits ¬ª √† tout moment, sans valider.</p>'
    + '</div>'
  );

  // r√©appliquer l'√©tat quantit√©s
  document.getElementById('djq-2').value  = tabState.disj[2].qty;
  document.getElementById('djq-10').value = tabState.disj[10].qty;
  document.getElementById('djq-16').value = tabState.disj[16].qty;
  document.getElementById('djq-20').value = tabState.disj[20].qty;
  document.getElementById('djq-32').value = tabState.disj[32].qty;
}

function pageTab_DisjDetails(rating){
  const selOnMain = document.getElementById('djq-'+rating);
  const fromMainQty = selOnMain ? (+selOnMain.value||0) : 0;

  const block = tabState.disj[rating] || { qty:0, circuits:[], hasDetails:false };
  // Si aucune qty d√©j√† m√©moris√©e, on prend celle de la page principale
  if(!block.qty && fromMainQty) block.qty = fromMainQty;

  ensureCircuitsArray(block);

  const qtyOpts = Array.from({length:31},(_,i)=>`<option value="${i}" ${i===block.qty?'selected':''}>${i}</option>`).join('');
  const specials = getSpecials();
  const specialOptsAll = specials.map(s=>`<option value="${s}">${s}</option>`).join('');

  function renderRow(c,i){
    const typeOpts = [
      ...CIRCUIT_TYPES.map(t=>`<option value="${t.value}" ${c.type===t.value?'selected':''}>${t.label}</option>`),
      `<option value="special" ${c.type==="special"?'selected':''}>Circuit sp√©cialis√©‚Ä¶</option>`
    ].join('');
    const isBasic = (c.type!=="special");
    const noteVal = (c.note||'').replace(/"/g,'&quot;');
    const specialOpts = specialOptsAll.replace(`value="${c.special}"`,`value="${c.special}" selected`);

    return `
      <div class="card" style="padding:10px;">
        <strong>Circuit ${i+1}</strong>
        <div class="row" style="margin-top:6px;">
          <label style="flex:1; min-width:220px;">
            Type
            <select data-role="type" data-idx="${i}">${typeOpts}</select>
          </label>
          <label style="flex:1; min-width:220px; ${isBasic?'':'display:none'}" data-wrap="note-${i}">
            Nom / caract√©ristique (optionnel)
            <input data-role="note" data-idx="${i}" value="${noteVal}" />
          </label>
          <label style="flex:1; min-width:220px; ${c.type==="special"?'':'display:none'}" data-wrap="special-${i}">
            Sp√©cialis√©
            <select data-role="special" data-idx="${i}">
              <option value="" ${!c.special?'selected':''}>(choisir)</option>
              ${specialOpts}
            </select>
          </label>
        </div>
      </div>`;
  }

  view(
    '<div class="card">'
      + b("Retour","pageTab_Disjoncteurs()","btn back")
      + `<h2>D√©tail circuits ‚Äî ${rating} A</h2>`
      + `<label>Nombre de circuits <select id="dj-detail-qty">${qtyOpts}</select></label>`
      + `<div id="dj-detail-rows" style="margin-top:10px;">${block.qty ? block.circuits.slice(0,block.qty).map(renderRow).join('') : '<p class="muted">Aucun circuit.</p>'}</div>`
      + '<div class="row" style="margin-top:12px;">'
        + b("Enregistrer et revenir","pageTab_DisjSaveDetails("+rating+")","btn primary")
      + '</div>'
    + '</div>'
  );

  const rowsEl = document.getElementById('dj-detail-rows');
  const qtyEl  = document.getElementById('dj-detail-qty');

  function attachRowListeners(){
    rowsEl.querySelectorAll('[data-role="type"]').forEach(sel=>{
      sel.addEventListener('change', ev=>{
        const i = +ev.target.getAttribute('data-idx');
        const val = ev.target.value;
        block.circuits[i].type = val;
        const noteWrap    = rowsEl.querySelector('[data-wrap="note-'+i+'"]');
        const specialWrap = rowsEl.querySelector('[data-wrap="special-'+i+'"]');
        if(val==="special"){ if(noteWrap) noteWrap.style.display="none"; if(specialWrap) specialWrap.style.display=""; }
        else{ if(noteWrap) noteWrap.style.display=""; if(specialWrap) specialWrap.style.display="none"; }
      });
    });
    rowsEl.querySelectorAll('[data-role="note"]').forEach(inp=>{
      inp.addEventListener('input', ev=>{
        const i = +ev.target.getAttribute('data-idx');
        block.circuits[i].note = ev.target.value || "";
      });
    });
    rowsEl.querySelectorAll('[data-role="special"]').forEach(sel=>{
      sel.addEventListener('change', ev=>{
        const i = +ev.target.getAttribute('data-idx');
        block.circuits[i].special = ev.target.value || "";
      });
    });
  }
  attachRowListeners();

  qtyEl.addEventListener('change', e=>{
    block.qty = +e.target.value || 0;
    ensureCircuitsArray(block);
    rowsEl.innerHTML = block.qty ? block.circuits.map(renderRow).join('') : '<p class="muted">Aucun circuit.</p>';
    attachRowListeners();
  });

  tabState.disj[rating] = block;
}

function pageTab_DisjSaveDetails(rating){
  const block = tabState.disj[rating] || { qty:0, circuits:[], hasDetails:false };
  ensureCircuitsArray(block);
  block.hasDetails = (block.qty>0); // on ne consid√®re ‚Äúd√©tails d√©finis‚Äù que si l‚Äôutilisateur enregistre
  tabState.disj[rating] = block;
  alert(`D√©tails ${rating} A enregistr√©s (${block.qty} circuit(s)).`);
  pageTab_Disjoncteurs();
}

function pageTab_DisjVider(){
  tabState.disj = {
    2:{qty:0,circuits:[],hasDetails:false},
    10:{qty:0,circuits:[],hasDetails:false},
    16:{qty:0,circuits:[],hasDetails:false},
    20:{qty:0,circuits:[],hasDetails:false},
    32:{qty:0,circuits:[],hasDetails:false}
  };
  pageTab_Disjoncteurs();
}

// ‚ûú Estimatif : n‚Äôafficher les ‚Äú‚Äî circuits : ‚Ä¶‚Äù que si hasDetails = true
function pageTab_DisjValider(){
  const readQty = id => +document.getElementById(id).value || 0;
  [2,10,16,20,32].forEach(r=>{
    if(!tabState.disj[r]) tabState.disj[r] = { qty:0, circuits:[], hasDetails:false };
    tabState.disj[r].qty = readQty('djq-'+r);
    // NE PAS appeler ensureCircuitsArray ici, sinon on ‚Äúcr√©era‚Äù des d√©tails par d√©faut
  });

  let added = 0;
  ensureTableau();

  [2,10,16,20,32].forEach(rating=>{
    const block = tabState.disj[rating];
    const qty   = block.qty|0;
    if(qty>0){
      let details = '';
      if(block.hasDetails && block.circuits && block.circuits.length){
        const names = block.circuits.slice(0, qty).map(c=>{
          if(c.type==="special") return c.special||"Sp√©cialis√©";
          if(c.type==="eclairage") return "√©clairage"+(c.note?` (${c.note})`:"");
          return "prise"+(c.note?` (${c.note})`:"");
        }).filter(Boolean);
        if(names.length) details = " ‚Äî circuits : "+names.join(', ');
      }
      devis["Tableau"].items.push({
        category: "Tableau/Modulaire",
        designation: "Disjoncteur "+rating+" A"+details,
        qty: qty,
        prixU: 0
      });
      added++;
    }
  });

  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal();
  alert("Disjoncteurs ajout√©s au devis.");
  pageTab_Disjoncteurs(); // on reste ici pour compl√©ter
}

/* ========== (4) COMMANDES ========== */
function pageTabMod_Commandes(){
  const opts = max => Array.from({length:max+1},(_,i)=>`<option value="${i}">${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome()","btn back")
      + '<h2>Commande & pilotage</h2>'
      + '<div class="list">'
        + `<label>T√©l√©rupteur <select id="cmd-telerup">${opts(20)}</select></label>`
        + `<label>T√©l√©rupteur silencieux <select id="cmd-telerup-sil">${opts(20)}</select></label>`
        + `<label>Horloge m√©canique + Disj 2A <select id="cmd-horloge-2a">${opts(20)}</select></label>`
        + `<label>Horloge m√©canique + contacteur HC + Disj 2A <select id="cmd-horloge-hc-2a">${opts(20)}</select></label>`
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter au devis","submitTabMod_Commandes()","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Commandes(){
  const pick=id=>+document.getElementById(id).value||0;
  const defs=[
    { id:"cmd-telerup",     name:"T√©l√©rupteur" },
    { id:"cmd-telerup-sil", name:"T√©l√©rupteur silencieux" },
    { id:"cmd-horloge-2a",  name:"Horloge m√©canique + Disj 2A" },
    { id:"cmd-horloge-hc-2a", name:"Horloge m√©canique + contacteur HC + Disj 2A" }
  ];
  let added=0; ensureTableau();
  defs.forEach(d=>{
    const q=pick(d.id);
    if(q>0){
      devis["Tableau"].items.push({ category:"Tableau/Commandes", designation:d.name, qty:q, prixU:0 });
      added++;
    }
  });
  if(!added){ alert("Rien √† ajouter."); return; }
  saveLocal(); alert("Commandes ajout√©es."); pageTabHome();
}

/* ========== (5) SP√âCIFIQUE ========== */
function pageTabMod_Specifique(){
  const label=prompt("Intitul√© (libre) :",""); if(!label){ pageTabHome(); return; }
  const prix=parseFloat(prompt("Prix unitaire (‚Ç¨) :","0"))||0;
  const qty=Math.max(1,parseInt(prompt("Quantit√© :","1")||"1",10));
  ensureTableau();
  devis["Tableau"].items.push({ category:"Tableau/Sp√©cifique", designation:label, qty, prixU:prix });
  saveLocal(); alert("Ajout√©."); pageTabHome();
}
</script>

<!-- =============================
     CHAPITRE 7 : ESTIMATIF & EXPORTS
     ============================= -->
<script>
// --- Groupes de pi√®ces (cr√©√© si absent)
window.PIECE_GROUPS = window.PIECE_GROUPS || {
  "Buanderie":"Pi√®ces techniques","Garage":"Pi√®ces techniques","Atelier":"Pi√®ces techniques",
  "Jardin":"Ext√©rieur","Terrasse":"Ext√©rieur","Balcon":"Ext√©rieur","Abri de jardin":"Ext√©rieur",
  "Cuisine":"Cuisine",
  "Salon":"Pi√®ces de vie","Salle √† manger":"Pi√®ces de vie","Couloir":"Pi√®ces de vie","Entr√©e":"Pi√®ces de vie",
  "Salle de bain":"Pi√®ces d'eau","Salle d'eau":"Pi√®ces d'eau","Toilettes":"Pi√®ces d'eau",
  "Chambre 1":"Chambres & Bureau","Chambre 2":"Chambres & Bureau","Chambre 3":"Chambres & Bureau",
  "Bureau":"Chambres & Bureau","Biblioth√®que":"Chambres & Bureau",
  "Tableau":"Tableau & distribution","Distribution":"Tableau & distribution",
  "Mise √† la terre":"Mise √† la terre","VMC":"VMC"
};

// --- Regroupe l‚Äôobjet devis par familles affichables
function groupDevis(){
  var g = {};
  for (var key in devis){
    if (key.indexOf("__") === 0) continue;
    var s = devis[key];
    var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
    var grp  = window.PIECE_GROUPS[base] || "Divers";
    if (!g[grp]) g[grp] = {};
    g[grp][key] = s;
  }
  return g;
}

// --- Helpers d‚Äôaffichage/export
function itemLine(it){
  var unit = it.unit || "u";
  var poseTxt = (it.intervention === "Cr√©ation" && it.pose) ? (" - " + String(it.pose).toLowerCase()) : "";
  var left = it.intervention ? (it.intervention + " ‚Äî ") : "";
  var pu = (+it.prixU || 0).toFixed(2);
  var q  = +it.qty || 0;
  var total = (q * (+it.prixU || 0)).toFixed(2);
  return "- " + left + it.designation + poseTxt + " | Qt√©: " + q + " " + unit + " | PU: " + pu + "‚Ç¨ | Total: " + total + "‚Ç¨";
}
function pieceSeparator(label){
  return "\n---------------- " + label + " ----------------\n";
}

// --- Page : Estimatif d√©taill√©
function pageEstimatif(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Estimatif d√©taill√©</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    html += '<h2 style="border-top:2px solid #000; padding-top:8px;">'+grp+'</h2>';
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var pieceLabel = formatPieceLabel(key);
      var sectionTotal = 0;

      html += '<h3 style="margin-top:6px; border-top:1px solid #ccc; padding-top:4px;">'+pieceLabel+'</h3><ul>';
      s.items.forEach(function(it){
        var q  = +it.qty || 0;
        var pu = +it.prixU || 0;
        var t  = q * pu;
        sectionTotal += t; groupTotal += t; totalGlobal += t;

        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? (" " + String(it.pose).toLowerCase()) : "";
        var unit    = it.unit || "u";
        var left    = it.intervention ? (it.intervention+" ‚Äî ") : "";
        html += '<li>' + left + it.designation + poseTxt + ' ('+q+' '+unit+' √ó '+euro(pu)+' = '+euro(t)+')</li>';
      });
      if (s.note) html += '<li><em>Note : '+s.note+'</em></li>';

      html += '</ul><p><strong>Total '+pieceLabel+' : '+euro(sectionTotal)+'</strong></p>';
    }

    html += '<p><strong>Total '+grp+' : '+euro(groupTotal)+'</strong></p><hr>';
  }

  html += '<h3>Total global : '+euro(totalGlobal)+'</h3>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

// --- Page : Totaux par groupe
function pageTotaux(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Totaux par groupe</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    var gt = 0;
    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;
      var st = s.items.reduce(function(sum,it){ return sum + (((+it.prixU)||0)*((+it.qty)||0)); }, 0);
      gt += st; totalGlobal += st;
    }
    html += '<p><strong>'+grp+'</strong> : '+euro(gt)+'</p>';
  }

  html += '<hr><p><strong>Total global : '+euro(totalGlobal)+'</strong></p>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

/* ===== Exports ===== */

// --- .txt par groupe
function exportText(){
  var grouped = groupDevis();
  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = formatPieceLabel(key);
      var st = 0;
      lines.push(pieceSeparator(label));

      s.items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');

    var blob = new Blob([lines.join('\r\n')], {type:'text/plain;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = 'devis_'+grp+'.txt'; a.click();
    URL.revokeObjectURL(url);
  }
  alert('‚úÖ Export termin√© : un fichier .txt par groupe g√©n√©r√©.');
}

// --- .zip par groupe
async function exportZipGroups(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var grouped = groupDevis();
  var zip = new JSZip();
  var global = 0;

  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = formatPieceLabel(key);
      var st = 0;
      lines.push(pieceSeparator(label));

      s.items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');
    global += groupTotal;

    zip.file('devis_'+grp+'.txt', lines.join('\r\n'));
  }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var readme = 'R√©capitulatif ‚Äî '+name+'\nDate: '+new Date().toLocaleString()
             + '\n\nTotal global: '+global.toFixed(2)+'‚Ç¨\n';
  zip.file('README.txt', readme);

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_groupes.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export ZIP (par groupe) g√©n√©r√©.');
}

// --- Texte complet (helper)
function buildFullText(){
  var grouped = groupDevis();
  var lines = ['=== DEVIS COMPLET ===\n'];
  var globalTotal = 0;

  for (var grp in grouped){
    lines.push('\n## '+grp+' ##\n');
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = formatPieceLabel(key);
      var st = 0;
      lines.push(pieceSeparator(label));

      s.items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t; globalTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨\n');
  }

  lines.push('\n=== Total global : '+globalTotal.toFixed(2)+'‚Ç¨ ===\n');
  return lines.join('\r\n');
}

// --- .txt complet
function exportTextFull(){
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildFullText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export .txt complet g√©n√©r√©.');
}

// --- .zip complet
async function exportZipFull(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var zip  = new JSZip();
  zip.file(name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt', buildFullText());
  zip.file('README.txt', 'Devis complet\nNom: '+name+'\nDate: '+new Date().toLocaleString()+'\n');

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export .zip complet g√©n√©r√©.');
}
</script>
<!-- =============================
     CHAPITRE 8 : D√âMARRAGE & EXPOSE
     ============================= -->
<script>
function init(){
  try{
    loadLocal();
    pageMain();
  }catch(err){
    const el=document.getElementById("app");
    if(el){
      el.innerHTML=`<div class="card"><h2>Erreur init()</h2><pre>${(err&&err.stack)||err}</pre></div>`;
    }
  }
}

/* Expose toutes les fonctions n√©cessaires */
Object.assign(window, {
  // Menu & sauvegarde (chap.4)
  pageMain,
  actionNouveauDevis,
  pageSavedDevis,
  loadDevis,
  deleteDevis,
  saveCurrentDevis,

  // Pi√®ces & flux (chap.5)
  pageHome,
  pageAddPiece,
  confirmPieceChoice,
  removePiece,
  goPiece,
  delLine,
  editPieceNote,
  pagePieceSpecifique,
  goCategory,
  goEclairageSub,
  setEclairageBranch,
  goIntervention,
  goDesignation,
  pageQuantite,
  saveItem,

  // Installations sp√©cifiques & Tableau (chap.6)
  pageISHome,
  isSoon,
  pageTabHome,
  pageTabPose,
  addTabPose,
  pageTab_ID,
  submitTab_ID,
  pageTab_Disjoncteurs,
  pageTab_DisjDetails,
  pageTab_DisjSaveDetails,
  pageTab_DisjVider,
  pageTab_DisjValider,
  pageTabMod_Commandes,
  submitTabMod_Commandes,
  pageTabMod_Specifique,

  // Estimatif & exports (chap.7)
  pageEstimatif,
  pageTotaux,
  exportText,
  exportZipGroups,
  exportTextFull,
  exportZipFull,

  // Navigation
  confirmBackHome
});

// Lancement
init();
</script>
