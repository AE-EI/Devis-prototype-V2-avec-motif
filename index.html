<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis ‚Äî V3.0</title>

  <!-- Styles de base -->
  <style>
    :root {
      --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666;
      --line:#e8e8e8; --primary:#111;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#444; background:#fafafa; }
  </style>

  <!-- JSZip (exports ZIP) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- Cache-busting : ajoute ?v=timestamp une seule fois par onglet -->
  <script>
  (function(){
    try{
      var url = new URL(location.href);
      if (url.searchParams.has('v')) return;
      var onceKey = 'cb_once_' + location.pathname;
      if (sessionStorage.getItem(onceKey)) return;
      url.searchParams.set('v', Date.now());
      sessionStorage.setItem(onceKey, '1');
      location.replace(url.toString());
    }catch(e){}
  })();
  </script>
</head>
<body>
  <header>MiniDevis ‚Äî V3.0</header>
  <main id="app"></main>

  <!-- Sentinelle ultra-t√¥t -->
  <script>
  (function(){
    var app = document.getElementById('app');
    if(app){ app.innerHTML =
      '<div class="card">Loader OK ‚Äî en attente des chapitres JS‚Ä¶</div>';
    }
  })();
  </script>







  

  

  
  <!-- =============================
     CHAPITRE 2 : √âTAT & HELPERS
     Index :
       ¬ß2.1 ‚Ä¢ Gestion erreurs globales
       ¬ß2.2 ‚Ä¢ √âtat global & contexte courant
       ¬ß2.3 ‚Ä¢ Identifiants & helpers DOM/UI
       ¬ß2.4 ‚Ä¢ Libell√©s de pi√®ces (build/format)
       ¬ß2.5 ‚Ä¢ Persistance locale (save/load)
     ============================= -->
<script>
// ¬ß2.1 ‚Ä¢ Gestion erreurs globales
window.addEventListener('error', function (e) {
  var el = document.getElementById('app');
  if (el) {
    el.innerHTML =
      '<div class="card"><h2>Erreur JS</h2><pre>'
      + (e.message || 'Erreur inconnue')
      + '\n' + (e.filename || '') + ':' + (e.lineno || 0) + ':' + (e.colno || 0)
      + '</pre></div>';
  }
});

// ¬ß2.2 ‚Ä¢ √âtat global & contexte courant
var devis = {}; // contiendra aussi __id, __name, __tabCounter
var ctx   = { piece:null, category:null, intervention:null, pose:null, designation:null };

// ¬ß2.3 ‚Ä¢ Identifiants & helpers DOM/UI
function genId(){ return 'dv_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
function ensureId(){ if(!devis.__id) devis.__id = genId(); }
function $app(){ return document.getElementById('app'); }
function b(label, fn, cls){
  cls = cls || 'btn';
  return '<button class="'+cls+'" onclick=\''+fn+'\'>'+label+'</button>';
}
function euro(n){ return (+(n||0)).toFixed(2) + ' ‚Ç¨'; }
function view(html, noFooter){
  if(!noFooter){
    html += '<div class="row" style="margin-top:16px; gap:12px;">'
          + b('‚¨ÖÔ∏è Accueil','confirmBackHome()','btn back')
          + b('üíæ Sauvegarder devis','saveCurrentDevis()','btn primary')
          + '</div>';
  }
  $app().innerHTML = html;
}
function confirmBackHome(){
  var hasData = Object.keys(devis)
    .filter(function(k){ return k.indexOf('__') !== 0; })
    .some(function(k){
      var s = devis[k]||{};
      return (s.items && s.items.length>0) || (s.note && s.note.trim().length>0);
    });

  if(!hasData || confirm('Revenir au menu principal ?\n‚ö†Ô∏è Les modifications non sauvegard√©es seront perdues.')){
    if (typeof pageMain === 'function') pageMain();
    else $app().innerHTML = '<div class="card"><h2>Accueil</h2><p class="muted">Le chapitre Menu (4) n\'est pas encore charg√©.</p></div>';
  }
}

// ¬ß2.4 ‚Ä¢ Libell√©s de pi√®ces (build/format)
function buildPieceLabel(base, qualif, etage){
  var lbl = base || '';
  if(qualif && qualif.trim()) lbl += ' ('+qualif.trim()+')';
  if(etage && etage.trim())   lbl += ' ‚Äî '+etage.trim();
  return lbl;
}
function nextFreeKey(label){
  if(!devis[label]) return label;
  var n=2; while(devis[label+' ('+n+')']) n++;
  return label+' ('+n+')';
}
function createOrGetPiece(base, qualif, etage){
  var wanted = buildPieceLabel(base,qualif,etage);
  var key    = nextFreeKey(wanted);
  if(!devis[key]) devis[key] = { __base:base, qualificatif:qualif||'', etage:etage||'', items:[], note:'' };
  saveLocal();
  return key;
}
function formatPieceLabel(key){
  var s = devis[key]; if(!s) return key;
  var base = s.__base || key;
  return buildPieceLabel(base, s.qualificatif, s.etage);
}

// ¬ß2.5 ‚Ä¢ Persistance locale (save/load)
function ensureSection(key){
  if(!devis[key]) devis[key] = { items:[], note:'', qualificatif:'', etage:'' };
}
function saveLocal(){
  try { localStorage.setItem('devis', JSON.stringify(devis)); } catch(e){}
}
function loadLocal(){
  try { devis = JSON.parse(localStorage.getItem('devis') || '{}') || {}; }
  catch(e){ devis = {}; }
  ensureId();
}
</script>










  
  
<!-- =============================
     CHAPITRE 3 : CONSTANTES + PRIX
     ============================= -->
<script>
// Pi√®ces pr√©d√©finies
var PIECES_PREDEFINIES = [
  'Salon','Cuisine','Salle √† manger','Salle de bain','Salle d\'eau',
  'Chambre 1','Chambre 2','Chambre 3','Toilettes','Bureau',
  'Buanderie','Garage','Couloir','Terrasse','Balcon','Jardin',
  'D√©barras','Ext√©rieur','Grenier/Combles','Atelier',
  'Abri de jardin','Entr√©e','Biblioth√®que'
];

  //
  // Liste d‚Äô√©tages (utilis√©e par pageAddPiece)
//
var ETAGES = window.ETAGES || [
  'Sous-sol', 'RDC', 'R+1', 'R+2', 'Combles', 'Mezzanine',
  'Annexe', 'Ext√©rieur'
];

// (Optionnel mais robuste) ‚Äî si la variable est supprim√©e ailleurs,
// on force un fallback vide pour √©viter les plantages.
if (!Array.isArray(ETAGES)) { ETAGES = []; }

// Cat√©gories standards
var CATEGORIES = ['Prises','√âclairage','Circuit sp√©cialis√©','Sp√©cifique'];

// Modes de pose
var POSES = [
  'Encastr√© ma√ßonnerie','Placo','Semi-encastr√©',
  'Saillie avec moulure','Sous tube IRL','Sur-mesure'
];

// Sections de c√¢blage (avec option personnalis√©e)
var SECTIONS_CABLE = ['0,75 mm¬≤','1,5 mm¬≤','2,5 mm¬≤','6 mm¬≤','Personnalis√©e‚Ä¶'];

// D√©signations possibles par cat√©gorie
var DESIGNATIONS_PAR_CATEGORIE = {
  // <‚Äî pour Prises on ne s‚Äôen sert plus (d√©signation supprim√©e dans l‚ÄôUI)
  '√âclairage/Luminaires': ['Point de centre','Applique'],
  '√âclairage/Commandes': ['Interrupteur simple','Interrupteur double'],
  'Circuit sp√©cialis√©': [
    'Four','Plaque de cuisson','Lave-linge','Lave-vaisselle',
    'S√®che-linge','Cumulus','VMC','Chauffage','Climatisation',
    'Prise ext√©rieure √©tanche'
  ]
};

/* ============ TARIFS BASE (FT pos√©, hors coefficients) ============

  ‚Ä¢ PRISES : le prix de base est unique (par intervention)
  ‚Ä¢ √âCLAIRAGE : prix de base par d√©signation (point de centre, applique, etc.)
  ‚Ä¢ CIRCUIT SP√âCIALIS√â : prix de base UNIQUE (par intervention, *quel que soit* le circuit).
    Les sections appliquent un coefficient (voir COEFF_SECTIONS_CS).

  Tu pourras tout modifier plus tard dans le chapitre ‚ÄúParam√©trage tarifs‚Äù.
*/
var TARIFS_BASE = {
  prises: { // par intervention
    'Cr√©ation': 110,
    'Remplacement appareillage': 30,
    'Rec√¢blage avec remplacement appareillage': 85,
    'Rec√¢blage sans remplacement appareillage': 65
  },
  eclairage: { // par d√©signation
    'Point de centre': {
      'Cr√©ation': 100,
      'Remplacement luminaire': 30,
      'Rec√¢blage avec remplacement luminaire': 95,
      'Rec√¢blage sans remplacement luminaire': 65
    },
    'Applique': {
      'Cr√©ation': 100,
      'Remplacement luminaire': 30,
      'Rec√¢blage avec remplacement luminaire': 95,
      'Rec√¢blage sans remplacement luminaire': 65
    },
    'Interrupteur simple': {
      'Cr√©ation': 50,
      'Remplacement appareillage': 25,
      'Rec√¢blage avec remplacement appareillage': 75,
      'Rec√¢blage sans remplacement appareillage': 55
    },
    'Interrupteur double': {
      'Cr√©ation': 50,
      'Remplacement appareillage': 30,
      'Rec√¢blage avec remplacement appareillage': 85,
      'Rec√¢blage sans remplacement appareillage': 55
    }
  },
  circuit_specialise_base: { // un seul prix de base, par intervention
    'Cr√©ation': 110,
    'Remplacement appareillage': 30,
    'Rec√¢blage avec remplacement appareillage': 85,
    'Rec√¢blage sans remplacement appareillage': 65
  }
};

// Coefficients de POSE (appliqu√©s √† Prises, √âclairage et CS)
var COEFF_POSE = {
  'Placo': 1.00,
  'Encastr√© ma√ßonnerie': 1.50,
  'Semi-encastr√©': 1.40,
  'Sur-mesure': 1.60,
  'Saillie avec moulure': 1.35,
  'Sous tube IRL': 1.35
};

// Coefficients de SECTION pour CS :
// 0,75 et 1,5 ‚Üí 1.00 ; 2,5 ‚Üí +10% ; 6 ‚Üí +20%
var COEFF_SECTIONS_CS = {
  '0,75 mm¬≤': 1.00,
  '1,5 mm¬≤': 1.00,
  '2,5 mm¬≤': 1.20,
  '6 mm¬≤': 1.40
};

/* ============ Tableau & distribution (inchang√©) ============ */
var TARIFS_TABLEAU = {
  pose_base_13: { 1:70, 2:90, 3:110, 4:130 },
  coef: {
    modules: { 13:1.00, 18:1.30, 24:1.50 },
    pose: { 'Saillie':1.00, 'Encastr√©':1.70 },
    intervention: { 'Cr√©ation':1.00, 'Avec d√©pose de l‚Äôexistant':1.30 }
  },
  disjoncteurs: { 2:32, 10:25, 16:25, 20:25, 32:32, 40:45 },
  inter_diff: { '40A-AC':70, '40A-A':90, '63A-AC':110, '63A-A':130 },
  commandes: {
    'T√©l√©rupteur':60,
    'T√©l√©rupteur silencieux':80,
    'Horloge m√©canique + Disjoncteur 2A':90,
    'Horloge m√©canique + contacteur heures creuses + Disjoncteur 2A':140
  }
};

/* ============ Helpers PRIX communs ============ */

// Arrondi au 5 sup√©rieur (toujours vers le haut)
function roundUp5(x){
  x = +x || 0;
  return Math.ceil(x / 5) * 5;
}

// Renvoie le PU avec pose/section + arrondi au 5 sup√©rieur
// category : 'Prises' | '√âclairage/Luminaires' | '√âclairage/Commandes' | 'Circuit sp√©cialis√©'
function computePU(category, designation, intervention, pose, section){
  var base = 0;

  if(category === 'Prises'){
    base = (TARIFS_BASE.prises[intervention] || 0);

  } else if(category === '√âclairage/Luminaires' || category === '√âclairage/Commandes'){
    base = (TARIFS_BASE.eclairage[designation] && TARIFS_BASE.eclairage[designation][intervention]) || 0;

  } else if(category === 'Circuit sp√©cialis√©'){
    base = (TARIFS_BASE.circuit_specialise_base[intervention] || 0);
    // Coeff section
    var cSec = COEFF_SECTIONS_CS[section] || 1.00;
    base = base * cSec;
  }

  // Coeff pose
  var cPose = COEFF_POSE[pose] || 1.00;
  var total = base * cPose;

  // Arrondi 5 sup√©rieur
  return roundUp5(total);
}

// Back-compat : utilis√© ailleurs (estimatif‚Ä¶)
function getPrix(designation, intervention){
  // garde une compatibilit√© minimale si appel√© sans contexte
  // (ex : pr√©visualisation ancienne). On renvoie juste la base eclairage.
  var e = TARIFS_BASE.eclairage[designation];
  return e ? (e[intervention] || 0) : 0;
}
</script>


  








  

  

  
<!-- =========================================
     CHAPITRE 4 : MENU & SAUVEGARDES ‚Äî V10.1 (corrig√©)
     - Menu principal (Nouveau devis, Mes devis sauvegard√©s, Param√©trage)
     - Gestion des devis sauvegard√©s (LS)
     - Export / import de la biblioth√®que de devis
     - Restauration ¬´ si vide ¬ª (recoverSavedIfEmpty)
     ========================================= -->

<script>
// ==============================
// ¬ß4.0 ‚Ä¢ Stockage & helpers
// ==============================
const KEY_SAVED_LIST = 'savedDevis_v1';  // biblioth√®que (liste de devis)
const KEY_CURRENT    = 'devis';          // devis courant (objet global existant)

/* Lecture / √©criture JSON LS */
function _readLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function _writeLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

/* R√©cup√®re la biblioth√®que des devis sauvegard√©s */
function _getSavedList(){ return _readLS(KEY_SAVED_LIST, []); }
function _setSavedList(list){ _writeLS(KEY_SAVED_LIST, Array.isArray(list)? list : []); }

/* G√©n√®re un id court */
function _shortId(){ return Math.random().toString(36).slice(2,8)+'-'+Date.now().toString(36).slice(-4); }

/* S√©curise le nom d‚Äôaffichage */
function _friendlyName(dv){
  const n = (dv && (dv.__name || dv.nom || 'Devis')).toString().trim() || 'Devis';
  const t = dv && dv.__ts ? new Date(dv.__ts).toLocaleDateString('fr-FR') : '';
  return t ? n+' ‚Äî '+t : n;
}

/* Clone profond simple */
function _clone(x){ return JSON.parse(JSON.stringify(x)); }

/* Total rapide (sans TVA) pour l‚Äôaper√ßu liste */
function _quickTotal(dv){
  let sum=0;
  if(!dv) return 0;
  for(const k in dv){
    if(k.indexOf('__')===0) continue;
    const s=dv[k]; const items=(s&&s.items)||[];
    for(let i=0;i<items.length;i++){
      const it=items[i];
      sum += ( (+it.prixU||0) * (+it.qty||0) );
    }
  }
  return sum;
}

// ==================================================
// ¬ß4.1 ‚Ä¢ Menu principal
// ==================================================
function pageMain(){
  view(
    '<div class="card">'
      + '<h2>Menu principal</h2>'
      + '<div class="row" style="gap:8px;flex-wrap:wrap;">'
        + b('‚ûï Nouveau devis','actionNouveauDevis()','btn primary')
        + b('üìÅ Mes devis sauvegard√©s','pageSavedDevis()','btn')
      + '</div>'
    + '</div>'

    + '<div class="card" style="margin-top:12px;">'
      + '<div class="section-title">Configuration</div>'
      + '<div class="row" style="gap:8px;flex-wrap:wrap;">'
        <!-- üîß Correctif : on appelle d√©sormais pageTarifsAccueil() -->
        + b('Param√©trage','pageTarifsAccueil()','btn')
      + '</div>'
    + '</div>'
  );
}

// Cr√©er/vider un devis courant
function actionNouveauDevis(){
  if(!confirm('Cr√©er un nouveau devis ? Le devis courant non sauvegard√© sera perdu.')) return;
  window.devis = { __id:_shortId(), __name:'Nouveau devis', __ts: Date.now() };
  saveLocal && saveLocal();
  pageHome && pageHome();
}

// ==================================================
// ¬ß4.2 ‚Ä¢ Devis sauvegard√©s (biblioth√®que)
// ==================================================
function pageSavedDevis(){
  const list = _getSavedList();
  const rows = list.length ? list.map(it=>{
    const total = euro(_quickTotal(it.data));
    return (
      '<div class="pill" style="width:100%;align-items:center;">'
      +  '<div style="flex:1 1 auto;"><strong>'+_friendlyName(it.data)+'</strong>'
      +  '<div class="muted" style="font-size:13px;">ID: '+it.id+' ‚Ä¢ '+total+'</div></div>'
      +  b('Ouvrir','loadDevis('+JSON.stringify(it.id)+')','btn')
      +  b('Supprimer','deleteDevis('+JSON.stringify(it.id)+')','btn')
      +'</div>'
    );
  }).join('') : '<p class="muted">Aucun devis sauvegard√©.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Mes devis sauvegard√©s</h2>'
      + '<div class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px;">'
        + b('üíæ Sauvegarder le devis courant','saveCurrentDevis()','btn primary')
        + b('‚¨áÔ∏è Exporter la biblioth√®que (.json)','exportSavedDevis()','btn')
        + b('‚¨ÜÔ∏è Importer une biblioth√®que','importSavedDevisUI()','btn')
      + '</div>'
    + '</div>'
    + '<div class="card" style="margin-top:12px;">'
      + '<h3>Liste</h3>'
      + rows
    + '</div>'
  );
}

/* Sauvegarde le devis courant dans la biblioth√®que */
function saveCurrentDevis(){
  if(!window.devis){ alert('Aucun devis courant.'); return; }
  const list=_getSavedList();
  const dv=_clone(window.devis);
  if(!dv.__id) dv.__id=_shortId();
  dv.__ts = Date.now();
  // remplace si m√™me __id, sinon ajoute
  const idx=list.findIndex(x=>x.id===dv.__id);
  const pack={ id: dv.__id, data: dv };
  if(idx>=0) list[idx]=pack; else list.unshift(pack);
  _setSavedList(list);
  alert('‚úÖ Devis sauvegard√© dans la biblioth√®que.');
  pageSavedDevis();
}

/* Charger un devis depuis la biblioth√®que */
function loadDevis(id){
  const list=_getSavedList();
  const it=list.find(x=>x.id===id);
  if(!it){ alert('Introuvable.'); return; }
  window.devis = _clone(it.data||{});
  saveLocal && saveLocal();
  pageHome && pageHome();
}

/* Supprimer un devis de la biblioth√®que */
function deleteDevis(id){
  if(!confirm('Supprimer ce devis sauvegard√© ?')) return;
  const list=_getSavedList().filter(x=>x.id!==id);
  _setSavedList(list);
  pageSavedDevis();
}

/* Export / Import de la biblioth√®que */
function exportSavedDevis(){
  const raw = JSON.stringify(_getSavedList(), null, 2);
  const blob = new Blob([raw], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='mes_devis.json'; a.click(); URL.revokeObjectURL(url);
}
function importSavedDevisUI(){
  const input=document.createElement('input');
  input.type='file'; input.accept='application/json';
  input.onchange = ()=>{
    const f=input.files && input.files[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=()=>{
      try{
        const arr=JSON.parse(rd.result||'[]'); if(!Array.isArray(arr)) throw new Error('format');
        // merge par id
        const cur=_getSavedList();
        arr.forEach(p=>{
          const idx=cur.findIndex(x=>x.id===p.id);
          if(idx>=0) cur[idx]=p; else cur.push(p);
        });
        _setSavedList(cur);
        alert('‚úÖ Biblioth√®que import√©e.');
        pageSavedDevis();
      }catch(e){ alert('‚ùå Import impossible.'); }
    };
    rd.readAsText(f,'utf-8');
  };
  input.click();
}

/* Restaure automatiquement le dernier devis si rien n‚Äôest pr√©sent (utilis√© par init) */
function recoverSavedIfEmpty(){
  try{
    if(window.devis && Object.keys(window.devis).length>0) return; // d√©j√† charg√©
    const list=_getSavedList();
    if(!list.length) return;
    window.devis = _clone(list[0].data||{});
    saveLocal && saveLocal();
  }catch(e){}
}

// ==================================================
// ¬ß4.3 ‚Ä¢ Expose (global)
// ==================================================
Object.assign(window, {
  pageMain,
  actionNouveauDevis,
  pageSavedDevis,
  saveCurrentDevis,
  exportSavedDevis,
  importSavedDevisUI,
  loadDevis,
  deleteDevis,
  recoverSavedIfEmpty
});
</script>







  




  
  


<!-- =============================
     CHAPITRE 5 : ACCUEIL & FLUX PI√àCES ‚Äî V10.0
     (ajouts : Prises = Fourniture/Marque/Gamme ‚Ä¢ Luminaires = Alimentation ligne de spot (nb) ‚Ä¢
               Commandes nouvelles d√©signations ‚Ä¢ Option "plusieurs types de pose")
     ============================= -->

<script>
function goVent(){
  if (typeof pageVentAccueil === 'function') pageVentAccueil();
  else alert('La section Ventilation n‚Äôest pas encore charg√©e.');
}
function _badge(txt){ return txt ? '<span class="badge">'+txt+'</span>' : ''; }
</script>

<script>
function pageHome(){
  var keys = Object.keys(devis).filter(k=>k.indexOf('__')!==0);
  var listHtml = keys.length ? keys.map(function(key){
    var s = devis[key] || {};
    var label = pieceDisplayLabel(key);
    return '<div class="pill">'
      +'<strong>'+label+'</strong> '
      +'<small>'+((s.items||[]).length)+' ligne(s)</small> '
      + _badge(s.qualificatif && s.qualificatif.trim())
      + _badge(s.etage && s.etage.trim())
      + b('Ouvrir','goPiece('+JSON.stringify(key)+')','btn')
      + b('Supprimer','removePiece('+JSON.stringify(key)+')','btn')
    +'</div>';
  }).join('') : '<p class="muted">Aucune pi√®ce ajout√©e pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      +'<h2>Accueil</h2>'
      +'<div class="row">'
        + b('Ajouter une pi√®ce','pageAddPiece()','btn primary')
        + b('Cr√©er un tableau','pageTabCreate()','btn')
        + b('Ventilation','goVent()','btn')
      +'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Pi√®ces & Tableaux ajout√©s</h2>'
      +'<div class="list">'+listHtml+'</div>'
    +'</div>'
    +'<div class="row" style="margin-top:12px;">'
      + b('Voir l‚Äôestimatif','pageEstimatif()','btn')
      + b('Voir les totaux','pageTotaux()','btn')
    +'</div>'
  );
}

function goPiece(key){
  ctx = { piece:key, category:null, intervention:null, pose:null, designation:null };
  ensureSection(key);

  var cats = ['Prises','√âclairage','Circuit sp√©cialis√©']
    .map(c=> b(c,'goCategory('+JSON.stringify(c)+')','btn'))
    .join('');

  var s = devis[key];
  var lignes = (s.items||[]).length
    ? '<ul>'+s.items.map(function(it,i){
        var total = (+it.prixU||0) * (+it.qty||0);
        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? ' ‚Äî '+String(it.pose).toLowerCase() : '';
        var unitTxt = it.unit || 'u';
        var left = it.intervention ? (it.intervention+' ‚Äî ') : '';
        return '<li>'
          + left + it.designation + poseTxt
          +' ('+it.qty+' '+unitTxt+' √ó '+euro(it.prixU)+' = '+euro(total)+') '
          + b('√ó','delLine('+JSON.stringify(key)+','+i+')','btn')
        +'</li>';
      }).join('') + '</ul>'
    : '<p class="muted">Aucune ligne pour l‚Äôinstant.</p>';

  var label = pieceDisplayLabel(key);
  var noteTxt = s.note ? '<em class="muted">Note : '+s.note+'</em>' : '<span class="muted">Aucune note</span>';

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      +'<h2>'+label+'</h2>'
      +'<div class="row">'+cats+b('Sp√©cifique','pageSpecifiqueForm()','btn ghost')+'</div>'
      +'<div class="row" style="margin-top:10px;">'+b('Ajouter / modifier la note','editPieceNote()','btn')+'</div>'
    +'</div>'
    +'<div class="card" style="margin-top:12px;">'
      +'<h2>Lignes de la pi√®ce</h2>'+lignes
      +'<p style="margin-top:8px;">'+noteTxt+'</p>'
    +'</div>'
  );
}

function delLine(key, idx){
  (devis[key].items||[]).splice(idx,1); saveLocal(); goPiece(key);
}
function removePiece(key){
  if(confirm('Supprimer la pi√®ce ¬´ '+pieceDisplayLabel(key)+' ¬ª et toutes ses lignes ?')){
    delete devis[key]; saveLocal(); pageHome();
  }
}
</script>

<script>
function pageAddPiece(){
  var opts = PIECES_PREDEFINIES.map(p=>'<option value="'+p+'">'+p+'</option>').join('')
           + '<option value="__NEW__">‚ûï Cr√©er une nouvelle pi√®ce‚Ä¶</option>';
  var safeEtages = (window.ETAGES && Array.isArray(ETAGES) && ETAGES.length)
      ? ['(aucun)'].concat(ETAGES)
      : ['(aucun)','RDC','R+1','R+2','Sous-sol','Combles','Ext√©rieur'];
  var etageOpts = safeEtages.map(e=>'<option value="'+e+'">'+e+'</option>').join('');

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Ajouter une pi√®ce</h2>'
      + '<label>Choisir une pi√®ce</label>'
      + '<select id="piece-choice">'+opts+'</select>'
      + '<label style="margin-top:10px;">Qualificatif (optionnel)</label>'
      + '<input id="piece-qualif" placeholder="ex : Parents, RDC, gauche" />'
      + '<label style="margin-top:10px;">√âtage (optionnel)</label>'
      + '<select id="piece-etage">'+etageOpts+'</select>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Valider','confirmPieceChoice()','btn primary')
      + '</div>'
    + '</div>'
  );
}
function confirmPieceChoice(){
  var sel    = document.getElementById('piece-choice').value;
  var qualif = (document.getElementById('piece-qualif').value || '').trim();
  var etage  = document.getElementById('piece-etage').value;
  if(!sel) return;
  var base = sel;
  if(sel==='__NEW__'){
    base = (prompt('Nom de la pi√®ce :','') || '').trim();
    if(!base) return;
  }
  var etageVal = (etage && etage!=='(aucun)') ? etage : '';
  var key = createOrGetPiece(base, qualif, etageVal);
  goPiece(key);
}
</script>

<script>
// ---- Sous-menu √âclairage
function goCategory(cat){
  if (cat === '√âclairage') return goEclairageSub();
  ctx.category = cat;
  pageOneShotSelection();
}
function goEclairageSub(){
  view(
    '<div class="card">'
      + b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      + '<h2>√âclairage ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<div class="row">'
        + b('Luminaires','setEclairageBranch('+JSON.stringify('√âclairage/Luminaires')+')','btn')
        + b('Commandes','setEclairageBranch('+JSON.stringify('√âclairage/Commandes')+')','btn')
      + '</div>'
    + '</div>'
  );
}
function setEclairageBranch(branch){
  ctx.category = branch;
  pageOneShotSelection();
}
</script>

<script>
// ---- Saisie one-shot (avec Fourniture/Marque/Gamme, Spots, Multi-pose)
const _BRANDS = {
  "Schneider": ["Odace","Alr√©a","Unica"],
  "Legrand": ["C√©liane","Dooxie","Keva"],
  "Hager": ["Gallery","Essensya","Cubyko","Ateha","1930"]
};
const _FOURNITURES_PRISES = ["Prise 2P+T","Prise 2P","Prise IP44","Sortie de c√¢ble"];

function pageOneShotSelection(){
  var cat = ctx.category;

  // Interventions par cat√©gorie
  var invs = [];
  if(cat==='Prises' || cat==='Circuit sp√©cialis√©'){
    invs = ['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'];
  } else if(cat==='√âclairage/Luminaires'){
    invs = ['Cr√©ation','Remplacement luminaire','Rec√¢blage avec remplacement luminaire','Rec√¢blage sans remplacement luminaire'];
  } else if(cat==='√âclairage/Commandes'){
    invs = ['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'];
  } else {
    invs = ['Cr√©ation'];
  }
  var invOpts = invs.map(i=>'<option value="'+i+'">'+i+'</option>').join('');

  // D√©signation + champs sp√©cifiques
  var desigHtml = '', defaultDesignation = '';
  var extraHtml = '';

  if(cat==='Prises'){
    defaultDesignation = 'Prise';
    // Fourniture / Marque / Gamme
    var fOpt  = _FOURNITURES_PRISES.map(x=>'<option>'+x+'</option>').join('');
    var mOpt  = Object.keys(_BRANDS).map(x=>'<option>'+x+'</option>').join('');
    var gOpt  = (_BRANDS["Schneider"]||[]).map(x=>'<option>'+x+'</option>').join('');
    desigHtml =
      '<div class="block">'
      +  '<div class="subcard"><div class="h-note">Fourniture (catalogue √† venir), Marque et Gamme sont m√©moris√©es avec la ligne, sans impact sur le PU de prestation.</div></div>'
      +  '<div class="presta-grid">'
      +    '<div class="field"><label>Fourniture</label><select id="fourn-prise">'+fOpt+'</select></div>'
      +    '<div class="field"><label>Marque</label><select id="brand-prise">'+mOpt+'</select></div>'
      +    '<div class="field"><label>Gamme</label><select id="range-prise">'+gOpt+'</select></div>'
      +  '</div>'
      +'</div>';
  }
  else if(cat==='√âclairage/Luminaires'){
    var list = (function(){
      // types dispos = ceux du catalogue prestation
      const pr = getPrestations();
      const L  = pr.appareillage.luminaires;
      return (L.baseTypes||[]).concat(L.customTypes||[]);
    })();
    defaultDesignation = list[0] || 'Point de centre';
    desigHtml =
      '<label style="margin-top:10px;">D√©signation</label>'
      + '<select id="oneshot-desig">'
      + list.map(d=>'<option value="'+d+'">'+d+'</option>').join('')
      + '</select>';

    // bloc spots (visible si design "Alimentation ligne de spot")
    extraHtml =
      '<div id="spot-extra" class="block" style="display:none;margin-top:10px;">'
      +  '<div class="field"><label>Nombre de spots sur la ligne</label>'
      +  '<input id="nb-spots" type="number" min="1" step="1" value="1" inputmode="numeric"/></div>'
      +  '<div class="h-note">PU = Base ligne + (Prix par spot √ó nombre de spots), avec coefficient de pose si Cr√©ation.</div>'
      +'</div>';
  }
  else if(cat==='√âclairage/Commandes'){
    var listC = (function(){
      const pr = getPrestations();
      const C  = pr.appareillage.commandes;
      return (C.baseTypes||[]).concat(C.customTypes||[]);
    })();
    defaultDesignation = listC[0] || 'Allumage simple';
    desigHtml =
      '<label style="margin-top:10px;">D√©signation</label>'
      + '<select id="oneshot-desig">'
      + listC.map(d=>'<option value="'+d+'">'+d+'</option>').join('')
      + '</select>';
  }
  else if(cat==='Circuit sp√©cialis√©'){
    // Choix de la section (affich√© en Cr√©ation)
    defaultDesignation = 'Circuit sp√©cialis√©'; // sera enrichi avec la section
  } else {
    defaultDesignation = '√âl√©ment';
    desigHtml = '<label>D√©signation</label><input id="oneshot-custom-desig" placeholder="√âl√©ment" />';
  }

  // Pose (masqu√©e si intervention ‚â† Cr√©ation)
  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var poseBlock = '<div id="oneshot-pose-wrap" class="block">'
                +   '<div class="field"><label>Type de pose</label><select id="oneshot-pose">'+poseOpts+'</select></div>'
                +   '<div class="field"><label><input type="checkbox" id="multi-pose"/> Plusieurs types de pose</label></div>'
                +   '<div id="multi-pose-wrap" class="subcard" style="display:none;margin-top:8px;">'
                +     '<div class="h-note">Ajoute plusieurs paliers {pose, quantit√©}. Le calcul utilise un PU moyen pond√©r√© (total / quantit√© totale).</div>'
                +     '<div class="row gap8">'
                +       '<select id="mp-pose">'+poseOpts+'</select>'
                +       '<input id="mp-qty" type="number" min="1" step="1" value="1" inputmode="numeric"/>'
                +       b("Ajouter","mpAdd()","btn")
                +     '</div>'
                +     '<div id="mp-list" style="margin-top:8px;"></div>'
                +   '</div>'
                + '</div>';

  // Section (CS uniquement, visible en Cr√©ation)
  var sectionBlock = '';
  if(cat==='Circuit sp√©cialis√©'){
    var sectOpts = SECTIONS_CABLE.map(s=>'<option value="'+s+'">'+s+'</option>').join('');
    sectionBlock = '<div id="oneshot-section-wrap" class="block" style="margin-top:10px;">'
                 +   '<div class="field"><label>Section</label><select id="oneshot-section">'+sectOpts+'</select></div>'
                 + '</div>';
  }

  // Quantit√©
  var qtyOpts = Array.from({length:30},(_,i)=>'<option '+(i===0?'selected':'')+'>'+(i+1)+'</option>').join('');

  var backFn = (cat && cat.indexOf('√âclairage/')===0) ? 'goEclairageSub()' : 'goPiece('+JSON.stringify(ctx.piece)+')';
  view(
    '<div class="card">'
      + b('Retour', backFn, 'btn back')
      + '<h2>'+cat+' ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<label>Intervention</label><select id="oneshot-interv">'+invOpts+'</select>'
      + desigHtml
      + (extraHtml || '')
      + poseBlock
      + sectionBlock
      + (cat==='Prises'
          ? '' // tout est dans desigHtml (fourniture/marque/gamme)
          : '')
      + '<label style="margin-top:10px;">Quantit√©</label>'
      + '<select id="oneshot-qty">'+qtyOpts+'</select>'
      + '<div id="oneshot-preview" class="muted" style="margin-top:10px;"></div>'
      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveOneShotItem(false)','btn primary')
        + b('Ajouter et rester','saveOneShotItem(true)','btn')
      + '</div>'
    + '</div>'
  );

  // ---------- logique dynamique
  function isCreation(){ return String(document.getElementById('oneshot-interv').value||'')==='Cr√©ation'; }
  function togglePoseVisibility(){
    var wrap = document.getElementById('oneshot-pose-wrap');
    if(wrap) wrap.style.display = isCreation() ? '' : 'none';
    var sWrap = document.getElementById('oneshot-section-wrap');
    if(sWrap) sWrap.style.display = (isCreation() && cat==='Circuit sp√©cialis√©') ? '' : 'none';
  }
  function refreshRanges(){
    var bsel = document.getElementById('brand-prise'); var rsel = document.getElementById('range-prise');
    if(!(bsel && rsel)) return;
    var brand = bsel.value;
    var list = _BRANDS[brand] || [];
    rsel.innerHTML = list.map(x=>'<option>'+x+'</option>').join('');
  }
  function refreshSpotExtra(){
    var sel = document.getElementById('oneshot-desig');
    var block = document.getElementById('spot-extra');
    if(!sel || !block) return;
    block.style.display = (String(sel.value).toLowerCase().indexOf('alimentation ligne de spot')===0) ? '' : 'none';
  }

  // multi-pose
  var mp = []; // [{pose, qty}]
  function renderMP(){
    var el = document.getElementById('mp-list');
    if(!el) return;
    if(!mp.length){ el.innerHTML = '<div class="muted">Aucune ligne de pose multiple.</div>'; return; }
    el.innerHTML = '<table class="table-mini"><thead><tr><th>Pose</th><th>Qt√©</th><th></th></tr></thead><tbody>'
      + mp.map(function(x,i){
        return '<tr><td>'+_esc(x.pose)+'</td><td>'+x.qty+'</td><td>'+b("√ó",'mpDel('+i+')','btn')+'</td></tr>';
      }).join('') + '</tbody></table>';
  }
  window.mpAdd = function(){
    var p = document.getElementById('mp-pose').value;
    var q = Math.max(1, parseInt(document.getElementById('mp-qty').value,10)||1);
    mp.push({pose:p, qty:q}); renderMP(); refreshPreview();
  };
  window.mpDel = function(i){ mp.splice(i,1); renderMP(); refreshPreview(); };

  // Aper√ßu PU/Total
  function currentDesignation(){
    if(cat==='Prises') return 'Prise';
    var selDes = document.getElementById('oneshot-desig');
    var custom = document.getElementById('oneshot-custom-desig');
    var d = (selDes && selDes.value) || (custom && custom.value.trim()) || '√âl√©ment';
    return d;
  }
  function currentExtras(){
    var ex = {};
    if(cat==='√âclairage/Luminaires'){
      var sel = document.getElementById('oneshot-desig');
      if(sel && String(sel.value).toLowerCase().indexOf('alimentation ligne de spot')===0){
        ex.spots = Math.max(1, parseInt(document.getElementById('nb-spots').value,10)||1);
      }
    }
    return ex;
  }
  function computePUMulti(interv, desig, pose, section){
    if(!isCreation() || !document.getElementById('multi-pose').checked || mp.length===0){
      return (typeof computePU==='function') ? computePU(cat, desig, interv, pose, section, currentExtras()) : 0;
    }
    // somme pond√©r√©e de plusieurs types de pose
    var total = 0, qtyTot = 0;
    mp.forEach(function(row){
      var pu = (typeof computePU==='function') ? computePU(cat, desig, interv, row.pose, section, currentExtras()) : 0;
      total += pu * row.qty; qtyTot += row.qty;
    });
    if(qtyTot<=0) return 0;
    return roundUp5(total / qtyTot);
  }
  function refreshPreview(){
    var interv = document.getElementById('oneshot-interv').value;
    var desig  = currentDesignation();
    var pose   = isCreation() ? (document.getElementById('oneshot-pose').value || '') : '';
    var section= (isCreation() && cat==='Circuit sp√©cialis√©') ? ((document.getElementById('oneshot-section')||{}).value||'') : '';
    var pu     = computePUMulti(interv, desig, pose, section);
    var q      = parseInt(document.getElementById('oneshot-qty').value,10)||1;
    document.getElementById('oneshot-preview').innerHTML = 'PU : '+euro(pu)+' ‚Äî Total : '+euro(pu*q);
  }

  // events
  (function bind(){
    ['oneshot-interv','oneshot-pose','oneshot-section','oneshot-desig','oneshot-custom-desig','oneshot-qty','nb-spots']
      .forEach(function(id){ var el=document.getElementById(id); if(el) el.addEventListener('input', function(){
        if(id==='oneshot-interv'){ togglePoseVisibility(); }
        if(id==='oneshot-desig'){ refreshSpotExtra(); }
        refreshPreview();
      }); });
    var mpChk = document.getElementById('multi-pose');
    if(mpChk) mpChk.addEventListener('change', function(){
      document.getElementById('multi-pose-wrap').style.display = mpChk.checked ? '' : 'none';
      refreshPreview();
    });
    var msel = document.getElementById('brand-prise'); if(msel){ msel.addEventListener('change', function(){ refreshRanges(); }); }
  })();

  // init
  togglePoseVisibility(); refreshRanges(); renderMP(); refreshSpotExtra(); refreshPreview();
}

function saveOneShotItem(stayHere){
  var cat  = ctx.category;
  var interv = document.getElementById('oneshot-interv').value;

  var isCrea = (interv==='Cr√©ation');
  var pose   = isCrea ? (document.getElementById('oneshot-pose').value||'') : '';
  var section= (isCrea && cat==='Circuit sp√©cialis√©')
                 ? ((document.getElementById('oneshot-section')||{}).value||'')
                 : '';

  var qty    = Math.max(1, parseInt(document.getElementById('oneshot-qty').value,10)||1);
  var desig  = (function(){
    if(cat==='Prises') return 'Prise';
    var selDes = document.getElementById('oneshot-desig');
    var custom = document.getElementById('oneshot-custom-desig');
    return (selDes && selDes.value) || (custom && custom.value.trim()) || '√âl√©ment';
  })();

  // extras
  var extras = {};
  if(cat==='√âclairage/Luminaires'){
    var sel = document.getElementById('oneshot-desig');
    if(sel && String(sel.value).toLowerCase().indexOf('alimentation ligne de spot')===0){
      extras.spots = Math.max(1, parseInt(document.getElementById('nb-spots').value,10)||1);
    }
  }

  // PU (multi-pose moyen si activ√©)
  var pu = (function(){
    var multi = document.getElementById('multi-pose');
    if(isCrea && multi && multi.checked){
      // recompute comme dans preview
      var mpRows = (function(){
        var list = []; var el=document.getElementById('mp-list'); if(!el) return list;
        return list; // (inutile ici, on recalcule √† nouveau)
      })();
      // On refait le calcul moyen via computePUMulti interne :
      var total = 0, qtyTot = 0;
      var tbl = []; // on relit mp depuis closure de pageOneShotSelection ? non ‚Äî on recalcule ad hoc :
      // pour simplicit√© : relire DOM (table) n‚Äôest pas fiable ici ; on prend pose courant si pas mp.
      // Or preview a d√©j√† affich√© le bon PU moyen ; on le reprend :
      var prevTxt = document.getElementById('oneshot-preview').textContent||'';
      var m = /PU\s*:\s*([0-9]+(?:[\.,][0-9]+)?)/.exec(prevTxt.replace(/\s/g,''));
      if(m){ return parseFloat(m[1].replace(',','.')) || 0; }
    }
    return (typeof computePU==='function') ? computePU(cat, desig, interv, pose, section, extras) : 0;
  })();

  // m√©tadonn√©es Prises (fourniture/marque/gamme)
  var meta = {};
  if(cat==='Prises'){
    meta.__fourniture = (document.getElementById('fourn-prise')||{}).value || '';
    meta.__marque     = (document.getElementById('brand-prise')||{}).value || '';
    meta.__gamme      = (document.getElementById('range-prise')||{}).value || '';
  }

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push(Object.assign({
    category: cat,
    intervention: interv,
    pose: pose,
    designation: (cat==='Circuit sp√©cialis√©' && desig==='Circuit sp√©cialis√©' && section) ? (desig+' ‚Äî '+section) : desig,
    qty: qty,
    prixU: pu,
    __tabKey: ctx.piece
  }, meta));
  saveLocal();

  if(stayHere){ pageOneShotSelection(); } else { goPiece(ctx.piece); }
}
</script>

<script>
// Sp√©cifique & notes ‚Äî inchang√©
function pageSpecifiqueForm(){
  var poseOpts  = POSES.map(p=>'<option value="'+p+'">'+p+'</option>').join('');
  var invOpts   = ['Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage']
                    .map(i=>'<option value="'+i+'">'+i+'</option>').join('');
  view(
    '<div class="card">'
      + b('Retour','goPiece('+JSON.stringify(ctx.piece)+')','btn back')
      + '<h2>Sp√©cifique ‚Äî '+pieceDisplayLabel(ctx.piece)+'</h2>'
      + '<label>Intervention</label><select id="sp-interv">'+invOpts+'</select>'
      + '<label style="margin-top:10px;">Nom</label>'
      + '<input id="sp-label" placeholder="ex : Bandeau LED, Pompe piscine‚Ä¶" />'
      + '<label style="margin-top:10px;">Type de pose</label><select id="sp-pose">'+poseOpts+'</select>'
      + '<label style="margin-top:10px;">Prix unitaire (‚Ç¨)</label><input id="sp-price" type="number" inputmode="decimal" placeholder="0" />'
      + '<label style="margin-top:10px;">Quantit√©</label><input id="sp-qty" type="number" inputmode="numeric" min="1" value="1" />'
      + '<div class="row" style="margin-top:14px; gap:8px;">'
        + b('Ajouter la ligne','saveSpecifique(false)','btn primary')
        + b('Ajouter et rester','saveSpecifique(true)','btn')
      + '</div>'
    + '</div>'
  );
}
function saveSpecifique(stayHere){
  var label = (document.getElementById('sp-label').value||'').trim();
  if(!label){ alert('Nom requis.'); return; }
  var pose  = document.getElementById('sp-pose').value || '';
  var interv= document.getElementById('sp-interv').value || 'Cr√©ation';
  var prix  = parseFloat(document.getElementById('sp-price').value)||0;
  var qty   = Math.max(1, parseInt(document.getElementById('sp-qty').value,10) || 1);

  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category:'Sp√©cifique',
    intervention:interv,
    pose:pose,
    designation:label,
    qty:qty,
    prixU:roundUp5(prix),
    __tabKey: ctx.piece
  });
  saveLocal();
  if(stayHere){ pageSpecifiqueForm(); } else { goPiece(ctx.piece); }
}

function editPieceNote(){
  ensureSection(ctx.piece);
  var cur = devis[ctx.piece].note || '';
  var n = prompt('Note pour '+pieceDisplayLabel(ctx.piece), cur);
  if(n!==null) devis[ctx.piece].note = n.trim();
  saveLocal();
  goPiece(ctx.piece);
}
</script>














  

  
  
 <!-- =======================================================================
     CHAPITRE 6 : TABLEAU √âLECTRIQUE (multi-tableaux) ‚Äî d√©coup√©
     Index :
       6.0 ‚Ä¢ √âtat local (tabState) + utils + getTabPrice
       6.1 ‚Ä¢ Cr√©ation / accueil d‚Äôun tableau (nom perso)
       6.2 ‚Ä¢ Pose du tableau
       6.3 ‚Ä¢ Interrupteurs diff√©rentiels
       6.3b‚Ä¢ Coupure g√©n√©rale
       6.4 ‚Ä¢ Disjoncteurs modulaires (+ d√©tails circuits)
       6.5 ‚Ä¢ Commandes & pilotage
       6.6 ‚Ä¢ √âl√©ment sp√©cifique
     ======================================================================= -->

<!-- 6.0 ‚Ä¢ √âtat local + utils -->
<script>
let tabState = {
  disj: {
    2:{qty:0,details:[]}, 10:{qty:0,details:[]}, 16:{qty:0,details:[]},
    20:{qty:0,details:[]}, 32:{qty:0,details:[]}, 40:{qty:0,details:[]},
    __custom__:{qty:0,details:[],label:""}
  }
};
function ensureTableauKey(key){
  if(!devis[key]) devis[key]={__base:"Tableau",items:[],note:"",__customName:""};
}
function saveDisjQtyFromUI(){
  const pick=id=>+((document.getElementById(id)||{}).value||0);
  ["2","10","16","20","32","40"].forEach(r=>{
    const v=pick("djq-"+r);
    if(!tabState.disj[+r]) tabState.disj[+r]={qty:0,details:[]};
    tabState.disj[+r].qty=v;
  });
  const lbl=(document.getElementById("djq-custom-label")?.value||"").trim();
  const q  =pick("djq-custom");
  tabState.disj.__custom__.label=lbl;
  tabState.disj.__custom__.qty=q;
}
// Prix de pose d‚Äôun tableau (arrondi 5+)
function getTabPrice(rangs, modules, pose, intervention){
  try{
    const base = (TARIFS_TABLEAU.pose_base_13[rangs]||0);
    const cm = (TARIFS_TABLEAU.coef.modules[modules]||1);
    const cp = (TARIFS_TABLEAU.coef.pose[pose]||1);
    const ci = (TARIFS_TABLEAU.coef.intervention[intervention]||1);
    return roundUp5(base*cm*cp*ci);
  }catch(e){ return 0; }
}
</script>

<!-- 6.1 ‚Ä¢ Cr√©ation / accueil -->
<script>
function pageTabCreate(){
  if(typeof devis.__tabCounter!=="number") devis.__tabCounter=0;
  devis.__tabCounter+=1;
  const key="Tableau "+devis.__tabCounter;

  if(!devis[key]) devis[key]={__base:"Tableau",items:[],note:"",__customName:""};
  saveLocal();

  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>Nouveau tableau</h2>'
      + '<p>Identifiant automatique : <strong>'+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="tab-custom" placeholder="ex: Principal RDC" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Valider","saveTabCustomName("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function saveTabCustomName(key){
  const name=(document.getElementById("tab-custom").value||"").trim();
  if(devis[key]){ devis[key].__customName=name; saveLocal(); }
  pageTabHome(key);
}
function pageTabHome(key){
  if(!key || !devis[key]) return pageHome();
  const custom = devis[key].__customName ? " ‚Äî "+devis[key].__customName : "";
  view(
    '<div class="card">'
      + b("Retour","pageHome()","btn back")
      + '<h2>'+key+custom+'</h2>'
      + '<div class="row" style="margin-top:10px;">'
        + b("1 ¬∑ Pose du tableau","pageTabPose("+JSON.stringify(key)+")","btn primary")
        + b("2 ¬∑ Interrupteurs diff√©rentiels","pageTab_ID("+JSON.stringify(key)+")","btn")
        + b("3 ¬∑ Coupure g√©n√©rale","pageTab_Coupure("+JSON.stringify(key)+")","btn")
        + b("4 ¬∑ Disjoncteurs modulaires","pageTab_Disjoncteurs("+JSON.stringify(key)+")","btn")
        + b("5 ¬∑ Commandes / pilotage","pageTabMod_Commandes("+JSON.stringify(key)+")","btn")
        + b("6 ¬∑ Sp√©cifique (libre + prix)","pageTabMod_Specifique("+JSON.stringify(key)+")","btn ghost")
      + '</div>'
      + '<p class="muted" style="margin-top:8px;">Les √©l√©ments ajout√©s ici restent dans ¬´ '+key+' ¬ª.</p>'
    + '</div>'
  );
}
</script>

<!-- 6.2 ‚Ä¢ Pose du tableau -->
<script>
function pageTabPose(key){
  const rangs=[1,2,3,4].map(r=>`<option value="${r}">${r} rang√©e(s)</option>`).join('');
  const modules=[13,18,24].map(m=>`<option value="${m}">${m} modules</option>`).join('');
  const poses=['Saillie','Encastr√©'].map(p=>`<option value="${p}">${p}</option>`).join('');
  const intervs=['Cr√©ation','Avec d√©pose de l‚Äôexistant'].map(i=>`<option value="${i}">${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Pose du tableau</h2>'
      + '<label>Nombre de rang√©es</label><select id="tab-rang">'+rangs+'</select>'
      + '<label>Modules</label><select id="tab-mod">'+modules+'</select>'
      + '<label>Pose</label><select id="tab-pose">'+poses+'</select>'
      + '<label>Intervention</label><select id="tab-inv">'+intervs+'</select>'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"addTabPose("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function addTabPose(key){
  const r=+document.getElementById("tab-rang").value;
  const m=+document.getElementById("tab-mod").value;
  const pos=document.getElementById("tab-pose").value;
  const itv=document.getElementById("tab-inv").value;
  const pu=(typeof getTabPrice==='function')?getTabPrice(r,m,pos,itv):0;

  ensureTableauKey(key);
  devis[key].items.push({
    category:"Tableau & distribution",
    intervention:itv, pose:pos,
    designation:`Pose tableau ‚Äî ${r} rang√©e(s), ${m} modules`,
    qty:1, prixU:pu, __tabKey:key
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.3 ‚Ä¢ Interrupteurs diff√©rentiels -->
<script>
function pageTab_ID(key){
  const MODELS=[
    { id:"40A-A",  label:"ID 30mA - 40A - Type A"  },
    { id:"40A-AC", label:"ID 30mA - 40A - Type AC" },
    { id:"63A-A",  label:"ID 30mA - 63A - Type A"  },
    { id:"63A-AC", label:"ID 30mA - 63A - Type AC" }
  ];
  const opts=(n=20)=>Array.from({length:n+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  const price=id=>(TARIFS_TABLEAU && TARIFS_TABLEAU.inter_diff ? (TARIFS_TABLEAU.inter_diff[id]||0) : 0);

  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Interrupteurs diff√©rentiels</h2>'
      + '<div class="list">'
        + MODELS.map(m=>(
          `<label>${m.label} ‚Äî <span class="muted">${euro(price(m.id))}</span> `
          + `<select id="idq-${m.id.replace(/[^a-z0-9]/ig,'_')}">${opts(20)}</select></label>`
        )).join('')
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"submitTab_ID("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_ID(key){
  const pick=id=>+document.getElementById(id).value||0;
  const mk=id=>`idq-${id.replace(/[^a-z0-9]/ig,'_')}`;
  const lines=["40A-A","40A-AC","63A-A","63A-AC"].map(id=>({id,q:pick(mk(id))})).filter(x=>x.q>0);
  if(!lines.length){ pageTabHome(key); return; }

  ensureTableauKey(key);
  lines.forEach(x=>{
    const pu = (TARIFS_TABLEAU && TARIFS_TABLEAU.inter_diff ? (TARIFS_TABLEAU.inter_diff[x.id]||0) : 0);
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:`ID 30mA ‚Äî ${x.id.replace('-', ' - ')}`,
      qty:x.q, prixU:pu, __tabKey:key
    });
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.3b ‚Ä¢ Coupure g√©n√©rale -->
<script>
function pageTab_Coupure(key){
  const MODELS=[ { id:"45A", label:"Coupure g√©n√©rale 45 A", pu:80 },
                 { id:"60A", label:"Coupure g√©n√©rale 60 A", pu:110 } ];
  const opts=(n=20)=>Array.from({length:n+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Coupure g√©n√©rale</h2>'
      + '<div class="list">'
        + MODELS.map(m=>(
          `<label>${m.label} ‚Äî <span class="muted">${euro(m.pu)}</span> `
          + `<select id="cgq-${m.id}">${opts(20)}</select></label>`
        )).join('')
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"submitTab_Coupure("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTab_Coupure(key){
  const pick=id=>+document.getElementById(id).value||0;
  const defs = [
    { id:"45A", label:"Coupure g√©n√©rale 45 A", pu:80 },
    { id:"60A", label:"Coupure g√©n√©rale 60 A", pu:110 }
  ].map(d=>({ ...d, q: pick("cgq-"+d.id) })).filter(d=>d.q>0);

  if(!defs.length){ pageTabHome(key); return; }
  ensureTableauKey(key);
  defs.forEach(d=>{
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:d.label,
      qty:d.q, prixU:d.pu, __tabKey:key
    });
  });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.4 ‚Ä¢ Disjoncteurs modulaires (+ d√©tails) -->
<script>
function pageTab_Disjoncteurs(key){
  const opts=(max=30)=>Array.from({length:max+1},(_,i)=>`<option value="${i}" ${i===0?'selected':''}>${i}</option>`).join('');
  const line = amp => (
    `<label>${amp} A <select id="djq-${amp}">${opts(30)}</select> `
    + `${b("D√©tail circuits","pageTab_DisjDetails("+JSON.stringify(key)+","+amp+")")}</label>`
  );
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Disjoncteurs modulaires</h2>'
      + '<div class="list">'
        + line(2) + line(10) + line(16) + line(20) + line(32) + line(40)
        + `<label>Calibre personnalis√©
             <input id="djq-custom-label" placeholder="ex: 50 A, 3x20A‚Ä¶">
             Qt√© <select id="djq-custom">${opts(30)}</select>
             ${b("D√©tail circuits","pageTab_DisjDetails("+JSON.stringify(key)+", '__custom__')")}
           </label>`
      + '</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Ajouter √† "+key,"pageTab_DisjValider("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
  ["2","10","16","20","32","40"].forEach(r=>{
    const el=document.getElementById("djq-"+r);
    if(el && tabState.disj[+r]) el.value=tabState.disj[+r].qty||0;
  });
  if(document.getElementById("djq-custom")){
    document.getElementById("djq-custom").value = tabState.disj.__custom__.qty||0;
    document.getElementById("djq-custom-label").value = tabState.disj.__custom__.label||"";
  }
}
function pageTab_DisjDetails(key, rating){
  saveDisjQtyFromUI();
  const st=tabState.disj[rating] || {qty:0,details:[]};
  const qty=st.qty||0; if(!st.details) st.details=[];
  const row=(i,d)=>{
    const type=d?.type||'', note=d?.note||'';
    return `
      <div class="pill" style="width:100%;">
        <select data-idx="${i}" class="dj-type">
          <option value="">(non d√©fini)</option>
          <option value="Circuit prise" ${type==='Circuit prise'?'selected':''}>Circuit prise</option>
          <option value="Circuit √©clairage" ${type==='Circuit √©clairage'?'selected':''}>Circuit √©clairage</option>
          <optgroup label="Circuits sp√©cialis√©s">
            <option value="Four" ${type==='Four'?'selected':''}>Four</option>
            <option value="Plaque de cuisson" ${type==='Plaque de cuisson'?'selected':''}>Plaque de cuisson</option>
            <option value="Lave-linge" ${type==='Lave-linge'?'selected':''}>Lave-linge</option>
            <option value="Lave-vaisselle" ${type==='Lave-vaisselle'?'selected':''}>Lave-vaisselle</option>
            <option value="S√®che-linge" ${type==='S√®che-linge'?'selected':''}>S√®che-linge</option>
            <option value="Cumulus" ${type==='Cumulus'?'selected':''}>Cumulus</option>
            <option value="VMC" ${type==='VMC'?'selected':''}>VMC</option>
            <option value="Chauffage" ${type==='Chauffage'?'selected':''}>Chauffage</option>
            <option value="Climatisation" ${type==='Climatisation'?'selected':''}>Climatisation</option>
            <option value="Prise ext√©rieure √©tanche" ${type==='Prise ext√©rieure √©tanche'?'selected':''}>Prise ext√©rieure √©tanche</option>
            <option value="__custom__">Nom personnalis√©‚Ä¶</option>
          </optgroup>
        </select>
        <input data-idx="${i}" class="dj-note" placeholder="Caract√©ristique / nom (facultatif)" value="${(note||'').replace(/"/g,'&quot;')}" />
      </div>
    `;
  };
  let out=''; for(let i=0;i<qty;i++){ out+=row(i, st.details[i]||{}); }
  view(
    '<div class="card">'
      + b("Retour","pageTab_Disjoncteurs("+JSON.stringify(key)+")","btn back")
      + '<h2>D√©tail circuits ‚Äî '+(rating==='__custom__'?(tabState.disj.__custom__.label||'Calibre personnalis√©'):(rating+' A'))+'</h2>'
      + '<div id="dj-detail-container">'+out+'</div>'
      + '<div class="row" style="margin-top:12px;">'
        + b("Enregistrer","pageTab_DisjSaveDetails("+JSON.stringify(key)+","+JSON.stringify(rating)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function pageTab_DisjSaveDetails(key, rating){
  const types=[...document.querySelectorAll('.dj-type')];
  const notes=[...document.querySelectorAll('.dj-note')];
  const details=[];
  for(let i=0;i<types.length;i++){
    let t=types[i]?.value||''; if(t==="__custom__"){ t=prompt("Nom personnalis√© du circuit :","")||("Circuit "+(i+1)); }
    const n=notes[i]?.value||''; details.push({type:t,note:n});
  }
  if(!tabState.disj[rating]) tabState.disj[rating]={qty:0,details:[]};
  tabState.disj[rating].details=details;
  saveLocal(); pageTab_Disjoncteurs(key);
}
function pageTab_DisjValider(key){
  saveDisjQtyFromUI();
  const PU=Object.assign({}, (TARIFS_TABLEAU && TARIFS_TABLEAU.disjoncteurs)?TARIFS_TABLEAU.disjoncteurs:{}, {40:45});
  ensureTableauKey(key);

  [2,10,16,20,32,40].forEach(r=>{
    const st=tabState.disj[r];
    if(st && st.qty>0){
      const hasDetail=Array.isArray(st.details)&&st.details.some(d=>d&&(d.type||d.note));
      const detailText=hasDetail?' ‚Äî circuits : '+st.details.map((d,i)=>(d.type||('Circuit '+(i+1)))+(d.note?(' ('+d.note+')'):'')).join(', '):'';
      devis[key].items.push({
        category:"Tableau/Modulaire",
        designation:`Disjoncteur ${r} A${detailText}`,
        qty:st.qty, prixU:PU[r]||0, __tabKey:key
      });
    }
  });

  const c=tabState.disj.__custom__;
  if(c && c.qty>0){
    const label=(c.label||"Calibre personnalis√©").trim();
    const hasDetail=Array.isArray(c.details)&&c.details.some(d=>d&&(d.type||d.note));
    const detailText=hasDetail?' ‚Äî circuits : '+c.details.map((d,i)=>(d.type||('Circuit '+(i+1)))+(d.note?(' ('+d.note+')'):'')).join(', '):'';
    const pu=parseFloat(prompt("Prix unitaire pour ¬´ "+label+" ¬ª (‚Ç¨) :","0")||"0")||0;
    devis[key].items.push({
      category:"Tableau/Modulaire",
      designation:`Disjoncteur ${label}${detailText}`,
      qty:c.qty, prixU:pu, __tabKey:key
    });
  }
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.5 ‚Ä¢ Commandes & pilotage -->
<script>
function pageTabMod_Commandes(key){
  const PC=(TARIFS_TABLEAU && TARIFS_TABLEAU.commandes)?TARIFS_TABLEAU.commandes:{};
  const opts=Object.keys(PC).map(k=>`<option value="${k}">${k} (${euro(PC[k]||0)})</option>`).join('');
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>Commande & pilotage</h2>'
      + '<label>Mod√®le</label><select id="cmd-model">'+opts+'</select>'
      + '<label>Quantit√©</label><input id="cmd-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"submitTabMod_Commandes("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Commandes(key){
  const model=document.getElementById("cmd-model").value;
  const qty=Math.max(1, parseInt(document.getElementById("cmd-qty").value,10)||1);
  const pu=(TARIFS_TABLEAU && TARIFS_TABLEAU.commandes)?(TARIFS_TABLEAU.commandes[model]||0):0;
  ensureTableauKey(key);
  devis[key].items.push({ category:"Tableau/Commandes", designation:model, qty, prixU:pu, __tabKey:key });
  saveLocal(); pageTabHome(key);
}
</script>

<!-- 6.6 ‚Ä¢ √âl√©ment sp√©cifique -->
<script>
function pageTabMod_Specifique(key){
  view(
    '<div class="card">'
      + b("Retour","pageTabHome("+JSON.stringify(key)+")","btn back")
      + '<h2>√âl√©ment sp√©cifique</h2>'
      + '<label>Intitul√©</label><input id="spec-label" />'
      + '<label>Prix unitaire (‚Ç¨)</label><input id="spec-price" type="number" inputmode="decimal" />'
      + '<label>Quantit√©</label><input id="spec-qty" type="number" min="1" value="1" inputmode="numeric" />'
      + '<div class="row" style="margin-top:10px;">'
        + b("Ajouter √† "+key,"submitTabMod_Specifique("+JSON.stringify(key)+")","btn primary")
      + '</div>'
    + '</div>'
  );
}
function submitTabMod_Specifique(key){
  const label=(document.getElementById("spec-label").value||"").trim();
  const prix=parseFloat(document.getElementById("spec-price").value)||0;
  const qty=Math.max(1,parseInt(document.getElementById("spec-qty").value,10)||1);
  if(!label){ pageTabHome(key); return; }
  ensureTableauKey(key);
  devis[key].items.push({ category:"Tableau/Sp√©cifique", designation:label, qty, prixU:prix, __tabKey:key });
  saveLocal(); pageTabHome(key);
}
</script>













  
  
  
  
<!-- =======================================================================
     CHAPITRE 7 : VENTILATION ‚Äî corrig√© (libell√©s explicites, sans gros titres)
     ======================================================================= -->
<script>
/* √âtat local par ventilation */
var ventState = {};

/* S√©curit√© : pr√©sence d‚Äôune section VMC c√¥t√© devis + √©tat local par cl√© */
function ensureVentKey(key){
  if(!devis[key]) devis[key] = { __base:"VMC", __customName:"", items:[], note:"" };
  if(!ventState[key]) ventState[key] = {
    creation: {
      kit: {
        ref:"", d80:1, d125:1,
        conduits:[{type:"Gaine isol√©e"}],
        percements:[{support:"Placo", qty:0}]
      },
      extracteur: {
        ref:"", diam:"100",
        conduits:[{type:"Gaine isol√©e"}],
        percements:[{support:"Placo", qty:0}]
      },
      ventilateur: {
        ref:"", diam:"100", typeConduit:"Gaine isol√©e", longueur:0,
        percements:[{support:"Placo", qty:0}]
      }
    },
    retirage: { n80:0, n125:0 },
    entretien: { type:"Groupe VMC", nb:0 }
  };
}

/* Helpers lecture champs */
function pickVal(id, def){ var el=document.getElementById(id); return (el?el.value:def); }
function pickNum(id, def){ var el=document.getElementById(id); var v=parseFloat(el?el.value:NaN); return isNaN(v)?(def||0):v; }

/* ============================
   Accueil Ventilation
   ============================ */
function pageVentAccueil(){
  if(typeof devis.__ventCounter!=="number") devis.__ventCounter = 0;

  var keys = Object.keys(devis).filter(function(k){
    if(k.indexOf('__')===0) return false;
    var s = devis[k]||{};
    return (s.__base||"").toLowerCase()==="vmc";
  });

  var list = keys.length ? keys.map(function(k){
    var s=devis[k]||{};
    var titre = k + (s.__customName?(" ‚Äî "+s.__customName):"");
    var nb = (s.items||[]).length;
    return '<div class="pill">'
          +'<strong>'+titre+'</strong> <small>'+nb+' ligne(s)</small>'
          + b('Ouvrir','pageVentHome('+JSON.stringify(k)+')','btn')
          + b('Supprimer','ventDelete('+JSON.stringify(k)+')','btn')
          +'</div>';
  }).join('') : '<p class="muted">Aucune ventilation pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Ventilation</h2>'
      + b('‚ûï Ajouter une ventilation','pageVentNew()','btn primary')
    + '</div>'
    + '<div class="card" style="margin-top:12px;">'
      + '<h2>Liste</h2>'
      + list
    + '</div>'
  );
}

function pageVentNew(){
  devis.__ventCounter++;
  var key = 'Ventilation '+devis.__ventCounter;
  ensureVentKey(key); saveLocal();
  view(
    '<div class="card">'
      + b('Retour','pageVentAccueil()','btn back')
      + '<h2>Nouvelle ventilation</h2>'
      + '<p><strong>Identifiant : '+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="vent-name" placeholder="ex : VMC habitation, Local technique‚Ä¶" />'
      + '<div class="row" style="margin-top:10px;">'
        + b('Valider','saveVentName('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function saveVentName(key){
  var name = (document.getElementById('vent-name').value||'').trim();
  if(devis[key]) devis[key].__customName = name;
  saveLocal(); pageVentHome(key);
}
function ventDelete(key){
  if(!confirm('Supprimer ¬´ '+key+' ¬ª ?')) return;
  delete devis[key]; saveLocal(); pageVentAccueil();
}

function pageVentHome(key){
  ensureVentKey(key);
  var custom = devis[key].__customName ? ' ‚Äî '+devis[key].__customName : '';
  view(
    '<div class="card">'
      + b('Retour','pageVentAccueil('+')','btn back')
      + '<h2>'+key+custom+'</h2>'
      + '<div class="row" style="margin-top:8px; gap:8px;">'
        + b('1 ¬∑ Cr√©ation','pageVentCreation('+JSON.stringify(key)+')','btn primary')
        + b('2 ¬∑ Retirage des conduits','pageVentRetirage('+JSON.stringify(key)+')','btn')
        + b('3 ¬∑ Entretien','pageVentEntretien('+JSON.stringify(key)+')','btn')
      + '</div>'
      + '<p class="muted" style="margin-top:6px;">Ajoutez ici les lignes li√©es √† la ventilation (kit, extracteur, ventilateur, retirage, entretien‚Ä¶)</p>'
    + '</div>'
  );
}

/* ============================
   Cr√©ation (Kit / Extracteur / Ventilateur)
   ‚Äî Sans gros titres, mais avec libell√©s explicites
   ============================ */
function pageVentCreation(key){
  ensureVentKey(key);
  var st = ventState[key].creation;

  // Bloc : Liste de conduits (type)
  function conduitsBlock(arr, mutFn, prefix, legend){
    var rows = arr.map(function(c,i){
      var sel = ['Gaine isol√©e','Conduit rigide','Conduit rigide extra-plat','Gaine non isol√©e']
        .map(function(t){ return '<option '+(t===c.type?'selected':'')+'>'+t+'</option>'; }).join('');
      return (
        '<div class="pill" style="width:100%;">'
          + '<div style="flex:1 1 auto;">'
            + '<label><small>'+legend+' ‚Äî √©l√©ment n¬∞'+(i+1)+'</small></label>'
            + '<select id="'+prefix+'-type-'+i+'">'+sel+'</select>'
          + '</div>'
          + (i>0 ? b('√ó',mutFn+'('+JSON.stringify(key)+',"del",'+i+')','btn') : '')
        + '</div>'
      );
    }).join('');
    return rows + '<div class="row">'+ b('Ajouter un conduit',mutFn+'('+JSON.stringify(key)+',"add")','btn') +'</div>';
  }

  // Bloc : Liste de percements (support + quantit√©)
  function percementsBlock(arr, mutFn, prefix, legend){
    var supports=['Placo','Briquette','Ourdi b√©ton'];
    var rows = arr.map(function(p,i){
      var opts=supports.map(function(s){ return '<option '+(s===p.support?'selected':'')+'>'+s+'</option>'; }).join('');
      return (
        '<div class="pill" style="width:100%;">'
          + '<div style="flex:1 1 220px;">'
            + '<label><small>'+legend+' ‚Äî support du percement n¬∞'+(i+1)+'</small></label>'
            + '<select id="'+prefix+'-sup-'+i+'">'+opts+'</select>'
          + '</div>'
          + '<div style="flex:0 0 140px;">'
            + '<label><small>Quantit√© (nb de trous)</small></label>'
            + '<input id="'+prefix+'-qty-'+i+'" type="number" min="0" value="'+(p.qty||0)+'" />'
          + '</div>'
          + (i>0 ? b('√ó',mutFn+'('+JSON.stringify(key)+',"del",'+i+')','btn') : '')
        + '</div>'
      );
    }).join('');
    return rows + '<div class="row">'+ b('Ajouter un percement',mutFn+'('+JSON.stringify(key)+',"add")','btn') +'</div>';
  }

  // UI
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Cr√©ation</h2>'

      // ‚Äî Kit VMC (avec libell√©s)
      + '<div class="pill" style="margin:6px 0;"><strong>Kit VMC</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="kit-ref" placeholder="R√©f. du kit" value="'+st.kit.ref+'"/>'
      + '<div class="row">'
        + '<div style="flex:1 1 160px;">'
          + '<label>Nombre de bouches √ò80</label>'
          + '<input id="kit-d80" type="number" min="0" value="'+st.kit.d80+'"/>'
        + '</div>'
        + '<div style="flex:1 1 160px;">'
          + '<label>Nombre de bouches √ò125</label>'
          + '<input id="kit-d125" type="number" min="0" value="'+st.kit.d125+'"/>'
        + '</div>'
      + '</div>'
      + '<div style="margin-top:8px;">'+conduitsBlock(st.kit.conduits,"kitConduitMut","kitc","Kit VMC ‚Äî type de conduit")+'</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.kit.percements,"kitPercMut","kitp","Kit VMC")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter le Kit VMC','ventAddKit('+JSON.stringify(key)+')','btn primary') +'</div>'

      // ‚Äî Extracteur
      + '<hr style="margin:16px 0; border:none; border-top:1px solid var(--line);" />'
      + '<div class="pill" style="margin:6px 0;"><strong>Extracteur</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="ex-ref" placeholder="R√©f. de l‚Äôextracteur" value="'+st.extracteur.ref+'"/>'
      + '<label>Diam√®tre de raccord (mm)</label>'
      + '<select id="ex-diam">'+['80','100','125'].map(function(d){return '<option '+(d===st.extracteur.diam?'selected':'')+'>'+d+'</option>';}).join('')+'</select>'
      + '<div style="margin-top:8px;">'+conduitsBlock(st.extracteur.conduits,"exConduitMut","exc","Extracteur ‚Äî type de conduit")+'</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.extracteur.percements,"exPercMut","exp","Extracteur")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter l‚ÄôExtracteur','ventAddExtracteur('+JSON.stringify(key)+')','btn primary') +'</div>'

      // ‚Äî Ventilateur de conduit
      + '<hr style="margin:16px 0; border:none; border-top:1px solid var(--line);" />'
      + '<div class="pill" style="margin:6px 0;"><strong>Ventilateur de conduit</strong></div>'
      + '<label>R√©f√©rence (optionnel)</label>'
      + '<input id="vc-ref" placeholder="R√©f. du ventilateur" value="'+st.ventilateur.ref+'"/>'
      + '<div class="row">'
        + '<div style="flex:1 1 160px;">'
          + '<label>Diam√®tre de raccord (mm)</label>'
          + '<select id="vc-diam">'+['80','100','125','150'].map(function(d){return '<option '+(d===st.ventilateur.diam?'selected':'')+'>'+d+'</option>';}).join('')+'</select>'
        + '</div>'
        + '<div style="flex:1 1 240px;">'
          + '<label>Type de conduit utilis√©</label>'
          + '<select id="vc-type">'+['Gaine isol√©e','Conduit rigide','Conduit rigide extra-plat','Gaine non isol√©e'].map(function(t){return '<option '+(t===st.ventilateur.typeConduit?'selected':'')+'>'+t+'</option>';}).join('')+'</select>'
        + '</div>'
        + '<div style="flex:1 1 160px;">'
          + '<label>Longueur de conduit (m)</label>'
          + '<input id="vc-len" type="number" min="0" step="0.1" value="'+st.ventilateur.longueur+'"/>'
        + '</div>'
      + '</div>'
      + '<div style="margin-top:8px;">'+percementsBlock(st.ventilateur.percements,"vcPercMut","vcp","Ventilateur de conduit")+'</div>'
      + '<div class="row" style="margin-top:8px;">'+ b('Ajouter le Ventilateur de conduit','ventAddVentilateur('+JSON.stringify(key)+')','btn primary') +'</div>'
    + '</div>'
  );
}

/* Mutateurs listes (ajout/suppression) */
function kitConduitMut(key,cmd,idx){ var arr=ventState[key].creation.kit.conduits; if(cmd==="add") arr.push({type:"Gaine isol√©e"}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function kitPercMut(key,cmd,idx){ var arr=ventState[key].creation.kit.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function exConduitMut(key,cmd,idx){ var arr=ventState[key].creation.extracteur.conduits; if(cmd==="add") arr.push({type:"Gaine isol√©e"}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function exPercMut(key,cmd,idx){ var arr=ventState[key].creation.extracteur.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }
function vcPercMut(key,cmd,idx){ var arr=ventState[key].creation.ventilateur.percements; if(cmd==="add") arr.push({support:"Placo",qty:0}); if(cmd==="del") arr.splice(idx,1); pageVentCreation(key); }

/* Ajouts d‚Äôitems (on garde le m√™me niveau de d√©tail que pr√©c√©demment) */
function ventAddKit(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Kit VMC',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}
function ventAddExtracteur(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Extracteur',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}
function ventAddVentilateur(key){
  devis[key].items.push({category:'Ventilation/Cr√©ation',designation:'Ventilateur conduit',qty:1,prixU:0,__tabKey:key});
  saveLocal(); pageVentHome(key);
}

/* ============================
   Retirage des conduits
   ============================ */
function pageVentRetirage(key){
  ensureVentKey(key); var st=ventState[key].retirage;
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Retirage de conduits</h2>'
      + '<div class="row">'
        + '<div style="flex:1 1 200px;">'
          + '<label>Nombre de conduits √ò80 √† retirer</label>'
          + '<input id="rt-80" type="number" min="0" value="'+st.n80+'"/>'
        + '</div>'
        + '<div style="flex:1 1 200px;">'
          + '<label>Nombre de conduits √ò125 √† retirer</label>'
          + '<input id="rt-125" type="number" min="0" value="'+st.n125+'"/>'
        + '</div>'
      + '</div>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Ajouter le Retirage','ventAddRetirage('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function ventAddRetirage(key){
  var n80=pickNum('rt-80',0), n125=pickNum('rt-125',0);
  devis[key].items.push({
    category:'Ventilation/Retirage',
    designation:'Retirage √ò80='+n80+' / √ò125='+n125,
    qty:1, prixU:0, __tabKey:key
  });
  saveLocal(); pageVentHome(key);
}

/* ============================
   Entretien
   ============================ */
function pageVentEntretien(key){
  ensureVentKey(key); var st=ventState[key].entretien;
  view(
    '<div class="card">'
      + b('Retour','pageVentHome('+JSON.stringify(key)+')','btn back')
      + '<h2>Entretien</h2>'
      + '<label>√âl√©ment √† entretenir</label>'
      + '<select id="ent-type">'
        + ['Groupe VMC','Extracteur','Ventilateur de conduit'].map(function(t){ return '<option '+(t===st.type?'selected':'')+'>'+t+'</option>'; }).join('')
      + '</select>'
      + '<label style="margin-top:8px;">Nombre d‚Äôunit√©s</label>'
      + '<input id="ent-nb" type="number" min="0" value="'+st.nb+'"/>'
      + '<div class="row" style="margin-top:10px;">'
        + b('Ajouter Entretien','ventAddEntretien('+JSON.stringify(key)+')','btn primary')
      + '</div>'
    + '</div>'
  );
}
function ventAddEntretien(key){
  var type=pickVal('ent-type','Groupe VMC'), nb=pickNum('ent-nb',0);
  devis[key].items.push({
    category:'Ventilation/Entretien',
    designation:'Entretien '+type+' ‚Äî nb='+nb,
    qty:1, prixU:0, __tabKey:key
  });
  saveLocal(); pageVentHome(key);
}
</script>







  





<!-- =============================
     CHAPITRE 8 : PARAM√âTRAGE ‚Äî V10.2 (propre & unifi√©)
     Index :
       8.0 ‚Ä¢ Styles
       8.1 ‚Ä¢ Storage (Entreprise / Pr√©f√©rences)
       8.2 ‚Ä¢ Helpers
       8.3 ‚Ä¢ Accueil Param√©trage (pageParametrageAccueil)
       8.4 ‚Ä¢ Configuration entreprise (form)
       8.5 ‚Ä¢ Pr√©f√©rences devis & facturation (form)
       8.6 ‚Ä¢ Param√©trage avanc√© (JSON / d√©veloppeur)
       8.7 ‚Ä¢ Coefficients de pose (UI + stockage + computePU)
       8.8 ‚Ä¢ Expose (window)
     ============================= -->

<style>
  /* 8.0 ‚Äî Styles */
  .param-wrap .card{ margin-bottom:24px; }
  .param-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .muted{ color:var(--muted); }
  .row.gap8{ gap:8px; flex-wrap:wrap; }
  .subcard{ border:1px dashed var(--line); border-radius:10px; padding:10px; background:#fafafa; }
  .mb8{ margin-bottom:8px; }

  /* Coeffs de pose */
  .pose-card .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .pose-field{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px}
  .pose-field label{display:block;font-weight:600;margin-bottom:6px}
  .pose-note{color:var(--muted);font-size:14px}
</style>

<script>
/* =============================
   8.1 ‚Ä¢ Storage keys & defaults
   ============================= */
const KEY_ENTREPRISE_V1 = 'cfg_entreprise_v1';
const KEY_PREFS_V1      = 'prefs_devis_fact_v1';

function _entrepriseDefaults(){
  return {
    raison_sociale: '',
    siret: '',
    adresse: '',
    cp: '',
    ville: '',
    email: '',
    telephone: '',
    tva_percent: 20
  };
}
function _prefsDefaults(){
  return {
    mode_separe: true,          // afficher Pose + Fourniture s√©par√©es
    afficher_ttc: true,         // montrer HT/TTC dans exports/aper√ßu
    remise_defaut: 0,           // % remise par d√©faut
    conditions: '',             // conditions de r√®glement / d√©lais
    mentions: ''                // mentions l√©gales/garanties
  };
}

function getEntreprise(){
  try{ return JSON.parse(localStorage.getItem(KEY_ENTREPRISE_V1)||'null') || _entrepriseDefaults(); }
  catch(e){ return _entrepriseDefaults(); }
}
function setEntreprise(obj){
  const cur = getEntreprise();
  const out = Object.assign({}, cur, obj||{});
  try{ localStorage.setItem(KEY_ENTREPRISE_V1, JSON.stringify(out)); }catch(e){}
  return out;
}
function getPrefs(){
  try{ return JSON.parse(localStorage.getItem(KEY_PREFS_V1)||'null') || _prefsDefaults(); }
  catch(e){ return _prefsDefaults(); }
}
function setPrefs(obj){
  const cur = getPrefs();
  const out = Object.assign({}, cur, obj||{});
  try{ localStorage.setItem(KEY_PREFS_V1, JSON.stringify(out)); }catch(e){}
  return out;
}

/* =============================
   8.2 ‚Ä¢ Helpers
   ============================= */
function _esc(s){ return String(s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }
function _val(id){ var el=document.getElementById(id); return el ? el.value : ''; }
function _num(id){ var v=parseFloat((_val(id)||'').replace(',','.')); return isNaN(v)?0:v; }
</script>

<script>
/* =============================
   8.3 ‚Ä¢ Accueil Param√©trage
   ============================= */
function pageParametrageAccueil(){
  view(
    '<div class="param-wrap">'
    +  '<div class="card">'
    +    b('Retour','pageMain()','btn back')
    +    '<h2>Param√©trage</h2>'
    +    '<p class="muted">Centralisez tous vos r√©glages : tarifs de prestation, coordonn√©es entreprise, pr√©f√©rences de devis & facturation, coefficients de pose, et options avanc√©es.</p>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Catalogue prestation</h3>'
    +    '<div class="subcard mb8"><div class="muted">G√©rez les tarifs de pose par famille (Appareillage, Luminaires, Commandes, Circuit sp√©cialis√©‚Ä¶). Les modifications s‚Äôappliquent √† l‚Äôapplication, aux aper√ßus, aux exports et √† la duplication ‚Äúappliquer nouveaux tarifs‚Äù.</div></div>'
    +    '<div class="row gap8">'
    +      b('Ouvrir le catalogue prestation','pageCataloguePrestation ? pageCataloguePrestation() : alert(\"Module non charg√©.\")','btn')
    +    '</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Coefficients de pose</h3>'
    +    '<div class="subcard mb8"><div class="muted">Personnalisez les multiplicateurs appliqu√©s automatiquement aux <strong>Cr√©ations</strong> selon le type de pose (synchronis√©s avec ‚ÄúAjouter une pi√®ce‚Äù).</div></div>'
    +    '<div class="row gap8">'
    +      b('Ouvrir','pageParam_CoeffPose()','btn')
    +    '</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Configuration entreprise</h3>'
    +    '<div class="subcard mb8"><div class="muted">Renseignez vos informations l√©gales et de contact. Elles s‚Äôafficheront dans l‚Äôen-t√™te et les exports.</div></div>'
    +    '<div class="row gap8">'
    +      b('Ouvrir','pageConfigEntreprise()','btn')
    +    '</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Pr√©f√©rences devis & facturation</h3>'
    +    '<div class="subcard mb8"><div class="muted">Mode s√©par√© (pose vs fournitures), affichage HT/TTC, remise par d√©faut et textes (conditions, mentions).</div></div>'
    +    '<div class="row gap8">'
    +      b('Ouvrir','pagePrefsDevis()','btn')
    +    '</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Param√©trage avanc√© (JSON / d√©veloppeur)</h3>'
    +    '<div class="subcard mb8"><div class="muted">Exporter / importer / √©diter les blocs de configuration (entreprise, pr√©f√©rences, prestations, coefficients) en JSON.</div></div>'
    +    '<div class="row gap8">'
    +      b('Ouvrir','pageParamAvance()','btn')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );
}
</script>

<script>
/* =============================
   8.4 ‚Ä¢ Configuration entreprise
   ============================= */
function pageConfigEntreprise(){
  const e = getEntreprise();
  view(
    '<div class="param-wrap">'
    +  '<div class="card">'+b('Retour','pageParametrageAccueil()','btn back')+'<h2>Configuration entreprise</h2></div>'
    +  '<div class="card"><div class="param-grid">'
    +    '<div class="field"><label>Raison sociale</label><input id="e-rs" value="'+_esc(e.raison_sociale)+'"/></div>'
    +    '<div class="field"><label>SIRET</label><input id="e-siret" value="'+_esc(e.siret)+'"/></div>'
    +    '<div class="field"><label>Adresse</label><input id="e-adr" value="'+_esc(e.adresse)+'"/></div>'
    +    '<div class="field"><label>Code postal</label><input id="e-cp" value="'+_esc(e.cp)+'"/></div>'
    +    '<div class="field"><label>Ville</label><input id="e-ville" value="'+_esc(e.ville)+'"/></div>'
    +    '<div class="field"><label>Email</label><input id="e-mail" value="'+_esc(e.email)+'"/></div>'
    +    '<div class="field"><label>T√©l√©phone</label><input id="e-tel" value="'+_esc(e.telephone)+'"/></div>'
    +    '<div class="field"><label>TVA (%)</label><input id="e-tva" type="number" inputmode="decimal" step="0.1" value="'+(+e.tva_percent||0)+'"/></div>'
    +  '</div>'
    +  '<div class="row gap8" style="margin-top:10px;">'
    +    b('Enregistrer','saveEntreprise()','btn primary')
    +  '</div></div>'
    +'</div>'
  );
}
function saveEntreprise(){
  setEntreprise({
    raison_sociale: _val('e-rs'),
    siret: _val('e-siret'),
    adresse: _val('e-adr'),
    cp: _val('e-cp'),
    ville: _val('e-ville'),
    email: _val('e-mail'),
    telephone: _val('e-tel'),
    tva_percent: Math.max(0, _num('e-tva'))
  });
  alert('Informations enregistr√©es.');
  pageConfigEntreprise();
}
</script>

<script>
/* =============================
   8.5 ‚Ä¢ Pr√©f√©rences devis & facturation
   ============================= */
function pagePrefsDevis(){
  const p = getPrefs();
  view(
    '<div class="param-wrap">'
    +  '<div class="card">'+b('Retour','pageParametrageAccueil()','btn back')+'<h2>Pr√©f√©rences devis & facturation</h2></div>'
    +  '<div class="card"><div class="param-grid">'
    +    '<div class="field"><label><input id="pf-sep" type="checkbox" '+(p.mode_separe?'checked':'')+'/> Mode s√©par√© (pose + fournitures)</label></div>'
    +    '<div class="field"><label><input id="pf-ttc" type="checkbox" '+(p.afficher_ttc?'checked':'')+'/> Afficher HT / TTC</label></div>'
    +    '<div class="field"><label>Remise par d√©faut (%)</label><input id="pf-rem" type="number" step="0.1" inputmode="decimal" value="'+(+p.remise_defaut||0)+'"/></div>'
    +  '</div>'
    +  '<div class="field" style="margin-top:10px;"><label>Conditions</label><textarea id="pf-cond" rows="4">'+_esc(p.conditions)+'</textarea></div>'
    +  '<div class="field" style="margin-top:10px;"><label>Mentions</label><textarea id="pf-men" rows="4">'+_esc(p.mentions)+'</textarea></div>'
    +  '<div class="row gap8" style="margin-top:10px;">'
    +    b('Enregistrer','savePrefs()','btn primary')
    +  '</div></div>'
    +'</div>'
  );
}
function savePrefs(){
  setPrefs({
    mode_separe: !!document.getElementById('pf-sep').checked,
    afficher_ttc: !!document.getElementById('pf-ttc').checked,
    remise_defaut: Math.max(0, _num('pf-rem')),
    conditions: _val('pf-cond'),
    mentions: _val('pf-men')
  });
  alert('Pr√©f√©rences enregistr√©es.');
  pagePrefsDevis();
}
</script>

<script>
/* =============================
   8.6 ‚Ä¢ Param√©trage avanc√© (JSON / d√©veloppeur)
   ============================= */
function pageParamAvance(){
  const packs = {
    entreprise: getEntreprise(),
    preferences: getPrefs(),
    prestations: (typeof getPrestations==='function') ? getPrestations() : '(module non charg√©)',
    coeffs_pose: (typeof getPoseCoeffMap==='function') ? getPoseCoeffMap() : '(module non charg√©)'
  };
  const pretty = _esc(JSON.stringify(packs, null, 2));

  view(
    '<div class="param-wrap">'
    +  '<div class="card">'+b('Retour','pageParametrageAccueil()','btn back')+'<h2>Param√©trage avanc√© (JSON / d√©veloppeur)</h2></div>'
    +  '<div class="card">'
    +    '<div class="subcard mb8"><div class="muted">Attention : toute erreur de JSON peut casser le chargement. Sauvegardez avant import. Vous pouvez exporter pour backup.</div></div>'
    +    '<div class="row gap8">'
    +      b('Exporter la configuration','paramAdvExport()','btn')
    +      b('Importer une configuration','paramAdvImport()','btn')
    +    '</div>'
    +  '</div>'
    +  '<div class="card">'
    +    '<h3>Visualisation</h3>'
    +    '<textarea id="adv-json" rows="18" style="width:100%; font-family:monospace;">'+pretty+'</textarea>'
    +    '<div class="row gap8" style="margin-top:10px;">'
    +      b('√âcraser depuis l‚Äô√©diteur','paramAdvApply()','btn')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );
}
function _bundleAll(){
  const bundle = {
    entreprise: getEntreprise(),
    preferences: getPrefs()
  };
  if(typeof getPrestations==='function') bundle.prestations = getPrestations();
  if(typeof getPoseCoeffMap==='function') bundle.coeffs_pose = getPoseCoeffMap();
  return bundle;
}
function paramAdvExport(){
  const raw = JSON.stringify(_bundleAll(), null, 2);
  const blob = new Blob([raw], {type:'application/json;charset=utf-8'});
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='parametrage_bundle.json'; a.click();
  URL.revokeObjectURL(url);
}
function paramAdvImport(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = function(){
    const f = input.files && input.files[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload = function(){
      try{
        const data = JSON.parse(rd.result||'{}');
        if(data.entreprise) setEntreprise(data.entreprise);
        if(data.preferences) setPrefs(data.preferences);
        if(data.prestations && typeof setPrestations==='function') setPrestations(data.prestations);
        if(data.coeffs_pose && typeof setPoseCoeffMap==='function') setPoseCoeffMap(data.coeffs_pose);
        alert('Configuration import√©e.');
        pageParamAvance();
      }catch(e){ alert('Import impossible : '+e.message); }
    };
    rd.readAsText(f,'utf-8');
  };
  input.click();
}
function paramAdvApply(){
  const txt = (document.getElementById('adv-json')||{}).value||'';
  try{
    const data = JSON.parse(txt);
    if(data.entreprise) setEntreprise(data.entreprise);
    if(data.preferences) setPrefs(data.preferences);
    if(data.prestations && typeof setPrestations==='function') setPrestations(data.prestations);
    if(data.coeffs_pose && typeof setPoseCoeffMap==='function') setPoseCoeffMap(data.coeffs_pose);
    alert('Configuration appliqu√©e.');
    pageParamAvance();
  }catch(e){
    alert('JSON invalide : '+e.message);
  }
}
</script>

<script>
/* =============================
   8.7 ‚Ä¢ Coefficients de pose (UI + stockage + computePU)
   ============================= */
const KEY_POSE_COEFFS = 'poseCoeffs_v1';
function _readJsonLS8(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function _writeJsonLS8(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

function _getPoseListFromApp(){
  if (Array.isArray(window.POSES) && window.POSES.length) return JSON.parse(JSON.stringify(window.POSES));
  return ['Apparent','Encastr√© placo','Encastr√© ma√ßonnerie','Goulotte'];
}
function getPoseCoeffMap(){
  const poses = _getPoseListFromApp();
  const cur   = _readJsonLS8(KEY_POSE_COEFFS, {});
  let changed = false;
  poses.forEach(p=>{ if(typeof cur[p] !== 'number'){ cur[p]=1; changed=true; }});
  Object.keys(cur).forEach(k=>{ if(poses.indexOf(k)===-1){ delete cur[k]; changed=true; }});
  if(changed) _writeJsonLS8(KEY_POSE_COEFFS, cur);
  return cur;
}
function setPoseCoeffMap(map){
  const clean = {};
  Object.keys(map||{}).forEach(k=>{ const v=+map[k]; clean[k]=isNaN(v)?1:Math.max(0,v); });
  _writeJsonLS8(KEY_POSE_COEFFS, clean);
}
function getPoseCoeff(name){ const map=getPoseCoeffMap(); return (typeof map[name]==='number')? map[name]:1; }
function setPoseCoeff(name, value){
  const map=getPoseCoeffMap(); map[name]=Math.max(0, +value||1); _writeJsonLS8(KEY_POSE_COEFFS, map);
}

function pageParam_CoeffPose(){
  const poses = _getPoseListFromApp();
  const map   = getPoseCoeffMap();
  const fields = poses.map(p=>{
    const id='pc_'+p.replace(/\s+/g,'_');
    return '<div class="pose-field">'
         +   '<label>'+_esc(p)+'</label>'
         +   '<input id="'+id+'" type="number" step="0.01" inputmode="decimal" value="'+(+map[p]).toFixed(2)+'" />'
         +   '<div class="pose-note">1.00 = neutre ‚Ä¢ &gt;1 = + cher ‚Ä¢ &lt;1 = - cher</div>'
         + '</div>';
  }).join('');
  view(
    '<div class="card">'+b('Retour','pageParametrageAccueil()','btn back')+'<h2>Coefficients de pose</h2>'
    +'<p class="pose-note">Synchronis√©s automatiquement avec les types de pose utilis√©s dans ‚ÄúAjouter une pi√®ce‚Äù.</p></div>'
    +'<div class="card pose-card"><div class="grid">'+fields+'</div>'
    +'<div class="row" style="margin-top:12px;gap:8px;flex-wrap:wrap;">'
      + b('üíæ Enregistrer','saveParam_CoeffPose()','btn primary')
      + b('‚Ü∫ Remettre √† 1.00','resetParam_CoeffPose()','btn')
    +'</div></div>'
  );
}
function saveParam_CoeffPose(){
  const poses=_getPoseListFromApp(); const map={};
  poses.forEach(p=>{
    const id='pc_'+p.replace(/\s+/g,'_'); const el=document.getElementById(id);
    map[p]=Math.max(0, parseFloat((el&&el.value)||'1')||1);
  });
  setPoseCoeffMap(map);
  alert('‚úÖ Coefficients enregistr√©s.');
}
function resetParam_CoeffPose(){
  if(!confirm('Remettre tous les coefficients de pose √† 1.00 ?')) return;
  const poses=_getPoseListFromApp(); const map={}; poses.forEach(p=>map[p]=1);
  setPoseCoeffMap(map); pageParam_CoeffPose();
}

/* Wrap computePU une seule fois */
(function wirePoseIntoCompute(){
  const oldCompute = window.computePU;
  window.computePU = function(category, designation, intervention, pose, section){
    let base = 0;
    if (typeof oldCompute==='function') base = +oldCompute(category, designation, intervention, pose, section) || 0;
    else {
      // Fallback minimal si computePU n‚Äôexistait pas
      const TB = (typeof window.TARIFS_BASE === 'object') ? window.TARIFS_BASE : {};
      function pick(obj,k){ return (obj&&typeof obj==='object')? obj[k]:undefined; }
      let ref;
      if(category==='Prises'){ ref = pick(TB.prises, designation); }
      else if(category==='√âclairage/Luminaires' || category==='√âclairage / Luminaires'){ ref = pick(TB.eclairage, designation); }
      else if(category==='√âclairage/Commandes' || category==='√âclairage / Commandes'){ ref = pick(TB.eclairage, designation); }
      else if(category==='Circuit sp√©cialis√©' || category==='Circuit specialise'){ ref = pick(TB.circuit_specialise, designation); }
      base = (ref && typeof ref==='object') ? (+ref[intervention]||0) : 0;
    }
    if (String(intervention)==='Cr√©ation' && pose){
      const k = getPoseCoeff(pose) || 1;
      let out = base * k;
      if(typeof window.roundUp5==='function') out = roundUp5(out);
      return out;
    }
    return base;
  };
})();
</script>

<script>
/* =============================
   8.8 ‚Ä¢ Expose (window)
   ============================= */
Object.assign(window, {
  pageParametrageAccueil,
  pageConfigEntreprise,
  pagePrefsDevis,
  pageParamAvance,
  // Coeffs de pose
  pageParam_CoeffPose,
  saveParam_CoeffPose,
  resetParam_CoeffPose,
  getPoseCoeffMap,
  setPoseCoeffMap,
  getPoseCoeff,
  setPoseCoeff
});
</script>







  




<!-- =============================
     CHAPITRE 9 : MODIFICATIONS DE TABLEAU
     Index :
       9.0 ‚Ä¢ Styles + Tarifs + Constantes
       9.1 ‚Ä¢ Injection bouton (apr√®s ‚ÄúCr√©ation tableau‚Äù dans le menu principal)
       9.2 ‚Ä¢ Accueil ‚ÄúModifications de Tableau‚Äù
       9.3 ‚Ä¢ √âcran unique : D√©placement + (√† la suite) Remplacement coffret
       9.4 ‚Ä¢ Rec√¢blage tableau existant (remplacement coffret + circuits + mat√©riel suppl.)
       9.5 ‚Ä¢ Expose (window)
     ============================= -->

<style>
  .mtx { margin-top:14px; }
  .mbx { margin-bottom:14px; }
  .vblock { display:block; margin-top:10px; }
  .fieldset {
    border:1px solid var(--line); background:#fff;
    border-radius:10px; padding:12px; margin-top:10px;
  }
  .fieldset h3 { margin:0 0 8px; font-size:16px; }
  .pill.small{ padding:6px 10px; font-size:14px; }
  .row.gap8{ gap:8px; flex-wrap:wrap; }
  .list-plain{ display:flex; flex-direction:column; gap:6px; }
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<script>
// =============================
// ¬ß9.0 ‚Ä¢ Tarifs + constantes
// =============================
window.TARIFS_TABMODS = window.TARIFS_TABMODS || {
  deplacement: {
    par_circuit: 20,          // ‚Ç¨ / circuit √† rallonger
    boite_base: 50,           // ‚Ç¨ base pour la bo√Æte (si ‚â† "N√©ant")
    boite_par_circuit: 10,    // ‚Ç¨ additionnels par circuit (si ‚â† "N√©ant")
    goulotte_base: 50,        // ‚Ç¨ base pour la goulotte
    goulotte_par_m: 20        // ‚Ç¨ / m√®tre
  },
  recablage: {
    par_circuit: 10,          // ‚Ç¨ / circuit √† rec√¢bler
    // Mat√©riel suppl. (prix unitaires par d√©faut ‚Äî modifiables dans le code)
    materiel: {
      "Disjoncteur modulaire": 18,
      "Inter diff 30mA": 65,
      "Peigne d‚Äôalimentation": 12,
      "Bornier": 8,
      "Contacteur J/N": 42
    }
  }
};

// Libell√©s bo√Ætes d√©rivation propos√©es (d√©placement)
const TABMODS_BOITES = [
  { id:'NONE', label:'N√©ant' },
  { id:'100x150', label:'Bo√Æte 100√ó150' },
  { id:'150x200', label:'Bo√Æte 150√ó200' },
  { id:'200x250', label:'Bo√Æte 200√ó250' },
  { id:'300x350', label:'Bo√Æte 300√ó350' }
];

// Choix (rapides) pour Remplacement Coffret
const TABMODS_COFFRET_GAMMES = [
  'Schneider Resi9','Schneider Acti9','Legrand (r√©sidentiel)','Hager (r√©sidentiel)','Hager (tertiaire)'
];
const TABMODS_COFFRET_MODULES = ['13 modules','18 modules','24 modules'];
const TABMODS_COFFRET_RANGES = [1,2,3,4];

// Dossier de rangement pour le devis
const TABMODS_SECTION_KEY = 'Tableau & distribution';
function ensureTabModsSection(){
  if(!devis[TABMODS_SECTION_KEY]){
    devis[TABMODS_SECTION_KEY] = { __base:'Tableau & distribution', items:[], note:'' };
  }
}

// ========================================================
// ¬ß9.1 ‚Ä¢ Injection bouton APRES ‚ÄúCr√©ation tableau‚Äù (menu)
// ========================================================
(function(){
  const _old = window.pageHome;
  window.pageHome = function(){
    if(typeof _old === 'function') _old();
    const app=document.getElementById('app');
    if(!app) return;
    if(app.innerHTML.indexOf('pageTabModsAccueil()')!==-1) return;

    // priorit√© : ins√©rer juste APR√àS le bouton de cr√©ation de tableau
    // on cherche un onclick de pageTabCreate() et on ins√®re derri√®re
    const btn = '<button class="btn" onclick="pageTabModsAccueil()">Modifications de Tableau</button>';
    let html = app.innerHTML;

    // insertion ‚Äúpropre‚Äù apr√®s un bouton qui appelle pageTabCreate()
    const reBtnCreate = /(<button[^>]+onclick="[^"]*pageTabCreate\(\)[^"]*"[^>]*>[\s\S]*?<\/button>)/i;
    if(reBtnCreate.test(html)){
      app.innerHTML = html.replace(reBtnCreate, '$1'+btn);
      return;
    }
    // fallback : apr√®s le mot ‚ÄúTableau‚Äù si le bouton est textuel
    const reWord = /(Cr√©ation\s*tableau|Tableau\s+nouveau)/i;
    if(reWord.test(html)){
      app.innerHTML = html.replace(reWord, '$1</button>'+btn);
      return;
    }
    // dernier fallback : on ajoute en fin de la premi√®re ligne de boutons
    app.innerHTML = html.replace(/(<div class="row"[^>]*>)/, '$1'+btn);
  };
})();

// ==========================================
// ¬ß9.2 ‚Ä¢ Accueil ‚ÄúModifications de Tableau‚Äù
// ==========================================
function pageTabModsAccueil(){
  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>Modifications de Tableau</h2>'
      + '<div class="row mtx" style="gap:8px;">'
        + b('D√©placement + Remplacement coffret (m√™me √©cran)','pageTabModsDeplacement()','btn primary')
        + b('Rec√¢blage tableau existant','pageTabModsRecablage()','btn')
      + '</div>'
    + '</div>'
  );
}

// =====================================================================
// ¬ß9.3 ‚Ä¢ √âcran UNIQUE : D√©placement + (√† la suite) Remplacement coffret
// =====================================================================
function pageTabModsDeplacement(){
  const t = TARIFS_TABMODS.deplacement || {};
  const circuits = Array.from({length:31},(_,i)=>`<option value="${i}">${i}</option>`).join('');
  const boites = TABMODS_BOITES.map(b=>`<option value="${b.id}">${b.label}</option>`).join('');

  const gammes = ['Aucun'].concat(TABMODS_COFFRET_GAMMES).map(x=>`<option value="${x}">${x}</option>`).join('');
  const modules = TABMODS_COFFRET_MODULES.map(x=>`<option value="${x}">${x}</option>`).join('');
  const ranges = TABMODS_COFFRET_RANGES.map(x=>`<option value="${x}">${x} rang√©e(s)</option>`).join('');

  view(
    '<div class="card">'
      + b('Retour','pageTabModsAccueil()','btn back')
      + '<h2>D√©placement de tableau</h2>'

      + '<div class="fieldset">'
        + '<h3>1) Nombre de circuits √† rallonger</h3>'
        + '<select id="mt-circuits">'+circuits+'</select>'
        + '<small class="muted vblock">Tarif : '+euro(+t.par_circuit||20)+' / circuit</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>2) Cr√©ation d‚Äôune bo√Æte de d√©rivation</h3>'
        + '<select id="mt-boite">'+boites+'</select>'
        + '<small class="muted vblock">Base : '+euro(+t.boite_base||50)+' + '+euro(+t.boite_par_circuit||10)+' / circuit (si bo√Æte ‚â† N√©ant)</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>3) Longueur de goulotte</h3>'
        + '<input id="mt-goulotte" type="number" step="0.1" min="0" value="0" inputmode="decimal" />'
        + '<small class="muted vblock">Base : '+euro(+t.goulotte_base||50)+' + '+euro(+t.goulotte_par_m||20)+' / m√®tre</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>4) Remplacement coffret (facultatif)</h3>'
        + '<label class="vblock">Marque / Gamme</label>'
        + '<select id="rc-gamme">'+gammes+'</select>'
        + '<label class="vblock">Modules par rang√©e</label>'
        + '<select id="rc-mod">'+modules+'</select>'
        + '<label class="vblock">Nombre de rang√©es</label>'
        + '<select id="rc-range">'+ranges+'</select>'
        + '<label class="vblock">Type de pose</label>'
        + '<select id="rc-pose"><option>Saillie</option><option>Encastr√©</option></select>'
        + '<small class="muted vblock">Estimation simple : base + rang√©es √ó modules, coef encastr√©.</small>'
      + '</div>'

      + '<div id="mt-preview" class="muted mtx"></div>'

      + '<div class="row mtx" style="gap:8px;">'
        + b('Ajouter la modification','addTabMod_Deplacement()','btn primary')
      + '</div>'
    + '</div>'
  );

  ['mt-circuits','mt-boite','mt-goulotte','rc-gamme','rc-mod','rc-range','rc-pose'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('input', refreshMtPreview);
  });
  refreshMtPreview();
}

function calcDeplacementTotal(nbCircuits, boiteId, lgM){
  const t = TARIFS_TABMODS.deplacement || {};
  const parCircuit = +t.par_circuit || 20;
  const bBase = (boiteId==='NONE') ? 0 : (+t.boite_base || 50);
  const bPerC = (boiteId==='NONE') ? 0 : (+t.boite_par_circuit || 10);
  const gBase = +t.goulotte_base || 50;
  const gPerM = +t.goulotte_par_m || 20;
  return roundUp5(nbCircuits*parCircuit + bBase + nbCircuits*bPerC + gBase + (Math.max(0,+lgM)*gPerM));
}
function calcRemplacementCoffretTotal(rang, modTxt, pose){
  const m = /(\d+)/.exec(modTxt||''); const mod = m? +m[1] : 13;
  const basePrix=100, coefPose=(pose==='Encastr√©'?1.7:1);
  return roundUp5(basePrix*coefPose*( (+rang||1) * (mod/13) ));
}

function refreshMtPreview(){
  const n  = +document.getElementById('mt-circuits').value || 0;
  const b  = document.getElementById('mt-boite').value;
  const lm = +document.getElementById('mt-goulotte').value || 0;

  const gamme = document.getElementById('rc-gamme').value;
  const mod   = document.getElementById('rc-mod').value;
  const rang  = (document.getElementById('rc-range').value||'').replace(/\D/g,'')||'1';
  const pose  = document.getElementById('rc-pose').value;

  const lblBoite = (b==='NONE') ? 'Aucune bo√Æte' : (TABMODS_BOITES.find(x=>x.id===b)?.label || b);
  const t1 = calcDeplacementTotal(n,b,lm);
  let recap = `R√©cap d√©placement : ${n} circuit(s) ‚Äî ${lblBoite} ‚Äî goulotte ${lm.toFixed(1)} m ‚Üí <strong>${euro(t1)}</strong>`;

  if(gamme && gamme!=='Aucun'){
    const t2 = calcRemplacementCoffretTotal(+rang, mod, pose);
    recap += `<br>Remplacement coffret : ${rang} rang√©e(s) ‚Äî ${mod} ‚Äî ${gamme} ‚Äî Pose ${pose} ‚Üí <strong>${euro(t2)}</strong>`;
  }else{
    recap += `<br>Remplacement coffret : <em>non s√©lectionn√©</em>`;
  }

  document.getElementById('mt-preview').innerHTML = recap;
}

function addTabMod_Deplacement(){
  const n  = +document.getElementById('mt-circuits').value || 0;
  const b  = document.getElementById('mt-boite').value;
  const lm = +document.getElementById('mt-goulotte').value || 0;
  const lbl = (b==='NONE') ? 'Aucune bo√Æte' : (TABMODS_BOITES.find(x=>x.id===b)?.label || b);
  const totalDep = calcDeplacementTotal(n,b,lm);

  const gamme = document.getElementById('rc-gamme').value;
  const mod   = document.getElementById('rc-mod').value;
  const rang  = (document.getElementById('rc-range').value||'').replace(/\D/g,'')||'1';
  const pose  = document.getElementById('rc-pose').value;

  ensureTabModsSection();
  // Ligne 1 : D√©placement
  devis[TABMODS_SECTION_KEY].items.push({
    category:'Modification emplacement Tableau',
    designation:`Circuits √† rallonger : ${n} ‚Äî Bo√Æte : ${lbl} ‚Äî Goulotte : ${lm.toFixed(1)} m`,
    qty:1, prixU:totalDep
  });

  // Ligne 2 (facultative) : Remplacement coffret
  if(gamme && gamme!=='Aucun'){
    const totalCof = calcRemplacementCoffretTotal(+rang, mod, pose);
    devis[TABMODS_SECTION_KEY].items.push({
      category:'Remplacement coffret',
      designation:`${gamme} ‚Äî ${rang} rang√©e(s) √ó ${mod} ‚Äî Pose ${pose}`,
      qty:1, prixU:totalCof
    });
  }

  saveLocal();
  alert('‚úÖ Modification ajout√©e √† l‚Äôestimatif.');
  pageTabModsAccueil();
}

// =============================================================
// ¬ß9.4 ‚Ä¢ Rec√¢blage tableau existant
//   - Remplacement coffret (sans ‚Äúd√©pose existant‚Äù)
//   - Nb de circuits √† rec√¢bler (10‚Ç¨ / u)
//   - Mat√©riel suppl√©mentaire (s√©lecteur multi-lignes)
// =============================================================
let _recab_suppl = []; // { type, qty, pu }

function pageTabModsRecablage(){
  const marques = ['Aucun'].concat(TABMODS_COFFRET_GAMMES).map(m=>`<option value="${m}">${m}</option>`).join('');
  const modules = TABMODS_COFFRET_MODULES.map(m=>`<option value="${m}">${m}</option>`).join('');
  const ranges  = TABMODS_COFFRET_RANGES.map(r=>`<option value="${r}">${r} rang√©e(s)</option>`).join('');
  const circuits = Array.from({length:31},(_,i)=>`<option value="${i}">${i}</option>`).join('');

  const MAT = TARIFS_TABMODS.recablage.materiel || {};
  const types = Object.keys(MAT);
  const typeOptions = types.map(t=>`<option value="${t}">${t}</option>`).join('');

  // tableau lignes mat√©rielles actuelles
  function tableSuppl(){
    if(!_recab_suppl.length) return '<div class="muted">Aucun mat√©riel ajout√©.</div>';
    const rows = _recab_suppl.map((it,i)=>(
      `<tr>
        <td>${it.type}</td>
        <td style="text-align:right">${(+it.pu||0).toFixed(2)} ‚Ç¨</td>
        <td style="text-align:right">${(+it.qty||0)}</td>
        <td style="text-align:right">${(+it.pu*(+it.qty)).toFixed(2)} ‚Ç¨</td>
        <td>${b('√ó','recabDel('+i+')','btn')}</td>
      </tr>`
    )).join('');
    return `<table class="table-mini">
      <thead><tr><th>√âl√©ment</th><th>PU</th><th>Qt√©</th><th>Total</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  }

  view(
    '<div class="card">'
      + b('Retour','pageTabModsAccueil()','btn back')
      + '<h2>Rec√¢blage tableau existant</h2>'

      + '<div class="fieldset">'
        + '<h3>1) Remplacement coffret (facultatif)</h3>'
        + '<label class="vblock">Marque / Gamme</label>'
        + '<select id="rb-gamme">'+marques+'</select>'
        + '<label class="vblock">Modules par rang√©e</label>'
        + '<select id="rb-mod">'+modules+'</select>'
        + '<label class="vblock">Nombre de rang√©es</label>'
        + '<select id="rb-range">'+ranges+'</select>'
        + '<label class="vblock">Type de pose</label>'
        + '<select id="rb-pose"><option>Saillie</option><option>Encastr√©</option></select>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>2) Circuits √† rec√¢bler</h3>'
        + '<select id="rb-circuits">'+circuits+'</select>'
        + '<small class="muted vblock">Tarif : '+euro(+TARIFS_TABMODS.recablage.par_circuit||10)+' / circuit</small>'
      + '</div>'

      + '<div class="fieldset">'
        + '<h3>3) Mat√©riel suppl√©mentaire</h3>'
        + '<div class="row gap8">'
          + '<select id="rb-type">'+typeOptions+'</select>'
          + '<input id="rb-pu" type="number" inputmode="decimal" step="0.1" min="0" placeholder="PU (‚Ç¨)" />'
          + '<input id="rb-qty" type="number" inputmode="numeric" step="1" min="1" value="1" placeholder="Qt√©" />'
          + b('Ajouter','recabAdd()','btn')
        + '</div>'
        + '<div id="rb-table" class="mtx">'+tableSuppl()+'</div>'
      + '</div>'

      + '<div id="rb-preview" class="muted mtx"></div>'
      + '<div class="row mtx" style="gap:8px;">'
        + b('Ajouter au devis','addTabMod_Recablage()','btn primary')
      + '</div>'
    + '</div>'
  );

  // init champs PU auto
  const sel = document.getElementById('rb-type');
  const puIn = document.getElementById('rb-pu');
  const setDefaultPU = ()=>{ const k = sel.value; const d = (TARIFS_TABMODS.recablage.materiel||{})[k]||0; puIn.value = (+d||0).toFixed(2); };
  if(sel){ sel.addEventListener('change', setDefaultPU); setDefaultPU(); }

  ['rb-gamme','rb-mod','rb-range','rb-pose','rb-circuits'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('input', refreshRecabPreview);
  });
  refreshRecabPreview();

  // expose handlers locaux
  window.recabAdd = function(){
    const type = (document.getElementById('rb-type')?.value||'').trim();
    const pu   = parseFloat(document.getElementById('rb-pu')?.value)||0;
    const qty  = parseInt(document.getElementById('rb-qty')?.value,10)||1;
    if(!type || pu<=0 || qty<=0) return;
    _recab_suppl.push({type, pu:+pu, qty:+qty});
    pageTabModsRecablage();
  };
  window.recabDel = function(i){
    _recab_suppl.splice(i,1);
    pageTabModsRecablage();
  };
}

function calcRecabCoffret(gamme, rang, modTxt, pose){
  if(!gamme || gamme==='Aucun') return 0;
  return calcRemplacementCoffretTotal(+rang, modTxt, pose);
}
function calcRecabCircuits(n){ return roundUp5( ( +TARIFS_TABMODS.recablage.par_circuit || 10 ) * Math.max(0,+n) ); }
function calcRecabSupplTotal(){
  return roundUp5((_recab_suppl||[]).reduce((s,it)=> s + ((+it.pu||0)*(+it.qty||0)), 0));
}

function refreshRecabPreview(){
  const gamme = document.getElementById('rb-gamme')?.value || 'Aucun';
  const mod   = document.getElementById('rb-mod')?.value || '13 modules';
  const rang  = (document.getElementById('rb-range')?.value||'1').replace(/\D/g,'')||'1';
  const pose  = document.getElementById('rb-pose')?.value || 'Saillie';
  const n     = +document.getElementById('rb-circuits')?.value || 0;

  const tCof = calcRecabCoffret(gamme, rang, mod, pose);
  const tCir = calcRecabCircuits(n);
  const tSup = calcRecabSupplTotal();
  const total = roundUp5(tCof + tCir + tSup);

  document.getElementById('rb-preview').innerHTML =
    `Rempl. coffret : ${(gamme==='Aucun')?'‚Äî':`${rang} rang√©e(s) ‚Äî ${mod} ‚Äî ${gamme} ‚Äî Pose ${pose} ‚Üí <strong>${euro(tCof)}</strong>`}`
    + `<br>Circuits √† rec√¢bler : ${n} ‚Üí <strong>${euro(tCir)}</strong>`
    + `<br>Mat√©riel suppl√©mentaire : <strong>${euro(tSup)}</strong>`
    + `<br>Total estim√© : <strong>${euro(total)}</strong>`;
}

function addTabMod_Recablage(){
  const gamme = document.getElementById('rb-gamme')?.value || 'Aucun';
  const mod   = document.getElementById('rb-mod')?.value || '13 modules';
  const rang  = (document.getElementById('rb-range')?.value||'1').replace(/\D/g,'')||'1';
  const pose  = document.getElementById('rb-pose')?.value || 'Saillie';
  const n     = +document.getElementById('rb-circuits')?.value || 0;

  ensureTabModsSection();

  // (a) Remplacement coffret (si choisi)
  if(gamme && gamme!=='Aucun'){
    const tCof = calcRecabCoffret(gamme, rang, mod, pose);
    devis[TABMODS_SECTION_KEY].items.push({
      category:'Rec√¢blage tableau existant ‚Äî Remplacement coffret',
      designation:`${gamme} ‚Äî ${rang} rang√©e(s) √ó ${mod} ‚Äî Pose ${pose}`,
      qty:1, prixU:tCof
    });
  }
  // (b) Circuits √† rec√¢bler
  const tCir = calcRecabCircuits(n);
  devis[TABMODS_SECTION_KEY].items.push({
    category:'Rec√¢blage tableau existant ‚Äî Circuits',
    designation:`Nombre de circuits √† rec√¢bler : ${n}`,
    qty:1, prixU:tCir
  });
  // (c) Mat√©riel suppl√©mentaire (lignes d√©taill√©es)
  (_recab_suppl||[]).forEach(it=>{
    devis[TABMODS_SECTION_KEY].items.push({
      category:'Rec√¢blage tableau existant ‚Äî Mat√©riel suppl.',
      designation:`${it.type}`,
      qty:+it.qty||1, prixU:+it.pu||0
    });
  });

  saveLocal();
  _recab_suppl = [];
  alert('‚úÖ Rec√¢blage ajout√© √† l‚Äôestimatif.');
  pageTabModsAccueil();
}

// =======================
// ¬ß9.5 ‚Ä¢ Expose (window)
// =======================
Object.assign(window,{
  pageTabModsAccueil,
  pageTabModsDeplacement,
  pageTabModsRecablage,
  addTabMod_Deplacement,
  addTabMod_Recablage
});
</script>


  









  

<!-- =============================
     CHAPITRE 10 : FACTURATION (export .txt)
     - G√©n√®re une facture texte
     - Mode 's√©par√©' : (v1) pas de d√©composition mat√©riel ‚Üí tout en Prestations
     - Bouton inject√© sur Estimatif & Totaux
     ============================= -->
<script>
/* ==== Helpers prefs/entreprise ==== */
function _getPrefsSafe(){
  try{ return JSON.parse(localStorage.getItem('appPrefs_v1')||'null') || {}; }catch(e){ return {}; }
}
function _getCompanySafe(){
  try{ return JSON.parse(localStorage.getItem('companyConfig_v1')||'null') || {}; }catch(e){ return {}; }
}
function _fmtEuro(n, sym){ var s = (sym || '‚Ç¨').trim(); return (+(n||0)).toFixed(2)+' '+s; }
function _todayFR(){ try{ return new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit'}); }catch(e){ return new Date().toLocaleDateString(); } }

/* ==== Totaliseur devis courant ==== */
function _totalGlobalDevis(){
  var sum = 0;
  for (var key in devis){
    if(key.indexOf('__')===0) continue;
    var s = devis[key]; var items = (s&&s.items)||[];
    for (var i=0;i<items.length;i++){
      var it=items[i]; sum += ((+it.prixU||0) * (+it.qty||0));
    }
  }
  return sum;
}

/* ==== G√©n√©ration du corps de facture (TXT) ==== */
function buildInvoiceText(){
  var prefs = _getPrefsSafe();
  var company = _getCompanySafe();
  var devise = prefs.devise || '‚Ç¨';

  var modeSepare = (prefs.facturation_mode === 'separe');

  var totalHT = _totalGlobalDevis(); // Montant HT global (tout compris)
  var totalPrest = totalHT; // v1 : sans d√©composition, on impute 100% en prestations
  var totalMat   = 0;

  var tvaOn   = !!prefs.tva_applicable;
  var tauxTVA = Math.max(0, +prefs.taux_tva || 20);
  var tvaPrest= tvaOn ? (totalPrest * tauxTVA/100) : 0;
  var tvaMat  = tvaOn ? (totalMat   * tauxTVA/100) : 0;

  // En-t√™te soci√©t√© / facture
  var header = [];
  header.push('================= FACTURE (brouillon) =================');
  header.push('Date : '+_todayFR());
  var facPrefix = (prefs.numerotation_fact_prefix || 'FAC-');
  var numCourant= Math.max(1, parseInt(prefs.numerotation_courante||1,10));
  header.push('N¬∞ : '+facPrefix+String(numCourant).padStart(4,'0'));
  header.push('');
  header.push('√âmetteur :');
  var rs = (company.raison_sociale || company.nom_commercial || '').trim();
  if(rs) header.push('  '+rs);
  var adr = [company.adresse, company.code_postal, company.ville].filter(Boolean).join(' ');
  if(adr) header.push('  '+adr);
  if(company.pays) header.push('  '+company.pays);
  if(company.email) header.push('  Email : '+company.email);
  if(company.telephone) header.push('  T√©l   : '+company.telephone);
  if(company.siren) header.push('  SIREN : '+company.siren);
  if(company.tva_intracom) header.push('  TVA   : '+company.tva_intracom);
  header.push('========================================================');
  header.push('');

  // Corps
  var body = [];
  if(modeSepare){
    body.push('--- PRESTATIONS ---');
    body.push('Total Prestations (HT) : '+_fmtEuro(totalPrest, devise));
    if(tvaOn) body.push('TVA Prestations ('+tauxTVA+'%) : '+_fmtEuro(tvaPrest, devise));
    body.push('');
    body.push('--- MAT√âRIEL ---');
    body.push('Total Mat√©riel (HT) : '+_fmtEuro(totalMat, devise));
    if(tvaOn) body.push('TVA Mat√©riel ('+tauxTVA+'%) : '+_fmtEuro(tvaMat, devise));
    body.push('');
    body.push('[Note] Mode ‚Äús√©par√©‚Äù : v1 sans d√©composition mat√©rielle ‚Üí tout imput√© en Prestations.');
    body.push('');
  } else {
    body.push('--- TOTAL (fournitures + pose) ---');
    body.push('Montant HT : '+_fmtEuro(totalHT, devise));
    if(tvaOn) body.push('TVA ('+tauxTVA+'%) : '+_fmtEuro(totalHT * tauxTVA/100, devise));
    body.push('');
  }

  // R√©cap global
  var htGlobal  = totalPrest + totalMat;
  var tvaGlobal = tvaOn ? (modeSepare ? (tvaPrest + tvaMat) : (totalHT * tauxTVA/100)) : 0;

  body.push('================= R√âCAPITULATIF =================');
  body.push('Total HT  : '+_fmtEuro(modeSepare?htGlobal:totalHT, devise));
  if(tvaOn) body.push('TVA       : '+_fmtEuro(tvaGlobal, devise));
  body.push('Total TTC : '+_fmtEuro((modeSepare?htGlobal:totalHT) + tvaGlobal, devise));
  body.push('=================================================');
  body.push('');

  // Mentions / paiement
  var foot = [];
  if(company.conditions_paiement) foot.push('Conditions de paiement : '+company.conditions_paiement);
  if(company.iban) foot.push('IBAN : '+company.iban+(company.bic?(' ‚Äî BIC : '+company.bic):''));
  if(company.rc_pro) foot.push('RC Pro : '+company.rc_pro);
  if(company.decennale) foot.push('D√©cennale : '+company.decennale);
  if(company.assureur) foot.push('Assureur : '+company.assureur);
  if(company.mentions_legales){
    foot.push('');
    foot.push(company.mentions_legales);
  }

  return header.concat(body).concat(foot).join('\r\n');
}

/* ==== Export .txt + incr√©ment num√©rotation ==== */
function exportInvoiceText(){
  var prefs = _getPrefsSafe();
  try{
    var cur = Math.max(1, parseInt(prefs.numerotation_courante||1,10));
    prefs.numerotation_courante = cur + 1;
    localStorage.setItem('appPrefs_v1', JSON.stringify(prefs));
  }catch(e){}
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildInvoiceText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url;
  a.download = name.replace(/\s+/g,'_').toLowerCase()+'_facture.txt';
  a.click();
  URL.revokeObjectURL(url);
  alert('‚úÖ Facture (texte) export√©e.');
}

/* ==== Injection du bouton dans Estimatif & Totaux ==== */
(function patchButtons(){
  var origEst = window.pageEstimatif;
  if(typeof origEst === 'function'){
    window.pageEstimatif = function(){
      origEst();
      var app = document.getElementById('app'); if(!app) return;
      if(app.innerHTML.indexOf('exportInvoiceText()')===-1){
        app.innerHTML = app.innerHTML.replace(
          /(Export \.zip \(complet\).*?<\/div>\s*<\/div>)/,
          '$1<div class="row" style="margin-top:10px;">'
          + '<button class="btn primary" onclick="exportInvoiceText()">üßæ Exporter facture (texte)</button>'
          + '</div>'
        );
      }
    };
  }
  var origTot = window.pageTotaux;
  if(typeof origTot === 'function'){
    window.pageTotaux = function(){
      origTot();
      var app = document.getElementById('app'); if(!app) return;
      if(app.innerHTML.indexOf('exportInvoiceText()')===-1){
        app.innerHTML = app.innerHTML.replace(
          /(Export \.zip \(complet\).*?<\/div>\s*<\/div>)/,
          '$1<div class="row" style="margin-top:10px;">'
          + '<button class="btn primary" onclick="exportInvoiceText()">üßæ Exporter facture (texte)</button>'
          + '</div>'
        );
      }
    };
  }
})();
</script>


  



  



  




  




  
  
  <!-- ============================================================
     CHAPITRE 11 : ESTIMATIF & EXPORTS ‚Äî vNEXT
     Index :
       ¬ß7.0 ‚Ä¢ D√©tection / libell√© des pi√®ces (Tableaux inclus)
       ¬ß7.1 ‚Ä¢ Tri d√©di√© aux Tableaux (diff ‚Üí coupure ‚Üí disjoncteurs ‚Üí reste)
       ¬ß7.2 ‚Ä¢ Pages : Estimatif d√©taill√© & Totaux par groupe
       ¬ß7.3 ‚Ä¢ Exports : .txt par groupe / .zip par groupe
       ¬ß7.4 ‚Ä¢ Exports : complet .txt / complet .zip
     ============================================================ -->
<script>
// ¬ß7.0 ‚Ä¢ D√©tection & libell√©s
window.PIECE_GROUPS = window.PIECE_GROUPS || {
  "Buanderie":"Pi√®ces techniques","Garage":"Pi√®ces techniques","Atelier":"Pi√®ces techniques",
  "Jardin":"Ext√©rieur","Terrasse":"Ext√©rieur","Balcon":"Ext√©rieur","Abri de jardin":"Ext√©rieur",
  "Cuisine":"Cuisine",
  "Salon":"Pi√®ces de vie","Salle √† manger":"Pi√®ces de vie","Couloir":"Pi√®ces de vie","Entr√©e":"Pi√®ces de vie",
  "Salle de bain":"Pi√®ces d'eau","Salle d'eau":"Pi√®ces d'eau","Toilettes":"Pi√®ces d'eau",
  "Chambre 1":"Chambres & Bureau","Chambre 2":"Chambres & Bureau","Chambre 3":"Chambres & Bureau",
  "Bureau":"Chambres & Bureau","Biblioth√®que":"Chambres & Bureau",
  "Tableau":"Tableau & distribution","Distribution":"Tableau & distribution",
  "Mise √† la terre":"Mise √† la terre","VMC":"VMC"
};
function groupDevis(){
  var g = {};
  for (var key in devis){
    if (key.indexOf("__") === 0) continue;
    var s = devis[key];
    var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
    var grp  = window.PIECE_GROUPS[base] || "Divers";
    if (!g[grp]) g[grp] = {};
    g[grp][key] = s;
  }
  return g;
}
function isTableauKey(key){
  var s = devis[key] || {};
  return ((s.__base||'').toLowerCase()==='tableau') || /^Tableau\s/i.test(key);
}
function pieceDisplayLabel(key){
  var s = devis[key] || {};
  var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
  var qual = s.qualificatif || '';
  var etg  = s.etage || '';
  var label = base===key ? key : (base + (qual ? ' ('+qual+')':'') + (etg ? ' ‚Äî '+etg:''));
  if(isTableauKey(key) && s.__customName && s.__customName.trim()){
    label = key + ' ‚Äî ' + s.__customName.trim();
  }else{
    if(!isTableauKey(key)){
      label = (typeof formatPieceLabel === 'function') ? formatPieceLabel(key) : key;
    }else{
      label = key;
    }
  }
  return label;
}

// ¬ß7.1 ‚Ä¢ Tri d√©di√© Tableaux
function sortedItemsForPiece(key, items){
  if(!Array.isArray(items)) return [];
  if(!isTableauKey(key)) return items.slice();

  function score(it){
    var d = (it && it.designation ? String(it.designation) : '').trim();
    if (/^ID\s/i.test(d))             return 0;
    if (/^Coupure g√©n√©rale/i.test(d)) return 1;
    if (/^Disjoncteur\s/i.test(d))    return 2;
    return 3;
  }
  return items.map(function(it, i){ return {it:it, i:i, s:score(it)}; })
              .sort(function(a,b){ return (a.s - b.s) || (a.i - b.i); })
              .map(function(x){ return x.it; });
}

// ¬ß7.2 ‚Ä¢ Pages : Estimatif + Totaux
function itemLine(it){
  var unit = it.unit || "u";
  var poseTxt = (it.intervention === "Cr√©ation" && it.pose) ? (" - " + String(it.pose).toLowerCase()) : "";
  var left = it.intervention ? (it.intervention + " ‚Äî ") : "";
  var pu = (+it.prixU || 0).toFixed(2);
  var q  = +it.qty || 0;
  var total = (q * (+it.prixU || 0)).toFixed(2);
  return "- " + left + it.designation + poseTxt + " | Qt√©: " + q + " " + unit + " | PU: " + pu + "‚Ç¨ | Total: " + total + "‚Ç¨";
}
function pieceSeparator(label){ return "\n---------------- " + label + " ----------------\n"; }

function pageEstimatif(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Estimatif d√©taill√©</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    html += '<h2 style="border-top:2px solid #000; padding-top:8px;">'+grp+'</h2>';
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var pieceLabel = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var sectionTotal = 0;

      html += '<h3 style="margin-top:6px; border-top:1px solid #ccc; padding-top:4px;">'+pieceLabel+'</h3><ul>';
      items.forEach(function(it){
        var q  = +it.qty || 0;
        var pu = +it.prixU || 0;
        var t  = q * pu;
        sectionTotal += t; groupTotal += t; totalGlobal += t;

        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? (" " + String(it.pose).toLowerCase()) : "";
        var unit    = it.unit || "u";
        var left    = it.intervention ? (it.intervention+" ‚Äî ") : "";
        html += '<li>' + left + it.designation + poseTxt + ' ('+q+' '+unit+' √ó '+euro(pu)+' = '+euro(t)+')</li>';
      });
      if (s.note) html += '<li><em>Note : '+s.note+'</em></li>';

      html += '</ul><p><strong>Total '+pieceLabel+' : '+euro(sectionTotal)+'</strong></p>';
    }

    html += '<p><strong>Total '+grp+' : '+euro(groupTotal)+'</strong></p><hr>';
  }

  html += '<h3>Total global : '+euro(totalGlobal)+'</h3>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

function pageTotaux(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Totaux par groupe</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    var gt = 0;
    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;
      var items = sortedItemsForPiece(key, s.items);
      var st = items.reduce(function(sum,it){ return sum + (((+it.prixU)||0)*((+it.qty)||0)); }, 0);
      gt += st; totalGlobal += st;
    }
    html += '<p><strong>'+grp+'</strong> : '+euro(gt)+'</p>';
  }

  html += '<hr><p><strong>Total global : '+euro(totalGlobal)+'</strong></p>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div></div>';

  view(html);
}

// ¬ß7.3 ‚Ä¢ Exports : TXT/ZIP par groupe
function exportText(){
  var grouped = groupDevis();
  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');

    var blob = new Blob([lines.join('\r\n')], {type:'text/plain;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = 'devis_'+grp+'.txt'; a.click();
    URL.revokeObjectURL(url);
  }
  alert('‚úÖ Export termin√© : un fichier .txt par groupe g√©n√©r√©.');
}

async function exportZipGroups(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var grouped = groupDevis();
  var zip = new JSZip();
  var global = 0;

  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');
    global += groupTotal;

    zip.file('devis_'+grp+'.txt', lines.join('\r\n'));
  }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var readme = 'R√©capitulatif ‚Äî '+name+'\nDate: '+new Date().toLocaleString()
             + '\n\nTotal global: '+global.toFixed(2)+'‚Ç¨\n';
  zip.file('README.txt', readme);

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_groupes.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export ZIP (par groupe) g√©n√©r√©.');
}

// ¬ß7.4 ‚Ä¢ Exports : COMPLET (.txt/.zip)
function buildFullText(){
  var grouped = groupDevis();
  var lines = ['=== DEVIS COMPLET ===\n'];
  var globalTotal = 0;

  for (var grp in grouped){
    lines.push('\n## '+grp+' ##\n');
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push(pieceSeparator(label));

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t; globalTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨\n');
  }

  lines.push('\n=== Total global : '+globalTotal.toFixed(2)+'‚Ç¨ ===\n');
  return lines.join('\r\n');
}
function exportTextFull(){
  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildFullText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export .txt complet g√©n√©r√©.');
}
async function exportZipFull(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var name = (devis.__name || 'Devis').trim() || 'Devis';
  var zip  = new JSZip();
  zip.file(name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt', buildFullText());
  zip.file('README.txt', 'Devis complet\nNom: '+name+'\nDate: '+new Date().toLocaleString()+'\n');

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export .zip complet g√©n√©r√©.');
}
</script>











  


<!-- =============================
     CHAPITRE 12 : CONFIG ENTREPRISE & PR√âF√âRENCES ‚Äî V10.1
     (Autonome, non intrusif ‚Äî pages ind√©pendantes)
     ============================= -->

<style>
  .cfg-wrap .card{ margin-bottom:24px; }
  .cfg-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .cfg-grid .field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .cfg-grid .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .cfg-actions{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; }

  .cfg-note{ color:var(--muted); font-size:14px; }

  /* Logo */
  .cfg-logo-block{ display:grid; grid-template-columns:1fr; gap:10px; }
  .cfg-logo-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .cfg-logo img{ max-height:64px; border:1px solid var(--line); border-radius:8px; background:#fff; padding:4px; }
  .dropzone{
    border:2px dashed var(--line); border-radius:10px; padding:12px; background:#fafafa;
    text-align:center; color:#444;
  }
  .dropzone.drag{ border-color:#4caf50; background:#f0fff4; }
  .alert-ok{
    border:1px solid #c8e6c9; background:#e8f5e9; color:#256029;
    padding:8px 10px; border-radius:8px; font-size:14px;
  }
</style>

<script>
/* ============================================================
   Stockage & helpers (localStorage)
   ============================================================ */
const KEY_COMPANY = 'companyConfig_v1';
const KEY_PREFS   = 'appPrefs_v1';

function readJsonLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function writeJsonLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

function getCompany(){
  return readJsonLS(KEY_COMPANY, {
    // Identit√©
    raison_sociale: '', nom_commercial: '',
    siren: '', tva_intracom: '',
    adresse: '', code_postal: '', ville: '', pays: 'France',
    email: '', telephone: '', site: '',
    // Assurance / mentions
    rc_pro: '', decennale: '', assureur: '',
    iban: '', bic: '', conditions_paiement: 'Virement bancaire √† 30 jours.',
    mentions_legales: '',
    // Logo (dataURL)
    logo_dataurl: '',
    logo_meta: { name:'', size:0, width:0, height:0, loaded_at:'' }
  });
}
function setCompany(obj){ writeJsonLS(KEY_COMPANY, obj||{}); }

function getPrefs(){
  return readJsonLS(KEY_PREFS, {
    facturation_mode: 'tout_compris', // 'tout_compris' | 'separe'
    devise: '‚Ç¨',
    tva_applicable: false,
    taux_tva: 20,
    numerotation_prefix: 'DEV-',
    numerotation_fact_prefix: 'FAC-',
    numerotation_courante: 1
  });
}
function setPrefs(obj){ writeJsonLS(KEY_PREFS, obj||{}); }

/* Fichier ‚Üí dataURL + meta (nom/taille + dimensions) */
function fileToDataURLWithMeta(file, cb, errCb){
  try{
    const rd = new FileReader();
    rd.onload = function(){
      const dataUrl = rd.result || '';
      const img = new Image();
      img.onload = function(){
        cb({
          dataUrl,
          meta: {
            name: file.name || '',
            size: file.size || 0,
            width: img.naturalWidth||img.width||0,
            height: img.naturalHeight||img.height||0,
            loaded_at: new Date().toISOString()
          }
        });
      };
      img.onerror = function(){ (errCb||alert)('Impossible de lire l‚Äôimage.'); };
      img.src = dataUrl;
    };
    rd.onerror = function(){ (errCb||alert)('Lecture du fichier √©chou√©e.'); };
    rd.readAsDataURL(file);
  }catch(e){ (errCb||alert)('S√©lection d‚Äôimage impossible : '+e.message); }
}

function pickImageFile(cb){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = function(){
    const f = input.files && input.files[0]; if(!f) return;
    cb(f);
  };
  input.click();
}

/* ============================================================
   UI ‚Äî Configuration entreprise
   ============================================================ */
function pageConfigEntreprise(notice){
  const cfg = getCompany();

  function f(label, id, val, placeholder){
    return '<div class="field"><label for="'+id+'">'+label+'</label>'
         + '<input id="'+id+'" value="'+(val?String(val).replace(/"/g,'&quot;'):'')+'" placeholder="'+(placeholder||'')+'"/></div>';
  }
  function ta(label, id, val, placeholder){
    return '<div class="field"><label for="'+id+'">'+label+'</label>'
         + '<textarea id="'+id+'" rows="5" placeholder="'+(placeholder||'')+'">'+(val||'')+'</textarea></div>';
  }

  const hasLogo = !!cfg.logo_dataurl;
  const meta = cfg.logo_meta || {};
  const metaTxt = hasLogo
    ? ('<div class="cfg-note">Fichier: <strong>'+ (meta.name||'') +
       '</strong> ‚Äî '+(Math.round((meta.size||0)/102.4)/10)+' Ko ‚Äî '+
       (meta.width||'?')+'√ó'+(meta.height||'?')+' px</div>')
    : '<div class="cfg-note">Aucun logo</div>';

  const banner = notice ? '<div class="alert-ok">'+notice+'</div>' : '';

  const logoHtml =
    '<div class="field">'
      + '<label>Logo</label>'
      + '<div class="cfg-logo-block">'
        + banner
        + '<div class="cfg-logo-row cfg-logo">'
            + (hasLogo ? ('<img id="cfg-logo-preview" src="'+cfg.logo_dataurl+'" alt="Logo"/>') : '')
            + metaTxt
        + '</div>'
        + '<div class="cfg-logo-row">'
            + b('Choisir une image','cfgPickLogoUI()','btn')
            + (hasLogo ? b('Aper√ßu plein','cfgOpenLogoFull()','btn') : '')
            + (hasLogo ? b('Retirer','cfgRemoveLogo()','btn') : '')
        + '</div>'
        + '<div id="dropzone" class="dropzone">Glissez-d√©posez votre logo ici (PNG/JPG recommand√©)</div>'
        + '<div class="cfg-note">Le logo sera int√©gr√© aux futurs documents (devis/factures).</div>'
      + '</div>'
    + '</div>';

  view(
    '<div class="cfg-wrap">'
    +  '<div class="card">'
        + b('Retour','pageParametrageAccueil ? pageParametrageAccueil() : pageMain()','btn back')
        + '<h2>Configuration entreprise</h2>'
        + '<p class="cfg-note">Ces informations sont utilis√©es pour les exports (devis/factures) et les mentions l√©gales.</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Identit√© & coordonn√©es</h3>'
        + '<div class="cfg-grid">'
          + f('Raison sociale','ce_rs', cfg.raison_sociale, 'Ex : SARL Dupont √âlectricit√©')
          + f('Nom commercial','ce_nc', cfg.nom_commercial, 'Ex : Dupont √âlec')
          + f('SIREN','ce_siren', cfg.siren, '123 456 789')
          + f('N¬∞ TVA intracom','ce_tva', cfg.tva_intracom, 'FRXX999999999')
          + f('Adresse','ce_addr', cfg.adresse, 'Rue et n¬∞')
          + f('Code postal','ce_cp', cfg.code_postal, '75000')
          + f('Ville','ce_ville', cfg.ville, 'Paris')
          + f('Pays','ce_pays', cfg.pays || 'France', 'France')
          + f('Email','ce_mail', cfg.email, 'contact@exemple.fr')
          + f('T√©l√©phone','ce_tel', cfg.telephone, '+33 6 12 34 56 78')
          + f('Site web','ce_web', cfg.site, 'https://‚Ä¶')
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Assurances & RIB</h3>'
        + '<div class="cfg-grid">'
          + f('RC Pro (n¬∞)','ce_rc', cfg.rc_pro, '')
          + f('D√©cennale (n¬∞)','ce_dec', cfg.decennale, '')
          + f('Assureur','ce_ass', cfg.assureur, '')
          + f('IBAN','ce_iban', cfg.iban, '')
          + f('BIC','ce_bic', cfg.bic, '')
        + '</div>'
        + ta('Conditions de paiement','ce_cond', cfg.conditions_paiement, 'Virement sous 30 jours‚Ä¶')
        + ta('Mentions l√©gales (pied de page)','ce_mentions', cfg.mentions_legales, 'Textes libres‚Ä¶')
      + '</div>'

      + '<div class="card">'
        + '<h3>Logo</h3>'
        + logoHtml
      + '</div>'

      + '<div class="cfg-actions">'
        + b('üíæ Enregistrer','saveConfigEntreprise()','btn primary')
      + '</div>'
    + '</div>'
  );

  // Handlers inline
  window.cfgPickLogoUI = function(){
    pickImageFile(function(file){
      fileToDataURLWithMeta(file, function(res){
        const c = getCompany();
        c.logo_dataurl = res.dataUrl;
        c.logo_meta = res.meta;
        setCompany(c);
        pageConfigEntreprise('Logo charg√© ‚úÖ ('+res.meta.width+'√ó'+res.meta.height+' px)');
      });
    });
  };
  window.cfgRemoveLogo = function(){
    const c = getCompany(); c.logo_dataurl = ''; c.logo_meta = {name:'',size:0,width:0,height:0,loaded_at:''};
    setCompany(c); pageConfigEntreprise('Logo supprim√©.');
  };
  window.cfgOpenLogoFull = function(){
    const c = getCompany(); if(!c.logo_dataurl) return;
    const w = window.open(); if(!w) return;
    w.document.write('<img src="'+c.logo_dataurl+'" style="max-width:100%;height:auto" alt="Logo" />');
  };

  // Drag & drop
  (function setupDrop(){
    const dz = document.getElementById('dropzone');
    if(!dz) return;
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('drag'); }));
    dz.addEventListener('drop', function(e){
      const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
      if(!f) return;
      if(!/^image\//i.test(f.type||'')){ alert('Merci de d√©poser une image (PNG/JPG).'); return; }
      fileToDataURLWithMeta(f, function(res){
        const c = getCompany();
        c.logo_dataurl = res.dataUrl;
        c.logo_meta = res.meta;
        setCompany(c);
        pageConfigEntreprise('Logo charg√© ‚úÖ ('+res.meta.width+'√ó'+res.meta.height+' px)');
      });
    });
  })();
}

/* ==========================
   Sauvegarde ‚Äî robuste (FIX)
   ========================== */
function saveConfigEntreprise(){
  // √âtat courant pour pr√©server ce qui n'est pas saisi
  const prev = getCompany();

  // Helper s√©curis√© : lit la valeur; si vide -> undefined (n'√©crase pas)
  const gv = (id) => {
    const el = document.getElementById(id);
    if (!el) return undefined;
    const v = (el.value ?? '').trim();
    return v === '' ? undefined : v;
  };

  const next = Object.assign({}, prev, {
    raison_sociale:         gv('ce_rs')       ?? prev.raison_sociale,
    nom_commercial:         gv('ce_nc')       ?? prev.nom_commercial,
    siren:                  gv('ce_siren')    ?? prev.siren,
    tva_intracom:           gv('ce_tva')      ?? prev.tva_intracom,
    adresse:                gv('ce_addr')     ?? prev.adresse,
    code_postal:            gv('ce_cp')       ?? prev.code_postal,
    ville:                  gv('ce_ville')    ?? prev.ville,
    pays:                   gv('ce_pays')     ?? prev.pays,
    email:                  gv('ce_mail')     ?? prev.email,
    telephone:              gv('ce_tel')      ?? prev.telephone,
    site:                   gv('ce_web')      ?? prev.site,
    rc_pro:                 gv('ce_rc')       ?? prev.rc_pro,
    decennale:              gv('ce_dec')      ?? prev.decennale,
    assureur:               gv('ce_ass')      ?? prev.assureur,
    iban:                   gv('ce_iban')     ?? prev.iban,
    bic:                    gv('ce_bic')      ?? prev.bic,
    conditions_paiement:    gv('ce_cond')     ?? prev.conditions_paiement,
    mentions_legales:       gv('ce_mentions') ?? prev.mentions_legales
    // Logo g√©r√© ailleurs ‚Äî on ne touche pas ici
  });

  setCompany(next);
  // Relit pour garantir l'affichage des valeurs persist√©es
  pageConfigEntreprise('Configuration entreprise enregistr√©e.');
}

/* ============================================================
   UI ‚Äî Pr√©f√©rences (mode facturation, devise, TVA‚Ä¶)
   ============================================================ */
function pagePreferences(){
  const p = getPrefs();
  const radio = (name, val, cur, label) =>
    '<label class="pill"><input type="radio" name="'+name+'" value="'+val+'" '+(cur===val?'checked':'')+'> '+label+'</label>';

  view(
    '<div class="cfg-wrap">'
      + '<div class="card">'
        + b('Retour','pageParametrageAccueil ? pageParametrageAccueil() : pageMain()','btn back')
        + '<h2>Pr√©f√©rences devis et facturation</h2>'
        + '<p class="cfg-note">Ces r√©glages influencent la pr√©sentation des exports et la logique de TVA.</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Mode de facturation</h3>'
        + '<div class="row" style="gap:8px;">'
          + radio('pf_fmode','tout_compris', p.facturation_mode, 'Tarifs ¬´ fournitures + pose ¬ª (tout compris)')
          + radio('pf_fmode','separe', p.facturation_mode, 'S√©parer prestations et mat√©riel')
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Devise & TVA</h3>'
        + '<div class="cfg-grid">'
          + '<div class="field">'
            + '<label>Devise</label>'
            + '<input id="pf_dev" value="'+(p.devise||'‚Ç¨')+'" placeholder="‚Ç¨"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>TVA applicable</label>'
            + '<select id="pf_tva_on"><option value="no" '+(!p.tva_applicable?'selected':'')+'>Non (Micro)</option><option value="yes" '+(p.tva_applicable?'selected':'')+'>Oui (R√©gime r√©el)</option></select>'
          + '</div>'
          + '<div class="field">'
            + '<label>Taux de TVA (%)</label>'
            + '<input id="pf_tva" type="number" inputmode="decimal" min="0" max="100" step="0.1" value="'+(+p.taux_tva||20)+'"/>'
          + '</div>'
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Num√©rotation</h3>'
        + '<div class="cfg-grid">'
          + '<div class="field">'
            + '<label>Pr√©fixe num√©rotation devis</label>'
            + '<input id="pf_pref_dev" value="'+(p.numerotation_prefix||'DEV-')+'"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>Pr√©fixe num√©rotation facture</label>'
            + '<input id="pf_pref_fac" value="'+(p.numerotation_fact_prefix||'FAC-')+'"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>Compteur courant</label>'
            + '<input id="pf_counter" type="number" inputmode="numeric" min="1" value="'+(+p.numerotation_courante||1)+'"/>'
            + '<div class="cfg-note">Servira pour g√©n√©rer DEV-0001, FAC-0001, etc.</div>'
          + '</div>'
        + '</div>'
      + '</div>'

      + '<div class="cfg-actions">'
        + b('üíæ Enregistrer','savePreferences()','btn primary')
      + '</div>'
    + '</div>'
  );
}

function savePreferences(){
  const cur = getPrefs();
  function gv(id){ const el=document.getElementById(id); return el?el.value:''; }
  function gi(name){ const el=document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:cur[name]; }
  const tvay = (gv('pf_tva_on')==='yes');

  const out = Object.assign({}, cur, {
    facturation_mode: gi('pf_fmode') || cur.facturation_mode,
    devise: gv('pf_dev') || cur.devise || '‚Ç¨',
    tva_applicable: tvay,
    taux_tva: Math.max(0, parseFloat(gv('pf_tva'))||cur.taux_tva||20),
    numerotation_prefix: gv('pf_pref_dev') || cur.numerotation_prefix || 'DEV-',
    numerotation_fact_prefix: gv('pf_pref_fac') || cur.numerotation_fact_prefix || 'FAC-',
    numerotation_courante: Math.max(1, parseInt(gv('pf_counter'),10)||cur.numerotation_courante||1)
  });
  setPrefs(out);
  alert('‚úÖ Pr√©f√©rences enregistr√©es.');
}

/* ============================================================
   Expose (aucune injection automatique ici)
   ============================================================ */
Object.assign(window, {
  pageConfigEntreprise,
  pagePreferences,
  saveConfigEntreprise,
  savePreferences
});
</script>
















  

<!-- =============================
     CHAPITRE 13 : CATALOGUE PRESTATION ‚Äî V10.0
     Index :
       13.0 ‚Ä¢ Styles
       13.1 ‚Ä¢ Stockage & Defaults (prestations + coefficients)
       13.2 ‚Ä¢ Helpers (IO, UI)
       13.3 ‚Ä¢ Runtime : registre + computePU (expos√© global)
       13.4 ‚Ä¢ Accueil "Catalogue prestation"
       13.5 ‚Ä¢ Appareillage (Prises / Luminaires / Commandes / Circuit sp√©cialis√©)
             - Prises : 4 interventions (cr√©a + remplacements/rec√¢blages)
             - Luminaires : Point de centre, Applique, Alimentation ligne de spot (base + par spot)
             - Commandes : Allumage simple/double, Va-et-vient, Variateur, Bouton poussoir
             - Circuit sp√©cialis√© : types par section (1.5 / 2.5 / 6 / 10 mm¬≤) avec 4 interventions
       13.6 ‚Ä¢ Coefficients de pose
       13.7 ‚Ä¢ Import / Export / Reset
       13.8 ‚Ä¢ Expose (window)
     ============================= -->

<style>
  .presta-wrap .card{ margin-bottom:24px; }
  .presta-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .muted{ color:var(--muted); }
  .row.gap8{ gap:8px; flex-wrap:wrap; }
  .pill.small{ padding:6px 10px; font-size:14px; }
  .block{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:12px; }
  .subcard{ border:1px dashed var(--line); border-radius:10px; padding:10px; background:#fafafa; }
  .h-note{ font-size:13px; color:#666; }
  .table-mini{ width:100%; border-collapse:collapse; font-size:14px; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; vertical-align:middle; }
  .table-mini th{ background:#fafafa; }
  .mb8{ margin-bottom:8px; }
</style>

<script>
/* ============================================================
   13.1 ‚Ä¢ Stockage & Defaults
   ============================================================ */
const KEY_PRESTA13   = 'catalogue_prestation_v1';
const KEY_COEFFS13   = 'coeff_pose_v1';

function _prestaDefaults(){
  return {
    // Cat√©gorie : Appareillage
    appareillage: {
      prises: {
        // Un "type" principal "Prise" avec 4 interventions param√©trables
        baseTypes: [ "Prise" ],
        tarifs: {
          "Prise": {
            "Cr√©ation": 90,
            "Remplacement appareillage": 25,
            "Rec√¢blage avec remplacement appareillage": 45,
            "Rec√¢blage sans remplacement appareillage": 30
          }
        },
        // possibilit√© d'ajouter d'autres "types" (affich√©s dans la liste Prises si besoin)
        customTypes: [] // ex: ["Sortie de c√¢ble", ...] -> h√©ritent d‚Äôun bloc de tarifs clon√© au d√©part
      },
      luminaires: {
        baseTypes: [ "Point de centre", "Applique", "Alimentation ligne de spot" ],
        tarifs: {
          "Point de centre": {
            "Cr√©ation": 110,
            "Remplacement luminaire": 35,
            "Rec√¢blage avec remplacement luminaire": 55,
            "Rec√¢blage sans remplacement luminaire": 40
          },
          "Applique": {
            "Cr√©ation": 95,
            "Remplacement luminaire": 30,
            "Rec√¢blage avec remplacement luminaire": 50,
            "Rec√¢blage sans remplacement luminaire": 35
          },
          // Alimentation ligne de spot : on enregistre deux param√®tres
          // base_ligne : prix d'alim. de la ligne
          // par_spot   : ajout par spot
          "__spot_line__": { base_ligne: 60, par_spot: 15 }
        },
        customTypes: [] // facultatif
      },
      commandes: {
        baseTypes: [ "Allumage simple", "Allumage double", "Va-et-vient", "Variateur", "Bouton poussoir" ],
        tarifs: {
          "Allumage simple": {
            "Cr√©ation": 65,
            "Remplacement appareillage": 25,
            "Rec√¢blage avec remplacement appareillage": 40,
            "Rec√¢blage sans remplacement appareillage": 28
          },
          "Allumage double": {
            "Cr√©ation": 80,
            "Remplacement appareillage": 30,
            "Rec√¢blage avec remplacement appareillage": 48,
            "Rec√¢blage sans remplacement appareillage": 34
          },
          "Va-et-vient": {
            "Cr√©ation": 80,
            "Remplacement appareillage": 28,
            "Rec√¢blage avec remplacement appareillage": 46,
            "Rec√¢blage sans remplacement appareillage": 32
          },
          "Variateur": {
            "Cr√©ation": 95,
            "Remplacement appareillage": 35,
            "Rec√¢blage avec remplacement appareillage": 55,
            "Rec√¢blage sans remplacement appareillage": 38
          },
          "Bouton poussoir": {
            "Cr√©ation": 70,
            "Remplacement appareillage": 26,
            "Rec√¢blage avec remplacement appareillage": 42,
            "Rec√¢blage sans remplacement appareillage": 30
          }
        },
        customTypes: []
      },
      circuit_spec: {
        baseTypes: [ "Circuit sp√©cialis√© 1,5 mm¬≤", "Circuit sp√©cialis√© 2,5 mm¬≤", "Circuit sp√©cialis√© 6 mm¬≤", "Circuit sp√©cialis√© 10 mm¬≤" ],
        tarifs: {
          "Circuit sp√©cialis√© 1,5 mm¬≤": {
            "Cr√©ation": 140,
            "Remplacement appareillage": 35,
            "Rec√¢blage avec remplacement appareillage": 55,
            "Rec√¢blage sans remplacement appareillage": 40
          },
          "Circuit sp√©cialis√© 2,5 mm¬≤": {
            "Cr√©ation": 155,
            "Remplacement appareillage": 35,
            "Rec√¢blage avec remplacement appareillage": 60,
            "Rec√¢blage sans remplacement appareillage": 42
          },
          "Circuit sp√©cialis√© 6 mm¬≤": {
            "Cr√©ation": 190,
            "Remplacement appareillage": 40,
            "Rec√¢blage avec remplacement appareillage": 70,
            "Rec√¢blage sans remplacement appareillage": 48
          },
          "Circuit sp√©cialis√© 10 mm¬≤": {
            "Cr√©ation": 230,
            "Remplacement appareillage": 45,
            "Rec√¢blage avec remplacement appareillage": 85,
            "Rec√¢blage sans remplacement appareillage": 58
          }
        },
        customTypes: []
      }
    },
    // Sections vides (pr√™tes pour plus tard)
    tableau: { note:"√Ä param√©trer ult√©rieurement." },
    ventilation: { note:"√Ä param√©trer ult√©rieurement." },
    mise_terre: { note:"√Ä param√©trer ult√©rieurement." }
  };
}
function _coeffDefaults(){
  // Coefficients multiplicatifs par type de pose
  // (utilis√©s par computePU si pertinents)
  return {
    "Encastr√© ma√ßonnerie": 1.00,
    "Encastr√© placo": 1.00,
    "Saillie": 1.00,
    "Apparent": 1.00
  };
}

function getPrestations(){
  try{ return JSON.parse(localStorage.getItem(KEY_PRESTA13)||'null') || _prestaDefaults(); }
  catch(e){ return _prestaDefaults(); }
}
function setPrestations(obj){
  try{ localStorage.setItem(KEY_PRESTA13, JSON.stringify(obj||_prestaDefaults())); }catch(e){}
}
function getCoeffs(){
  try{ return JSON.parse(localStorage.getItem(KEY_COEFFS13)||'null') || _coeffDefaults(); }
  catch(e){ return _coeffDefaults(); }
}
function setCoeffs(obj){
  try{ localStorage.setItem(KEY_COEFFS13, JSON.stringify(obj||_coeffDefaults())); }catch(e){}
}

/* ============================================================
   13.2 ‚Ä¢ Helpers
   ============================================================ */
function _esc(s){ return String(s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }
function _num(n){ return Math.max(0, +n||0); }
function _clone(x){ return JSON.parse(JSON.stringify(x)); }
function _rowNum(id, val){ return '<div class="field"><label>'+_esc(id.label)+'</label><input id="'+id.id+'" type="number" inputmode="decimal" step="1" value="'+_num(val)+'"/></div>'; }
function _saveNum(id){ var el=document.getElementById(id); return el? _num(el.value) : 0; }

/* ============================================================
   13.3 ‚Ä¢ Runtime : Registre & computePU
   ------------------------------------------------------------
   - computePU(cat, desig, interv, pose, section, extras)
     * cat : "Prises", "√âclairage/Luminaires", "√âclairage/Commandes", "Circuit sp√©cialis√©"
     * desig : nom du type (ou libell√© saisi)
     * interv : intervention s√©lectionn√©e
     * pose : type de pose (optionnel si ‚â† Cr√©ation)
     * section : section c√¢ble (CS)
     * extras : { spots: <int> } pour "Alimentation ligne de spot"
   ============================================================ */
function mapCatKey(cat){
  if(cat==='Prises') return ['appareillage','prises'];
  if(cat==='√âclairage/Luminaires') return ['appareillage','luminaires'];
  if(cat==='√âclairage/Commandes')  return ['appareillage','commandes'];
  if(cat==='Circuit sp√©cialis√©')   return ['appareillage','circuit_spec'];
  return null;
}

function computePU(cat, desig, interv, pose, section, extras){
  var pr = getPrestations();
  var ck = mapCatKey(cat);
  if(!ck) return 0;

  // Luminaires ‚Äî "Alimentation ligne de spot"
  if(cat==='√âclairage/Luminaires' && String(desig).toLowerCase().indexOf('alimentation ligne de spot')===0){
    var LS = pr.appareillage.luminaires.tarifs["__spot_line__"] || {base_ligne:0, par_spot:0};
    var nb = Math.max(1, (extras && +extras.spots) || 1);
    var base = _num(LS.base_ligne) + _num(LS.par_spot) * nb;
    var coef = (getCoeffs()[pose] || 1);
    return roundUp5(base * coef);
  }

  // Circuit sp√©cialis√© ‚Äî si libell√© "Circuit sp√©cialis√©" simple, choisir par section
  if(cat==='Circuit sp√©cialis√©' && /^Circuit sp√©cialis√©/i.test(desig||'') && section){
    desig = 'Circuit sp√©cialis√© ' + String(section);
  }

  var bloc = pr[ck[0]][ck[1]];
  var tarifs = (bloc.tarifs && bloc.tarifs[desig]) ? bloc.tarifs[desig] : null;
  if(!tarifs){
    // si type perso absent ‚Üí fallback √† "Prise" pour Prises, au 1er type sinon
    if(cat==='Prises') tarifs = bloc.tarifs["Prise"];
    else {
      var f = (bloc.baseTypes && bloc.baseTypes[0]) || Object.keys(bloc.tarifs||{})[0];
      tarifs = bloc.tarifs[f] || {};
    }
  }
  var base = _num(tarifs[interv]) || 0;
  var coef = (interv==='Cr√©ation' && pose) ? (getCoeffs()[pose]||1) : 1;
  return roundUp5(base * coef);
}
// expose
window.computePU = computePU;

/* ============================================================
   13.4 ‚Ä¢ Accueil "Catalogue prestation"
   ============================================================ */
function pageCataloguePrestation(){
  const p = getPrestations();
  view(
    '<div class="presta-wrap">'
    +  '<div class="card">'
    +    b('Retour','pageTarifsAccueil ? pageTarifsAccueil() : pageMain()','btn back')
    +    '<h2>Catalogue prestation</h2>'
    +    '<p class="muted">Param√©trez les tarifs de pose utilis√©s dans l‚Äôapplication. Les changements impactent l‚Äôaper√ßu, l‚Äôestimatif, les exports et la duplication ‚Äúappliquer nouveaux tarifs‚Äù.</p>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Appareillage</h3>'
    +    '<div class="subcard mb8"><div class="h-note">Prises, √©clairage (luminaires et commandes), circuits sp√©cialis√©s. Chaque section ci-dessous ouvre son √©diteur complet.</div></div>'
    +    '<div class="row gap8">'
    +      b('Prises','pageCatPresta_Prise()','btn')
    +      b('√âclairage ‚Äî Luminaires','pageCatPresta_Luminaires()','btn')
    +      b('√âclairage ‚Äî Commandes','pageCatPresta_Commandes()','btn')
    +      b('Circuit sp√©cialis√©','pageCatPresta_CS()','btn')
    +    '</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Coefficients de pose</h3>'
    +    '<div class="subcard mb8"><div class="h-note">Ajuste les coefficients multiplicatifs par type de pose (appliqu√©s surtout aux interventions ‚ÄúCr√©ation‚Äù).</div></div>'
    +    '<div class="row gap8">'+ b('Ouvrir','pageCatPresta_Coeffs()','btn') +'</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Tableau ‚Ä¢ Ventilation ‚Ä¢ Mise √† la terre</h3>'
    +    '<div class="subcard mb8"><div class="h-note">Sections pr√™tes pour de futurs r√©glages (actuellement vides).</div></div>'
    +    '<div class="row gap8">'
    +      b('Tableau (√† venir)','alert(\'Section Tableau : √† d√©finir plus tard.\')','btn')
    +      b('Ventilation (√† venir)','alert(\'Section Ventilation : √† d√©finir plus tard.\')','btn')
    +      b('Mise √† la terre (√† venir)','alert(\'Section Mise √† la terre : √† d√©finir plus tard.\')','btn')
    +    '</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Import / Export</h3>'
    +    '<div class="subcard mb8"><div class="h-note">Sauvegarde ou partage de vos r√©glages de prestations et coefficients.</div></div>'
    +    '<div class="row gap8">'
    +      b('Export JSON','presta13Export()','btn')
    +      b('Import JSON','presta13Import()','btn')
    +      b('R√©initialiser','presta13Reset()','btn')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );
}

/* ============================================================
   13.5 ‚Ä¢ √âditeurs : Appareillage
   ------------------------------------------------------------ */

/* ---- 13.5.1 Prises ---- */
function pageCatPresta_Prise(){
  const P = getPrestations().appareillage.prises;
  const allTypes = (P.baseTypes||[]).concat(P.customTypes||[]);
  const rows = allTypes.map((name,idx)=>{
    const t = P.tarifs[name] || {};
    const prefix = 'pr-'+idx;
    return (
      '<div class="block">'
      +  '<div class="row" style="justify-content:space-between;align-items:center;">'
      +    '<h3 style="margin:0;">'+_esc(name)+'</h3>'
      +    (P.baseTypes.indexOf(name)===-1 ? b('Supprimer','catPrDel('+JSON.stringify(name)+')','btn') : '')
      +  '</div>'
      +  '<div class="presta-grid">'
      +    _rowNum({id:prefix+'-c', label:'Cr√©ation'}, t["Cr√©ation"])
      +    _rowNum({id:prefix+'-ra',label:'Remplacement appareillage'}, t["Remplacement appareillage"])
      +    _rowNum({id:prefix+'-rwa',label:'Rec√¢blage avec remplacement appareillage'}, t["Rec√¢blage avec remplacement appareillage"])
      +    _rowNum({id:prefix+'-rs', label:'Rec√¢blage sans remplacement appareillage'}, t["Rec√¢blage sans remplacement appareillage"])
      +  '</div>'
      +  '<div class="row gap8" style="margin-top:8px;">'
      +    b('Enregistrer','catPrSave('+idx+','+JSON.stringify(name)+')','btn')
      +  '</div>'
      +'</div>'
    );
  }).join('');

  view(
    '<div class="presta-wrap">'
    +  '<div class="card">'+ b('Retour','pageCataloguePrestation()','btn back') +'<h2>Catalogue prestation ‚Äî Prises</h2></div>'
    +  (rows || '<div class="card"><div class="muted">Aucun type.</div></div>')
    +  '<div class="card">'
    +    '<h3>Ajouter un type</h3>'
    +    '<div class="row gap8">'
    +      '<input id="pr-add-name" placeholder="ex : Sortie de c√¢ble" />'
    +      + b('Ajouter','catPrAdd()','btn')
    +    '</div>'
    +    '<div class="h-note" style="margin-top:6px;">Les nouveaux types h√©ritent des tarifs actuels de ‚ÄúPrise‚Äù au moment de l‚Äôajout (modifiable ensuite).</div>'
    +  '</div>'
    +'</div>'
  );

  window.catPrAdd = function(){
    const name = (document.getElementById('pr-add-name').value||'').trim(); if(!name) return;
    const all = getPrestations();
    const P2 = all.appareillage.prises;
    if(!P2.tarifs[name]){
      P2.customTypes.push(name);
      P2.tarifs[name] = _clone(P2.tarifs["Prise"]||{});
      setPrestations(all);
    }
    pageCatPresta_Prise();
  };
  window.catPrDel = function(name){
    const all = getPrestations(); const P2 = all.appareillage.prises;
    if(P2.baseTypes.indexOf(name)!==-1) return;
    P2.customTypes = (P2.customTypes||[]).filter(n=>n!==name);
    delete P2.tarifs[name];
    setPrestations(all); pageCatPresta_Prise();
  };
  window.catPrSave = function(idx, name){
    const id = 'pr-'+idx;
    const all = getPrestations(); const P2=all.appareillage.prises;
    P2.tarifs[name] = {
      "Cr√©ation": _saveNum(id+'-c'),
      "Remplacement appareillage": _saveNum(id+'-ra'),
      "Rec√¢blage avec remplacement appareillage": _saveNum(id+'-rwa'),
      "Rec√¢blage sans remplacement appareillage": _saveNum(id+'-rs')
    };
    setPrestations(all); alert('Tarifs enregistr√©s.');
  };
}

/* ---- 13.5.2 Luminaires ---- */
function pageCatPresta_Luminaires(){
  const L = getPrestations().appareillage.luminaires;
  const list = (L.baseTypes||[]).filter(n=>n!=="Alimentation ligne de spot").concat(L.customTypes||[]);
  const rows = list.map((name,idx)=>{
    const t = L.tarifs[name] || {};
    const prefix = 'lum-'+idx;
    return (
      '<div class="block">'
      +  '<div class="row" style="justify-content:space-between;align-items:center;">'
      +    '<h3 style="margin:0;">'+_esc(name)+'</h3>'
      +    (L.baseTypes.indexOf(name)===-1 ? b('Supprimer','catLumDel('+JSON.stringify(name)+')','btn') : '')
      +  '</div>'
      +  '<div class="presta-grid">'
      +    _rowNum({id:prefix+'-c', label:'Cr√©ation'}, t["Cr√©ation"])
      +    _rowNum({id:prefix+'-rl',label:'Remplacement luminaire'}, t["Remplacement luminaire"])
      +    _rowNum({id:prefix+'-rwl',label:'Rec√¢blage avec remplacement luminaire'}, t["Rec√¢blage avec remplacement luminaire"])
      +    _rowNum({id:prefix+'-rsl',label:'Rec√¢blage sans remplacement luminaire'}, t["Rec√¢blage sans remplacement luminaire"])
      +  '</div>'
      +  '<div class="row gap8" style="margin-top:8px;">'
      +    b('Enregistrer','catLumSave('+idx+','+JSON.stringify(name)+')','btn')
      +  '</div>'
      +'</div>'
    );
  }).join('');

  const SP = L.tarifs["__spot_line__"] || {base_ligne:0, par_spot:0};
  const spotBlock =
    '<div class="block">'
    +  '<h3 style="margin:0 0 8px 0;">Alimentation ligne de spot</h3>'
    +  '<div class="presta-grid">'
    +    _rowNum({id:'spot-base', label:'Prix base ligne'}, SP.base_ligne)
    +    _rowNum({id:'spot-un',   label:'Prix par spot'}, SP.par_spot)
    +  '</div>'
    +  '<div class="row gap8" style="margin-top:8px;">'
    +    b('Enregistrer','catSpotSave()','btn')
    +  '</div>'
    +'</div>';

  view(
    '<div class="presta-wrap">'
    +  '<div class="card">'+ b('Retour','pageCataloguePrestation()','btn back') +'<h2>Catalogue prestation ‚Äî √âclairage / Luminaires</h2></div>'
    +  (rows || '') + spotBlock
    +  '<div class="card">'
    +    '<h3>Ajouter un type</h3>'
    +    '<div class="row gap8">'
    +      '<input id="lum-add-name" placeholder="ex : R√©glette LED" />'
    +      + b('Ajouter','catLumAdd()','btn')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );

  window.catLumAdd = function(){
    const name = (document.getElementById('lum-add-name').value||'').trim(); if(!name) return;
    const all = getPrestations(); const L2 = all.appareillage.luminaires;
    if(!L2.tarifs[name]){
      L2.customTypes.push(name);
      // h√©rite des tarifs de "Point de centre"
      L2.tarifs[name] = _clone(L2.tarifs["Point de centre"]||{});
      setPrestations(all);
    }
    pageCatPresta_Luminaires();
  };
  window.catLumDel = function(name){
    const all = getPrestations(); const L2 = all.appareillage.luminaires;
    if(L2.baseTypes.indexOf(name)!==-1) return;
    L2.customTypes = (L2.customTypes||[]).filter(n=>n!==name);
    delete L2.tarifs[name]; setPrestations(all); pageCatPresta_Luminaires();
  };
  window.catLumSave = function(idx, name){
    const id = 'lum-'+idx;
    const all = getPrestations(); const L2 = all.appareillage.luminaires;
    L2.tarifs[name] = {
      "Cr√©ation": _saveNum(id+'-c'),
      "Remplacement luminaire": _saveNum(id+'-rl'),
      "Rec√¢blage avec remplacement luminaire": _saveNum(id+'-rwl'),
      "Rec√¢blage sans remplacement luminaire": _saveNum(id+'-rsl')
    };
    setPrestations(all); alert('Tarifs enregistr√©s.');
  };
  window.catSpotSave = function(){
    const all = getPrestations(); const L2=all.appareillage.luminaires;
    L2.tarifs["__spot_line__"] = { base_ligne: _saveNum('spot-base'), par_spot: _saveNum('spot-un') };
    setPrestations(all); alert('Tarifs enregistr√©s.');
  };
}

/* ---- 13.5.3 Commandes ---- */
function pageCatPresta_Commandes(){
  const C = getPrestations().appareillage.commandes;
  const list = (C.baseTypes||[]).concat(C.customTypes||[]);
  const rows = list.map((name,idx)=>{
    const t = C.tarifs[name] || {};
    const prefix = 'cmd-'+idx;
    return (
      '<div class="block">'
      +  '<div class="row" style="justify-content:space-between;align-items:center;">'
      +    '<h3 style="margin:0;">'+_esc(name)+'</h3>'
      +    (C.baseTypes.indexOf(name)===-1 ? b('Supprimer','catCmdDel('+JSON.stringify(name)+')','btn') : '')
      +  '</div>'
      +  '<div class="presta-grid">'
      +    _rowNum({id:prefix+'-c', label:'Cr√©ation'}, t["Cr√©ation"])
      +    _rowNum({id:prefix+'-ra',label:'Remplacement appareillage'}, t["Remplacement appareillage"])
      +    _rowNum({id:prefix+'-rwa',label:'Rec√¢blage avec remplacement appareillage'}, t["Rec√¢blage avec remplacement appareillage"])
      +    _rowNum({id:prefix+'-rs', label:'Rec√¢blage sans remplacement appareillage'}, t["Rec√¢blage sans remplacement appareillage"])
      +  '</div>'
      +  '<div class="row gap8" style="margin-top:8px;">'
      +    b('Enregistrer','catCmdSave('+idx+','+JSON.stringify(name)+')','btn')
      +  '</div>'
      +'</div>'
    );
  }).join('');

  view(
    '<div class="presta-wrap">'
    +  '<div class="card">'+ b('Retour','pageCataloguePrestation()','btn back') +'<h2>Catalogue prestation ‚Äî √âclairage / Commandes</h2></div>'
    +  (rows || '<div class="card"><div class="muted">Aucun type.</div></div>')
    +  '<div class="card">'
    +    '<h3>Ajouter un type</h3>'
    +    '<div class="row gap8">'
    +      '<input id="cmd-add-name" placeholder="ex : Commande radio" />'
    +      + b('Ajouter','catCmdAdd()','btn')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );

  window.catCmdAdd = function(){
    const name = (document.getElementById('cmd-add-name').value||'').trim(); if(!name) return;
    const all = getPrestations(); const C2 = all.appareillage.commandes;
    if(!C2.tarifs[name]){
      C2.customTypes.push(name);
      C2.tarifs[name] = _clone(C2.tarifs["Allumage simple"]||{});
      setPrestations(all);
    }
    pageCatPresta_Commandes();
  };
  window.catCmdDel = function(name){
    const all = getPrestations(); const C2 = all.appareillage.commandes;
    if(C2.baseTypes.indexOf(name)!==-1) return;
    C2.customTypes = (C2.customTypes||[]).filter(n=>n!==name);
    delete C2.tarifs[name]; setPrestations(all); pageCatPresta_Commandes();
  };
  window.catCmdSave = function(idx, name){
    const id = 'cmd-'+idx;
    const all = getPrestations(); const C2 = all.appareillage.commandes;
    C2.tarifs[name] = {
      "Cr√©ation": _saveNum(id+'-c'),
      "Remplacement appareillage": _saveNum(id+'-ra'),
      "Rec√¢blage avec remplacement appareillage": _saveNum(id+'-rwa'),
      "Rec√¢blage sans remplacement appareillage": _saveNum(id+'-rs')
    };
    setPrestations(all); alert('Tarifs enregistr√©s.');
  };
}

/* ---- 13.5.4 Circuit sp√©cialis√© ---- */
function pageCatPresta_CS(){
  const CS = getPrestations().appareillage.circuit_spec;
  const list = (CS.baseTypes||[]).concat(CS.customTypes||[]);
  const rows = list.map((name,idx)=>{
    const t = CS.tarifs[name] || {};
    const prefix = 'cs-'+idx;
    return (
      '<div class="block">'
      +  '<div class="row" style="justify-content:space-between;align-items:center;">'
      +    '<h3 style="margin:0;">'+_esc(name)+'</h3>'
      +    (CS.baseTypes.indexOf(name)===-1 ? b('Supprimer','catCSDel('+JSON.stringify(name)+')','btn') : '')
      +  '</div>'
      +  '<div class="presta-grid">'
      +    _rowNum({id:prefix+'-c', label:'Cr√©ation'}, t["Cr√©ation"])
      +    _rowNum({id:prefix+'-ra',label:'Remplacement appareillage'}, t["Remplacement appareillage"])
      +    _rowNum({id:prefix+'-rwa',label:'Rec√¢blage avec remplacement appareillage'}, t["Rec√¢blage avec remplacement appareillage"])
      +    _rowNum({id:prefix+'-rs', label:'Rec√¢blage sans remplacement appareillage'}, t["Rec√¢blage sans remplacement appareillage"])
      +  '</div>'
      +  '<div class="row gap8" style="margin-top:8px;">'
      +    b('Enregistrer','catCSSave('+idx+','+JSON.stringify(name)+')','btn')
      +  '</div>'
      +'</div>'
    );
  }).join('');

  view(
    '<div class="presta-wrap">'
    +  '<div class="card">'+ b('Retour','pageCataloguePrestation()','btn back') +'<h2>Catalogue prestation ‚Äî Circuit sp√©cialis√©</h2></div>'
    +  (rows || '<div class="card"><div class="muted">Aucun type.</div></div>')
    +  '<div class="card">'
    +    '<h3>Ajouter un type</h3>'
    +    '<div class="row gap8">'
    +      '<input id="cs-add-name" placeholder="ex : Circuit sp√©cialis√© 4 mm¬≤" />'
    +      + b('Ajouter','catCSAdd()','btn')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );

  window.catCSAdd = function(){
    const name = (document.getElementById('cs-add-name').value||'').trim(); if(!name) return;
    const all = getPrestations(); const CS2 = all.appareillage.circuit_spec;
    if(!CS2.tarifs[name]){
      CS2.customTypes.push(name);
      CS2.tarifs[name] = _clone(CS2.tarifs["Circuit sp√©cialis√© 2,5 mm¬≤"]||{});
      setPrestations(all);
    }
    pageCatPresta_CS();
  };
  window.catCSDel = function(name){
    const all = getPrestations(); const CS2 = all.appareillage.circuit_spec;
    if(CS2.baseTypes.indexOf(name)!==-1) return;
    CS2.customTypes = (CS2.customTypes||[]).filter(n=>n!==name);
    delete CS2.tarifs[name]; setPrestations(all); pageCatPresta_CS();
  };
  window.catCSSave = function(idx, name){
    const id = 'cs-'+idx;
    const all = getPrestations(); const CS2 = all.appareillage.circuit_spec;
    CS2.tarifs[name] = {
      "Cr√©ation": _saveNum(id+'-c'),
      "Remplacement appareillage": _saveNum(id+'-ra'),
      "Rec√¢blage avec remplacement appareillage": _saveNum(id+'-rwa'),
      "Rec√¢blage sans remplacement appareillage": _saveNum(id+'-rs')
    };
    setPrestations(all); alert('Tarifs enregistr√©s.');
  };
}

/* ============================================================
   13.6 ‚Ä¢ Coefficients de pose
   ============================================================ */
function pageCatPresta_Coeffs(){
  const C = getCoeffs();
  function f(k){ return '<div class="field"><label>'+_esc(k)+'</label><input id="cf-'+_esc(k)+'" type="number" step="0.01" inputmode="decimal" value="'+(+C[k]||1)+'"/></div>'; }

  const keys = Object.keys(C);
  view(
    '<div class="presta-wrap">'
    +  '<div class="card">'+ b('Retour','pageCataloguePrestation()','btn back') +'<h2>Coefficients de pose</h2></div>'
    +  '<div class="card"><div class="presta-grid">'
    +    keys.map(f).join('')
    +  '</div>'
    +  '<div class="row gap8" style="margin-top:8px;">'
    +    b('Enregistrer','coeffSaveAll()','btn')
    +  '</div></div>'
    +'</div>'
  );

  window.coeffSaveAll = function(){
    const C2 = {};
    keys.forEach(k=>{ var el=document.getElementById('cf-'+k); C2[k]= Math.max(0, parseFloat(el.value)||1); });
    setCoeffs(C2); alert('Coefficients enregistr√©s.');
  };
}

/* ============================================================
   13.7 ‚Ä¢ Import / Export / Reset
   ============================================================ */
function presta13Export(){
  const raw = JSON.stringify({ prestations:getPrestations(), coeffs:getCoeffs() }, null, 2);
  const blob = new Blob([raw], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'catalogue_prestation_v1.json'; a.click(); URL.revokeObjectURL(url);
}
function presta13Import(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = function(){
    const f = input.files && input.files[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload = function(){
      try{
        const obj = JSON.parse(rd.result||'{}');
        if(obj.prestations) setPrestations(obj.prestations);
        if(obj.coeffs) setCoeffs(obj.coeffs);
        alert('Catalogue prestation import√©.'); pageCataloguePrestation();
      }catch(e){ alert('Import impossible : '+e.message); }
    };
    rd.readAsText(f,'utf-8');
  };
  input.click();
}
function presta13Reset(){
  if(!confirm('R√©initialiser le catalogue prestation et les coefficients ?')) return;
  localStorage.removeItem(KEY_PRESTA13);
  localStorage.removeItem(KEY_COEFFS13);
  alert('Catalogue r√©initialis√©.'); pageCataloguePrestation();
}

/* ============================================================
   13.8 ‚Ä¢ Expose
   ============================================================ */
Object.assign(window,{
  pageCataloguePrestation,
  pageCatPresta_Prise,
  pageCatPresta_Luminaires,
  pageCatPresta_Commandes,
  pageCatPresta_CS,
  pageCatPresta_Coeffs,
  presta13Export,
  presta13Import,
  presta13Reset,
  computePU // d√©j√† expos√© ci-dessus
});
</script>


  
  
  


  
<!-- =============================
     CHAPITRE 14 : D√âMARRAGE & EXPOSE
     Index :
       ¬ß0  ‚Ä¢ init() : chargement + reprise sauvegardes + pageMain()
       ¬ß1  ‚Ä¢ Expose : fonctions rendues accessibles (UI)
       ¬ß2  ‚Ä¢ Shim compat : neutralise les anciens appels goIntervention(...)
     ============================= -->
<script>
/* ======================
   ¬ß0 ‚Ä¢ D√âMARRAGE (init)
   ====================== */
function init(){
  try{
    // Charge l'√©tat courant
    loadLocal();

    // ‚úÖ Tentative de restauration si la liste des devis sauvegard√©s est vide
    // (fourni par le chapitre 4 robuste ‚Äî sans effet si absent)
    if (typeof recoverSavedIfEmpty === 'function') recoverSavedIfEmpty();

    // D√©marrage UI
    pageMain();
  }catch(err){
    var el = document.getElementById('app');
    if(el){
      el.innerHTML =
        '<div class="card"><h2>Erreur init()</h2><pre>'
        + ((err && err.stack) || String(err))
        + '</pre></div>';
    }
  }
}

/* ======================
   ¬ß1 ‚Ä¢ EXPOSE (window)
   ====================== */
Object.assign(window, {
  // Chap.4 ‚Äî Menu & sauvegarde (robuste)
  pageMain,
  actionNouveauDevis,
  pageSavedDevis,
  loadDevis,
  deleteDevis,
  saveCurrentDevis,
  exportSavedDevis,     // ‚ûï export .json (liste compl√®te)
  importSavedDevisUI,   // ‚ûï import .json (merge par __id)

  // Chap.5 ‚Äî Pi√®ces (flux one-page) + Ventilation (raccourci)
  pageHome,
  pageAddPiece,
  confirmPieceChoice,
  removePiece,
  goPiece,
  delLine,
  editPieceNote,
  pageSpecifiqueForm,
  saveSpecifique,
  pagePieceSpecifique: pageSpecifiqueForm, // alias
  goCategory,
  goEclairageSub,
  setEclairageBranch,
  pageOneShotSelection,
  saveOneShotItem,
  goVent, // bouton "Ventilation" (redirige vers pageVentAccueil si charg√©e)

  // Chap.6 ‚Äî Tableaux (multi-tableaux)
  pageTabCreate,
  saveTabCustomName,
  pageTabHome,
  pageTabPose,
  addTabPose,
  pageTab_ID,
  submitTab_ID,
  pageTab_Coupure,       // (coupure g√©n√©rale)
  submitTab_Coupure,     // (coupure g√©n√©rale)
  pageTab_Disjoncteurs,
  pageTab_DisjDetails,
  pageTab_DisjSaveDetails,
  pageTab_DisjValider,
  pageTabMod_Commandes,
  submitTabMod_Commandes,
  pageTabMod_Specifique,
  submitTabMod_Specifique,

  // Chap.7 ‚Äî Ventilation
  pageVentAccueil,
  pageVentNew,
  saveVentName,
  ventDelete,
  pageVentHome,
  pageVentCreation,
  kitConduitMut, kitPercMut, exConduitMut, exPercMut, vcPercMut,
  ventAddKit, ventAddExtracteur, ventAddVentilateur,
  pageVentRetirage,
  ventAddRetirage,
  pageVentEntretien, ventAddEntretien,

  // Chap.9 ‚Äî Estimatif & exports
  pageEstimatif,
  pageTotaux,
  exportText,
  exportZipGroups,
  exportTextFull,
  exportZipFull,

  // Navigation commune
  confirmBackHome
});

/* =========================================
   ¬ß2 ‚Ä¢ SHIM COMPAT (s√©curit√© anti-crash)
   - Si l‚Äôancienne fonction goIntervention est appel√©e
     via un vieux bouton, on neutralise proprement.
   ========================================= */
if (typeof window.goIntervention !== 'function') {
  window.goIntervention = function(){
    alert('‚ö†Ô∏è Ce raccourci "Intervention" n‚Äôest plus utilis√©.\n' +
          'Choisissez directement l‚Äôintervention dans la page de saisie.');
  };
}

// Lancement auto
init();
</script>










<!-- =============================
     CHAPITRE 15 : DUPLIQUER & RECALCULER AUX TARIFS ACTUELS
     - Bouton sur Estimatif & Totaux
     - Cr√©e un duplicata du devis courant avec PU recalcul√©s
     - N'√©crase rien (ajoute un nouveau devis dans la liste)
     ============================= -->
<script>
(function(){

/* ============ Helpers s√ªrs ============ */
function _safe(obj, path, def){
  try{
    return path.split('.').reduce((o,k)=> (o && k in o)? o[k] : undefined, obj) ?? def;
  }catch(e){ return def; }
}
function _num(x){ return +x || 0; }
function _clone(x){ return JSON.parse(JSON.stringify(x)); }
function _pickPoseCoef(pose){
  // Utilise COEFF_POSE si dispo, sinon 1
  var cp = (typeof COEFF_POSE==='object' && COEFF_POSE) ? COEFF_POSE : {};
  return +cp[pose] || 1;
}

/* ============ Repricing par familles ============ */
/* Prises, √âclairage, Circuit sp√©cialis√© ‚Üí TARIFS_BASE (+ COEFF_POSE si Cr√©ation) */
function repriceFromTarifsBase(it){
  var TB = (typeof TARIFS_BASE==='object' && TARIFS_BASE) ? TARIFS_BASE : null;
  if(!TB) return null;

  var cat  = String(it.category||'').trim();
  var des  = String(it.designation||'').trim();
  var intv = String(it.intervention||'').trim();
  var pose = String(it.pose||'').trim();
  var pu   = null;

  if(/^Prises$/i.test(cat)){
    pu = _safe(TB, 'prises["'+des+'"]["'+intv+'"]', null);
    if(pu==null && TB.prises && TB.prises[des] && TB.prises[des]['Cr√©ation']!=null && intv==='Cr√©ation'){
      pu = TB.prises[des]['Cr√©ation']; // fallback
    }
    if(pu!=null && intv==='Cr√©ation' && pose){
      pu = pu * _pickPoseCoef(pose);
    }
    return (pu!=null)? roundUp5(pu) : null;
  }

  if(/^√âclairage\/Luminaires$/i.test(cat) || /^√âclairage\/Commandes$/i.test(cat)){
    pu = _safe(TB, 'eclairage["'+des+'"]["'+intv+'"]', null);
    if(pu!=null && intv==='Cr√©ation' && pose){
      pu = pu * _pickPoseCoef(pose);
    }
    return (pu!=null)? roundUp5(pu) : null;
  }

  // Circuit sp√©cialis√© : on tente d'abord par d√©signation (v13)
  pu = _safe(TB, 'circuit_specialise["'+des+'"]["'+intv+'"]', null);
  if(pu!=null && intv==='Cr√©ation' && pose){
    pu = pu * _pickPoseCoef(pose);
  }
  if(pu!=null) return roundUp5(pu);

  // Sinon, si base g√©n√©rique existe on l‚Äôutilise (sans section ici)
  pu = _safe(TB, 'circuit_specialise_base["'+intv+'"]', null);
  if(pu!=null && intv==='Cr√©ation' && pose){
    pu = pu * _pickPoseCoef(pose);
  }
  return (pu!=null)? roundUp5(pu) : null;
}

/* Tableau & distribution (Chap.6/9) ‚Üí TARIFS_TABLEAU + fonctions de calcul si dispo */
function repriceTableauLike(it){
  var des  = String(it.designation||'').trim();
  var intv = String(it.intervention||'').trim();
  var pose = String(it.pose||'').trim();
  var TTab = (typeof TARIFS_TABLEAU==='object' && TARIFS_TABLEAU) ? TARIFS_TABLEAU : {};

  // Pose tableau ‚Äî r rang√©e(s), m modules
  // Exemple : "Pose tableau ‚Äî 2 rang√©e(s), 18 modules"
  var m1 = /^Pose tableau\s+‚Äî\s+(\d+)\s+rang√©e\(s\),\s*(\d+)\s+modules/i.exec(des);
  if(m1 && typeof getTabPrice==='function'){
    var rangs = +m1[1]||1, modules=+m1[2]||13;
    var pu = +getTabPrice(rangs, modules, pose||'Saillie', intv||'Cr√©ation')||0;
    return roundUp5(pu);
  }

  // Interrupteurs diff√©rentiels : "ID 30mA ‚Äî 40A - Type A"
  var m2 = /^ID\s*30mA\s*‚Äî\s*(\d+A\s*-\s*Type\s*(A|AC))/i.exec(des);
  if(m2){
    var key = String(m2[1]||'').toUpperCase().replace(/\s+/g,'').replace('TYPE','Type ').replace('A-','A - ');
    // Cl√©s attendues : "40A - Type A" | "40A - Type AC" | "63A - Type A" | ...
    var pu = _safe(TTab, 'inter_diff["'+key.replace(/\s{2,}/g,' ')+'"]', null);
    return (pu!=null)? roundUp5(+pu) : null;
  }

  // Disjoncteurs : "Disjoncteur 20 A ..."  ou "Disjoncteur 40 A ‚Äî circuits : ..."
  var m3 = /^Disjoncteur\s+(\d+)\s*A\b/i.exec(des);
  if(m3){
    var r = +m3[1]||0;
    var pu = _safe(TTab, 'disjoncteurs["'+r+'"]', null);
    if(pu==null && r===40) pu = 45; // fallback d√©j√† en vigueur dans V10.0
    return (pu!=null)? roundUp5(+pu) : null;
  }

  // Commandes tableau : d√©signation = cl√© exacte du tarif
  if(/^Tableau\/Commandes$/i.test(String(it.category||'')) && TTab.commandes){
    var pu = TTab.commandes[des];
    return (pu!=null)? roundUp5(+pu) : null;
  }

  // Modifications de tableau ‚Äî totaux calcul√©s (Chap.9)
  // (a) D√©placement : "Circuits √† rallonger : N ‚Äî Bo√Æte : LABEL ‚Äî Goulotte : X m"
  if(/^Modification emplacement Tableau$/i.test(String(it.category||'')) && typeof calcDeplacementTotal==='function'){
    var m = /Circuits √† rallonger\s*:\s*(\d+)\s*‚Äî\s*Bo√Æte\s*:\s*([^‚Äî]+?)\s*‚Äî\s*Goulotte\s*:\s*([\d.,]+)\s*m/i.exec(des);
    if(m){
      var n  = +m[1]||0;
      var lbl= (m[2]||'').trim();
      var id = 'NONE';
      // on remappe le label en id minimalement
      if(/100\s*√ó\s*150/i.test(lbl)) id='100x150';
      else if(/150\s*√ó\s*200/i.test(lbl)) id='150x200';
      else if(/200\s*√ó\s*250/i.test(lbl)) id='200x250';
      else if(/300\s*√ó\s*350/i.test(lbl)) id='300x350';
      var lm = parseFloat((m[3]||'0').replace(',','.'))||0;
      return roundUp5(+calcDeplacementTotal(n, id, lm)||0);
    }
  }
  // (b) Remplacement coffret : "N rang√©e(s) √ó 18 modules ‚Äî Pose Encastr√©"
  if(/^Remplacement coffret$/i.test(String(it.category||'')) && typeof calcRemplacementCoffretTotal==='function'){
    var mr = /(\d+)\s*rang√©e\(s\).*?(\d+)\s*modules.*?Pose\s*(Saillie|Encastr√©)/i.exec(des);
    if(mr){
      var rang = +mr[1]||1, modTxt = (mr[2]||'13')+' modules', p = mr[3]||'Saillie';
      return roundUp5(+calcRemplacementCoffretTotal(rang, modTxt, p)||0);
    }
  }
  // (c) Rec√¢blage circuits
  if(/^Rec√¢blage tableau existant ‚Äî Circuits$/i.test(String(it.category||'')) && typeof calcRecabCircuits==='function'){
    var mc = /Nombre de circuits √† rec√¢bler\s*:\s*(\d+)/i.exec(des);
    if(mc){ return roundUp5(+calcRecabCircuits(+mc[1]||0)||0); }
  }
  // (d) Rec√¢blage mat√©riel suppl. ‚Üí prix √† l'unit√© saisi : on le laisse tel quel

  return null; // pas de meilleure r√®gle
}

/* ============ D√©cideur PU ============ */
function computeNewPU(it){
  // 1) familles ‚Äúcatalogue de pose‚Äù
  var p1 = repriceFromTarifsBase(it);
  if(p1!=null) return p1;

  // 2) familles ‚Äútableau / mods‚Äù sp√©cifiques
  var p2 = repriceTableauLike(it);
  if(p2!=null) return p2;

  // 3) pas de recalcul possible ‚Üí conserve PU d‚Äôorigine
  return +it.prixU || 0;
}

/* ============ Moteur de duplication ============ */
function duplicateDevisWithCurrentTarifs(){
  if(!window.devis || typeof devis!=='object'){ alert('Aucun devis en cours.'); return; }

  // Choisir la source (devis courant)
  var src = devis;
  var baseName = (src.__name || 'Devis') + ' ‚Äî recalcul√©';
  var newName = prompt('Nom pour le duplicata recalcul√© :', baseName) || baseName;

  // Nouveau conteneur de devis (copie profonde, puis recalcul)
  var dst = _clone(src);

  // Nouveau ID + nom
  dst.__id = 'dv_'+Date.now()+'_'+Math.random().toString(36).slice(2,8);
  dst.__name = newName;

  // Repricing ligne √† ligne
  for (var key in dst){
    if(key.indexOf('__')===0) continue; // m√©ta
    var sect = dst[key];
    if(!sect || !Array.isArray(sect.items)) continue;

    sect.items = sect.items.map(function(it){
      var out = _clone(it);
      // Cas ‚ÄúSp√©cifique‚Äù utilisateur ‚Üí on ne touche pas
      var isSpec = /sp√©cifique/i.test(String(out.category||'')) || /sp√©cifique/i.test(String(out.designation||''));
      if(isSpec) return out;

      // Recalcul PU
      out.prixU = computeNewPU(out);
      return out;
    });
  }

  // Enregistrer dans la liste multi-devis (si disponible) ou remplacer ‚Äúcourant‚Äù
  // Chapitre 4 fournit normalement un stockage multi-devis.
  try{
    if(typeof saveCurrentDevis === 'function'){
      // Sauvegarde le devis courant actuel dans l‚Äôhistorique
      saveCurrentDevis(); 
    }
  }catch(e){}

  // Injecte ce duplicata comme ‚Äúdevis courant‚Äù puis persiste
  window.devis = dst;
  try{ if(typeof saveLocal==='function') saveLocal(); }catch(e){}

  alert('‚úÖ Duplicata cr√©√© avec r√©-application des tarifs actuels.\nNom : '+newName);
  // Retour √† l‚Äôestimatif pour contr√¥le
  if(typeof pageEstimatif==='function') pageEstimatif();
}

/* ============ Injection UI : Estimatif & Totaux ============ */
function injectButtonOnce(){
  function injectIn(fnName){
    var orig = window[fnName];
    if(typeof orig !== 'function') return;

    window[fnName] = function(){
      orig();
      var app = document.getElementById('app'); if(!app) return;
      if(app.innerHTML.indexOf('duplicateDevisWithCurrentTarifs()')!==-1) return;

      // On ajoute le bouton juste apr√®s la ligne des exports
      app.innerHTML = app.innerHTML.replace(
        /(Export \.zip \(complet\).*?<\/div>\s*<\/div>)/,
        '$1<div class="row" style="margin-top:10px;">'
        + '<button class="btn" onclick="duplicateDevisWithCurrentTarifs()">Dupliquer avec nouveaux tarifs</button>'
        + '</div>'
      );
    };
  }
  injectIn('pageEstimatif');
  injectIn('pageTotaux');
}
injectButtonOnce();

/* ============ Expose global ============ */
Object.assign(window, {
  duplicateDevisWithCurrentTarifs
});

})();
</script>
<script>
/* Patch : apr√®s cr√©ation du duplicata, on l‚Äôenregistre r√©ellement
   dans la liste multi-devis puis on ouvre l‚Äô√©cran ‚ÄúDevis sauvegard√©s‚Äù. */
(function(){
  if (typeof window.duplicateDevisWithCurrentTarifs !== 'function') return;

  const _orig = window.duplicateDevisWithCurrentTarifs;

  window.duplicateDevisWithCurrentTarifs = function(){
    // 1) on laisse la logique de duplication/repricing faire son travail
    _orig();

    // 2) √Ä ce stade, window.devis contient le duplicata (dst) et __name est pos√©.
    try{
      // Sauvegarde locale ‚Äúcourant‚Äù
      if (typeof saveLocal === 'function') saveLocal();

      // Ajout √† la liste des devis sauvegard√©s (chapitre 4)
      // => IMPORTANT : on sauve APRES avoir remplac√© window.devis par le duplicata
      if (typeof saveCurrentDevis === 'function') saveCurrentDevis();

      // Optionnel : on affiche directement la liste pour que tu voies le duplicata
      if (typeof pageSavedDevis === 'function') pageSavedDevis();
    }catch(e){
      console.warn('Sauvegarde duplicata :', e);
      alert('Le duplicata a bien √©t√© cr√©√©. Si tu ne le vois pas dans la liste, utilise ‚ÄúSauvegarder le devis‚Äù.');
    }
  };
})();
</script>
  
<script>
/* ============================================================
   CHAPITRE 15.2 ‚Äî DUPLICATION + REPRICING PROPRE
   - Ne touche pas aux chapitres existants
   - Recalcule prixU √† partir des param√®tres actuels
   - Sauvegarde le duplicata dans ‚ÄúDevis sauvegard√©s‚Äù
   ============================================================ */

/* ---------- Helpers s√ªrs ---------- */
function _deepClone(obj){ try{ return JSON.parse(JSON.stringify(obj)); } catch(e){ return obj; } }
function _get(obj, path, def){
  try{ return path.split('.').reduce((o,k)=> (o && k in o)? o[k] : undefined, obj) ?? def; }catch(e){ return def; }
}
function _poseCoef(pose){
  if (!pose) return 1;
  const map = (window.COEFF_POSE||{});
  return +map[pose] > 0 ? +map[pose] : 1;
}
function _round5(x){ x = +x||0; return Math.ceil(x/5)*5; }

/* ---------- Repricing : familles g√©n√©rales ---------- */
function repricePrise(it){
  // Attendu : it.category ~ "Prises", it.designation = libell√© connu dans TARIFS_BASE.prises
  const base  = (window.TARIFS_BASE && TARIFS_BASE.prises) ? TARIFS_BASE.prises : {};
  const price = _get(base, it.designation + '.' + it.intervention, null);
  if (price==null) return it.prixU; // pas trouv√© ‚Üí on ne change pas
  const coef  = (it.intervention === 'Cr√©ation') ? _poseCoef(it.pose) : 1;
  return _round5((+price||0) * coef);
}

function repriceEclLuminaires(it){
  // it.category ~ "√âclairage/Luminaires"
  const base  = (window.TARIFS_BASE && TARIFS_BASE.eclairage) ? TARIFS_BASE.eclairage : {};
  const price = _get(base, it.designation + '.' + it.intervention, null); // libell√©s "luminaire"
  if (price==null) return it.prixU;
  const coef  = (it.intervention === 'Cr√©ation') ? _poseCoef(it.pose) : 1;
  return _round5((+price||0) * coef);
}

function repriceEclCommandes(it){
  // it.category ~ "√âclairage/Commandes"
  const base  = (window.TARIFS_BASE && TARIFS_BASE.eclairage) ? TARIFS_BASE.eclairage : {};
  const price = _get(base, it.designation + '.' + it.intervention, null); // libell√©s ‚Äúappareillage‚Äù
  if (price==null) return it.prixU;
  const coef  = (it.intervention === 'Cr√©ation') ? _poseCoef(it.pose) : 1;
  return _round5((+price||0) * coef);
}

function repriceCircuitSpecialise(it){
  // On tente d'abord un tarif sp√©cifique par d√©signation, sinon la base + √©ventuel coef de section.
  const TB   = (window.TARIFS_BASE || {});
  const spec = TB.circuit_specialise || {};
  const base = TB.circuit_specialise_base || {};
  let price  = _get(spec, it.designation + '.' + it.intervention, null);
  if (price==null) price = _get(base, it.intervention, null);
  if (price==null) return it.prixU;

  // D√©tection (facultative) d‚Äôune section dans la d√©signation ‚Üí applique COEFF_SECTIONS_CS si trouv√©e
  const m = /(\d+(?:,\d+)?)\s*mm¬≤/i.exec(it.designation||'');
  let coefSection = 1;
  if (m && window.COEFF_SECTIONS_CS){
    const key = (m[1].replace('.',',')+' mm¬≤').trim(); // ex "2,5 mm¬≤"
    if (+COEFF_SECTIONS_CS[key] > 0) coefSection = +COEFF_SECTIONS_CS[key];
  }
  const coefPose = (it.intervention === 'Cr√©ation') ? _poseCoef(it.pose) : 1;
  return _round5((+price||0) * coefSection * coefPose);
}

/* ---------- Repricing : √©l√©ments de TABLEAU ---------- */
function _parseIntFirst(s, def){ const m = /(\d+)/.exec(String(s||'')); return m? +m[1] : (def||0); }

function repriceTableauPose(it){
  // designation: "Pose tableau ‚Äî X rang√©e(s), Y modules"; champs it.intervention & it.pose sont pr√©sents
  if (typeof window.getTabPrice !== 'function') return it.prixU;
  const mR = /(\d+)\s*rang/i.exec(it.designation||'');
  const mM = /(\d+)\s*modules?/i.exec(it.designation||'');
  const rangs = mR? +mR[1] : 1;
  const modules = mM? +mM[1] : 13;
  const pu = window.getTabPrice(rangs, modules, it.pose||'Saillie', it.intervention||'Cr√©ation');
  return (+pu||0) ? _round5(+pu) : it.prixU;
}

function repriceTableauID(it){
  // designation: "ID 30mA ‚Äî 40A - Type A" etc.
  const TT = (window.TARIFS_TABLEAU||{});
  const map = TT.inter_diff || {};
  const s = String(it.designation||'');
  const isA  = /Type\s*A\b/i.test(s);
  const isAC = /Type\s*AC\b/i.test(s);
  const amp  = _parseIntFirst(s, 40);
  const key  = (amp + (isA? 'A' : (isAC? 'AC' : 'AC'))).replace(/([0-9]+)(A|AC)/i, '$1-$2'); // e.g. "40-AC"
  const targetKey = (isA ? (amp+'A') : (amp+'-AC')).replace('A','-A'); // "40-A" ou "40-AC"
  const price = map[targetKey] || map[key] || null;
  return (price!=null) ? _round5(+price||0) : it.prixU;
}

function repriceTableauCoupure(it){
  // designation: "Coupure g√©n√©rale 45 A" (les tarifs sont souvent constants/fixes)
  // Si tarif d√©fini dans TARIFS_TABLEAU.coupure, on l‚Äôutilise, sinon on garde.
  const TT = (window.TARIFS_TABLEAU||{});
  const map = TT.coupure || {};
  const amp = _parseIntFirst(it.designation, 0);
  const price = map[amp] || null;
  return (price!=null) ? _round5(+price||0) : it.prixU;
}

function repriceTableauDisjoncteur(it){
  // designation: "Disjoncteur 20 A ‚Äî circuits : ‚Ä¶"
  const TT = (window.TARIFS_TABLEAU||{});
  const map = TT.disjoncteurs || {};
  const amp = _parseIntFirst(it.designation, 0);
  const price = map[amp];
  return (price!=null) ? _round5(+price||0) : it.prixU;
}

function repriceTableauCommande(it){
  // category: "Tableau/Commandes", designation = libell√© mod√®le
  const TT = (window.TARIFS_TABLEAU||{});
  const map = TT.commandes || {};
  const price = map[it.designation] ?? null;
  return (price!=null) ? _round5(+price||0) : it.prixU;
}

/* ---------- Routeur de repricing par cat√©gorie ---------- */
function repriceItem(it, pieceKey){
  const cat = String(it.category||'').trim();

  try{
    if (/^Prises$/i.test(cat))                         return repricePrise(it);
    if (/^√âclairage\/Luminaires$/i.test(cat))          return repriceEclLuminaires(it);
    if (/^√âclairage\/Commandes$/i.test(cat))           return repriceEclCommandes(it);
    if (/^Circuit\s*sp[√©e]cialis[√©e]$/i.test(cat))     return repriceCircuitSpecialise(it);

    // TABLEAU (plusieurs sous-cat√©gories)
    if (/^Tableau\s*&\s*distribution$/i.test(cat))     return it.prixU; // regroupe des totaux/ligne libre ‚Üí on ne touche pas
    if (/^Tableau\/Modulaire$/i.test(cat)){
      const s = String(it.designation||'');
      if (/^ID\s*30mA/i.test(s))                       return repriceTableauID(it);
      if (/^Disjoncteur\s/i.test(s))                   return repriceTableauDisjoncteur(it);
      return it.prixU;
    }
    if (/^Tableau\/Commandes$/i.test(cat))             return repriceTableauCommande(it);
    if (/^Tableau\s*&\s*distribution$/i.test(cat))     return it.prixU;
    if (/^Tableau\s*&\s*distribution/i.test(cat))      return it.prixU;

    // Pose du tableau (cr√©ation)
    if (/^Tableau\s*&\s*distribution$/i.test(cat))     return it.prixU;

    // Certains √©crans rangent la pose du tableau avec category:"Tableau & distribution"
    if (/^Tableau\s*&\s*distribution$/i.test(cat) && /^Pose tableau/i.test(String(it.designation||''))){
      return repriceTableauPose(it);
    }
    if (/^Tableau\s*&\s*distribution$/i.test(cat) && /Remplacement coffret/i.test(String(it.category||''))){
      return it.prixU;
    }

    // Ventilation / Mise √† la terre / Sp√©cifique : souvent prixU manuels ‚Üí ne pas modifier
    return it.prixU;
  }catch(e){
    console.warn('Reprice item error', e, it);
    return it.prixU;
  }
}

/* ---------- Reprice d‚Äôun DEVIS complet ---------- */
function repriceDevisFromTarifs(srcDevis){
  const dst = _deepClone(srcDevis||{});
  for (var key in dst){
    if (key.indexOf('__')===0) continue;
    const section = dst[key];
    const items = Array.isArray(section.items) ? section.items : [];
    items.forEach(function(it, idx){
      const newPU = repriceItem(it, key);
      if (typeof newPU === 'number' && isFinite(newPU)) it.prixU = newPU;
    });
  }
  return dst;
}

/* ---------- Duplication + Repricing + Sauvegarde ---------- */
function duplicateDevisWithCurrentTarifs_REPRICE(){
  if (!window.devis){ alert('Aucun devis courant.'); return; }

  // 1) Recalcule les PU selon les param√®tres actuels
  const src = window.devis;
  const dup = repriceDevisFromTarifs(src);

  // 2) Marqueur & nom
  dup.__id   = (src.__id ? (src.__id + '_repriced_' + Date.now()) : ('repriced_' + Date.now()));
  dup.__name = (src.__name||'Devis') + ' ‚Äî (repricing ' + new Date().toLocaleString() + ')';

  // 3) Deviens le devis courant
  window.devis = dup;

  // 4) Sauvegarde dans ‚ÄúDevis sauvegard√©s‚Äù (chap.4) + ouverture liste
  if (typeof saveLocal === 'function') saveLocal();
  if (typeof saveCurrentDevis === 'function') saveCurrentDevis();
  if (typeof pageSavedDevis === 'function') pageSavedDevis();

  alert('‚úÖ Duplicata cr√©√© avec r√©-√©valuation des tarifs.');
}

/* ---------- Bouton (si tu veux l‚Äôexposer rapidement) ---------- */
(function injectButton(){
  const orig = window.pageEstimatif;
  if (typeof orig !== 'function') return;

  window.pageEstimatif = function(){
    orig();
    const app = document.getElementById('app'); if(!app) return;
    const label = 'üß™ Dupliquer avec tarifs actuels';
    if (app.innerHTML.indexOf('duplicateDevisWithCurrentTarifs_REPRICE()') === -1){
      app.innerHTML = app.innerHTML.replace(
        /(Export \.zip \(complet\).*?<\/div>\s*<\/div>)/,
        '$1<div class="row" style="margin-top:10px;">'
        + '<button class="btn" onclick="duplicateDevisWithCurrentTarifs_REPRICE()">'+label+'</button>'
        + '</div>'
      );
    }
  };
})();
</script>







  


<!-- =============================
     CHAPITRE 15 : MOTEUR TARIFAIRE & DUPLICATION (V10.x)
     - Recalcule le devis courant selon les tarifs en vigueur (Chap.13)
     - Duplique un devis en appliquant les nouveaux tarifs
     - Injection de 2 boutons dans Estimatif + Totaux
     ============================= -->
<script>
/* ============================================================
   ¬ß15.0 ‚Ä¢ D√©pendances attendues (d√©j√† pr√©sentes dans l‚Äôapp)
   - devis : objet de travail courant
   - saveLocal(), loadLocal()
   - saved devis utils (Chap.4) : saveCurrentDevis(), export/import existent d√©j√†
   - TARIFS_BASE : aliment√© par Chapitre 13 (pageCataloguePrestation/applyPrestToApp)
   - COEFFS_POSE / TARIFS_COEFS : si utiles plus tard
   ============================================================ */

/* ============================================================
   ¬ß15.1 ‚Ä¢ R√©solution de tarif (d√©signation + intervention)
   - On cherche d‚Äôabord dans PRISES, puis ECLAIRAGE, puis CIRCUIT_SP√â
   - On g√®re quelques synonymes d‚Äôinterventions historiques
   ============================================================ */
(function(){
  const SYN_INTERV = {
    // normalisation d‚Äôinterventions historiques vers nos cl√©s actuelles
    "Remplacement": "Remplacement appareillage",
    "Remplacement luminaire (ancien)": "Remplacement luminaire",
    "Recablage avec remplacement appareillage": "Rec√¢blage avec remplacement appareillage",
    "Recablage sans remplacement appareillage": "Rec√¢blage sans remplacement appareillage",
    "Recablage avec remplacement luminaire": "Rec√¢blage avec remplacement luminaire",
    "Recablage sans remplacement luminaire": "Rec√¢blage sans remplacement luminaire"
  };

  function _normIntervention(interv){
    if(!interv) return "Cr√©ation";
    const k = String(interv).trim();
    return SYN_INTERV[k] || k;
  }

  function _findTarif(designation, intervention){
    if(!window.TARIFS_BASE) return null;
    const inter = _normIntervention(intervention);
    const name  = String(designation||'').trim();

    // 1) PRISES
    const tP = (TARIFS_BASE.prises && TARIFS_BASE.prises[name]);
    if(tP && tP[inter] != null) return +tP[inter];

    // 2) √âCLAIRAGE
    const tE = (TARIFS_BASE.eclairage && TARIFS_BASE.eclairage[name]);
    if(tE && tE[inter] != null) return +tE[inter];

    // 3) CIRCUITS SP√âCIALIS√âS
    const tC = (TARIFS_BASE.circuit_specialise && TARIFS_BASE.circuit_specialise[name]);
    if(tC && tC[inter] != null) return +tC[inter];

    // 4) fallback : si l‚Äôintervention n‚Äôexiste pas mais qu‚Äôil y a ‚ÄúCr√©ation‚Äù on la prend
    if(tP && tP["Cr√©ation"] != null) return +tP["Cr√©ation"];
    if(tE && tE["Cr√©ation"] != null) return +tE["Cr√©ation"];
    if(tC && tC["Cr√©ation"] != null) return +tC["Cr√©ation"];

    return null;
  }

  window.__tarifResolverV10 = { _findTarif, _normIntervention };
})();

/* ============================================================
   ¬ß15.2 ‚Ä¢ Repricing d‚Äôun devis (objet) en place
   - options:
       {applyCoeffs: false} -> r√©serv√© pour futur (on garde off par d√©faut)
   ============================================================ */
function repriceDevisObjectV10(draft, options){
  if(!draft || typeof draft!=='object') return { changed:0, total:0 };
  const { _findTarif, _normIntervention } = window.__tarifResolverV10 || {};
  if(!_findTarif) return { changed:0, total:0 };

  let changed = 0, total = 0;

  for(const key in draft){
    if(key.indexOf('__')===0) continue;
    const section = draft[key]; if(!section || !Array.isArray(section.items)) continue;

    section.items.forEach(it=>{
      const q = +it.qty || 0;
      const oldPU = +it.prixU || 0;

      const designation  = it.designation || '';
      const intervention = _normIntervention(it.intervention || '');

      const newPU = _findTarif(designation, intervention);
      if(newPU != null && newPU >= 0){
        if(newPU !== oldPU){
          it.prixU = +newPU;
          changed++;
        }
        total += (+newPU) * q;
      }else{
        total += oldPU * q; // on garde le PU existant si non reconnu
      }
    });
  }
  return { changed, total };
}

/* ============================================================
   ¬ß15.3 ‚Ä¢ Actions : Recalculer (devis courant) & Dupliquer
   ============================================================ */
function repriceCurrentDevisV10(){
  if(!window.devis){ alert('Aucun devis charg√©.'); return; }
  const res = repriceDevisObjectV10(window.devis, {applyCoeffs:false});
  if(typeof saveLocal==='function') saveLocal();
  alert('‚úÖ Tarifs recalcul√©s.\nLignes modifi√©es : '+res.changed);
  // rafra√Æchir l‚Äô√©cran courant si besoin
  if(typeof pageEstimatif==='function'){
    try{ pageEstimatif(); }catch(e){}
  }
}

function duplicateDevisWithNewTarifsV10(){
  if(!window.devis){ alert('Aucun devis charg√©.'); return; }

  // clone profond
  const dup = JSON.parse(JSON.stringify(window.devis));
  // renommer
  const base = (dup.__name || 'Devis');
  dup.__name = base.replace(/\s*\(.*\)\s*$/,'') + ' (recalcul tarifs)';

  const res = repriceDevisObjectV10(dup, {applyCoeffs:false});

  // sauvegarde dans la liste des devis sauvegard√©s (Chap.4)
  try{
    // helpers du Chap.4
    if(typeof window.ensureSavedList==='function'){
      window.ensureSavedList();
    }
    // structure : savedDevisList [{id, name, ts, data}]
    const key = 'savedDevisList_v2';
    const list = JSON.parse(localStorage.getItem(key)||'[]');
    const id   = 'dv_'+Date.now();
    list.push({ id, name: dup.__name||'Devis', ts: Date.now(), data: dup });
    localStorage.setItem(key, JSON.stringify(list));
    alert('‚úÖ Duplicata cr√©√© avec nouveaux tarifs.\nLignes modifi√©es : '+res.changed+'\nRetrouve-le dans ‚ÄúMes devis sauvegard√©s‚Äù.');
  }catch(e){
    console.error(e);
    alert('Le duplicata n‚Äôa pas pu √™tre sauvegard√©.');
  }
}

/* ============================================================
   ¬ß15.4 ‚Ä¢ Injection des boutons (Estimatif & Totaux)
   ============================================================ */
(function injectButtons15(){
  const addButtons = (html)=>{
    if(html.indexOf('repriceCurrentDevisV10()')!==-1) return html; // d√©j√† inject√©
    return html.replace(
      /(Export \.zip \(complet\).*?<\/div>\s*<\/div>)/,
      '$1'
      + '<div class="row" style="margin-top:10px;">'
      +   '<button class="btn" onclick="repriceCurrentDevisV10()">üîÑ Recalculer tarifs (devis courant)</button>'
      +   '<button class="btn primary" onclick="duplicateDevisWithNewTarifsV10()">üß≠ Dupliquer avec nouveaux tarifs</button>'
      + '</div>'
    );
  };

  if(typeof window.pageEstimatif === 'function'){
    const orig = window.pageEstimatif;
    window.pageEstimatif = function(){
      orig();
      const app = document.getElementById('app'); if(app) app.innerHTML = addButtons(app.innerHTML);
    };
  }
  if(typeof window.pageTotaux === 'function'){
    const orig2 = window.pageTotaux;
    window.pageTotaux = function(){
      orig2();
      const app = document.getElementById('app'); if(app) app.innerHTML = addButtons(app.innerHTML);
    };
  }
})();

/* ============================================================
   ¬ß15.5 ‚Ä¢ Expose
   ============================================================ */
Object.assign(window, {
  repriceDevisObjectV10,
  repriceCurrentDevisV10,
  duplicateDevisWithNewTarifsV10
});
</script>


















<!-- =============================
     CHAPITRE 16A : G√âN√âRATION DE DEVIS (UI & Donn√©es)
     - Fiche client (LS)
     - CGV √©ditables (LS)
     - Page de pr√©paration
     - Aucune modification destructive
     ============================= -->

<style>
  .dv-wrap .card{ margin-bottom:16px; }
  .dv-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .dv-field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .dv-field label{ display:block; font-weight:600; margin-bottom:6px; }
  .dv-note{ color:var(--muted); font-size:14px; }
  .dv-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
</style>

<script>
/* =========================
   ¬ß16A.0 ‚Ä¢ Cl√©s LS + helpers
   ========================= */
const KEY_DEVIS_CGV = 'devis_cgv_v1';
const KEY_DEVIS_LASTCLIENT = 'devis_last_client_v1';

function _rdJSON16(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function _wrJSON16(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

function _getCompany16(){ try{ return JSON.parse(localStorage.getItem('companyConfig_v1')||'null') || {}; }catch(e){ return {}; } }
function _getPrefs16(){ try{ return JSON.parse(localStorage.getItem('appPrefs_v1')||'null') || {}; }catch(e){ return {}; } }

function _todayFR16(){
  try{ return new Date().toLocaleDateString('fr-FR', {year:'numeric',month:'2-digit',day:'2-digit'}); }
  catch(e){ return new Date().toLocaleDateString(); }
}
function _pad4(n){ return String(n).padStart(4,'0'); }
function _esc16(s){ return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function _euro16(n){
  if (typeof euro === 'function') return euro(n);
  const v = +(n||0);
  return v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2})+' ‚Ç¨';
}

/* =========================
   ¬ß16A.1 ‚Ä¢ Donn√©es Client + CGV
   ========================= */
function _getClient16(){
  return _rdJSON16(KEY_DEVIS_LASTCLIENT, { nom:'', adresse:'', cp:'', ville:'', email:'', tel:'' });
}
function _setClient16(obj){ _wrJSON16(KEY_DEVIS_LASTCLIENT, obj||{}); }

function _getCGV16(){
  return _rdJSON16(KEY_DEVIS_CGV,
`Conditions g√©n√©rales de vente
- Validit√© du devis : 30 jours.
- D√©lai de paiement : 30 jours fin de mois par virement.
- Les travaux seront r√©alis√©s selon les r√®gles de l‚Äôart.
- Toute modification hors devis fera l‚Äôobjet d‚Äôun avenant.
- Les fournitures et la pose sont garanties selon les conditions l√©gales.`);
}
function _setCGV16(txt){ _wrJSON16(KEY_DEVIS_CGV, String(txt||'')); }

/* =========================
   ¬ß16A.2 ‚Ä¢ UI : Pr√©paration devis
   ========================= */
function pageDevisPDF16(){
  const cli   = _getClient16();
  const cgv   = _getCGV16();
  const prefs = _getPrefs16();

  const devName   = (window.devis && devis.__name) ? devis.__name : 'Devis';
  const prefix    = (prefs.numerotation_prefix || 'DEV-');
  const numCourant= Math.max(1, parseInt(prefs.numerotation_courante||1,10));
  const ref       = prefix + _pad4(numCourant);

  view(
    '<div class="dv-wrap">'
    +  '<div class="card">'
    +     (typeof b==='function' ? b('Retour','pageEstimatif ? pageEstimatif() : pageMain()','btn back') : '')
    +     '<h2>Pr√©parer le devis (PDF ‚Äî tout compris)</h2>'
    +     '<p class="dv-note">Chaque ligne regroupe fourniture et pose en un prix global.</p>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Client</h3>'
    +    '<div class="dv-grid">'
    +      '<div class="dv-field"><label>Nom / Soci√©t√©</label><input id="dv-cli-nom" value="'+_esc16(cli.nom)+'" /></div>'
    +      '<div class="dv-field"><label>Email</label><input id="dv-cli-email" value="'+_esc16(cli.email)+'" /></div>'
    +      '<div class="dv-field"><label>T√©l√©phone</label><input id="dv-cli-tel" value="'+_esc16(cli.tel)+'" /></div>'
    +      '<div class="dv-field"><label>Adresse</label><input id="dv-cli-adr" value="'+_esc16(cli.adresse)+'" /></div>'
    +      '<div class="dv-field"><label>Code postal</label><input id="dv-cli-cp" value="'+_esc16(cli.cp)+'" /></div>'
    +      '<div class="dv-field"><label>Ville</label><input id="dv-cli-ville" value="'+_esc16(cli.ville)+'" /></div>'
    +    '</div>'
    +    '<div class="dv-actions">'
    +      (typeof b==='function' ? b('Enregistrer le client','_dvSaveClient16()','btn primary') : '<button onclick="_dvSaveClient16()">Enregistrer le client</button>')
    +      '<span class="dv-note">R√©f√©rence devis : '+_esc16(ref)+' ‚Äî Date : '+_esc16(_todayFR16())+'</span>'
    +    '</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>Conditions g√©n√©rales (CGV)</h3>'
    +    '<textarea id="dv-cgv" rows="10" style="width:100%;">'+_esc16(cgv)+'</textarea>'
    +    '<div class="dv-actions">'
    +      (typeof b==='function' ? b('Enregistrer les CGV','_dvSaveCGV16()','btn') : '<button onclick="_dvSaveCGV16()">Enregistrer les CGV</button>')
    +    '</div>'
    +  '</div>'

    +  '<div class="card">'
    +    '<h3>G√©n√©ration</h3>'
    +    '<p class="dv-note">Ouvre un aper√ßu imprimable. Utilisez ensuite ¬´ Enregistrer en PDF ¬ª du navigateur.</p>'
    +    '<div class="dv-actions">'
    +      (typeof b==='function' ? b('G√©n√©rer le PDF (tout compris)','buildDevisPDF16()','btn primary') : '<button onclick="buildDevisPDF16()">G√©n√©rer le PDF (tout compris)</button>')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );
}

function _dvSaveClient16(){
  const cli = {
    nom: (document.getElementById('dv-cli-nom')||{}).value || '',
    email: (document.getElementById('dv-cli-email')||{}).value || '',
    tel: (document.getElementById('dv-cli-tel')||{}).value || '',
    adresse: (document.getElementById('dv-cli-adr')||{}).value || '',
    cp: (document.getElementById('dv-cli-cp')||{}).value || '',
    ville: (document.getElementById('dv-cli-ville')||{}).value || ''
  };
  _setClient16(cli);
  alert('Client enregistr√©.');
}
function _dvSaveCGV16(){
  const txt = (document.getElementById('dv-cgv')||{}).value || '';
  _setCGV16(txt);
  alert('CGV enregistr√©es.');
}

/* =========================
   ¬ß16A.3 ‚Ä¢ Expose (global)
   ========================= */
Object.assign(window, {
  pageDevisPDF16
});
</script>
  
<!-- =============================
     CHAPITRE 16B : G√âN√âRATION DE DEVIS (Rendu & Int√©gration)
     - Collecte des lignes existantes
     - Rendu HTML imprimable (fourniture+pose combin√©es)
     - Boutons ajout√©s √† Estimatif & Totaux
     ============================= -->
<script>
/* =========================
   ¬ß16B.0 ‚Ä¢ Fallbacks calcul/tri
   ========================= */
function _groupDevis16(){
  if (typeof groupDevis === 'function') return groupDevis();
  const g = {'Devis':{}};
  for (const k in devis){ if(k.indexOf('__')===0) continue; g['Devis'][k] = devis[k]; }
  return g;
}
function _pieceLabel16(key){
  if (typeof pieceDisplayLabel === 'function') return pieceDisplayLabel(key);
  return key;
}
function _sortedItems16(key, items){
  if (typeof sortedItemsForPiece === 'function') return sortedItemsForPiece(key, items);
  return Array.isArray(items) ? items.slice() : [];
}

/* =========================
   ¬ß16B.1 ‚Ä¢ Collecte / formatage
   ========================= */
function _companyBlockHTML16(c){
  const rs = (c.raison_sociale || c.nom_commercial || '').trim();
  const adr = [c.adresse, c.code_postal, c.ville].filter(Boolean).join(' ');
  const lines = [];
  if(rs) lines.push('<strong>'+_esc16(rs)+'</strong>');
  if(adr) lines.push(_esc16(adr));
  if(c.pays) lines.push(_esc16(c.pays));
  if(c.telephone) lines.push('T√©l : '+_esc16(c.telephone));
  if(c.email) lines.push('Email : '+_esc16(c.email));
  if(c.site) lines.push(_esc16(c.site));
  if(c.siren) lines.push('SIREN : '+_esc16(c.siren));
  if(c.tva_intracom) lines.push('TVA : '+_esc16(c.tva_intracom));
  return lines.join('<br>');
}
function _clientBlockHTML16(cli){
  const lines = [];
  if(cli.nom) lines.push('<strong>'+_esc16(cli.nom)+'</strong>');
  if(cli.adresse) lines.push(_esc16(cli.adresse));
  const cpv = [cli.cp, cli.ville].filter(Boolean).join(' ');
  if(cpv) lines.push(_esc16(cpv));
  if(cli.tel) lines.push('T√©l : '+_esc16(cli.tel));
  if(cli.email) lines.push('Email : '+_esc16(cli.email));
  return lines.join('<br>');
}
function _collectLines16(){
  const grouped = _groupDevis16();
  const out = [];
  let totalGlobal = 0;

  for (const grp in grouped){
    for (const key in grouped[grp]){
      const sec = grouped[grp][key]; if(!sec || !sec.items || !sec.items.length) continue;
      const items = _sortedItems16(key, sec.items);
      items.forEach(it=>{
        const q = +it.qty || 0;
        const pu= +it.prixU || 0;
        const t = q*pu;
        totalGlobal += t;

        const left = it.intervention ? (it.intervention+' ‚Äî ') : '';
        const pose = (it.intervention==='Cr√©ation' && it.pose) ? (' ‚Äî '+String(it.pose).toLowerCase()) : '';
        const des  = left + (it.designation||'√âl√©ment') + pose;

        out.push({ piece:key, designation:des, qty:q, pu:pu, total:t });
      });
    }
  }
  return {lines: out, total: totalGlobal};
}

/* =========================
   ¬ß16B.2 ‚Ä¢ Rendu HTML imprimable
   ========================= */
function _buildPrintableHTML16(){
  const prefs   = _getPrefs16();
  const company = _getCompany16();
  const cli     = _getClient16();
  const cgv     = _getCGV16();

  const prefix  = (prefs.numerotation_prefix || 'DEV-');
  const num     = Math.max(1, parseInt(prefs.numerotation_courante||1,10));
  const ref     = prefix + _pad4(num);

  const devName = (window.devis && devis.__name) ? devis.__name : 'Devis';
  const pack    = _collectLines16();

  // Regrouper par pi√®ce
  const byPiece = {};
  pack.lines.forEach(L=>{
    const p = _pieceLabel16(L.piece);
    if(!byPiece[p]) byPiece[p] = [];
    byPiece[p].push(L);
  });

  let sectionsHTML = '';
  Object.keys(byPiece).forEach(pieceLabel=>{
    const rows = byPiece[pieceLabel].map(L=>{
      return '<tr>'
        + '<td>'+_esc16(L.designation)+'</td>'
        + '<td style="text-align:right">'+L.qty+'</td>'
        + '<td style="text-align:right">'+_euro16(L.pu)+'</td>'
        + '<td style="text-align:right">'+_euro16(L.total)+'</td>'
      + '</tr>';
    }).join('');
    const subtotal = byPiece[pieceLabel].reduce((s,x)=>s+x.total,0);
    sectionsHTML +=
      '<h3 style="margin:18px 0 6px 0;">'+_esc16(pieceLabel)+'</h3>'
      + '<table class="dv-table"><thead><tr>'
      +   '<th>D√©signation</th><th style="width:70px;text-align:right">Qt√©</th><th style="width:110px;text-align:right">PU</th><th style="width:130px;text-align:right">Total</th>'
      + '</tr></thead><tbody>'+rows+'</tbody>'
      + '<tfoot><tr><td colspan="3" style="text-align:right"><strong>Sous-total</strong></td>'
      + '<td style="text-align:right"><strong>'+_euro16(subtotal)+'</strong></td></tr></tfoot>'
      + '</table>';
  });

  // TVA (si activ√©e)
  const tvaOn    = !!prefs.tva_applicable;
  const taux     = Math.max(0, +prefs.taux_tva || 20);
  const totalHT  = pack.total;
  const totalTVA = tvaOn ? totalHT * (taux/100) : 0;
  const totalTTC = totalHT + totalTVA;

  const logoHTML = (company.logo_dataurl)
    ? '<img src="'+company.logo_dataurl+'" style="max-height:70px;max-width:240px;border:1px solid #eee;border-radius:6px;padding:4px;background:#fff" alt="Logo"/>'
    : '';

  const html =
'<!doctype html><html lang="fr"><head><meta charset="utf-8"/><title>'+_esc16(devName)+' ‚Äî '+_esc16(ref)+'</title>'
+'<style>'
+'body{ font:14px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif; color:#222; margin:0; background:#fff; }'
+'.sheet{ width:210mm; margin:0 auto; padding:18mm 16mm; }'
+'h1,h2,h3{ margin:0 0 6px 0; }'
+'.row{ display:flex; justify-content:space-between; gap:16px; }'
+'.box{ border:1px solid #ddd; border-radius:8px; padding:10px; background:#fafafa; }'
+'.muted{ color:#666; }'
+'.dv-table{ width:100%; border-collapse:collapse; margin:6px 0 12px; }'
+'.dv-table th, .dv-table td{ border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align:top; }'
+'.totals{ margin-top:8px; width:100%; }'
+'.totals td{ padding:6px 8px; }'
+'@media print{ .no-print{ display:none !important; } .sheet{ box-shadow:none; margin:0; } }'
+'</style></head><body>'
+'<div class="sheet">'
+  '<div class="row">'
+    '<div style="flex:1 1 auto">'
+      '<div>'+logoHTML+'</div>'
+      '<div style="margin-top:8px" class="muted">'+_companyBlockHTML16(company)+'</div>'
+    '</div>'
+    '<div class="box" style="min-width:280px;">'
+      '<h2>Devis</h2>'
+      '<div>R√©f√©rence : <strong>'+_esc16(ref)+'</strong></div>'
+      '<div>Date : '+_esc16(_todayFR16())+'</div>'
+      '<div style="margin-top:6px;">Destinataire :</div>'
+      '<div>'+_clientBlockHTML16(cli)+'</div>'
+    '</div>'
+  '</div>'
+  '<div style="margin-top:14px;">'
+    '<h1 style="font-size:20px;">'+_esc16(devName)+'</h1>'
+    '<div class="muted">Devis en prix global par ligne (fournitures et pose incluses).</div>'
+  '</div>'
+  '<div style="margin-top:10px;">'+(sectionsHTML || '<div class="muted">Aucune ligne √† afficher.</div>')+'</div>'
+  '<table class="totals" style="margin-top:6px;">'
+    '<tr><td style="text-align:right"><strong>Total HT</strong></td><td style="width:150px; text-align:right;"><strong>'+_euro16(totalHT)+'</strong></td></tr>'
+    +(tvaOn ? ('<tr><td style="text-align:right">TVA ('+_esc16(String(taux))+'%)</td><td style="text-align:right">'+_euro16(totalTVA)+'</td></tr>') : '')
+    '<tr><td style="text-align:right"><strong>Total TTC</strong></td><td style="text-align:right"><strong>'+_euro16(totalTTC)+'</strong></td></tr>'
+  '</table>'
+  '<div style="margin-top:16px;">'
+    '<h3>Conditions g√©n√©rales</h3>'
+    '<div class="box" style="white-space:pre-wrap;">'+_esc16(_getCGV16())+'</div>'
+  '</div>'
+  '<div class="no-print" style="margin-top:14px; display:flex; gap:8px;">'
+    '<button onclick="window.print()">Imprimer / Enregistrer en PDF</button>'
+    '<button onclick="window.close()">Fermer</button>'
+  '</div>'
+'</div></body></html>';
  return html;
}

function buildDevisPDF16(){
  try{
    const html = _buildPrintableHTML16();
    const w = window.open('', '_blank');
    if(!w){ alert('Impossible d‚Äôouvrir l‚Äôaper√ßu. Autorisez les popups.'); return; }
    w.document.open('text/html');
    w.document.write(html);
    w.document.close();
    setTimeout(()=>{ try{ w.focus(); w.print(); }catch(e){} }, 300);
  }catch(err){
    alert('Erreur g√©n√©ration PDF : '+(err && err.message ? err.message : String(err)));
  }
}

/* =========================
   ¬ß16B.3 ‚Ä¢ Int√©gration UI (boutons)
   ========================= */
(function injectButtons16(){
  function appendButtons(){
    const app = document.getElementById('app'); if(!app) return;
    if(app.innerHTML.indexOf('buildDevisPDF16()')!==-1) return; // d√©j√† inject√©
    // Ajoute une carte d√©di√©e en bas de page (robuste, sans regex fragiles)
    app.innerHTML +=
      '<div class="card" style="margin-top:12px;">'
      +  '<h3>G√©n√©ration de devis (PDF)</h3>'
      +  '<div class="row" style="gap:8px;flex-wrap:wrap;">'
      +    '<button class="btn" onclick="pageDevisPDF16()">Pr√©parer le devis (PDF)</button>'
      +    '<button class="btn primary" onclick="buildDevisPDF16()">G√©n√©rer le PDF (tout compris)</button>'
      +  '</div>'
      +'</div>';
  }
  const origEst = window.pageEstimatif;
  if (typeof origEst === 'function'){
    window.pageEstimatif = function(){ origEst(); appendButtons(); };
  }
  const origTot = window.pageTotaux;
  if (typeof origTot === 'function'){
    window.pageTotaux = function(){ origTot(); appendButtons(); };
  }
})();

/* =========================
   ¬ß16B.4 ‚Ä¢ Expose (global)
   ========================= */
Object.assign(window, {
  buildDevisPDF16
});
</script>
  


<!-- =============================
     CHAPITRE 16D : Annuaire Clients + int√©gration Devis (v16D.1)
     - Stockage local (clients_v1)
     - Ecrans : liste, nouveau, edition
     - Etape Nouveau devis : choisir client existant OU creer client
     - Injection d'un bouton "Clients" dans le menu principal
     ============================= -->

<style>
  .cli-wrap .card{ margin-bottom:16px; }
  .cli-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
  .cli-field{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:10px; }
  .cli-field label{ display:block; font-weight:600; margin-bottom:6px; }
  .cli-note{ color:var(--muted); font-size:14px; }
  .cli-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .cli-list-item{ display:flex; align-items:center; gap:8px; padding:8px; border:1px solid var(--line); border-radius:10px; background:#fff; }
  .cli-list-item .meta{ font-size:13px; color:var(--muted); }
  .cli-tabs{ display:flex; gap:6px; margin:8px 0; flex-wrap:wrap; }
  .cli-tab{ border:1px solid var(--line); background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer; }
  .cli-tab.active{ background:#f0f6ff; border-color:#90caf9; }
  .muted{ color:var(--muted); }
  .fullrow{ grid-column:1/-1; }
</style>

<script>
/* ============================
   16D.0 - Stockage & helpers
   ============================ */
const KEY_CLIENTS_V1 = 'clients_v1';

function _readLS16d(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function _writeLS16d(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
function _clientsGet(){ return _readLS16d(KEY_CLIENTS_V1, []); }
function _clientsSet(list){ _writeLS16d(KEY_CLIENTS_V1, Array.isArray(list)? list : []); }
function _esc16d(s){ return String(s||'').replace(/[&<>"]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]; }); }
function _shortId16d(){ return Math.random().toString(36).slice(2,8)+'-'+Date.now().toString(36).slice(-4); }
function _nowISO(){ return new Date().toISOString(); }

function _clientUpsert(obj){
  const list=_clientsGet();
  if(!obj.id) obj.id=_shortId16d();
  obj.updated_at=_nowISO();
  if(!obj.created_at) obj.created_at=_nowISO();
  const idx=list.findIndex(function(x){ return x.id===obj.id; });
  if(idx>=0) list[idx]=obj; else list.unshift(obj);
  _clientsSet(list);
  return obj;
}
function _clientDelete(id){
  _clientsSet(_clientsGet().filter(function(x){ return x.id!==id; }));
}
function _clientById(id){
  return _clientsGet().find(function(x){ return x.id===id; }) || null;
}

/* ============================
   16D.1 - Pages Annuaire
   ============================ */
function pageClients(){
  const list = _clientsGet();
  const rows = list.length ? list.map(function(c){
    const line2 = [(c.adresse||'').trim(), [c.cp||'', c.ville||''].filter(Boolean).join(' ')].filter(Boolean).join(' ‚Äî ');
    const meta  = [ (c.email||''),(c.tel||'') ].filter(Boolean).join(' ‚Ä¢ ');
    return (
      '<div class="cli-list-item">'
      +  '<div style="flex:1 1 auto;">'
      +    '<strong>'+_esc16d(c.nom||'')+'</strong>'
      +    (line2?'<div class="meta">'+_esc16d(line2)+'</div>':'')
      +    (meta?'<div class="meta">'+_esc16d(meta)+'</div>':'')
      +  '</div>'
      +  b('Ouvrir','pageClientEdit('+JSON.stringify(c.id)+')','btn')
      +  b('Supprimer','clientDeleteUI('+JSON.stringify(c.id)+')','btn')
      +  (window.devis ? b('Affecter au devis','attachClientToCurrent('+JSON.stringify(c.id)+')','btn') : '')
      +'</div>'
    );
  }).join('') : '<p class="muted">Aucun client enregistre pour le moment.</p>';

  view(
    '<div class="cli-wrap">'
    +  '<div class="card">'
    +    (typeof b==='function' ? b('Retour','pageMain()','btn back') : '')
    +    '<h2>Clients</h2>'
    +    '<div class="cli-actions">'
    +      b('Creer un client','pageClientNew()','btn primary')
    +    '</div>'
    +  '</div>'
    +  '<div class="card"><h3>Annuaire</h3>'+rows+'</div>'
    +'</div>'
  );
}
function clientDeleteUI(id){
  const c=_clientById(id); if(!c) return;
  if(confirm('Supprimer le client ¬´ '+(c.nom||'')+' ¬ª ?')){
    _clientDelete(id); pageClients();
  }
}
function pageClientNew(prefill){
  const c = Object.assign({ id:'', nom:'', email:'', tel:'', adresse:'', cp:'', ville:'', notes:'' }, prefill||{});
  view(_clientFormHTML(c, 'Creer un client', '_clientSaveNew()','pageClients()'));
}
function pageClientEdit(id){
  const c=_clientById(id); if(!c){ alert('Introuvable.'); return pageClients(); }
  view(_clientFormHTML(c, 'Modifier le client', '_clientSaveEdit('+JSON.stringify(id)+')','pageClients()'));
}
function _clientFormHTML(c, title, onSave, onCancel){
  return (
    '<div class="cli-wrap">'
    +  '<div class="card">'
    +    b('Retour', onCancel, 'btn back')
    +    '<h2>'+_esc16d(title)+'</h2>'
    +    '<p class="cli-note">Les champs peuvent rester vides si non pertinents.</p>'
    +  '</div>'
    +  '<div class="card">'
    +    '<div class="cli-grid">'
    +      '<div class="cli-field"><label>Nom / Societe</label><input id="cli-nom" value="'+_esc16d(c.nom)+'"/></div>'
    +      '<div class="cli-field"><label>Email</label><input id="cli-email" value="'+_esc16d(c.email)+'"/></div>'
    +      '<div class="cli-field"><label>Telephone</label><input id="cli-tel" value="'+_esc16d(c.tel)+'"/></div>'
    +      '<div class="cli-field fullrow"><label>Adresse</label><input id="cli-adr" value="'+_esc16d(c.adresse)+'"/></div>'
    +      '<div class="cli-field"><label>Code postal</label><input id="cli-cp" value="'+_esc16d(c.cp)+'"/></div>'
    +      '<div class="cli-field"><label>Ville</label><input id="cli-ville" value="'+_esc16d(c.ville)+'"/></div>'
    +      '<div class="cli-field fullrow"><label>Notes</label><textarea id="cli-notes" rows="4">'+_esc16d(c.notes||'')+'</textarea></div>'
    +    '</div>'
    +    '<div class="cli-actions">'
    +      b('Enregistrer', onSave, 'btn primary')
    +      b('Annuler', onCancel, 'btn')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );
}
function _readClientForm(){
  return {
    id:'',
    nom:(document.getElementById('cli-nom')||{}).value||'',
    email:(document.getElementById('cli-email')||{}).value||'',
    tel:(document.getElementById('cli-tel')||{}).value||'',
    adresse:(document.getElementById('cli-adr')||{}).value||'',
    cp:(document.getElementById('cli-cp')||{}).value||'',
    ville:(document.getElementById('cli-ville')||{}).value||'',
    notes:(document.getElementById('cli-notes')||{}).value||''
  };
}
function _clientSaveNew(){
  const data=_readClientForm();
  _clientUpsert(data);
  alert('Client cree.');
  pageClients();
}
function _clientSaveEdit(id){
  const old=_clientById(id)||{id:id};
  const data=Object.assign({}, old, _readClientForm(), {id:id});
  _clientUpsert(data);
  alert('Client mis a jour.');
  pageClients();
}

/* ============================
   16D.2 - Etape Client pour "Nouveau devis"
   ============================ */
function pageClientNewDevis(){
  var cur = (window.devis && devis.__client) ? devis.__client : { nom:'', email:'', tel:'', adresse:'', cp:'', ville:'', notes:'' };
  var list = _clientsGet();

  function listHTML(){
    if(!list.length) return '<p class="muted">Aucun client enregistre.</p>';
    return list.map(function(c){
      const line2 = [(c.adresse||'').trim(), [c.cp||'', c.ville||''].filter(Boolean).join(' ')].filter(Boolean).join(' ‚Äî ');
      const meta  = [ (c.email||''),(c.tel||'') ].filter(Boolean).join(' ‚Ä¢ ');
      return (
        '<div class="cli-list-item">'
        +  '<div style="flex:1 1 auto;">'
        +    '<strong>'+_esc16d(c.nom||'')+'</strong>'
        +    (line2?'<div class="meta">'+_esc16d(line2)+'</div>':'')
        +    (meta?'<div class="meta">'+_esc16d(meta)+'</div>':'')
        +  '</div>'
        +  b('Selectionner','_selectClientForDevis('+JSON.stringify(c.id)+')','btn primary')
        +  b('Editer','pageClientEdit('+JSON.stringify(c.id)+')','btn')
        +'</div>'
      );
    }).join('');
  }

  view(
    '<div class="cli-wrap">'
    +  '<div class="card">'
    +    b('Annuler','_abortNewDevis16d()','btn back')
    +    '<h2>Client du devis</h2>'
    +    '<p class="cli-note">Choisissez un client existant ou creez-en un nouveau.</p>'
    +    '<div class="cli-tabs">'
    +      '<span class="cli-tab active" id="tab-exist">Client existant</span>'
    +      '<span class="cli-tab" id="tab-new">Nouveau client</span>'
    +    '</div>'
    +  '</div>'
    +  '<div class="card" id="pane-exist"><h3>Clients</h3>'+listHTML()+'</div>'
    +  '<div class="card" id="pane-new" style="display:none;">'
    +    '<h3>Nouveau client</h3>'
    +    '<div class="cli-grid">'
    +      '<div class="cli-field"><label>Nom / Societe</label><input id="ncli-nom" value="'+_esc16d(cur.nom)+'"/></div>'
    +      '<div class="cli-field"><label>Email</label><input id="ncli-email" value="'+_esc16d(cur.email)+'"/></div>'
    +      '<div class="cli-field"><label>Telephone</label><input id="ncli-tel" value="'+_esc16d(cur.tel)+'"/></div>'
    +      '<div class="cli-field fullrow"><label>Adresse</label><input id="ncli-adr" value="'+_esc16d(cur.adresse)+'"/></div>'
    +      '<div class="cli-field"><label>Code postal</label><input id="ncli-cp" value="'+_esc16d(cur.cp)+'"/></div>'
    +      '<div class="cli-field"><label>Ville</label><input id="ncli-ville" value="'+_esc16d(cur.ville)+'"/></div>'
    +      '<div class="cli-field fullrow"><label>Notes</label><textarea id="ncli-notes" rows="3">'+_esc16d(cur.notes||'')+'</textarea></div>'
    +    '</div>'
    +    '<div class="cli-actions">'
    +      b('Enregistrer le client et continuer','_saveNewClientAndAttach()','btn primary')
    +      b('Ignorer','_skipClientNewDevis16d()','btn')
    +    '</div>'
    +  '</div>'
    +'</div>'
  );

  var te=document.getElementById('tab-exist');
  var tn=document.getElementById('tab-new');
  if(te) te.addEventListener('click', function(){
    te.classList.add('active'); tn.classList.remove('active');
    document.getElementById('pane-exist').style.display='';
    document.getElementById('pane-new').style.display='none';
  });
  if(tn) tn.addEventListener('click', function(){
    tn.classList.add('active'); te.classList.remove('active');
    document.getElementById('pane-exist').style.display='none';
    document.getElementById('pane-new').style.display='';
  });
}
function _selectClientForDevis(id){
  const c=_clientById(id); if(!c){ alert('Introuvable.'); return; }
  if(!window.devis) window.devis = {};
  devis.__client = { nom:c.nom||'', email:c.email||'', tel:c.tel||'', adresse:c.adresse||'', cp:c.cp||'', ville:c.ville||'', notes:c.notes||'', __client_id:id };
  if(typeof saveLocal==='function') saveLocal();
  if(typeof pageHome==='function') pageHome(); else alert('Client associe.');
}
function _saveNewClientAndAttach(){
  if(!window.devis) window.devis = {};
  const c = {
    nom:(document.getElementById('ncli-nom')||{}).value||'',
    email:(document.getElementById('ncli-email')||{}).value||'',
    tel:(document.getElementById('ncli-tel')||{}).value||'',
    adresse:(document.getElementById('ncli-adr')||{}).value||'',
    cp:(document.getElementById('ncli-cp')||{}).value||'',
    ville:(document.getElementById('ncli-ville')||{}).value||'',
    notes:(document.getElementById('ncli-notes')||{}).value||''
  };
  const saved=_clientUpsert(c);
  devis.__client = { nom:saved.nom||'', email:saved.email||'', tel:saved.tel||'', adresse:saved.adresse||'', cp:saved.cp||'', ville:saved.ville||'', notes:saved.notes||'', __client_id:saved.id };
  if(typeof saveLocal==='function') saveLocal();
  if(typeof pageHome==='function') pageHome(); else alert('Client enregistre et associe.');
}
function _skipClientNewDevis16d(){
  if(typeof pageHome==='function') pageHome(); else alert('OK.');
}
function _abortNewDevis16d(){
  if(confirm('Annuler ce nouveau devis ?')){
    window.devis = {};
    if(typeof saveLocal==='function') saveLocal();
    if(typeof pageMain==='function') pageMain();
  }
}

/* ============================
   16D.3 - Override Nouveau devis
   ============================ */
(function overrideNewDevis16d(){
  var _oldNew = window.actionNouveauDevis;
  window.actionNouveauDevis = function(){
    if(!confirm('Creer un nouveau devis ? Le devis courant non sauvegarde sera perdu.')) return;
    function _shortId(){ return Math.random().toString(36).slice(2,8)+'-'+Date.now().toString(36).slice(-4); }
    window.devis = { __id:_shortId(), __name:'Nouveau devis', __ts: Date.now(), __client:{ nom:'', email:'', tel:'', adresse:'', cp:'', ville:'', notes:'' } };
    if(typeof saveLocal==='function') saveLocal();
    pageClientNewDevis();
  };
})();

/* ============================
   16D.4 - Injection bouton "Clients" dans le menu principal
   ============================ */
(function injectClientsButtonIntoMain(){
  var _orig = window.pageMain;
  if(typeof _orig !== 'function') return;
  window.pageMain = function(){
    _orig();
    var app=document.getElementById('app'); if(!app) return;
    if(app.innerHTML.indexOf('pageClients()')!==-1) return;
    app.innerHTML = app.innerHTML.replace(
      /(Configuration<\/div>\s*<div class="row"[^>]*>[\s\S]*?<\/div>\s*<\/div>)/,
      '$1'
      + '<div class="card" style="margin-top:12px;">'
      + '  <div class="section-title">Annuaire</div>'
      + '  <div class="row" style="gap:8px;flex-wrap:wrap;">'
      + '    <button class="btn" onclick="pageClients()">Clients</button>'
      + '  </div>'
      + '</div>'
    );
  };
})();

/* ============================
   16D.5 - Expose
   ============================ */
Object.assign(window, {
  pageClients,
  pageClientNew,
  pageClientEdit,
  clientDeleteUI,
  attachClientToCurrent: _selectClientForDevis,
  pageClientNewDevis
});
</script>
<script>
/* ============================================================
   16D bis ‚Äî Page de s√©lection client simplifi√©e
   (remplace toutes les versions pr√©c√©dentes)
   ============================================================ */
(function cleanAndSimplifyClientStep(){

  // --- Suppression douce des anciennes d√©finitions ---
  delete window.pageClientNewDevis;
  delete window._saveClientTVAName16E;
  delete window._skipClientTVAName16E;

  // --- Nouvelle page "choix de client" ---
  window.pageClientNewDevis = function(){
    view(
      '<div class="cli-wrap">'
      +  '<div class="card">'
      +    (typeof b==='function'? b("Annuler","_abortNewDevis16d()","btn back") : '')
      +    '<h2>Client du devis</h2>'
      +    '<p class="cli-note">Souhaitez-vous s√©lectionner un client existant ou cr√©er un nouveau client ?</p>'
      +  '</div>'

      +  '<div class="card" style="display:flex;gap:10px;flex-wrap:wrap;">'
      +    b('Choisir un client existant','_openClientSelector16D()','btn primary')
      +    b('Cr√©er un nouveau client','_openClientCreator16D()','btn')
      +  '</div>'
      +'</div>'
    );
  };

  // --- Ouverture des √©crans existants de 16D ---
  window._openClientSelector16D = function(){
    // ouvre l‚Äôannuaire complet pour choisir un client
    if(typeof pageClients==='function') pageClients();
    else alert('Fonction pageClients() introuvable.');
  };
  window._openClientCreator16D = function(){
    if(typeof pageClientNew==='function') pageClientNew();
    else alert('Fonction pageClientNew() introuvable.');
  };

})();
</script>

  <!-- =============================
     CHAPITRE 16G ‚Äî Correctif PDF (NaN & ligne ¬´ Taux de TVA ¬ª)
     - S√©curise tous les calculs (anti-NaN)
     - Ajoute la ligne ¬´ Taux de TVA : XX % ¬ª entre HT et TTC
     - Remplace proprement _buildPrintableHTML16 si pr√©sent
     ============================= -->
<script>
(function(){
  if (typeof window._buildPrintableHTML16 !== 'function') return;

  // Helpers locaux (sans d√©pendances)
  const rd = (k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? d; }catch(e){ return d; } };
  const prefs = ()=> rd('appPrefs_v1', {});
  const company = ()=> rd('companyConfig_v1', {});
  const cgv = ()=> rd('devis_cgv_v1','');
  const esc = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const today = ()=> { try{ return new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit'}); }catch(e){ return new Date().toLocaleDateString(); } };
  const pad4 = n => String(n).padStart(4,'0');
  const num = v => (Number.isFinite(+v) ? +v : 0);
  const euro = v => {
    const n = num(v);
    try{ return n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨'; }
    catch(e){ return (Math.round(n*100)/100)+' ‚Ç¨'; }
  };

  // Compat : r√©emploie tes utilitaires si dispo
  const group = ()=> (typeof groupDevis==='function'
    ? groupDevis()
    : (function(){ const g={'Devis':{}}; for(const k in devis){ if(k.indexOf('__')===0) continue; g.Devis[k]=devis[k]; } return g; })());
  const pieceLabel = k => (typeof pieceDisplayLabel==='function' ? pieceDisplayLabel(k) : k);
  const sortItems  = (k,items)=> (typeof sortedItemsForPiece==='function' ? sortedItemsForPiece(k,items) : (Array.isArray(items)?items.slice():[]));

  // ====== Nouvelle version robustifi√©e ======
  window._buildPrintableHTML16 = function(){
    const pr   = prefs();
    const comp = company();
    const taux = num(pr.taux_tva || 20);         // taux ¬´ lisible ¬ª
    const tvaOn= !!pr.tva_applicable;            // applicabilit√©
    const prefix = pr.numerotation_prefix || 'DEV-';
    const numCour= Math.max(1, parseInt(pr.numerotation_courante||1,10));
    const ref  = (window.devis && devis.__ref) ? String(devis.__ref) : (prefix+pad4(numCour));
    const devName = (window.devis && devis.__name) ? String(devis.__name) : 'Devis';

    // Collecte s√©curis√©e
    const grouped = group();
    const lines = [];
    let totalGlobal = 0;

    for(const grp in grouped){
      for(const key in grouped[grp]){
        const sec = grouped[grp][key];
        if(!sec || !Array.isArray(sec.items) || !sec.items.length) continue;
        sortItems(key, sec.items).forEach(it=>{
          const q  = num(it.qty);
          const pu = num(it.prixU);
          const t  = num(q * pu);
          totalGlobal += t;

          const left = it.intervention ? (it.intervention+' ‚Äî ') : '';
          const pose = (it.intervention==='Cr√©ation' && it.pose) ? (' ‚Äî '+String(it.pose).toLowerCase()) : '';
          lines.push({
            piece: pieceLabel(key),
            designation: left + (it.designation || '√âl√©ment') + pose,
            qty: q, pu: pu, total: t
          });
        });
      }
    }

    // Groupement par pi√®ce
    const byPiece = {};
    lines.forEach(L => { (byPiece[L.piece]||(byPiece[L.piece]=[])).push(L); });

    let sectionsHTML = '';
    Object.keys(byPiece).forEach(pl=>{
      const rows = byPiece[pl].map(L =>
        '<tr>'
          + '<td>'+esc(L.designation)+'</td>'
          + '<td style="text-align:right">'+num(L.qty)+'</td>'
          + '<td style="text-align:right">'+euro(L.pu)+'</td>'
          + '<td style="text-align:right">'+euro(L.total)+'</td>'
        + '</tr>'
      ).join('');
      const st = byPiece[pl].reduce((s,x)=> num(s) + num(x.total), 0);
      sectionsHTML +=
        '<h3 style="margin:18px 0 6px 0;">'+esc(pl)+'</h3>'
        + '<table class="dv-table"><thead><tr>'
        +   '<th>D√©signation</th><th style="width:70px;text-align:right">Qt√©</th><th style="width:110px;text-align:right">PU</th><th style="width:130px;text-align:right">Total</th>'
        + '</tr></thead><tbody>'+rows+'</tbody>'
        + '<tfoot><tr><td colspan="3" style="text-align:right"><strong>Sous-total</strong></td>'
        + '<td style="text-align:right"><strong>'+euro(st)+'</strong></td></tr></tfoot>'
        + '</table>';
    });

    // Totaux (anti-NaN)
    const totalHT  = num(totalGlobal);
    const totalTVA = tvaOn ? num(totalHT * (taux/100)) : 0;
    const totalTTC = num(totalHT + totalTVA);

    const logoHTML = comp.logo_dataurl
      ? '<img src="'+comp.logo_dataurl+'" style="max-height:70px;max-width:240px;border:1px solid #eee;border-radius:6px;padding:4px;background:#fff" alt="Logo"/>'
      : '';

    // HTML final
    const html =
'<!doctype html><html lang="fr"><head><meta charset="utf-8"/>'
+'<title>'+esc(devName)+' ‚Äî '+esc(ref)+'</title>'
+'<style>'
+'body{font:14px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;color:#222;margin:0;background:#fff}'
+'.sheet{width:210mm;margin:0 auto;padding:18mm 16mm}'
+'h1,h2,h3{margin:0 0 6px 0}.row{display:flex;justify-content:space-between;gap:16px}'
+'.box{border:1px solid #ddd;border-radius:8px;padding:10px;background:#fafafa}.muted{color:#666}'
+'.dv-table{width:100%;border-collapse:collapse;margin:6px 0 12px}'
+'.dv-table th,.dv-table td{border:1px solid #ddd;padding:6px 8px;text-align:left;vertical-align:top}'
+'.totals{margin-top:8px;width:100%}.totals td{padding:6px 8px}'
+'@media print{.no-print{display:none !important}.sheet{box-shadow:none;margin:0}}'
+'</style></head><body>'
+'<div class="sheet">'
+  '<div class="row">'
+    '<div style="flex:1 1 auto"><div>'+logoHTML+'</div></div>'
+    '<div class="box" style="min-width:280px;">'
+      '<h2>Devis</h2>'
+      '<div>R√©f√©rence : <strong>'+esc(ref)+'</strong></div>'
+      '<div>Date : '+esc(today())+'</div>'
+    '</div>'
+  '</div>'
+  '<div style="margin-top:14px;">'
+    '<h1 style="font-size:20px;">'+esc(devName)+'</h1>'
+    '<div class="muted">Devis en prix global par ligne (fournitures et pose incluses).</div>'
+  '</div>'
+  '<div style="margin-top:10px;">'+(sectionsHTML || '<div class="muted">Aucune ligne √† afficher.</div>')+'</div>'
+  '<table class="totals" style="margin-top:6px;">'
+    '<tr><td style="text-align:right"><strong>Total HT</strong></td><td style="width:150px;text-align:right"><strong>'+euro(totalHT)+'</strong></td></tr>'
+    '<tr><td style="text-align:right" class="muted">Taux de TVA</td><td style="text-align:right" class="muted">'+esc(String(taux))+' %</td></tr>'
+    +(tvaOn ? ('<tr><td style="text-align:right">TVA</td><td style="text-align:right">'+euro(totalTVA)+'</td></tr>') : '')
+    '<tr><td style="text-align:right"><strong>Total TTC</strong></td><td style="text-align:right"><strong>'+euro(totalTTC)+'</strong></td></tr>'
+  '</table>'
+  '<div style="margin-top:16px;"><h3>Conditions g√©n√©rales</h3><div class="box" style="white-space:pre-wrap;">'+esc(cgv())+'</div></div>'
+  '<div class="no-print" style="margin-top:14px;display:flex;gap:8px;"><button onclick="window.print()">Imprimer / Enregistrer en PDF</button><button onclick="window.close()">Fermer</button></div>'
+'</div></body></html>';

    return html;
  };
})();
</script>
<!-- =============================
     CHAPITRE 16G‚Äô ‚Äî PDF robuste + saut de page CGV + Taux de TVA + libell√© bouton
     - Remplace proprement _buildPrintableHTML16 (anti-NaN)
     - Ajoute un saut de page AVANT les CGV
     - Ajoute la ligne "Taux de TVA : XX %"
     - Remplace le libell√© "Pr√©parer le devis (PDF)" -> "Aper√ßu du devis (PDF)"
     ============================= -->
<script>
(function(){
  // 1) Relabel du bouton d‚Äôinjection sans toucher ton 16B
  const _est = window.pageEstimatif;
  if (typeof _est === 'function'){
    window.pageEstimatif = function(){
      _est();
      const app=document.getElementById('app'); if(!app) return;
      app.innerHTML = app.innerHTML.replace('Pr√©parer le devis (PDF)','Aper√ßu du devis (PDF)');
    };
  }
  const _tot = window.pageTotaux;
  if (typeof _tot === 'function'){
    window.pageTotaux = function(){
      _tot();
      const app=document.getElementById('app'); if(!app) return;
      app.innerHTML = app.innerHTML.replace('Pr√©parer le devis (PDF)','Aper√ßu du devis (PDF)');
    };
  }

  // 2) Si ton constructeur existe, on le remplace par une version "safe"
  if (typeof window._buildPrintableHTML16 !== 'function') return;

  const num  = v => (Number.isFinite(+v) ? +v : 0);
  const esc  = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;'}[c]));
  const today= ()=>{ try{ return new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit'}); }catch(e){ return new Date().toLocaleDateString(); } };
  const euro = v => { const n=num(v); try{ return n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨'; }catch(e){ return (Math.round(n*100)/100)+' ‚Ç¨'; } };

  const getPrefs   = ()=> (typeof _getPrefs16==='function'? _getPrefs16(): {});
  const getCompany = ()=> (typeof _getCompany16==='function'? _getCompany16(): {});
  const getClient  = ()=> (typeof _getClient16==='function'? _getClient16(): {nom:'',adresse:'',cp:'',ville:'',tel:'',email:''});
  const getCGV     = ()=> (typeof _getCGV16==='function'? _getCGV16(): '');

  const group     = ()=> (typeof groupDevis==='function'
                        ? groupDevis()
                        : (function(){ const g={'Devis':{}}; for(const k in devis){ if(k.indexOf('__')===0) continue; g.Devis[k]=devis[k]; } return g; })());
  const pieceName = k => (typeof pieceDisplayLabel==='function'? pieceDisplayLabel(k): k);
  const sortItems = (k,items)=> (typeof sortedItemsForPiece==='function'? sortedItemsForPiece(k,items): (Array.isArray(items)?items.slice():[]));

  window._buildPrintableHTML16 = function(){
    const prefs = getPrefs();
    const comp  = getCompany();
    const cli   = getClient();
    const cgv   = getCGV();

    const taux  = num(prefs.taux_tva || 20);
    const tvaOn = !!prefs.tva_applicable;

    const prefix = prefs.numerotation_prefix || 'DEV-';
    const nref   = Math.max(1, parseInt(prefs.numerotation_courante||1,10));
    const ref    = (window.devis && devis.__ref) ? String(devis.__ref) : (prefix + String(nref).padStart(4,'0'));
    const title  = (window.devis && devis.__name) ? String(devis.__name) : 'Devis';

    // Collecte
    const grouped = group();
    const lines = [];
    let total = 0;
    for(const grp in grouped){
      for(const key in grouped[grp]){
        const sec = grouped[grp][key];
        if(!sec || !Array.isArray(sec.items) || !sec.items.length) continue;
        sortItems(key, sec.items).forEach(it=>{
          const q  = num(it.qty);
          const pu = num(it.prixU);
          const t  = num(q*pu);
          total += t;

          const left = it.intervention ? (it.intervention+' ‚Äî ') : '';
          const pose = (it.intervention==='Cr√©ation' && it.pose) ? (' ‚Äî '+String(it.pose).toLowerCase()) : '';
          lines.push({ piece: pieceName(key), designation: left + (it.designation||'√âl√©ment') + pose, qty:q, pu:pu, total:t });
        });
      }
    }

    // Groupement par pi√®ce
    const byPiece = {};
    lines.forEach(L => { (byPiece[L.piece]||(byPiece[L.piece]=[])).push(L); });
    let sectionsHTML='';
    Object.keys(byPiece).forEach(p=>{
      const rows = byPiece[p].map(L =>
        '<tr><td>'+esc(L.designation)+'</td>'
           +'<td style="text-align:right">'+num(L.qty)+'</td>'
           +'<td style="text-align:right">'+euro(L.pu)+'</td>'
           +'<td style="text-align:right">'+euro(L.total)+'</td></tr>'
      ).join('');
      const st = byPiece[p].reduce((s,x)=> num(s)+num(x.total),0);
      sectionsHTML +=
        '<h3 style="margin:18px 0 6px 0;">'+esc(p)+'</h3>'
        +'<table class="dv-table"><thead><tr>'
        +'<th>D√©signation</th><th style="width:70px;text-align:right">Qt√©</th><th style="width:110px;text-align:right">PU</th><th style="width:130px;text-align:right">Total</th>'
        +'</tr></thead><tbody>'+rows+'</tbody>'
        +'<tfoot><tr><td colspan="3" style="text-align:right"><strong>Sous-total</strong></td><td style="text-align:right"><strong>'+euro(st)+'</strong></td></tr></tfoot>'
        +'</table>';
    });

    // Totaux
    const totalHT  = num(total);
    const totalTVA = tvaOn ? num(totalHT * (taux/100)) : 0;
    const totalTTC = num(totalHT + totalTVA);

    const logoHTML = comp.logo_dataurl
      ? '<img src="'+comp.logo_dataurl+'" style="max-height:70px;max-width:240px;border:1px solid #eee;border-radius:6px;padding:4px;background:#fff" alt="Logo"/>'
      : '';

    // Blocs adresse
    function companyBlock(c){
      const rs  = (c.raison_sociale || c.nom_commercial || '').trim();
      const adr = [c.adresse, c.cp||c.code_postal, c.ville].filter(Boolean).join(' ');
      const L=[]; if(rs) L.push('<strong>'+esc(rs)+'</strong>');
      if(adr) L.push(esc(adr));
      if(c.telephone) L.push('T√©l : '+esc(c.telephone));
      if(c.email)     L.push('Email : '+esc(c.email));
      if(c.siren)     L.push('SIREN : '+esc(c.siren));
      if(c.tva_intracom) L.push('TVA : '+esc(c.tva_intracom));
      return L.join('<br>');
    }
    function clientBlock(c){
      const L=[]; if(c.nom) L.push('<strong>'+esc(c.nom)+'</strong>');
      if(c.adresse) L.push(esc(c.adresse));
      const cpv=[c.cp,c.ville].filter(Boolean).join(' ');
      if(cpv) L.push(esc(cpv));
      if(c.tel) L.push('T√©l : '+esc(c.tel));
      if(c.email) L.push('Email : '+esc(c.email));
      return L.join('<br>');
    }

    // HTML
    const style = ''
      +'body{font:14px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;color:#222;margin:0;background:#fff}'
      +'.sheet{width:210mm;margin:0 auto;padding:18mm 16mm}'
      +'h1,h2,h3{margin:0 0 6px 0}.row{display:flex;justify-content:space-between;gap:16px}'
      +'.box{border:1px solid #ddd;border-radius:8px;padding:10px;background:#fafafa}.muted{color:#666}'
      +'.dv-table{width:100%;border-collapse:collapse;margin:6px 0 12px}'
      +'.dv-table th,.dv-table td{border:1px solid #ddd;padding:6px 8px;text-align:left;vertical-align:top}'
      +'.totals{margin-top:8px;width:100%}.totals td{padding:6px 8px}'
      +'.page-break{page-break-before:always}'
      +'@media print{.no-print{display:none !important}.sheet{box-shadow:none;margin:0}}';

    const html =
'<!doctype html><html lang="fr"><head><meta charset="utf-8"/><title>'+esc(title)+' ‚Äî '+esc(ref)+'</title><style>'+style+'</style></head><body>'
+'<div class="sheet">'
+  '<div class="row">'
+    '<div style="flex:1 1 auto"><div>'+logoHTML+'</div><div style="margin-top:8px" class="muted">'+companyBlock(comp)+'</div></div>'
+    '<div class="box" style="min-width:280px;"><h2>Devis</h2><div>R√©f√©rence : <strong>'+esc(ref)+'</strong></div><div>Date : '+esc(today())+'</div><div style="margin-top:6px;">Destinataire :</div><div>'+clientBlock(cli)+'</div></div>'
+  '</div>'
+  '<div style="margin-top:14px;"><h1 style="font-size:20px;">'+esc(title)+'</h1><div class="muted">Devis en prix global par ligne (fournitures et pose incluses).</div></div>'
+  '<div style="margin-top:10px;">'+(sectionsHTML || '<div class="muted">Aucune ligne √† afficher.</div>')+'</div>'
+  '<table class="totals" style="margin-top:6px;">'
+    '<tr><td style="text-align:right"><strong>Total HT</strong></td><td style="width:150px;text-align:right"><strong>'+euro(totalHT)+'</strong></td></tr>'
+    '<tr><td style="text-align:right" class="muted">Taux de TVA</td><td style="text-align:right" class="muted">'+esc(String(taux))+' %</td></tr>'
+    +(tvaOn ? ('<tr><td style="text-align:right">TVA</td><td style="text-align:right">'+euro(totalTVA)+'</td></tr>') : '')
+    '<tr><td style="text-align:right"><strong>Total TTC</strong></td><td style="text-align:right"><strong>'+euro(totalTTC)+'</strong></td></tr>'
+  '</table>'
+'</div>'
+'<div class="sheet page-break">'
+  '<h3>Conditions g√©n√©rales</h3>'
+  '<div class="box" style="white-space:pre-wrap">'+esc(cgv)+'</div>'
+  '<div class="no-print" style="margin-top:14px;display:flex;gap:8px;"><button onclick="window.print()">Imprimer / Enregistrer en PDF</button><button onclick="window.close()">Fermer</button></div>'
+'</div>'
+'</body></html>';

    return html;
  };
})();
</script>

  <script>
/* ============================================================
   Patch "√† la source" ‚Äî garder UNIQUEMENT le bouton noir :
   üß≠ duplicateDevisWithNewTarifsV10()
   ============================================================ */
(function keepOnlyBlackDuplicate(){
  /* 1) Neutraliser les anciennes actions (source logique) */
  window.repriceCurrentDevisV10                = function(){ /* d√©sactiv√© */ };
  window.duplicateDevisWithCurrentTarifs       = function(){ /* d√©sactiv√© */ };
  window.duplicateDevisWithCurrentTarifs_REPRICE = function(){ /* d√©sactiv√© */ };

  /* 2) Surcouche propre des pages pour emp√™cher toute r√©injection
        et ne laisser que le bouton noir de ¬ß15.4 */
  function stripUnwantedButtons(){
    var app = document.getElementById('app'); if(!app) return;

    // Supprime les 3 CTA que l‚Äôon retire ‚Äú√† la source d‚ÄôUI‚Äù
    var killers = [
      'repriceCurrentDevisV10()',
      'duplicateDevisWithCurrentTarifs_REPRICE()',
      'duplicateDevisWithCurrentTarifs()'
    ];
    app.querySelectorAll('button').forEach(function(btn){
      var oc = (btn.getAttribute('onclick')||'').trim();
      if (killers.some(function(s){ return oc.indexOf(s) !== -1; })){
        btn.remove();
      }
    });

    // Enl√®ve les .row devenues vides (propre visuel)
    app.querySelectorAll('.row').forEach(function(row){
      if(!row.querySelector('button')) row.remove();
    });
  }

  function wrapOnce(name){
    var orig = window[name];
    if (typeof orig !== 'function') return;
    // √âvite sur-emballage
    if (orig.__onlyBlackWrapped) return;

    function wrapped(){
      orig.apply(this, arguments);
      // √Ä ce niveau, d‚Äôanciens injecteurs (15.0/15.2) auraient pu tenter d‚Äôajouter leurs boutons;
      // on supprime leur UI et on conserve uniquement le bouton noir (15.4).
      stripUnwantedButtons();
    }
    wrapped.__onlyBlackWrapped = true;
    window[name] = wrapped;
  }

  wrapOnce('pageEstimatif');
  wrapOnce('pageTotaux');

  // 3) Nettoyage imm√©diat si la page est d√©j√† rendue
  setTimeout(stripUnwantedButtons, 0);
})();
</script>


  <script>
/* ============================================================
   16H‚Äî √âtape "Nom du devis + TVA" (valeurs par d√©faut = Pr√©f√©rences)
   - S'affiche apr√®s choix/cr√©ation du client (Chap. 16D)
   - Enregistre toujours devis.__tva (m√™me si l'utilisateur "ignore")
   - Laisse _buildPrintableHTML16 tel quel : il lira via _getPrefs16()
   ============================================================ */

/* ---------- Shim : _getPrefs16 merge la TVA du devis si pr√©sente ---------- */
(function perDevisTVAShim(){
  const safeRead = (k, d) => { try { return JSON.parse(localStorage.getItem(k) || 'null') ?? d; } catch(e){ return d; } };
  const baseGetter = (typeof window._getPrefs16 === 'function')
    ? window._getPrefs16
    : function(){ return safeRead('appPrefs_v1', { devise:'‚Ç¨', tva_applicable:false, taux_tva:20 }); };

  window._getPrefs16 = function(){
    const base = baseGetter() || {};
    try{
      if (window.devis && devis.__tva){
        const out = Object.assign({}, base);
        if (typeof devis.__tva.applicable === 'boolean') out.tva_applicable = devis.__tva.applicable;
        if (typeof devis.__tva.taux === 'number')        out.taux_tva      = devis.__tva.taux;
        return out;
      }
    }catch(e){}
    return base;
  };
})();

/* ---------- √âtape TVA + Nom du devis ---------- */
(function makeTVANameStep16F(){
  const esc = s => String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]);

  window.pageTVAName16F = function(){
    const prefs = (typeof _getPrefs16 === 'function') ? _getPrefs16() : {};
    const cur   = (window.devis && devis.__tva) ? devis.__tva : {};

    // Valeurs par d√©faut : les Pr√©f√©rences
    const applicable = (typeof cur.applicable === 'boolean') ? cur.applicable : !!prefs.tva_applicable;
    const taux       = (typeof cur.taux === 'number') ? cur.taux : (+prefs.taux_tva || 20);
    const dvName     = (window.devis && devis.__name) ? devis.__name : 'Nouveau devis';

    view(
      '<div class="dvname-wrap">'
      +  '<div class="card">'
      +    (typeof b==='function' ? b('Retour','pageClients ? pageClients() : pageMain()','btn back') : '')
      +    '<h2>Nom du devis & TVA</h2>'
      +    '<p class="muted">Par d√©faut, on reprend la TVA des Pr√©f√©rences. Vous pouvez l‚Äôactiver/d√©sactiver et modifier le taux.</p>'
      +  '</div>'

      +  '<div class="card">'
      +    '<div class="dvname-field"><label>Nom du devis</label>'
      +      '<input id="dv16f-name" value="'+esc(dvName)+'"/></div>'
      +    '<div class="dvname-field" style="margin-top:8px;"><label>'
      +      '<input type="checkbox" id="dv16f-tva-on" '+(applicable?'checked':'')+'> Appliquer la TVA sur ce devis'
      +    '</label></div>'
      +    '<div class="dvname-field"><label>Taux de TVA (%)</label>'
      +      '<input id="dv16f-tva-rate" type="number" step="0.1" min="0" value="'+esc(taux)+'"/></div>'
      +    '<div class="dv-actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">'
      +      (typeof b==='function' ? b('Enregistrer et continuer','_dv16fSave()','btn primary')
                                  : '<button class="btn primary" onclick="_dv16fSave()">Enregistrer et continuer</button>')
      +      (typeof b==='function' ? b('Ignorer (garder valeurs par d√©faut)','_dv16fSkip()','btn')
                                  : '<button class="btn" onclick="_dv16fSkip()">Ignorer</button>')
      +    '</div>'
      +  '</div>'
      +'</div>'
    );
  };

  // Enregistrer TVA + nom et poursuivre
  window._dv16fSave = function(){
    if (!window.devis) window.devis = {};
    const on   = !!(document.getElementById('dv16f-tva-on')||{}).checked;
    const taux = parseFloat((document.getElementById('dv16f-tva-rate')||{}).value) || 0;
    const name = (document.getElementById('dv16f-name')||{}).value || 'Devis';

    devis.__tva  = { applicable:on, taux:taux };
    devis.__name = name;

    if (typeof saveLocal === 'function') saveLocal();
    if (typeof pageHome  === 'function') pageHome();
  };

  // Ignorer : on ENREGISTRE quand m√™me les valeurs par d√©faut des Pr√©f√©rences
  window._dv16fSkip = function(){
    if (!window.devis) window.devis = {};
    const prefs = (typeof _getPrefs16 === 'function') ? _getPrefs16() : { tva_applicable:false, taux_tva:20 };
    if (!devis.__tva){
      devis.__tva = { applicable: !!prefs.tva_applicable, taux: +prefs.taux_tva || 20 };
    }
    if (!devis.__name){
      devis.__name = 'Devis';
    }
    if (typeof saveLocal === 'function') saveLocal();
    if (typeof pageHome  === 'function') pageHome();
  };
})();

/* ---------- Int√©gration : apr√®s s√©lection/cr√©ation client, on va sur la page TVA+Nom ---------- */
(function hookClientFlowToTVAName(){
  // 16D fournit ces fonctions : on les wrappe sans casser le reste
  const _sel = window._selectClientForDevis;
  window._selectClientForDevis = function(id){
    if (typeof _sel === 'function') _sel(id); // attache le client + saveLocal + pageHome
    // On rouvre l'√©tape TVA + Nom (prend la main juste apr√®s)
    if (typeof pageTVAName16F === 'function') pageTVAName16F();
  };

  const _saveNew = window._saveNewClientAndAttach;
  window._saveNewClientAndAttach = function(){
    if (typeof _saveNew === 'function') _saveNew(); // cr√©e client + attache + saveLocal + pageHome
    if (typeof pageTVAName16F === 'function') pageTVAName16F();
  };

  // Si tu pr√©f√®res √©viter l'aller/retour visuel, on peut patcher 16D pour ne PAS appeler pageHome()
  // dans _selectClientForDevis/_saveNewClientAndAttach et appeler seulement pageTVAName16F().
  // Dis-moi si tu veux cette variante "sans flash".
})();
</script>
