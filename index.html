<!-- =====================================================
     CHAPITRE 1 : SOCLE UI & HELPERS
     Sommaire :
       1.0 ‚Ä¢ Styles de base + conteneur
       1.1 ‚Ä¢ Boutons & rendu (b, view)
       1.2 ‚Ä¢ Aides ‚Ç¨ / arrondi / formats
       1.3 ‚Ä¢ √âtat courant du devis (ensure)
       1.4 ‚Ä¢ Persistance locale (load/save)
       1.5 ‚Ä¢ Outils g√©n√©riques (download, uid)
     ===================================================== -->

<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280; --bg:#f7f7fb;
  }
  html,body{ margin:0; padding:0; background:var(--bg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; color:#111; }
  .app-wrap{ max-width:980px; margin:24px auto; padding:0 14px; }
  .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; }
  h1,h2,h3{ margin:0 0 8px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{ appearance:none; border:1px solid #1112; background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn:hover{ background:#fafafa; }
  .btn.primary{ background:#111; color:#fff; border-color:#111; }
  .btn.back{ background:#f3f4f6; }
  .pill{ display:inline-flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--line); border-radius:999px; padding:6px 10px; }
  .muted{ color:var(--muted); font-size:14px; }
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th,.table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<div id="app" class="app-wrap">
  <div class="card"><h2>Chargement‚Ä¶</h2></div>
</div>

<script>
/* =========================
   1.1 ‚Ä¢ Boutons & rendu
   ========================= */
window.b = window.b || function(txt, fn, cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>'; };
window.view = window.view || function(html){ var el=document.getElementById('app'); if(el) el.innerHTML=html; };

/* =========================
   1.2 ‚Ä¢ ‚Ç¨ / arrondi / format
   ========================= */
window.euro = window.euro || function(n){ var v=+(n||0); return v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2})+' ‚Ç¨'; };
window.roundUp5 = window.roundUp5 || function(n){ n=+n||0; return Math.ceil(n/5)*5; };
window.formatDateFR = function(d){ try{ return (d?new Date(d):new Date()).toLocaleDateString('fr-FR'); }catch(e){ return new Date().toLocaleDateString(); } };

/* =========================
   1.3 ‚Ä¢ √âtat devis courant
   ========================= */
window.devis = window.devis || { __id:'', __name:'Nouveau devis', __created_at:'', __tva_applicable:undefined, __taux_tva:undefined };
function ensureDevis(){
  if(!devis.__id) devis.__id = 'dv_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7);
  if(!devis.__created_at) devis.__created_at = new Date().toISOString();
  if(typeof devis.__name!=='string') devis.__name='Devis';
}

/* =========================
   1.4 ‚Ä¢ Persistance locale
   ========================= */
const KEY_DEVIS_CURRENT = 'devis_current_v1';
function saveLocal(){ try{ ensureDevis(); localStorage.setItem(KEY_DEVIS_CURRENT, JSON.stringify(devis)); }catch(e){} }
function loadLocal(){
  try{
    var raw = localStorage.getItem(KEY_DEVIS_CURRENT);
    if(raw){ window.devis = JSON.parse(raw)||window.devis; }
    ensureDevis();
  }catch(e){ ensureDevis(); }
}

/* =========================
   1.5 ‚Ä¢ Utilitaires divers
   ========================= */
function makeUID(pfx){ return (pfx||'id')+'_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6); }
function downloadBlob(name, blob){
  try{
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }catch(e){ alert('T√©l√©chargement impossible : '+e.message); }
}

// expose minimal
Object.assign(window,{ saveLocal, loadLocal, ensureDevis, downloadBlob, makeUID });
</script>



















<!-- =====================================================
     CHAPITRE 2 : LISTE DES DEVIS & PERSISTANCE
     Sommaire :
       2.0 ‚Ä¢ Stockage (liste) & helpers
       2.1 ‚Ä¢ Nouveau devis (actionNouveauDevis)
       2.2 ‚Ä¢ Page ‚ÄúMes devis‚Äù (ouvrir, dupliquer, renommer, supprimer)
       2.3 ‚Ä¢ Import / Export (JSON)
     ===================================================== -->
<script>
/* =========================
   2.0 ‚Ä¢ Stockage & helpers
   ========================= */
const KEY_DEVIS_LIST = 'saved_devis_list_v1';

function readSavedList(){ try{ return JSON.parse(localStorage.getItem(KEY_DEVIS_LIST)||'null')||[]; }catch(e){ return []; } }
function writeSavedList(arr){ try{ localStorage.setItem(KEY_DEVIS_LIST, JSON.stringify(arr||[])); }catch(e){} }

/* =========================
   2.1 ‚Ä¢ Nouveau devis
   ========================= */
function actionNouveauDevis(){
  window.devis = { __id:'', __name:'Nouveau devis', __created_at:'', __tva_applicable:undefined, __taux_tva:undefined };
  ensureDevis(); saveLocal(); pageMain();
}

/* =========================
   2.2 ‚Ä¢ Page Mes devis
   ========================= */
function pageSavedDevis(){
  const list = readSavedList();
  const rows = list.length ? list.map(d=>{
    const when = formatDateFR(d.__created_at);
    return `<tr>
      <td>${d.__name||'Devis'}</td>
      <td>${when}</td>
      <td>
        ${b('Ouvrir','loadDevis("'+d.__id+'")','btn')}
        ${b('Renommer','renameDevis("'+d.__id+'")','btn')}
        ${b('Dupliquer','duplicateDevis("'+d.__id+'")','btn')}
        ${b('Supprimer','deleteDevis("'+d.__id+'")','btn')}
      </td>
    </tr>`;
  }).join('') : '<tr><td colspan="3" class="muted">Aucun devis enregistr√©.</td></tr>';

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Mes devis</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + b('üíæ Enregistrer l‚Äôactuel dans la liste','saveCurrentDevis()','btn primary')
        + b('‚¨áÔ∏è Exporter la liste (.json)','exportSavedDevis()','btn')
        + b('‚¨ÜÔ∏è Importer une liste (.json)','importSavedDevisUI()','btn')
      + '</div>'
    + '</div>'
    + '<div class="card">'
      + '<table class="table-mini"><thead><tr><th>Nom</th><th>Cr√©√© le</th><th>Actions</th></tr></thead><tbody>'+rows+'</tbody></table>'
    + '</div>'
  );
}

function saveCurrentDevis(){
  ensureDevis();
  const list=readSavedList();
  // si d√©j√† pr√©sent ‚Üí remplace
  const i=list.findIndex(x=>x.__id===devis.__id);
  if(i>=0) list[i]=JSON.parse(JSON.stringify(devis));
  else list.unshift(JSON.parse(JSON.stringify(devis)));
  writeSavedList(list);
  alert('‚úÖ Devis enregistr√© dans la liste.');
}

function loadDevis(id){
  const d = readSavedList().find(x=>x.__id===id);
  if(!d){ alert('Introuvable.'); return; }
  window.devis = JSON.parse(JSON.stringify(d));
  saveLocal();
  alert('‚úÖ Devis charg√©.'); pageMain();
}
function deleteDevis(id){
  if(!confirm('Supprimer ce devis ?')) return;
  writeSavedList(readSavedList().filter(x=>x.__id!==id));
  pageSavedDevis();
}
function duplicateDevis(id){
  const d = readSavedList().find(x=>x.__id===id); if(!d) return;
  const copy = JSON.parse(JSON.stringify(d));
  copy.__id = makeUID('dv');
  copy.__name = (d.__name||'Devis')+' (copie)';
  copy.__created_at = new Date().toISOString();
  const list=readSavedList(); list.unshift(copy); writeSavedList(list);
  pageSavedDevis();
}
function renameDevis(id){
  const list=readSavedList(); const d=list.find(x=>x.__id===id); if(!d) return;
  const nn=prompt('Nouveau nom :', d.__name||''); if(nn==null) return;
  d.__name=(nn||'').trim()||d.__name; writeSavedList(list); pageSavedDevis();
}

/* =========================
   2.3 ‚Ä¢ Import / Export
   ========================= */
function exportSavedDevis(){
  const blob=new Blob([JSON.stringify(readSavedList(),null,2)],{type:'application/json;charset=utf-8'});
  downloadBlob('mes_devis.json', blob);
}
function importSavedDevisUI(){
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange=function(){
    const f=input.files&&input.files[0]; if(!f) return;
    const rd=new FileReader(); rd.onload=function(){
      try{
        const arr=JSON.parse(rd.result||'[]'); if(!Array.isArray(arr)) throw new Error('Format inattendu');
        // merge (par __id)
        const cur=readSavedList(); const map=new Map(cur.map(x=>[x.__id,x]));
        arr.forEach(x=>{ if(x&&x.__id) map.set(x.__id,x); });
        writeSavedList(Array.from(map.values()).sort((a,b)=>(b.__created_at||'').localeCompare(a.__created_at||'')));
        alert('‚úÖ Liste import√©e.');
        pageSavedDevis();
      }catch(e){ alert('‚ùå Import impossible : '+e.message); }
    }; rd.readAsText(f,'utf-8');
  };
  input.click();
}

Object.assign(window,{
  pageSavedDevis, actionNouveauDevis, saveCurrentDevis,
  loadDevis, deleteDevis, duplicateDevis, renameDevis,
  exportSavedDevis, importSavedDevisUI
});
</script>




















<!-- =====================================================
     CHAPITRE 3 : NAVIGATION & ACCUEIL
     Sommaire :
       3.0 ‚Ä¢ Page principale (pageMain)
       3.1 ‚Ä¢ Raccourcis vers modules (Pi√®ces, Tableaux, Ventilation‚Ä¶)
       3.2 ‚Ä¢ Aide/√©tat en pied de page
     ===================================================== -->
<script>
function pageMain(){
  ensureDevis();
  view(
    '<div class="card">'
      + '<div class="row" style="justify-content:space-between;">'
        + '<h2>'+ (devis.__name||'Devis') +'</h2>'
        + '<div class="row">'
          + b('üìÅ Mes devis','pageSavedDevis()','btn')
          + b('üìù Renommer','renameCurrentDevis()','btn')
          + b('üÜï Nouveau devis','actionNouveauDevis()','btn')
        + '</div>'
      + '</div>'
      + '<p class="muted">ID : '+devis.__id+' ‚Äî Cr√©√© le '+formatDateFR(devis.__created_at)+'</p>'
    + '</div>'

    + '<div class="card" style="margin-top:12px;">'
      + '<h2>Outils</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + b('üì¶ Saisie par pi√®ces','pageHome()','btn primary')  // (Chap.5)
        + b('üß∞ Tableaux','pageTabHome ? pageTabHome() : pageTabCreate()','btn') // (Chap.6)
        + b('üå¨Ô∏è Ventilation','pageVentAccueil ? pageVentAccueil() : alert(\'Module ventilation (chap.7) non charg√©\')','btn')
        + b('üßÆ Estimatif & exports','pageEstimatif ? pageEstimatif() : alert(\'Chap.11 requis\')','btn')
      + '</div>'
    + '</div>'

    + '<div class="card" style="margin-top:12px;">'
      + '<h2>Param√©trage</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + b('‚öôÔ∏è Tarifs / Catalogue','pageTarifsAccueil ? pageTarifsAccueil() : (pageCatalogueTarifsAccueil ? pageCatalogueTarifsAccueil() : alert(\'Chapitres 8/13 requis\'))','btn')
        + b('üè¢ Configuration entreprise','pageConfigEntreprise ? pageConfigEntreprise() : alert(\'Chap.12 requis\')','btn')
        + b('üß≠ Pr√©f√©rences','pagePreferences ? pagePreferences() : alert(\'Chap.12 requis\')','btn')
        + b('üí∂ Facturation','pageFactures ? pageFactures() : alert(\'Chap.10 requis\')','btn')
      + '</div>'
    + '</div>'
  );
}
function renameCurrentDevis(){
  const nn = prompt('Nom du devis :', devis.__name||''); if(nn==null) return;
  devis.__name = (nn||'').trim() || devis.__name; saveLocal(); pageMain();
}
Object.assign(window,{ pageMain, renameCurrentDevis });
</script>



















<!-- =====================================================
     CHAPITRE 4 : SAUVEGARDE ROBUSTE
     Sommaire :
       4.0 ‚Ä¢ Snapshots auto (historique court)
       4.1 ‚Ä¢ Reprise si document vide
       4.2 ‚Ä¢ Outils (purge / restore)
     ===================================================== -->
<script>
const KEY_AUTOSNAPS = 'devis_autosnaps_v1';
const AUTOSNAP_EVERY_MS = 30*1000; // 30s
let _autosnap_timer = null;

function _readSnaps(){ try{ return JSON.parse(localStorage.getItem(KEY_AUTOSNAPS)||'null')||[]; }catch(e){ return []; } }
function _writeSnaps(arr){ try{ localStorage.setItem(KEY_AUTOSNAPS, JSON.stringify(arr||[])); }catch(e){} }

function autosnapOnce(){
  try{
    ensureDevis();
    const list = _readSnaps();
    const snap = { when: Date.now(), data: JSON.parse(JSON.stringify(devis)) };
    list.unshift(snap);
    // garder les 20 derniers
    _writeSnaps(list.slice(0,20));
  }catch(e){}
}
function startAutosnapLoop(){
  if(_autosnap_timer) clearInterval(_autosnap_timer);
  _autosnap_timer = setInterval(autosnapOnce, AUTOSNAP_EVERY_MS);
}

// Reprise si devis ‚Äúvide‚Äù
function isDevisEmpty(dv){
  if(!dv) return true;
  for(const k in dv){ if(k.startsWith('__')) continue; const s=dv[k]; if(s && Array.isArray(s.items) && s.items.length) return false; }
  return true;
}
function recoverSavedIfEmpty(){
  try{
    if(!isDevisEmpty(devis)) return; // rien √† faire
    const last = _readSnaps()[0];
    if(last && last.data){ window.devis = last.data; saveLocal(); }
  }catch(e){}
}

Object.assign(window,{ autosnapOnce, startAutosnapLoop, recoverSavedIfEmpty });
</script>


















<!-- =====================================================
     CHAPITRE 5 : SAISIE PAR PI√àCES
     Sommaire :
       5.0 ‚Ä¢ Mod√®le de section (pi√®ce) & helpers
       5.1 ‚Ä¢ Accueil + ajout de pi√®ce
       5.2 ‚Ä¢ S√©lection d‚Äôune cat√©gorie (rapide)
       5.3 ‚Ä¢ Ajout d‚Äô√©l√©ments ‚Äúone-shot‚Äù (PU simple)
       5.4 ‚Ä¢ Notes de pi√®ce / suppression
     ===================================================== -->
<script>
/* =========================
   5.0 ‚Ä¢ Mod√®le de pi√®ce
   ========================= */
function ensurePiece(key, base){
  devis[key] = devis[key] || { __base: (base||key), items:[], note:'' };
}
function pieceKeys(){ return Object.keys(devis).filter(k=>!k.startsWith('__')); }

/* =========================
   5.1 ‚Ä¢ Accueil & ajout
   ========================= */
function pageHome(){
  const keys = pieceKeys();
  const list = keys.length ? keys.map(k=>{
    const s=devis[k]||{}; const nb=(s.items||[]).length;
    return `<div class="pill"><strong>${k}</strong><span class="muted">${nb} ligne(s)</span>
      ${b('Ouvrir','goPiece("'+k.replace(/"/g,'&quot;')+'")','btn')}
      ${b('Supprimer','removePiece("'+k.replace(/"/g,'&quot;')+'")','btn')}
    </div>`;
  }).join(' ') : '<p class="muted">Aucune pi√®ce pour l‚Äôinstant.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Pi√®ces</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + '<input id="new-piece" placeholder="Nouvelle pi√®ce (ex: Salon, Cuisine‚Ä¶)" />'
        + b('Ajouter','pageAddPiece()','btn primary')
      + '</div>'
    + '</div>'
    + '<div class="card"><h3>Liste</h3>'+list+'</div>'
  );
}
function pageAddPiece(){
  const el=document.getElementById('new-piece'); const name=(el&&el.value||'').trim(); if(!name) return;
  ensurePiece(name, name); saveLocal(); goPiece(name);
}

/* =========================
   5.2 ‚Ä¢ √âcran d‚Äôune pi√®ce
   ========================= */
const QUICK_CATS = [
  { id:'Prises', items:['Prise 2P+T'] },
  { id:'√âclairage/Luminaires', items:['Point de centre','Applique'] },
  { id:'√âclairage/Commandes', items:['Interrupteur simple','Interrupteur double'] },
  { id:'Circuit sp√©cialis√©', items:['Four','Plaque de cuisson'] }
];

function goPiece(key){
  ensurePiece(key);
  const s=devis[key], items=(s.items||[]);
  const rows = items.length ? items.map((it,idx)=>{
    const q=+it.qty||0, pu=+it.prixU||0, t=q*pu;
    return `<li>${it.intervention?it.intervention+' ‚Äî ':''}${it.designation} (${q} ${it.unit||'u'} √ó ${euro(pu)} = ${euro(t)})
      ${b('√ó','delLine("'+key+'",'+idx+')','btn')}</li>`;
  }).join('') : '<li class="muted">Aucune ligne.</li>';

  const catBtns = QUICK_CATS.map(c=>b(c.id,'goCategory("'+key+'","'+c.id+'")','btn')).join(' ');

  view(
    '<div class="card">'
      + b('Retour','pageHome()','btn back')
      + '<h2>'+key+'</h2>'
      + '<div class="row" style="margin-top:8px;">'+catBtns+'</div>'
      + '<div class="row" style="margin-top:8px;">'
        + b('‚ûï Ajout ‚Äúone-shot‚Äù','pageOneShotSelection("'+key+'")','btn')
        + b('üìù Note','editPieceNote("'+key+'")','btn')
      + '</div>'
    + '</div>'
    + '<div class="card"><h3>Lignes</h3><ul>'+rows+'</ul></div>'
  );
}
function delLine(key, idx){
  const s=devis[key]; if(!s||!s.items) return; s.items.splice(idx,1); saveLocal(); goPiece(key);
}

/* =========================
   5.3 ‚Ä¢ Ajouts rapides
   ========================= */
function goCategory(key, cat){
  const cfg = QUICK_CATS.find(x=>x.id===cat);
  if(!cfg) return alert('Cat√©gorie inconnue');
  const opts = cfg.items.map(n=>'<option>'+n+'</option>').join('');
  view(
    '<div class="card">'
      + b('Retour','goPiece("'+key+'")','btn back')
      + '<h2>'+key+' ‚Äî '+cat+'</h2>'
      + '<label>√âl√©ment</label><select id="qsel">'+opts+'</select>'
      + '<div class="row" style="margin-top:8px;">'
        + '<input id="q-qty" type="number" min="1" value="1" style="max-width:120px;" />'
        + '<input id="q-pu" type="number" min="0" step="1" placeholder="PU (tout compris)" style="max-width:200px;" />'
        + b('Ajouter','saveSpecifique("'+key+'","'+cat+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}

// compat: utilis√© par d‚Äôanciens boutons
function pageSpecifiqueForm(key, cat){ goCategory(key, cat); }

function saveSpecifique(key, cat){
  const sel=document.getElementById('qsel'); const des=(sel&&sel.value)||cat;
  const q = Math.max(1, parseInt(document.getElementById('q-qty')?.value||'1',10));
  const pu = Math.max(0, parseFloat(document.getElementById('q-pu')?.value||'0'));
  ensurePiece(key);
  devis[key].items.push({ category:cat, intervention:'Cr√©ation', designation:des, qty:q, prixU:pu });
  saveLocal(); goPiece(key);
}

/* =========================
   5.4 ‚Ä¢ Notes & suppression
   ========================= */
function editPieceNote(key){
  ensurePiece(key);
  const cur = devis[key].note || '';
  const nn = prompt('Note pour '+key+' :', cur);
  if(nn==null) return;
  devis[key].note = nn; saveLocal(); goPiece(key);
}
function removePiece(key){
  if(!confirm('Supprimer la pi√®ce ¬´ '+key+' ¬ª ?')) return;
  delete devis[key]; saveLocal(); pageHome();
}

Object.assign(window,{
  pageHome, pageAddPiece, goPiece, delLine,
  goCategory, pageSpecifiqueForm, saveSpecifique,
  pageOneShotSelection: goCategory, // alias
  editPieceNote, removePiece
});
</script>






















<!-- =====================================================
     CHAPITRE 6 : TABLEAUX (MULTI)
     Sommaire :
       6.0 ‚Ä¢ Mod√®le, cl√©s & helpers
       6.1 ‚Ä¢ Accueil Tableaux (liste)
       6.2 ‚Ä¢ Cr√©ation & nom personnalis√©
       6.3 ‚Ä¢ √âl√©ments clefs (ID, coupure, disjoncteurs)
       6.4 ‚Ä¢ Ajout d‚Äô√©l√©ments & validation
     ===================================================== -->
<script>
/* =========================
   6.0 ‚Ä¢ Mod√®le & helpers
   ========================= */
function _tabListKeys(){
  return Object.keys(devis).filter(k=>{
    if(k.startsWith('__')) return false;
    const s=devis[k]||{}; return ((s.__base||'').toLowerCase()==='tableau');
  });
}
function _ensureTab(key){
  if(!devis[key]) devis[key]={ __base:'Tableau', __customName:'', items:[], note:'' };
}

/* =========================
   6.1 ‚Ä¢ Accueil Tableaux
   ========================= */
function pageTabHome(){
  const keys = _tabListKeys();
  const list = keys.length ? keys.map(k=>{
    const s=devis[k]||{}; const lab = k + (s.__customName?(' ‚Äî '+s.__customName):'');
    return `<div class="pill"><strong>${lab}</strong>
      ${b('Ouvrir','pageTabPose("'+k+'")','btn')}
      ${b('Supprimer','tabDelete("'+k+'")','btn')}
    </div>`;
  }).join(' ') : '<p class="muted">Aucun tableau.</p>';

  view(
    '<div class="card">'
      + b('Retour','pageMain()','btn back')
      + '<h2>Tableaux</h2>'
      + '<div class="row" style="margin-top:8px;">'+ b('‚ûï Cr√©er un tableau','pageTabCreate()','btn primary') +'</div>'
    + '</div>'
    + '<div class="card"><h3>Liste</h3>'+list+'</div>'
  );
}

/* =========================
   6.2 ‚Ä¢ Cr√©ation & nom
   ========================= */
function pageTabCreate(){
  const key = 'Tableau '+(_tabListKeys().length+1);
  _ensureTab(key); saveLocal();
  view(
    '<div class="card">'
      + b('Retour','pageTabHome()','btn back')
      + '<h2>Nouveau tableau</h2>'
      + '<p><strong>Identifiant : '+key+'</strong></p>'
      + '<label>Nom personnalis√© (optionnel)</label>'
      + '<input id="tab-name" placeholder="ex : Logement A / Atelier / TGBT‚Ä¶" />'
      + '<div class="row" style="margin-top:10px;">'
        + b('Valider','saveTabCustomName("'+key+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}
function saveTabCustomName(key){
  const nm = (document.getElementById('tab-name')?.value||'').trim();
  if(devis[key]) devis[key].__customName = nm;
  saveLocal(); pageTabPose(key);
}
function tabDelete(key){
  if(!confirm('Supprimer ¬´ '+key+' ¬ª ?')) return;
  delete devis[key]; saveLocal(); pageTabHome();
}

/* =========================
   6.3 ‚Ä¢ √âl√©ments clefs
   ========================= */
function pageTabPose(key){
  _ensureTab(key);
  const s=devis[key];
  const name = key + (s.__customName?(' ‚Äî '+s.__customName):'');
  const rows = (s.items||[]).map((it,idx)=>{
    const t = (it.qty||0)*(it.prixU||0);
    return `<li>${it.designation} (${it.qty||0} √ó ${euro(it.prixU||0)} = ${euro(t)}) ${b('√ó','tabDelLine("'+key+'",'+idx+')','btn')}</li>`;
  }).join('') || '<li class="muted">Aucune ligne.</li>';

  view(
    '<div class="card">'
      + b('Retour','pageTabHome()','btn back')
      + '<h2>'+name+'</h2>'
      + '<div class="row" style="margin-top:8px;">'
        + b('Ajouter ‚Äî ID 30mA','pageTab_ID("'+key+'")','btn')
        + b('Ajouter ‚Äî Coupure g√©n√©rale','pageTab_Coupure("'+key+'")','btn')
        + b('Ajouter ‚Äî Disjoncteurs','pageTab_Disjoncteurs("'+key+'")','btn')
      + '</div>'
      + '<p class="muted">Version l√©g√®re ‚Äî compatible avec tes chapitres d√©taill√©s.</p>'
    + '</div>'
    + '<div class="card"><h3>Lignes</h3><ul>'+rows+'</ul></div>'
  );
}
function tabDelLine(key, idx){ const s=devis[key]; if(!s||!s.items) return; s.items.splice(idx,1); saveLocal(); pageTabPose(key); }

/* === 6.3.a ‚Ä¢ ID 30mA === */
function pageTab_ID(key){
  view(
    '<div class="card">'
      + b('Retour','pageTabPose("'+key+'")','btn back')
      + '<h2>Interrupteur diff√©rentiel 30 mA</h2>'
      + '<div class="row">'
        + '<input id="id-cal" type="number" min="25" step="5" value="40" style="max-width:120px;" />'
        + '<select id="id-type"><option>AC</option><option>A</option><option>F</option></select>'
        + '<input id="id-prix" type="number" step="1" placeholder="PU (tout compris)" style="max-width:180px;" />'
        + b('Ajouter','pageTab_ID_submit("'+key+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}
function pageTab_ID_submit(key){
  const cal = parseInt(document.getElementById('id-cal')?.value||'40',10);
  const type = document.getElementById('id-type')?.value||'AC';
  const pu = Math.max(0, parseFloat(document.getElementById('id-prix')?.value||'0'));
  _ensureTab(key);
  devis[key].items.push({ category:'Tableau', designation:`ID 30mA ${type} ${cal}A`, qty:1, prixU:pu });
  saveLocal(); pageTabPose(key);
}

/* === 6.3.b ‚Ä¢ Coupure g√©n√©rale === */
function pageTab_Coupure(key){
  view(
    '<div class="card">'
      + b('Retour','pageTabPose("'+key+'")','btn back')
      + '<h2>Coupure g√©n√©rale</h2>'
      + '<div class="row">'
        + '<select id="cg-type"><option>Inter-sectionneur</option><option>Disjoncteur de coupure</option></select>'
        + '<input id="cg-cal" type="number" min="40" step="10" value="63" style="max-width:120px;" />'
        + '<input id="cg-prix" type="number" step="1" placeholder="PU (tout compris)" style="max-width:180px;" />'
        + b('Ajouter','submitTab_Coupure("'+key+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}
function submitTab_Coupure(key){
  const t=document.getElementById('cg-type')?.value||'Inter-sectionneur';
  const cal=parseInt(document.getElementById('cg-cal')?.value||'63',10);
  const pu=Math.max(0, parseFloat(document.getElementById('cg-prix')?.value||'0'));
  _ensureTab(key);
  devis[key].items.push({ category:'Tableau', designation:`Coupure g√©n√©rale ‚Äî ${t} ${cal}A`, qty:1, prixU:pu });
  saveLocal(); pageTabPose(key);
}

/* === 6.3.c ‚Ä¢ Disjoncteurs === */
function pageTab_Disjoncteurs(key){
  view(
    '<div class="card">'
      + b('Retour','pageTabPose("'+key+'")','btn back')
      + '<h2>Disjoncteurs modulaires</h2>'
      + '<div class="row">'
        + '<input id="dj-nb" type="number" min="1" value="1" style="max-width:120px;" />'
        + '<select id="dj-cal"><option>10A</option><option>16A</option><option>20A</option><option>32A</option></select>'
        + '<input id="dj-prix" type="number" step="1" placeholder="PU (tout compris / pi√®ce)" style="max-width:220px;" />'
        + b('Ajouter','pageTab_DisjValider("'+key+'")','btn primary')
      + '</div>'
    + '</div>'
  );
}
function pageTab_DisjValider(key){
  const nb = Math.max(1, parseInt(document.getElementById('dj-nb')?.value||'1',10));
  const cal = document.getElementById('dj-cal')?.value||'16A';
  const pu = Math.max(0, parseFloat(document.getElementById('dj-prix')?.value||'0'));
  _ensureTab(key);
  devis[key].items.push({ category:'Tableau', designation:`Disjoncteur ${cal}`, qty:nb, prixU:pu });
  saveLocal(); pageTabPose(key);
}

/* =========================
   6.4 ‚Ä¢ Expose compat
   ========================= */
Object.assign(window,{
  pageTabHome, pageTabCreate, saveTabCustomName, tabDelete,
  pageTabPose,
  pageTab_ID, pageTab_ID_submit: pageTab_ID_submit, submitTab_ID: pageTab_ID_submit,
  pageTab_Coupure, submitTab_Coupure,
  pageTab_Disjoncteurs, pageTab_DisjValider
});
</script>
















<!-- =====================================================
     CHAPITRE 7 : VENTILATION ‚Äî VMC / Extracteur / Ventilo conduit
     Sommaire :
       7.0 ‚Ä¢ √âtat local & helpers
       7.1 ‚Ä¢ Accueil ventilation
       7.2 ‚Ä¢ Cr√©ation (kit / extracteur / ventilateur)
       7.3 ‚Ä¢ Retirage de conduits
       7.4 ‚Ä¢ Entretien
       7.5 ‚Ä¢ Expose
     ===================================================== -->
<script>
/* ======== 7.0 ‚Ä¢ √âtat local & helpers ======== */
var ventState = {};
function ensureVentKey(key){
  if(!devis[key]) devis[key] = { __base:"VMC", __customName:"", items:[], note:"" };
  if(!ventState[key]) ventState[key] = {
    creation:{ kit:{ref:"",d80:1,d125:1,conduits:[{type:"Gaine isol√©e"}],perc:[{support:"Placo",qty:0}]},
               extracteur:{ref:"",diam:"100",conduits:[{type:"Gaine isol√©e"}],perc:[{support:"Placo",qty:0}]},
               ventilo:{ref:"",diam:"100",long:0,perc:[{support:"Placo",qty:0}]}},
    retirage:{n80:0,n125:0},
    entretien:{type:"Groupe VMC",nb:0}
  };
}
function pickVal(id,def){const e=document.getElementById(id);return e?e.value:def;}
function pickNum(id,def){const e=document.getElementById(id);const v=parseFloat(e?e.value:NaN);return isNaN(v)?(def||0):v;}

/* ======== 7.1 ‚Ä¢ Accueil ventilation ======== */
function pageVentAccueil(){
  var keys=Object.keys(devis).filter(k=>(devis[k]?.__base||"").toLowerCase()==="vmc");
  var list=keys.length?keys.map(k=>{
    var s=devis[k];return `<div class="pill"><strong>${k}</strong> <small>${(s.items||[]).length} ligne(s)</small>
      ${b("Ouvrir","pageVentHome('"+k+"')","btn")}
      ${b("Supprimer","ventDelete('"+k+"')","btn")}</div>`;
  }).join(""):"<p class='muted'>Aucune ventilation.</p>";
  view(`<div class="card">${b("Retour","pageMain()","btn back")}<h2>Ventilation</h2>
    <div class="row">${b("‚ûï Ajouter une ventilation","pageVentNew()","btn primary")}</div></div>
    <div class="card" style="margin-top:12px;"><h2>Liste</h2>${list}</div>`);
}
function pageVentNew(){
  var key="Ventilation "+((_tabListKeys?.().length||0)+1);
  ensureVentKey(key);saveLocal();
  view(`<div class="card">${b("Retour","pageVentAccueil()","btn back")}<h2>Nouvelle ventilation</h2>
    <p><strong>${key}</strong></p><input id="vent-name" placeholder="Nom personnalis√©"/><div class="row" style="margin-top:10px;">
    ${b("Valider","saveVentName('"+key+"')","btn primary")}</div></div>`);
}
function saveVentName(key){var n=(document.getElementById("vent-name")?.value||"").trim();devis[key].__customName=n;saveLocal();pageVentHome(key);}
function ventDelete(key){if(!confirm("Supprimer "+key+" ?"))return;delete devis[key];saveLocal();pageVentAccueil();}

/* ======== 7.2 ‚Ä¢ Cr√©ation (kit / extracteur / ventilo) ======== */
function pageVentHome(key){
  ensureVentKey(key);
  view(`<div class="card">${b("Retour","pageVentAccueil()","btn back")}<h2>${key}</h2>
    <div class="row" style="margin-top:8px;">${b("Cr√©ation","pageVentCreation('"+key+"')","btn primary")}
      ${b("Retirage","pageVentRetirage('"+key+"')","btn")}
      ${b("Entretien","pageVentEntretien('"+key+"')","btn")}</div></div>`);
}
function pageVentCreation(key){
  ensureVentKey(key);var st=ventState[key].creation;
  view(`<div class="card">${b("Retour","pageVentHome('"+key+"')","btn back")}<h2>Cr√©ation VMC</h2>
    <label>Kit ref.</label><input id="kit-ref" value="${st.kit.ref}"/>
    <div class="row"><input id="kit-d80" type="number" value="${st.kit.d80}"/><input id="kit-d125" type="number" value="${st.kit.d125}"/></div>
    <div class="row" style="margin-top:8px;">${b("Ajouter Kit","ventAddKit('"+key+"')","btn primary")}</div>
    <hr/>
    <label>Extracteur ref.</label><input id="ex-ref" value="${st.extracteur.ref}"/>
    <div class="row"><input id="ex-diam" value="${st.extracteur.diam}"/></div>
    <div class="row" style="margin-top:8px;">${b("Ajouter Extracteur","ventAddExtracteur('"+key+"')","btn primary")}</div>
    <hr/>
    <label>Ventilo ref.</label><input id="vc-ref" value="${st.ventilo.ref}"/>
    <div class="row"><input id="vc-diam" value="${st.ventilo.diam}"/><input id="vc-long" type="number" value="${st.ventilo.long}"/></div>
    <div class="row" style="margin-top:8px;">${b("Ajouter Ventilo","ventAddVentilateur('"+key+"')","btn primary")}</div></div>`);
}
function ventAddKit(key){devis[key].items.push({category:"Ventilation",designation:"Kit VMC",qty:1,prixU:0});saveLocal();pageVentHome(key);}
function ventAddExtracteur(key){devis[key].items.push({category:"Ventilation",designation:"Extracteur",qty:1,prixU:0});saveLocal();pageVentHome(key);}
function ventAddVentilateur(key){devis[key].items.push({category:"Ventilation",designation:"Ventilateur conduit",qty:1,prixU:0});saveLocal();pageVentHome(key);}

/* ======== 7.3 ‚Ä¢ Retirage ======== */
function pageVentRetirage(key){
  ensureVentKey(key);var st=ventState[key].retirage;
  view(`<div class="card">${b("Retour","pageVentHome('"+key+"')","btn back")}<h2>Retirage</h2>
    <div class="row"><input id="rt80" type="number" value="${st.n80}"/><input id="rt125" type="number" value="${st.n125}"/></div>
    <div class="row" style="margin-top:8px;">${b("Ajouter","ventAddRetirage('"+key+"')","btn primary")}</div></div>`);
}
function ventAddRetirage(key){
  var n80=pickNum("rt80",0),n125=pickNum("rt125",0);
  devis[key].items.push({category:"Ventilation",designation:`Retirage √ò80=${n80}/√ò125=${n125}`,qty:1,prixU:0});saveLocal();pageVentHome(key);
}

/* ======== 7.4 ‚Ä¢ Entretien ======== */
function pageVentEntretien(key){
  ensureVentKey(key);var st=ventState[key].entretien;
  view(`<div class="card">${b("Retour","pageVentHome('"+key+"')","btn back")}<h2>Entretien</h2>
    <select id="ent-type"><option>Groupe VMC</option><option>Extracteur</option><option>Ventilateur conduit</option></select>
    <input id="ent-nb" type="number" value="${st.nb}" style="margin-top:8px;"/>
    <div class="row" style="margin-top:8px;">${b("Ajouter","ventAddEntretien('"+key+"')","btn primary")}</div></div>`);
}
function ventAddEntretien(key){
  var t=pickVal("ent-type","Groupe VMC"),nb=pickNum("ent-nb",0);
  devis[key].items.push({category:"Ventilation",designation:`Entretien ${t} nb=${nb}`,qty:1,prixU:0});saveLocal();pageVentHome(key);
}

/* ======== 7.5 ‚Ä¢ Expose ======== */
Object.assign(window,{
  pageVentAccueil,pageVentNew,saveVentName,ventDelete,pageVentHome,pageVentCreation,
  ventAddKit,ventAddExtracteur,ventAddVentilateur,
  pageVentRetirage,ventAddRetirage,pageVentEntretien,ventAddEntretien
});
</script>


















<!-- =======================================================================
     CHAPITRE 8 : CATALOGUES & TARIFS ‚Äî V3
     =======================================================================
     SOMMAIRE
       8.0 ‚Ä¢ Styles + Helpers communs
       8.1 ‚Ä¢ Accueil ‚ÄúCatalogue & Tarifs‚Äù (pont d‚Äôentr√©e)
       8.2 ‚Ä¢ Catalogue PRESTATIONS (families/types/prix)
            8.2.1 Familles & libell√©s d‚Äôinterventions
            8.2.2 √âditeur par famille (liste, ajout, prix)
            8.2.3 Import / Export / Reset
       8.3 ‚Ä¢ TARIFS & COEFFICIENTS (pose, sections, overrides runtime)
            8.3.1 Tarifs unitaires par famille (injection dans TARIFS_BASE)
            8.3.2 Coefficients (pose / sections)
            8.3.3 Sauvegarde overrides + application runtime
       8.4 ‚Ä¢ Catalogue MAT√âRIEL (marques, gammes, multiplicateurs)
            8.4.1 Structure & stockage
            8.4.2 √âditeur (marque/gamme par famille)
            8.4.3 Import / Export / Reset
       8.5 ‚Ä¢ Application runtime (DESIGNATIONS_PAR_CATEGORIE / TARIFS_BASE)
       8.6 ‚Ä¢ Expose (window) + int√©gration menu (hook discret)
     ======================================================================= -->

<style>
  /* 8.0 ‚Ä¢ Styles communs */
  .cfg8-wrap .card{ margin-bottom:24px; }
  .row.gap8{ gap:8px; flex-wrap:wrap; display:flex; }
  .grid-auto{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
  .field{ border:1px solid var(--line, #e5e5e5); background:#fff; border-radius:10px; padding:10px; }
  .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .note{ color:var(--muted,#666); font-size:14px; }
  .pill.small{ padding:6px 10px; font-size:14px; border:1px solid var(--line,#e5e5e5); border-radius:999px; background:#fafafa; }
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th, .table-mini td{ border:1px solid var(--line,#e5e5e5); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
  .muted{ color:var(--muted,#666); }
  .space-top{ margin-top:12px; }
  .sep{ border-top:1px solid var(--line,#e5e5e5); padding-top:10px; margin-top:10px; }
  .footer-nav{ margin-top:16px; display:flex; justify-content:flex-end; }
</style>

<script>
/* =======================================================================
   8.0 ‚Ä¢ Helpers communs
   ======================================================================= */
(function(){
  // Garde-fous (si l‚Äôapp h√¥te n‚Äôa pas ces utilitaires)
  if(typeof window.b!=='function'){
    window.b=function(txt,fn,cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>'; };
  }
  if(typeof window.view!=='function'){
    window.view=function(html){ var app=document.getElementById('app'); if(app) app.innerHTML=html; };
  }

  // Cl√©s localStorage (versionn√©es)
  const KEY_CAT_PREST = 'cat_prestations_v1';
  const KEY_CAT_MAT   = 'catalogue_materiel_v1';
  const KEY_TAR_OV    = 'tarifsOverrides_v1';

  // I/O JSON LS
  function readJsonLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
  function writeJsonLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

  // Utilitaires
  const _clone = x => JSON.parse(JSON.stringify(x));
  const _num = n => Math.max(0, +n||0);
  const _esc = s => String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]);

  // Boutons navigation "Retour / Accueil"
  function topBackButton(){
    return b('Retour','history.length>1?history.back():pageHome&&pageHome()','btn back');
  }
  function bottomHome(){
    const act = (typeof window.confirmBackHome==='function') ? 'confirmBackHome()' : 'pageHome&&pageHome()';
    return '<div class="footer-nav">'+b('üè† Accueil',act,'btn')+'</div>';
  }

  /* =====================================================================
     8.1 ‚Ä¢ Accueil ‚ÄúCatalogue & Tarifs‚Äù
     ===================================================================== */
  function pageCatalogueTarifsAccueil(){
    view(
      '<div class="cfg8-wrap">'
      + '<div class="card">'
        + topBackButton()
        + '<h2>Catalogue & Tarifs</h2>'
        + '<p class="note">G√®re tes prestations (libell√©s + prix), tes coefficients et ton catalogue mat√©riel (marques/gammes).</p>'
        + '<div class="row gap8 space-top">'
          + b('üìö Catalogue prestations','pageCataloguePrestations()','btn primary')
          + b('üí∂ Tarifs & coefficients','pageTarifsCoeffs()','btn')
          + b('üè∑Ô∏è Catalogue mat√©riel','pageCatalogueMateriel()','btn')
        + '</div>'
      + '</div>'
      + bottomHome()
      + '</div>'
    );
  }

  /* =====================================================================
     8.2 ‚Ä¢ CATALOGUE PRESTATIONS
     ===================================================================== */

  // 8.2.1 ‚Ä¢ Familles + types d‚Äôinterventions
  const PREST_FAMILIES = [
    { id:'prises', label:'Prises', keys:[
      'Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'
    ]},
    { id:'ecl_lum', label:'√âclairage ‚Äî Luminaires', keys:[
      'Cr√©ation','Remplacement luminaire','Rec√¢blage avec remplacement luminaire','Rec√¢blage sans remplacement luminaire'
    ]},
    { id:'ecl_cmd', label:'√âclairage ‚Äî Commandes', keys:[
      'Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'
    ]},
    { id:'cs', label:'Circuit sp√©cialis√©', keys:[
      'Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'
    ]},
    { id:'tableau', label:'Tableau & distribution', keys:[
      'Cr√©ation','Remplacement appareillage','Rec√¢blage avec remplacement appareillage','Rec√¢blage sans remplacement appareillage'
    ]},
    { id:'vent', label:'Ventilation', keys:[
      'Cr√©ation','Remplacement appareillage','Entretien'
    ]},
    { id:'terre', label:'Mise √† la terre', keys:[
      'Cr√©ation','Am√©lioration/ajout','Contr√¥le'
    ]}
  ];

  // Mod√®le par d√©faut (simple, modifiable ensuite)
  function _catPrestDefault(){
    return {
      prises:  [ { nom:'Prise 2P+T', prix:{'Cr√©ation':90,'Remplacement appareillage':25,'Rec√¢blage avec remplacement appareillage':45,'Rec√¢blage sans remplacement appareillage':30} } ],
      ecl_lum: [ { nom:'Point de centre', prix:{'Cr√©ation':110,'Remplacement luminaire':35,'Rec√¢blage avec remplacement luminaire':55,'Rec√¢blage sans remplacement luminaire':40} } ],
      ecl_cmd: [ { nom:'Interrupteur simple', prix:{'Cr√©ation':65,'Remplacement appareillage':25,'Rec√¢blage avec remplacement appareillage':40,'Rec√¢blage sans remplacement appareillage':28} } ],
      cs:      [ { nom:'Four', prix:{'Cr√©ation':140,'Remplacement appareillage':35,'Rec√¢blage avec remplacement appareillage':55,'Rec√¢blage sans remplacement appareillage':40} } ],
      tableau: [ { nom:'Remplacement coffret standard', prix:{'Cr√©ation':100} } ],
      vent:    [ { nom:'Kit VMC simple flux', prix:{'Cr√©ation':280,'Remplacement appareillage':60,'Entretien':45} } ],
      terre:   [ { nom:'Prise de terre (piquet)', prix:{'Cr√©ation':180,'Am√©lioration/ajout':90,'Contr√¥le':30} } ]
    };
  }
  function getCatPrest(){ return readJsonLS(KEY_CAT_PREST, _catPrestDefault()); }
  function setCatPrest(obj){ writeJsonLS(KEY_CAT_PREST, obj||_catPrestDefault()); }

  // 8.2.2 ‚Ä¢ √âditeur par famille
  function pageCataloguePrestations(){
    const cat = getCatPrest();
    const cards = PREST_FAMILIES.map(f=>{
      const arr = cat[f.id]||[];
      const table = arr.length ? `
        <table class="table-mini">
          <thead>
            <tr><th>Type</th>${f.keys.map(k=>`<th>${_esc(k)}</th>`).join('')}<th></th></tr>
          </thead>
          <tbody>
            ${arr.map((t,idx)=>`
              <tr>
                <td>${_esc(t.nom)}</td>
                ${f.keys.map(k=>{
                  const id = `pr_${f.id}_${idx}_${k.replace(/\s+/g,'_')}`;
                  const val = +(t.prix?.[k]||0);
                  return `<td><input id="${id}" type="number" inputmode="decimal" step="1" min="0" value="${val}"></td>`;
                }).join('')}
                <td>${b('üíæ','catPrestSave("'+f.id+'",'+idx+')','btn')} ${b('üóëÔ∏è','catPrestDel("'+f.id+'",'+idx+')','btn')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<p class="muted">Aucun type pour le moment.</p>';

      return `
        <div class="card">
          <h3>${_esc(f.label)}</h3>
          ${table}
          <div class="row gap8 space-top">
            <input id="add_${f.id}" placeholder="Ajouter un type (ex : Prise 2P+T IP55)" />
            ${b('Ajouter','catPrestAdd("'+f.id+'")','btn')}
          </div>
        </div>
      `;
    }).join('');

    view(
      '<div class="cfg8-wrap">'
      + '<div class="card">'
        + topBackButton()
        + '<h2>Catalogue prestations</h2>'
        + '<p class="note">Ajoute/modifie tes types de prestations. Les prix saisis nourrissent les menus et les exports.</p>'
        + '<div class="row gap8 space-top">'
          + b('‚¨áÔ∏è Export JSON','catPrestExport()','btn')
          + b('‚¨ÜÔ∏è Import JSON','catPrestImport()','btn')
          + b('üßπ R√©initialiser','catPrestReset()','btn')
        + '</div>'
      + '</div>'
      + cards
      + bottomHome()
      + '</div>'
    );

    // Handlers
    window.catPrestAdd=function(fid){
      const el=document.getElementById('add_'+fid); const name=(el&&el.value||'').trim(); if(!name) return;
      const cur=getCatPrest(); cur[fid]=cur[fid]||[]; cur[fid].push({ nom:name, prix:{} });
      setCatPrest(cur); applyPrestationsToRuntime(); pageCataloguePrestations();
    };
    window.catPrestDel=function(fid,idx){
      const cur=getCatPrest(); (cur[fid]||[]).splice(idx,1);
      setCatPrest(cur); applyPrestationsToRuntime(); pageCataloguePrestations();
    };
    window.catPrestSave=function(fid,idx){
      const fam=PREST_FAMILIES.find(x=>x.id===fid); if(!fam) return;
      const cur=getCatPrest(); const row=cur[fid]?.[idx]; if(!row) return;
      const out={};
      fam.keys.forEach(k=>{
        const id=`pr_${fid}_${idx}_${k.replace(/\s+/g,'_')}`;
        out[k]=_num(document.getElementById(id)?.value);
      });
      row.prix=out; setCatPrest(cur); applyPrestationsToRuntime();
      alert('‚úÖ Enregistr√©.');
    };
  }

  // 8.2.3 ‚Ä¢ IO Prestations
  function catPrestExport(){
    const raw=JSON.stringify(getCatPrest(),null,2);
    const blob=new Blob([raw],{type:'application/json;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='catalogue_prestations.json'; a.click();
    URL.revokeObjectURL(url);
  }
  function catPrestImport(){
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=function(){
      const f=input.files&&input.files[0]; if(!f) return;
      const rd=new FileReader();
      rd.onload=function(){
        try{
          const obj=JSON.parse(rd.result||'{}');
          if(!obj || typeof obj!=='object') throw new Error('JSON inattendu');
          setCatPrest(obj); applyPrestationsToRuntime(); alert('‚úÖ Catalogue prestations import√©.'); pageCataloguePrestations();
        }catch(e){ alert('‚ùå Import impossible : '+e.message); }
      };
      rd.readAsText(f,'utf-8');
    };
    input.click();
  }
  function catPrestReset(){
    if(!confirm('R√©initialiser le catalogue prestations ?')) return;
    localStorage.removeItem(KEY_CAT_PREST);
    applyPrestationsToRuntime();
    pageCataloguePrestations();
  }

  /* =====================================================================
     8.3 ‚Ä¢ TARIFS & COEFFICIENTS
     ===================================================================== */

  // Garantir les globaux runtime
  function ensureTarifsGlobals(){
    window.TARIFS_BASE = window.TARIFS_BASE || { prises:{}, eclairage:{}, circuit_specialise:{}, circuit_specialise_base:{} };
    window.COEFF_POSE  = window.COEFF_POSE  || { 'Placo':1,'Encastr√© ma√ßonnerie':1.2,'Semi-encastr√©':1.1,'Sur-mesure':1.5,'Saillie avec moulure':0.9,'Sous tube IRL':1 };
    window.COEFF_SECTIONS_CS = window.COEFF_SECTIONS_CS || { '0,75 mm¬≤':0.8,'1,5 mm¬≤':1,'2,5 mm¬≤':1.2,'6 mm¬≤':1.4 };
    window.DESIGNATIONS_PAR_CATEGORIE = window.DESIGNATIONS_PAR_CATEGORIE || {};
  }

  // Overrides (fusion douce)
  function getOverrides(){ return readJsonLS(KEY_TAR_OV, {}); }
  function setOverrides(p){
    const cur=getOverrides();
    function deepMerge(base, add){
      if(!add || typeof add!=='object') return;
      Object.keys(add).forEach(k=>{
        const v=add[k];
        if(v && typeof v==='object' && !Array.isArray(v)){
          if(!base[k] || typeof base[k]!=='object') base[k]={};
          deepMerge(base[k], v);
        }else{
          base[k]=v;
        }
      });
    }
    deepMerge(cur, p||{});
    writeJsonLS(KEY_TAR_OV, cur);
    // Appliquer live si objets globaux existent
    if(typeof window.TARIFS_BASE==='object' && p?.TARIFS_BASE) deepMerge(window.TARIFS_BASE, p.TARIFS_BASE);
    if(typeof window.COEFF_POSE==='object' && p?.COEFF_POSE) deepMerge(window.COEFF_POSE, p.COEFF_POSE);
    if(typeof window.COEFF_SECTIONS_CS==='object' && p?.COEFF_SECTIONS_CS) deepMerge(window.COEFF_SECTIONS_CS, p.COEFF_SECTIONS_CS);
  }

  // Page 8.3
  function pageTarifsCoeffs(){
    ensureTarifsGlobals();
    const cat=getCatPrest();

    // Section A : Tarifs par famille (injection dans TARIFS_BASE)
    const familyCards = PREST_FAMILIES.map(f=>{
      const arr=(cat[f.id]||[]);
      if(!arr.length) return '';
      return `
        <div class="card">
          <h3>${_esc(f.label)} ‚Äî tarifs de base (par type)</h3>
          <table class="table-mini">
            <thead><tr><th>Type</th>${f.keys.map(k=>`<th>${_esc(k)}</th>`).join('')}<th></th></tr></thead>
            <tbody>
              ${arr.map((t,idx)=>`
                <tr>
                  <td>${_esc(t.nom)}</td>
                  ${f.keys.map(k=>{
                    const id=\`tb_${f.id}_${idx}_${k.replace(/\s+/g,'_')}\`;
                    const def=+(t.prix?.[k]||0);
                    return \`<td><input id="\${id}" type="number" inputmode="decimal" step="1" min="0" value="\${def}"></td>\`;
                  }).join('')}
                  <td>${b('üíæ','saveTarifBase("'+f.id+'",'+idx+')','btn')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <p class="note">Ces tarifs seront fusionn√©s dans TARIFS_BASE (overrides). Ils impacteront menus et exports.</p>
        </div>
      `;
    }).join('');

    // Section B : Coefficients
    const pose = window.COEFF_POSE||{};
    const cs   = window.COEFF_SECTIONS_CS||{};
    const poseRows = Object.keys(pose).map(k=>{
      const id='cp_'+k.replace(/\s+/g,'_');
      return `<tr><td>${_esc(k)}</td><td><input id="${id}" type="number" inputmode="decimal" step="0.05" min="0" value="${+(pose[k]||1)}"></td></tr>`;
    }).join('');
    const csRows = Object.keys(cs).map(k=>{
      const id='cs_'+k.replace(/\s+/g,'_');
      return `<tr><td>${_esc(k)}</td><td><input id="${id}" type="number" inputmode="decimal" step="0.05" min="0" value="${+(cs[k]||1)}"></td></tr>`;
    }).join('');

    view(
      '<div class="cfg8-wrap">'
      + '<div class="card">'
        + topBackButton()
        + '<h2>Tarifs & coefficients</h2>'
        + '<p class="note">Modifie les tarifs de base et les coefficients utilis√©s dans les calculs.</p>'
      + '</div>'
      + familyCards
      + '<div class="card">'
        + '<h3>Coefficients de pose</h3>'
        + '<table class="table-mini"><thead><tr><th>Type de pose</th><th>Coeff</th></tr></thead><tbody>'+poseRows+'</tbody></table>'
        + '<div class="row gap8 space-top">'+b('üíæ Enregistrer','saveCoeffsPose()','btn primary')+'</div>'
      + '</div>'
      + '<div class="card">'
        + '<h3>Coefficients sections (Circuit sp√©cialis√©)</h3>'
        + '<table class="table-mini"><thead><tr><th>Section</th><th>Coeff</th></tr></thead><tbody>'+csRows+'</tbody></table>'
        + '<div class="row gap8 space-top">'+b('üíæ Enregistrer','saveCoeffsSections()','btn primary')+'</div>'
      + '</div>'
      + bottomHome()
      + '</div>'
    );

    // Handlers
    window.saveTarifBase=function(fid,idx){
      const fam=PREST_FAMILIES.find(x=>x.id===fid); if(!fam) return;
      const cat=getCatPrest(); const item=cat[fid]?.[idx]; if(!item) return;

      const ov={ TARIFS_BASE:{} };
      const read = k => _num(document.getElementById(`tb_${fid}_${idx}_${k.replace(/\s+/g,'_')}`)?.value);

      if(fid==='prises'){
        ov.TARIFS_BASE.prises = ov.TARIFS_BASE.prises||{};
        ov.TARIFS_BASE.prises[item.nom]={}; fam.keys.forEach(k=> ov.TARIFS_BASE.prises[item.nom][k]=read(k));
      }else if(fid==='ecl_lum'||fid==='ecl_cmd'){
        ov.TARIFS_BASE.eclairage = ov.TARIFS_BASE.eclairage||{};
        ov.TARIFS_BASE.eclairage[item.nom]={}; fam.keys.forEach(k=> ov.TARIFS_BASE.eclairage[item.nom][k]=read(k));
      }else if(fid==='cs'){
        ov.TARIFS_BASE.circuit_specialise = ov.TARIFS_BASE.circuit_specialise||{};
        ov.TARIFS_BASE.circuit_specialise[item.nom]={}; fam.keys.forEach(k=> ov.TARIFS_BASE.circuit_specialise[item.nom][k]=read(k));
      }else{
        ov.TARIFS_BASE.divers = ov.TARIFS_BASE.divers||{};
        ov.TARIFS_BASE.divers[item.nom]={}; fam.keys.forEach(k=> ov.TARIFS_BASE.divers[item.nom][k]=read(k));
      }

      setOverrides(ov);
      alert('‚úÖ TARIFS_BASE mis √† jour.');
    };
    window.saveCoeffsPose=function(){
      const map={}; Object.keys(window.COEFF_POSE||{}).forEach(k=>{
        map[k]=_num(document.getElementById('cp_'+k.replace(/\s+/g,'_'))?.value);
      });
      setOverrides({ COEFF_POSE: map }); alert('‚úÖ Coeffs de pose enregistr√©s.');
    };
    window.saveCoeffsSections=function(){
      const map={}; Object.keys(window.COEFF_SECTIONS_CS||{}).forEach(k=>{
        map[k]=_num(document.getElementById('cs_'+k.replace(/\s+/g,'_'))?.value);
      });
      setOverrides({ COEFF_SECTIONS_CS: map }); alert('‚úÖ Coeffs sections enregistr√©s.');
    };
  }

  /* =====================================================================
     8.4 ‚Ä¢ CATALOGUE MAT√âRIEL (marques/gammes)
     ===================================================================== */
  function _matDefault(){
    return {
      prises: [
        { marque:'Schneider', gammes:[ {nom:'Odace', coef:1.00}, {nom:'Unica', coef:1.15} ] }
      ],
      ecl_cmd: [
        { marque:'Legrand', gammes:[ {nom:'C√©liane', coef:1.10} ] }
      ],
      tableau: [
        { marque:'Schneider', gammes:[ {nom:'Resi9', coef:1.00}, {nom:'Acti9', coef:1.15} ] }
      ]
    };
  }
  function getMat(){ return readJsonLS(KEY_CAT_MAT, _matDefault()); }
  function setMat(obj){ writeJsonLS(KEY_CAT_MAT, obj||_matDefault()); }

  function pageCatalogueMateriel(){
    const famOptions = PREST_FAMILIES.map(f=>`<option value="${f.id}">${_esc(f.label)}</option>`).join('');
    const m=getMat();
    const famCards = PREST_FAMILIES.map(f=>{
      const arr=m[f.id]||[];
      return `
        <div class="card">
          <h3>${_esc(f.label)}</h3>
          ${arr.length ? `
            <table class="table-mini">
              <thead><tr><th>Marque</th><th>Gammes (nom ‚Äî coef)</th><th></th></tr></thead>
              <tbody>
                ${arr.map((brand,bi)=>`
                  <tr>
                    <td>${_esc(brand.marque)}</td>
                    <td>
                      ${(brand.gammes||[]).map((g,gi)=>`
                        <div class="row gap8" style="margin:4px 0">
                          <input id="mg_${f.id}_${bi}_${gi}_name" value="${_esc(g.nom)}" placeholder="Nom de gamme"/>
                          <input id="mg_${f.id}_${bi}_${gi}_coef" type="number" step="0.01" inputmode="decimal" min="0" value="${+(g.coef||1)}" placeholder="Coef"/>
                          ${b('üíæ','saveMatGamme("'+f.id+'",'+bi+','+gi+')','btn')}
                          ${b('üóëÔ∏è','delMatGamme("'+f.id+'",'+bi+','+gi+')','btn')}
                        </div>
                      `).join('')}
                      <div class="row gap8 sep">
                        <input id="newg_${f.id}_${bi}_name" placeholder="Nouvelle gamme"/>
                        <input id="newg_${f.id}_${bi}_coef" type="number" step="0.01" inputmode="decimal" min="0" value="1"/>
                        ${b('Ajouter une gamme','addMatGamme("'+f.id+'",'+bi+')','btn')}
                      </div>
                    </td>
                    <td>${b('üóëÔ∏è Marque','delMatBrand("'+f.id+'",'+bi+')','btn')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          ` : '<p class="muted">Aucune marque pour le moment.</p>'}
          <div class="row gap8 space-top">
            <input id="addm_${f.id}" placeholder="Ajouter une marque (ex : Schneider)"/>
            ${b('Ajouter','addMatBrand("'+f.id+'")','btn')}
          </div>
        </div>
      `;
    }).join('');

    view(
      '<div class="cfg8-wrap">'
      + '<div class="card">'
        + topBackButton()
        + '<h2>Catalogue mat√©riel</h2>'
        + '<p class="note">D√©clare tes marques et gammes par famille. Les coefficients peuvent pond√©rer tes prix.</p>'
        + '<div class="row gap8 space-top">'
          + b('‚¨áÔ∏è Export JSON','matExport()','btn')
          + b('‚¨ÜÔ∏è Import JSON','matImport()','btn')
          + b('üßπ R√©initialiser','matReset()','btn')
        + '</div>'
      + '</div>'
      + famCards
      + bottomHome()
      + '</div>'
    );

    // Handlers
    window.addMatBrand=function(fid){
      const el=document.getElementById('addm_'+fid); const name=(el&&el.value||'').trim(); if(!name) return;
      const cur=getMat(); cur[fid]=cur[fid]||[]; cur[fid].push({ marque:name, gammes:[] });
      setMat(cur); pageCatalogueMateriel();
    };
    window.delMatBrand=function(fid,bi){
      const cur=getMat(); (cur[fid]||[]).splice(bi,1); setMat(cur); pageCatalogueMateriel();
    };
    window.addMatGamme=function(fid,bi){
      const n=document.getElementById(`newg_${fid}_${bi}_name`); const c=document.getElementById(`newg_${fid}_${bi}_coef`);
      const nom=(n&&n.value||'').trim(); if(!nom) return; const coef=_num(c&&c.value);
      const cur=getMat(); const br=(cur[fid]||[])[bi]; if(!br) return;
      br.gammes=br.gammes||[]; br.gammes.push({ nom, coef }); setMat(cur); pageCatalogueMateriel();
    };
    window.delMatGamme=function(fid,bi,gi){
      const cur=getMat(); const br=(cur[fid]||[])[bi]; if(!br) return; (br.gammes||[]).splice(gi,1);
      setMat(cur); pageCatalogueMateriel();
    };
    window.saveMatGamme=function(fid,bi,gi){
      const nameEl=document.getElementById(`mg_${fid}_${bi}_${gi}_name`);
      const coefEl=document.getElementById(`mg_${fid}_${bi}_${gi}_coef`);
      const cur=getMat(); const br=(cur[fid]||[])[bi]; if(!br) return;
      const g=(br.gammes||[])[gi]; if(!g) return;
      g.nom=(nameEl&&nameEl.value||'').trim(); g.coef=_num(coefEl&&coefEl.value);
      setMat(cur); alert('‚úÖ Gamme enregistr√©e.');
    };
  }

  // IO Mat√©riel
  function matExport(){
    const raw=JSON.stringify(getMat(),null,2);
    const blob=new Blob([raw],{type:'application/json;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='catalogue_materiel.json'; a.click();
    URL.revokeObjectURL(url);
  }
  function matImport(){
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=function(){
      const f=input.files&&input.files[0]; if(!f) return;
      const rd=new FileReader();
      rd.onload=function(){
        try{
          const obj=JSON.parse(rd.result||'{}'); if(!obj || typeof obj!=='object') throw new Error('JSON inattendu');
          setMat(obj); alert('‚úÖ Catalogue mat√©riel import√©.'); pageCatalogueMateriel();
        }catch(e){ alert('‚ùå Import impossible : '+e.message); }
      };
      rd.readAsText(f,'utf-8');
    };
    input.click();
  }
  function matReset(){
    if(!confirm('R√©initialiser le catalogue mat√©riel ?')) return;
    localStorage.removeItem(KEY_CAT_MAT); pageCatalogueMateriel();
  }

  /* =====================================================================
     8.5 ‚Ä¢ Application runtime (d√©signations & tarifs)
     ===================================================================== */
  function applyPrestationsToRuntime(){
    ensureTarifsGlobals();

    const cat=getCatPrest();

    // DESIGNATIONS_PAR_CATEGORIE
    const ensureList = (key)=>{ window.DESIGNATIONS_PAR_CATEGORIE[key] = window.DESIGNATIONS_PAR_CATEGORIE[key] || []; return window.DESIGNATIONS_PAR_CATEGORIE[key]; };
    function pushU(list, name){ if(list.indexOf(name)===-1) list.push(name); }

    (cat.prises||[]).forEach(t=> pushU(ensureList('Prises'), t.nom));
    (cat.ecl_lum||[]).forEach(t=> pushU(ensureList('√âclairage/Luminaires'), t.nom));
    (cat.ecl_cmd||[]).forEach(t=> pushU(ensureList('√âclairage/Commandes'), t.nom));
    (cat.cs||[]).forEach(t=> pushU(ensureList('Circuit sp√©cialis√©'), t.nom));
    (cat.tableau||[]).forEach(t=> pushU(ensureList('Tableau & distribution'), t.nom));
    (cat.vent||[]).forEach(t=> pushU(ensureList('VMC'), t.nom));
    (cat.terre||[]).forEach(t=> pushU(ensureList('Mise √† la terre'), t.nom));

    // TARIFS_BASE : fusionner
    function mergeTarifs(dst, src){
      Object.keys(src||{}).forEach(k=>{
        if(!dst[k]) dst[k]={};
        Object.assign(dst[k], src[k]);
      });
    }
    const tb = { prises:{}, eclairage:{}, circuit_specialise:{}, divers:{} };
    (cat.prises||[]).forEach(t=> tb.prises[t.nom] = _clone(t.prix||{}));
    (cat.ecl_lum||[]).forEach(t=> { tb.eclairage[t.nom] = Object.assign(tb.eclairage[t.nom]||{}, _clone(t.prix||{})); });
    (cat.ecl_cmd||[]).forEach(t=> { tb.eclairage[t.nom] = Object.assign(tb.eclairage[t.nom]||{}, _clone(t.prix||{})); });
    (cat.cs||[]).forEach(t=> tb.circuit_specialise[t.nom] = _clone(t.prix||{}));
    (cat.tableau||[]).forEach(t=> tb.divers[t.nom] = _clone(t.prix||{}));
    (cat.vent||[]).forEach(t=> tb.divers[t.nom] = _clone(t.prix||{}));
    (cat.terre||[]).forEach(t=> tb.divers[t.nom] = _clone(t.prix||{}));

    mergeTarifs(TARIFS_BASE.prises, tb.prises);
    mergeTarifs(TARIFS_BASE.eclairage, tb.eclairage);
    mergeTarifs(TARIFS_BASE.circuit_specialise, tb.circuit_specialise);
    TARIFS_BASE.divers = TARIFS_BASE.divers || {};
    mergeTarifs(TARIFS_BASE.divers, tb.divers);

    // Appliquer aussi les overrides enregistr√©s
    const ov=getOverrides();
    (function deepMerge(base, add){
      if(!add || typeof add!=='object') return;
      Object.keys(add).forEach(k=>{
        const v=add[k];
        if(v && typeof v==='object' && !Array.isArray(v)){
          if(!base[k] || typeof base[k]!=='object') base[k]={};
          deepMerge(base[k], v);
        }else{
          base[k]=v;
        }
      });
    })(TARIFS_BASE, ov.TARIFS_BASE||{});
  }

  // Appliquer au chargement du chapitre
  applyPrestationsToRuntime();

  /* =====================================================================
     8.6 ‚Ä¢ Expose (window) + hook menu
     ===================================================================== */
  Object.assign(window, {
    // Pages
    pageCatalogueTarifsAccueil,
    pageCataloguePrestations,
    pageTarifsCoeffs,
    pageCatalogueMateriel,

    // IO cat prestations
    catPrestExport, catPrestImport, catPrestReset,

    // IO mat√©riel
    matExport, matImport, matReset,

    // Runtime
    applyPrestationsToRuntime
  });

  // Hook discret : injecte les 3 boutons sur l‚Äôaccueil s'ils n‚Äôexistent pas
  (function softHookIntoMenu(){
    if(typeof window.pageHome!=='function') return;
    const old = window.pageHome;
    window.pageHome = function(){
      old();
      const app = document.getElementById('app'); if(!app) return;
      if(app.innerHTML.indexOf('pageCataloguePrestations()')===-1){
        const hint = '<div class="card"><div class="row" style="gap:8px;">'
          + '<button class="btn" onclick="pageCataloguePrestations()">Catalogue prestations</button>'
          + '<button class="btn" onclick="pageTarifsCoeffs()">Tarifs & coefficients</button>'
          + '<button class="btn" onclick="pageCatalogueMateriel()">Catalogue mat√©riel</button>'
          + '</div></div>';
        app.innerHTML += hint;
      }
    };
  })();

})();
</script>





















<!-- =======================================================================
     CHAPITRE 9 : MODIFICATIONS DE TABLEAU ‚Äî V3
     =======================================================================
     SOMMAIRE
       9.0 ‚Ä¢ Styles & helpers locaux (format ‚Ç¨, arrondi, section devis)
       9.1 ‚Ä¢ Injection bouton (apr√®s ‚ÄúCr√©ation tableau‚Äù sur l‚Äôaccueil)
       9.2 ‚Ä¢ Accueil ¬´ Modifications de tableau ¬ª
       9.3 ‚Ä¢ √âcran unique : D√©placement + (option) Remplacement coffret
       9.4 ‚Ä¢ Rec√¢blage tableau existant (+ mat√©riel suppl√©mentaire)
       9.5 ‚Ä¢ Expose (window)
     ======================================================================= -->

<style>
  /* 9.0 ‚Ä¢ Styles */
  .mtx{ margin-top:14px; }
  .mbx{ margin-bottom:14px; }
  .fieldset{
    border:1px solid var(--line,#e5e5e5); background:#fff;
    border-radius:10px; padding:12px; margin-top:10px;
  }
  .fieldset h3{ margin:0 0 8px; font-size:16px; }
  .pill.small{ padding:6px 10px; font-size:14px; }
  .row.gap8{ display:flex; gap:8px; flex-wrap:wrap; }
  .muted{ color:var(--muted,#666); font-size:14px; }
  .table-mini{ width:100%; border-collapse:collapse; margin-top:6px; }
  .table-mini th, .table-mini td{ border:1px solid var(--line,#e5e5e5); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<script>
/* =======================================================================
   9.0 ‚Ä¢ Helpers & constantes
   ======================================================================= */
(function(){
  // Garde-fous : boutons & affichage
  if(typeof window.b!=='function'){
    window.b=function(txt,fn,cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>'; };
  }
  if(typeof window.view!=='function'){
    window.view=function(html){ var app=document.getElementById('app'); if(app) app.innerHTML=html; };
  }

  // Format ‚Ç¨ s√ªr
  function euro9(n){
    if(typeof window.euro==='function') return window.euro(n);
    const v=(+n||0); return v.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';
  }
  // Arrondi au 5 sup√©rieur (pratique pour forfaits)
  function roundUp5(n){ n=+n||0; return Math.ceil(n/5)*5; }

  // Section devis utilis√©e
  const TABMODS_SECTION_KEY = 'Tableau & distribution';
  function ensureTabModsSection(){
    window.devis = window.devis || {};
    if(!window.devis[TABMODS_SECTION_KEY]){
      window.devis[TABMODS_SECTION_KEY] = { __base:'Tableau & distribution', items:[], note:'' };
    }
  }
  function saveLocalSafe(){ if(typeof window.saveLocal==='function') window.saveLocal(); }

  // Bar√®mes par d√©faut (modifiable ici si besoin)
  window.TARIFS_TABMODS = window.TARIFS_TABMODS || {
    deplacement: {
      par_circuit: 20,          // ‚Ç¨ / circuit rallong√©
      boite_base: 50,           // ‚Ç¨ si une bo√Æte est cr√©√©e
      boite_par_circuit: 10,    // ‚Ç¨ / circuit si bo√Æte ‚â† N√©ant
      goulotte_base: 50,        // ‚Ç¨ base goulotte
      goulotte_par_m: 20        // ‚Ç¨ / m√®tre
    },
    recablage: {
      par_circuit: 10,          // ‚Ç¨ / circuit rec√¢bl√©
      materiel: {               // prix unitaires par d√©faut (√©ditables en UI)
        "Disjoncteur modulaire": 18,
        "Inter diff 30mA": 65,
        "Peigne d‚Äôalimentation": 12,
        "Bornier": 8,
        "Contacteur J/N": 42
      }
    }
  };

  const TABMODS_BOITES = [
    { id:'NONE', label:'N√©ant' },
    { id:'100x150', label:'Bo√Æte 100√ó150' },
    { id:'150x200', label:'Bo√Æte 150√ó200' },
    { id:'200x250', label:'Bo√Æte 200√ó250' },
    { id:'300x350', label:'Bo√Æte 300√ó350' }
  ];

  // Choix rapides pour remplacement de coffret (estimation simple)
  const TABMODS_COFFRET_GAMMES  = ['Schneider Resi9','Schneider Acti9','Legrand (r√©sidentiel)','Hager (r√©sidentiel)','Hager (tertiaire)'];
  const TABMODS_COFFRET_MODULES = ['13 modules','18 modules','24 modules'];
  const TABMODS_COFFRET_RANGES  = [1,2,3,4];

  /* =====================================================================
     9.1 ‚Ä¢ Injection bouton (apr√®s ‚ÄúCr√©ation tableau‚Äù)
     ===================================================================== */
  (function injectAfterCreateTableau(){
    const original = window.pageHome;
    window.pageHome = function(){
      if(typeof original==='function') original();

      const app=document.getElementById('app');
      if(!app) return;
      if(app.innerHTML.indexOf('pageTabModsAccueil()')!==-1) return;

      const btn = '<button class="btn" onclick="pageTabModsAccueil()">Modifications de Tableau</button>';
      let html = app.innerHTML;

      // Cas 1 : bouton existant qui appelle pageTabCreate()
      const reBtnCreate = /(<button[^>]+onclick="[^"]*pageTabCreate\(\)[^"]*"[^>]*>[\s\S]*?<\/button>)/i;
      if(reBtnCreate.test(html)){
        app.innerHTML = html.replace(reBtnCreate, '$1'+btn);
        return;
      }
      // Cas 2 : fallback s√©mantique
      const reWord = /(Cr√©ation\s*tableau|Tableau\s+nouveau)/i;
      if(reWord.test(html)){
        app.innerHTML = html.replace(reWord, '$1</button>'+btn);
        return;
      }
      // Cas 3 : dernier recours : ajouter en fin de premi√®re .row
      app.innerHTML = html.replace(/(<div class="row"[^>]*>)/, '$1'+btn);
    };
  })();

  /* =====================================================================
     9.2 ‚Ä¢ Accueil ¬´ Modifications de tableau ¬ª
     ===================================================================== */
  function pageTabModsAccueil(){
    view(
      '<div class="card">'
        + b('Retour','pageHome()','btn back')
        + '<h2>Modifications de Tableau</h2>'
        + '<div class="row gap8 mtx">'
          + b('D√©placement + Remplacement coffret','pageTabModsDeplacement()','btn primary')
          + b('Rec√¢blage tableau existant','pageTabModsRecablage()','btn')
        + '</div>'
      + '</div>'
    );
  }

  /* =====================================================================
     9.3 ‚Ä¢ D√©placement + (option) Remplacement coffret
     ===================================================================== */
  function pageTabModsDeplacement(){
    const t = window.TARIFS_TABMODS.deplacement || {};
    const circuits = Array.from({length:31},(_,i)=>`<option value="${i}">${i}</option>`).join('');
    const boites   = TABMODS_BOITES.map(b=>`<option value="${b.id}">${b.label}</option>`).join('');
    const gammes   = ['Aucun'].concat(TABMODS_COFFRET_GAMMES).map(x=>`<option value="${x}">${x}</option>`).join('');
    const modules  = TABMODS_COFFRET_MODULES.map(x=>`<option value="${x}">${x}</option>`).join('');
    const ranges   = TABMODS_COFFRET_RANGES.map(x=>`<option value="${x}">${x} rang√©e(s)</option>`).join('');

    view(
      '<div class="card">'
        + b('Retour','pageTabModsAccueil()','btn back')
        + '<h2>D√©placement de tableau</h2>'

        + '<div class="fieldset">'
          + '<h3>1) Circuits √† rallonger</h3>'
          + `<select id="mt-circuits">${circuits}</select>`
          + `<small class="muted mtx">Tarif : ${euro9(+t.par_circuit||20)} / circuit</small>`
        + '</div>'

        + '<div class="fieldset">'
          + '<h3>2) Bo√Æte de d√©rivation</h3>'
          + `<select id="mt-boite">${boites}</select>`
          + `<small class="muted mtx">Base : ${euro9(+t.boite_base||50)} + ${euro9(+t.boite_par_circuit||10)} / circuit (si ‚â† N√©ant)</small>`
        + '</div>'

        + '<div class="fieldset">'
          + '<h3>3) Goulotte</h3>'
          + '<input id="mt-goulotte" type="number" step="0.1" min="0" value="0" inputmode="decimal" />'
          + `<small class="muted mtx">Base : ${euro9(+t.goulotte_base||50)} + ${euro9(+t.goulotte_par_m||20)} / m√®tre</small>`
        + '</div>'

        + '<div class="fieldset">'
          + '<h3>4) Remplacement coffret (facultatif)</h3>'
          + '<label class="pill small">Marque / Gamme</label>'
          + `<select id="rc-gamme">${gammes}</select>`
          + '<label class="pill small">Modules par rang√©e</label>'
          + `<select id="rc-mod">${modules}</select>`
          + '<label class="pill small">Nombre de rang√©es</label>'
          + `<select id="rc-range">${ranges}</select>`
          + '<label class="pill small">Type de pose</label>'
          + '<select id="rc-pose"><option>Saillie</option><option>Encastr√©</option></select>'
          + '<small class="muted mtx vblock">Estimation simple : base √ó rang√©es √ó (modules/13), coef encastr√© 1.7.</small>'
        + '</div>'

        + '<div id="mt-preview" class="muted mtx"></div>'

        + '<div class="row gap8 mtx">'
          + b('Ajouter la modification','addTabMod_Deplacement()','btn primary')
        + '</div>'
      + '</div>'
    );

    ['mt-circuits','mt-boite','mt-goulotte','rc-gamme','rc-mod','rc-range','rc-pose'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('input', refreshMtPreview);
    });
    refreshMtPreview();
  }

  function calcDeplacementTotal(nbCircuits, boiteId, lgM){
    const t = window.TARIFS_TABMODS.deplacement || {};
    const parCircuit = +t.par_circuit || 20;
    const bBase = (boiteId==='NONE') ? 0 : (+t.boite_base || 50);
    const bPerC = (boiteId==='NONE') ? 0 : (+t.boite_par_circuit || 10);
    const gBase = +t.goulotte_base || 50;
    const gPerM = +t.goulotte_par_m || 20;
    return roundUp5(nbCircuits*parCircuit + bBase + nbCircuits*bPerC + gBase + (Math.max(0,+lgM)*gPerM));
  }
  function calcRemplacementCoffretTotal(rang, modTxt, pose){
    // Mod√®le simple : 100 ‚Ç¨/rang√©e 13M, proportionnel modules, coef encastr√© 1.7
    const m = /(\d+)/.exec(modTxt||''); const mod = m? +m[1] : 13;
    const basePrix=100, coefPose=(pose==='Encastr√©'?1.7:1);
    return roundUp5(basePrix*coefPose*( (+rang||1) * (mod/13) ));
  }

  function refreshMtPreview(){
    const n  = +document.getElementById('mt-circuits').value || 0;
    const b  = document.getElementById('mt-boite').value || 'NONE';
    const lm = +document.getElementById('mt-goulotte').value || 0;

    const gamme = document.getElementById('rc-gamme').value || 'Aucun';
    const mod   = document.getElementById('rc-mod').value || '13 modules';
    const rang  = (document.getElementById('rc-range').value||'1').replace(/\D/g,'')||'1';
    const pose  = document.getElementById('rc-pose').value || 'Saillie';

    const lblBoite = (b==='NONE') ? 'Aucune bo√Æte' : (TABMODS_BOITES.find(x=>x.id===b)?.label || b);
    const t1 = calcDeplacementTotal(n,b,lm);
    let recap = `D√©placement : ${n} circuit(s) ‚Äî ${lblBoite} ‚Äî goulotte ${lm.toFixed(1)} m ‚Üí <strong>${euro9(t1)}</strong>`;

    if(gamme && gamme!=='Aucun'){
      const t2 = calcRemplacementCoffretTotal(+rang, mod, pose);
      recap += `<br>Remplacement coffret : ${rang} rang√©e(s) ‚Äî ${mod} ‚Äî ${gamme} ‚Äî Pose ${pose} ‚Üí <strong>${euro9(t2)}</strong>`;
    }else{
      recap += `<br>Remplacement coffret : <em>non s√©lectionn√©</em>`;
    }
    const el = document.getElementById('mt-preview'); if(el) el.innerHTML = recap;
  }

  function addTabMod_Deplacement(){
    const n  = +document.getElementById('mt-circuits').value || 0;
    const b  = document.getElementById('mt-boite').value || 'NONE';
    const lm = +document.getElementById('mt-goulotte').value || 0;
    const lbl = (b==='NONE') ? 'Aucune bo√Æte' : (TABMODS_BOITES.find(x=>x.id===b)?.label || b);
    const totalDep = calcDeplacementTotal(n,b,lm);

    const gamme = document.getElementById('rc-gamme').value || 'Aucun';
    const mod   = document.getElementById('rc-mod').value || '13 modules';
    const rang  = (document.getElementById('rc-range').value||'1').replace(/\D/g,'')||'1';
    const pose  = document.getElementById('rc-pose').value || 'Saillie';

    ensureTabModsSection();
    // Ligne 1 : D√©placement
    window.devis[TABMODS_SECTION_KEY].items.push({
      category:'Modification emplacement Tableau',
      designation:`Circuits √† rallonger : ${n} ‚Äî Bo√Æte : ${lbl} ‚Äî Goulotte : ${lm.toFixed(1)} m`,
      qty:1, prixU:totalDep
    });

    // Ligne 2 (facultative) : Remplacement coffret
    if(gamme && gamme!=='Aucun'){
      const totalCof = calcRemplacementCoffretTotal(+rang, mod, pose);
      window.devis[TABMODS_SECTION_KEY].items.push({
        category:'Remplacement coffret',
        designation:`${gamme} ‚Äî ${rang} rang√©e(s) √ó ${mod} ‚Äî Pose ${pose}`,
        qty:1, prixU:totalCof
      });
    }

    saveLocalSafe();
    alert('‚úÖ Modification ajout√©e √† l‚Äôestimatif.');
    pageTabModsAccueil();
  }

  /* =====================================================================
     9.4 ‚Ä¢ Rec√¢blage tableau existant
     ===================================================================== */
  let _recab_suppl = []; // { type, qty, pu }

  function pageTabModsRecablage(){
    const marques = ['Aucun'].concat(TABMODS_COFFRET_GAMMES).map(m=>`<option value="${m}">${m}</option>`).join('');
    const modules = TABMODS_COFFRET_MODULES.map(m=>`<option value="${m}">${m}</option>`).join('');
    const ranges  = TABMODS_COFFRET_RANGES.map(r=>`<option value="${r}">${r} rang√©e(s)</option>`).join('');
    const circuits = Array.from({length:31},(_,i)=>`<option value="${i}">${i}</option>`).join('');

    const MAT = (window.TARIFS_TABMODS.recablage||{}).materiel || {};
    const typeOptions = Object.keys(MAT).map(t=>`<option value="${t}">${t}</option>`).join('');

    function tableSuppl(){
      if(!_recab_suppl.length) return '<div class="muted">Aucun mat√©riel ajout√©.</div>';
      const rows = _recab_suppl.map((it,i)=>(
        `<tr>
          <td>${it.type}</td>
          <td style="text-align:right">${(+it.pu||0).toFixed(2)} ‚Ç¨</td>
          <td style="text-align:right">${(+it.qty||0)}</td>
          <td style="text-align:right">${(+it.pu*(+it.qty)).toFixed(2)} ‚Ç¨</td>
          <td>${b('√ó','recabDel('+i+')','btn')}</td>
        </tr>`
      )).join('');
      return `<table class="table-mini">
        <thead><tr><th>√âl√©ment</th><th>PU</th><th>Qt√©</th><th>Total</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    view(
      '<div class="card">'
        + b('Retour','pageTabModsAccueil()','btn back')
        + '<h2>Rec√¢blage tableau existant</h2>'

        + '<div class="fieldset">'
          + '<h3>1) Remplacement coffret (facultatif)</h3>'
          + '<label class="pill small">Marque / Gamme</label>'
          + `<select id="rb-gamme">${marques}</select>`
          + '<label class="pill small">Modules par rang√©e</label>'
          + `<select id="rb-mod">${modules}</select>`
          + '<label class="pill small">Nombre de rang√©es</label>'
          + `<select id="rb-range">${ranges}</select>`
          + '<label class="pill small">Type de pose</label>'
          + '<select id="rb-pose"><option>Saillie</option><option>Encastr√©</option></select>'
        + '</div>'

        + '<div class="fieldset">'
          + '<h3>2) Circuits √† rec√¢bler</h3>'
          + `<select id="rb-circuits">${circuits}</select>`
          + `<small class="muted mtx">Tarif : ${euro9(+((window.TARIFS_TABMODS.recablage||{}).par_circuit)||10)} / circuit</small>`
        + '</div>'

        + '<div class="fieldset">'
          + '<h3>3) Mat√©riel suppl√©mentaire</h3>'
          + '<div class="row gap8">'
            + `<select id="rb-type">${typeOptions}</select>`
            + '<input id="rb-pu" type="number" inputmode="decimal" step="0.1" min="0" placeholder="PU (‚Ç¨)" />'
            + '<input id="rb-qty" type="number" inputmode="numeric" step="1" min="1" value="1" placeholder="Qt√©" />'
            + b('Ajouter','recabAdd()','btn')
          + '</div>'
          + `<div id="rb-table" class="mtx">${tableSuppl()}</div>`
        + '</div>'

        + '<div id="rb-preview" class="muted mtx"></div>'
        + '<div class="row gap8 mtx">'
          + b('Ajouter au devis','addTabMod_Recablage()','btn primary')
        + '</div>'
      + '</div>'
    );

    // Auto PU selon type
    const sel = document.getElementById('rb-type');
    const puIn = document.getElementById('rb-pu');
    const setDefaultPU = ()=>{ const k = sel.value; const d = (window.TARIFS_TABMODS.recablage.materiel||{})[k]||0; puIn.value = (+d||0).toFixed(2); };
    if(sel){ sel.addEventListener('change', setDefaultPU); setDefaultPU(); }

    ['rb-gamme','rb-mod','rb-range','rb-pose','rb-circuits'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('input', refreshRecabPreview);
    });
    refreshRecabPreview();

    // Handlers locaux
    window.recabAdd = function(){
      const type = (document.getElementById('rb-type')?.value||'').trim();
      const pu   = parseFloat(document.getElementById('rb-pu')?.value)||0;
      const qty  = parseInt(document.getElementById('rb-qty')?.value,10)||1;
      if(!type || pu<=0 || qty<=0) return;
      _recab_suppl.push({type, pu:+pu, qty:+qty});
      pageTabModsRecablage();
    };
    window.recabDel = function(i){
      _recab_suppl.splice(i,1);
      pageTabModsRecablage();
    };
  }

  function calcRecabCoffret(gamme, rang, modTxt, pose){
    if(!gamme || gamme==='Aucun') return 0;
    return calcRemplacementCoffretTotal(+rang, modTxt, pose);
  }
  function calcRecabCircuits(n){
    return roundUp5( ( +(window.TARIFS_TABMODS.recablage||{}).par_circuit || 10 ) * Math.max(0,+n) );
  }
  function calcRecabSupplTotal(){
    return roundUp5((_recab_suppl||[]).reduce((s,it)=> s + ((+it.pu||0)*(+it.qty||0)), 0));
  }

  function refreshRecabPreview(){
    const gamme = document.getElementById('rb-gamme')?.value || 'Aucun';
    const mod   = document.getElementById('rb-mod')?.value || '13 modules';
    const rang  = (document.getElementById('rb-range')?.value||'1').replace(/\D/g,'')||'1';
    const pose  = document.getElementById('rb-pose')?.value || 'Saillie';
    const n     = +document.getElementById('rb-circuits')?.value || 0;

    const tCof = calcRecabCoffret(gamme, rang, mod, pose);
    const tCir = calcRecabCircuits(n);
    const tSup = calcRecabSupplTotal();
    const total = roundUp5(tCof + tCir + tSup);

    const el = document.getElementById('rb-preview');
    if(!el) return;
    el.innerHTML =
      `Rempl. coffret : ${(gamme==='Aucun')?'‚Äî':`${rang} rang√©e(s) ‚Äî ${mod} ‚Äî ${gamme} ‚Äî Pose ${pose} ‚Üí <strong>${euro9(tCof)}</strong>`}`
      + `<br>Circuits √† rec√¢bler : ${n} ‚Üí <strong>${euro9(tCir)}</strong>`
      + `<br>Mat√©riel suppl√©mentaire : <strong>${euro9(tSup)}</strong>`
      + `<br>Total estim√© : <strong>${euro9(total)}</strong>`;
  }

  function addTabMod_Recablage(){
    const gamme = document.getElementById('rb-gamme')?.value || 'Aucun';
    const mod   = document.getElementById('rb-mod')?.value || '13 modules';
    const rang  = (document.getElementById('rb-range')?.value||'1').replace(/\D/g,'')||'1';
    const pose  = document.getElementById('rb-pose')?.value || 'Saillie';
    const n     = +document.getElementById('rb-circuits')?.value || 0;

    ensureTabModsSection();

    // (a) Remplacement coffret (si choisi)
    if(gamme && gamme!=='Aucun'){
      const tCof = calcRecabCoffret(gamme, rang, mod, pose);
      window.devis[TABMODS_SECTION_KEY].items.push({
        category:'Rec√¢blage tableau existant ‚Äî Remplacement coffret',
        designation:`${gamme} ‚Äî ${rang} rang√©e(s) √ó ${mod} ‚Äî Pose ${pose}`,
        qty:1, prixU:tCof
      });
    }
    // (b) Circuits √† rec√¢bler
    const tCir = calcRecabCircuits(n);
    window.devis[TABMODS_SECTION_KEY].items.push({
      category:'Rec√¢blage tableau existant ‚Äî Circuits',
      designation:`Nombre de circuits √† rec√¢bler : ${n}`,
      qty:1, prixU:tCir
    });
    // (c) Mat√©riel suppl√©mentaire (lignes d√©taill√©es)
    (_recab_suppl||[]).forEach(it=>{
      window.devis[TABMODS_SECTION_KEY].items.push({
        category:'Rec√¢blage tableau existant ‚Äî Mat√©riel suppl.',
        designation:`${it.type}`,
        qty:+it.qty||1, prixU:+it.pu||0
      });
    });

    saveLocalSafe();
    _recab_suppl = [];
    alert('‚úÖ Rec√¢blage ajout√© √† l‚Äôestimatif.');
    pageTabModsAccueil();
  }

  /* =====================================================================
     9.5 ‚Ä¢ Expose (window)
     ===================================================================== */
  Object.assign(window,{
    // Pages
    pageTabModsAccueil,
    pageTabModsDeplacement,
    pageTabModsRecablage,
    // Actions
    addTabMod_Deplacement,
    addTabMod_Recablage
  });

})();
</script>
















<!-- =======================================================================
     CHAPITRE 10 : FACTURATION ‚Äî V3 (Complet)
     =======================================================================
     SOMMAIRE
       10.0 ‚Ä¢ Helpers & pr√©f√©rences (lecture/sauvegarde, ‚Ç¨, date)
       10.1 ‚Ä¢ TVA effective & total HT (depuis le devis courant)
       10.2 ‚Ä¢ Num√©rotation facture (aper√ßu + incr√©ment apr√®s export)
       10.3 ‚Ä¢ FACTURE TXT (tout compris ou s√©par√©e)
       10.4 ‚Ä¢ FACTURE CSV (2 lignes : Prestations / Mat√©riel)
       10.5 ‚Ä¢ Snapshots locaux ¬´ Mes factures ¬ª (ouvrir, renommer, dupliquer, supprimer)
       10.6 ‚Ä¢ Page ¬´ Mes factures ¬ª
       10.7 ‚Ä¢ Injection robuste des boutons d‚Äôexport (Estimatif & Totaux)
       10.8 ‚Ä¢ Expose (window)
     ======================================================================= -->

<style>
  .fact-wrap .card{ margin-bottom:24px; }
  .table-mini{ width:100%; border-collapse:collapse; margin-top:10px; }
  .table-mini th, .table-mini td{ border:1px solid var(--line,#e5e5e5); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
  .muted{ color:#666; font-size:14px; }
  .row.gap8{ display:flex; gap:8px; flex-wrap:wrap; }
</style>

<script>
/* =======================================================================
   10.0 ‚Ä¢ Helpers & pr√©f√©rences
   ======================================================================= */
(function(){
  // Garde-fous UI
  if(typeof window.b!=='function'){
    window.b=(txt,fn,cls)=>'<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>';
  }
  if(typeof window.view!=='function'){
    window.view=html=>{ const app=document.getElementById('app'); if(app) app.innerHTML=html; };
  }

  // LS JSON
  function _f10_readJSON(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
  function _f10_writeJSON(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

  // Pr√©f√©rences & soci√©t√©
  function _f10_prefs(){
    return _f10_readJSON('appPrefs_v1', {
      facturation_mode:'tout_compris', devise:'‚Ç¨',
      tva_applicable:false, taux_tva:20,
      numerotation_fact_prefix:'FAC-', numerotation_courante:1
    });
  }
  function _f10_company(){ return _f10_readJSON('companyConfig_v1', {}); }

  // Format ‚Ç¨
  function _f10_fmtEuro(n, sym){ var s=(sym||'‚Ç¨').trim(); return (+(n||0)).toFixed(2)+' '+s; }
  // Date FR
  function _f10_todayFR(){
    try{ return new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit'}); }
    catch(e){ return new Date().toLocaleDateString(); }
  }
  function _f10_clone(x){ return JSON.parse(JSON.stringify(x)); }

  /* =====================================================================
     10.1 ‚Ä¢ TVA effective & total HT (devis courant)
     ===================================================================== */
  function _f10_effectiveTVA_from(obj){
    var prefs=_f10_prefs();
    var on  = (obj && typeof obj.__tva_applicable!=='undefined') ? !!obj.__tva_applicable : !!prefs.tva_applicable;
    var tx  = (obj && typeof obj.__taux_tva!=='undefined') ? Math.max(0,+obj.__taux_tva||0) : Math.max(0,+prefs.taux_tva||20);
    return { on:on, taux:tx };
  }
  function _f10_sumHT_from(obj){
    var sum=0;
    if(!obj) return 0;
    for(var k in obj){
      if(k.indexOf('__')===0) continue;
      var s=obj[k], items=(s&&s.items)||[];
      for(var i=0;i<items.length;i++){
        var it=items[i];
        sum += ((+it.prixU||0) * (+it.qty||0));
      }
    }
    return sum;
  }

  /* =====================================================================
     10.2 ‚Ä¢ Num√©rotation facture
     ===================================================================== */
  function _f10_invoiceNumberPreview(){
    var p=_f10_prefs();
    var prefix=p.numerotation_fact_prefix||'FAC-';
    var num=Math.max(1, parseInt(p.numerotation_courante||1,10));
    return prefix + String(num).padStart(4,'0');
  }
  function _f10_incrementAfterExport(){
    var p=_f10_prefs();
    var cur=Math.max(1, parseInt(p.numerotation_courante||1,10));
    p.numerotation_courante = cur + 1;
    _f10_writeJSON('appPrefs_v1', p);
  }

  /* =====================================================================
     10.3 ‚Ä¢ FACTURE TXT
     ===================================================================== */
  function _f10_buildInvoiceText_fromSnapshot(snap, opts){
    opts = opts||{};
    var prefs=_f10_prefs(), company=_f10_company();
    var devise=prefs.devise||'‚Ç¨';

    var eff=_f10_effectiveTVA_from(snap);
    var tvaOn=!!eff.on, tauxTVA=Math.max(0,+eff.taux||20);

    var totalHT=_f10_sumHT_from(snap);
    var mode=(opts.mode || prefs.facturation_mode || 'tout_compris'); // 'separe'|'tout_compris'
    var ratioMat=0, ratioPrest=1;

    if(mode==='separe'){
      var pct = (typeof opts.matPct==='number') ? opts.matPct : parseFloat(prompt('Facture s√©par√©e : % MAT√âRIEL ?', '40'));
      if(isNaN(pct)) pct=40;
      pct=Math.min(100,Math.max(0,pct));
      ratioMat=pct/100; ratioPrest=1-ratioMat;
    }

    var totalMatHT   = (mode==='separe') ? (totalHT * ratioMat)   : 0;
    var totalPrestHT = (mode==='separe') ? (totalHT * ratioPrest) : totalHT;

    var tvaPrest = tvaOn ? (totalPrestHT * tauxTVA/100) : 0;
    var tvaMat   = tvaOn ? (totalMatHT   * tauxTVA/100) : 0;

    var out=[];
    out.push('================= FACTURE =================');
    out.push('Date : '+_f10_todayFR());
    out.push('N¬∞   : '+_f10_invoiceNumberPreview());
    out.push('');

    // √âmetteur
    out.push('√âmetteur :');
    var rs=(company.raison_sociale||company.nom_commercial||'').trim(); if(rs) out.push('  '+rs);
    var adr=[company.adresse,company.code_postal,company.ville].filter(Boolean).join(' '); if(adr) out.push('  '+adr);
    if(company.pays) out.push('  '+company.pays);
    if(company.email) out.push('  Email : '+(company.email||''));
    if(company.telephone) out.push('  T√©l   : '+(company.telephone||''));
    if(company.siren) out.push('  SIREN : '+(company.siren||''));
    if(company.tva_intracom) out.push('  TVA   : '+(company.tva_intracom||''));
    out.push('========================================================'); out.push('');

    if(mode==='separe'){
      out.push('1) Prestations de services');
      out.push('   Montant HT  : '+_f10_fmtEuro(totalPrestHT, devise));
      if(tvaOn) out.push('   TVA ('+tauxTVA+'%) : '+_f10_fmtEuro(tvaPrest, devise));
      out.push('   Montant TTC : '+_f10_fmtEuro(totalPrestHT + tvaPrest, devise));
      out.push('');

      out.push('2) Vente de mat√©riel');
      out.push('   Montant HT  : '+_f10_fmtEuro(totalMatHT, devise));
      if(tvaOn) out.push('   TVA ('+tauxTVA+'%) : '+_f10_fmtEuro(tvaMat, devise));
      out.push('   Montant TTC : '+_f10_fmtEuro(totalMatHT + tvaMat, devise));
      out.push('');

      out.push('[Info] R√©partition : Mat√©riel = '+Math.round(ratioMat*100)+'% | Prestations = '+Math.round(ratioPrest*100)+'%');
      out.push('');
    }else{
      out.push('1) Fournitures + pose (tout compris)');
      out.push('   Montant HT  : '+_f10_fmtEuro(totalHT, devise));
      if(tvaOn) out.push('   TVA ('+tauxTVA+'%) : '+_f10_fmtEuro(totalHT * tauxTVA/100, devise));
      out.push('   Montant TTC : '+_f10_fmtEuro(totalHT + (tvaOn? totalHT*tauxTVA/100 : 0), devise));
      out.push('');
    }

    var htGlobal  = (mode==='separe') ? (totalPrestHT + totalMatHT) : totalHT;
    var tvaGlobal = tvaOn ? ((mode==='separe') ? (tvaPrest + tvaMat) : (totalHT * tauxTVA/100)) : 0;

    out.push('================= R√âCAPITULATIF =================');
    out.push('Total HT  : '+_f10_fmtEuro(htGlobal, devise));
    if(tvaOn) out.push('TVA       : '+_f10_fmtEuro(tvaGlobal, devise));
    out.push('Total TTC : '+_f10_fmtEuro(htGlobal + tvaGlobal, devise));
    out.push('================================================='); out.push('');

    if(company.conditions_paiement) out.push('Conditions de paiement : '+company.conditions_paiement);
    if(company.iban) out.push('IBAN : '+company.iban+(company.bic?(' ‚Äî BIC : '+company.bic):''));
    if(company.rc_pro) out.push('RC Pro : '+company.rc_pro);
    if(company.decennale) out.push('D√©cennale : '+company.decennale);
    if(company.assureur) out.push('Assureur : '+company.assureur);
    if(company.mentions_legales){ out.push(''); out.push(company.mentions_legales); }

    return out.join('\r\n');
  }

  function f10_exportInvoiceTXT_Current(mode){ // 'tout_compris' | 'separe' | 'auto'
    var snap = window.devis || null;
    if(!snap){ alert('Aucun document en cours.'); return; }
    var prefs=_f10_prefs();
    var useMode = (mode && mode!=='auto') ? mode : (prefs.facturation_mode||'tout_compris');

    var txt = _f10_buildInvoiceText_fromSnapshot(snap, { mode:useMode });
    var name = (snap.__name || 'Document').trim() || 'Document';
    var blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase() + (useMode==='separe'?'_facture_sep':'_facture') + '.txt';
    a.click(); URL.revokeObjectURL(url);

    _f10_incrementAfterExport();
    alert('‚úÖ Facture (texte) export√©e.');
  }

  /* =====================================================================
     10.4 ‚Ä¢ FACTURE CSV (2 lignes)
     ===================================================================== */
  function _f10_csv_build_fromSnapshot(snap, matPct){
    var prefs=_f10_prefs();
    var eff=_f10_effectiveTVA_from(snap);
    var tvaOn=!!eff.on, tauxTVA=Math.max(0,+eff.taux||20);

    var totalHT=_f10_sumHT_from(snap);
    var matRatio=Math.min(100,Math.max(0,parseFloat(matPct||40)))/100;
    var prestRatio=1-matRatio;
    var totalMatHT=totalHT*matRatio, totalPrestHT=totalHT*prestRatio;

    function fmt(n){ return (+(n||0)).toFixed(2).replace('.',','); }
    function esc(s){ s=String(s==null?'':s); return (s.indexOf(';')>=0 || s.indexOf('"')>=0 || s.indexOf('\n')>=0) ? ('"'+s.replace(/"/g,'""')+'"') : s; }

    var date=_f10_todayFR(), unit='lot', qty=1;
    var name=(snap && snap.__name ? String(snap.__name).trim() : 'Document');
    var lines=[ ['Date','Libell√©','Quantit√©','Unit√©','PU HT','Montant HT','TVA %','Cat√©gorie'].join(';') ];

    lines.push([ esc(date), esc('Prestations ‚Äî '+name), esc(qty), esc(unit), fmt(totalPrestHT), fmt(totalPrestHT), esc(tvaOn?tauxTVA:0), esc('Prestations') ].join(';'));
    lines.push([ esc(date), esc('Mat√©riel ‚Äî '+name),   esc(qty), esc(unit), fmt(totalMatHT),   fmt(totalMatHT),   esc(tvaOn?tauxTVA:0), esc('Mat√©riel')   ].join(';'));

    return lines.join('\r\n');
  }
  function f10_exportInvoiceCSV_Current(){
    var snap = window.devis || null;
    if(!snap){ alert('Aucun document en cours.'); return; }
    var ask = prompt('Pourcentage MAT√âRIEL (0‚Äì100) ?', '40'); if(ask==null) return;
    var csv = _f10_csv_build_fromSnapshot(snap, ask);
    var name = (snap.__name || 'Document').trim() || 'Document';
    var blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_facture.csv';
    a.click(); URL.revokeObjectURL(url);

    alert('‚úÖ CSV (facture) export√© : 2 lignes (Prestations / Mat√©riel).');
  }

  /* =====================================================================
     10.5 ‚Ä¢ Snapshots ¬´ Mes factures ¬ª
     ===================================================================== */
  const F10_KEY_INVOICES = 'invoices_v1';
  function f10_invoices_read(){ return _f10_readJSON(F10_KEY_INVOICES, []); }
  function f10_invoices_write(arr){ _f10_writeJSON(F10_KEY_INVOICES, arr||[]); }
  function f10_newId(){ return 'fac_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8); }

  function f10_saveCurrentAsInvoice(){
    if(!window.devis){ alert('Aucun document en cours.'); return; }
    var prefs=_f10_prefs();
    var inv={
      __id: f10_newId(),
      name: (devis.__name || 'Document').trim() || 'Document',
      created_at: new Date().toISOString(),
      mode: prefs.facturation_mode || 'tout_compris',
      snapshot: _f10_clone(devis)
    };
    var list=f10_invoices_read(); list.unshift(inv); f10_invoices_write(list);
    alert('‚úÖ Facture enregistr√©e.');
  }

  /* =====================================================================
     10.6 ‚Ä¢ Page ¬´ Mes factures ¬ª
     ===================================================================== */
  function pageFactures(){
    var list=f10_invoices_read();
    var html = '<div class="fact-wrap">'
      + '<div class="card">'
        + (typeof b==='function'? b('Retour','pageHome ? pageHome() : pageMain()','btn back') : '')
        + '<h2>Mes factures</h2>'
        + '<div class="row gap8" style="margin-top:8px;">'
          + (typeof b==='function'? b('Transformer le document courant en facture','f10_saveCurrentAsInvoice()','btn primary') : '<button class="btn" onclick="f10_saveCurrentAsInvoice()">Transformer le document courant en facture</button>')
        + '</div>'
        + '<p class="muted">Prochain num√©ro : '+_f10_invoiceNumberPreview()+'</p>'
      + '</div>';

    if(!list.length){
      html += '<div class="card"><p class="muted">Aucune facture sauvegard√©e pour le moment.</p></div>';
    }else{
      html += '<div class="card">'
        + '<table class="table-mini"><thead><tr>'
        + '<th>Nom</th><th>Cr√©√©e le</th><th>Mode</th><th>Actions</th>'
        + '</tr></thead><tbody>';
      list.forEach(function(inv){
        var d=new Date(inv.created_at).toLocaleString('fr-FR');
        html += '<tr>'
          + '<td>'+ (inv.name||'Facture') +'</td>'
          + '<td>'+ d +'</td>'
          + '<td>'+ (inv.mode==='separe'?'S√©par√©':'Tout compris') +'</td>'
          + '<td>'
            + b('Ouvrir (√©diter)','f10_openInvoice(\''+inv.__id+'\')','btn')
            + b('Renommer','f10_renameInvoice(\''+inv.__id+'\')','btn')
            + b('Dupliquer','f10_duplicateInvoice(\''+inv.__id+'\')','btn')
            + b('Supprimer','f10_deleteInvoice(\''+inv.__id+'\')','btn')
            + b('TXT (TC)','f10_exportInvoiceTXT_FromStored(\''+inv.__id+'\',\'tc\')','btn')
            + b('TXT (S√©par√©)','f10_exportInvoiceTXT_FromStored(\''+inv.__id+'\',\'sep\')','btn')
            + b('CSV','f10_exportInvoiceCSV_FromStored(\''+inv.__id+'\')','btn')
          + '</td>'
        + '</tr>';
      });
      html += '</tbody></table></div>';
    }

    html += '</div>';
    view(html);
  }

  // Handlers pageFactures
  function f10_findInvoice(id){ return f10_invoices_read().find(x=>x.__id===id); }
  function f10_openInvoice(id){
    var inv=f10_findInvoice(id); if(!inv){ alert('Introuvable.'); return; }
    window.devis=_f10_clone(inv.snapshot||{});
    if(typeof saveLocal==='function') saveLocal();
    alert('‚úÖ Facture ouverte comme document modifiable.\nTu peux ajuster puis exporter.');
    if(typeof pageEstimatif==='function') pageEstimatif();
  }
  function f10_deleteInvoice(id){
    if(!confirm('Supprimer cette facture ?')) return;
    var list=f10_invoices_read().filter(x=>x.__id!==id); f10_invoices_write(list);
    pageFactures();
  }
  function f10_duplicateInvoice(id){
    var inv=f10_findInvoice(id); if(!inv) return;
    var copy=_f10_clone(inv); copy.__id=f10_newId(); copy.created_at=new Date().toISOString();
    var list=f10_invoices_read(); list.unshift(copy); f10_invoices_write(list);
    pageFactures();
  }
  function f10_renameInvoice(id){
    var inv=f10_findInvoice(id); if(!inv) return;
    var nn=prompt('Nouveau nom de facture :', inv.name||''); if(nn==null) return;
    inv.name = (nn||'').trim()||inv.name;
    var list=f10_invoices_read().map(x=> x.__id===id ? inv : x); f10_invoices_write(list);
    pageFactures();
  }

  // Exports depuis snapshot stock√©
  function f10_exportInvoiceTXT_FromStored(id, mode){ // 'tc' | 'sep'
    var inv=f10_findInvoice(id); if(!inv) return;
    var txt=_f10_buildInvoiceText_fromSnapshot(inv.snapshot, { mode:(mode==='sep'?'separe':'tout_compris') });
    var blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download=(inv.name||'facture').replace(/\s+/g,'_').toLowerCase() + (mode==='sep'?'_sep':'_tc') + '.txt';
    a.click(); URL.revokeObjectURL(url);
  }
  function f10_exportInvoiceCSV_FromStored(id){
    var inv=f10_findInvoice(id); if(!inv) return;
    var ask=prompt('Pourcentage MAT√âRIEL (0‚Äì100) ?','40'); if(ask==null) return;
    var csv=_f10_csv_build_fromSnapshot(inv.snapshot, ask);
    var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download=(inv.name||'facture').replace(/\s+/g,'_').toLowerCase()+'_facture.csv';
    a.click(); URL.revokeObjectURL(url);
  }

  /* =====================================================================
     10.7 ‚Ä¢ Injection des boutons d‚Äôexport (Estimatif & Totaux)
     ===================================================================== */
  (function f10_injectExportButtons(){
    function addBtns(){
      var app=document.getElementById('app'); if(!app) return;

      // √©viter doublons
      if(app.innerHTML.indexOf('f10_exportInvoiceTXT_Current(')!==-1
        && app.innerHTML.indexOf('f10_exportInvoiceCSV_Current()')!==-1) return;

      // point d‚Äôancrage : zone d‚Äôexports existante si possible
      var anchor =
        app.querySelector('.row button[onclick*="exportZipFull"]')?.closest('.row') ||
        app.querySelector('.row button[onclick*="exportTextFull"]')?.closest('.row') ||
        app.querySelector('.row:last-of-type');

      var wrap=document.createElement('div');
      wrap.className='row';
      wrap.style.marginTop='10px';
      wrap.innerHTML =
        '<button class="btn" onclick="f10_exportInvoiceTXT_Current(\'auto\')">üí∂ Facture (TXT)</button>'
        + '<button class="btn" onclick="f10_exportInvoiceTXT_Current(\'separe\')">üí∂ Facture (TXT s√©par√©)</button>'
        + '<button class="btn" onclick="f10_exportInvoiceCSV_Current()">üí∂ Facture (CSV ‚Äî compta)</button>';

      (anchor?anchor.parentNode:app).appendChild(wrap);
    }

    var oE=window.pageEstimatif, oT=window.pageTotaux;
    if(typeof oE==='function'){ window.pageEstimatif=function(){ oE(); addBtns(); }; }
    if(typeof oT==='function'){ window.pageTotaux=function(){ oT(); addBtns(); }; }
  })();

  /* =====================================================================
     10.8 ‚Ä¢ Expose
     ===================================================================== */
  Object.assign(window, {
    // Page & store
    pageFactures,
    f10_saveCurrentAsInvoice,
    f10_openInvoice,
    f10_deleteInvoice,
    f10_duplicateInvoice,
    f10_renameInvoice,

    // Exports courants
    f10_exportInvoiceTXT_Current,
    f10_exportInvoiceCSV_Current,

    // Exports depuis ¬´ Mes factures ¬ª
    f10_exportInvoiceTXT_FromStored,
    f10_exportInvoiceCSV_FromStored
  });
})();
</script>




















<!-- =============================
     CHAPITRE 11 : ESTIMATIF & EXPORTS ‚Äî V3 (Partie 1/2)
     Sommaire :
       11.0 ‚Ä¢ D√©tection / libell√© des pi√®ces (Tableaux inclus)
       11.1 ‚Ä¢ Tri d√©di√© aux Tableaux (diff ‚Üí coupure ‚Üí disjoncteurs ‚Üí reste)
       11.2 ‚Ä¢ Pages : Estimatif d√©taill√© & Totaux par groupe
       11.9 ‚Ä¢ Expose (fin de partie 1)
     ============================= -->
<style>
  .table-mini{ width:100%; border-collapse:collapse; }
  .table-mini th, .table-mini td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
  .table-mini th{ background:#fafafa; }
</style>

<script>
// =============================
// 11.0 ‚Ä¢ D√©tection & libell√©s
// =============================

// Groupes ‚Äúpi√®ce ‚Üí famille‚Äù
window.PIECE_GROUPS = window.PIECE_GROUPS || {
  "Buanderie":"Pi√®ces techniques","Garage":"Pi√®ces techniques","Atelier":"Pi√®ces techniques",
  "Jardin":"Ext√©rieur","Terrasse":"Ext√©rieur","Balcon":"Ext√©rieur","Abri de jardin":"Ext√©rieur",
  "Cuisine":"Cuisine",
  "Salon":"Pi√®ces de vie","Salle √† manger":"Pi√®ces de vie","Couloir":"Pi√®ces de vie","Entr√©e":"Pi√®ces de vie",
  "Salle de bain":"Pi√®ces d'eau","Salle d'eau":"Pi√®ces d'eau","Toilettes":"Pi√®ces d'eau",
  "Chambre 1":"Chambres & Bureau","Chambre 2":"Chambres & Bureau","Chambre 3":"Chambres & Bureau",
  "Bureau":"Chambres & Bureau","Biblioth√®que":"Chambres & Bureau",
  "Tableau":"Tableau & distribution","Distribution":"Tableau & distribution",
  "Mise √† la terre":"Mise √† la terre","VMC":"VMC"
};

// Format ‚Ç¨ (utilise euro() si dispo)
function _euro11(n){
  try{
    if(typeof euro==='function') return euro(n);
  }catch(e){}
  var v = (+n||0);
  return v.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2})+' ‚Ç¨';
}

function groupDevis(){
  var g = {};
  if(!window.devis) return g;
  for (var key in devis){
    if (key.indexOf("__") === 0) continue;
    var s = devis[key];
    var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
    var grp  = window.PIECE_GROUPS[base] || "Divers";
    if (!g[grp]) g[grp] = {};
    g[grp][key] = s;
  }
  return g;
}
function isTableauKey(key){
  var s = devis[key] || {};
  return ((s.__base||'').toLowerCase()==='tableau') || /^Tableau\s/i.test(key);
}
function pieceDisplayLabel(key){
  var s = devis[key] || {};
  var base = (s && s.__base) ? s.__base : key.replace(/\s*\(.*\)\s*$/,"").split(" ‚Äî ")[0];
  var qual = s.qualificatif || '';
  var etg  = s.etage || '';
  var label = base===key ? key : (base + (qual ? ' ('+qual+')':'') + (etg ? ' ‚Äî '+etg:''));
  if(isTableauKey(key) && s.__customName && s.__customName.trim()){
    label = key + ' ‚Äî ' + s.__customName.trim();
  }else{
    if(!isTableauKey(key)){
      label = (typeof formatPieceLabel === 'function') ? formatPieceLabel(key) : key;
    }else{
      label = key;
    }
  }
  return label;
}

// ========================================
// 11.1 ‚Ä¢ Tri d√©di√© aux Tableaux (esth√©tique)
// ========================================
function sortedItemsForPiece(key, items){
  if(!Array.isArray(items)) return [];
  if(!isTableauKey(key)) return items.slice();

  function score(it){
    var d = (it && it.designation ? String(it.designation) : '').trim();
    if (/^ID\s/i.test(d))             return 0; // Inter diff en t√™te
    if (/^Coupure g√©n√©rale/i.test(d)) return 1;
    if (/^Disjoncteur\s/i.test(d))    return 2;
    return 3;
  }
  return items.map(function(it, i){ return {it:it, i:i, s:score(it)}; })
              .sort(function(a,b){ return (a.s - b.s) || (a.i - b.i); })
              .map(function(x){ return x.it; });
}

// ===========================================
// 11.2 ‚Ä¢ Pages : Estimatif & Totaux par groupe
// ===========================================
function itemLine(it){
  var unit = it.unit || "u";
  var poseTxt = (it.intervention === "Cr√©ation" && it.pose) ? (" - " + String(it.pose).toLowerCase()) : "";
  var left = it.intervention ? (it.intervention + " ‚Äî ") : "";
  var pu = (+it.prixU || 0).toFixed(2);
  var q  = +it.qty || 0;
  var total = (q * (+it.prixU || 0)).toFixed(2);
  return "- " + left + it.designation + poseTxt + " | Qt√©: " + q + " " + unit + " | PU: " + pu + "‚Ç¨ | Total: " + total + "‚Ç¨";
}
function pieceSeparator(label){ return "\n---------------- " + label + " ----------------\n"; }

function pageEstimatif(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Estimatif d√©taill√©</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    html += '<h2 style="border-top:2px solid #000; padding-top:8px;">'+grp+'</h2>';
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var pieceLabel = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var sectionTotal = 0;

      html += '<h3 style="margin-top:6px; border-top:1px solid #ccc; padding-top:4px;">'+pieceLabel+'</h3><ul>';
      items.forEach(function(it){
        var q  = +it.qty || 0;
        var pu = +it.prixU || 0;
        var t  = q * pu;
        sectionTotal += t; groupTotal += t; totalGlobal += t;

        var poseTxt = (it.intervention==="Cr√©ation" && it.pose) ? (" " + String(it.pose).toLowerCase()) : "";
        var unit    = it.unit || "u";
        var left    = it.intervention ? (it.intervention+" ‚Äî ") : "";
        html += '<li>' + left + it.designation + poseTxt + ' ('+q+' '+unit+' √ó '+_euro11(pu)+' = '+_euro11(t)+')</li>';
      });
      if (s.note) html += '<li><em>Note : '+s.note+'</em></li>';

      html += '</ul><p><strong>Total '+pieceLabel+' : '+_euro11(sectionTotal)+'</strong></p>';
    }

    html += '<p><strong>Total '+grp+' : '+_euro11(groupTotal)+'</strong></p><hr>';
  }

  html += '<h3>Total global : '+_euro11(totalGlobal)+'</h3>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("üßæ Export DEVIS (tout compris)","exportDevisToutComprisTXT()","btn primary")
       +    b("üßæ Export DEVIS (s√©par√©)","exportDevisSepareTXT()","btn")
       +  '</div>'
       +  '</div>';

  view(html);
}

function pageTotaux(){
  var html = '<div class="card">'+b("Retour","pageHome()","btn back")+'<h2>Totaux par groupe</h2>';
  var totalGlobal = 0;
  var grouped = groupDevis();

  for (var grp in grouped){
    var gt = 0;
    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;
      var items = sortedItemsForPiece(key, s.items);
      var st = items.reduce(function(sum,it){ return sum + (((+it.prixU)||0)*((+it.qty)||0)); }, 0);
      gt += st; totalGlobal += st;
    }
    html += '<p><strong>'+grp+'</strong> : '+_euro11(gt)+'</p>';
  }

  html += '<hr><p><strong>Total global : '+_euro11(totalGlobal)+'</strong></p>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("Export .txt (par groupe)","exportText()","btn")
       +    b("Export .zip (par groupe)","exportZipGroups()","btn")
       +    b("Export .txt (complet)","exportTextFull()","btn")
       +    b("Export .zip (complet)","exportZipFull()","btn")
       +  '</div>'
       +  '<div class="row" style="margin-top:10px;">'
       +    b("üßæ Export DEVIS (tout compris)","exportDevisToutComprisTXT()","btn primary")
       +    b("üßæ Export DEVIS (s√©par√©)","exportDevisSepareTXT()","btn")
       +  '</div>'
       +  '</div>';

  view(html);
}

// =============================
// 11.9 ‚Ä¢ Expose (fin de partie 1)
// =============================
Object.assign(window, {
  PIECE_GROUPS, groupDevis, isTableauKey, pieceDisplayLabel, sortedItemsForPiece,
  pageEstimatif, pageTotaux
});
</script>
<!-- =============================
     CHAPITRE 11 : ESTIMATIF & EXPORTS ‚Äî V3 (Partie 2/2)
     Sommaire :
       11.3 ‚Ä¢ Exports : .txt par groupe / .zip par groupe
       11.4 ‚Ä¢ Exports : complet .txt / complet .zip
       11.5 ‚Ä¢ DEVIS (TXT) : tout compris & s√©par√© Prestations/Mat√©riel
       11.6 ‚Ä¢ Expose (fonctions d‚Äôexport)
     ============================= -->
<script>
// =============================================
// 11.3 ‚Ä¢ Exports : TXT/ZIP par groupe (estimatif)
// =============================================
function exportText(){
  var grouped = groupDevis();
  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push("\n---------------- "+label+" ----------------\n");

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');

    var blob = new Blob([lines.join('\r\n')], {type:'text/plain;charset=utf-8'});
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href = url; a.download = 'devis_'+grp+'.txt'; a.click();
    URL.revokeObjectURL(url);
  }
  alert('‚úÖ Export termin√© : un fichier .txt par groupe g√©n√©r√©.');
}

async function exportZipGroups(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var grouped = groupDevis();
  var zip = new JSZip();
  var global = 0;

  for (var grp in grouped){
    var lines = ['=== '+grp+' ===\n'];
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push("\n---------------- "+label+" ----------------\n");

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨');
    global += groupTotal;

    zip.file('devis_'+grp+'.txt', lines.join('\r\n'));
  }

  var name = (devis && devis.__name || 'Devis').trim() || 'Devis';
  var readme = 'R√©capitulatif ‚Äî '+name+'\nDate: '+new Date().toLocaleString('fr-FR')
             + '\n\nTotal global: '+global.toFixed(2)+'‚Ç¨\n';
  zip.file('README.txt', readme);

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_groupes.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export ZIP (par groupe) g√©n√©r√©.');
}

// ==========================================
// 11.4 ‚Ä¢ Exports : COMPLET (.txt/.zip) devis
// ==========================================
function buildFullText(){
  var grouped = groupDevis();
  var lines = ['=== DEVIS COMPLET ===\n'];
  var globalTotal = 0;

  for (var grp in grouped){
    lines.push('\n## '+grp+' ##\n');
    var groupTotal = 0;

    for (var key in grouped[grp]){
      var s = grouped[grp][key];
      if (!s || !s.items || !s.items.length) continue;

      var label = pieceDisplayLabel(key);
      var items = sortedItemsForPiece(key, s.items);
      var st = 0;
      lines.push("\n---------------- "+label+" ----------------\n");

      items.forEach(function(it){
        var q = +it.qty || 0, pu = +it.prixU || 0, t = q * pu;
        st += t; groupTotal += t; globalTotal += t;
        lines.push(itemLine(it));
      });
      if (s.note) lines.push('Note : '+s.note);
      lines.push('Total '+label+' : '+st.toFixed(2)+'‚Ç¨\n');
    }

    lines.push('Total '+grp+' : '+groupTotal.toFixed(2)+'‚Ç¨\n');
  }

  lines.push('\n=== Total global : '+globalTotal.toFixed(2)+'‚Ç¨ ===\n');
  return lines.join('\r\n');
}
function exportTextFull(){
  var name = (devis && devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildFullText()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Export .txt complet g√©n√©r√©.');
}
async function exportZipFull(){
  if (typeof JSZip === 'undefined'){ alert('JSZip non charg√©.'); return; }

  var name = (devis && devis.__name || 'Devis').trim() || 'Devis';
  var zip  = new JSZip();
  zip.file(name.replace(/\s+/g,'_').toLowerCase()+'_complet.txt', buildFullText());
  zip.file('README.txt', 'Devis complet\nNom: '+name+'\nDate: '+new Date().toLocaleString('fr-FR')+'\n');

  var blob = await zip.generateAsync({type:'blob'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_complet.zip';
  a.click(); URL.revokeObjectURL(url);

  alert('‚úÖ Export .zip complet g√©n√©r√©.');
}

// =========================================================
// 11.5 ‚Ä¢ DEVIS (TXT) : tout compris & s√©par√© P/M (c√¥t√© devis)
// =========================================================

// Petits helpers locaux
function _fmtDevTxt11(n, sym){ var s = (sym || '‚Ç¨').trim(); return (+(n||0)).toFixed(2)+' '+s; }
function _todayFR_dev11(){
  try{ return new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit'}); }
  catch(e){ return new Date().toLocaleDateString(); }
}
function _getPrefsSafe11(){ try{ return JSON.parse(localStorage.getItem('appPrefs_v1')||'null')||{}; }catch(e){ return {}; } }
function _getCompanySafe11(){ try{ return JSON.parse(localStorage.getItem('companyConfig_v1')||'null')||{}; }catch(e){ return {}; } }

// Construit une liste de blocs (groupe > pi√®ce > items) pour affichage texte
function _linesByGroup_dev11(){
  var out=[];
  var g = groupDevis();
  for (var grp in g){
    for (var key in g[grp]){
      var s = g[grp][key];
      var items = sortedItemsForPiece(key, (s&&s.items)||[]);
      out.push({ group: grp, label: pieceDisplayLabel(key), items: items });
    }
  }
  return out;
}
function _txtItemLine_dev11(it, deviseSym){
  var unit = it.unit || 'u';
  var q  = +it.qty || 0;
  var pu = +it.prixU || 0;
  var t  = q*pu;
  var left = it.intervention ? (it.intervention+' ‚Äî ') : '';
  var poseTxt = (it.intervention==='Cr√©ation' && it.pose) ? (' - '+String(it.pose).toLowerCase()) : '';
  return '- ' + left + (it.designation||'') + poseTxt + ' ('
       + q+' '+unit+' √ó '+_fmtDevTxt11(pu, deviseSym)+' = '+_fmtDevTxt11(t, deviseSym)+')';
}

// DEVIS ‚Äî tout compris (TXT)
function buildDevisText_ToutCompris(){
  var prefs   = _getPrefsSafe11();
  var company = _getCompanySafe11();
  var devise  = prefs.devise || '‚Ç¨';
  var tvaOn   = !!prefs.tva_applicable;
  var tauxTVA = Math.max(0, +prefs.taux_tva || 20);

  var lines=[];
  lines.push('================= DEVIS ‚Äî TOUT COMPRIS =================');
  lines.push('Date : '+_todayFR_dev11());
  lines.push('');

  // √âmetteur
  var rs = (company.raison_sociale || company.nom_commercial || '').trim();
  if(rs){ lines.push('√âmetteur : '+rs); }
  var adr = [company.adresse, company.code_postal, company.ville].filter(Boolean).join(' ');
  if(adr) lines.push('Adresse  : '+adr+(company.pays?(' ‚Äî '+company.pays):''));
  if(company.email) lines.push('Email    : '+company.email);
  if(company.telephone) lines.push('T√©l      : '+company.telephone);
  if(company.siren) lines.push('SIREN    : '+company.siren);
  if(company.tva_intracom) lines.push('TVA      : '+company.tva_intracom);
  lines.push('========================================================');
  lines.push('');

  // D√©tail
  var blocks = _linesByGroup_dev11();
  var totalHT = 0;
  var currentGroup = null;
  blocks.forEach(function(block){
    if(block.group && block.group!==currentGroup){
      lines.push('## '+block.group+' ##');
      currentGroup = block.group;
    }
    lines.push('---- '+block.label+' ----');
    var st=0;
    block.items.forEach(function(it){
      lines.push(_txtItemLine_dev11(it, devise));
      st += ((+it.qty||0) * (+it.prixU||0));
    });
    lines.push('Total '+block.label+' : '+_fmtDevTxt11(st, devise));
    lines.push('');
    totalHT += st;
  });

  // Totaux
  var tva = tvaOn ? (totalHT * tauxTVA/100) : 0;
  lines.push('================= R√âCAPITULATIF =================');
  lines.push('Total HT  : '+_fmtDevTxt11(totalHT, devise));
  if(tvaOn) lines.push('TVA ('+tauxTVA+'%) : '+_fmtDevTxt11(tva, devise));
  lines.push('Total TTC : '+_fmtDevTxt11(totalHT + tva, devise));
  lines.push('=================================================');
  lines.push('');

  // Mentions
  if(company.conditions_paiement) lines.push('Conditions de paiement : '+company.conditions_paiement);
  if(company.iban) lines.push('IBAN : '+company.iban+(company.bic?(' ‚Äî BIC : '+company.bic):''));
  if(company.mentions_legales){
    lines.push('');
    lines.push(company.mentions_legales);
  }
  return lines.join('\r\n');
}

// DEVIS ‚Äî s√©par√© Prestations / Mat√©riel (TXT)
function buildDevisText_Separe(matPct){
  var prefs   = _getPrefsSafe11();
  var company = _getCompanySafe11();
  var devise  = prefs.devise || '‚Ç¨';
  var tvaOn   = !!prefs.tva_applicable;
  var tauxTVA = Math.max(0, +prefs.taux_tva || 20);

  var matRatio   = Math.min(100, Math.max(0, parseFloat(matPct||40))) / 100;
  var prestRatio = 1 - matRatio;

  var lines=[];
  lines.push('============ DEVIS ‚Äî S√âPAR√â PRESTATIONS / MAT√âRIEL ============');
  lines.push('Date : '+_todayFR_dev11());
  lines.push('');

  // √âmetteur
  var rs = (company.raison_sociale || company.nom_commercial || '').trim();
  if(rs){ lines.push('√âmetteur : '+rs); }
  var adr = [company.adresse, company.code_postal, company.ville].filter(Boolean).join(' ');
  if(adr) lines.push('Adresse  : '+adr+(company.pays?(' ‚Äî '+company.pays):''));
  if(company.email) lines.push('Email    : '+company.email);
  if(company.telephone) lines.push('T√©l      : '+company.telephone);
  if(company.siren) lines.push('SIREN    : '+company.siren);
  if(company.tva_intracom) lines.push('TVA      : '+company.tva_intracom);
  lines.push('===============================================================');
  lines.push('');

  // D√©tail identique √† "tout compris"
  var blocks = _linesByGroup_dev11();
  var totalHT = 0;
  var currentGroup = null;
  blocks.forEach(function(block){
    if(block.group && block.group!==currentGroup){
      lines.push('## '+block.group+' ##');
      currentGroup = block.group;
    }
    lines.push('---- '+block.label+' ----');
    var st=0;
    block.items.forEach(function(it){
      lines.push(_txtItemLine_dev11(it, devise));
      st += ((+it.qty||0) * (+it.prixU||0));
    });
    lines.push('Total '+block.label+' : '+_fmtDevTxt11(st, devise));
    lines.push('');
    totalHT += st;
  });

  // Split global
  var totalMatHT   = totalHT * matRatio;
  var totalPrestHT = totalHT * prestRatio;

  var tvaPrest = tvaOn ? (totalPrestHT * tauxTVA/100) : 0;
  var tvaMat   = tvaOn ? (totalMatHT   * tauxTVA/100) : 0;

  lines.push('================= R√âCAPITULATIF =================');
  lines.push('Hypoth√®se s√©paration : Mat√©riel = '+Math.round(matRatio*100)+'% | Prestations = '+Math.round(prestRatio*100)+'%');
  lines.push('');
  lines.push('--- PRESTATIONS ---');
  lines.push('HT  : '+_fmtDevTxt11(totalPrestHT, devise));
  if(tvaOn) lines.push('TVA : '+_fmtDevTxt11(tvaPrest, devise));
  lines.push('');
  lines.push('--- MAT√âRIEL ---');
  lines.push('HT  : '+_fmtDevTxt11(totalMatHT, devise));
  if(tvaOn) lines.push('TVA : '+_fmtDevTxt11(tvaMat, devise));
  lines.push('');
  lines.push('Total HT  : '+_fmtDevTxt11(totalHT, devise));
  if(tvaOn) lines.push('Total TVA : '+_fmtDevTxt11(tvaPrest + tvaMat, devise));
  lines.push('Total TTC : '+_fmtDevTxt11(totalHT + (tvaPrest + tvaMat), devise));
  lines.push('=================================================');
  lines.push('');

  // Mentions
  if(company.conditions_paiement) lines.push('Conditions de paiement : '+company.conditions_paiement);
  if(company.iban) lines.push('IBAN : '+company.iban+(company.bic?(' ‚Äî BIC : '+company.bic):''));
  if(company.mentions_legales){
    lines.push('');
    lines.push(company.mentions_legales);
  }
  return lines.join('\r\n');
}

// Exports .TXT (devis)
function exportDevisToutComprisTXT(){
  var name = (devis && devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildDevisText_ToutCompris()], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_devis_tout_compris.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Devis (tout compris) export√©.');
}
function exportDevisSepareTXT(){
  var pct = prompt('Pourcentage MAT√âRIEL (0‚Äì100) ?', '40');
  if(pct==null) return; // annul√©
  var name = (devis && devis.__name || 'Devis').trim() || 'Devis';
  var blob = new Blob([buildDevisText_Separe(pct)], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = name.replace(/\s+/g,'_').toLowerCase()+'_devis_separe.txt';
  a.click(); URL.revokeObjectURL(url);
  alert('‚úÖ Devis (s√©par√©) export√©.');
}

// =============================
// 11.6 ‚Ä¢ Expose (exports)
// =============================
Object.assign(window, {
  // Exports estimatif (par groupes & complet)
  exportText, exportZipGroups, exportTextFull, exportZipFull,
  // Devis TXT
  buildDevisText_ToutCompris, buildDevisText_Separe, exportDevisToutComprisTXT, exportDevisSepareTXT
});
</script>
















<!-- =============================
     CHAPITRE 12 (V3) : CONFIG ENTREPRISE & PR√âF√âRENCES
     Index :
       12.0 ‚Ä¢ Cl√©s & helpers de stockage (localStorage)
       12.1 ‚Ä¢ UI ‚Äî Configuration entreprise (coordonn√©es, assurances, logo)
       12.2 ‚Ä¢ UI ‚Äî Pr√©f√©rences (facturation, devise, TVA, num√©rotation)
       12.3 ‚Ä¢ Expose (window)
     ============================= -->

<style>
  /* ====== Styles Chapitre 12 ====== */
  .cfg-wrap .card{ margin-bottom:24px; }
  .cfg-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .cfg-grid .field{ border:1px solid var(--line, #ddd); background:#fff; border-radius:10px; padding:10px; }
  .cfg-grid .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .cfg-actions{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; }
  .cfg-note{ color:var(--muted, #666); font-size:14px; }

  /* Logo */
  .cfg-logo-block{ display:grid; grid-template-columns:1fr; gap:10px; }
  .cfg-logo-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .cfg-logo img{ max-height:64px; border:1px solid var(--line, #ddd); border-radius:8px; background:#fff; padding:4px; }
  .dropzone{
    border:2px dashed var(--line, #ddd); border-radius:10px; padding:12px; background:#fafafa;
    text-align:center; color:#444;
  }
  .dropzone.drag{ border-color:#4caf50; background:#f0fff4; }
  .alert-ok{
    border:1px solid #c8e6c9; background:#e8f5e9; color:#256029;
    padding:8px 10px; border-radius:8px; font-size:14px;
  }

  /* Bouton g√©n√©rique si l‚Äôapp n‚Äôa pas b() */
  .btn{ cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:8px; padding:8px 12px; }
  .btn.primary{ background:#0d6efd; border-color:#0d6efd; color:#fff; }
  .btn.back{ background:#f3f3f3; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
</style>

<script>
/* =========================================================
   S√©curit√©s : helpers b() & view() si non fournis par l'app
   ========================================================= */
if(typeof window.b!=='function'){
  window.b=function(txt,fn,cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>'; };
}
if(typeof window.view!=='function'){
  window.view=function(html){ var app=document.getElementById('app'); if(app) app.innerHTML=html; };
}

/* ================================
   12.0 ‚Ä¢ Stockage & helpers
   ================================ */
const KEY_COMPANY = 'companyConfig_v1';
const KEY_PREFS   = 'appPrefs_v1';

function readJsonLS(key, def){ try{ return JSON.parse(localStorage.getItem(key)||'null') ?? def; }catch(e){ return def; } }
function writeJsonLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

/* ‚Äî Config entreprise ‚Äî */
function getCompany(){
  return readJsonLS(KEY_COMPANY, {
    // Identit√©
    raison_sociale: '', nom_commercial: '',
    siren: '', tva_intracom: '',
    adresse: '', code_postal: '', ville: '', pays: 'France',
    email: '', telephone: '', site: '',
    // Assurance / mentions
    rc_pro: '', decennale: '', assureur: '',
    iban: '', bic: '', conditions_paiement: 'Virement bancaire √† 30 jours.',
    mentions_legales: '',
    // Logo (dataURL)
    logo_dataurl: '',
    logo_meta: { name:'', size:0, width:0, height:0, loaded_at:'' }
  });
}
function setCompany(obj){ writeJsonLS(KEY_COMPANY, obj||{}); }

/* ‚Äî Pr√©f√©rences ‚Äî */
function getPrefs(){
  return readJsonLS(KEY_PREFS, {
    facturation_mode: 'tout_compris', // 'tout_compris' | 'separe'
    devise: '‚Ç¨',
    tva_applicable: false,  // si vrai : application du taux ci-dessous
    taux_tva: 20,           // %
    numerotation_prefix: 'DEV-',
    numerotation_fact_prefix: 'FAC-',
    numerotation_courante: 1
  });
}
function setPrefs(obj){ writeJsonLS(KEY_PREFS, obj||{}); }

/* Fichier ‚Üí dataURL + meta (nom/taille + dimensions) */
function fileToDataURLWithMeta(file, cb, errCb){
  try{
    const rd = new FileReader();
    rd.onload = function(){
      const dataUrl = rd.result || '';
      const img = new Image();
      img.onload = function(){
        cb({
          dataUrl,
          meta: {
            name: file.name || '',
            size: file.size || 0,
            width: img.naturalWidth||img.width||0,
            height: img.naturalHeight||img.height||0,
            loaded_at: new Date().toISOString()
          }
        });
      };
      img.onerror = function(){ (errCb||alert)('Impossible de lire l‚Äôimage.'); };
      img.src = dataUrl;
    };
    rd.onerror = function(){ (errCb||alert)('Lecture du fichier √©chou√©e.'); };
    rd.readAsDataURL(file);
  }catch(e){ (errCb||alert)('S√©lection d‚Äôimage impossible : '+e.message); }
}
function pickImageFile(cb){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = function(){ const f=input.files&&input.files[0]; if(f) cb(f); };
  input.click();
}

/* ============================================
   12.1 ‚Ä¢ UI ‚Äî Configuration entreprise
   ============================================ */
function pageConfigEntreprise(notice){
  const cfg = getCompany();

  function f(label, id, val, placeholder){
    return '<div class="field"><label for="'+id+'">'+label+'</label>'
         + '<input id="'+id+'" value="'+(val?String(val).replace(/"/g,'&quot;'):'')+'" placeholder="'+(placeholder||'')+'"/></div>';
  }
  function ta(label, id, val, placeholder){
    return '<div class="field"><label for="'+id+'">'+label+'</label>'
         + '<textarea id="'+id+'" rows="5" placeholder="'+(placeholder||'')+'">'+(val||'')+'</textarea></div>';
  }

  const hasLogo = !!cfg.logo_dataurl;
  const meta = cfg.logo_meta || {};
  const metaTxt = hasLogo
    ? ('<div class="cfg-note">Fichier: <strong>'+ (meta.name||'') +
       '</strong> ‚Äî '+(Math.round((meta.size||0)/102.4)/10)+' Ko ‚Äî '+
       (meta.width||'?')+'√ó'+(meta.height||'?')+' px</div>')
    : '<div class="cfg-note">Aucun logo</div>';

  const banner = notice ? '<div class="alert-ok">'+notice+'</div>' : '';

  const logoHtml =
    '<div class="field">'
      + '<label>Logo</label>'
      + '<div class="cfg-logo-block">'
        + banner
        + '<div class="cfg-logo-row cfg-logo">'
            + (hasLogo ? ('<img id="cfg-logo-preview" src="'+cfg.logo_dataurl+'" alt="Logo"/>') : '')
            + metaTxt
        + '</div>'
        + '<div class="cfg-logo-row">'
            + b('Choisir une image','cfgPickLogoUI()','btn')
            + (hasLogo ? b('Aper√ßu plein','cfgOpenLogoFull()','btn') : '')
            + (hasLogo ? b('Retirer','cfgRemoveLogo()','btn') : '')
        + '</div>'
        + '<div id="dropzone" class="dropzone">Glissez-d√©posez votre logo ici (PNG/JPG recommand√©)</div>'
        + '<div class="cfg-note">Le logo sera exploitable par vos exports (PDF plus tard, TXT/CSV pour l‚Äôen-t√™te).</div>'
      + '</div>'
    + '</div>';

  view(
    '<div class="cfg-wrap">'
      + '<div class="card">'
        + b('Retour','(typeof pageMain==="function"?pageMain():history.back())','btn back')
        + '<h2>Configuration entreprise</h2>'
        + '<p class="cfg-note">Renseignez vos coordonn√©es, assurances et mentions l√©gales. Ces informations sont r√©utilis√©es dans les exports (devis/factures texte, CSV, etc.).</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Identit√© & coordonn√©es</h3>'
        + '<div class="cfg-grid">'
          + f('Raison sociale','ce_rs', cfg.raison_sociale, 'Ex : SARL Dupont √âlectricit√©')
          + f('Nom commercial','ce_nc', cfg.nom_commercial, 'Ex : Dupont √âlec')
          + f('SIREN','ce_siren', cfg.siren, 'Ex : 123 456 789')
          + f('N¬∞ TVA intracom','ce_tva', cfg.tva_intracom, 'Ex : FRXX999999999')
          + f('Adresse','ce_addr', cfg.adresse, 'Rue et n¬∞')
          + f('Code postal','ce_cp', cfg.code_postal, '75000')
          + f('Ville','ce_ville', cfg.ville, 'Paris')
          + f('Pays','ce_pays', cfg.pays || 'France', 'France')
          + f('Email','ce_mail', cfg.email, 'contact@exemple.fr')
          + f('T√©l√©phone','ce_tel', cfg.telephone, '+33 6 12 34 56 78')
          + f('Site web','ce_web', cfg.site, 'https://‚Ä¶')
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Assurances & RIB</h3>'
        + '<div class="cfg-grid">'
          + f('RC Pro (n¬∞)','ce_rc', cfg.rc_pro, '')
          + f('D√©cennale (n¬∞)','ce_dec', cfg.decennale, '')
          + f('Assureur','ce_ass', cfg.assureur, '')
          + f('IBAN','ce_iban', cfg.iban, '')
          + f('BIC','ce_bic', cfg.bic, '')
        + '</div>'
        + ta('Conditions de paiement','ce_cond', cfg.conditions_paiement, 'Ex : Virement sous 30 jours‚Ä¶')
        + ta('Mentions l√©gales (pied de page)','ce_mentions', cfg.mentions_legales, 'Textes libres‚Ä¶')
      + '</div>'

      + '<div class="card">'
        + '<h3>Logo</h3>'
        + logoHtml
      + '</div>'

      + '<div class="cfg-actions">'
        + b('üíæ Enregistrer','saveConfigEntreprise()','btn primary')
        + b('‚¨ÖÔ∏è Accueil','(typeof pageMain==="function"?pageMain():history.back())','btn')
      + '</div>'
    + '</div>'
  );

  // Handlers inline (√©vite les fuites globales)
  window.cfgPickLogoUI = function(){
    pickImageFile(function(file){
      fileToDataURLWithMeta(file, function(res){
        const c = getCompany();
        c.logo_dataurl = res.dataUrl;
        c.logo_meta = res.meta;
        setCompany(c);
        pageConfigEntreprise('Logo charg√© ‚úÖ ('+res.meta.width+'√ó'+res.meta.height+' px)');
      });
    });
  };
  window.cfgRemoveLogo = function(){
    const c = getCompany(); c.logo_dataurl = ''; c.logo_meta = {name:'',size:0,width:0,height:0,loaded_at:''};
    setCompany(c); pageConfigEntreprise('Logo supprim√©.');
  };
  window.cfgOpenLogoFull = function(){
    const c = getCompany(); if(!c.logo_dataurl) return;
    const w = window.open(); if(!w) return;
    w.document.write('<img src="'+c.logo_dataurl+'" style="max-width:100%;height:auto" alt="Logo" />');
  };

  // Drag & drop
  (function setupDrop(){
    const dz = document.getElementById('dropzone');
    if(!dz) return;
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('drag'); }));
    dz.addEventListener('drop', function(e){
      const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
      if(!f) return;
      if(!/^image\//i.test(f.type||'')){ alert('Merci de d√©poser une image (PNG/JPG).'); return; }
      fileToDataURLWithMeta(f, function(res){
        const c = getCompany();
        c.logo_dataurl = res.dataUrl;
        c.logo_meta = res.meta;
        setCompany(c);
        pageConfigEntreprise('Logo charg√© ‚úÖ ('+res.meta.width+'√ó'+res.meta.height+' px)');
      });
    });
  })();
}

function saveConfigEntreprise(){
  const cfg = getCompany();
  function gv(id){ const el=document.getElementById(id); return el?el.value.trim():''; }
  Object.assign(cfg, {
    raison_sociale: gv('ce_rs'),
    nom_commercial: gv('ce_nc'),
    siren: gv('ce_siren'),
    tva_intracom: gv('ce_tva'),
    adresse: gv('ce_addr'),
    code_postal: gv('ce_cp'),
    ville: gv('ce_ville'),
    pays: gv('ce_pays'),
    email: gv('ce_mail'),
    telephone: gv('ce_tel'),
    site: gv('ce_web'),
    rc_pro: gv('ce_rc'),
    decennale: gv('ce_dec'),
    assureur: gv('ce_ass'),
    iban: gv('ce_iban'),
    bic: gv('ce_bic'),
    conditions_paiement: gv('ce_cond'),
    mentions_legales: gv('ce_mentions')
  });
  setCompany(cfg);
  alert('‚úÖ Configuration entreprise enregistr√©e.');
}

/* ============================================
   12.2 ‚Ä¢ UI ‚Äî Pr√©f√©rences g√©n√©rales
   ============================================ */
function pagePreferences(){
  const p = getPrefs();
  const radio = (name, val, cur, label) =>
    '<label class="btn" style="display:inline-flex;align-items:center;gap:6px;">'
    + '<input type="radio" name="'+name+'" value="'+val+'" '+(cur===val?'checked':'')+'> '
    + label + '</label>';

  view(
    '<div class="cfg-wrap">'
      + '<div class="card">'
        + b('Retour','(typeof pageMain==="function"?pageMain():history.back())','btn back')
        + '<h2>Pr√©f√©rences g√©n√©rales</h2>'
        + '<p class="cfg-note">Ces r√©glages influencent la pr√©sentation des exports (devis/factures) et la logique de TVA.</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Mode de facturation</h3>'
        + '<div class="row">'
          + radio('pf_fmode','tout_compris', p.facturation_mode, 'Tarifs ¬´ fournitures + pose ¬ª (tout compris)')
          + radio('pf_fmode','separe', p.facturation_mode, 'S√©parer prestations et mat√©riel')
        + '</div>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Devise & TVA</h3>'
        + '<div class="cfg-grid">'
          + '<div class="field">'
            + '<label>Devise</label>'
            + '<input id="pf_dev" value="'+(p.devise||'‚Ç¨')+'" placeholder="‚Ç¨"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>TVA applicable</label>'
            + '<select id="pf_tva_on"><option value="no" '+(!p.tva_applicable?'selected':'')+'>Non (Micro)</option><option value="yes" '+(p.tva_applicable?'selected':'')+'>Oui (R√©gime r√©el)</option></select>'
          + '</div>'
          + '<div class="field">'
            + '<label>Taux de TVA (%)</label>'
            + '<input id="pf_tva" type="number" inputmode="decimal" min="0" max="100" step="0.1" value="'+(+p.taux_tva||20)+'"/>'
          + '</div>'
        + '</div>'
        + '<p class="cfg-note">Le devis peut surcharger la TVA (ex : chantier √† 10%). Les exports utilisent d‚Äôabord la TVA du document courant.</p>'
      + '</div>'

      + '<div class="card">'
        + '<h3>Num√©rotation</h3>'
        + '<div class="cfg-grid">'
          + '<div class="field">'
            + '<label>Pr√©fixe num√©rotation devis</label>'
            + '<input id="pf_pref_dev" value="'+(p.numerotation_prefix||'DEV-')+'"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>Pr√©fixe num√©rotation facture</label>'
            + '<input id="pf_pref_fac" value="'+(p.numerotation_fact_prefix||'FAC-')+'"/>'
          + '</div>'
          + '<div class="field">'
            + '<label>Compteur courant</label>'
            + '<input id="pf_counter" type="number" inputmode="numeric" min="1" value="'+(+p.numerotation_courante||1)+'"/>'
            + '<div class="cfg-note">Servira pour g√©n√©rer DEV-0001, FAC-0001, etc. (incr√©ment √† l‚Äôexport).</div>'
          + '</div>'
        + '</div>'
      + '</div>'

      + '<div class="cfg-actions">'
        + b('üíæ Enregistrer','savePreferences()','btn primary')
        + b('‚¨ÖÔ∏è Accueil','(typeof pageMain==="function"?pageMain():history.back())','btn')
      + '</div>'
    + '</div>'
  );
}

function savePreferences(){
  const cur = getPrefs();
  function gv(id){ const el=document.getElementById(id); return el?el.value:''; }
  function gi(name){ const el=document.querySelector('input[name="'+name+'"]:checked'); return el?el.value:cur[name]; }
  const tvay = (gv('pf_tva_on')==='yes');

  const out = Object.assign({}, cur, {
    facturation_mode: gi('pf_fmode') || cur.facturation_mode,
    devise: (gv('pf_dev') || cur.devise || '‚Ç¨').trim() || '‚Ç¨',
    tva_applicable: tvay,
    taux_tva: Math.max(0, parseFloat(gv('pf_tva'))||cur.taux_tva||20),
    numerotation_prefix: gv('pf_pref_dev') || cur.numerotation_prefix || 'DEV-',
    numerotation_fact_prefix: gv('pf_pref_fac') || cur.numerotation_fact_prefix || 'FAC-',
    numerotation_courante: Math.max(1, parseInt(gv('pf_counter'),10)||cur.numerotation_courante||1)
  });
  setPrefs(out);
  alert('‚úÖ Pr√©f√©rences enregistr√©es.');
}

/* =========================
   12.3 ‚Ä¢ Expose (window)
   ========================= */
Object.assign(window, {
  // acc√®s lecture/√©criture
  getCompany, setCompany, getPrefs, setPrefs,
  // pages
  pageConfigEntreprise, pagePreferences,
  // actions
  saveConfigEntreprise, savePreferences
});
</script>

















<!-- =============================
     CHAPITRE 13 (V3) : CATALOGUE PRESTATIONS / MAT√âRIEL & TARIFS C√îT√â CATALOGUE
     Index :
       13.0 ‚Ä¢ Styles & garde-fous
       13.1 ‚Ä¢ Stockage & structures (prestations, coefficients, mat√©riel)
       13.2 ‚Ä¢ Helpers (merge, UI, IO)
       13.3 ‚Ä¢ Catalogue PRESTATIONS (ajout/suppression + tarifs par intervention)
       13.4 ‚Ä¢ TARIFS & COEFFICIENTS (pose, sections, overrides cibl√©s)
       13.5 ‚Ä¢ Catalogue MAT√âRIEL (marques ‚Üí gammes ‚Üí prix)
       13.6 ‚Ä¢ Import / Export / Reset (3 sous-domaines)
       13.7 ‚Ä¢ Accueil(s) de ce chapitre
       13.8 ‚Ä¢ Expose (window)
     ============================= -->

<style>
  /* ====== Styles Chapitre 13 ====== */
  .cat-wrap .card{ margin-bottom:24px; }
  .grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
  .field{ border:1px solid var(--line, #ddd); background:#fff; border-radius:10px; padding:10px; }
  .field label{ display:block; font-weight:600; margin-bottom:6px; }
  .muted{ color:var(--muted, #666); }
  .row.gap8{ display:flex; gap:8px; flex-wrap:wrap; }
  .table-mini{ width:100%; border-collapse:collapse; font-size:14px; }
  .table-mini th, .table-mini td{ border:1px solid var(--line, #ddd); padding:6px 8px; text-align:left; vertical-align:middle; }
  .table-mini th{ background:#fafafa; }
  .type-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .pill.small{ padding:6px 10px; font-size:14px; }
  .note{ font-size:13px; color:#555; }
  .hr{ border-top:1px solid var(--line, #ddd); margin:12px 0; }
  .btn{ cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:8px; padding:8px 12px; }
  .btn.primary{ background:#0d6efd; border-color:#0d6efd; color:#fff; }
  .btn.back{ background:#f3f3f3; }
</style>

<script>
/* =============================
   13.0 ‚Ä¢ Garde-fous (host app)
   ============================= */
/* Helpers de l‚Äôapp suppos√©s : b(), view() */
if(typeof window.b!=='function'){
  window.b=function(txt,fn,cls){ return '<button class="'+(cls||'btn')+'" onclick="'+fn+'">'+txt+'</button>'; };
}
if(typeof window.view!=='function'){
  window.view=function(html){ var app=document.getElementById('app'); if(app) app.innerHTML=html; };
}

/* Tronc de donn√©es attendu par l‚Äôapp (non bloquant si d√©j√† d√©fini) */
window.TARIFS_BASE  = window.TARIFS_BASE  || { prises:{}, eclairage:{}, circuit_specialise:{}, circuit_specialise_base:{} };
window.COEFF_POSE   = window.COEFF_POSE   || { 'Placo':1, 'Encastr√© ma√ßonnerie':1.3, 'Semi-encastr√©':1.15, 'Sur-mesure':1.6, 'Saillie avec moulure':1.1, 'Sous tube IRL':1.2 };
window.COEFF_SECTIONS_CS = window.COEFF_SECTIONS_CS || { '0,75 mm¬≤':0.9, '1,5 mm¬≤':1, '2,5 mm¬≤':1.15, '6 mm¬≤':1.6 };
window.DESIGNATIONS_PAR_CATEGORIE = window.DESIGNATIONS_PAR_CATEGORIE || {
  'Prises': ['Prise 2P+T'],
  '√âclairage/Luminaires': ['Point de centre','Applique'],
  '√âclairage/Commandes': ['Interrupteur simple','Interrupteur double'],
  'Circuit sp√©cialis√©': ['Four','Plaque de cuisson'],
  'Tableau': ['Inter diff 30mA','Disjoncteur'],
  'Ventilation': ['Kit VMC','Extracteur'],
  'Mise √† la terre': ['Prise de terre','Barre de terre']
};

/* ==================================
   13.1 ‚Ä¢ Stockage & structures cl√©s
   ================================== */
const KEY_CAT_PRESTATIONS = 'cat_prestations_v1';
const KEY_TARIFS_COEFFS   = 'cat_tarifs_coeffs_v1';
const KEY_CAT_MATERIEL    = 'cat_materiel_v1';

/* ‚Äî PRESTATIONS
   Structure : {
     familles: {
       'Prises': [
         { nom:'Prise 2P+T', tarifs:{ 'Cr√©ation':90, 'Remplacement appareillage':25, 'Rec√¢blage avec remplacement appareillage':45, 'Rec√¢blage sans remplacement appareillage':30 } },
         ...
       ],
       '√âclairage/Luminaires': [ { nom:'Point de centre', tarifs:{ 'Cr√©ation':110, ... } }, ... ],
       ...
     }
   }
*/
function _defaultCatPrestations(){
  return {
    familles: {
      'Prises': [
        { nom:'Prise 2P+T', tarifs:{ 'Cr√©ation':90, 'Remplacement appareillage':25, 'Rec√¢blage avec remplacement appareillage':45, 'Rec√¢blage sans remplacement appareillage':30 } }
      ],
      '√âclairage/Luminaires': [
        { nom:'Point de centre', tarifs:{ 'Cr√©ation':110, 'Remplacement luminaire':35, 'Rec√¢blage avec remplacement luminaire':55, 'Rec√¢blage sans remplacement luminaire':40 } },
        { nom:'Applique',        tarifs:{ 'Cr√©ation':95,  'Remplacement luminaire':30, 'Rec√¢blage avec remplacement luminaire':50, 'Rec√¢blage sans remplacement luminaire':35 } }
      ],
      '√âclairage/Commandes': [
        { nom:'Interrupteur simple', tarifs:{ 'Cr√©ation':65, 'Remplacement appareillage':25, 'Rec√¢blage avec remplacement appareillage':40, 'Rec√¢blage sans remplacement appareillage':28 } },
        { nom:'Interrupteur double', tarifs:{ 'Cr√©ation':80, 'Remplacement appareillage':30, 'Rec√¢blage avec remplacement appareillage':48, 'Rec√¢blage sans remplacement appareillage':34 } }
      ],
      'Circuit sp√©cialis√©': [
        { nom:'Four',              tarifs:{ 'Cr√©ation':140, 'Remplacement appareillage':35, 'Rec√¢blage avec remplacement appareillage':55, 'Rec√¢blage sans remplacement appareillage':40 } },
        { nom:'Plaque de cuisson', tarifs:{ 'Cr√©ation':155, 'Remplacement appareillage':35, 'Rec√¢blage avec remplacement appareillage':60, 'Rec√¢blage sans remplacement appareillage':42 } }
      ],
      'Tableau': [
        { nom:'Inter diff 30mA', tarifs:{ 'Cr√©ation':120 } },
        { nom:'Disjoncteur',     tarifs:{ 'Cr√©ation':18 } }
      ],
      'Ventilation': [
        { nom:'Kit VMC',      tarifs:{ 'Cr√©ation':380 } },
        { nom:'Extracteur',   tarifs:{ 'Cr√©ation':140 } }
      ],
      'Mise √† la terre': [
        { nom:'Prise de terre', tarifs:{ 'Cr√©ation':220 } },
        { nom:'Barre de terre', tarifs:{ 'Cr√©ation':90 } }
      ]
    }
  };
}
function getCatPrestations(){ try{ return JSON.parse(localStorage.getItem(KEY_CAT_PRESTATIONS)||'null') || _defaultCatPrestations(); }catch(e){ return _defaultCatPrestations(); } }
function setCatPrestations(obj){ try{ localStorage.setItem(KEY_CAT_PRESTATIONS, JSON.stringify(obj||_defaultCatPrestations())); }catch(e){} }

/* ‚Äî TARIFS & COEFFS (pose, sections, overrides base) */
function _defaultTarifsCoeffs(){
  return {
    coeff_pose: Object.assign({}, COEFF_POSE),
    coeff_sections_cs: Object.assign({}, COEFF_SECTIONS_CS),
    // Overrides optionnels par famille/type/intervention (ex: {'Prises': {'Prise 2P+T': {'Cr√©ation':95}}})
    overrides: {}
  };
}
function getTarifsCoeffs(){ try{ return JSON.parse(localStorage.getItem(KEY_TARIFS_COEFFS)||'null') || _defaultTarifsCoeffs(); }catch(e){ return _defaultTarifsCoeffs(); } }
function setTarifsCoeffs(obj){ try{ localStorage.setItem(KEY_TARIFS_COEFFS, JSON.stringify(obj||_defaultTarifsCoeffs())); }catch(e){} }

/* ‚Äî MAT√âRIEL (Marques ‚Üí Gammes ‚Üí Tarifs unitaires) */
function _defaultCatMateriel(){
  return {
    familles: {
      'Appareillage': {
        'Schneider': {
          'Odace': { 'Interrupteur simple': 14, 'Prise 2P+T': 11 },
          'Mureva': { 'Interrupteur simple': 18, 'Prise 2P+T': 16 }
        },
        'Legrand': {
          'C√©liane': { 'Interrupteur simple': 16, 'Prise 2P+T': 13 }
        }
      },
      'Tableau': {
        'Schneider': {
          'Resi9': { 'Disjoncteur 16A': 9.5, 'Inter diff 30mA AC': 58 }
        },
        'Hager': {
          'Volta': { 'Disjoncteur 16A': 9.2, 'Inter diff 30mA AC': 55 }
        }
      }
    }
  };
}
function getCatMateriel(){ try{ return JSON.parse(localStorage.getItem(KEY_CAT_MATERIEL)||'null') || _defaultCatMateriel(); }catch(e){ return _defaultCatMateriel(); } }
function setCatMateriel(obj){ try{ localStorage.setItem(KEY_CAT_MATERIEL, JSON.stringify(obj||_defaultCatMateriel())); }catch(e){} }

/* =========================
   13.2 ‚Ä¢ Helpers communs
   ========================= */
function _clone13(x){ return JSON.parse(JSON.stringify(x)); }
function _ensureNum13(n){ return Math.max(0, +n || 0); }
function _esc13(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]); }
function _mergeLeafOverride(base, add){
  if(!add || typeof add!=='object') return;
  Object.keys(add).forEach(k=>{
    const v=add[k];
    if(v && typeof v==='object' && !Array.isArray(v)){
      if(!base[k] || typeof base[k]!=='object') base[k]={};
      _mergeLeafOverride(base[k], v);
    }else{
      base[k]=v;
    }
  });
}

/* Applique PRESTATIONS + TARIFS/COEFFS au runtime de l‚Äôapp */
function applyPrestationsToApp(){
  const cat = getCatPrestations();
  // 1) D√©signations visibles dans l‚Äôapp
  Object.keys(cat.familles).forEach(fam=>{
    window.DESIGNATIONS_PAR_CATEGORIE[fam] = window.DESIGNATIONS_PAR_CATEGORIE[fam] || [];
    cat.familles[fam].forEach(item=>{
      if(window.DESIGNATIONS_PAR_CATEGORIE[fam].indexOf(item.nom)===-1){
        window.DESIGNATIONS_PAR_CATEGORIE[fam].push(item.nom);
      }
    });
  });

  // 2) TARIFS_BASE : fusionner/ajouter
  window.TARIFS_BASE.prises = window.TARIFS_BASE.prises || {};
  window.TARIFS_BASE.eclairage = window.TARIFS_BASE.eclairage || {};
  window.TARIFS_BASE.circuit_specialise = window.TARIFS_BASE.circuit_specialise || {};

  Object.keys(cat.familles).forEach(fam=>{
    (cat.familles[fam]||[]).forEach(it=>{
      if(fam==='Prises'){
        TARIFS_BASE.prises[it.nom] = TARIFS_BASE.prises[it.nom] || {};
        _mergeLeafOverride(TARIFS_BASE.prises[it.nom], it.tarifs||{});
      } else if(fam==='√âclairage/Luminaires' || fam==='√âclairage/Commandes'){
        TARIFS_BASE.eclairage[it.nom] = TARIFS_BASE.eclairage[it.nom] || {};
        _mergeLeafOverride(TARIFS_BASE.eclairage[it.nom], it.tarifs||{});
      } else if(fam==='Circuit sp√©cialis√©'){
        TARIFS_BASE.circuit_specialise[it.nom] = TARIFS_BASE.circuit_specialise[it.nom] || {};
        _mergeLeafOverride(TARIFS_BASE.circuit_specialise[it.nom], it.tarifs||{});
      } else {
        // autres familles sous un tronc d√©di√©
        TARIFS_BASE[fam] = TARIFS_BASE[fam] || {};
        TARIFS_BASE[fam][it.nom] = TARIFS_BASE[fam][it.nom] || {};
        _mergeLeafOverride(TARIFS_BASE[fam][it.nom], it.tarifs||{});
      }
    });
  });

  // 3) COEFFICIENTS (depuis storage)
  const tc = getTarifsCoeffs();
  _mergeLeafOverride(COEFF_POSE, tc.coeff_pose||{});
  _mergeLeafOverride(COEFF_SECTIONS_CS, tc.coeff_sections_cs||{});

  // 4) Overrides chiffr√©s (cibl√©s)
  if(tc.overrides && typeof tc.overrides==='object'){
    Object.keys(tc.overrides).forEach(fam=>{
      const bloc = tc.overrides[fam]||{};
      if(!TARIFS_BASE[fam]) TARIFS_BASE[fam]={};
      Object.keys(bloc).forEach(des=>{
        TARIFS_BASE[fam][des] = TARIFS_BASE[fam][des] || {};
        _mergeLeafOverride(TARIFS_BASE[fam][des], bloc[des]);
      });
    });
  }
}

/* ================================
   13.3 ‚Ä¢ CATALOGUE PRESTATIONS
   ================================ */
function pageCataloguePrestations(){
  const cat = getCatPrestations();
  const familles = Object.keys(cat.familles);

  function blockFamille(fam){
    const arr = cat.familles[fam] || [];
    const rows = arr.map((t,idx)=>{
      const pfx = fam+'__'+idx;
      const KEYS_APP = (fam==='√âclairage/Luminaires')
        ? ["Cr√©ation","Remplacement luminaire","Rec√¢blage avec remplacement luminaire","Rec√¢blage sans remplacement luminaire"]
        : (fam==='Prises' || fam==='√âclairage/Commandes' || fam==='Circuit sp√©cialis√©'
            ? ["Cr√©ation","Remplacement appareillage","Rec√¢blage avec remplacement appareillage","Rec√¢blage sans remplacement appareillage"]
            : ["Cr√©ation"]);
      const inputs = KEYS_APP.map(k=>{
        const id = (pfx+'__'+k).replace(/\s+/g,'_');
        const val = +(t.tarifs?.[k]||0);
        return '<div class="field"><label>'+_esc13(k)+'</label><input id="'+id+'" type="number" step="1" inputmode="decimal" value="'+val+'"/></div>';
      }).join('');
      return `
        <div class="card">
          <div class="type-head">
            <h3>${_esc13(t.nom)}</h3>
            <div class="row gap8">
              ${b('Supprimer','catPrestDel("'+fam+'",'+idx+')','btn')}
              ${b('üíæ Enregistrer','catPrestSave("'+fam+'",'+idx+')','btn primary')}
            </div>
          </div>
          <div class="grid">${inputs}</div>
        </div>`;
    }).join('');

    return `
      <div class="card">
        <h2>${_esc13(fam)}</h2>
        ${rows || '<p class="muted">Aucune prestation d√©finie.</p>'}
        <div class="hr"></div>
        <div class="row gap8">
          <input id="add-${_esc13(fam)}" placeholder="Nouvelle prestation‚Ä¶" />
          ${b('Ajouter','catPrestAdd("'+fam+'")','btn')}
        </div>
      </div>`;
  }

  view(
    '<div class="cat-wrap">'
    + '<div class="card">'
      + b('Retour','(typeof pageMain==="function"?pageMain():history.back())','btn back')
      + '<h2>Configuration catalogue prestations</h2>'
      + '<p class="muted">Ajoutez/supprimez des prestations et ajustez leurs tarifs d‚Äôintervention. Toute modification est appliqu√©e imm√©diatement √† l‚Äôapplication.</p>'
      + '<div class="row gap8">'
        + b('‚¨áÔ∏è Export JSON','catPrestExport()','btn')
        + b('‚¨ÜÔ∏è Import JSON','catPrestImport()','btn')
        + b('üßπ R√©initialiser','catPrestReset()','btn')
      + '</div>'
    + '</div>'
    + (familles.length ? familles.map(blockFamille).join('') : '<div class="card"><p class="muted">Aucune famille. Ajoutez-en une en bas.</p></div>')
    + '<div class="card">'
      + '<h3>Ajouter une famille</h3>'
      + '<div class="row gap8">'
        + '<input id="fam-add" placeholder="Nom de la famille (ex: Domotique)"/>'
        + b('Ajouter la famille','catFamAdd()','btn')
      + '</div>'
      + '<p class="note">Les familles doivent correspondre (id√©alement) aux cat√©gories de l‚Äôapplication pour appara√Ætre dans les menus. Exemples : ¬´ Prises ¬ª, ¬´ √âclairage/Luminaires ¬ª, ¬´ √âclairage/Commandes ¬ª, ¬´ Circuit sp√©cialis√© ¬ª, ¬´ Tableau ¬ª, ¬´ Ventilation ¬ª, ¬´ Mise √† la terre ¬ª.</p>'
    + '</div>'
    + '</div>'
  );

  // Handlers
  window.catPrestAdd = function(fam){
    const el = document.getElementById('add-'+fam);
    const name = (el && el.value || '').trim(); if(!name) return;
    const cur = getCatPrestations();
    cur.familles[fam] = cur.familles[fam] || [];
    cur.familles[fam].push({ nom:name, tarifs:{} });
    setCatPrestations(cur); applyPrestationsToApp(); pageCataloguePrestations();
  };
  window.catPrestDel = function(fam, idx){
    const cur = getCatPrestations();
    (cur.familles[fam]||[]).splice(idx,1);
    setCatPrestations(cur); applyPrestationsToApp(); pageCataloguePrestations();
  };
  window.catPrestSave = function(fam, idx){
    const cur = getCatPrestations(); const t=cur.familles[fam][idx]; if(!t) return;
    const KEYS_APP = (fam==='√âclairage/Luminaires')
      ? ["Cr√©ation","Remplacement luminaire","Rec√¢blage avec remplacement luminaire","Rec√¢blage sans remplacement luminaire"]
      : (fam==='Prises' || fam==='√âclairage/Commandes' || fam==='Circuit sp√©cialis√©'
          ? ["Cr√©ation","Remplacement appareillage","Rec√¢blage avec remplacement appareillage","Rec√¢blage sans remplacement appareillage"]
          : ["Cr√©ation"]);
    const tarifs = {};
    KEYS_APP.forEach(k=>{
      const id = (fam+'__'+idx+'__'+k).replace(/\s+/g,'_');
      const el = document.getElementById(id);
      tarifs[k] = _ensureNum13(el && el.value);
    });
    t.tarifs = tarifs;
    setCatPrestations(cur); applyPrestationsToApp(); alert('‚úÖ Tarifs enregistr√©s.');
  };
  window.catFamAdd = function(){
    const el=document.getElementById('fam-add'); const fam=(el&&el.value||'').trim(); if(!fam) return;
    const cur=getCatPrestations(); cur.familles[fam]=cur.familles[fam]||[]; setCatPrestations(cur);
    applyPrestationsToApp(); pageCataloguePrestations();
  };
}

/* ==========================================
   13.4 ‚Ä¢ TARIFS & COEFFICIENTS (catalogue)
   ========================================== */
function pageTarifsEtCoeffs(){
  const tc = getTarifsCoeffs();
  function coefPoseGrid(){
    return Object.keys(Object.assign({}, COEFF_POSE, tc.coeff_pose||{})).map(k=>{
      const id = 'cp_'+k.replace(/\s+/g,'_');
      const val = (tc.coeff_pose && typeof tc.coeff_pose[k]!=='undefined') ? tc.coeff_pose[k] : COEFF_POSE[k];
      return '<div class="field"><label>'+_esc13(k)+'</label><input id="'+id+'" type="number" step="0.05" inputmode="decimal" value="'+(+val||1)+'"/></div>';
    }).join('');
  }
  function coefSectionsGrid(){
    return Object.keys(Object.assign({}, COEFF_SECTIONS_CS, tc.coeff_sections_cs||{})).map(k=>{
      const id = 'cs_'+k.replace(/\s+/g,'_');
      const val = (tc.coeff_sections_cs && typeof tc.coeff_sections_cs[k]!=='undefined') ? tc.coeff_sections_cs[k] : COEFF_SECTIONS_CS[k];
      return '<div class="field"><label>'+_esc13(k)+'</label><input id="'+id+'" type="number" step="0.05" inputmode="decimal" value="'+(+val||1)+'"/></div>';
    }).join('');
  }

  view(
    '<div class="cat-wrap">'
    + '<div class="card">'
      + b('Retour','(typeof pageMain==="function"?pageMain():history.back())','btn back')
      + '<h2>Tarifs & coefficients</h2>'
      + '<p class="muted">Ajustez ici les coefficients de pose et de section, ainsi que des overrides cibl√©s par famille/type/intervention.</p>'
      + '<div class="row gap8">'
        + b('üíæ Enregistrer','saveTarifsEtCoeffs()','btn primary')
        + b('‚¨áÔ∏è Export JSON','tcExport()','btn')
        + b('‚¨ÜÔ∏è Import JSON','tcImport()','btn')
        + b('üßπ R√©initialiser','tcReset()','btn')
      + '</div>'
    + '</div>'

    + '<div class="card">'
      + '<h3>Coefficients de pose</h3>'
      + '<div class="grid">'+coefPoseGrid()+'</div>'
    + '</div>'

    + '<div class="card">'
      + '<h3>Coefficients de section (Circuit sp√©cialis√©)</h3>'
      + '<div class="grid">'+coefSectionsGrid()+'</div>'
    + '</div>'

    + '<div class="card">'
      + '<h3>Overrides cibl√©s (optionnel)</h3>'
      + '<p class="note">Format simple : indiquez Famille ‚Üí D√©signation ‚Üí Intervention ‚Üí Prix. Laissez vide pour ignorer.<br>Exemple : Famille=Prises, D√©signation=Prise 2P+T, Intervention=Cr√©ation, Prix=95</p>'
      + '<div class="grid">'
        + '<div class="field"><label>Famille</label><input id="ov_fam" placeholder="ex : Prises"/></div>'
        + '<div class="field"><label>D√©signation</label><input id="ov_des" placeholder="ex : Prise 2P+T"/></div>'
        + '<div class="field"><label>Intervention</label><input id="ov_int" placeholder="ex : Cr√©ation"/></div>'
        + '<div class="field"><label>Prix (‚Ç¨)</label><input id="ov_prix" type="number" step="1" inputmode="decimal" placeholder="ex : 95"/></div>'
      + '</div>'
      + '<div class="row gap8" style="margin-top:8px;">'
        + b('Ajouter/Mettre √† jour override','tcAddOverride()','btn')
        + b('Vider les overrides','tcClearOverrides()','btn')
      + '</div>'
    + '</div>'
    + '</div>'
  );

  window.saveTarifsEtCoeffs = function(){
    const cur = getTarifsCoeffs();
    const inputs = document.querySelectorAll('[id^="cp_"],[id^="cs_"]');
    inputs.forEach(el=>{
      if(el.id.startsWith('cp_')){
        const k = el.id.slice(3).replace(/_/g,' ');
        cur.coeff_pose[k] = Math.max(0, parseFloat(el.value)||1);
      }else if(el.id.startsWith('cs_')){
        const k = el.id.slice(3).replace(/_/g,' ');
        cur.coeff_sections_cs[k] = Math.max(0, parseFloat(el.value)||1);
      }
    });
    setTarifsCoeffs(cur); applyPrestationsToApp(); alert('‚úÖ Tarifs & coefficients enregistr√©s.');
  };
  window.tcAddOverride = function(){
    const fam = (document.getElementById('ov_fam')?.value||'').trim();
    const des = (document.getElementById('ov_des')?.value||'').trim();
    const itv = (document.getElementById('ov_int')?.value||'').trim();
    const p   = Math.max(0, parseFloat(document.getElementById('ov_prix')?.value)||0);
    if(!fam || !des || !itv || !p){ alert('Renseignez tous les champs.'); return; }
    const cur = getTarifsCoeffs();
    cur.overrides = cur.overrides || {};
    cur.overrides[fam] = cur.overrides[fam] || {};
    cur.overrides[fam][des] = cur.overrides[fam][des] || {};
    cur.overrides[fam][des][itv] = p;
    setTarifsCoeffs(cur); applyPrestationsToApp(); alert('‚úÖ Override ajout√©.');
  };
  window.tcClearOverrides = function(){
    const cur=getTarifsCoeffs(); cur.overrides={}; setTarifsCoeffs(cur); applyPrestationsToApp(); alert('‚úÖ Overrides vid√©s.');
  };
  window.tcExport = function(){
    const blob = new Blob([JSON.stringify(getTarifsCoeffs(),null,2)],{type:'application/json;charset=utf-8'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tarifs_coeffs.json'; a.click(); URL.revokeObjectURL(url);
  };
  window.tcImport = function(){
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=function(){
      const f=input.files&&input.files[0]; if(!f) return;
      const rd=new FileReader(); rd.onload=function(){
        try{ const obj=JSON.parse(rd.result||'{}'); setTarifsCoeffs(obj); applyPrestationsToApp(); alert('‚úÖ Import OK.'); pageTarifsEtCoeffs(); }
        catch(e){ alert('‚ùå Import invalide : '+e.message); }
      }; rd.readAsText(f,'utf-8');
    };
    input.click();
  };
  window.tcReset = function(){
    if(!confirm('R√©initialiser les coefficients ?')) return;
    localStorage.removeItem(KEY_TARIFS_COEFFS); applyPrestationsToApp(); pageTarifsEtCoeffs();
  };
}

/* =======================================
   13.5 ‚Ä¢ CATALOGUE MAT√âRIEL (marques‚Ä¶)
   ======================================= */
function pageCatalogueMateriel(){
  const cat = getCatMateriel();
  const familles = Object.keys(cat.familles||{});

  function blocFam(fam){
    const marques = cat.familles[fam]||{};
    const marqueRows = Object.keys(marques).map(marque=>{
      const gammes = marques[marque]||{};
      const gammeRows = Object.keys(gammes).map(gamme=>{
        const refs = gammes[gamme]||{};
        const refRows = Object.keys(refs).map(ref=>{
          const id = ['mat',fam,marque,gamme,ref].map(x=>x.replace(/\s+/g,'_')).join('__');
          const v  = +refs[ref]||0;
          return `<tr>
            <td>${_esc13(ref)}</td>
            <td style="width:140px"><input id="${id}" type="number" step="0.1" inputmode="decimal" value="${v}"/></td>
            <td style="width:1%">${b('√ó','matDelRef("'+fam+'","'+marque+'","'+gamme+'","'+ref+'")','btn')}</td>
          </tr>`;
        }).join('');
        return `
          <div class="card">
            <div class="type-head">
              <h3>${_esc13(marque)} ‚Äî ${_esc13(gamme)}</h3>
              <div class="row gap8">
                ${b('Supprimer la gamme','matDelGamme("'+fam+'","'+marque+'","'+gamme+'")','btn')}
              </div>
            </div>
            <table class="table-mini">
              <thead><tr><th>R√©f√©rence</th><th>PU (‚Ç¨)</th><th></th></tr></thead>
              <tbody>${refRows || '<tr><td colspan="3" class="muted">Aucune r√©f√©rence.</td></tr>'}</tbody>
            </table>
            <div class="row gap8" style="margin-top:8px;">
              <input id="ref-${_esc13(fam)}-${_esc13(marque)}-${_esc13(gamme)}" placeholder="Nouvelle r√©f√©rence (ex: Inter simple)"/>
              <input id="pu-${_esc13(fam)}-${_esc13(marque)}-${_esc13(gamme)}" type="number" step="0.1" inputmode="decimal" placeholder="PU (‚Ç¨)"/>
              ${b('Ajouter','matAddRef("'+fam+'","'+marque+'","'+gamme+'")','btn')}
              ${b('üíæ Enregistrer les PU','matSaveRefs("'+fam+'","'+marque+'","'+gamme+'")','btn primary')}
            </div>
          </div>`;
      }).join('');

      return `
        <div class="card">
          <div class="type-head">
            <h2>${_esc13(fam)} ‚Äî ${_esc13(marque)}</h2>
            <div class="row gap8">
              ${b('Supprimer la marque','matDelMarque("'+fam+'","'+marque+'")','btn')}
            </div>
          </div>
          ${gammeRows || '<p class="muted">Aucune gamme.</p>'}
          <div class="row gap8">
            <input id="gamme-${_esc13(fam)}-${_esc13(marque)}" placeholder="Nouvelle gamme (ex: Resi9)"/>
            ${b('Ajouter la gamme','matAddGamme("'+fam+'","'+marque+'")','btn')}
          </div>
        </div>`;
    }).join('');

    return `
      <div class="card">
        <h2>${_esc13(fam)}</h2>
        ${marqueRows || '<p class="muted">Aucune marque.</p>'}
        <div class="row gap8">
          <input id="marque-${_esc13(fam)}" placeholder="Nouvelle marque (ex: Schneider)"/>
          ${b('Ajouter la marque','matAddMarque("'+fam+'")','btn')}
        </div>
      </div>`;
  }

  view(
    '<div class="cat-wrap">'
    + '<div class="card">'
      + b('Retour','(typeof pageMain==="function"?pageMain():history.back())','btn back')
      + '<h2>Catalogue mat√©riel</h2>'
      + '<p class="muted">D√©finissez les marques, gammes et prix unitaires de vos r√©f√©rences.</p>'
      + '<div class="row gap8">'
        + b('‚¨áÔ∏è Export JSON','matExport()','btn')
        + b('‚¨ÜÔ∏è Import JSON','matImport()','btn')
        + b('üßπ R√©initialiser','matReset()','btn')
      + '</div>'
    + '</div>'
    + (familles.length ? familles.map(blocFam).join('') : '<div class="card"><p class="muted">Aucune famille. Ajoutez-en une.</p></div>')
    + '<div class="card">'
      + '<h3>Ajouter une famille</h3>'
      + '<div class="row gap8">'
        + '<input id="fam-mat-add" placeholder="ex: Appareillage, Tableau, Ventilation‚Ä¶"/>'
        + b('Ajouter la famille','matAddFamille()','btn')
      + '</div>'
    + '</div>'
    + '</div>'
  );

  // Handlers mat√©riel
  window.matAddFamille = function(){
    const fam = (document.getElementById('fam-mat-add')?.value||'').trim(); if(!fam) return;
    const cur = getCatMateriel(); cur.familles[fam]=cur.familles[fam]||{}; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matAddMarque = function(fam){
    const m = (document.getElementById('marque-'+fam)?.value||'').trim(); if(!m) return;
    const cur=getCatMateriel(); cur.familles[fam]=cur.familles[fam]||{}; cur.familles[fam][m]=cur.familles[fam][m]||{}; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matAddGamme = function(fam, marque){
    const g = (document.getElementById('gamme-'+fam+'-'+marque)?.value||'').trim(); if(!g) return;
    const cur=getCatMateriel(); cur.familles[fam][marque]=cur.familles[fam][marque]||{}; cur.familles[fam][marque][g]=cur.familles[fam][marque][g]||{}; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matAddRef = function(fam, marque, gamme){
    const refEl=document.getElementById('ref-'+fam+'-'+marque+'-'+gamme);
    const puEl =document.getElementById('pu-'+fam+'-'+marque+'-'+gamme);
    const ref=(refEl&&refEl.value||'').trim(); const pu=Math.max(0, parseFloat(puEl&&puEl.value)||0);
    if(!ref || !pu) return;
    const cur=getCatMateriel(); cur.familles[fam][marque][gamme][ref]=pu; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matDelRef = function(fam, marque, gamme, ref){
    const cur=getCatMateriel(); delete cur.familles[fam][marque][gamme][ref]; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matDelGamme = function(fam, marque, gamme){
    const cur=getCatMateriel(); delete cur.familles[fam][marque][gamme]; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matDelMarque = function(fam, marque){
    const cur=getCatMateriel(); delete cur.familles[fam][marque]; setCatMateriel(cur); pageCatalogueMateriel();
  };
  window.matSaveRefs = function(fam, marque, gamme){
    const cur=getCatMateriel();
    const prefix = ['mat',fam,marque,gamme].map(x=>x.replace(/\s+/g,'_')).join('__');
    const inputs=document.querySelectorAll(`table.table-mini input[id^="${prefix}__"]`);
    inputs.forEach(el=>{
      const parts = el.id.split('__'); // mat__fam__marque__gamme__ref...
      const ref = parts.slice(4).join('__').replace(/_/g,' ');
      cur.familles[fam][marque][gamme][ref]=Math.max(0, parseFloat(el.value)||0);
    });
    setCatMateriel(cur); alert('‚úÖ Tarifs mat√©riel enregistr√©s.');
  };
  window.matExport=function(){
    const blob = new Blob([JSON.stringify(getCatMateriel(),null,2)],{type:'application/json;charset=utf-8'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='catalogue_materiel.json'; a.click(); URL.revokeObjectURL(url);
  };
  window.matImport=function(){
    const input=document.createElement('input'); input.type='file'; input.accept='application/json';
    input.onchange=function(){
      const f=input.files&&input.files[0]; if(!f) return;
      const rd=new FileReader(); rd.onload=function(){
        try{ const obj=JSON.parse(rd.result||'{}'); setCatMateriel(obj); alert('‚úÖ Import OK.'); pageCatalogueMateriel(); }
        catch(e){ alert('‚ùå Import invalide : '+e.message); }
      }; rd.readAsText(f,'utf-8');
    };
    input.click();
  };
  window.matReset=function(){
    if(!confirm('R√©initialiser le catalogue mat√©riel ?')) return;
    localStorage.removeItem(KEY_CAT_MATERIEL); pageCatalogueMateriel();
  };
}

/* ===========================================
   13.6 ‚Ä¢ Import / Export / Reset (prestations)
   =========================================== */
function catPrestExport(){
  const blob = new Blob([JSON.stringify(getCatPrestations(),null,2)],{type:'application/json;charset=utf-8'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='catalogue_prestations.json'; a.click(); URL.revokeObjectURL(url);
}
function catPrestImport(){
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange=function(){
    const f=input.files&&input.files[0]; if(!f) return;
    const rd=new FileReader(); rd.onload=function(){
      try{ const obj=JSON.parse(rd.result||'{}'); setCatPrestations(obj); applyPrestationsToApp(); alert('‚úÖ Import OK.'); pageCataloguePrestations(); }
      catch(e){ alert('‚ùå Import invalide : '+e.message); }
    }; rd.readAsText(f,'utf-8');
  };
  input.click();
}
function catPrestReset(){
  if(!confirm('R√©initialiser le catalogue prestations ?')) return;
  localStorage.removeItem(KEY_CAT_PRESTATIONS); applyPrestationsToApp(); pageCataloguePrestations();
}

/* =======================================
   13.7 ‚Ä¢ Accueil(s) de ce chapitre (facultatif)
   ======================================= */
function pageCatalogueAccueil(){
  view(
    '<div class="card">'
      + b('Retour','(typeof pageMain==="function"?pageMain():history.back())','btn back')
      + '<h2>Catalogue & tarifs (configuration)</h2>'
      + '<div class="row gap8" style="margin-top:8px;">'
        + b('Catalogue prestations','pageCataloguePrestations()','btn primary')
        + b('Tarifs & coefficients','pageTarifsEtCoeffs()','btn')
        + b('Catalogue mat√©riel','pageCatalogueMateriel()','btn')
      + '</div>'
    + '</div>'
  );
}

/* =========================
   13.8 ‚Ä¢ Expose (window)
   ========================= */
Object.assign(window,{
  // pages
  pageCatalogueAccueil,
  pageCataloguePrestations,
  pageTarifsEtCoeffs,
  pageCatalogueMateriel,
  // apply runtime
  applyPrestationsToApp,
  // IO prestations
  catPrestExport, catPrestImport, catPrestReset
});

/* Alimente l‚Äôapp au chargement du chapitre */
applyPrestationsToApp();
</script>


