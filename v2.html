<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- ============================= -->
  <!-- CHAPITRE 1 : STRUCTURE & STYLES -->
  <!-- Rôle : page de base + styles simples responsive -->
  <!-- ============================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniDevis — V2 (dev, pièces dynamiques)</title>
  <style>
    :root { --bg:#f6f6f6; --card:#fff; --txt:#111; --muted:#666; --line:#e8e8e8; --primary:#111; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Arial, Helvetica, sans-serif; color:var(--txt); background:var(--bg); }
    header{ position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; padding:10px 14px; font-weight:700; text-align:center; }
    main{ max-width:980px; margin:0 auto; padding:16px; }
    h2{ margin:8px 0 12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    .grid-qty{ display:grid; grid-template-columns:repeat(6,56px); gap:8px; }
    .btn{ padding:10px 14px; font-size:16px; background:#eee; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
    .btn.primary{ background:#111; color:#fff; border-color:#000; }
    .btn.back{ background:#ddd; }
    .btn.ghost{ background:#fff; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; }
    .muted{ color:var(--muted); }
    pre{ white-space:pre-wrap; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:10px; }
    input, select, textarea{ width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; }
    .pill small{ color:var(--muted); }
  </style>
</head>
<body>
<header>MiniDevis — V2 (dev) — Pièces dynamiques</header>
<main id="app"></main>

<!-- ============================= -->
<!-- CHAPITRE 2 : CONTENEUR & PAGES -->
<!-- Rôle : un seul fichier / plusieurs “écrans” rendus par JS -->
<!-- ============================= -->

<script>
/* ============================= */
/* CHAPITRE 3 : DONNÉES & CONSTANTES
   Rôle : listes de pièces, poses, catégories, tarifs de base            */
/* ============================= */
const PIECES_PREDEFINIES = [
  "Salon","Cuisine","Salle à manger","Salle de bain","Salle d'eau",
  "Chambre 1","Chambre 2","Chambre 3","Toilettes","Bureau",
  "Buanderie","Garage","Couloir","Terrasse","Balcon","Jardin",
  "Débarras","Extérieur","Grenier/Combles"
];
const CATEGORIES = ["Prises","Éclairage","Spécifique"]; // “Spécifique” = saisie libre dans la pièce
const POSES = ["Encastré maçonnerie","Placo","Semi-encastré","Sur-mesure"];
const DESIGNATIONS_PAR_CATEGORIE = {
  "Prises": ["Prise"],
  "Éclairage": ["Point de centre","Applique","Interrupteur simple","Interrupteur double"]
};
const TARIFS = {
  "Prise": { creation:120, recablage_sans:50, recablage_avec:70, remplacement:20 },
  "Point de centre": { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  "Applique": { creation:100, recablage_sans:50, recablage_avec:75, remplacement:30 },
  "Interrupteur simple": { creation:40, recablage_sans:50, recablage_avec:75, remplacement:25 },
  "Interrupteur double": { creation:60, recablage_sans:50, recablage_avec:85, remplacement:35 }
};

/* ============================= */
/* CHAPITRE 4 : ÉTAT & HELPERS UI
   Rôle : état global, rendu, boutons utilitaires                       */
/* ============================= */
let devis = {}; // { [piece]: { items:[{...}], note:"" } }
let ctx = { piece:null, category:null, intervention:null, pose:null, designation:null };

const $app = () => document.getElementById('app');
function view(html){ $app().innerHTML = html; }
function b(label, fn, cls="btn"){ return `<button class="${cls}" onclick="${fn}">${label}</button>`; }
function euro(n){ return `${(+n).toFixed(2)} €`; }

function ensureSection(piece){
  if(!devis[piece]) devis[piece] = { items:[], note:"" };
}

/* ============================= */
/* CHAPITRE 5 : ACCUEIL & FLUX “PIÈCES DYN.”           
   Rôle : gérer la liste de pièces (dyn), navigation dans une pièce,
          ajout/suppression de lignes, notes, etc.                 */
/* ============================= */

/* Accueil */
function pageHome(){
  const listPieces = Object.keys(devis);
  const listHtml = listPieces.length
    ? listPieces.map(p => `<div class="pill">
          <strong>${p}</strong>
          <small>${devis[p].items.length} ligne(s)</small>
          ${b("Ouvrir", `goPiece('${p}')`,"btn")}
          ${b("Renommer", `renamePiece('${p}')`,"btn")}
          ${b("Dupliquer", `clonePiece('${p}')`,"btn")}
          ${b("Supprimer", `removePiece('${p}')`,"btn")}
        </div>`).join('')
    : `<p class="muted">Aucune pièce ajoutée pour l’instant.</p>`;

  view(`
    <div class="card">
      <h2>Accueil</h2>
      <div class="row">
        ${b("Ajouter une pièce","pageAddPiece()","btn primary")}
        ${b("Installations spécifiques","pageISHome()","btn")}
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Pièces ajoutées</h2>
      <div class="list">${listHtml}</div>
    </div>

    <div class="row" style="margin-top:12px;">
      ${b("Voir l’estimatif","pageEstimatif()")}
      ${b("Voir les totaux","pageTotaux()")}
      ${b("Réinitialiser devis","resetAll()","btn")}
    </div>

    <p class="muted" style="margin-top:8px;">Astuce : crée une pièce libre avec “Créer une nouvelle pièce…” tout en bas du menu.</p>
  `);
}

/* Sélection / création de pièce */
function pageAddPiece(){
  const options =
    PIECES_PREDEFINIES.map(p=>`<option value="${p}">${p}</option>`).join('') +
    `<option value="__NEW__">➕ Créer une nouvelle pièce…</option>`;

  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Ajouter une pièce</h2>
      <label>Choisir une pièce</label>
      <select id="piece-choice">${options}</select>
      <div class="row" style="margin-top:10px;">
        ${b("Valider","confirmPieceChoice()","btn primary")}
      </div>
      <p class="muted" style="margin-top:10px;">
        L’option “Créer une nouvelle pièce…” te demande un nom et n’est pas mémorisée pour les prochaines fois.
      </p>
    </div>
  `);
}
function confirmPieceChoice(){
  const sel = document.getElementById('piece-choice').value;
  if(!sel) return;

  let name = sel;
  if (sel === "__NEW__") {
    name = (prompt("Nom de la pièce :","") || "").trim();
    if(!name) return; // annulé ou vide
  }

  ensureSection(name);
  saveLocal();                // ← persistance
  goPiece(name);
}

/* (Optionnelle si tu gardes un champ libre à côté du select) */
function confirmPieceCustom(){
  const name = (document.getElementById("piece-custom")?.value||"").trim();
  if(!name) return alert("Indique un nom de pièce.");
  ensureSection(name);
  saveLocal();                // ← persistance
  goPiece(name);
}

function removePiece(piece){
  if(confirm(`Supprimer la pièce “${piece}” et toutes ses lignes ?`)){
    delete devis[piece];
    saveLocal();              // ← persistance
    pageHome();
  }
}
function renamePiece(p){
  const n=(prompt("Nouveau nom :", p)||"").trim();
  if(!n || n===p) return;
  if(devis[n]) return alert("Ce nom existe déjà.");
  devis[n]=devis[p]; delete devis[p];
  saveLocal();                // ← persistance
  pageHome();
}
function clonePiece(p){
  const n=(prompt("Nom de la copie :", p+" (copie)")||"").trim();
  if(!n) return;
  if(devis[n]) return alert("Ce nom existe déjà.");
  devis[n]=JSON.parse(JSON.stringify(devis[p]));
  saveLocal();                // ← persistance
  pageHome();
}

/* Page d’une pièce */
function goPiece(piece){
  ctx = { piece, category:null, intervention:null, pose:null, designation:null };
  ensureSection(piece);

  const cats = CATEGORIES.map(cat => b(cat, `goCategory('${cat}')`)).join('');
  const noteTxt = devis[piece].note ? `<em class="muted">Note : ${devis[piece].note}</em>` : `<span class="muted">Aucune note</span>`;
  const lignes = devis[piece].items.length
    ? `<ul>` + devis[piece].items.map((it,i)=>{
        const total = (it.prixU||0) * (it.qty||0);
        const poseTxt = (it.intervention==="Création" && it.pose) ? ` — ${it.pose.toLowerCase()}` : "";
        const unitTxt = it.unit || "u";
        return `<li>${it.intervention?it.intervention+" — ":""}${it.designation}${poseTxt} (${it.qty} ${unitTxt} × ${euro(it.prixU)} = ${euro(total)}) ${b("×",`delLine('${piece}',${i})`,"btn")}</li>`;
      }).join('') + `</ul>`
    : `<p class="muted">Aucune ligne pour l’instant.</p>`;

  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>${piece}</h2>
      <div class="row">${cats} ${b("Spécifique",`pagePieceSpecifique()`,"btn ghost")}</div>
      <div class="row" style="margin-top:10px;">
        ${b("Ajouter / modifier la note","editPieceNote()")}
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Lignes de la pièce</h2>
      ${lignes}
      <p style="margin-top:8px;">${noteTxt}</p>
    </div>
  `);
}
function delLine(piece, idx){
  devis[piece].items.splice(idx,1);
  saveLocal();                // ← persistance
  goPiece(piece);
}
function editPieceNote(){
  const cur = devis[ctx.piece].note || "";
  const n = prompt(`Note pour ${ctx.piece}`, cur);
  if(n!==null) devis[ctx.piece].note = n.trim();
  saveLocal();                // ← persistance
  goPiece(ctx.piece);
}

/* Catégorie → Intervention → Pose → Quantité */
function goCategory(cat){
  ctx.category = cat;
  const interventions = (cat==="Prises")
    ? ["Création","Remplacement appareillage","Recâblage avec remplacement appareillage","Recâblage sans remplacement appareillage"]
    : (cat==="Éclairage")
      ? ["Création","Remplacement luminaire","Recâblage avec remplacement appareillage","Recâblage sans remplacement appareillage"]
      : ["Saisie libre avec prix"]; // “Spécifique” (dans la pièce)

  const btns = interventions.map(i=> b(i,`goIntervention('${i}')`)).join('');
  view(`
    <div class="card">
      ${b("Retour",`goPiece('${ctx.piece}')`,"btn back")}
      <h2>${ctx.category} — ${ctx.piece}</h2>
      <div class="row">${btns}</div>
    </div>
  `);
}
function goIntervention(interv){
  ctx.intervention = interv;
  if(ctx.category==="Spécifique"){
    const label = prompt("Nom de la prestation spécifique :","");
    if(!label){ return goCategory("Spécifique"); }
    const prix = parseFloat(prompt("Prix estimé (€) :","0"))||0;
    ensureSection(ctx.piece);
    devis[ctx.piece].items.push({ category:"Spécifique", intervention:"", pose:"", designation:label, qty:1, prixU:prix });
    saveLocal();              // ← persistance
    goPiece(ctx.piece);
    return;
  }
  if(interv==="Création"){
    const poses = POSES.map(p=> b(p,`goDesignation('${p}')`)).join('');
    view(`
      <div class="card">
        ${b("Retour",`goCategory('${ctx.category}')`,"btn back")}
        <h2>Type de pose</h2>
        <div class="row">${poses}</div>
      </div>
    `);
  } else {
    goDesignation(null);
  }
}
function goDesignation(pose){
  ctx.pose = pose; // peut être null (hors Création)
  const list = DESIGNATIONS_PAR_CATEGORIE[ctx.category] || ["Élément"];
  const btns = list.map(d=> b(d,`pageQuantite('${d}')`)).join('');
  view(`
    <div class="card">
      ${b("Retour", ctx.intervention==="Création" ? `goIntervention('${ctx.intervention}')` : `goCategory('${ctx.category}')`,"btn back")}
      <h2>Désignation</h2>
      <div class="row">${btns}</div>
    </div>
  `);
}
function pageQuantite(designation){
  ctx.designation = designation;
  const qtyBtns = Array.from({length:10},(_,i)=> b(i+1,`saveItem(${i+1})`)).join('');
  view(`
    <div class="card">
      ${b("Retour",`goDesignation('${ctx.pose}')`,"btn back")}
      <h2>Quantité</h2>
      <div class="grid-qty">${qtyBtns}</div>
      <div class="row" style="margin-top:10px;">
        ${b("1","saveItem(1)")}
        ${b("5","saveItem(5)")}
        ${b("10","saveItem(10)")}
      </div>
    </div>
  `);
}
function getPrix(designation, intervention){
  const base = TARIFS[designation] || {};
  if(intervention==="Création") return base.creation||0;
  if(intervention.includes("sans remplacement")) return base.recablage_sans||0;
  if(intervention.includes("avec remplacement")) return base.recablage_avec||0;
  if(intervention.startsWith("Remplacement")) return base.remplacement||0;
  return 0;
}
function saveItem(qty){
  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({
    category: ctx.category,
    intervention: ctx.intervention,
    pose: ctx.pose,
    designation: ctx.designation,
    qty: qty,
    prixU: getPrix(ctx.designation, ctx.intervention)
  });
  saveLocal();                // ← persistance
  // Rester sur la pièce pour enchaîner
  goPiece(ctx.piece);
}

/* Saisie rapide “Spécifique” dans la pièce */
function pagePieceSpecifique(){
  const label = prompt("Nom de la prestation spécifique :","");
  if(!label){ return goPiece(ctx.piece); }
  const prix = parseFloat(prompt("Prix estimé (€) :","0"))||0;
  ensureSection(ctx.piece);
  devis[ctx.piece].items.push({ category:"Spécifique", intervention:"", pose:"", designation:label, qty:1, prixU:prix });
  saveLocal();                // ← persistance
  goPiece(ctx.piece);
}

<!-- ============================= -->
<!-- CHAPITRE 6 : PERSISTENCE & INSTALLATIONS SPÉCIFIQUES (IS) -->
<!-- Rôle :
     1) Sauvegarder / restaurer automatiquement l’objet "devis" (localStorage)
     2) Fournir les pages d’Installations Spécifiques (Terre / Ventilation / Tableau)
        qui ajoutent des lignes dans le devis via addIS()                     -->
<!-- ============================= -->

<script>
/* ---------- 6.A — PERSISTENCE (localStorage) ---------- */

/** Sauvegarde l’état complet du devis dans le navigateur */
function saveLocal(){
  try { localStorage.setItem("devisV2", JSON.stringify(devis)); } catch(e){}
}

/** Charge l’état sauvegardé si présent (à appeler au démarrage) */
function loadLocal(){
  try {
    const d = JSON.parse(localStorage.getItem("devisV2") || "null");
    if (d && typeof d === "object") devis = d;
  } catch(e){}
}

/** Remise à zéro complète du devis (avec confirmation) */
function resetAll(){
  if(confirm("Tout effacer ?")){
    devis = {};
    saveLocal();
    pageHome();
  }
}

/* Sauvegarde automatique en quittant l’onglet (par sécurité) */
window.addEventListener("beforeunload", saveLocal);

/* ---------- 6.B — INSTALLATIONS SPÉCIFIQUES (IS) ---------- */
/* Tarifs / packs utilisés par les IS (identiques à V1) */
const IS_TERRA = {
  complete_base: 500,
  piquet_supp: 100,
  part_conducteur_m: 20,
  part_barrette: 40,
  part_piquet_pack: 120
};
const IS_VENTIL = {
  bouche_remplacement: 40,
  bouche_creation: 120,
  groupe_remplacement: 200,
  pack_creation: 900,
  bouche_supp: 120,
  gaine_m: 10,
  chapeau_125: 180,
  alim_groupe: 100,
  nettoyage: 80
};
const IS_TABLEAU = {
  circ_prises: 180,
  circ_eclairage: 150,
  circ_specialise: 200,
  recablage_circuit: 100,
  remplacement_protection: 40,
  remplacement_tableau: 800,
  tableau_secondaire: 500,
  extension_tableau: 250
};

/** Ajoute une ligne "Installation spécifique" dans une section du devis */
function addIS(section, label, prixU, qty=1, unit="u"){
  ensureSection(section);
  devis[section].items.push({
    category: "Installation spécifique",
    intervention: "",
    pose: "",
    designation: label,
    qty: +qty,
    prixU: +prixU,
    unit: unit
  });
  saveLocal(); // <-- persistance
  alert(`${label} ajouté (${qty} ${unit}, ${prixU} €/ ${unit})`);
  pageISHome();
}

/* Page d’accueil des IS */
function pageISHome(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Installations spécifiques</h2>
      <div class="row" style="margin-bottom:10px;">
        ${b("Mise à la terre","pageISTerre()")}
        ${b("Ventilation","pageISVentil()")}
        ${b("Distribution tableau","pageISTableau()")}
      </div>
      <p class="muted">Ajoute des postes “hors‑pièces”, regroupés par section dans l’estimatif.</p>
    </div>
  `);
}

/* ----- Mise à la terre ----- */
function pageISTerre(){
  view(`
    <div class="card">
      ${b("Retour","pageISHome()","btn back")}
      <h2>Mise à la terre</h2>
      <div class="row">
        ${b(\`Complète (\${euro(IS_TERRA.complete_base)})\`,"terreComplete()")}
        ${b(\`Piquet supp. +2m câblette (\${euro(IS_TERRA.piquet_supp)})\`,"terrePiquetSupp()")}
        ${b(\`Rempl. conducteur 16mm² (\${euro(IS_TERRA.part_conducteur_m)}/m)\`,"terreRemplacementConducteur()")}
        ${b(\`Barrette de coupure (\${euro(IS_TERRA.part_barrette)})\`,"terreBarrette()")}
        ${b(\`Piquet pack (\${euro(IS_TERRA.part_piquet_pack)})\`,"terrePiquetPack()")}
      </div>
    </div>
  `);
}
function terreComplete(){
  addIS("Mise à la terre","Mise à la terre complète (conducteur 16mm² tableau→barrette, barrette, 4 piquets, 10m câblette 25mm²)", IS_TERRA.complete_base, 1, "u");
}
function terrePiquetSupp(){
  const q = parseInt(prompt("Nb de piquets supplémentaires (+2m câblette chacun) :","1")||"0",10);
  if(q>0) addIS("Mise à la terre","Piquet supplémentaire (+2m câblette)", IS_TERRA.piquet_supp, q, "u"); else pageISTerre();
}
function terreRemplacementConducteur(){
  const m = parseFloat(prompt("Longueur de conducteur 16mm² (m) :","1")||"0");
  if(m>0) addIS("Mise à la terre","Remplacement conducteur principal 16mm²", IS_TERRA.part_conducteur_m, m, "m"); else pageISTerre();
}
function terreBarrette(){ addIS("Mise à la terre","Pose d’une barrette de coupure", IS_TERRA.part_barrette, 1, "u"); }
function terrePiquetPack(){
  const q = parseInt(prompt("Nb de piquets pack (avec câblette) :","1")||"0",10);
  if(q>0) addIS("Mise à la terre","Piquet supplémentaire (pack avec câblette)", IS_TERRA.part_piquet_pack, q, "u"); else pageISTerre();
}

/* ----- Ventilation ----- */
function pageISVentil(){
  view(`
    <div class="card">
      ${b("Retour","pageISHome()","btn back")}
      <h2>Ventilation</h2>
      <div class="row">
        ${b(\`Remplacement bouche (\${euro(IS_VENTIL.bouche_remplacement)})\`,"ventilBoucheRempl()")}
        ${b(\`Création bouche (\${euro(IS_VENTIL.bouche_creation)})\`,"ventilBoucheCreation()")}
        ${b(\`Remplacement groupe VMC (\${euro(IS_VENTIL.groupe_remplacement)})\`,"ventilGroupeRempl()")}
        ${b(\`Pack création VMC (\${euro(IS_VENTIL.pack_creation)})\`,"ventilPackCreation()")}
        ${b(\`Bouche supplémentaire (\${euro(IS_VENTIL.bouche_supp)})\`,"ventilBoucheSupp()")}
        ${b(\`Gaine supplémentaire (\${euro(IS_VENTIL.gaine_m)}/m)\`,"ventilGaineM()")}
        ${b(\`Chapeau toiture Ø125 (\${euro(IS_VENTIL.chapeau_125)})\`,"ventilChapeau()")}
        ${b(\`Alimentation groupe (\${euro(IS_VENTIL.alim_groupe)})\`,"ventilAlim()")}
        ${b(\`Nettoyage / réglage (\${euro(IS_VENTIL.nettoyage)})\`,"ventilNettoyage()")}
      </div>
    </div>
  `);
}
function ventilBoucheRempl(){
  const q = parseInt(prompt("Nombre de bouches à remplacer :","1")||"0",10);
  if(q>0) addIS("Ventilation","Remplacement bouche d’extraction", IS_VENTIL.bouche_remplacement, q, "u"); else pageISVentil();
}
function ventilBoucheCreation(){
  const q = parseInt(prompt("Nombre de bouches à créer :","1")||"0",10);
  if(q>0) addIS("Ventilation","Création bouche d’extraction", IS_VENTIL.bouche_creation, q, "u"); else pageISVentil();
}
function ventilGroupeRempl(){ addIS("Ventilation","Remplacement groupe VMC simple flux", IS_VENTIL.groupe_remplacement, 1, "u"); }
function ventilPackCreation(){ addIS("Ventilation","Pack création VMC (groupe + 2 bouches + ~10m gaine + sortie murale)", IS_VENTIL.pack_creation, 1, "u"); }
function ventilBoucheSupp(){
  const q = parseInt(prompt("Nombre de bouches supplémentaires :","1")||"0",10);
  if(q>0) addIS("Ventilation","Bouche supplémentaire", IS_VENTIL.bouche_supp, q, "u"); else pageISVentil();
}
function ventilGaineM(){
  const m = parseFloat(prompt("Longueur de gaine (m) :","1")||"0");
  if(m>0) addIS("Ventilation","Gaine supplémentaire Ø125", IS_VENTIL.gaine_m, m, "m"); else pageISVentil();
}
function ventilChapeau(){ addIS("Ventilation","Pose chapeau de toiture Ø125", IS_VENTIL.chapeau_125, 1, "u"); }
function ventilAlim(){ addIS("Ventilation","Alimentation électrique du groupe VMC", IS_VENTIL.alim_groupe, 1, "u"); }
function ventilNettoyage(){ addIS("Ventilation","Nettoyage / réglage réseau VMC", IS_VENTIL.nettoyage, 1, "u"); }

/* ----- Distribution tableau ----- */
function pageISTableau(){
  view(`
    <div class="card">
      ${b("Retour","pageISHome()","btn back")}
      <h2>Distribution tableau</h2>
      <div class="row">
        ${b(\`Création circuit prises (\${euro(IS_TABLEAU.circ_prises)})\`,"tabCircPrises()")}
        ${b(\`Création circuit éclairage (\${euro(IS_TABLEAU.circ_eclairage)})\`,"tabCircEclairage()")}
        ${b(\`Création circuit spécialisé (\${euro(IS_TABLEAU.circ_specialise)})\`,"tabCircSpecialise()")}
        ${b(\`Recâblage circuit (\${euro(IS_TABLEAU.recablage_circuit)})\`,"tabRecablage()")}
        ${b(\`Remplacement protection (\${euro(IS_TABLEAU.remplacement_protection)})\`,"tabRemplProtection()")}
        ${b(\`Remplacement tableau complet (\${euro(IS_TABLEAU.remplacement_tableau)})\`,"tabRemplTableau()")}
        ${b(\`Création tableau secondaire (\${euro(IS_TABLEAU.tableau_secondaire)})\`,"tabSecondaire()")}
        ${b(\`Extension tableau (\${euro(IS_TABLEAU.extension_tableau)})\`,"tabExtension()")}
      </div>
    </div>
  `);
}
function tabCircPrises(){
  const q = parseInt(prompt("Nb circuits prises à créer :","1")||"0",10);
  if(q>0) addIS("Distribution tableau","Création circuit prises", IS_TABLEAU.circ_prises, q, "u"); else pageISTableau();
}
function tabCircEclairage(){
  const q = parseInt(prompt("Nb circuits éclairage à créer :","1")||"0",10);
  if(q>0) addIS("Distribution tableau","Création circuit éclairage", IS_TABLEAU.circ_eclairage, q, "u"); else pageISTableau();
}
function tabCircSpecialise(){
  const q = parseInt(prompt("Nb circuits spécialisés à créer :","1")||"0",10);
  if(q>0) addIS("Distribution tableau","Création circuit spécialisé", IS_TABLEAU.circ_specialise, q, "u"); else pageISTableau();
}
function tabRecablage(){
  const q = parseInt(prompt("Nb de circuits à recâbler :","1")||"0",10);
  if(q>0) addIS("Distribution tableau","Recâblage de circuit", IS_TABLEAU.recablage_circuit, q, "u"); else pageISTableau();
}
function tabRemplProtection(){
  const q = parseInt(prompt("Nb de protections à remplacer (DJ / diff.) :","1")||"0",10);
  if(q>0) addIS("Distribution tableau","Remplacement de protection", IS_TABLEAU.remplacement_protection, q, "u"); else pageISTableau();
}
function tabRemplTableau(){ addIS("Distribution tableau","Remplacement tableau complet (même emplacement / nb circuits)", IS_TABLEAU.remplacement_tableau, 1, "u"); }
function tabSecondaire(){ addIS("Distribution tableau","Création d’un tableau secondaire", IS_TABLEAU.tableau_secondaire, 1, "u"); }
function tabExtension(){ addIS("Distribution tableau","Extension de tableau (rangées / modules)", IS_TABLEAU.extension_tableau, 1, "u"); }
</script>
<!-- ============================= -->
<!-- FIN CHAPITRE 6 -->
<!-- ============================= -->

/* ============================= */
/* CHAPITRE 7 : (PLACEHOLDER) ESTIMATIF & TOTAUX
   Rôle : affichages récapitulatifs.
   → Ajoutés dans la PARTIE 2. */
/* ============================= */
function pageEstimatif(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Estimatif</h2>
      <p class="muted">Cette section sera activée dans la Partie 2.</p>
    </div>
  `);
}
function pageTotaux(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Totaux</h2>
      <p class="muted">Cette section sera activée dans la Partie 2.</p>
    </div>
  `);
}

/* ============================= */
/* CHAPITRE 8 : DÉMARRAGE */
/* ============================= */
function init(){
  loadLocal();     // ← restaure le devis si présent (depuis CHAPITRE 6)
  pageHome();
}
init();

/* (NE PAS FERMER LE SCRIPT ICI — la PARTIE 2 continue juste après) */
/* ============================= */
/* CHAPITRE 6 (COMPLET) : INSTALLATIONS SPÉCIFIQUES (IS)
   Rôle : mêmes IS que V1 (Terre, Ventilation, Tableau)
   → addIS(section, label, prixU, qty=1, unit="u") ajoute une ligne dans la section */
/* ============================= */

const IS_TERRA = { complete_base:500, piquet_supp:100, part_conducteur_m:20, part_barrette:40, part_piquet_pack:120 };
const IS_VENTIL = { bouche_remplacement:40, bouche_creation:120, groupe_remplacement:200, pack_creation:900, bouche_supp:120, gaine_m:10, chapeau_125:180, alim_groupe:100, nettoyage:80 };
const IS_TABLEAU = { circ_prises:180, circ_eclairage:150, circ_specialise:200, recablage_circuit:100, remplacement_protection:40, remplacement_tableau:800, tableau_secondaire:500, extension_tableau:250 };

function addIS(section, label, prixU, qty=1, unit="u"){
  ensureSection(section);
  devis[section].items.push({ category:"Installation spécifique", intervention:"", pose:"", designation:label, qty:+qty, prixU:+prixU, unit:unit });
  alert(`${label} ajouté (${qty} ${unit}, ${prixU} €/ ${unit})`);
  pageISHome();
}

function pageISHome(){
  view(`
    <div class="card">
      ${b("Retour","pageHome()","btn back")}
      <h2>Installations spécifiques</h2>
      <div class="row" style="margin-bottom:10px;">
        ${b("Mise à la terre","pageISTerre()")}
        ${b("Ventilation","pageISVentil()")}
        ${b("Distribution tableau","pageISTableau()")}
      </div>
      <p class="muted">Ajoute des postes “hors‑pièces”, regroupés par section dans l’estimatif.</p>
    </div>
  `);
}

/* --- Mise à la terre --- */
function pageISTerre(){
  view(`
    <div class="card">
      ${b("Retour","pageISHome()","btn back")}
      <h2>Mise à la terre</h2>
      <div class="row">
        ${b(`Complète (${euro(IS_TERRA.complete_base)})`,"terreComplete()")}
        ${b(`Piquet supp. +2m câblette (${euro(IS_TERRA.piquet_supp)})`,"terrePiquetSupp()")}
        ${b(`Rempl. conducteur 16mm² (${euro(IS_TERRA.part_conducteur_m)}/m)`,"terreRemplacementConducteur()")}
        ${b(`Barrette de coupure (${euro(IS_TERRA.part_barrette)})`,"terreBarrette()")}
        ${b(`Piquet pack (${euro(IS_TERRA.part_piquet_pack)})`,"terrePiquetPack()")}
      </div>
    </div>
  `);
}
function terreComplete(){ addIS("Mise à la terre","Mise à la terre complète (conducteur 16mm² tableau→barrette, barrette, 4 piquets, 10m câblette 25mm²)", IS_TERRA.complete_base, 1, "u"); }
function terrePiquetSupp(){ const q=parseInt(prompt("Nb de piquets supplémentaires (+2m câblette chacun) :","1")||"0",10); if(q>0) addIS("Mise à la terre","Piquet supplémentaire (+2m câblette)", IS_TERRA.piquet_supp, q, "u"); else pageISTerre(); }
function terreRemplacementConducteur(){ const m=parseFloat(prompt("Longueur de conducteur 16mm² (m) :","1")||"0"); if(m>0) addIS("Mise à la terre","Remplacement conducteur principal 16mm²", IS_TERRA.part_conducteur_m, m, "m"); else pageISTerre(); }
function terreBarrette(){ addIS("Mise à la terre","Pose d’une barrette de coupure", IS_TERRA.part_barrette, 1, "u"); }
function terrePiquetPack(){ const q=parseInt(prompt("Nb de piquets pack (avec câblette) :","1")||"0",10); if(q>0) addIS("Mise à la terre","Piquet supplémentaire (pack avec câblette)", IS_TERRA.part_piquet_pack, q, "u"); else pageISTerre(); }

/* --- Ventilation --- */
function pageISVentil(){
  view(`
    <div class="card">
      ${b("Retour","pageISHome()","btn back")}
      <h2>Ventilation</h2>
      <div class="row">
        ${b(`Remplacement bouche (${euro(IS_VENTIL.bouche_remplacement)})`,"ventilBoucheRempl()")}
        ${b(`Création bouche (${euro(IS_VENTIL.bouche_creation)})`,"ventilBoucheCreation()")}
        ${b(`Remplacement groupe VMC (${euro(IS_VENTIL.groupe_remplacement)})`,"ventilGroupeRempl()")}
        ${b(`Pack création VMC (${euro(IS_VENTIL.pack_creation)})`,"ventilPackCreation()")}
        ${b(`Bouche supplémentaire (${euro(IS_VENTIL.bouche_supp)})`,"ventilBoucheSupp()")}
        ${b(`Gaine supplémentaire (${euro(IS_VENTIL.gaine_m)}/m)`,"ventilGaineM()")}
        ${b(`Chapeau toiture Ø125 (${euro(IS_VENTIL.chapeau_125)})`,"ventilChapeau()")}
        ${b(`Alimentation groupe (${euro(IS_VENTIL.alim_groupe)})`,"ventilAlim()")}
        ${b(`Nettoyage / réglage (${euro(IS_VENTIL.nettoyage)})`,"ventilNettoyage()")}
      </div>
    </div>
  `);
}
function ventilBoucheRempl(){ const q=parseInt(prompt("Nombre de bouches à remplacer :","1")||"0",10); if(q>0) addIS("Ventilation","Remplacement bouche d’extraction", IS_VENTIL.bouche_remplacement, q, "u"); else pageISVentil(); }
function ventilBoucheCreation(){ const q=parseInt(prompt("Nombre de bouches à créer :","1")||"0",10); if(q>0) addIS("Ventilation","Création bouche d’extraction", IS_VENTIL.bouche_creation, q, "u"); else pageISVentil(); }
function ventilGroupeRempl(){ addIS("Ventilation","Remplacement groupe VMC simple flux", IS_VENTIL.groupe_remplacement, 1, "u"); }
function ventilPackCreation(){ addIS("Ventilation","Pack création VMC (groupe + 2 bouches + ~10m gaine + sortie murale)", IS_VENTIL.pack_creation, 1, "u"); }
function ventilBoucheSupp(){ const q=parseInt(prompt("Nombre de bouches supplémentaires :","1")||"0",10); if(q>0) addIS("Ventilation","Bouche supplémentaire", IS_VENTIL.bouche_supp, q, "u"); else pageISVentil(); }
function ventilGaineM(){ const m=parseFloat(prompt("Longueur de gaine (m) :","1")||"0"); if(m>0) addIS("Ventilation","Gaine supplémentaire Ø125", IS_VENTIL.gaine_m, m, "m"); else pageISVentil(); }
function ventilChapeau(){ addIS("Ventilation","Pose chapeau de toiture Ø125", IS_VENTIL.chapeau_125, 1, "u"); }
function ventilAlim(){ addIS("Ventilation","Alimentation électrique du groupe VMC", IS_VENTIL.alim_groupe, 1, "u"); }
function ventilNettoyage(){ addIS("Ventilation","Nettoyage / réglage réseau VMC", IS_VENTIL.nettoyage, 1, "u"); }

/* --- Distribution tableau --- */
function pageISTableau(){
  view(`
    <div class="card">
      ${b("Retour","pageISHome()","btn back")}
      <h2>Distribution tableau</h2>
      <div class="row">
        ${b(`Création circuit prises (${euro(IS_TABLEAU.circ_prises)})`,"tabCircPrises()")}
        ${b(`Création circuit éclairage (${euro(IS_TABLEAU.circ_eclairage)})`,"tabCircEclairage()")}
        ${b(`Création circuit spécialisé (${euro(IS_TABLEAU.circ_specialise)})`,"tabCircSpecialise()")}
        ${b(`Recâblage circuit (${euro(IS_TABLEAU.recablage_circuit)})`,"tabRecablage()")}
        ${b(`Remplacement protection (${euro(IS_TABLEAU.remplacement_protection)})`,"tabRemplProtection()")}
        ${b(`Remplacement tableau complet (${euro(IS_TABLEAU.remplacement_tableau)})`,"tabRemplTableau()")}
        ${b(`Création tableau secondaire (${euro(IS_TABLEAU.tableau_secondaire)})`,"tabSecondaire()")}
        ${b(`Extension tableau (${euro(IS_TABLEAU.extension_tableau)})`,"tabExtension()")}
      </div>
    </div>
  `);
}
function tabCircPrises(){ const q=parseInt(prompt("Nb circuits prises à créer :","1")||"0",10); if(q>0) addIS("Distribution tableau","Création circuit prises", IS_TABLEAU.circ_prises, q, "u"); else pageISTableau(); }
function tabCircEclairage(){ const q=parseInt(prompt("Nb circuits éclairage à créer :","1")||"0",10); if(q>0) addIS("Distribution tableau","Création circuit éclairage", IS_TABLEAU.circ_eclairage, q, "u"); else pageISTableau(); }
function tabCircSpecialise(){ const q=parseInt(prompt("Nb circuits spécialisés à créer :","1")||"0",10); if(q>0) addIS("Distribution tableau","Création circuit spécialisé", IS_TABLEAU.circ_specialise, q, "u"); else pageISTableau(); }
function tabRecablage(){ const q=parseInt(prompt("Nb de circuits à recâbler :","1")||"0",10); if(q>0) addIS("Distribution tableau","Recâblage de circuit", IS_TABLEAU.recablage_circuit, q, "u"); else pageISTableau(); }
function tabRemplProtection(){ const q=parseInt(prompt("Nb de protections à remplacer (DJ / diff.) :","1")||"0",10); if(q>0) addIS("Distribution tableau","Remplacement de protection", IS_TABLEAU.remplacement_protection, q, "u"); else pageISTableau(); }
function tabRemplTableau(){ addIS("Distribution tableau","Remplacement tableau complet (même emplacement / nb circuits)", IS_TABLEAU.remplacement_tableau, 1, "u"); }
function tabSecondaire(){ addIS("Distribution tableau","Création d’un tableau secondaire", IS_TABLEAU.tableau_secondaire, 1, "u"); }
function tabExtension(){ addIS("Distribution tableau","Extension de tableau (rangées / modules)", IS_TABLEAU.extension_tableau, 1, "u"); }

/* ============================= */
/* CHAPITRE 7 (COMPLET) : ESTIMATIF & TOTAUX + EXPORT */
/* ============================= */
function pageEstimatif(){
  let html = `<div class="card">${b("Retour","pageHome()","btn back")}<h2>Estimatif détaillé</h2>`;
  let totalGlobal = 0;
  for (const section in devis) {
    if (!devis[section] || devis[section].items.length === 0) continue;
    let sectionTotal = 0;
    html += `<h3><strong>${section}</strong></h3><ul>`;
    devis[section].items.forEach((item, idx) => {
      const prixTotal = (item.prixU||0) * (item.qty||0);
      sectionTotal += prixTotal;
      const poseTxt = (item.intervention==="Création" && item.pose) ? ` ${item.pose.toLowerCase()}` : "";
      const unitTxt = item.unit ? item.unit : "u";
      const left = item.intervention ? `${item.intervention} — ` : "";
      html += `<li>${left}${item.designation}${poseTxt} (${item.qty} ${unitTxt} × ${euro(item.prixU)} = ${euro(prixTotal)})</li>`;
    });
    if (devis[section].note) html += `<li><em>Note : ${devis[section].note}</em></li>`;
    html += `</ul><p><strong>Total ${section} : ${euro(sectionTotal)}</strong></p><hr>`;
    totalGlobal += sectionTotal;
  }
  html += `<h3>Total global : ${euro(totalGlobal)}</h3>
           <div class="row" style="margin-top:10px;">${b("Exporter en .txt","exportText()")}</div></div>`;
  view(html);
}

function pageTotaux(){
  let html = `<div class="card">${b("Retour","pageHome()","btn back")}<h2>Totaux par section</h2>`;
  let totalGlobal = 0;
  for (const section in devis) {
    if (!devis[section] || devis[section].items.length === 0) continue;
    const sectionTotal = devis[section].items.reduce((sum, it) => sum + ((it.prixU||0) * (it.qty||0)), 0);
    totalGlobal += sectionTotal;
    html += `<p><strong>${section}</strong> : ${euro(sectionTotal)}</p>`;
  }
  html += `<hr><p><strong>Total global : ${euro(totalGlobal)}</strong></p>
           <div class="row" style="margin-top:10px;">${b("Exporter en .txt","exportText()")}</div></div>`;
  view(html);
}

function exportText(){
  let lines = [];
  let totalGlobal = 0;
  for (const section in devis) {
    if (!devis[section] || devis[section].items.length === 0) continue;
    lines.push(`${section} :`);
    let sectionTotal = 0;
    devis[section].items.forEach(item => {
      const prixTotal = (item.prixU||0) * (item.qty||0);
      sectionTotal += prixTotal;
      totalGlobal += prixTotal;
      const poseTxt = (item.intervention==="Création" && item.pose) ? ` - ${item.pose.toLowerCase()}` : "";
      const unitTxt = item.unit ? item.unit : "u";
      lines.push(`-${item.qty} ${item.designation}${poseTxt} (${item.prixU}€/ ${unitTxt})`);
    });
    if (devis[section].note) lines.push(`_Note : ${devis[section].note}_`);
    lines.push(`Total ${section} : ${sectionTotal}€`);
    lines.push(""); // ligne vide entre sections
  }
  lines.push(`Total global : ${totalGlobal}€`);
  const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "devis.txt"; a.click();
  URL.revokeObjectURL(url);
}

/* ============================= */
/* CHAPITRE 8 : DÉMARRAGE (déjà appelé dans la Partie 1) */
/* ============================= */
</script>
</main>
</body>
</html>
